{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23063","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23063/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23063/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23063/events","html_url":"https://github.com/elastic/elasticsearch/issues/23063","id":206410340,"node_id":"MDU6SXNzdWUyMDY0MTAzNDA=","number":23063,"title":"Elasticsearch huge dentry usage","user":{"login":"azrle","id":2177709,"node_id":"MDQ6VXNlcjIxNzc3MDk=","avatar_url":"https://avatars3.githubusercontent.com/u/2177709?v=4","gravatar_id":"","url":"https://api.github.com/users/azrle","html_url":"https://github.com/azrle","followers_url":"https://api.github.com/users/azrle/followers","following_url":"https://api.github.com/users/azrle/following{/other_user}","gists_url":"https://api.github.com/users/azrle/gists{/gist_id}","starred_url":"https://api.github.com/users/azrle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/azrle/subscriptions","organizations_url":"https://api.github.com/users/azrle/orgs","repos_url":"https://api.github.com/users/azrle/repos","events_url":"https://api.github.com/users/azrle/events{/privacy}","received_events_url":"https://api.github.com/users/azrle/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2017-02-09T05:39:53Z","updated_at":"2020-06-12T06:57:14Z","closed_at":"2017-03-22T10:35:40Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_51\r\n\r\n**OS version**: CentOS 6.5 (kernel: 2.6.32-642.6.2.el6.x86_64)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe observe that the dentry size is increasing at the speed of 2.7GiB/week. We tried to use systemtap to have a view on the contents. It seems that the dentry is full of negative entries.\r\n\r\nSomething like these:\r\n```\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.tip (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.tip\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.tim (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.tim\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.pos (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.pos\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.doc (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene50_0.doc\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.dii (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.dii\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.dim (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.dim\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene54_0.dvm (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene54_0.dvm\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene54_0.dvd (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f_Lucene54_0.dvd\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.nvm (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.nvm\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.nvd (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/2/index/_5p6f.nvd\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.si (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.si\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.cfe (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.cfe\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.cfs (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.cfs\r\nbash(91970) dentry_iput /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.fnm (negative)\r\nbash(91970) d_free /data/nodes/0/indices/ppd2vezcTxK16MR4lZAWOw/1/index/_5o9h.fnm\r\n```\r\n\r\nAlso, we have master nodes which do not store any data. And as a result, their dentries are not increasing. Hence it might be data storage (Lucence) ?\r\n\r\nMore version and docs info:\r\n```\r\n{\r\n  \"name\" : \"xxxxxxxx\",\r\n  \"cluster_name\" : \"xxxxxxxxxxxxxx\",\r\n  \"cluster_uuid\" : \"xxxxxxxxx\",\r\n  \"version\" : {\r\n    \"number\" : \"5.0.1\",\r\n    \"build_hash\" : \"080bb47\",\r\n    \"build_date\" : \"2016-11-11T22:08:49.812Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"6.2.1\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\n# curl endpoint:port/_cat/indices?v\r\nhealth status index                                      uuid                   pri rep docs.count docs.deleted store.size pri.store.size\r\ngreen  open   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx            ppd2vezcTxK16MR4lZAWOw   3  69    6641032      3981878    219.1gb          2.8gb\r\n\r\n# free -m\r\n             total       used       free     shared    buffers     cached\r\nMem:         30074      28882       1192          0        238       3323\r\n-/+ buffers/cache:      25320       4753\r\nSwap:            0          0          0\r\n\r\n# cat /proc/meminfo\r\nMemTotal:       30796036 kB\r\nMemFree:         1641472 kB\r\nBuffers:          227688 kB\r\nCached:          3031304 kB\r\n...\r\nSlab:            9450312 kB\r\nSReclaimable:    9389144 kB\r\n...\r\n\r\n# curl endpoint:port/_nodes/node/stats/jvm?pretty\r\n....\r\n      \"roles\" : [\r\n        \"data\",\r\n        \"ingest\"\r\n      ],\r\n      \"jvm\" : {\r\n        \"timestamp\" : 1483385678513,\r\n        \"uptime_in_millis\" : 2468281683,\r\n        \"mem\" : {\r\n          \"heap_used_in_bytes\" : 2760026208,\r\n          \"heap_used_percent\" : 18,\r\n          \"heap_committed_in_bytes\" : 14919008256,\r\n          \"heap_max_in_bytes\" : 14919008256,\r\n          \"non_heap_used_in_bytes\" : 120941856,\r\n          \"non_heap_committed_in_bytes\" : 126672896,\r\n          ...\r\n\r\n```\r\n\r\nAs you may see, we have a lot of replicas and they are distributed in many servers. However, to fit our traffics, we dramatically decrease the number of nodes and replicas recently. As far as we seen, it does not make any change. We decide to drop the dentry regularly to prevent OOM before OS can finish reclaiming the memory.\r\n\r\nWe know that the Lucence takes advantage of OS's disk and dentry caches. But is the phenomenon we observed a normal case and by design? \r\n\r\n**Steps to reproduce**:\r\n 1. Index bunch of data\r\n 2. Keep querying data and deleting data\r\n 3. Check dentry usage\r\n\r\n**Provide logs (if relevant)**:\r\nNo relevant logs.\r\n\r\nRelated: https://github.com/elastic/elasticsearch/issues/11253\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}