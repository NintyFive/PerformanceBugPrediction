{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24944","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24944/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24944/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24944/events","html_url":"https://github.com/elastic/elasticsearch/issues/24944","id":232106669,"node_id":"MDU6SXNzdWUyMzIxMDY2Njk=","number":24944,"title":"geo_point value parsing seems inconsistent and documentation could be improved","user":{"login":"pandrese","id":1724167,"node_id":"MDQ6VXNlcjE3MjQxNjc=","avatar_url":"https://avatars3.githubusercontent.com/u/1724167?v=4","gravatar_id":"","url":"https://api.github.com/users/pandrese","html_url":"https://github.com/pandrese","followers_url":"https://api.github.com/users/pandrese/followers","following_url":"https://api.github.com/users/pandrese/following{/other_user}","gists_url":"https://api.github.com/users/pandrese/gists{/gist_id}","starred_url":"https://api.github.com/users/pandrese/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pandrese/subscriptions","organizations_url":"https://api.github.com/users/pandrese/orgs","repos_url":"https://api.github.com/users/pandrese/repos","events_url":"https://api.github.com/users/pandrese/events{/privacy}","received_events_url":"https://api.github.com/users/pandrese/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-05-29T22:21:44Z","updated_at":"2018-05-11T17:55:09Z","closed_at":"2018-05-11T17:55:09Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**:\r\n5.4\r\n\r\n**Plugins installed**: []\r\nNone\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 13f1d2351e28 4.4.0-78-generic #99-Ubuntu SMP Thu Apr 27 15:29:09 UTC 2017 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nConfusing error messages are returned during indexing of geo_points, and even worse, in the case of  using \"ignore_malformed\" in the type mapping, the geo_point field will have a wrong value which will be used in e.g. aggregations.\r\n\r\nThe core of the problem seems to be that using the object format for the geo_point, string values for lat/lon are as expected parsed and interpreted as floats. Where as in the geo_point array format a string will be interpreted as a geohash value. The error message returned when parsing a float as a geohash value is confusing (also considering that the decimal point is not a valid character in the geohash encoding). Could this somehow be improved to make this easier to catch and understand?\r\n\r\nIn the case where when specifying \"ignore_malformed\" in the type mapping, I would have expected that the field would be ignored in the document, and not that it is set to the best guess. Or did I misread the documentation?\r\n\r\n\r\n**Steps to reproduce**:\r\nThe problem can be recreated by issuing the following commands:\r\n\r\n```\r\ncurl -XPUT localhost:9200/geotest -d '{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"loc\": {\r\n          \"type\": \"geo_point\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\ncurl -XPUT localhost:9200/geotesti -d '{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"loc\": {\r\n          \"type\": \"geo_point\",\r\n          \"ignore_malformed\": \"true\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -XPUT localhost:9200/geotest/test/array -d '{\"loc\": [5, 55.5]}'\r\ncurl -XPUT localhost:9200/geotest/test/arrayerr -d '{\"loc\": [\"5\", \"55.5\"]}'\r\ncurl -XPUT localhost:9200/geotest/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": \"55.5\",\r\n    \"lon\": \"5\"\r\n  }\r\n}'\r\ncurl -XPUT localhost:9200/geotest/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": 55.5,\r\n    \"lon\": 5\r\n  }\r\n}'\r\n\r\ncurl -XPUT localhost:9200/geotesti/test/array -d '{\"loc\": [5, 55.5]}'\r\ncurl -XPUT localhost:9200/geotesti/test/arrayerr -d '{\"loc\": [\"5\", \"55.5\"]}'\r\ncurl -XPUT localhost:9200/geotesti/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": \"55.5\",\r\n    \"lon\": \"5\"\r\n  }\r\n}'\r\ncurl -XPUT localhost:9200/geotesti/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": 55.5,\r\n    \"lon\": 5\r\n  }\r\n}'\r\n\r\nsleep 30\r\n\r\ncurl -XPOST localhost:9200/geotest/_search -d '{\"query\": { \"match_all\": {}}, \"aggs\": {\"geo\": {\"geohash_grid\": {\"field\": \"loc\"}}}}'\r\n\r\ncurl -XPOST localhost:9200/geotesti/_search -d '{\"query\": { \"match_all\": {}}, \"aggs\": {\"geo\": {\"geohash_grid\": {\"field\": \"loc\"}}}}'\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n++ curl -XPUT localhost:9200/geotest -d '{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"loc\": {\r\n          \"type\": \"geo_point\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n{\"acknowledged\":true,\"shards_acknowledged\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotesti -d '{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"loc\": {\r\n          \"type\": \"geo_point\",\r\n          \"ignore_malformed\": \"true\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n{\"acknowledged\":true,\"shards_acknowledged\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotest/test/array -d '{\"loc\": [5, 55.5]}'\r\n{\"_index\":\"geotest\",\"_type\":\"test\",\"_id\":\"array\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotest/test/arrayerr -d '{\"loc\": [\"5\", \"55.5\"]}'\r\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse\",\"caused_by\":{\"type\":\"illegal_argument_exception\",\"reason\":\"illegal latitude value [269.12109375] for loc\"}},\"status\":400}\r\n\r\n++ curl -XPUT localhost:9200/geotest/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": \"55.5\",\r\n    \"lon\": \"5\"\r\n  }\r\n}'\r\n{\"_index\":\"geotest\",\"_type\":\"test\",\"_id\":\"llerr\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotest/test/ll -d '{\r\n  \"loc\": {\r\n    \"lat\": 55.5,\r\n    \"lon\": 5\r\n  }\r\n}'\r\n{\"_index\":\"geotest\",\"_type\":\"test\",\"_id\":\"ll\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotesti/test/array -d '{\"loc\": [5, 55.5]}'\r\n{\"_index\":\"geotesti\",\"_type\":\"test\",\"_id\":\"array\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotesti/test/arrayerr -d '{\"loc\": [\"5\", \"55.5\"]}'\r\n{\"_index\":\"geotesti\",\"_type\":\"test\",\"_id\":\"arrayerr\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotesti/test/llerr -d '{\r\n  \"loc\": {\r\n    \"lat\": \"55.5\",\r\n    \"lon\": \"5\"\r\n  }\r\n}'\r\n{\"_index\":\"geotesti\",\"_type\":\"test\",\"_id\":\"llerr\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ curl -XPUT localhost:9200/geotesti/test/ll -d '{\r\n  \"loc\": {\r\n    \"lat\": 55.5,\r\n    \"lon\": 5\r\n  }\r\n}'\r\n{\"_index\":\"geotesti\",\"_type\":\"test\",\"_id\":\"ll\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"created\":true}\r\n\r\n++ sleep 30\r\n\r\n++ curl -XPOST localhost:9200/geotest/_search -d '{\"query\": { \"match_all\": {}}, \"size\": 0, \"aggs\": {\"geo\": {\"geohash_grid\": {\"field\": \"loc\"}}}}'\r\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":3,\"max_score\":0.0,\"hits\":[]},\"aggregations\":{\"geo\":{\"buckets\":[{\"key\":\"u1ge9\",\"doc_count\":3}]}}}\r\n\r\n++ curl -XPOST localhost:9200/geotesti/_search -d '{\"query\": { \"match_all\": {}},  \"size\": 0 ,\"aggs\": {\"geo\": {\"geohash_grid\": {\"field\": \"loc\"}}}}'\r\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":4,\"max_score\":0.0,\"hits\":[]},\"aggregations\":{\"geo\":{\"buckets\":[{\"key\":\"u1ge9\",\"doc_count\":3},{\"key\":\"5bpj0\",\"doc_count\":1},{\"key\":\"50000\",\"doc_count\":1}]}}}\r\n```\r\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}