[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/69907470","html_url":"https://github.com/elastic/elasticsearch/issues/9280#issuecomment-69907470","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9280","id":69907470,"node_id":"MDEyOklzc3VlQ29tbWVudDY5OTA3NDcw","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-01-14T12:09:35Z","updated_at":"2015-01-14T12:09:35Z","author_association":"MEMBER","body":"The mapping seems to be wrong in the above (it doesn't parse) I think it should be:\n\n```\nPUT /agg-test\n{\n  \"mappings\": {\n    \"provider\": {\n      \"properties\": {\n        \"comments\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"cid\": {\n              \"type\": \"long\"\n            },\n            \"identifier\": {\n              \"type\": \"string\",\n              \"index\": \"not_analyzed\"\n            },\n            \"tags\": {\n              \"type\": \"nested\",\n              \"properties\": {\n                \"tid\": {\n                  \"type\": \"long\"\n                },\n                \"name\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n                }\n              }\n            }\n          }\n        },\n        \"dates\": {\n          \"properties\": {\n            \"day\": {\n              \"type\": \"date\",\n              \"format\": \"dateOptionalTime\"\n            },\n            \"month\": {\n              \"properties\": {\n                \"end\": {\n                  \"type\": \"date\",\n                  \"format\": \"dateOptionalTime\"\n                },\n                \"label\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n                },\n                \"start\": {\n                  \"type\": \"date\",\n                  \"format\": \"dateOptionalTime\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/69907600","html_url":"https://github.com/elastic/elasticsearch/issues/9280#issuecomment-69907600","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9280","id":69907600,"node_id":"MDEyOklzc3VlQ29tbWVudDY5OTA3NjAw","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-01-14T12:10:46Z","updated_at":"2015-01-14T12:10:46Z","author_association":"MEMBER","body":"Also, this issue doesn't seem to reproduce on the current master branch\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70070839","html_url":"https://github.com/elastic/elasticsearch/issues/9280#issuecomment-70070839","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9280","id":70070839,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMDcwODM5","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-01-15T11:09:01Z","updated_at":"2015-01-15T11:09:01Z","author_association":"MEMBER","body":"@colings86 @pickypg I think I found the bug. The `nested` aggregator work based on the wrong assumption. It assumes: https://github.com/elasticsearch/elasticsearch/blob/a56520d26d70ae731ed929660e29df119290114f/src/main/java/org/elasticsearch/search/aggregations/bucket/nested/NestedAggregator.java#L65\n\nBut this isn't the case if buckets are introduced during executing of aggs. If buckets are created before the actual execution this assumption is true. This results in the parent filter not being resolved correctly for nested `nested` aggs. (It resolves the root level as filter)\n\nI'll open a pr and move the resolving of the parentFilter to the collect method instead, in that method we can assume that the child filter of a parent nested aggregator is resolved at that time, which can than be as a parent filter for the nested aggregator that are nested below.\n","performed_via_github_app":null}]