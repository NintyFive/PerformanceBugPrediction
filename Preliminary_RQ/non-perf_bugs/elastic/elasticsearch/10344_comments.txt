[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88096471","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88096471","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88096471,"node_id":"MDEyOklzc3VlQ29tbWVudDg4MDk2NDcx","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2015-03-31T13:56:51Z","updated_at":"2015-03-31T13:56:51Z","author_association":"MEMBER","body":"@nicktgr15 could you post the stack trace for the OOM error?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88098535","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88098535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88098535,"node_id":"MDEyOklzc3VlQ29tbWVudDg4MDk4NTM1","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-03-31T14:00:52Z","updated_at":"2015-03-31T14:00:52Z","author_association":"MEMBER","body":"> we create about 200 new indices per day\n\nHow many number of shards represent those 200 indices? What's the total size?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88112169","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88112169","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88112169,"node_id":"MDEyOklzc3VlQ29tbWVudDg4MTEyMTY5","user":{"login":"nicktgr15","id":2852737,"node_id":"MDQ6VXNlcjI4NTI3Mzc=","avatar_url":"https://avatars0.githubusercontent.com/u/2852737?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktgr15","html_url":"https://github.com/nicktgr15","followers_url":"https://api.github.com/users/nicktgr15/followers","following_url":"https://api.github.com/users/nicktgr15/following{/other_user}","gists_url":"https://api.github.com/users/nicktgr15/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktgr15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktgr15/subscriptions","organizations_url":"https://api.github.com/users/nicktgr15/orgs","repos_url":"https://api.github.com/users/nicktgr15/repos","events_url":"https://api.github.com/users/nicktgr15/events{/privacy}","received_events_url":"https://api.github.com/users/nicktgr15/received_events","type":"User","site_admin":false},"created_at":"2015-03-31T14:34:59Z","updated_at":"2015-03-31T14:34:59Z","author_association":"NONE","body":"Thanks for the responses!\n\n@imotov I'm currently reproducing the issue in order to get a full stack trace which I will attach to the ticket as soon as I have it\n\n@tlrx There are 7 primary shards and 7 replicas per index, so 200 indices are represented by 2800 shards. The total number of shards (for the 5 days retention policy) is 14000. The total size in bytes for the 200 indices created per day is close to 400GB (including replicas).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88123013","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88123013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88123013,"node_id":"MDEyOklzc3VlQ29tbWVudDg4MTIzMDEz","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-03-31T15:02:25Z","updated_at":"2015-03-31T15:02:25Z","author_association":"MEMBER","body":"@nicktgr15 thanks for your quick response\n\nWe are suspecting that the verification process failed in your case. Can you please try to register the repository but without verification? You have to set `verify: false` when registering the repo, see the documentation [here](http://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html#_shared_file_system_repository)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88151090","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88151090","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88151090,"node_id":"MDEyOklzc3VlQ29tbWVudDg4MTUxMDkw","user":{"login":"nicktgr15","id":2852737,"node_id":"MDQ6VXNlcjI4NTI3Mzc=","avatar_url":"https://avatars0.githubusercontent.com/u/2852737?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktgr15","html_url":"https://github.com/nicktgr15","followers_url":"https://api.github.com/users/nicktgr15/followers","following_url":"https://api.github.com/users/nicktgr15/following{/other_user}","gists_url":"https://api.github.com/users/nicktgr15/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktgr15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktgr15/subscriptions","organizations_url":"https://api.github.com/users/nicktgr15/orgs","repos_url":"https://api.github.com/users/nicktgr15/repos","events_url":"https://api.github.com/users/nicktgr15/events{/privacy}","received_events_url":"https://api.github.com/users/nicktgr15/received_events","type":"User","site_admin":false},"created_at":"2015-03-31T16:16:58Z","updated_at":"2015-03-31T16:16:58Z","author_association":"NONE","body":"I'm attaching a screenshot from jConsole showing the heap space utilisation in both cases with `verify: true` (default) and `verify: false`. For the two cases we got the following output:\n\n**verify: true** (default)\n\n```\ncurl -XPUT 'http://localhost:9200/_snapshot/s3_repository' -d '{\n>     \"type\": \"s3\",\n>     \"settings\":{\"region\":\"eu-west-1\",\"base_path\":\"pyxis/test/snapshots\",\"max_restore_bytes_per_sec\":\"100mb\",\"bucket\":\"prod-s3-common-storagebucket-sl9vplg1o48d\"}\n> }'\n{\"error\":\"OutOfMemoryError[Java heap space]\",\"status\":500}\n```\n\n```\n[2015-03-31 15:43:25,265][INFO ][repositories             ] [Master Menace] update repository [s3_repository]\n[2015-03-31 15:53:11,375][WARN ][repositories             ] [Master Menace] [s3_repository] failed to finish repository verification\n```\n\n**verify: false** \n\n```\ncurl -XPUT 'http://localhost:9200/_snapshot/s3_repository' -d '{\n>     \"type\": \"s3\",\n>     \"settings\":{\"region\":\"eu-west-1\",\"base_path\":\"pyxis/test/snapshots\",\"max_restore_bytes_per_sec\":\"100mb\",\"bucket\":\"prod-s3-common-storagebucket-sl9vplg1o48d\", \"verify\": false}\n> }'\n{\"error\":\"AmazonClientException[Unable to unmarshall response (Failed to sanitize XML document destined for handler class com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListBucketHandler). Response Code: 200, Response Text: OK]; nested: AmazonClientException[Failed to sanitize XML document destined for handler c\n```\n\n```\n[2015-03-31 15:56:21,785][INFO ][repositories             ] [Master Menace] update repository [s3_repository]\n[2015-03-31 16:05:33,932][WARN ][repositories             ] [Master Menace] [s3_repository] failed to finish repository verification\n```\n\n![repository-verify](https://cloud.githubusercontent.com/assets/2852737/6923334/efc902fe-d7c8-11e4-8508-bd8da584e422.png)\n\nWe reduced the heap space to 300m in order to trigger the out of memory error sooner. As you can see in the first block there is an \"out of memory\" error but there was no stack trace.\n\nThis was not reproduced on Live environment and load conditions were not the same.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88465144","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88465144","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88465144,"node_id":"MDEyOklzc3VlQ29tbWVudDg4NDY1MTQ0","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-04-01T12:41:40Z","updated_at":"2015-04-01T12:41:40Z","author_association":"MEMBER","body":"@nicktgr15 thanks for the information. I think I can now imagine what happened in your cluster.\n\nIn elasticsearch 1.4 we added repository verification. When registering a repository, each node of the cluster tries to write a file in the repository before the repository registration is acknowledged. \n\nThe current implementation of the verification process lists all the files at the root level of the repository... and in your case it represents too much data for the Java XML API so the node hits an OOM. \n\nFirst thing, I've created the pull request #10366 to avoid listing all files when verifying a repository.\n\nSecond thing, the is an error in the documentation. To disable repository verification you need to add the URL parameter `verify=false` when registering the repository. I've created the pull request #10365 to update the doc, but you can now try to register the repository with this parameter.\n\nLast thing: in your case there are good chances that disabling the repository verification will just differ the OOM. The snapshot process needs to list all files of the repository to be able to make an incremental backup. The upcoming #8969 will improve the creation and deletion of snapshot in use cases like yours, but you should consider to create less indices (200 indices with 7 shards = 1400 shards, 400GB / 1400 =~142MB per shard where a shard could handle GBs of data)\n\nYou can also consider to create multiple repositories, like snapshotting newly indices in a new repo every day.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88852292","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88852292","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88852292,"node_id":"MDEyOklzc3VlQ29tbWVudDg4ODUyMjky","user":{"login":"nicktgr15","id":2852737,"node_id":"MDQ6VXNlcjI4NTI3Mzc=","avatar_url":"https://avatars0.githubusercontent.com/u/2852737?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktgr15","html_url":"https://github.com/nicktgr15","followers_url":"https://api.github.com/users/nicktgr15/followers","following_url":"https://api.github.com/users/nicktgr15/following{/other_user}","gists_url":"https://api.github.com/users/nicktgr15/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktgr15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktgr15/subscriptions","organizations_url":"https://api.github.com/users/nicktgr15/orgs","repos_url":"https://api.github.com/users/nicktgr15/repos","events_url":"https://api.github.com/users/nicktgr15/events{/privacy}","received_events_url":"https://api.github.com/users/nicktgr15/received_events","type":"User","site_admin":false},"created_at":"2015-04-02T09:50:01Z","updated_at":"2015-04-02T09:50:01Z","author_association":"NONE","body":"Thanks for the update @tlrx. As a temporary workaround we will be rotating the snapshots repository on a monthly basis. We didn't have a chance to try again with `verify: false` as a url parameter, if we do, I will provide an update.\n\nRegarding your suggestion about the number of shards in the cluster, is there a performance impact on the snapshotting process because of this? \n\nIn general, we know that there is a suggested 10GB upper limit for the shard size and based on what you describe, we should aim for a minimum of 1GB. Does this sound like the right strategy to optimise the number of shards we currently have in the cluster? At this point we can't reduce the number of indices as it is a requirement the system should satisfy.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88856426","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88856426","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88856426,"node_id":"MDEyOklzc3VlQ29tbWVudDg4ODU2NDI2","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-04-02T10:07:59Z","updated_at":"2015-04-02T10:07:59Z","author_association":"MEMBER","body":"> Regarding your suggestion about the number of shards in the cluster, is there a performance impact on the snapshotting process because of this?\n\nDefinitely. The snapshot process iterates over each file of the shards to process and upload them. The more shards you have, the more files need to be snapshotted.\n\n> Does this sound like the right strategy to optimise the number of shards we currently have in the cluster?\n\nHard to tell if it's the right strategy without knowing exactly what is your use case. But for what I know of your cluster I feel like you should benefit of creating less but larger indices.\n\n> At this point we can't reduce the number of indices as it is a requirement the system should satisfy.\n\nI'm curious to understand why the number of indices is a requirement for your system?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88859313","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88859313","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88859313,"node_id":"MDEyOklzc3VlQ29tbWVudDg4ODU5MzEz","user":{"login":"nicktgr15","id":2852737,"node_id":"MDQ6VXNlcjI4NTI3Mzc=","avatar_url":"https://avatars0.githubusercontent.com/u/2852737?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktgr15","html_url":"https://github.com/nicktgr15","followers_url":"https://api.github.com/users/nicktgr15/followers","following_url":"https://api.github.com/users/nicktgr15/following{/other_user}","gists_url":"https://api.github.com/users/nicktgr15/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktgr15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktgr15/subscriptions","organizations_url":"https://api.github.com/users/nicktgr15/orgs","repos_url":"https://api.github.com/users/nicktgr15/repos","events_url":"https://api.github.com/users/nicktgr15/events{/privacy}","received_events_url":"https://api.github.com/users/nicktgr15/received_events","type":"User","site_admin":false},"created_at":"2015-04-02T10:23:18Z","updated_at":"2015-04-02T10:23:18Z","author_association":"NONE","body":"Was a requirement when the system was designed as it was simplifying the way we managed clients data (e.g. backups per index, permissions). However, we are going to review our current approach as the high number of indices seems to be an overhead. Thank you for you help. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88881107","html_url":"https://github.com/elastic/elasticsearch/issues/10344#issuecomment-88881107","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","id":88881107,"node_id":"MDEyOklzc3VlQ29tbWVudDg4ODgxMTA3","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-04-02T12:19:00Z","updated_at":"2015-04-02T12:19:00Z","author_association":"MEMBER","body":"@nicktgr15 ok thanks, that's what I suspected. \n\nYou may be interested in the chapter [\"Designing for Scale\"](http://www.elastic.co/guide/en/elasticsearch/guide/current/scale.html) of the book Elasticsearch Definitive Guide. It's a great chapter that deals with use case like yours.\n\nI'm closing this issue since many pull requests are already engaged. Feel free to reopen if needed.\n","performed_via_github_app":null}]