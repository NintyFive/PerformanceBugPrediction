{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23465","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23465/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23465/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23465/events","html_url":"https://github.com/elastic/elasticsearch/issues/23465","id":211495978,"node_id":"MDU6SXNzdWUyMTE0OTU5Nzg=","number":23465,"title":"Position of query property in request changes aggs results","user":{"login":"markttech","id":15839595,"node_id":"MDQ6VXNlcjE1ODM5NTk1","avatar_url":"https://avatars0.githubusercontent.com/u/15839595?v=4","gravatar_id":"","url":"https://api.github.com/users/markttech","html_url":"https://github.com/markttech","followers_url":"https://api.github.com/users/markttech/followers","following_url":"https://api.github.com/users/markttech/following{/other_user}","gists_url":"https://api.github.com/users/markttech/gists{/gist_id}","starred_url":"https://api.github.com/users/markttech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markttech/subscriptions","organizations_url":"https://api.github.com/users/markttech/orgs","repos_url":"https://api.github.com/users/markttech/repos","events_url":"https://api.github.com/users/markttech/events{/privacy}","received_events_url":"https://api.github.com/users/markttech/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-02T19:43:17Z","updated_at":"2017-03-06T19:38:51Z","closed_at":"2017-03-06T19:38:51Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\r\nElasticSearch 5.2.1\r\n\r\n**Plugins installed**: \r\nx-pack\r\n\r\n**JVM version**:\r\njava version \"1.8.0_91\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_91-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)\r\n\r\n**OS version**:\r\nWindows Server 2012 R2 Standard\r\n\r\nI am getting different results for aggs when the query property is before or after a term aggs that is using include property with a pattern and reading from an alias that points to two indexes with similar data.\r\n\r\nThe issue is that the results appear to change depending on where the query property is in the request. \r\n\r\nAccording to the comment on https://github.com/elastic/elasticsearch-net/issues/2639#issuecomment-283754955 the position of the query property shouldn't be changing the results.\r\n\r\n```\r\nput aggstest \r\n{\r\n    \"mappings\" : {\r\n        \"entity\" : {\r\n            \"properties\" : {\r\n                \"genre\" : { \"type\" : \"keyword\" },\r\n\t\t\t\t\"group\" : {\"type\": \"integer\"}\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nput aggstest2\r\n{\r\n    \"mappings\" : {\r\n        \"entity\" : {\r\n            \"properties\" : {\r\n                \"genre\" : { \"type\" : \"keyword\" },\r\n\t\t\t\t\"group\" : {\"type\": \"integer\"}\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\npost aggstest/entity\r\n{\r\n    \"genre\":\"nonfiction\",\r\n\t\"group\":100\r\n}\r\n\r\npost aggstest/entity\r\n{\r\n    \"genre\":\"documentary\",\r\n\t\"group\":100\r\n}\r\n\r\npost aggstest2/entity\r\n{\r\n    \"genre\":\"nonfiction\",\r\n\t\"group\":200\r\n}\r\n\r\npost aggstest2/entity\r\n{\r\n    \"genre\":\"documentary\",\r\n\t\"group\":200\r\n}\r\n\r\npost _aliases\r\n{\r\n    \"actions\" : [\r\n        { \"add\" : { \"index\" : \"aggstest\", \"alias\" : \"aggstestalias\" } },\r\n\t\t{ \"add\" : { \"index\" : \"aggstest2\", \"alias\" : \"aggstestalias\" } }\r\n    ]\r\n}\r\n\r\npost aggstestalias/entity/_search\r\n{\r\n  \"size\": 0,\r\n  \"from\": 0,\r\n  \"query\": {\r\n    \"term\": {\r\n      \"group\": \"100\"\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"genres\": {\r\n      \"terms\": {\r\n        \"field\": \"genre\",\r\n        \"include\": {\r\n          \"pattern\": \".*nonfiction.*\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\nThis returns doc_count 1 for nonfiction.\r\n\r\npost aggstestalias/entity/_search\r\n{\r\n  \"size\": 0,\r\n  \"from\": 0,\r\n  \"aggs\": {\r\n    \"genres\": {\r\n      \"terms\": {\r\n        \"field\": \"genre\",\r\n        \"include\": {\r\n          \"pattern\": \".*nonfiction.*\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"query\": {\r\n    \"term\": {\r\n      \"group\": \"100\"\r\n    }\r\n  }\r\n}\r\nThis returns doc_count 2 for nonfiction.\r\n```","closed_by":{"login":"markttech","id":15839595,"node_id":"MDQ6VXNlcjE1ODM5NTk1","avatar_url":"https://avatars0.githubusercontent.com/u/15839595?v=4","gravatar_id":"","url":"https://api.github.com/users/markttech","html_url":"https://github.com/markttech","followers_url":"https://api.github.com/users/markttech/followers","following_url":"https://api.github.com/users/markttech/following{/other_user}","gists_url":"https://api.github.com/users/markttech/gists{/gist_id}","starred_url":"https://api.github.com/users/markttech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markttech/subscriptions","organizations_url":"https://api.github.com/users/markttech/orgs","repos_url":"https://api.github.com/users/markttech/repos","events_url":"https://api.github.com/users/markttech/events{/privacy}","received_events_url":"https://api.github.com/users/markttech/received_events","type":"User","site_admin":false},"performed_via_github_app":null}