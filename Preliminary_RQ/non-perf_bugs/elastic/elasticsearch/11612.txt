{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11612","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11612/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11612/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11612/events","html_url":"https://github.com/elastic/elasticsearch/issues/11612","id":87444286,"node_id":"MDU6SXNzdWU4NzQ0NDI4Ng==","number":11612,"title":"ES 1.6 broke installing plugins in uninstalled package","user":{"login":"jib","id":90691,"node_id":"MDQ6VXNlcjkwNjkx","avatar_url":"https://avatars3.githubusercontent.com/u/90691?v=4","gravatar_id":"","url":"https://api.github.com/users/jib","html_url":"https://github.com/jib","followers_url":"https://api.github.com/users/jib/followers","following_url":"https://api.github.com/users/jib/following{/other_user}","gists_url":"https://api.github.com/users/jib/gists{/gist_id}","starred_url":"https://api.github.com/users/jib/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jib/subscriptions","organizations_url":"https://api.github.com/users/jib/orgs","repos_url":"https://api.github.com/users/jib/repos","events_url":"https://api.github.com/users/jib/events{/privacy}","received_events_url":"https://api.github.com/users/jib/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"assignees":[{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-06-11T18:45:10Z","updated_at":"2020-11-11T22:00:13Z","closed_at":"2016-01-18T20:22:43Z","author_association":"NONE","active_lock_reason":null,"body":"First, the use case:\n\nTo ensure a single, tested, artifact to be installed across the fleet, including all plugins needed, our build process roughly works like this:\n- Grab the version of ES as a debian package\n- Extract this debian package in a temp dir\n- cd into this directory and run: `bin/plugin install ...`\n- go back to the temp dir, and repackage as debian package\n\nThe reason for the debian package is that the init scripts for ES do a lot of work (setting ulimit, users, groups, etc), and we don't want to duplicate that and maintain it; otherwise we'd just use the tarball.\n\nThis process worked fine with 1.5.x, but starting 1.6, the 'plugin' command can no longer find the needed config files. Here are the specific issues:\n\n1) Even though it finds 'CONF_DIR' just fine, it insists on setting 'CONF_FILE' separately, and does not use the same heuristics as for 'CONF_DIR'. \n\n2) It now requires /etc/default/elasticsearch to be present to run, which requires an installed version, or another override.\n\nThe workaround is now to do this, which is ugly and prone to breakage going forward:\n\n```\n$ ES_INCLUDE=`pwd`/etc/default/elasticsearch CONF_FILE=`pwd`/etc/elasticsearch/elasticsearch.yaml CONF_DIR=`pwd`/etc/elasticsearch  usr/share/elasticsearch/bin/plugin  -h\n```\n\nThe full diff below, to illustrate the offending parts:\n\n```\ndiff elasticsearch-1.{5.2,6.0}/usr/share/elasticsearch/bin/plugin\n23a26,62\n> # Sets the default values for elasticsearch variables used in this script\n> if [ -z \"$CONF_DIR\" ]; then\n>   CONF_DIR=\"/etc/elasticsearch\"\n>\n>   if [ -z \"$CONF_FILE\" ]; then\n>     CONF_FILE=\"$CONF_DIR/elasticsearch.yml\"\n>   fi\n> fi\n>\n> if [ -z \"$CONF_FILE\" ]; then\n>   CONF_FILE=\"/etc/elasticsearch/elasticsearch.yml\"\n> fi\n>\n> # The default env file is defined at building/packaging time.\n> # For a deb package, the value is \"/etc/default/elasticsearch\".\n> ES_ENV_FILE=\"/etc/default/elasticsearch\"\n>\n> # If an include is specified with the ES_INCLUDE environment variable, use it\n> if [ -n \"$ES_INCLUDE\" ]; then\n>     ES_ENV_FILE=\"$ES_INCLUDE\"\n> fi\n>\n> # Source the environment file\n> if [ -n \"$ES_ENV_FILE\" ]; then\n>\n>   # If the ES_ENV_FILE is not found, try to resolve the path\n>   # against the ES_HOME directory\n>   if [ ! -f \"$ES_ENV_FILE\" ]; then\n>       ES_ENV_FILE=\"$ELASTIC_HOME/$ES_ENV_FILE\"\n>   fi\n>\n>   . \"$ES_ENV_FILE\"\n>   if [ $? -ne 0 ]; then\n>       echo \"Unable to source environment file: $ES_ENV_FILE\" >&2\n>       exit 1\n>   fi\n> fi\n48c87,96\n< exec \"$JAVA\" $JAVA_OPTS $ES_JAVA_OPTS -Xmx64m -Xms16m -Delasticsearch -Des.path.home=\"$ES_HOME\" $properties -cp \"$ES_HOME/lib/*\" org.elasticsearch.plugins.PluginManager $args\n\n---\n> # check if properties already has a config file or config dir\n> if [ -e \"$CONF_DIR\" ]; then\n>   case \"$properties\" in\n>     *-Des.default.path.conf=*|*-Des.path.conf=*)\n>     ;;\n>     *)\n>       properties=\"$properties -Des.default.path.conf=$CONF_DIR\"\n>     ;;\n>   esac\n> fi\n49a98,110\n> if [ -e \"$CONF_FILE\" ]; then\n>   case \"$properties\" in\n>     *-Des.default.config=*|*-Des.config=*)\n>     ;;\n>     *)\n>       properties=\"$properties -Des.default.config=$CONF_FILE\"\n>     ;;\n>   esac\n> fi\n>\n> export HOSTNAME=`hostname -s`\n>\n> exec \"$JAVA\" $JAVA_OPTS $ES_JAVA_OPTS -Xmx64m -Xms16m -Delasticsearch -Des.path.home=\"$ES_HOME\" $properties -cp \"$ES_HOME/lib/*\" org.elasticsearch.plugins.PluginManager $args\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}