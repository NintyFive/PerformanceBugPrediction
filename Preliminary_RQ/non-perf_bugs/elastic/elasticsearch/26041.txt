{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26041","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26041/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26041/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26041/events","html_url":"https://github.com/elastic/elasticsearch/issues/26041","id":247665781,"node_id":"MDU6SXNzdWUyNDc2NjU3ODE=","number":26041,"title":"match_phrase does not work in highlight_query if stopwords are involved (FVH)","user":{"login":"kori0129","id":23311112,"node_id":"MDQ6VXNlcjIzMzExMTEy","avatar_url":"https://avatars1.githubusercontent.com/u/23311112?v=4","gravatar_id":"","url":"https://api.github.com/users/kori0129","html_url":"https://github.com/kori0129","followers_url":"https://api.github.com/users/kori0129/followers","following_url":"https://api.github.com/users/kori0129/following{/other_user}","gists_url":"https://api.github.com/users/kori0129/gists{/gist_id}","starred_url":"https://api.github.com/users/kori0129/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kori0129/subscriptions","organizations_url":"https://api.github.com/users/kori0129/orgs","repos_url":"https://api.github.com/users/kori0129/repos","events_url":"https://api.github.com/users/kori0129/events{/privacy}","received_events_url":"https://api.github.com/users/kori0129/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":176784422,"node_id":"MDU6TGFiZWwxNzY3ODQ0MjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/won't%20fix","name":"won't fix","color":"f7c6c7","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-08-03T10:42:33Z","updated_at":"2017-08-04T12:59:04Z","closed_at":"2017-08-04T09:54:40Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\nElasticsearch version: 5.2.0\r\n\r\nPlugins installed: []\r\n\r\nJVM version (java -version): 1.8.0_131\r\n\r\nOS version (uname -a if on a Unix-like system):\r\nLinux 3.10.0-514.6.1.el7.x86_64 #1 SMP Wed Jan 18 13:06:36 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n**Action**: Highlight a field with a highlight_query, using match_phrase on a field with stopword filtering in Fast Vector Highlighter\r\n**Expected Behaviour**: match_phrase handles stopwords the same way in highlight_query as in a normal query\r\n**Actual Behaviour**: match_phrase fails to match in highlight_query with stopwords involved\r\n\r\n**Steps to reproduce**:\r\n\r\n 1.  Create index with a field with \"term_vector\" : \"with_positions_offsets\", to use Fast Vector Highlighter and a stopword analyser\r\n```\r\nPUT highlighttest\r\n{\r\n   \"settings\":{\r\n      \"analysis\": {\r\n          \"analyzer\": {\r\n            \"my_analyzer\": {\r\n              \"type\": \"custom\",\r\n              \"tokenizer\": \"standard\",\r\n              \"filter\": [ \r\n                \"lowercase\",\r\n                \"stopfilter\"\r\n              ]\r\n            }\r\n          },\r\n          \"filter\": {\r\n            \"stopfilter\": {\r\n              \"type\":        \"stop\",\r\n              \"stopwords\": [ \"and\", \"the\" ]  \r\n            }\r\n          }\r\n          \r\n       }\r\n    },\r\n   \"mappings\":{\r\n      \"doc\":{\r\n         \"properties\":{\r\n            \"body\": {\r\n               \"type\":\"text\",\r\n               \"analyzer\":\"my_analyzer\",\r\n               \"term_vector\" : \"with_positions_offsets\" \r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```\r\n  2. Index a document with stopwords in it\r\n```\r\nPUT highlighttest/doc/1\r\n{\r\n    \"body\": \"I like the cake\"\r\n}\r\n```\r\n\r\n 3. Query the index with with a matchphrase in a highlight_query, while using stopwords in the searchterm\r\n\r\n```\r\nGET highlighttest/doc/_search\r\n{\r\n    \"query\": {\r\n        \"match_phrase\": {\r\n            \"body\":{\r\n                \"query\":\"like the cake\"\r\n            }\r\n        }\r\n    },\r\n    \"highlight\": {\r\n        \"fields\": {\r\n             \"body\":{\r\n                  \"highlight_query\": {\r\n                        \"match_phrase\": {\r\n                            \"body\":{\r\n                                \"query\":\"like the cake\"\r\n                            }\r\n                        }\r\n                   }\r\n               }\r\n         }\r\n   }\r\n}\r\n```\r\nthe result is\r\n```\r\n{\r\n   \"took\": 3,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 1,\r\n      \"max_score\": 0.5063205,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"highlighttest\",\r\n            \"_type\": \"doc\",\r\n            \"_id\": \"1\",\r\n            \"_score\": 0.5063205,\r\n            \"_source\": {\r\n               \"body\": \"I like the cake\"\r\n            }\r\n         }\r\n      ]\r\n   }\r\n}\r\n```\r\n\r\nAs you can see, I'm using the exact same query in the normal query as in the highlight_query, and the article matches (so match_phrase matches), but it does not get highlighted.\r\n\r\nNote: This works as expected with the plain highlighter. However, I cannot use plain highlighter for my product.\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}