{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17068","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17068/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17068/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17068/events","html_url":"https://github.com/elastic/elasticsearch/issues/17068","id":140170980,"node_id":"MDU6SXNzdWUxNDAxNzA5ODA=","number":17068,"title":" Query using a wildcard is not working on fields which have an icu_collation filter","user":{"login":"ribugent","id":1180455,"node_id":"MDQ6VXNlcjExODA0NTU=","avatar_url":"https://avatars1.githubusercontent.com/u/1180455?v=4","gravatar_id":"","url":"https://api.github.com/users/ribugent","html_url":"https://github.com/ribugent","followers_url":"https://api.github.com/users/ribugent/followers","following_url":"https://api.github.com/users/ribugent/following{/other_user}","gists_url":"https://api.github.com/users/ribugent/gists{/gist_id}","starred_url":"https://api.github.com/users/ribugent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ribugent/subscriptions","organizations_url":"https://api.github.com/users/ribugent/orgs","repos_url":"https://api.github.com/users/ribugent/repos","events_url":"https://api.github.com/users/ribugent/events{/privacy}","received_events_url":"https://api.github.com/users/ribugent/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-03-11T12:17:15Z","updated_at":"2016-03-12T13:11:06Z","closed_at":"2016-03-12T13:11:06Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: \n\n```\n$ bin/elasticsearch --version\nVersion: 2.1.1, Build: 40e2c53/2015-12-15T13:05:55Z, JVM: 1.7.0_80\n```\n\n**JVM version**:\n\n```\n$ java -version\njava version \"1.7.0_80\"\nJava(TM) SE Runtime Environment (build 1.7.0_80-b15)\nJava HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)\n\n```\n\n**OS version**: Ubuntu 15.10\n\n**Description of the problem including expected versus actual behavior**:\nQuery using a wildcard is not working on fields which have an icu_collation filter.\n\n**Steps to reproduce**:\n1 - Create index with a custom analyzer\n\n```\n$ curl -XPUT 'http://localhost:9200/icu_wildcard/?pretty=1' -d '{\n    \"settings\" : {\n        \"index\" : {\n            \"number_of_shards\" : 1,\n            \"number_of_replicas\" : 1\n        },\n        \"analysis\" : {\n          \"analyzer\":{\n            \"unicode_l1\": {\n              \"char_filter\": [\n                \"icu_normalizer_nfc\"\n              ],\n              \"tokenizer\": \"icu_tokenizer\",\n              \"filter\": [\n                \"icu_collation_primary_filter\"\n              ]\n            }\n          },\n          \"char_filter\": {\n            \"icu_normalizer_nfc\": {\n              \"type\": \"icu_normalizer\",\n              \"name\": \"nfc\"\n            }\n          },\n          \"filter\": {\n            \"icu_collation_primary_filter\": {\n              \"type\": \"icu_collation\",\n              \"strength\": \"primary\"\n            }\n          }\n        }\n      }\n}'\n```\n\n2 - Put mapping, with two fields, one with standard analyzer and our custom analyzer\n\n```\n$ curl -XPUT 'http://localhost:9200/icu_wildcard/_mapping/test?pretty=1' -d '\n{\n    \"dynamic\": false,\n    \"_source\": {\n      \"enabled\": false\n    },\n    \"properties\": {\n      \"first_name_unicode\": {\n        \"type\": \"string\",\n        \"analyzer\": \"unicode_l1\"\n      },\n      \"first_name_standard\": {\n        \"type\": \"string\",\n        \"analyzer\": \"standard\"\n      }\n    }\n  }\n}'\n```\n\n3 - Add document\n\n```\n$ curl -XPUT 'http://localhost:9200/icu_wildcard/test/1?pretty=1' -d '{\n    \"first_name_unicode\" : \"ABCDEFGHIJKLabcdefghijkl\",\n    \"first_name_standard\" : \"ABCDEFGHIJKLabcdefghijkl\"\n}'\n$ curl -XPOST 'http://localhost:9200/icu_wildcard/_flush?pretty=1'\n```\n\n4 - Search on text over `first_name_standard` field\n\n```\n$ curl -XGET 'http://localhost:9200/icu_wildcard/test/_search?q=first_name_standard:abcdef*&analyze_wildcard=true&pretty=1'\n```\n\nIt returns:\n\n```\n{\n  \"took\" : 6,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"icu_wildcard\",\n      \"_type\" : \"test\",\n      \"_id\" : \"1\",\n      \"_score\" : 1.0\n    } ]\n  }\n}\n```\n\n5 - Search on text over `first_name_unicode` field\n\n```\n$ curl -XGET 'http://localhost:9200/icu_wildcard/test/_search?q=first_name_unicode:abcdef*&analyze_wildcard=true&pretty=1'\n```\n\nIt returns:\n\n```\n{\n  \"took\" : 4,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 0,\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n```\n\nAs far I know, it should return the same document, but for some reason I don't know, this kind of search isn't working\n\nHope this helps\n","closed_by":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"performed_via_github_app":null}