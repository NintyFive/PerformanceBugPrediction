{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250/events","html_url":"https://github.com/elastic/elasticsearch/issues/13250","id":104305517,"node_id":"MDU6SXNzdWUxMDQzMDU1MTc=","number":13250,"title":"Distributed Search issue ","user":{"login":"diegossilveira","id":347380,"node_id":"MDQ6VXNlcjM0NzM4MA==","avatar_url":"https://avatars1.githubusercontent.com/u/347380?v=4","gravatar_id":"","url":"https://api.github.com/users/diegossilveira","html_url":"https://github.com/diegossilveira","followers_url":"https://api.github.com/users/diegossilveira/followers","following_url":"https://api.github.com/users/diegossilveira/following{/other_user}","gists_url":"https://api.github.com/users/diegossilveira/gists{/gist_id}","starred_url":"https://api.github.com/users/diegossilveira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegossilveira/subscriptions","organizations_url":"https://api.github.com/users/diegossilveira/orgs","repos_url":"https://api.github.com/users/diegossilveira/repos","events_url":"https://api.github.com/users/diegossilveira/events{/privacy}","received_events_url":"https://api.github.com/users/diegossilveira/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-09-01T16:32:16Z","updated_at":"2015-09-02T12:56:16Z","closed_at":"2015-09-02T11:03:17Z","author_association":"NONE","active_lock_reason":null,"body":"When using a Scripted Metric Aggregation, we're facing some weird result inconsistencies:\n\nThe `init_script`:\n\n``` groovy\n_agg['success'] = [];\n_agg['error'] = [];\n_agg['tolerated'] = [];\n_agg['ignored'] = [];\n```\n\nThe `map_script`:\n\n``` groovy\ntags = doc['tags'].values\n\nif(tags.contains('_gw-successful') || tags.contains('_gw-informational')) {\n    return _agg.success.add(1)\n}\nif(tags.contains('_gw-client-error') || tags.contains('_gw-server-error')) {\n    return _agg.error.add(1)\n}\nif(tags.contains('_gw-unauthorized-origin')) {\n    return _agg.ignored.add(1)\n}\n\nreturn _agg.tolerated.add(1)\n```\n\nThe `combine_script`:\n\n``` groovy\n _combine = {}\n\n _combine['error'] = 0\nfor (t in _agg.error) {\n    _combine['error'] += t\n}\n\n_combine['success'] = 0\nfor (t in _agg.success) {\n    _combine['success'] += t\n}\n\n_combine['tolerated'] = 0\nfor (t in _agg.tolerated) {\n    _combine['tolerated'] += t\n}\n\nreturn _combine\n```\n\nThe `reduce_script`:\n\n``` groovy\nerror = 0\nfor (a in _aggs['error']) {\n error += a\n}\nsuccess = 0\nfor (a in _aggs['success']) {\n    success += a\n}\ntolerated = 0\nfor (a in _aggs['tolerated']) {\n    tolerated += a\n}\ntotal = success + error + tolerated\nreturn total > 0 ? (success + tolerated/2)/total : 1\n```\n\nThe `query`:\n\n``` json\n{\n    \"query\": {\n        \"bool\": {\n            \"must\": [\n                {\n                    \"range\": {\n                        \"@timestamp\": {\n                            \"gte\": \"now-5h\"\n                        }\n                    }\n                },\n                {\n                    \"match\": {\n                        \"_entrypoint.id\": 6\n                    }\n                }\n            ]\n        }\n    },\n    \"aggs\": {\n        \"resourcesScore\": {\n            \"filters\": {\n                \"filters\": {\n                    \"81\": {\n                        \"term\": {\n                            \"_resource.id\": 81\n                        }\n                    },\n                    \"83\": {\n                        \"term\": {\n                            \"_resource.id\": 83\n                        }\n                    }\n                }\n            },\n            \"aggs\": {\n                \"apdexScore\": {\n                    \"scripted_metric\": {\n                        \"init_script_file\": \"init_script\",\n                        \"map_script_file\": \"map_script\",\n                        \"combine_script_file\": \"combine_script\",\n                        \"reduce_script_file\": \"reduce_script\"\n                    }\n                },\n                \"responseTime\": {\n                    \"percentiles\": {\n                        \"field\": \"entries.entrypoint.time\",\n                        \"percents\": [\n                            10,\n                            80\n                        ]\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nThis `query` sometimes give us aleatory failures like this:\n\n``` json\n{\n    \"took\": 9,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 5,\n        \"successful\": 3,\n        \"failed\": 2,\n        \"failures\": [\n            {\n                \"index\": \"events-gateway-29-20150901\",\n                \"shard\": 0,\n                \"status\": 500,\n                \"reason\": \"RemoteTransportException[[Shellshock][inet[/192.168.12.37:9300]][indices:data/read/search[phase/query]]]; nested: IOException[Can't write type [class b033d26c7c699de2870d36961a0ba8fc886a1963$_run_closure1]]; \"\n            },\n            {\n                \"index\": \"events-gateway-29-20150901\",\n                \"shard\": 2,\n                \"status\": 500,\n                \"reason\": \"RemoteTransportException[[Asp][inet[/192.168.12.245:9300]][indices:data/read/search[phase/query]]]; nested: IOException[Can't write type [class b033d26c7c699de2870d36961a0ba8fc886a1963$_run_closure1]]; \"\n            }\n        ]\n    },\n    \"hits\": {\n        \"total\": 14,\n        \"max_score\": 0,\n        \"hits\": []\n    },\n    \"aggregations\": {\n        \"resourcesScore\": {\n            \"buckets\": {\n                \"81\": {\n                    \"doc_count\": 14,\n                    \"responseTime\": {\n                        \"values\": {\n                            \"10.0\": 17.2,\n                            \"80.0\": 43.6\n                        }\n                    },\n                    \"apdexScore\": {\n                        \"value\": \"0.0357142857\"\n                    }\n                },\n                \"83\": {\n                    \"doc_count\": 0,\n                    \"responseTime\": {\n                        \"values\": {\n                            \"10.0\": \"NaN\",\n                            \"80.0\": \"NaN\"\n                        }\n                    },\n                    \"apdexScore\": {\n                        \"value\": 1\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nIs there something we're missing or is that a issue with Elasticsearch?\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}