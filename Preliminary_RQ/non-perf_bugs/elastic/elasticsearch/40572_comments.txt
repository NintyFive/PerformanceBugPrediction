[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/477493457","html_url":"https://github.com/elastic/elasticsearch/issues/40572#issuecomment-477493457","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","id":477493457,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NzQ5MzQ1Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-03-28T08:16:00Z","updated_at":"2019-03-28T08:16:31Z","author_association":"MEMBER","body":"Your query contains two `inner_hits` at the same level, one named `comment`:\r\n````\r\n\"inner_hits\": {\r\n\t\"name\": \"comment\",\r\n\t\"highlight\": {\r\n\t\t\"fields\": {\r\n\t\t\t\"commentText_en\": {}\r\n\t\t}\r\n\t}\r\n}\r\n````\r\nand the other one with no name:\r\n````\r\n\"inner_hits\": {}\r\n````\r\n`inner_hits` without names are keyed in the response with the `type` of the `has_child` query where they appear. Since the `type` in this case is `comment`, there is a clash between the two inner_hits definitions. The last `inner_hits` always wins so the results of the first one are discarded. You can \"fix\" your query by setting an explicit name in the empty `inner_hits` definition or change the first one to use another name. Note that starting in `6.7.0` we throw an error if two inner_hits have the same name: https://github.com/elastic/elasticsearch/pull/37645.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/478200166","html_url":"https://github.com/elastic/elasticsearch/issues/40572#issuecomment-478200166","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","id":478200166,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3ODIwMDE2Ng==","user":{"login":"kowndinyav","id":1315693,"node_id":"MDQ6VXNlcjEzMTU2OTM=","avatar_url":"https://avatars1.githubusercontent.com/u/1315693?v=4","gravatar_id":"","url":"https://api.github.com/users/kowndinyav","html_url":"https://github.com/kowndinyav","followers_url":"https://api.github.com/users/kowndinyav/followers","following_url":"https://api.github.com/users/kowndinyav/following{/other_user}","gists_url":"https://api.github.com/users/kowndinyav/gists{/gist_id}","starred_url":"https://api.github.com/users/kowndinyav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kowndinyav/subscriptions","organizations_url":"https://api.github.com/users/kowndinyav/orgs","repos_url":"https://api.github.com/users/kowndinyav/repos","events_url":"https://api.github.com/users/kowndinyav/events{/privacy}","received_events_url":"https://api.github.com/users/kowndinyav/received_events","type":"User","site_admin":false},"created_at":"2019-03-30T02:58:55Z","updated_at":"2019-04-01T04:54:17Z","author_association":"NONE","body":"Hello @jimczi,\r\n\r\nIf I remove, empty inner_hits, reply document snippets are not returned. Please try the same at your end once. If my understanding is wrong, could you please share the query that returns both comments and replies without missing any of the matching snippets. That would be immensely helpful\r\n\r\n-Kowndinya ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/478869992","html_url":"https://github.com/elastic/elasticsearch/issues/40572#issuecomment-478869992","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","id":478869992,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3ODg2OTk5Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-04-02T06:59:48Z","updated_at":"2019-04-02T06:59:48Z","author_association":"MEMBER","body":"I tested the following query in 5.6:\r\n````\r\n{\r\n\t\"query\": {\r\n\t\t\"bool\": {\r\n\t\t\t\"should\": [{\r\n\t\t\t\t\t\"match_phrase_prefix\": {\r\n\t\t\t\t\t\t\"postText_en\": \"document\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"has_child\": {\r\n\t\t\t\t\t\t\"type\": \"comment\",\r\n\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\"match_phrase_prefix\": {\r\n\t\t\t\t\t\t\t\t\"commentText_en\": \"document\"\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\t\"name\": \"comment\",\r\n\t\t\t\t\t\t\t\"highlight\": {\r\n\t\t\t\t\t\t\t\t\"fields\": {\r\n\t\t\t\t\t\t\t\t\t\"commentText_en\": {}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"has_child\": {\r\n\t\t\t\t\t\t\"type\": \"comment\",\r\n\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\"has_child\": {\r\n\t\t\t\t\t\t\t\t\"type\": \"reply\",\r\n\t\t\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\t\t\"match_phrase_prefix\": {\r\n\t\t\t\t\t\t\t\t\t\t\"replyText_en\": \"document\"\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\t\t\t\"name\": \"reply\",\r\n\t\t\t\t\t\t\t\t\t\"highlight\": {\r\n\t\t\t\t\t\t\t\t\t\t\"fields\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"replyText_en\": {}\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\t\"name\": \"comment2\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t},\r\n\t\"highlight\": {\r\n\t\t\"fields\": {\r\n\t\t\t\"postText_en\": {}\r\n\t\t}\r\n\t}\r\n}\r\n````\r\nAs I said above you need to set an explicit name in your `inner_hits` in order to avoid name clash. In the example above I replaced the empty `inner_hits` with:\r\n````\r\n\"inner_hits\": {\r\n  \"name\": \"comment2\"\r\n}\r\n````\r\nand the highlights are returned as expected. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/479352811","html_url":"https://github.com/elastic/elasticsearch/issues/40572#issuecomment-479352811","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","id":479352811,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3OTM1MjgxMQ==","user":{"login":"kowndinyav","id":1315693,"node_id":"MDQ6VXNlcjEzMTU2OTM=","avatar_url":"https://avatars1.githubusercontent.com/u/1315693?v=4","gravatar_id":"","url":"https://api.github.com/users/kowndinyav","html_url":"https://github.com/kowndinyav","followers_url":"https://api.github.com/users/kowndinyav/followers","following_url":"https://api.github.com/users/kowndinyav/following{/other_user}","gists_url":"https://api.github.com/users/kowndinyav/gists{/gist_id}","starred_url":"https://api.github.com/users/kowndinyav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kowndinyav/subscriptions","organizations_url":"https://api.github.com/users/kowndinyav/orgs","repos_url":"https://api.github.com/users/kowndinyav/repos","events_url":"https://api.github.com/users/kowndinyav/events{/privacy}","received_events_url":"https://api.github.com/users/kowndinyav/received_events","type":"User","site_admin":false},"created_at":"2019-04-03T06:06:54Z","updated_at":"2019-04-03T10:01:08Z","author_association":"NONE","body":"Thanks @jimczi  for the query. With this I could get comments and replies as expected but I have few queries. \r\n\r\nWhen I first time wrote the query, I did not have empty \"inner_hits\" fragment. When reply documents were not turning up in highlights section, it was a guess work to add the empty inner_hits as it was not clear from documentation how to resolve this. So, why is it required to add an additional dummy inner_hits for reply documents to turn-up? \r\n\r\nAlso, the clash that you are referring to is between two different \"match\" sections inside \"should\". One match is for matching documents for comment fields and the other one is matching reply fields. As an end user of elastic search, my expectation was that it should have worked without the additional inner_hits. Is this some implementation issue that is addressed in 5.1+ releases already?\r\n\r\nFor me the issue with adding a random name for inner_hits is that it breaks certain assumptions that we make while parsing the response. Essentially we go by type name. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480172372","html_url":"https://github.com/elastic/elasticsearch/issues/40572#issuecomment-480172372","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","id":480172372,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDE3MjM3Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-04-05T07:12:02Z","updated_at":"2019-04-05T07:12:02Z","author_association":"MEMBER","body":"> When I first time wrote the query, I did not have empty \"inner_hits\" fragment. When reply documents were not turning up in highlights section, it was a guess work to add the empty inner_hits as it was not clear from documentation how to resolve this. So, why is it required to add an additional dummy inner_hits for reply documents to turn-up?\r\n\r\nYou have two level of parent-child, `comment` and `reply`. Inner hits for the `reply` section are grandchildren of the root document so you need to provide `inner_hits` for the intermediate level (`comment`) to link the `reply` documents in the response. \r\n\r\n> Also, the clash that you are referring to is between two different \"match\" sections inside \"should\". \r\n\r\nThese two `inner_hits` are at the same level so we need a way to differentiate them, hence the name should be different. \r\n\r\n> For me the issue with adding a random name for inner_hits is that it breaks certain assumptions that we make while parsing the response. Essentially we go by type name.\r\n\r\nThis works if you have a single `inner_hits` per level but in your example you have two `has_child` query at the same level. One thing you can do is to group the `comment` query in a single `has_child` clause:\r\n````\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"should\": [\r\n                {\r\n                    \"match_phrase_prefix\": {\r\n                        \"postText_en\": \"document\"\r\n                    }\r\n                },\r\n                {\r\n                    \"has_child\": {\r\n                        \"type\": \"comment\",\r\n                        \"query\": {\r\n                            \"bool\": {\r\n                                \"should\": [\r\n                                    {\r\n                                        \"match_phrase_prefix\": {\r\n                                            \"commentText_en\": \"document\"\r\n                                        }\r\n                                    },\r\n                                    {\r\n                                        \"has_child\": {\r\n                                            \"type\": \"reply\",\r\n                                            \"query\": {\r\n                                                \"match_phrase_prefix\": {\r\n                                                    \"replyText_en\": \"document\"\r\n                                                }\r\n                                            },\r\n                                            \"inner_hits\": {\r\n                                                \"name\": \"reply\",\r\n                                                \"highlight\": {\r\n                                                    \"fields\": {\r\n                                                        \"replyText_en\": {}\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                ]\r\n                            }\r\n                        },\r\n                        \"inner_hits\": {\r\n                            \"name\": \"comment\",\r\n                            \"highlight\": {\r\n                                \"fields\": {\r\n                                    \"commentText_en\": {}\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"highlight\": {\r\n        \"fields\": {\r\n            \"postText_en\": {}\r\n        }\r\n    }\r\n}\r\n````\r\n\r\n@kowndinyav if you have any further questions please don't answer in this issue but open a topic in the [discuss forum](https://discuss.elastic.co/c/elasticsearch), we reserve github for verified bugs and feature requests. ","performed_via_github_app":null}]