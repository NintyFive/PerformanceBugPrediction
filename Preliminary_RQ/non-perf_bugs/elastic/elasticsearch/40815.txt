{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40815","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40815/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40815/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40815/events","html_url":"https://github.com/elastic/elasticsearch/issues/40815","id":428980446,"node_id":"MDU6SXNzdWU0Mjg5ODA0NDY=","number":40815,"title":"Inline char filter preventing rolling upgrade from 5.x to 6.x","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""},{"id":1163688906,"node_id":"MDU6TGFiZWwxMTYzNjg4OTA2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.0","name":"v6.7.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-04-03T21:20:30Z","updated_at":"2019-04-09T09:49:30Z","closed_at":"2019-04-09T09:49:29Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"A user [reported the following exception](https://discuss.elastic.co/t/encountering-only-value-lists-are-allowed-in-serialized-settings-exception-after-upgrade-to-6-7-0-from-5-6-5/175254) preventing a node from starting in a rolling upgrade from 5.6.5 to 6.7.0:\r\n\r\n```\r\n[2019-04-03T12:04:06,926][ERROR][o.e.b.Bootstrap          ] [node-1] Exception\r\norg.elasticsearch.ElasticsearchException: java.io.IOException: failed to read [id:1, file:/var/lib/elasticsearch/nodes/0/_state/global-1.st]\r\n        at org.elasticsearch.ExceptionsHelper.maybeThrowRuntimeAndSuppress(ExceptionsHelper.java:164) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:304) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.gateway.MetaStateService.loadGlobalState(MetaStateService.java:112) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.gateway.MetaStateService.loadFullState(MetaStateService.java:57) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.gateway.GatewayMetaState.<init>(GatewayMetaState.java:88) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.node.Node.<init>(Node.java:499) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.node.Node.<init>(Node.java:266) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:212) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:212) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:333) [elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) [elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:150) [elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) [elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124) [elasticsearch-cli-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.cli.Command.main(Command.java:90) [elasticsearch-cli-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:116) [elasticsearch-6.7.0.jar:6.7.0]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:93) [elasticsearch-6.7.0.jar:6.7.0]\r\nCaused by: java.io.IOException: failed to read [id:1, file:/var/lib/elasticsearch/nodes/0/_state/global-1.st]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:298) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n        ... 15 more\r\nCaused by: java.lang.IllegalStateException: only value lists are allowed in serialized settings\r\n        at org.elasticsearch.common.settings.Settings.fromXContent(Settings.java:692) ~[elasticsearch-6.7.0.jar:6.7.0]\r\n```\r\n\r\nThey provided the offending file and we discovered that there was an index template with an inline `char_filter`:\r\n\r\n```\r\n          'brand_replacement' => [\r\n              'tokenizer' => 'brand_replacement',\r\n              'filter' => ['trim', 'lowercase'],\r\n              'char_filter' => [\r\n                 [\r\n                   'type' => 'pattern_replace',\r\n                   'pattern' => '-',\r\n                   'replacement' => ' '\r\n                  ]\r\n              ]\r\n          ]\r\n```\r\n\r\nIndeed the error is thrown on encountering a `START_OBJECT` here in the metadata file (converted to pseudo-JSON):\r\n\r\n```\r\n\"brand_replacement\":{\r\n  \"filter\":\r\n    [\r\n      \"trim\",\r\n      \"lowercase\"\r\n    ],\r\n  \"char_filter\":[{\r\n```\r\n\r\nIt seems from the reference manual that these inline char filters were supported in 2.4 but dropped in 5.0. I am presuming that this template came from a pre-5.0 upgrade but haven't tested the full upgrade path to verify this. I'm not too familiar with the history of this setting and can't see anything obvious in the breaking changes docs so I'm not sure where this should have been caught.\r\n\r\nThey reported that removing the offending template allowed the upgrade to proceed.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}