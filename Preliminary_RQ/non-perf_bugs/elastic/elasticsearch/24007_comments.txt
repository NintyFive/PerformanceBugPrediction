[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292924772","html_url":"https://github.com/elastic/elasticsearch/issues/24007#issuecomment-292924772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24007","id":292924772,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MjkyNDc3Mg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2017-04-10T11:38:44Z","updated_at":"2017-04-10T11:38:44Z","author_association":"MEMBER","body":"one more failure, this time from 5.x: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.x+multijob-darwin-compatibility/364","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292977153","html_url":"https://github.com/elastic/elasticsearch/issues/24007#issuecomment-292977153","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24007","id":292977153,"node_id":"MDEyOklzc3VlQ29tbWVudDI5Mjk3NzE1Mw==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2017-04-10T15:03:15Z","updated_at":"2017-04-10T15:03:15Z","author_association":"MEMBER","body":"For master, shadow replicas are going away entirely in #23906, I'll take a look at the 5.x failure","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292986688","html_url":"https://github.com/elastic/elasticsearch/issues/24007#issuecomment-292986688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24007","id":292986688,"node_id":"MDEyOklzc3VlQ29tbWVudDI5Mjk4NjY4OA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2017-04-10T15:33:30Z","updated_at":"2017-04-10T15:33:30Z","author_association":"MEMBER","body":"I marked it as AwaitsFix in master until it is removed also","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/293252192","html_url":"https://github.com/elastic/elasticsearch/issues/24007#issuecomment-293252192","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24007","id":293252192,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MzI1MjE5Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-04-11T12:58:39Z","updated_at":"2017-04-11T12:58:39Z","author_association":"CONTRIBUTOR","body":"OK, I think I know what's going on:\r\n\r\n- Async shard fetching is started for all 3 nodes (`node_t0`, `node_t1`, `node_t2`) :\r\n\r\n```\r\n[2017-04-09T12:01:26,948][TRACE][o.e.g.GatewayAllocator$InternalReplicaShardAllocator] [node_t0] [test][0] fetching [shard_store] from [{node_t2}{YzGiBQKJQZSF-m9vJklUJw}{Jv31eJhcRFapDP8BpNprvg}{127.0.0.1}{127.0.0.1:9482}, {node_t0}{MzEFZ1OiRkmhUyhzBZIKug}{jc19yNiyQFSaFGU74Yxy1g}{127.0.0.1}{127.0.0.1:9480}, {node_t1}{JPMaUNu3SY-r_wuVThJr0w}{BKmWE4tRTJOf62nrbVtaCQ}{127.0.0.1}{127.0.0.1:9481}]\r\n```\r\n\r\n- Node `node_t1` is restarted while async fetching is going on\r\n```\r\n[2017-04-09T12:01:26,969][INFO ][o.e.c.s.ClusterService   ] [node_t0] removed {{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{BKmWE4tRTJOf62nrbVtaCQ}{127.0.0.1}{127.0.0.1:9481},}, reason: zen-disco-node-failed({node_t1}{JPMaUNu3SY-r_wuVThJr0w}{BKmWE4tRTJOf62nrbVtaCQ}{127.0.0.1}{127.0.0.1:9481}), reason(transport disconnected)[{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{BKmWE4tRTJOf62nrbVtaCQ}{127.0.0.1}{127.0.0.1:9481} transport disconnected]\r\n```\r\n- In the cluster state update where `node_t1` is removed, it's `NodeEntry` is being removed from the `cache` field in the `AsyncShardFetch` class.\r\n\r\n- While `node_t1` rejoins, a new `NodeEntry` is added to the `cache` field in the `AsyncShardFetch` is added and another fetching attempt is made for `node_t1`:\r\n\r\n```\r\n[2017-04-09T12:01:26,984][TRACE][o.e.g.GatewayAllocator$InternalReplicaShardAllocator] [node_t0] [test][0] fetching [shard_store] from [{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{nT-bJ889Rb2_eIpe_TjrPw}{127.0.0.1}{127.0.0.1:9481}]\r\n// The zen-disco-node-join message happens later here but the shard_store fetching is caused by the join.\r\n[2017-04-09T12:01:26,985][INFO ][o.e.c.s.ClusterService   ] [node_t0] added {{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{nT-bJ889Rb2_eIpe_TjrPw}{127.0.0.1}{127.0.0.1:9481},}, reason: zen-disco-node-join[{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{nT-bJ889Rb2_eIpe_TjrPw}{127.0.0.1}{127.0.0.1:9481}]\r\n```\r\n\r\n- **As the `cache` field is keyed by the persistent node id**, the cache does not distinguish between old `node_t1 ` and new `node_t1`.\r\n\r\n- We have now two responses coming back for `node_t1` (first a successful one, then a failure):\r\n\r\n```\r\n[2017-04-09T12:01:27,014][TRACE][o.e.g.GatewayAllocator$InternalReplicaShardAllocator] [node_t0] [test][0] marking JPMaUNu3SY-r_wuVThJr0w as done for [shard_store], result is [[[{node_t1}{JPMaUNu3SY-r_wuVThJr0w}{nT-bJ889Rb2_eIpe_TjrPw}{127.0.0.1}{127.0.0.1:9481}][StoreFilesMetaData{, shardId=[test][0], metadataSnapshot{size=4, syncId=null}}]]]\r\n...\r\n\r\n[2017-04-09T12:01:27,026][TRACE][o.e.g.GatewayAllocator$InternalReplicaShardAllocator] [node_t0] [test][0] processing failure FailedNodeException[Failed node [JPMaUNu3SY-r_wuVThJr0w]]; nested: NodeNotConnectedException[[node_t1][127.0.0.1:9481] Node not connected]; for [shard_store]\r\n...\r\n\r\n\r\n1> [2017-04-09T12:01:27,026][WARN ][o.e.g.GatewayAllocator$InternalReplicaShardAllocator] [node_t0] [test][0]: failed to list shard for shard_store on node [JPMaUNu3SY-r_wuVThJr0w]\r\n  1> org.elasticsearch.action.FailedNodeException: Failed node [JPMaUNu3SY-r_wuVThJr0w]\r\n  1> \tat ...\r\n```\r\n- This trips the assertion\r\n```\r\nCaused by: java.lang.AssertionError: setting value but not in fetching mode\r\n   > \tat __randomizedtesting.SeedInfo.seed([4FDB1AE2E4E7D59C]:0)\r\n   > \tat org.elasticsearch.gateway.AsyncShardFetch$NodeEntry.doneFetching(AsyncShardFetch.java:372)\r\n   > \tat org.elasticsearch.gateway.AsyncShardFetch.processAsyncFetch(AsyncShardFetch.java:206)\r\n```\r\n\r\n@dakrone We can discuss solutions if you like.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298843861","html_url":"https://github.com/elastic/elasticsearch/issues/24007#issuecomment-298843861","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24007","id":298843861,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODg0Mzg2MQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-05-03T07:48:13Z","updated_at":"2017-05-03T07:48:13Z","author_association":"CONTRIBUTOR","body":"Closed by #24434","performed_via_github_app":null}]