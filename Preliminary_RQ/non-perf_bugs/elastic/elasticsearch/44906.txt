{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44906","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44906/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44906/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44906/events","html_url":"https://github.com/elastic/elasticsearch/issues/44906","id":473387640,"node_id":"MDU6SXNzdWU0NzMzODc2NDA=","number":44906,"title":"[ML-DataFrame] NPE if no source index available / revisit empty set of source indexes","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1442574459,"node_id":"MDU6TGFiZWwxNDQyNTc0NDU5","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.3.1","name":"v7.3.1","color":"dddddd","default":false,"description":""},{"id":1434538947,"node_id":"MDU6TGFiZWwxNDM0NTM4OTQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.4.0","name":"v7.4.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-07-26T14:29:40Z","updated_at":"2019-08-06T19:54:08Z","closed_at":"2019-08-06T19:54:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Originally at lease 1 source index was required, in case of a pattern new index could appear but it wasn't allowed to remove them. To support ILM however we decided to relax this constraint and allow the deletion of indexes, see https://github.com/elastic/elasticsearch/pull/44344.\r\n\r\nAs indexes could get deleted while indexing is running it could happen that searches fail if the index is closed at the moment we try to access it, that's why we had to switch to lenient source index expansion: https://github.com/elastic/elasticsearch/pull/44633\r\n\r\nThis had a bad side effect: sources indexes can run empty which breaks assumptions made in various places of the indexer, e.g. leading to a NPE:\r\n\r\n```\r\n[2019-07-25T06:49:38,936][WARN ][o.e.x.d.t.DataFrameTransformTask] [ml-qa-ubuntu-5] Data frame transform [dft_failed_missing_source_index_1564037378655] encountered an exception: \r\njava.lang.NullPointerException: null\r\n    at org.elasticsearch.xpack.dataframe.transforms.DataFrameIndexer.doProcess(DataFrameIndexer.java:170) ~[?:?]\r\n    at org.elasticsearch.xpack.core.indexing.AsyncTwoPhaseIndexer.onSearchResponse(AsyncTwoPhaseIndexer.java:337) ~[?:?]\r\n    at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n    at org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n    at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:68) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n```\r\n\r\n(the NPE happens as we try to access the non-existing `aggs` object in the response)\r\n\r\n## Solution\r\n\r\n - ~if a concrete index is involved and the set of source indexes gets empty the transform should fail~\r\n - ~if the source is a pattern~ we allow source getting empty\r\n\r\n=> always be lenient (whether or not source is a pattern)\r\n=> require a non-empty source(index, not document-wise!) on `_preview` and `PUT`\r\n\r\n## Dev Notes\r\n\r\n - check for empty source set / results:\r\n   - at validation time if validation is not deferred do not allow an empty set, independent of pattern usage\r\n   - at preview, independent of pattern usage\r\n - expect empty/null results, code needs to be hardened for that\r\n\r\n## Discuss\r\n\r\n=> a strict mode will be provided once we see a demand for it\r\n\r\nOutdated:\r\n\r\nThe deletion of source indexes seem only relevant if source indexes are managed by ILM and for continuous data frames:\r\n\r\n- should batch data frames be strict like before?\r\n- even if continuous is used you might not want to \"loose\" data without notice, should we have a parameter for strictness (while lenient can be the default)?\r\n  - or use `index` for non-ILM and `index_patterns` for ILM:\r\n\r\nnon-ILM:\r\n```\r\n\"source\": {\r\n    \"index\": \"kibana_sample_data_ecommerce\",\r\n    \"query\": {}\r\n...\r\n```\r\n\r\nILM: \r\n```\r\n\"source\": {\r\n    \"index_patterns\": [\"events-*\"],\r\n    \"query\": {}\r\n...\r\n```","closed_by":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"performed_via_github_app":null}