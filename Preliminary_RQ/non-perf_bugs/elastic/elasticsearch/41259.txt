{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41259","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41259/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41259/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41259/events","html_url":"https://github.com/elastic/elasticsearch/issues/41259","id":433818127,"node_id":"MDU6SXNzdWU0MzM4MTgxMjc=","number":41259,"title":"Highlighted word is out of order in snippet when searching in Arabic","user":{"login":"RichardBradley","id":1265780,"node_id":"MDQ6VXNlcjEyNjU3ODA=","avatar_url":"https://avatars3.githubusercontent.com/u/1265780?v=4","gravatar_id":"","url":"https://api.github.com/users/RichardBradley","html_url":"https://github.com/RichardBradley","followers_url":"https://api.github.com/users/RichardBradley/followers","following_url":"https://api.github.com/users/RichardBradley/following{/other_user}","gists_url":"https://api.github.com/users/RichardBradley/gists{/gist_id}","starred_url":"https://api.github.com/users/RichardBradley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RichardBradley/subscriptions","organizations_url":"https://api.github.com/users/RichardBradley/orgs","repos_url":"https://api.github.com/users/RichardBradley/repos","events_url":"https://api.github.com/users/RichardBradley/events{/privacy}","received_events_url":"https://api.github.com/users/RichardBradley/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-04-16T14:39:21Z","updated_at":"2019-05-22T16:20:04Z","closed_at":"2019-05-22T16:20:04Z","author_association":"NONE","active_lock_reason":null,"body":"(This is a bug report.)\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): a) 6.7.0 local and b) 6.5 on AWS\r\n\r\n**Plugins installed**: a) [Netty4Plugin, CommonAnalysisPlugin] local and b) none / default on AWS\r\n\r\n**JVM version** (`java -version`): a) 1.8.0_151 local and b) ??? on AWS\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): a) Windows 10 local and b) ??? linux on AWS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen highlighting a searched word in a snippet in Arabic, the highlighted word is put on the right hand end of the line, out of order with its containing sentence. This does not occur when highlighting the whole field or for very short documents.\r\n\r\n**Steps to reproduce**:\r\n\r\nThis is the shortest document I could find that reproduces the issue.\r\n\r\nThere are lots of \"RTL\" characters in the following text, which can be difficult to manipulate in text editors. The text here should survive copy & paste on most modern systems.\r\n\r\nI do not speak Arabic myself, so I apologize if any of the text below is garbled. The issue is related to the highlighting algorithm in Elasticsearch and not directly related to the text content here.\r\n\r\nStart a blank Elasticsearch, v6.7.0\r\n\r\nCreate an index \r\n\r\n```\r\nPORT=9400\r\n\r\ncurl -X PUT \"localhost:$PORT/test\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"number_of_shards\" : 1\r\n    },\r\n    \"mappings\" : {\r\n\t    \"_doc\" : {\r\n            \"properties\" : {\r\n                \"transcript\" : { \"type\" : \"text\", \"analyzer\": \"arabic\" }\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n```\r\n\r\nIndex a document with the problem Arabic text:\r\n\r\n```\r\ncurl -X PUT \"localhost:$PORT/test/_doc/1\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"transcript\":\" عمر أشعلت هذه النائبة الديمقراطية من  ولاية مينيسوتا الأميركية وهي واحدة من  بين أول امرأتين مسلمتين وأول محجبة في  الكونغرس أشعلت عاصفة من الانتقادات من  الديمقراطيين والجمهوريين على حد سواء في  الكونجرس اتهمت بمعاداة السامية وطالما  الترام بالإستقالة  هذه القصة قصة هذه المرأة  الصحفي على توتر  زعيم الحزب الجمهوري كيفين مكارثي يهدد  بعقوبة إيلهان عمر ورشيدة إطلاق بسبب  انتقاداته لإسرائيل  كم من الوقت يقضي الزعماء السياسيون  الأميركيون في الدفاع عن دولة أجنبية حتى  لو كان ذلك يعني مهاجمة حقوق حرية التعبير  للأميركيين  عمر على هذا السؤال بهذه التغريدة التي  قالت فيها إن الأمر يتعلق برضيع أسرته  بنيامين بن جبل تتحدث هنا المصطلح الذي  يعني بالعامية ورقة النقد الأميركي فئة ما  الدولار التي عليها صورة  بنيامين  دفع شخص آخر للتغريد وسؤال إلهان  أحب أن أعرف  إلهام عمر  أنه يدفع للسياسيين الأميركيين لأن يكونوا  مؤيدين لإسرائيل على الرغم من أنني أعتقد  أنه بإمكان التخمين  أردت إلهان عليه في هذه التغريدة  التي اعتبرت معادية للسامية تقول ما يدفع  لهم هو أيباك  وهو مختصر للجنة الشؤون العامة الأميركية  الإسرائيلية وهي جماعة الضغط المعنية  بمصالح إسرائيل أثارت هذه التصريحات موجة  من الغضب مما دفع رئيسة مجلس النواب نانسي  بيلوسي وقادت وديمقراطيون آخرون لإصدار  بيان أدانوا فيه التغريدة مطالبين إلى أن  عمر بالاعتذار الفوري على تلك التعليقات  المسيئة جاء في ذلك البيان من نانسي بلوسي  النقد المشروع لسياسات إسرائيل مقفول بقيم  حرية التعبير والنقاش الديمقراطي التي  تشترك في الإيمان بها كل من الولايات  المتحدة  إسرائيل ما استخدمته عضوة الكونغرس إلهان  عمر من عبارات مجازية معادية للسامية وما  واجهته من اتهامات مجحفة لداعمي إسرائيل  فقد كان أمرا مسيئا للغاية اضطرت إلى  إصدار بيان قدمت فيه  تقول فيه إلهام معاداة السامية حقيقية لم  يكن فنية أبدا إزعاج الناخبين أو  الأميركيين اليهود ولهذا أعتذر على نحو لا  لبس فيه في الوقت نفسه أعيد تأكيد الدور  الإشكالي الذي تؤديه جماعات الضغط في  سياستنا على الرغم من اعتذار  طالبها بالإسلام قال دعونا نستمع إلى ما  قاله التراب بحقها  أقسام  كويس  كويس  لا مكان لمعاداة السامية في الكونغرس  الأميركي ما قالته عضوة الكونغرس عمر فضية  أعتقد أن على عمر أن تستقيل من الكونغرس  أو بالتأكيد تستقيل من لجنة العلاقات  الدولية التابعة لمجلس النواب ما قالته  عمر متجذر في قلبها اعتذارها أعرفش وهي لم  تكن تعني كلمة واحدة منه  بعد تصريح وأعرب مسؤولون وأعضاء في الحزب  الديمقراطي الأميركي عن دعمهم لإيلهان  منهم بوجان وبابيلا جايبال واللذان قال  مطالبته بالاستقالة مخجلة وغير مسؤول وغير  مستغربة وإذا كانت خلال فترة ترشحه  ورئاسته امتدح دائما القومية البيضاء  والإسلام فوبيا والتمييز الجنسي والعنصرية  دون أن يعتذر عن ذلك وأكد ضرورة عدم نسيان  أن ترامب اعتبر النازيين الجدد أناسا  جيدين\"\r\n}'\r\n```\r\n\r\n(This string is just Arabic letters and the space character, there are no non-printable characters.)\r\n\r\nQuery this document, with highlighting on the whole field, for the search term \"التخمين\":\r\n\r\n```\r\ncurl \"localhost:$PORT/test/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"query\": {\r\n                \"query_string\": {\r\n                    \"query\": \"التخمين\",\r\n                    \"fields\": [\"transcript\"]\r\n                }\r\n    },\r\n    \"highlight\": {\r\n        \"number_of_fragments\": 0,\r\n        \"require_field_match\": true,\r\n        \"encoder\": \"html\",\r\n        \"fields\": {\"transcript\": {}}\r\n    }\r\n}\r\n'\r\n```\r\n\r\nThis works fine for me.\r\nThe highlighting includes:\r\n   `غم من أنني أعتقد  أنه بإمكان <em>التخمين</em>  أردت إلهان عليه في هذه التغر`\r\n   \r\nNow query with a snippet highlight:\r\n\r\n```\r\ncurl \"localhost:$PORT/test/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"query\": {\r\n                \"query_string\": {\r\n                    \"query\": \"التخمين\",\r\n                    \"fields\": [\"transcript\"]\r\n                }\r\n    },\r\n    \"highlight\": {\r\n        \"require_field_match\": true,\r\n        \"encoder\": \"html\",\r\n        \"fields\": {\"transcript\": {}}\r\n    }\r\n}\r\n'\r\n```\r\n\r\nThe returned highlight has the matched word at the right hand end of the snippet, out of place in the sentence:\r\n\r\n`\"highlight\":{\"transcript\":[\"عمر  أنه يدفع للسياسيين الأميركيين لأن يكونوا  مؤيدين لإسرائيل على الرغم من أنني أعتقد  أنه بإمكان <em>التخمين</em>\"]}}`\r\n\r\nI believe this is a bug, and the highlighted word should appear in place.\r\n\r\nCan anyone tell me if I have done something wrong here, or if there is any way to work around this bug pending a fix?\r\n\r\nThanks,\r\n\r\n\r\nRich","closed_by":{"login":"RichardBradley","id":1265780,"node_id":"MDQ6VXNlcjEyNjU3ODA=","avatar_url":"https://avatars3.githubusercontent.com/u/1265780?v=4","gravatar_id":"","url":"https://api.github.com/users/RichardBradley","html_url":"https://github.com/RichardBradley","followers_url":"https://api.github.com/users/RichardBradley/followers","following_url":"https://api.github.com/users/RichardBradley/following{/other_user}","gists_url":"https://api.github.com/users/RichardBradley/gists{/gist_id}","starred_url":"https://api.github.com/users/RichardBradley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RichardBradley/subscriptions","organizations_url":"https://api.github.com/users/RichardBradley/orgs","repos_url":"https://api.github.com/users/RichardBradley/repos","events_url":"https://api.github.com/users/RichardBradley/events{/privacy}","received_events_url":"https://api.github.com/users/RichardBradley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}