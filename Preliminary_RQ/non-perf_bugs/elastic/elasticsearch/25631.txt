{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25631","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25631/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25631/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25631/events","html_url":"https://github.com/elastic/elasticsearch/issues/25631","id":241699426,"node_id":"MDU6SXNzdWUyNDE2OTk0MjY=","number":25631,"title":"Unable to complete version upgrade after master with lower version died, new master with higher version got elected and index was created","user":{"login":"nachogiljaldo","id":998352,"node_id":"MDQ6VXNlcjk5ODM1Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/998352?v=4","gravatar_id":"","url":"https://api.github.com/users/nachogiljaldo","html_url":"https://github.com/nachogiljaldo","followers_url":"https://api.github.com/users/nachogiljaldo/followers","following_url":"https://api.github.com/users/nachogiljaldo/following{/other_user}","gists_url":"https://api.github.com/users/nachogiljaldo/gists{/gist_id}","starred_url":"https://api.github.com/users/nachogiljaldo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nachogiljaldo/subscriptions","organizations_url":"https://api.github.com/users/nachogiljaldo/orgs","repos_url":"https://api.github.com/users/nachogiljaldo/repos","events_url":"https://api.github.com/users/nachogiljaldo/events{/privacy}","received_events_url":"https://api.github.com/users/nachogiljaldo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-07-10T12:44:14Z","updated_at":"2017-09-29T21:36:30Z","closed_at":"2017-07-10T14:09:19Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.4.1 and 5.4.2 (probably others as well)\r\n\r\n**Plugins installed**: [`repository-s3`, `x-pack`]\r\n\r\n**JVM version** (`java -version`):1.8.0_131-b11\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): 14.04.1-Ubuntu\r\n\r\n**Description of the problem including expected versus actual behaviour**: \r\nI am aware the check that triggers this makes sense and is intended, but it could create issues during version upgrade. So I prefer to report it.\r\nI was performing an upgrade from version 5.4.1 to 5.5.0, this was performed using a grow-and-shrink approach. The node had 1 cluster only. I created an instance with 5.5.0 joined it to the node and started migrating data from the 5.4.1 to the 5.5.0 instance.\r\nAt some point 5.4.1 crashed (I still don't know the reason, but let's assume it has nothing to do with elasticsearch, i.e. power outage on the box), the node 5.5.0 became master and a new index was created in it. When 5.4.1 came back, it was unable to join the cluster, meaning the data could not be migrated.\r\n\r\nIt would be interesting to know what happens in an scenario similar to this one but with more instances, how do they get affected, if the elected master has the newer version and an index is created.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create a one node cluster with 5.4.1 (let's call the node A)\r\n 2. Put some data in it\r\n 3. Add a node B with version 5.5.0 to the cluster\r\n 4. Wait until it joins\r\n 5. Kill A\r\n 6. Wait until B becomes master\r\n 7. Create an index (any index)\r\n 8. Restart A\r\n\r\n**Provide logs (if relevant)**:\r\n The 5.4.1 node was logging this every couple of seconds: \r\n\r\n```logs\r\n[2017-07-10T12:24:48,473][INFO ][org.elasticsearch.discovery.zen.ZenDiscovery] failed to send join request to master [{instance-0000000001}{rel-q4ZcRAeTmeEv1Z5SCQ}{QFzYgblKR_-866FEZIyiXA}{192.168.43.10}{192.168.43.10:19440}{logical_availability_zone=zone-0, region=unknown-region, availability_zone=ece-1a}], reason [RemoteTransportException[[instance-0000000001][172.17.0.13:19440][internal:discovery/zen/join]]; nested: IllegalStateException[index [test_index3/ARhFDVwqTEawlODT3_4IxQ] version not supported: 5.5.0 the node version is: 5.4.1]; ]\r\n[2017-07-10T12:24:51,573][INFO ][org.elasticsearch.discovery.zen.ZenDiscovery] failed to send join request to master [{instance-0000000001}{rel-q4ZcRAeTmeEv1Z5SCQ}{QFzYgblKR_-866FEZIyiXA}{192.168.43.10}{192.168.43.10:19440}{logical_availability_zone=zone-0, region=unknown-region, availability_zone=ece-1a}], reason [RemoteTransportException[[instance-0000000001][172.17.0.13:19440][internal:discovery/zen/join]]; nested: IllegalStateException[index [test_index3/ARhFDVwqTEawlODT3_4IxQ] version not supported: 5.5.0 the node version is: 5.4.1]; ]\r\n```\r\nThis seems to be: https://github.com/elastic/elasticsearch/blob/v5.4.2/core/src/main/java/org/elasticsearch/discovery/zen/MembershipAction.java#L197-L211\r\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}