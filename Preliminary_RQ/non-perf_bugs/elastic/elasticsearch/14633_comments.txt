[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155364693","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155364693","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155364693,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTM2NDY5Mw==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T09:14:22Z","updated_at":"2015-11-10T09:14:22Z","author_association":"MEMBER","body":"@xuzha I totally agree with your findings.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155368982","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155368982","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155368982,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTM2ODk4Mg==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T09:33:21Z","updated_at":"2015-11-10T09:33:21Z","author_association":"MEMBER","body":"I looked at the code but apparently there is no real way today to close the `S3Object`. Actually `BlobContainer` interface needs an `InputStream` with:\n\n``` java\n    /**\n     * Creates a new InputStream for the given blob name\n     */\n    InputStream readBlob(String blobName) throws IOException;\n```\n\nWhen we use it for example in BlobStoreRepository class we call:\n\n``` java\n    /**\n     * Reads snapshot index file\n     * <p>\n     * This file can be used by read-only repositories that are unable to list files in the repository\n     *\n     * @return list of snapshots in the repository\n     * @throws IOException I/O errors\n     */\n    protected List<SnapshotId> readSnapshotList() throws IOException {\n        try (InputStream blob = snapshotsBlobContainer.readBlob(SNAPSHOTS_FILE)) {\n            BytesStreamOutput out = new BytesStreamOutput();\n            Streams.copy(blob, out);\n            ArrayList<SnapshotId> snapshots = new ArrayList<>();\n            try (XContentParser parser = XContentHelper.createParser(out.bytes())) {\n                if (parser.nextToken() == XContentParser.Token.START_OBJECT) {\n                    if (parser.nextToken() == XContentParser.Token.FIELD_NAME) {\n                        String currentFieldName = parser.currentName();\n                        if (\"snapshots\".equals(currentFieldName)) {\n                            if (parser.nextToken() == XContentParser.Token.START_ARRAY) {\n                                while (parser.nextToken() != XContentParser.Token.END_ARRAY) {\n                                    snapshots.add(new SnapshotId(repositoryName, parser.text()));\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n            return Collections.unmodifiableList(snapshots);\n        }\n    }\n```\n\nThere is no way here to call `S3Object#close`. I think we should may be add a `closeInputStream()` method or something like this in `BlobContainer` interface. @imotov WDYT?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155525522","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155525522","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155525522,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTUyNTUyMg==","user":{"login":"xuzha","id":1799964,"node_id":"MDQ6VXNlcjE3OTk5NjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1799964?v=4","gravatar_id":"","url":"https://api.github.com/users/xuzha","html_url":"https://github.com/xuzha","followers_url":"https://api.github.com/users/xuzha/followers","following_url":"https://api.github.com/users/xuzha/following{/other_user}","gists_url":"https://api.github.com/users/xuzha/gists{/gist_id}","starred_url":"https://api.github.com/users/xuzha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xuzha/subscriptions","organizations_url":"https://api.github.com/users/xuzha/orgs","repos_url":"https://api.github.com/users/xuzha/repos","events_url":"https://api.github.com/users/xuzha/events{/privacy}","received_events_url":"https://api.github.com/users/xuzha/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T18:38:18Z","updated_at":"2015-11-10T18:38:18Z","author_association":"CONTRIBUTOR","body":"@dadoonet I took another look this morning\n\nI think this is fine in master, in `Streams.copy(blob, out)` we do close inputstream after use. `S3object.close()` is just close the `inputstream`, so I think this issue is fine in 3.0.\n\nBut in 2.x and 2.1 `google.common.io.ByteStreams` do not close the streams. That are not liberated after `readSnapshotList()`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155531953","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155531953","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155531953,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTUzMTk1Mw==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T19:00:44Z","updated_at":"2015-11-10T19:00:50Z","author_association":"MEMBER","body":"Interesting. Indeed we found with @imotov today when looking at the code that calling actually `S3object.close()` is useless and won't fix the issue but we did not look at 2.x branch I guess! Awesome. Do you think you'll have time for a PR or do you want me to look at it on thursday?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155532750","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155532750","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155532750,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTUzMjc1MA==","user":{"login":"xuzha","id":1799964,"node_id":"MDQ6VXNlcjE3OTk5NjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1799964?v=4","gravatar_id":"","url":"https://api.github.com/users/xuzha","html_url":"https://github.com/xuzha","followers_url":"https://api.github.com/users/xuzha/followers","following_url":"https://api.github.com/users/xuzha/following{/other_user}","gists_url":"https://api.github.com/users/xuzha/gists{/gist_id}","starred_url":"https://api.github.com/users/xuzha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xuzha/subscriptions","organizations_url":"https://api.github.com/users/xuzha/orgs","repos_url":"https://api.github.com/users/xuzha/repos","events_url":"https://api.github.com/users/xuzha/events{/privacy}","received_events_url":"https://api.github.com/users/xuzha/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T19:03:57Z","updated_at":"2015-11-10T19:03:57Z","author_association":"CONTRIBUTOR","body":"Thanks @dadoonet, I could make a PR for this later today.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155574405","html_url":"https://github.com/elastic/elasticsearch/issues/14633#issuecomment-155574405","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14633","id":155574405,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTU3NDQwNQ==","user":{"login":"xuzha","id":1799964,"node_id":"MDQ6VXNlcjE3OTk5NjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1799964?v=4","gravatar_id":"","url":"https://api.github.com/users/xuzha","html_url":"https://github.com/xuzha","followers_url":"https://api.github.com/users/xuzha/followers","following_url":"https://api.github.com/users/xuzha/following{/other_user}","gists_url":"https://api.github.com/users/xuzha/gists{/gist_id}","starred_url":"https://api.github.com/users/xuzha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xuzha/subscriptions","organizations_url":"https://api.github.com/users/xuzha/orgs","repos_url":"https://api.github.com/users/xuzha/repos","events_url":"https://api.github.com/users/xuzha/events{/privacy}","received_events_url":"https://api.github.com/users/xuzha/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T21:36:10Z","updated_at":"2015-11-10T21:36:10Z","author_association":"CONTRIBUTOR","body":"@dadoonet, we do close the stream in 2.x,  within the `try {}` block. \n\nI double checked. This should be a false alarm. I'm sorry, closing the issue.\n","performed_via_github_app":null}]