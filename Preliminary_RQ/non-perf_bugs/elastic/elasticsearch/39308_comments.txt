[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466376179","html_url":"https://github.com/elastic/elasticsearch/issues/39308#issuecomment-466376179","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39308","id":466376179,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjM3NjE3OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T12:10:54Z","updated_at":"2019-02-22T12:10:54Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466379794","html_url":"https://github.com/elastic/elasticsearch/issues/39308#issuecomment-466379794","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39308","id":466379794,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjM3OTc5NA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T12:26:00Z","updated_at":"2019-02-22T12:26:00Z","author_association":"MEMBER","body":"The actual cause of the failure is that instead of index following failing with an index not found exception, index following fails with a NPE:\r\n\r\n```\r\n[2019-02-22T19:10:24,144][WARN ][o.e.x.c.a.ShardFollowNodeTask] [follower1] shard follow task encounter non-retryable error\r\n  1> org.elasticsearch.transport.RemoteTransportException: [leaderd2][127.0.0.1:34037][indices:data/read/xpack/ccr/shard_changes]\r\n  1> Caused by: org.elasticsearch.transport.RemoteTransportException: [leaderd2][127.0.0.1:34037][indices:data/read/xpack/ccr/shard_changes[s]]\r\n  1> Caused by: java.lang.NullPointerException\r\n  1>    at org.elasticsearch.xpack.ccr.action.ShardChangesAction$TransportAction.globalCheckpointAdvancementFailure(ShardChangesAction.java:421) ~[main/:?]\r\n  1>    at org.elasticsearch.xpack.ccr.action.ShardChangesAction$TransportAction.lambda$asyncShardOperation$0(ShardChangesAction.java:386) ~[main/:?]\r\n  1>    at org.elasticsearch.index.shard.GlobalCheckpointListeners.notifyListener(GlobalCheckpointListeners.java:229) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT\r\n]\r\n  1>    at org.elasticsearch.index.shard.GlobalCheckpointListeners.lambda$add$2(GlobalCheckpointListeners.java:143) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n  1>    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSH\r\nOT]\r\n  1>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_202]\r\n  1>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_202]\r\n  1>    at java.lang.Thread.run(Thread.java:748) [?:1.8.0_202]\r\n  1>    Suppressed: org.elasticsearch.common.io.stream.NotSerializableExceptionWrapper: timeout_exception: 10ms\r\n  1>            at org.elasticsearch.index.shard.GlobalCheckpointListeners.lambda$add$3(GlobalCheckpointListeners.java:141) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SN\r\nAPSHOT]\r\n  1>            at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[?:1.8.0_202]\r\n  1>            at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[?:1.8.0_202]\r\n  1>            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180) ~[?:1.8.0_202]\r\n  1>            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293) ~[?:1.8.0_202]\r\n  1>            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_202]\r\n  1>            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_202]\r\n  1>            at java.lang.Thread.run(Thread.java:748) [?:1.8.0_202]\r\n```\r\n\r\nThis fix is simple. In `ShardChangesAction.TransportAction#globalCheckpointAdvancementFailure(...)` method we need to guard against the fact that the `IndexMetaData` instance for the leader index is missing.","performed_via_github_app":null}]