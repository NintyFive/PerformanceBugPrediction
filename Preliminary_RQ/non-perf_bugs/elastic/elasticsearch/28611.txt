{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28611","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28611/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28611/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28611/events","html_url":"https://github.com/elastic/elasticsearch/issues/28611","id":296028347,"node_id":"MDU6SXNzdWUyOTYwMjgzNDc=","number":28611,"title":"composite aggregation as child aggregation","user":{"login":"flefebure","id":16290736,"node_id":"MDQ6VXNlcjE2MjkwNzM2","avatar_url":"https://avatars2.githubusercontent.com/u/16290736?v=4","gravatar_id":"","url":"https://api.github.com/users/flefebure","html_url":"https://github.com/flefebure","followers_url":"https://api.github.com/users/flefebure/followers","following_url":"https://api.github.com/users/flefebure/following{/other_user}","gists_url":"https://api.github.com/users/flefebure/gists{/gist_id}","starred_url":"https://api.github.com/users/flefebure/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flefebure/subscriptions","organizations_url":"https://api.github.com/users/flefebure/orgs","repos_url":"https://api.github.com/users/flefebure/repos","events_url":"https://api.github.com/users/flefebure/events{/privacy}","received_events_url":"https://api.github.com/users/flefebure/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2018-02-09T22:12:05Z","updated_at":"2020-02-13T21:03:17Z","closed_at":"2019-01-25T13:00:40Z","author_association":"NONE","active_lock_reason":null,"body":"The 6.x new composite aggregation provides a way to scroll and page on terms bucket, and it's a good thing.\r\nHowever, it's not (for now?) possible to set a composite aggregation as a child of another bucket aggregation.\r\nSo it's impossible, for example, to composite-aggregate on a nested or a child entity. This request is not allowed :\r\n\r\n```\r\n{\r\n        \"metadatas\" : {\r\n            \"nested\" : {\r\n                \"path\" : \"metaDatas\"\r\n            },\r\n            \"aggs\" : {\r\n                \"msisdn\" : {\r\n                  \"filter\" : { \"term\": { \"metaDatas.name\": \"msisdn\" } },\r\n                  \"aggs\": {\r\n                    \"msisdns\": {\r\n                       \"composite\" : {\r\n                          \"size\":5,\r\n                          \"sources\" : [{ \"value\": { \"terms\" : { \"field\": \"metaDatas.value.raw\" } } }]\r\n                       }\r\n                    }\r\n                  }\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\nI don't understand this limitation. \r\nFurthermore, an ES 6.2 patched without the check seems to work as expected.\r\n ```\r\n@Override\r\n    protected AggregatorFactory<?> doBuild(SearchContext context, AggregatorFactory<?> parent,\r\n                                           AggregatorFactories.Builder subfactoriesBuilder) throws IOException {\r\n        /*if (parent != null) {\r\n            throw new IllegalArgumentException(\"[composite] aggregation cannot be used with a parent aggregation\");\r\n        }*/\r\n```\r\nany insight ?\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}