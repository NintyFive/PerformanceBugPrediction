{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20232","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20232/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20232/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20232/events","html_url":"https://github.com/elastic/elasticsearch/issues/20232","id":174034440,"node_id":"MDU6SXNzdWUxNzQwMzQ0NDA=","number":20232,"title":"Elasticsearch unstable after upgrade from 1.7.2 to 2.3.5 - multiple issues","user":{"login":"AGirin","id":5177657,"node_id":"MDQ6VXNlcjUxNzc2NTc=","avatar_url":"https://avatars2.githubusercontent.com/u/5177657?v=4","gravatar_id":"","url":"https://api.github.com/users/AGirin","html_url":"https://github.com/AGirin","followers_url":"https://api.github.com/users/AGirin/followers","following_url":"https://api.github.com/users/AGirin/following{/other_user}","gists_url":"https://api.github.com/users/AGirin/gists{/gist_id}","starred_url":"https://api.github.com/users/AGirin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AGirin/subscriptions","organizations_url":"https://api.github.com/users/AGirin/orgs","repos_url":"https://api.github.com/users/AGirin/repos","events_url":"https://api.github.com/users/AGirin/events{/privacy}","received_events_url":"https://api.github.com/users/AGirin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-08-30T14:28:48Z","updated_at":"2016-08-30T15:32:02Z","closed_at":"2016-08-30T14:48:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.5\n\n**Plugins installed**: [head, kopf, cloud_aws, marvel, license]\n\n**JVM version**: 1.8.0_51\n\n**OS version**: CentOS 6.6\n\n**Description of the problem including expected versus actual behavior**:\n\n**Steps to reproduce**:\n1. Cluster has 21 nodes. Previous version (1.7.2) worked with no issues for more than a year. \n\nWhat we see is huge spike in write IOPS per node (500 writes/s before 2500 writes/s now). Around noon we have a script that reads a lot of data from this cluster and our read IOPS go high as well. We are running on AWS and the volume has only 3,000 max. With all those IOPS we hit the limit of 3,000 and at this point Elastisearch goes down. \n\n![image](https://cloud.githubusercontent.com/assets/5177657/18093612/16ea9248-6e96-11e6-9fcc-9acda254116b.png)\n\nWhen we look at all ES nodes and get the status of Elasticsearch service we get this: `elasticsearch dead but subsys locked`. When we try to start ES backup we get this:\n\n```\n\nStarting elasticsearch: Java HotSpot(TM) 64-Bit Server VM warning: INFO: os::commit_memory(0x0000000429990000, 15408234496, 0) failed; error='Cannot allocate memory' (errno=12)\n\n There is insufficient memory for the Java Runtime Environment to continue.\n Native memory allocation (mmap) failed to map 15408234496 bytes for committing reserved memory.\n An error report file with more information is saved as:\n /tmp/hs_err_pid8710.log\n[FAILED]\n```\n\nSo apparently init script does not correctly report Elasticsearch status - ES is still running but it is in a bad state. So we have to kill ES manually with kill -9 (which is not fun at all on 21 servers) and only then we can start ES back online.\n\nSo with that multiple questions:\n1. Why does new ES has so much more write IOPS? How do we prevent this? \n\nOne possibility is that auto-throttling is in place? We used to have this setting in our previous cluster:\n\nindices.store.throttle.max_bytes_per_sec = \"100mb\"\n\nSo 2.3.5 apparently has auto-throttling enabled by default. Since it is impossible to delete our previous setting - does new ES just ignores it? Or how do we delete it? How can we disable auto-throttling if it causes the issue?\n1. What is wrong with init script? We use official rpm and it seems there is a bug with init script - it does not correctly detect hung process. How can we fix that? \n\nThanks a lot!\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}