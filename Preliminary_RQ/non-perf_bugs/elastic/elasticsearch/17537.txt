{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17537","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17537/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17537/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17537/events","html_url":"https://github.com/elastic/elasticsearch/issues/17537","id":145978723,"node_id":"MDU6SXNzdWUxNDU5Nzg3MjM=","number":17537,"title":"Invalid shift value (xx) in prefixCoded bytes (is encoded value really a geo point?)","user":{"login":"jaksmid","id":3618465,"node_id":"MDQ6VXNlcjM2MTg0NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/3618465?v=4","gravatar_id":"","url":"https://api.github.com/users/jaksmid","html_url":"https://github.com/jaksmid","followers_url":"https://api.github.com/users/jaksmid/followers","following_url":"https://api.github.com/users/jaksmid/following{/other_user}","gists_url":"https://api.github.com/users/jaksmid/gists{/gist_id}","starred_url":"https://api.github.com/users/jaksmid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaksmid/subscriptions","organizations_url":"https://api.github.com/users/jaksmid/orgs","repos_url":"https://api.github.com/users/jaksmid/repos","events_url":"https://api.github.com/users/jaksmid/events{/privacy}","received_events_url":"https://api.github.com/users/jaksmid/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":360757959,"node_id":"MDU6TGFiZWwzNjA3NTc5NTk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.3.3","name":"v2.3.3","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"assignees":[{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false}],"milestone":null,"comments":42,"created_at":"2016-04-05T12:52:21Z","updated_at":"2016-09-19T10:27:35Z","closed_at":"2016-09-19T10:27:35Z","author_association":"NONE","active_lock_reason":null,"body":"Hi guys,\n\nwe have upgraded ElasticSearch from 2.3.0 and reindexed our geolocations so the latitude and longitude are stored separately. We have noticed that some of our visualisation started to fail after we add a filter based on geolocation rectangle. However, map visualisation are working just fine. The problem occurs when we include actual documents. In this case, we get some failed shards (usually 1 out of 5) and error: Invalid shift value (xx) in prefixCoded bytes (is encoded value really a geo point?).\n\nDetails:\nOur geolocation index is based on:\n\n```\n\"dynamic_templates\": [{\n....\n{\n        \"ner_geo\": {\n          \"mapping\": {\n            \"type\": \"geo_point\",\n            \"lat_lon\": true\n          },\n          \"path_match\": \"*.coordinates\"\n        }\n      }],\n```\n\nThe ok query with the error is as follows. If we change the query size to 0 (map visualizations example), the query completes without problem.\n\n```\n{\n  \"size\": 100,\n  \"aggs\": {\n    \"2\": {\n      \"geohash_grid\": {\n        \"field\": \"authors.affiliation.coordinates\",\n        \"precision\": 2\n      }\n    }\n  },\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"query_string\": {\n          \"analyze_wildcard\": true,\n          \"query\": \"*\"\n        }\n      },\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"geo_bounding_box\": {\n                \"authors.affiliation.coordinates\": {\n                  \"top_left\": {\n                    \"lat\": 61.10078883158897,\n                    \"lon\": -170.15625\n                  },\n                  \"bottom_right\": {\n                    \"lat\": -64.92354174306496,\n                    \"lon\": 118.47656249999999\n                  }\n                }\n              }\n            }\n          ],\n          \"must_not\": []\n        }\n      }\n    }\n  },\n  \"highlight\": {\n    \"pre_tags\": [\n      \"@kibana-highlighted-field@\"\n    ],\n    \"post_tags\": [\n      \"@/kibana-highlighted-field@\"\n    ],\n    \"fields\": {\n      \"*\": {}\n    },\n    \"require_field_match\": false,\n    \"fragment_size\": 2147483647\n  }\n}\n```\n\nElasticsearch version**: 2.3.0\nOS version**: Elasticsearch docker image with head plugin, marvel and big desk installed\n\nThank you for your help,\nregards,\nJakub Smid\n","closed_by":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"performed_via_github_app":null}