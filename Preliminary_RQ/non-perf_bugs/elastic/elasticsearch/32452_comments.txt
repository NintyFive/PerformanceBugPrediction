[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408746109","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-408746109","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":408746109,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODc0NjEwOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T04:50:01Z","updated_at":"2018-07-30T04:50:01Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408769861","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-408769861","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":408769861,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODc2OTg2MQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T07:18:11Z","updated_at":"2018-08-06T10:43:44Z","author_association":"MEMBER","body":"`min_doc_count` is not implemented in the `composite` aggregation. This aggregation can be used to retrieve **all** buckets (with pagination) so if you need to filter some of them you'll need to do it on client side or use a pipeline aggregation:\r\n\r\n````\r\n{\r\n\"aggs\" : {\r\n    \"my_buckets\": {\r\n        \"composite\" : {\r\n            \"sources\" : [\r\n                { \"product\": { \"terms\" : { \"field\": \"product\" } } }\r\n            ]\r\n        },\r\n        \"aggs\": {\r\n          \"filter\": {\r\n            \"bucket_selector\": {\r\n              \"buckets_path\": {\r\n                \"doc_count\": \"_count\"\r\n              },\r\n              \"script\": \"doc_count > 2\"\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```` \r\nThe `bucket_selector` will keep buckets with a doc count greater than 2 and will preserve the `after_key` to handle pagination correctly. \r\n\r\nThough it should be possible to handle `min_doc_count` natively in the `composite` aggregation, this would be consistent with the other aggregations so I'll mark this issue as an enhancement and adoptme tags.\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410662350","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-410662350","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":410662350,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDY2MjM1MA==","user":{"login":"chester89","id":190332,"node_id":"MDQ6VXNlcjE5MDMzMg==","avatar_url":"https://avatars1.githubusercontent.com/u/190332?v=4","gravatar_id":"","url":"https://api.github.com/users/chester89","html_url":"https://github.com/chester89","followers_url":"https://api.github.com/users/chester89/followers","following_url":"https://api.github.com/users/chester89/following{/other_user}","gists_url":"https://api.github.com/users/chester89/gists{/gist_id}","starred_url":"https://api.github.com/users/chester89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chester89/subscriptions","organizations_url":"https://api.github.com/users/chester89/orgs","repos_url":"https://api.github.com/users/chester89/repos","events_url":"https://api.github.com/users/chester89/events{/privacy}","received_events_url":"https://api.github.com/users/chester89/received_events","type":"User","site_admin":false},"created_at":"2018-08-06T10:22:59Z","updated_at":"2018-08-06T10:34:15Z","author_association":"NONE","body":"@jimczi are you sure the query syntax is correct? It gives me ParserNotFound error. I'm on ES 6.1.1\r\n`{\r\n\t\"error\": {\r\n\t\t\"root_cause\": [{\r\n\t\t\t\"type\": \"parsing_exception\",\r\n\t\t\t\"reason\": \"[composite] failed to parse field [sources]\",\r\n\t\t\t\"line\": 18,\r\n\t\t\t\"col\": 67\r\n\t\t}],\r\n\t\t\"type\": \"parsing_exception\",\r\n\t\t\"reason\": \"[composite] failed to parse field [sources]\",\r\n\t\t\"line\": 18,\r\n\t\t\"col\": 67,\r\n\t\t\"caused_by\": {\r\n\t\t\t\"type\": \"illegal_argument_exception\",\r\n\t\t\t\"reason\": \"[terms] unknown field [min_doc_count], parser not found\"\r\n\t\t}\r\n\t},\r\n\t\"status\": 400\r\n}`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410667785","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-410667785","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":410667785,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDY2Nzc4NQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-06T10:45:40Z","updated_at":"2018-08-06T10:45:40Z","author_association":"MEMBER","body":"@chester89 thanks I updated the query, `min_doc_count` is not handled by the `composite` agg and indeed it should be removed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/411055419","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-411055419","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":411055419,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMTA1NTQxOQ==","user":{"login":"chester89","id":190332,"node_id":"MDQ6VXNlcjE5MDMzMg==","avatar_url":"https://avatars1.githubusercontent.com/u/190332?v=4","gravatar_id":"","url":"https://api.github.com/users/chester89","html_url":"https://github.com/chester89","followers_url":"https://api.github.com/users/chester89/followers","following_url":"https://api.github.com/users/chester89/following{/other_user}","gists_url":"https://api.github.com/users/chester89/gists{/gist_id}","starred_url":"https://api.github.com/users/chester89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chester89/subscriptions","organizations_url":"https://api.github.com/users/chester89/orgs","repos_url":"https://api.github.com/users/chester89/repos","events_url":"https://api.github.com/users/chester89/events{/privacy}","received_events_url":"https://api.github.com/users/chester89/received_events","type":"User","site_admin":false},"created_at":"2018-08-07T13:27:31Z","updated_at":"2018-08-07T13:27:31Z","author_association":"NONE","body":"@jimczi would it be easy to add support for `min_doc_count`? And is there any plans to mark this aggregation as production ready?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414635532","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-414635532","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":414635532,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDYzNTUzMg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-21T10:59:03Z","updated_at":"2018-08-21T10:59:03Z","author_association":"MEMBER","body":"I checked how we could implement `min_doc_count` for the `composite` aggregation and found out that this would require a big refactoring since we don't keep track of all buckets but only those that are in the top N. Adding this feature would defeat the purpose since we'd need to keep **all** buckets and make the selection (based on `min_doc_count`) at the end. Since this would use a lot of memory I don't think we should handle this feature natively in this aggregation and instead rely on client filtering or the `bucket_selector`. \r\n\r\n> And is there any plans to mark this aggregation as production ready?\r\n\r\nThe `composite` aggregation is marked as `beta` now (previously `experimental`). We'll remove the `beta` label soon but this label does not mean that we don't provide support if a bug is found and we plan to keep this functionality so there is no reason to not use it in production. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414638266","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-414638266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":414638266,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDYzODI2Ng==","user":{"login":"chester89","id":190332,"node_id":"MDQ6VXNlcjE5MDMzMg==","avatar_url":"https://avatars1.githubusercontent.com/u/190332?v=4","gravatar_id":"","url":"https://api.github.com/users/chester89","html_url":"https://github.com/chester89","followers_url":"https://api.github.com/users/chester89/followers","following_url":"https://api.github.com/users/chester89/following{/other_user}","gists_url":"https://api.github.com/users/chester89/gists{/gist_id}","starred_url":"https://api.github.com/users/chester89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chester89/subscriptions","organizations_url":"https://api.github.com/users/chester89/orgs","repos_url":"https://api.github.com/users/chester89/repos","events_url":"https://api.github.com/users/chester89/events{/privacy}","received_events_url":"https://api.github.com/users/chester89/received_events","type":"User","site_admin":false},"created_at":"2018-08-21T11:10:31Z","updated_at":"2018-08-21T11:10:31Z","author_association":"NONE","body":"@jimczi I see. can you tell me if there's any query in ES that would allow me to count unique field values with count condition on them (e.g. count unique users that visited site more than X times in particular period)? [here's my SO question](http://bit.ly/2wjbx3s)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414645200","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-414645200","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":414645200,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDY0NTIwMA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-21T11:41:49Z","updated_at":"2018-08-21T11:41:49Z","author_association":"MEMBER","body":"Nope I don't see a scalable way to do that in a single aggregation. One solution is to count unique users on client side using the `composite` aggregation. You can retrieve the buckets page by page and do the counting based on the doc count. You'll need multiple requests to paginate over the `composite` aggregation but the retrieval of each page is optimized (the `composite` aggregation doesn't need to visit all documents). If you have millions of unique user this might take some time to compute but it won't kill your cluster (each `composite` query is light weight)  and you could cache the final response for visualization. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414655099","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-414655099","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":414655099,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDY1NTA5OQ==","user":{"login":"chester89","id":190332,"node_id":"MDQ6VXNlcjE5MDMzMg==","avatar_url":"https://avatars1.githubusercontent.com/u/190332?v=4","gravatar_id":"","url":"https://api.github.com/users/chester89","html_url":"https://github.com/chester89","followers_url":"https://api.github.com/users/chester89/followers","following_url":"https://api.github.com/users/chester89/following{/other_user}","gists_url":"https://api.github.com/users/chester89/gists{/gist_id}","starred_url":"https://api.github.com/users/chester89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chester89/subscriptions","organizations_url":"https://api.github.com/users/chester89/orgs","repos_url":"https://api.github.com/users/chester89/repos","events_url":"https://api.github.com/users/chester89/events{/privacy}","received_events_url":"https://api.github.com/users/chester89/received_events","type":"User","site_admin":false},"created_at":"2018-08-21T12:22:58Z","updated_at":"2018-08-21T12:22:58Z","author_association":"NONE","body":"I see, thanks for the detailed answer","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533775661","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-533775661","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":533775661,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzc3NTY2MQ==","user":{"login":"mutecamel","id":1539321,"node_id":"MDQ6VXNlcjE1MzkzMjE=","avatar_url":"https://avatars3.githubusercontent.com/u/1539321?v=4","gravatar_id":"","url":"https://api.github.com/users/mutecamel","html_url":"https://github.com/mutecamel","followers_url":"https://api.github.com/users/mutecamel/followers","following_url":"https://api.github.com/users/mutecamel/following{/other_user}","gists_url":"https://api.github.com/users/mutecamel/gists{/gist_id}","starred_url":"https://api.github.com/users/mutecamel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mutecamel/subscriptions","organizations_url":"https://api.github.com/users/mutecamel/orgs","repos_url":"https://api.github.com/users/mutecamel/repos","events_url":"https://api.github.com/users/mutecamel/events{/privacy}","received_events_url":"https://api.github.com/users/mutecamel/received_events","type":"User","site_admin":false},"created_at":"2019-09-21T07:22:53Z","updated_at":"2019-09-21T07:22:53Z","author_association":"NONE","body":"> `min_doc_count` is not implemented in the `composite` aggregation. This aggregation can be used to retrieve **all** buckets (with pagination) so if you need to filter some of them you'll need to do it on client side or use a pipeline aggregation:\r\n> \r\n> ```\r\n> {\r\n> \"aggs\" : {\r\n>     \"my_buckets\": {\r\n>         \"composite\" : {\r\n>             \"sources\" : [\r\n>                 { \"product\": { \"terms\" : { \"field\": \"product\" } } }\r\n>             ]\r\n>         },\r\n>         \"aggs\": {\r\n>           \"filter\": {\r\n>             \"bucket_selector\": {\r\n>               \"buckets_path\": {\r\n>                 \"doc_count\": \"_count\"\r\n>               },\r\n>               \"script\": \"doc_count > 2\"\r\n>             }\r\n>          }\r\n>       }\r\n>    }\r\n> }\r\n> ```\r\n> \r\n> The `bucket_selector` will keep buckets with a doc count greater than 2 and will preserve the `after_key` to handle pagination correctly.\r\n> \r\n> Though it should be possible to handle `min_doc_count` natively in the `composite` aggregation, this would be consistent with the other aggregations so I'll mark this issue as an enhancement and adoptme tags.\r\n\r\nHere is a minor correction to the original solution:\r\n```\r\n{\r\n\"aggs\" : {\r\n    \"my_buckets\": {\r\n        \"composite\" : {\r\n            \"sources\" : [\r\n                { \"product\": { \"terms\" : { \"field\": \"product\" } } }\r\n            ]\r\n        },\r\n        \"aggs\": {\r\n          \"filter\": {\r\n            \"bucket_selector\": {\r\n              \"buckets_path\": {\r\n                \"doc_count\": \"_count\"\r\n              },\r\n              \"script\": \"params.doc_count > 2\"\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/608318911","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-608318911","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":608318911,"node_id":"MDEyOklzc3VlQ29tbWVudDYwODMxODkxMQ==","user":{"login":"charlie-wasp","id":3796082,"node_id":"MDQ6VXNlcjM3OTYwODI=","avatar_url":"https://avatars2.githubusercontent.com/u/3796082?v=4","gravatar_id":"","url":"https://api.github.com/users/charlie-wasp","html_url":"https://github.com/charlie-wasp","followers_url":"https://api.github.com/users/charlie-wasp/followers","following_url":"https://api.github.com/users/charlie-wasp/following{/other_user}","gists_url":"https://api.github.com/users/charlie-wasp/gists{/gist_id}","starred_url":"https://api.github.com/users/charlie-wasp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/charlie-wasp/subscriptions","organizations_url":"https://api.github.com/users/charlie-wasp/orgs","repos_url":"https://api.github.com/users/charlie-wasp/repos","events_url":"https://api.github.com/users/charlie-wasp/events{/privacy}","received_events_url":"https://api.github.com/users/charlie-wasp/received_events","type":"User","site_admin":false},"created_at":"2020-04-03T08:58:35Z","updated_at":"2020-04-03T08:58:35Z","author_association":"NONE","body":"It seems that offered solution doesn't work anymore? According to the [docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html#_pipeline_aggregations) for 7.6:\r\n\r\n> The composite agg is not currently compatible with pipeline aggregations, nor does it make sense in most cases","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/608539174","html_url":"https://github.com/elastic/elasticsearch/issues/32452#issuecomment-608539174","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32452","id":608539174,"node_id":"MDEyOklzc3VlQ29tbWVudDYwODUzOTE3NA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-04-03T16:32:36Z","updated_at":"2020-04-03T16:32:36Z","author_association":"MEMBER","body":"@charlie-wasp the documentation was updated due to discussions about composite + pipeline in general (https://github.com/elastic/elasticsearch/issues/32692#issuecomment-517810517).  \r\n\r\nSome pipelines work with composite, some do not work at all, and some _technically_ work but can give bad data (like a derivative that would span between composite pages).  While we decide what to do with composite and pipelines, we decided it would be prudent to just document that they are not supported so that users don't accidentally get themselves into a pickle.\r\n\r\nIn this particular scenario, the bucket_selector is one of the \"safe\" pipelines that does work as expected and I don't believe anything has changed in that regard.  But I would view pipelines + composite as \"experimental\" until we come to a decision about how/which should be supported.  I.e. might change in the future :)","performed_via_github_app":null}]