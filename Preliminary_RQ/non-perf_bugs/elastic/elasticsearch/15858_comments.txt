[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170331182","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170331182","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170331182,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDMzMTE4Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-10T10:02:34Z","updated_at":"2016-01-10T10:02:34Z","author_association":"CONTRIBUTOR","body":"Simpler recreation here:\n\n```\nPUT t\n{\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"syns\": {\n          \"tokenizer\": \"standard\",\n          \"filter\": [\n            \"lowercase\",\n            \"syns\"\n          ]\n        }\n      },\n      \"filter\": {\n        \"syns\": {\n          \"type\": \"synonym\",\n          \"synonyms\": [\n            \"arroz,rice\",\n            \"brown sugar,brownsugar\"\n          ]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"t\": {\n      \"properties\": {\n        \"full_name\": {\n          \"type\": \"string\",\n          \"analyzer\": \"syns\"\n        }\n      }\n    }\n  }\n}\n\nGET t/_validate/query?explain\n{\n  \"query\": {\n    \"match\": {\n      \"full_name\": {\n        \"query\": \"rice\",\n        \"minimum_should_match\": 2\n      }\n    }\n  }\n}\n\nGET t/_validate/query?explain\n{\n  \"query\": {\n    \"match\": {\n      \"full_name\": {\n        \"query\": \"brown sugar\",\n        \"minimum_should_match\": 2\n      }\n    }\n  }\n}\n```\n\nNot sure what can be done for the second multi-word synonym example (as multi-word synonyms are really problematic) but it does feel like the first example should not apply the min-should-match to stacked tokens.\n\n@mikemccand @jpountz what do you think=\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170469231","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170469231","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170469231,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDQ2OTIzMQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T08:50:05Z","updated_at":"2016-01-11T08:50:05Z","author_association":"CONTRIBUTOR","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170503174","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170503174","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170503174,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDUwMzE3NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T10:37:40Z","updated_at":"2016-01-11T10:37:40Z","author_association":"MEMBER","body":"@clintongormley I changed the behavior of minimum should match to fix this issue: https://github.com/elastic/elasticsearch/issues/15521. In 2.2 and master we always honor the value even if the final number of optional clauses (after expansion) is smaller. This is why your first example returns no result. For the multi word synonym example the problem is similar but the resolution would be different simply because the generated query is wrong:\n\n```\n\"explanation\": \"((full_name:brown full_name:brownsugar) full_name:sugar)\"\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170614804","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170614804","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170614804,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDYxNDgwNA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T16:49:41Z","updated_at":"2016-01-11T16:49:41Z","author_association":"CONTRIBUTOR","body":"@jimferenczi Maybe I'm the one confused but I think the issue is different here: we want the number of SHOULD clauses to be equal to the number of unique positions instead of the number of tokens?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170619794","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170619794","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170619794,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDYxOTc5NA==","user":{"login":"jzbahrai","id":8869623,"node_id":"MDQ6VXNlcjg4Njk2MjM=","avatar_url":"https://avatars2.githubusercontent.com/u/8869623?v=4","gravatar_id":"","url":"https://api.github.com/users/jzbahrai","html_url":"https://github.com/jzbahrai","followers_url":"https://api.github.com/users/jzbahrai/followers","following_url":"https://api.github.com/users/jzbahrai/following{/other_user}","gists_url":"https://api.github.com/users/jzbahrai/gists{/gist_id}","starred_url":"https://api.github.com/users/jzbahrai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jzbahrai/subscriptions","organizations_url":"https://api.github.com/users/jzbahrai/orgs","repos_url":"https://api.github.com/users/jzbahrai/repos","events_url":"https://api.github.com/users/jzbahrai/events{/privacy}","received_events_url":"https://api.github.com/users/jzbahrai/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T17:06:08Z","updated_at":"2016-01-11T17:06:08Z","author_association":"NONE","body":"I am also a little unsure as to what @jimferenczi is saying. I want the minimum_should_match for rice,arroz to be equal to 1 as it should be based on the number of positions (in this case 1), but it is 2. It is correct for the multiword brown sugar, brownsugar as it is 2 and the number of positions in that case is 2.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170638474","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170638474","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170638474,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDYzODQ3NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T18:13:59Z","updated_at":"2016-01-11T18:13:59Z","author_association":"MEMBER","body":"@jzbahrai @jpountz I just answered regarding @clintongormley's recreation where the minimum should match is statically set to 2. I agree that there is a bug with the example used by @jzbahrai where minimum should match is set with \"3<90%\". I'll take a look.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170647673","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170647673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170647673,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDY0NzY3Mw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T18:39:21Z","updated_at":"2016-01-11T18:39:21Z","author_association":"MEMBER","body":"The bug is when there is only one position but multiple clauses in this position. it is related to a small optimization that is done to reduce the number of clauses when there is only one position. In such case we build only one level of boolean query and the optional clauses are all at the root level, this level is then used to compute the number of optional clauses in the query. For instance the query \"rice\" is expanded into:\n(rice arrow) => 2 optional clauses at the root level.\nbut to correctly compute the number of positions we should generate another level to indicate that the query contains only one position:\n((rice arrow)) => 1 optional clause at the root level and 2 optional clauses at the inner level.\nI'll work on a fix tomorrow.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170845076","html_url":"https://github.com/elastic/elasticsearch/issues/15858#issuecomment-170845076","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15858","id":170845076,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDg0NTA3Ng==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-12T09:05:22Z","updated_at":"2016-01-12T09:05:22Z","author_association":"MEMBER","body":"The bug/problem is at the Lucene level. I opened https://issues.apache.org/jira/browse/LUCENE-6972, @jpountz can you take a look ?\n","performed_via_github_app":null}]