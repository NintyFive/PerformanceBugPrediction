{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50636","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50636/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50636/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50636/events","html_url":"https://github.com/elastic/elasticsearch/issues/50636","id":545544520,"node_id":"MDU6SXNzdWU1NDU1NDQ1MjA=","number":50636,"title":"Many warn logs from SearchSlowLog escapeJson ","user":{"login":"cfangpp","id":16027694,"node_id":"MDQ6VXNlcjE2MDI3Njk0","avatar_url":"https://avatars1.githubusercontent.com/u/16027694?v=4","gravatar_id":"","url":"https://api.github.com/users/cfangpp","html_url":"https://github.com/cfangpp","followers_url":"https://api.github.com/users/cfangpp/followers","following_url":"https://api.github.com/users/cfangpp/following{/other_user}","gists_url":"https://api.github.com/users/cfangpp/gists{/gist_id}","starred_url":"https://api.github.com/users/cfangpp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cfangpp/subscriptions","organizations_url":"https://api.github.com/users/cfangpp/orgs","repos_url":"https://api.github.com/users/cfangpp/repos","events_url":"https://api.github.com/users/cfangpp/events{/privacy}","received_events_url":"https://api.github.com/users/cfangpp/received_events","type":"User","site_admin":false},"labels":[{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-01-06T05:17:40Z","updated_at":"2020-01-06T09:05:42Z","closed_at":"2020-01-06T09:05:42Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the feature**:\r\n\r\n**Elasticsearch version**: 7.4.1\r\n**JVM version** (`java -version`):1.8.0_66\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThere is a warn exception when a lot of search requests the cluster, it's looks like a concurrent problem\r\n\r\nthe error stack trace like below:\r\n`[hitch_passenger_order_2019_12_25_13_51_45][0] onQueryPhase listener [org.elasticsearch.index.SearchSlowLog@20220cb5] failed\r\njava.lang.RuntimeException: Internal error: total len assumed to be 2, copied 0 bytes\r\n\tat com.fasterxml.jackson.core.util.ByteArrayBuilder.toByteArray(ByteArrayBuilder.java:134) ~[jackson-core-2.8.11.jar:2.8.11]\r\n\tat com.fasterxml.jackson.core.util.ByteArrayBuilder.completeAndCoalesce(ByteArrayBuilder.java:179) ~[jackson-core-2.8.11.jar:2.8.11]\r\n\tat com.fasterxml.jackson.core.io.JsonStringEncoder.quoteAsUTF8(JsonStringEncoder.java:283) ~[jackson-core-2.8.11.jar:2.8.11]\r\n\tat org.elasticsearch.common.logging.ESLogMessage.escapeJson(ESLogMessage.java:49) ~[elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.index.SearchSlowLog$SearchSlowLogMessage.prepareMap(SearchSlowLog.java:173) ~[elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.index.SearchSlowLog$SearchSlowLogMessage.<init>(SearchSlowLog.java:159) ~[elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.index.SearchSlowLog.onQueryPhase(SearchSlowLog.java:139) ~[elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.index.shard.SearchOperationListener$CompositeListener.onQueryPhase(SearchOperationListener.java:155) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.search.SearchService$SearchOperationListenerExecutor.close(SearchService.java:1130) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:362) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.search.SearchService.lambda$executeQueryPhase$1(SearchService.java:340) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.action.ActionListener.lambda$map$2(ActionListener.java:145) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.search.SearchService.lambda$rewriteShardRequest$7(SearchService.java:1043) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.action.ActionRunnable$1.doRun(ActionRunnable.java:45) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:773) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.4.0.jar:7.4.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:830) [?:?]`\r\n \r\n\r\nIt's a singleton static instance JsonStringEncoder on org.elasticsearch.common.logging.ESLogMessage.  And invoked the method quoteAsUTF8 on code line 49.  Then used a global ByteArrayBuilder to put byte arrays of text. finally occur error on ByteArrayBuilder.toByteArray. the ByteArrayBuilder is from jackson-core-2.8.11.jar\r\n\r\nIt does't thread safe  above. maybe another thread changed ByteArrayBuilder so that happened above error .","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}