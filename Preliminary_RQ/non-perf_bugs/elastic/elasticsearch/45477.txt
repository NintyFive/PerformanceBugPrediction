{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45477","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45477/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45477/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45477/events","html_url":"https://github.com/elastic/elasticsearch/issues/45477","id":479964449,"node_id":"MDU6SXNzdWU0Nzk5NjQ0NDk=","number":45477,"title":"[CI] Docs tests failed to cleanup ILM policy","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"assignees":[{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-08-13T05:24:04Z","updated_at":"2019-08-15T01:45:13Z","closed_at":"2019-08-15T01:45:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**CI**: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob+fast+part2/715\r\n\r\n```\r\norg.elasticsearch.smoketest.DocsClientYamlTestSuiteIT > test {yaml=reference/mapping/types/binary/line_12} FAILED\r\n    org.elasticsearch.client.ResponseException: method [DELETE], host [http://[::1]:36875], URI [/_ilm/policy/slm-history-ilm-policy], status line [HTTP/1.1 400 Bad Request]\r\n    {\"error\":{\"root_cause\":[{\"type\":\"illegal_argument_exception\",\"reason\":\"Cannot delete policy [slm-history-ilm-policy]. It is in use by one or more indices: [.g/slm-history-1-2019.08]\"}],\"type\":\"illegal_argument_exception\",\"reason\":\"Cannot delete policy [slm-history-ilm-policy]. It is in use by one or more indices: [.slm-history-1-2019.08]\"},\"status\":400}\r\n```\r\n\r\nI had a quick look and I can't see an obvious cause - `wipeCluster` should remove all the indices before removing policies.\r\nHowever, the node logs show that a SLM policy kicked in at the same time as the test, so I suspect that is related (the node TZ is an hour ahead of the rest-client logs)\r\n```\r\n[2019-08-13T01:29:59,716][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] removing template [.slm-history]\r\n[2019-08-13T01:29:59,744][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] adding template [.slm-history] for index patterns [.slm-history-1*]\r\n[2019-08-13T01:29:59,789][INFO ][o.e.x.i.a.TransportPutLifecycleAction] [node-0] adding index lifecycle policy [watch-history-ilm-policy]\r\n[2019-08-13T01:29:59,839][INFO ][o.e.x.i.a.TransportPutLifecycleAction] [node-0] adding index lifecycle policy [slm-history-ilm-policy]\r\n[2019-08-13T01:29:59,917][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [my_index] creating index, cause [api], templates [], shards [1]/[1], mappings [_doc]\r\n[2019-08-13T01:30:00,003][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy [daily-snapshots] issuing create snapshot [daily-snap-2019.08.13-7jbmpvp_soeh4ulzqusyqw]\r\n[2019-08-13T01:30:00,005][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy job [daily-snapshots-1] issued new snapshot creation for [daily-snap-2019.08.13-7jbmpvp_soeh4ulzqusyqw] successfully\r\n[2019-08-13T01:30:00,006][ERROR][o.e.x.s.SnapshotLifecycleTask] [node-0] failed to issue create snapshot request for snapshot lifecycle policy [daily-snapshots]: RepositoryMissingException[[my_repository] missing]\r\n[2019-08-13T01:30:00,006][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy [nightly-snapshots] issuing create snapshot [nightly-snap-2019.08.13-tqfkyopbs9kujniyb5c4ja]\r\n[2019-08-13T01:30:00,007][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy job [nightly-snapshots-1] issued new snapshot creation for [nightly-snap-2019.08.13-tqfkyopbs9kujniyb5c4ja] successfully\r\n[2019-08-13T01:30:00,007][ERROR][o.e.x.s.SnapshotLifecycleTask] [node-0] failed to issue create snapshot request for snapshot lifecycle policy [nightly-snapshots]: RepositoryMissingException[[my_repository] missing]\r\n[2019-08-13T01:30:00,015][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.slm-history-1-2019.08] creating index, cause [auto(bulk api)], templates [.slm-history], shards [1]/[0], mappings [_doc]\r\n[2019-08-13T01:30:00,044][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [my_index/XC3O8k5JRrmbp8KyECwJ1Q] deleting index\r\n[2019-08-13T01:30:00,098][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] removing template [.logstash-management]\r\n[2019-08-13T01:30:00,121][INFO ][o.e.c.m.TemplateUpgradeService] [node-0] Starting template upgrade to version 8.0.0, 1 templates will be updated and 0 will be removed\r\n[2019-08-13T01:30:00,123][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.slm-history-1-2019.08][0]]]).\r\n[2019-08-13T01:30:00,149][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] adding template [.logstash-management] for index patterns [.logstash]\r\n[2019-08-13T01:30:00,171][INFO ][o.e.c.m.TemplateUpgradeService] [node-0] Templates were upgraded successfully to version 8.0.0\r\n[2019-08-13T01:30:00,173][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] removing template [.slm-history]\r\n```","closed_by":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"performed_via_github_app":null}