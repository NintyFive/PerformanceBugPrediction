{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16536","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16536/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16536/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16536/events","html_url":"https://github.com/elastic/elasticsearch/issues/16536","id":132430181,"node_id":"MDU6SXNzdWUxMzI0MzAxODE=","number":16536,"title":"Groovy: Reflection causes exceptions after several runs","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":303029443,"node_id":"MDU6TGFiZWwzMDMwMjk0NDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.2.1","name":"v2.2.1","color":"dddddd","default":false,"description":null},{"id":302749677,"node_id":"MDU6TGFiZWwzMDI3NDk2Nzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.3.0","name":"v2.3.0","color":"dddddd","default":false,"description":null},{"id":246685314,"node_id":"MDU6TGFiZWwyNDY2ODUzMTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha1","name":"v5.0.0-alpha1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"assignees":[{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-02-09T14:16:49Z","updated_at":"2016-02-20T00:29:03Z","closed_at":"2016-02-09T16:39:57Z","author_association":"MEMBER","active_lock_reason":null,"body":"A user in the [watcher forum](https://discuss.elastic.co/t/failed-to-execute-watch-transform-noclassdeffounderror/41257/5) hit a `ClassNotFoundError`, after a watch ran successful several times.\n\nTurns out this is a groovy issue and can be reproduced using this test:\n\n``` java\npackage org.elasticsearch.script.groovy;\n\nimport org.elasticsearch.common.settings.Settings;\nimport org.elasticsearch.script.CompiledScript;\nimport org.elasticsearch.script.ExecutableScript;\nimport org.elasticsearch.script.ScriptService;\nimport org.elasticsearch.test.ESTestCase;\n\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\n\npublic class GroovyCompilationTests extends ESTestCase {\n\n    private GroovyScriptEngineService se;\n\n    @Override\n    public void setUp() throws Exception {\n        super.setUp();\n        se = new GroovyScriptEngineService(Settings.EMPTY);\n        // otherwise will exit your VM and other bad stuff\n        assumeTrue(\"test requires security manager to be enabled\", System.getSecurityManager() != null);\n    }\n\n    @Override\n    public void tearDown() throws Exception {\n        se.close();\n        super.tearDown();\n    }\n\n    public void testThatPotentialBugWithSeveralExecutions() throws Exception {\n        String script = \"return hits.collect({\\\"${it.message}\\\"})\";\n\n        Map<String, Object> data = new HashMap<>();\n        data.put(\"message\", \"The big lebowski\");\n\n        List<Object> hitsArray = new ArrayList<>();\n        hitsArray.add(data);\n\n        Map<String, Object> hits = new HashMap<>();\n        hits.put(\"hits\", hitsArray);\n\n        Object compiledObject = se.compile(script, Collections.emptyMap());\n        CompiledScript compiledScript = new CompiledScript(ScriptService.ScriptType.INLINE, \"test\", \"groovy\", compiledObject);\n        ExecutableScript executable = se.executable(compiledScript, hits);\n\n        // 100 runs will fail, 10 runs work..\n        for (int i = 0; i < 100; i++) {\n            executable.run();\n        }\n    }\n\n}\n```\n\n@ywelsch already found out, that one can trigger this immediately by setting the `-Dsun.reflect.noInflation=true` property.\n\nFor more info about that, check out https://blogs.oracle.com/buck/entry/inflation_system_properties\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}