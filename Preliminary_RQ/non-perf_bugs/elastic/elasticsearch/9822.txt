{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9822","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9822/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9822/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9822/events","html_url":"https://github.com/elastic/elasticsearch/issues/9822","id":58592531,"node_id":"MDU6SXNzdWU1ODU5MjUzMQ==","number":9822,"title":"NoSuchFileException _1gl.si in OldIndexBackwardsCompatibilityTests","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-02-23T14:30:59Z","updated_at":"2015-12-05T17:24:25Z","closed_at":"2015-12-05T17:24:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"OldIndexBackCompatTests fails (rarely, won't repro for me after beasting) sometimes (http://build-us-00.elasticsearch.org/job/es_core_1x_centos/3304/console) with this nasty exception:\n\n```\njava.nio.file.NoSuchFileException: _1gl.si in dir=least_used[rate_limited(default(mmapfs(/mnt/jenkins/workspace/es_core_1x_centos/target/J0/data/TEST-ip-10-255-15-175-CHILD_VM=[0]-CLUSTER_SEED=[3276434121362593305]-HASH=[87FD12A7499C81]/nodes/1/indices/test/0/index),niofs(/mnt/jenkins/workspace/es_core_1x_centos/target/J0/data/TEST-ip-10-255-15-175-CHILD_VM=[0]-CLUSTER_SEED=[3276434121362593305]-HASH=[87FD12A7499C81]/nodes/1/indices/test/0/index)), type=MERGE, rate=20.0)]\n    at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:603)\n    at org.apache.lucene.store.FilterDirectory.openInput(FilterDirectory.java:80)\n    at org.elasticsearch.index.store.Store$StoreDirectory.openInput(Store.java:688)\n    at org.apache.lucene.codecs.lucene3x.Lucene3xSegmentInfoReader.read(Lucene3xSegmentInfoReader.java:106)\n    at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:358)\n    at org.apache.lucene.index.SegmentInfos$1.doBody(SegmentInfos.java:454)\n    at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:906)\n    at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:752)\n    at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:450)\n    at org.elasticsearch.common.lucene.Lucene.readSegmentInfos(Lucene.java:92)\n    at org.elasticsearch.index.store.Store.readSegmentsInfo(Store.java:158)\n    at org.elasticsearch.index.store.Store.readLastCommittedSegmentsInfo(Store.java:148)\n    at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:648)\n    at org.elasticsearch.index.engine.InternalEngine.snapshotIndex(InternalEngine.java:774)\n    at org.elasticsearch.test.store.MockFSDirectoryService$1.beforeIndexShardClosed(MockFSDirectoryService.java:93)\n    at org.elasticsearch.indices.InternalIndicesLifecycle.beforeIndexShardClosed(InternalIndicesLifecycle.java:193)\n    at org.elasticsearch.index.IndexService.closeShardInjector(IndexService.java:391)\n    at org.elasticsearch.index.IndexService.removeShard(IndexService.java:382)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyDeletedShards(IndicesClusterStateService.java:294)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:187)\n    at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:466)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:182)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:152)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\nIt's always with the 0.20.6 index (= Lucene 3.6.2).  The exc is bad: it means Lucene corrupted the 3.x index on first commit with Lucene 4.x, because it failed to write an upgraded .si file yet did reference it.\n\nDigging with @s1monw we uncovered one abuse case where Lucene could do this https://issues.apache.org/jira/browse/LUCENE-6279 (which is a \"won't fix\") where if a directory is \"dirty\" (has unrelated index files from a previous index), Lucene will fail to upgrade the .si files and the index will be corrupt.\n\nSo ... is ES re-using directories here?  The test make new nodes, sharing the local data dir, to replicate to, and then later closes them before testing the next index.  Each node that starts up will try to find a free (not locked) sub-dir of the data dir, and then that may have leftover files from the last time that index was replicated to that node?\n\nIf this is happening ... I think we need to somehow fix ES to never share dirty index directories?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}