{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8896","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8896/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8896/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8896/events","html_url":"https://github.com/elastic/elasticsearch/issues/8896","id":51676285,"node_id":"MDU6SXNzdWU1MTY3NjI4NQ==","number":8896,"title":"Path hierarchy aggregation","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2014-12-11T11:35:51Z","updated_at":"2017-03-24T12:55:56Z","closed_at":"2015-11-23T10:43:09Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"A few users have used nested terms aggregations to try to visualise each level in a tree, such as a file system, eg:\n\n```\n{\n  \"aggs\": {\n    \"first_level\": {\n      \"terms\": {\n        \"field\": \"first_level\"\n      },\n      \"aggs\": {\n        \"second_level\": {\n          \"terms\": {\n            \"field\": \"second_level\"\n          },\n          \"aggs\": {\n            \"third_level\": {\n              \"terms\": {\n                \"field\": \"third_level\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThis is very costly as it results in combinatorial explosion.  However, because this is a tree, it would be more efficient to store first_level+second_level+third_level in a single field, and to do a single pass over these \"leaf buckets\". Once we have the most popular leaves, we can backfill the branches (ie first_level+second_level  and first_level).\n\nThe results would obviously be different to the nested terms agg: instead of having the most popular first_levels, then the most popular second_levels in the most popular first_levels (etc), you'd have the most popular leaves, plus the first_level and second level that those leaves belong to.\n\nA complete example could look like this:\n\n```\nPUT /filesystem\n{\n  \"mappings\": {\n    \"file\": {\n      \"properties\": {\n        \"path\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\",\n          \"doc_values\": true\n        }\n      }\n    }\n  }\n}\n\nPUT /filesystem/file/1\n{\n  \"path\": \"/My documents/Spreadsheets/Budget_2013.xls\",\n  \"views\": 10\n}\n\nPUT /filesystem/file/2\n{\n  \"path\": \"/My documents/Spreadsheets/Budget_2014.xls\",\n  \"views\": 6\n}\n\nPUT /filesystem/file/3\n{\n  \"path\": \"/My documents/Test.txt\",\n  \"views\": 1\n}\n\nGET /filesystem/file/_search?search_type=count\n{\n  \"aggs\": {\n    \"tree\": {\n      \"path_hierarchy\": {\n        \"field\": \"path\",\n        \"separator\": \"/\",\n        \"order\": \"total_views\"\n      },\n      \"aggs\": {\n        \"total_views\": {\n          \"sum\": {\n            \"field\": \"views\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nAnd the result like this:\n\n```\n{\n  \"aggregations\": {\n    \"tree\": {\n      \"buckets\": [\n        {\n          \"key\": \"My documents\",\n          \"doc_count\": 3,\n          \"total_views\": {\n            \"value\": 18\n          },\n          \"tree\": {\n            \"buckets\": [\n              {\n                \"key\": \"Spreadsheets\",\n                \"doc_count\": 2,\n                \"total_views\": {\n                  \"value\": 17\n                },\n                \"tree\": {\n                  \"buckets\": [\n                    {\n                      \"key\": \"Budget_2013.xls\",\n                      \"doc_count\": 1,\n                      \"total_views\": {\n                        \"value\": 10\n                      }\n                    },\n                    {\n                      \"key\": \"Budget_2014.xls\",\n                      \"doc_count\": 1,\n                      \"total_views\": {\n                        \"value\": 7\n                      }\n                    }\n                  ]\n                }\n              },\n              {\n                \"key\": \"Test.txt\",\n                \"doc_count\": 1,\n                \"total_views\": {\n                  \"value\": 1\n                }\n              }\n            ]\n          }\n        }\n      ]\n    }\n  }\n}\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}