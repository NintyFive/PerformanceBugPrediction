{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24719","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24719/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24719/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24719/events","html_url":"https://github.com/elastic/elasticsearch/issues/24719","id":229077494,"node_id":"MDU6SXNzdWUyMjkwNzc0OTQ=","number":24719,"title":"Elasticsearch 5.2.2, Memory keeps on increasing steadily untill ES gets killed by System OOM Killer","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2017-05-16T15:36:37Z","updated_at":"2018-01-11T03:25:55Z","closed_at":"2017-05-31T10:45:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: ES Version 5.2.2\r\n\r\n**Plugins installed**: [ only defaults ]\r\n\r\n**JVM version** (`java -version`): Oracle JDK 1.8.0_112-b15\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): centos 6.8 ( 2.6.32-642.6.2.el6 )\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nOur Environment is: 3 node ES Cluster with 3 data nodes. We have upgraded ES from 2.3.3 to 5.2.2.\r\n\r\nThe data nodes are allocated 31gb heap ( as recommended by ES Community ). Node1 mostly serves the search requests while Node 2/ Node 3 are used for Bulk insertions.\r\n\r\nWe have seen a constant surge in the Memory usage of ES Node 1 ( node mostly used for search queries ), it starts up with 32g res memory and then res memory goes to 40g...45g...50g.. 56g...60g...62g and KILLED! ( by kernel's OOM killer ). This happens over the duration of 24-30hrs. The only thing we can do at this point is restart ES and same repeats over.\r\n\r\nI have already gone through https://discuss.elastic.co/t/out-of-memory-invoked-oom-killer/807951 but this doesn't apply here as we are running on a Physical server with centos 6.8 ( 2.6.32-642.6.2.el6 ) with 64GB RAM and 24 core processors.\r\n\r\nFrom this article, https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html , we can make out that ( guess ) that the memory above 32g+ is related to Lucene caching. Can someone please throw more light on what's happening here?\r\n\r\nI have gone through github issues which already says some memory leak issue was already fixed before es5.2.2.\r\n\r\nIt'd be great if someone can help understand this behavior and possible solution to this.\r\n\r\nPS: This was not happening with ES 2.3.3 on contrary.\r\n\r\nSome more details:\r\n\r\nNo FULL GCs at all, following is the output of jstat just before ES got killed by system OOM killer\r\n\r\n```\r\nTimestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   \r\n       367764.3   0.00 100.00  19.66  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367769.3   0.00 100.00  24.77  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367774.3   0.00 100.00  30.94  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367779.3   0.00 100.00  34.65  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367784.3   0.00 100.00  40.53  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367789.3   0.00 100.00  43.95  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367794.3   0.00 100.00  48.67  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367799.3   0.00 100.00  57.06  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367804.3   0.00 100.00  64.82  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367809.3   0.00 100.00  70.31  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\nTimestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   \r\n       367814.3   0.00 100.00  76.48  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367819.3   0.00 100.00  78.75  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367824.3   0.00 100.00  85.45  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367829.3   0.00 100.00  89.59  77.69  92.53  84.63   3967  227.608     0    0.000  227.608\r\n       367834.3   0.00 100.00   1.36  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367839.3   0.00 100.00   9.36  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367844.3   0.00 100.00  11.64  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367849.3   0.00 100.00  18.63  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367854.3   0.00 100.00  23.14  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367859.3   0.00 100.00  29.02  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\nTimestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   \r\n       367864.3   0.00 100.00  33.43  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367869.3   0.00 100.00  39.25  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367874.3   0.00 100.00  45.80  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367879.3   0.00 100.00  50.99  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367884.3   0.00 100.00  57.25  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367889.3   0.00 100.00  63.12  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367894.3   0.00 100.00  68.36  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367899.3   0.00 100.00  76.95  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367902.6   0.00 100.00  82.29  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367902.6   0.00 100.00  82.29  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\nTimestamp         S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   \r\n       367902.6   0.00 100.00  82.29  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n       367902.6   0.00 100.00  82.29  77.44  92.53  84.63   3968  227.667     0    0.000  227.667\r\n```\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}