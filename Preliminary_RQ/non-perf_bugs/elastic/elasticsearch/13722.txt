{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13722","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13722/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13722/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13722/events","html_url":"https://github.com/elastic/elasticsearch/issues/13722","id":107770952,"node_id":"MDU6SXNzdWUxMDc3NzA5NTI=","number":13722,"title":"Top level inner hits not using filter","user":{"login":"nemonster","id":1417839,"node_id":"MDQ6VXNlcjE0MTc4Mzk=","avatar_url":"https://avatars3.githubusercontent.com/u/1417839?v=4","gravatar_id":"","url":"https://api.github.com/users/nemonster","html_url":"https://github.com/nemonster","followers_url":"https://api.github.com/users/nemonster/followers","following_url":"https://api.github.com/users/nemonster/following{/other_user}","gists_url":"https://api.github.com/users/nemonster/gists{/gist_id}","starred_url":"https://api.github.com/users/nemonster/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nemonster/subscriptions","organizations_url":"https://api.github.com/users/nemonster/orgs","repos_url":"https://api.github.com/users/nemonster/repos","events_url":"https://api.github.com/users/nemonster/events{/privacy}","received_events_url":"https://api.github.com/users/nemonster/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-09-22T18:21:07Z","updated_at":"2015-09-23T11:57:34Z","closed_at":"2015-09-23T11:57:34Z","author_association":"NONE","active_lock_reason":null,"body":"When specifying a query for top level inner hits, using a filter does not appear to have any effect on the returned results.  \n\nScript to set up index\n\n```\n#!/bin/sh\n\nnode=\"http://localhost:9200\"\ncurl  -XDELETE $node/test1\n\ncurl  -XPUT $node/test1\n\n# create mapping for test1\ncurl  -XPOST $node/test1/_mapping/Parent -d '\n{\n Parent: {\n  _routing: { required : true },\n  properties: {\n   display : { \"type\": \"string\" }\n  }\n }\n}'\n\ncurl  -XPOST $node/test1/_mapping/Child -d '\n{\n Child : {\n   _parent : { type : \"Parent\" },\n   _routing : { required : true },\n   properties: {\n    display : { \"type\": \"string\" },\n    date: {\n      \"type\": \"date\",\n      \"format\": \"dateOptionalTime || M/d/Y k:m:s a || Y-M-d'\"'\"'TH:m:s.S || YYYYMMddHHms\"\n    }\n  }\n }\n}'\n\n# Create a parent object\ncurl  -XPUT \"$node/test1/Parent/1?routing=1\" -d'\n{\n    \"display\" : \"Parent 1\"\n}'\n\n# Create 10 child objects, with dates from 1930 to 1939\nfor i in 0 1 2 3 4 5 6 7 8 9 ; do\ncurl  -XPUT \"$node/test1/Child/1$i?parent=1&routing=1\" -d'\n{\n    \"display\" : \"Child 1'$i'\",\n    \"date\" : \"193'$i'-01-01\"\n}'\ndone\n\n```\n\nUsing a query gives the expected result:\n\n```\nGET /test1/Parent/_search\n{\n \"query\":{\n   \"has_child\":{\n     \"type\":\"Child\",\n     \"query\":{ \n       \"filtered\": {\n         \"query\": {\"match_all\":{} },\n         \"filter\": {\n           \"range\": {\n             \"date\": {\n               \"gte\": \"1932-01-01\"\n             }\n           } \n         }\n       }\n     }\n   }\n }, \n \"inner_hits\" : {\n  \"children\" : {\n   \"type\" : { \n    \"Child\" : { \n     \"query\" : {       \n       \"match\":{\"display\": \"Child 14\"}\n     }, \n     \"size\":10\n    }\n   }\n  }\n }\n}\n```\n\nHowever adding a filter to the query returns all the inner hits, not just those that are greater than the date specified in the range.\n\n```\nGET /test1/Parent/_search\n{\n \"query\":{\n   \"has_child\":{\n     \"type\":\"Child\",\n     \"query\":{ \n       \"filtered\": {\n         \"query\": {\"match_all\":{} },\n         \"filter\": {\n           \"range\": {\n             \"date\": {\n               \"gte\": \"1932-01-01\"\n             }\n           } \n         }\n       }\n     }\n   }\n }, \n \"inner_hits\" : {\n  \"children\" : {\n   \"type\" : { \n    \"Child\" : { \n     \"query\" : {       \n      \"filtered\": {\n       \"query\": {\"match_all\":{} },\n       \"filter\": {\n        \"range\": {\n         \"date\": {\n          \"gte\": \"1938-01-01\"\n         }\n        } \n       }\n      }\n     },\n     \"size\":10\n    }\n   }\n  }\n }\n}\n```\n\nIt's hard to tell from the current documentation if this is the expected behavior or not.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}