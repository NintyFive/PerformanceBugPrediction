[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/76911445","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-76911445","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":76911445,"node_id":"MDEyOklzc3VlQ29tbWVudDc2OTExNDQ1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-03-03T09:17:46Z","updated_at":"2015-03-03T09:17:46Z","author_association":"CONTRIBUTOR","body":"Hi @coxchen \n\nThe `_ttl` is added to the `_timestamp`, so you need to update both otherwise it uses the old `_timestamp` as a base.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/76959292","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-76959292","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":76959292,"node_id":"MDEyOklzc3VlQ29tbWVudDc2OTU5Mjky","user":{"login":"coxchen","id":503112,"node_id":"MDQ6VXNlcjUwMzExMg==","avatar_url":"https://avatars1.githubusercontent.com/u/503112?v=4","gravatar_id":"","url":"https://api.github.com/users/coxchen","html_url":"https://github.com/coxchen","followers_url":"https://api.github.com/users/coxchen/followers","following_url":"https://api.github.com/users/coxchen/following{/other_user}","gists_url":"https://api.github.com/users/coxchen/gists{/gist_id}","starred_url":"https://api.github.com/users/coxchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coxchen/subscriptions","organizations_url":"https://api.github.com/users/coxchen/orgs","repos_url":"https://api.github.com/users/coxchen/repos","events_url":"https://api.github.com/users/coxchen/events{/privacy}","received_events_url":"https://api.github.com/users/coxchen/received_events","type":"User","site_admin":false},"created_at":"2015-03-03T14:52:15Z","updated_at":"2015-03-03T15:34:16Z","author_association":"NONE","body":"Hi @clintongormley \n\nThanks for your reply.\n\nSorry for the confusion. I didn't update the _timestamp field (or log_time in my example), instead I did partial update to the **log_count** field with:\n\n```\ncurl -XPOST 'localhost:9200/activity/log/1/_update' -d '{ \"script\" : \"ctx._source.log_count+=1\" }'\n```\n\nI just want to update fields **other than** the _timestamp filed and _ttl field, so I don't see why I hit the AlreadyExpiredException.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/77010842","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-77010842","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":77010842,"node_id":"MDEyOklzc3VlQ29tbWVudDc3MDEwODQy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-03-03T19:01:33Z","updated_at":"2015-03-03T19:01:33Z","author_association":"CONTRIBUTOR","body":"@coxchen It means that the document has actually expired, but not yet been deleted. Expired docs are only removed every 60 seconds.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/77088566","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-77088566","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":77088566,"node_id":"MDEyOklzc3VlQ29tbWVudDc3MDg4NTY2","user":{"login":"coxchen","id":503112,"node_id":"MDQ6VXNlcjUwMzExMg==","avatar_url":"https://avatars1.githubusercontent.com/u/503112?v=4","gravatar_id":"","url":"https://api.github.com/users/coxchen","html_url":"https://github.com/coxchen","followers_url":"https://api.github.com/users/coxchen/followers","following_url":"https://api.github.com/users/coxchen/following{/other_user}","gists_url":"https://api.github.com/users/coxchen/gists{/gist_id}","starred_url":"https://api.github.com/users/coxchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coxchen/subscriptions","organizations_url":"https://api.github.com/users/coxchen/orgs","repos_url":"https://api.github.com/users/coxchen/repos","events_url":"https://api.github.com/users/coxchen/events{/privacy}","received_events_url":"https://api.github.com/users/coxchen/received_events","type":"User","site_admin":false},"created_at":"2015-03-04T02:59:02Z","updated_at":"2015-03-04T03:13:49Z","author_association":"NONE","body":"Hi @clintongormley \n\nNope, it's not that case. The document I'd like to update still has valid _ttl (>> 0).\n\nI first found this issue in a production system I'm working on. In this case, I had a document with _ttl originally set to **7d**, and I got the AlreadyExpiredException from updating that document on the **4th day** after it been indexed in ES. At that time, the document **still has its _ttl about 3 days left**.\n\nI did some experiments, which you can read the details at https://medium.com/@coxchen/document-obsolescence-in-elasticsearch-c5973dd9e68d if you have time.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/77091436","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-77091436","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":77091436,"node_id":"MDEyOklzc3VlQ29tbWVudDc3MDkxNDM2","user":{"login":"coxchen","id":503112,"node_id":"MDQ6VXNlcjUwMzExMg==","avatar_url":"https://avatars1.githubusercontent.com/u/503112?v=4","gravatar_id":"","url":"https://api.github.com/users/coxchen","html_url":"https://github.com/coxchen","followers_url":"https://api.github.com/users/coxchen/followers","following_url":"https://api.github.com/users/coxchen/following{/other_user}","gists_url":"https://api.github.com/users/coxchen/gists{/gist_id}","starred_url":"https://api.github.com/users/coxchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coxchen/subscriptions","organizations_url":"https://api.github.com/users/coxchen/orgs","repos_url":"https://api.github.com/users/coxchen/repos","events_url":"https://api.github.com/users/coxchen/events{/privacy}","received_events_url":"https://api.github.com/users/coxchen/received_events","type":"User","site_admin":false},"created_at":"2015-03-04T03:34:51Z","updated_at":"2015-03-04T03:36:23Z","author_association":"NONE","body":"@clintongormley \n\nBelow is the result of my experiments, showing how _ttl of document changes over time.\n\n![ttl_change_chart](https://cloud.githubusercontent.com/assets/503112/6477649/c19516c0-c260-11e4-9195-e42f1dd9564f.png)\n\nI have four documents indexed in ES\n- /activity/log1/1 is _green_ curve\n- /activity/log1/2 is _yellow_ curve\n- /activity/log2/3 is _blue_ curve\n- /activity/log2/4 is _orange_ curve\n\nwith the following index mapping\n\n```\n{\n  \"activity\" : {\n    \"mappings\" : {\n      \"log1\" : {\n        \"_timestamp\" : {\"enabled\" : true, \"path\" : \"log_time\"},\n        \"_ttl\" : {\"enabled\" : true, \"default\" : 300000},\n        \"properties\" : {\n          \"log_count\" : {\"type\" : \"integer\"},\n          \"log_time\" : {\"type\" : \"date\"}\n        }\n      },\n      \"log2\" : {\n        \"_ttl\" : {\"enabled\" : true, \"default\" : 300000},\n        \"properties\" : {\n          \"log_count\" : {\"type\" : \"integer\"},\n          \"log_time\" : {\"type\" : \"date\"}\n        }\n      }\n    }\n  }\n}\n```\n\nI also have script to update the **log_count** field to document **2** and **4** periodically.\n\n```\ncurl -XPOST 'localhost:9200/activity/log1/2/_update' -d '{ \"script\" : \"ctx._source.log_count+=1\" }'\n\ncurl -XPOST 'localhost:9200/activity/log2/4/_update' -d '{ \"script\" : \"ctx._source.log_count+=1\" }'\n```\n\nSupposedly, the curves of the 4 document should overlap. But you can see the **yellow** curve (document 2) is outstanding. It doesn't look right to me. Can you help to explain?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92031163","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-92031163","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":92031163,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMDMxMTYz","user":{"login":"coxchen","id":503112,"node_id":"MDQ6VXNlcjUwMzExMg==","avatar_url":"https://avatars1.githubusercontent.com/u/503112?v=4","gravatar_id":"","url":"https://api.github.com/users/coxchen","html_url":"https://github.com/coxchen","followers_url":"https://api.github.com/users/coxchen/followers","following_url":"https://api.github.com/users/coxchen/following{/other_user}","gists_url":"https://api.github.com/users/coxchen/gists{/gist_id}","starred_url":"https://api.github.com/users/coxchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coxchen/subscriptions","organizations_url":"https://api.github.com/users/coxchen/orgs","repos_url":"https://api.github.com/users/coxchen/repos","events_url":"https://api.github.com/users/coxchen/events{/privacy}","received_events_url":"https://api.github.com/users/coxchen/received_events","type":"User","site_admin":false},"created_at":"2015-04-12T10:34:40Z","updated_at":"2015-04-12T10:34:40Z","author_association":"NONE","body":"Hi @clintongormley \n\nI trace the source code and found that, in **TTLFieldMapper.java**, the _timestamp in document source will be used to check expiration when updating a document. So the workaround for my issue is to **always provide the original _ttl value** when updating the document, even though I don't have the intention to update _ttl.\n\nYou can check my article for details: https://medium.com/@coxchen/saving-document-half-life-in-es-89be764f21ca\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92322181","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-92322181","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":92322181,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzIyMTgx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T11:38:18Z","updated_at":"2015-04-13T11:38:18Z","author_association":"CONTRIBUTOR","body":"Hi @coxchen \n\nThanks for digging!  I've just tried my own (slightly different) test and see the `_ttl` increasing by leaps and bounds:\n\n```\nDELETE activity\n\nPUT activity\n{\n  \"mappings\": {\n    \"log\": {\n      \"_timestamp\": {\n        \"enabled\": true,\n        \"path\": \"log_time\",\n        \"store\": true\n      },\n      \"_ttl\": {\n        \"enabled\": true,\n        \"default\": 300000\n      },\n      \"properties\": {\n        \"log_count\": {\n          \"type\": \"integer\"\n        },\n        \"log_time\": {\n          \"type\": \"date\"\n        }\n      }\n    }\n  }\n}\n```\n\nIndex a document using tomorrow's date:\n\n```\nPUT activity/log/1\n{\n  \"log_time\": \"2015-04-14\"\n}\n```\n\nRepeat these two steps to see the `_ttl` just keep on growing\n\n```\nGET _search?fields=_ttl\n\nPOST activity/log/1/_update \n{\n  \"doc\": { \"foo\": \"bar\" }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92370964","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-92370964","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":92370964,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzcwOTY0","user":{"login":"coxchen","id":503112,"node_id":"MDQ6VXNlcjUwMzExMg==","avatar_url":"https://avatars1.githubusercontent.com/u/503112?v=4","gravatar_id":"","url":"https://api.github.com/users/coxchen","html_url":"https://github.com/coxchen","followers_url":"https://api.github.com/users/coxchen/followers","following_url":"https://api.github.com/users/coxchen/following{/other_user}","gists_url":"https://api.github.com/users/coxchen/gists{/gist_id}","starred_url":"https://api.github.com/users/coxchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coxchen/subscriptions","organizations_url":"https://api.github.com/users/coxchen/orgs","repos_url":"https://api.github.com/users/coxchen/repos","events_url":"https://api.github.com/users/coxchen/events{/privacy}","received_events_url":"https://api.github.com/users/coxchen/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T14:16:39Z","updated_at":"2015-04-13T14:16:39Z","author_association":"NONE","body":"Hi @clintongormley \n\nInteresting, the log_time is some time in the future, making the _ttl growing with UPDATE.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/99930322","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-99930322","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":99930322,"node_id":"MDEyOklzc3VlQ29tbWVudDk5OTMwMzIy","user":{"login":"darylrobbins","id":2270905,"node_id":"MDQ6VXNlcjIyNzA5MDU=","avatar_url":"https://avatars1.githubusercontent.com/u/2270905?v=4","gravatar_id":"","url":"https://api.github.com/users/darylrobbins","html_url":"https://github.com/darylrobbins","followers_url":"https://api.github.com/users/darylrobbins/followers","following_url":"https://api.github.com/users/darylrobbins/following{/other_user}","gists_url":"https://api.github.com/users/darylrobbins/gists{/gist_id}","starred_url":"https://api.github.com/users/darylrobbins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darylrobbins/subscriptions","organizations_url":"https://api.github.com/users/darylrobbins/orgs","repos_url":"https://api.github.com/users/darylrobbins/repos","events_url":"https://api.github.com/users/darylrobbins/events{/privacy}","received_events_url":"https://api.github.com/users/darylrobbins/received_events","type":"User","site_admin":false},"created_at":"2015-05-07T16:30:47Z","updated_at":"2015-05-07T16:30:47Z","author_association":"NONE","body":"I have hit this same issue when upgrading from 1.4.2 to 1.5.2. I'm using a mvel script to update attributes in the document (neither the _timestamp or _ttl). The issue appears to happen for some documents but not others.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/218748569","html_url":"https://github.com/elastic/elasticsearch/issues/9956#issuecomment-218748569","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9956","id":218748569,"node_id":"MDEyOklzc3VlQ29tbWVudDIxODc0ODU2OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-12T12:56:15Z","updated_at":"2016-05-12T12:56:15Z","author_association":"CONTRIBUTOR","body":"Closing in favour of #18280\n","performed_via_github_app":null}]