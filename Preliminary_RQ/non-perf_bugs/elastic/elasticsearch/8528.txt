{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8528","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8528/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8528/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8528/events","html_url":"https://github.com/elastic/elasticsearch/issues/8528","id":49201867,"node_id":"MDU6SXNzdWU0OTIwMTg2Nw==","number":8528,"title":"[CI Failure] IndexStatsTests.throttleStats \"Delete Index failed - not acked\"","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"labels":[{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"assignees":[{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2014-11-18T10:00:22Z","updated_at":"2014-11-18T16:56:36Z","closed_at":"2014-11-18T12:23:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"http://build-us-1.elasticsearch.org/job/es_core_1x_metal/4765\n\n```\n  1> Throwable:\n  1> java.lang.AssertionError: Delete Index failed - not acked\n  1> Expected: <true>\n  1>      but: was <false>\n  1>     __randomizedtesting.SeedInfo.seed([567E75887CCCE111:EB7D7A75ECB82CA5]:0)\n  1>     org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\n  1>     org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked(ElasticsearchAssertions.java:114)\n  1>     org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked(ElasticsearchAssertions.java:110)\n  1>     org.elasticsearch.test.TestCluster.wipeIndices(TestCluster.java:138)\n  1>     org.elasticsearch.test.TestCluster.wipe(TestCluster.java:75)\n  1>     org.elasticsearch.test.ElasticsearchIntegrationTest.afterInternal(ElasticsearchIntegrationTest.java:616)\n  1>     org.elasticsearch.test.ElasticsearchIntegrationTest.after(ElasticsearchIntegrationTest.java:1788)\n```\n\nThis failure has plagued us for some time.  It happens during test cleanup, when we ask ES to delete the index, but that delete takes > 30 seconds (times out) and causes the not acked.\n\nThe question is why the delete would take so long.\n\nWe recently (#7730) changed MockFSDirectoryService to do a flush when an index is closed, in order to run check index, and for this test that flush sometimes (rarely) takes > 30 seconds.\n\nOn the most recent iteration, I added \"dump all threads\" when this assert trips, so we got all threads in this failure, but ... it does not reveal much (no deadlock).  I see one thread stuck in fsync:\n\n```\n  1>   421) Thread[id=5152, name=elasticsearch[node_s0][generic][T#2], state=RUNNABLE, group=TGRP-IndexStatsTests]\n  1>         at sun.nio.ch.FileDispatcherImpl.force0(Native Method)\n  1>         at sun.nio.ch.FileDispatcherImpl.force(FileDispatcherImpl.java:76)\n  1>         at sun.nio.ch.FileChannelImpl.force(FileChannelImpl.java:386)\n  1>         at org.apache.lucene.util.IOUtils.fsync(IOUtils.java:316)\n  1>         at org.apache.lucene.store.FSDirectory.fsync(FSDirectory.java:415)\n  1>         at org.apache.lucene.store.FSDirectory.sync(FSDirectory.java:310)\n  1>         at org.apache.lucene.store.FilterDirectory.sync(FilterDirectory.java:74)\n  1>         at org.elasticsearch.index.store.DistributorDirectory.sync(DistributorDirectory.java:115)\n  1>         at org.apache.lucene.store.MockDirectoryWrapper.sync(MockDirectoryWrapper.java:233)\n  1>         at org.apache.lucene.store.FilterDirectory.sync(FilterDirectory.java:74)\n  1>         at org.apache.lucene.index.IndexWriter.startCommit(IndexWriter.java:4519)\n  1>         at org.apache.lucene.index.IndexWriter.prepareCommitInternal(IndexWriter.java:2994)\n  1>         at org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:3097)\n  1>         at org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3064)\n  1>         at org.elasticsearch.index.engine.internal.InternalEngine.flush(InternalEngine.java:924)\n  1>         at org.elasticsearch.index.shard.service.InternalIndexShard.flush(InternalIndexShard.java:628)\n  1>         at org.elasticsearch.test.store.MockFSDirectoryService$1.beforeIndexShardClosed(MockFSDirectoryService.java:89)\n```\n\nAnd then, because MockDirectoryWrapper is heavily sync'd, I see other threads in Lucene (one merging, one trying to do refresh) blocked in MDW's methods.\n\nNet/net this seems to indicate that fsync of the many small files created by this test is just too slow.\n","closed_by":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"performed_via_github_app":null}