[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/565440065","html_url":"https://github.com/elastic/elasticsearch/issues/50177#issuecomment-565440065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50177","id":565440065,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTQ0MDA2NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-12-13T13:25:14Z","updated_at":"2019-12-13T13:25:14Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/565441451","html_url":"https://github.com/elastic/elasticsearch/issues/50177#issuecomment-565441451","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50177","id":565441451,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTQ0MTQ1MQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-12-13T13:29:50Z","updated_at":"2019-12-13T13:31:30Z","author_association":"CONTRIBUTOR","body":"This is the first time I'm seeing this exact issue related to `testStopAndRestart` test (the test which I'm working for some time already).\r\nHere is the excerpt from the server logs downloaded from Jenkins:\r\n```\r\n3371 [2019-12-13T09:37:55,153][INFO ][o.e.x.m.a.TransportStartDataFrameAnalyticsAction] [integTest-1] [regression_stop_and_restart] Starting data frame analytics^M\r\n3372 [2019-12-13T09:37:55,807][INFO ][o.e.x.m.d.DataFrameAnalyticsManager] [integTest-1] [regression_stop_and_restart] Creating destination index [regression_stop_and_restart_source_index_results]^M\r\n3373 [2019-12-13T09:37:56,382][INFO ][o.e.x.m.a.TransportStopDataFrameAnalyticsAction] [integTest-1] [regression_stop_and_restart] Stopping task with force [false]^M\r\n3374 [2019-12-13T09:37:56,779][WARN ][o.e.x.m.p.AbstractNativeProcess] [integTest-1] [regression_stop_and_restart] Failed to get PID of analytics process to kill^M\r\n3375 [2019-12-13T09:37:56,785][INFO ][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-1] [regression_stop_and_restart] Closing process^M\r\n3376 [2019-12-13T09:37:56,880][FATAL][o.e.x.m.p.l.CppLogMessageHandler] [integTest-1] [regression_stop_and_restart] [data_frame_analyzer/13148] [Main.cc@49] Environment error: failed to open file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'.^M\r\n3377 [2019-12-13T09:37:56,880][FATAL][o.e.x.m.p.l.CppLogMessageHandler] [integTest-1] [regression_stop_and_restart] [data_frame_analyzer/13148] [Main.cc@148] Failed to read config file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'^M\r\n3378 [2019-12-13T09:37:56,883][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-1] [regression_stop_and_restart] Error closing data frame analyzer process^M\r\n3379 org.elasticsearch.ElasticsearchException: Environment error: failed to open file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'.\r\n3380 Failed to read config file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'\r\n3381 ^M\r\n3382     at org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper.serverError(ExceptionsHelper.java:51) ~[x-pack-core-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3383     at org.elasticsearch.xpack.ml.process.AbstractNativeProcess.close(AbstractNativeProcess.java:182) ~[x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3384     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.closeProcess(AnalyticsProcessManager.java:297) [x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3385     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.processData(AnalyticsProcessManager.java:177) [x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3386     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.lambda$runJob$1(AnalyticsProcessManager.java:119) [x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3387     at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:629) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]^M\r\n3388     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]^M\r\n3389     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]^M\r\n3390     at java.lang.Thread.run(Thread.java:834) [?:?]^M\r\n3391 [2019-12-13T09:37:56,885][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-1] [regression_stop_and_restart] Marking task failed; [regression_stop_and_restart] Error closing data frame analyzer process [Environment error: failed to open file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'.\r\n3392 Failed to read config file 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ml\\qa\\native-multi-node-tests\\build\\testclusters\\integTest-1\\tmp\\analysis12988701410012102091.conf'\r\n3393 ]^M\r\n3394 [2019-12-13T09:37:56,938][INFO ][o.e.x.m.d.DataFrameAnalyticsTask] [integTest-1] [regression_stop_and_restart] Successfully update task state to [failed]^M\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/565506633","html_url":"https://github.com/elastic/elasticsearch/issues/50177#issuecomment-565506633","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50177","id":565506633,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTUwNjYzMw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-12-13T16:25:33Z","updated_at":"2019-12-13T16:25:33Z","author_association":"CONTRIBUTOR","body":"@przemekwitek to me that sequence of log messages suggests a race between start and stop.\r\n\r\n1. Job is started\r\n2. Job is stopped while the start sequence is still in progress\r\n3. Stop sequence tries to kill the process and fails because it hasn't been running long enough to report its PID to the JVM\r\n4. Stop sequence deletes the native process's config file\r\n5. Native process tries to read its config file and fails\r\n\r\nIt implies this logic is flawed: https://github.com/elastic/elasticsearch/blob/7107c221a704adf736ae551e939d0e8d60006dc0/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/process/AbstractNativeProcess.java#L200-L203\r\n\r\nAnomaly detection jobs treat a closing of their input stream as meaning they've been asked to gracefully shut down.  Not sure about data frame analytics jobs.  But even for anomaly detection jobs there's a race where the process kill could be attempted in between startup and reading the config files, fail, and then the config files get deleted by the JVM before the native process tries to read them.\r\n\r\nSo I think it would be worth trying a wait of `Duration.ofMillis(processConnectTimeout.getMillis());` instead of `Duration.ZERO` where `processConnectTimeout` comes from the `MachineLearning.PROCESS_CONNECT_TIMEOUT` dynamic setting.\r\n\r\nPlease give it a try and if it doesn't cause any easily reproducible problems locally that suggest it's a bad idea then add it to the code and we can see if it stops these related intermittent failures of the various \"stop and restart\" tests.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/565978275","html_url":"https://github.com/elastic/elasticsearch/issues/50177#issuecomment-565978275","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50177","id":565978275,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NTk3ODI3NQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-12-16T09:30:07Z","updated_at":"2019-12-16T09:30:07Z","author_association":"CONTRIBUTOR","body":"> Please give it a try and if it doesn't cause any easily reproducible problems locally that suggest it's a bad idea then add it to the code and we can see if it stops these related intermittent failures of the various \"stop and restart\" tests.\r\n\r\nThanks for the analysis, @droberts195. I'll try it out.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571940604","html_url":"https://github.com/elastic/elasticsearch/issues/50177#issuecomment-571940604","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50177","id":571940604,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTk0MDYwNA==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-01-08T08:22:12Z","updated_at":"2020-01-08T08:22:12Z","author_association":"CONTRIBUTOR","body":"A number of fixes were applied and the last CI failure of this test was a week ago.\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:e58bf320-7efd-11e8-bf69-63c8ef516157,key:branch,negate:!t,params:(query:move-jobs,type:phrase),type:phrase,value:move-jobs),query:(match:(branch:(query:move-jobs,type:phrase))))),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'%22RegressionIT%20testStopAndRestart%22'),sort:!(time,desc))\r\n\r\nClosing this issue for now.","performed_via_github_app":null}]