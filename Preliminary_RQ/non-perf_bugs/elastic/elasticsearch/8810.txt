{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8810","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8810/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8810/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8810/events","html_url":"https://github.com/elastic/elasticsearch/issues/8810","id":51240597,"node_id":"MDU6SXNzdWU1MTI0MDU5Nw==","number":8810,"title":"java.lang.OutOfMemoryError: Java heap space after upgrade from 0.90","user":{"login":"serj-p","id":2565455,"node_id":"MDQ6VXNlcjI1NjU0NTU=","avatar_url":"https://avatars0.githubusercontent.com/u/2565455?v=4","gravatar_id":"","url":"https://api.github.com/users/serj-p","html_url":"https://github.com/serj-p","followers_url":"https://api.github.com/users/serj-p/followers","following_url":"https://api.github.com/users/serj-p/following{/other_user}","gists_url":"https://api.github.com/users/serj-p/gists{/gist_id}","starred_url":"https://api.github.com/users/serj-p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/serj-p/subscriptions","organizations_url":"https://api.github.com/users/serj-p/orgs","repos_url":"https://api.github.com/users/serj-p/repos","events_url":"https://api.github.com/users/serj-p/events{/privacy}","received_events_url":"https://api.github.com/users/serj-p/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2014-12-08T01:34:32Z","updated_at":"2015-02-19T20:49:37Z","closed_at":"2015-02-19T20:49:37Z","author_association":"NONE","active_lock_reason":null,"body":"We have 6 servers and 14 shards in cluster, the index size 26GB, we have 1 replica so total size is 52GB, and ES v1.4.0, java version \"1.7.0_65\"\nWe use servers with RAM of 14GB (m3.xlarge), and heap is set to 7GB\n\nAfter update from 0.90 we started facing next issue:\nrandom cluster servers around once a day/two hits the heap size limit (java.lang.OutOfMemoryError: Java heap space) in log, and cluster falls - becomes red or yellow\n\nWe tried to add more servers to cluster - even 8, but than it's a matter of time when we'll hit the problem, so looks like there is no matter how many servers are in cluster - it still hits the limit after some time.\nBefore we started facing the problem we were running smoothly with 3 servers\nAlso we tried to set indices.fielddata.cache.size:  40% but it didnt helped\nAlso, there are possible workarounds to flush heap:\n1) reboot some server - than heap becomes under 70% and for some time cluster is ok\nor\n2) decrease number of replicas to 0, and than back to 1\n\nUpgrade to 1.4.1 hasn't solved an issue. \n\nFinally <b>found the query causing the cluster crashes</b>. After I commented code doing this - the claster is ok for few days. Before it was crashing once a day in average.\n\nthe query looks like:\n\n```\n    {\n        \"sort\": [\n            {\n                \"user_last_contacted.ct\": {\n                    \"nested_filter\": {\n                        \"term\": {\n                            \"user_last_contacted.owner_id\": \"542b2b7fb0bc2244056fd90f\"\n                        }\n                    },\n                    \"order\": \"desc\",\n                    \"missing\": \"_last\"\n                }\n            }\n        ],\n        \"query\": {\n            \"filtered\": {\n                \"filter\": {\n                    \"term\": {\n                        \"company_id\": \"52c0e0b7e0534664db9dfb9a\"\n                    }\n                },\n                \"query\": {\n                    \"match_all\": {}\n                }\n            }\n        },\n        \"explain\": false,\n        \"from\": 0,\n        \"size\": 100\n    }\n```\n\nthe mapping looks like:\n\n```\n        \"contact\": {\n            \"_all\": {\n                \"type\": \"string\",\n                \"enabled\": true,\n                \"analyzer\": \"default_full\",\n                \"index\": \"analyzed\"\n            },\n            \"_routing\": {\n                \"path\": \"company_id\",\n                \"required\": true\n            },\n            \"_source\": {\n                \"enabled\": false\n            },\n            \"include_in_all\": true,\n            \"dynamic\": false,\n            \"properties\": {\n                \"user_last_contacted\": {\n                    \"include_in_all\": false,\n                    \"dynamic\": false,\n                    \"type\": \"nested\",\n                    \"properties\": {\n                        \"ct\": {\n                            \"include_in_all\": false,\n                            \"index\": \"not_analyzed\",\n                            \"type\": \"date\"\n                        },\n                        \"owner_id\": {\n                            \"type\": \"string\"\n                        }\n                    }\n                }...\n```\n\nuser_last_contacted is an array field with nested objects. The size of the array can be 100+ items.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}