{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33010","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33010/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33010/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33010/events","html_url":"https://github.com/elastic/elasticsearch/issues/33010","id":352397366,"node_id":"MDU6SXNzdWUzNTIzOTczNjY=","number":33010,"title":"UpdateRequest.fromXContent or JsonXContentParser.nextToken loop forever resulting  http_server_worker thread too busy to accept any connections. ","user":{"login":"wuyunfeng","id":5183061,"node_id":"MDQ6VXNlcjUxODMwNjE=","avatar_url":"https://avatars1.githubusercontent.com/u/5183061?v=4","gravatar_id":"","url":"https://api.github.com/users/wuyunfeng","html_url":"https://github.com/wuyunfeng","followers_url":"https://api.github.com/users/wuyunfeng/followers","following_url":"https://api.github.com/users/wuyunfeng/following{/other_user}","gists_url":"https://api.github.com/users/wuyunfeng/gists{/gist_id}","starred_url":"https://api.github.com/users/wuyunfeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuyunfeng/subscriptions","organizations_url":"https://api.github.com/users/wuyunfeng/orgs","repos_url":"https://api.github.com/users/wuyunfeng/repos","events_url":"https://api.github.com/users/wuyunfeng/events{/privacy}","received_events_url":"https://api.github.com/users/wuyunfeng/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-08-21T06:06:03Z","updated_at":"2019-09-06T17:39:33Z","closed_at":"2019-09-06T17:39:33Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):5.5.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):1.8\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):Linux es-node-1 3.10.0-693.21.1.el7.x86_64, 6core, 30G memory\r\n\r\n**Description of the problem including expected versus actual behavior**:  curl -XGET http://localhost:8200 stuck until reset by peer exception\r\n\r\n**Steps to reproduce**:\r\n we start Elasticseaerch cluster with 4 nodes, we run some update API in this clusterï¼š\r\n\r\n```\r\nindex/type/{ID}/_update\" -d '{\"doc\":{\"f1\":\"xxx\",\"f2\":\"xxx\"},\"doc_as_upsert\":true}',\r\n```\r\nafter insert some document, we stop update relevant index, we do not perform any operation on the cluster,\r\nbut we find the cpu usage reached to 100%,  run the `ss -an | grep 8200`command line below, we find:\r\n\r\n![image](https://user-images.githubusercontent.com/5183061/44382797-03d0a080-a549-11e8-91d1-151682f8b1c4.png)\r\n\r\nwe print the jstack for those node with 100% cpu usage, find:\r\n\r\n![image](https://user-images.githubusercontent.com/5183061/44382967-97a26c80-a549-11e8-8caa-f6c63f348b4c.png)\r\n\r\nabout 6 http_server_work thread running forever(6 core)\r\n\r\n`I guess may be some extreme scenario trigger the Elasticsearch internal bug resulting in the http server work running forever even ignore the tcp accept queue(in other words,  the server was too busy to invoke tcp accept new connection), the LISTEN state TCP RECV-Q exceeds the max_some_conn resulting in reject any connection from client.`\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. we can not reproduce this scenario, we just reserver only one node having this problem, the other nodes we restart and this may not happen \r\n\r\n**Provide logs (if relevant)**:\r\n\r\nthe elasitcsearch process have no logs to print, we just invoke `jstack` on the stack and running the `netstat apn | grep 8200` or `ss -an | grep 8200`,\r\n\r\nI wonder weather this is a elasticsearch internal bug which may triggered in extreme scenario,\r\nthe `http_server_work` stacktrace below:\r\nelasticsearch[UYc-RX2][http_server_worker][T#10]\" #154 daemon prio=5 os_prio=0 tid=0x00007f6344044000 nid=0x81c5 runnable [\r\n0x00007f62f19ef000]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at org.elasticsearch.common.xcontent.json.JsonXContentParser.nextToken(JsonXContentParser.java:55)\r\n        at org.elasticsearch.action.update.UpdateRequest.fromXContent(UpdateRequest.java:788)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction.lambda$prepareRequest$0(RestUpdateAction.java:90)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction$$Lambda$1728/1931072261.accept(Unknown Source)\r\n        at org.elasticsearch.rest.RestRequest.applyContentParser(RestRequest.java:361)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction.prepareRequest(RestUpdateAction.java:89)\r\n        at org.elasticsearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:64)\r\n        at com.baidu.elasticsearch.BaiduPackPlugin.lambda$null$0(BaiduPackPlugin.java:79)\r\n        at com.baidu.elasticsearch.BaiduPackPlugin$$Lambda$1580/409439411.handleRequest(Unknown Source)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:262)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:200)\r\n        at org.elasticsearch.http.netty4.Netty4HttpServerTransport.dispatchRequest(Netty4HttpServerTransport.java:505)\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:72)\r\n\"elasticsearch[UYc-RX2][http_server_worker][T#12]\" #171 daemon prio=5 os_prio=0 tid=0x00007f6344048800 nid=0x81ee runnable [\r\n0x00007f62f19ae000]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at org.elasticsearch.common.xcontent.json.JsonXContentParser.nextToken(JsonXContentParser.java:55)\r\n        at org.elasticsearch.action.update.UpdateRequest.fromXContent(UpdateRequest.java:788)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction.lambda$prepareRequest$0(RestUpdateAction.java:90)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction$$Lambda$1728/1931072261.accept(Unknown Source)\r\n        at org.elasticsearch.rest.RestRequest.applyContentParser(RestRequest.java:361)\r\n        at org.elasticsearch.rest.action.document.RestUpdateAction.prepareRequest(RestUpdateAction.java:89)\r\n        at org.elasticsearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:64)\r\n        at com.baidu.elasticsearch.BaiduPackPlugin.lambda$null$0(BaiduPackPlugin.java:79)\r\n        at com.baidu.elasticsearch.BaiduPackPlugin$$Lambda$1580/409439411.handleRequest(Unknown Source)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:262)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:200)\r\n        at org.elasticsearch.http.netty4.Netty4HttpServerTransport.dispatchRequest(Netty4HttpServerTransport.java:505)\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:72)\r\n        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at org.elasticsearch.http.netty4.pipelining.HttpPipeliningHandler.channelRead(HttpPipeliningHandler.java:63)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n\r\n\r\n\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}