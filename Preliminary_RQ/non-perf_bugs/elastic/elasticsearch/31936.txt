{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31936","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31936/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31936/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31936/events","html_url":"https://github.com/elastic/elasticsearch/issues/31936","id":339970643,"node_id":"MDU6SXNzdWUzMzk5NzA2NDM=","number":31936,"title":"Metadata cannot reject aliases pointing to multiple indices when resolving routing","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"}],"state":"closed","locked":false,"assignee":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"assignees":[{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-07-10T19:08:11Z","updated_at":"2018-07-19T16:50:04Z","closed_at":"2018-07-19T16:50:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With #30942 (add is-write-index to aliases) and https://github.com/elastic/elasticsearch/pull/31520, we allow an alias to point to multiple indices when\r\nwriting/deleting documents. This means that we will resolve the alias to the \"write index\" specified in alias metadata.\r\n\r\nThis presents a problem when requests resolve routing values against aliases. Historically, it was clear \r\nthat if an alias specified routing values, those would be used, instead of the index's. With, potentially, different aliases having different routing values, it isn't clear which routing value an index request should use.\r\n\r\nThe code in Metadata that needs modifying:\r\nhttps://github.com/elastic/elasticsearch/blob/4761a1f/server/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java#L479-L491\r\n```\r\n    public String resolveIndexRouting(@Nullable String routing, String aliasOrIndex) {\r\n        if (aliasOrIndex == null) {\r\n            return routing;\r\n        }\r\n\r\n        AliasOrIndex result = getAliasAndIndexLookup().get(aliasOrIndex);\r\n        if (result == null || result.isAlias() == false) {\r\n            return routing;\r\n        }\r\n        AliasOrIndex.Alias alias = (AliasOrIndex.Alias) result;\r\n        if (result.getIndices().size() > 1) {\r\n            rejectSingleIndexOperation(aliasOrIndex, result);\r\n        }\r\n```\r\n\r\nThere are a few solutions\r\n\r\n1. when resolving routing within write operations (ones that require a write index), aliases matching multiple indices can have their routing values ignored. This means the default routing value is used, and no exception is thrown.\r\n2. We can throw an exception if an alias points to multiple indices and any one of the aliases specifies their own routing values. Otherwise, we have nothing to look for, so it is safe to have an alias point to multiple indices, and simply return the default routing value passed into the method.\r\n3. others?\r\n\r\ncc/ @bleskes ","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}