[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264131285","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264131285","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264131285,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDEzMTI4NQ==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T10:05:02Z","updated_at":"2016-12-01T10:05:02Z","author_association":"CONTRIBUTOR","body":"Oh, forgot to mention that I use 5.0.1.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264139688","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264139688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264139688,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDEzOTY4OA==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T10:46:12Z","updated_at":"2016-12-01T10:46:12Z","author_association":"CONTRIBUTOR","body":"Here's the NPE stacktrace from the console BTW:\r\n\r\n```\r\n[2016-12-01T11:59:13,208][WARN ][r.suppressed             ] path: /tv_bug/doc/_termvectors, params: {pretty=true, preference=_shards:1, index=tv_bug, type=doc}\r\norg.elasticsearch.transport.RemoteTransportException: [C-N1Zbn][127.0.0.1:9300][indices:data/read/tv[s]]\r\nCaused by: java.lang.NullPointerException\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:79) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:42) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:293) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:286) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:520) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_92]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_92]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_92]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264145894","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264145894","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264145894,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDE0NTg5NA==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T11:17:19Z","updated_at":"2016-12-01T11:17:19Z","author_association":"CONTRIBUTOR","body":"After reviewing ES code, I believe I found the issue, in `TermVectorsWriter.setFields()` (line 72)\r\n```\r\n            // if no terms found, take the retrieved term vector fields for stats\r\n            if (topLevelTerms == null) {\r\n                topLevelTerms = fieldTermVector;\r\n            }\r\n```\r\n\r\nSince the shard has no documents indexed, it finds no terms for the artificial document's field, and therefore uses the doc's TV as the terms iterator.\r\n\r\nSo if I send:\r\n\r\n```\r\n$ curl -XGET 'http://localhost:9200/tv_bug/doc/_termvectors?preference=_shards:0&pretty=true' -d '{\r\n  \"term_statistics\" : true,\r\n  \"doc\" : {\r\n    \"text\" : \"one one one\"\r\n  }\r\n}'\r\n```\r\n\r\nI get `ttf=3`, which supports the observation above.\r\n\r\nI still think it's a bug, in that it's OK to receive the artificial doc's TV, but I don't expect term_statistics to use the doc's stats as what's in the index?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264147140","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264147140","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264147140,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDE0NzE0MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T11:23:49Z","updated_at":"2016-12-01T11:23:49Z","author_association":"CONTRIBUTOR","body":"Hi @shaie \r\n\r\nThanks for the report and for digging into the code to find the issue.  Would you be up for sending a PR to fix this?\r\n\r\nAlso, if you don't mind, I'd be interested to hear how what you're using the term vectors API for?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264155634","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264155634","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264155634,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDE1NTYzNA==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T12:02:10Z","updated_at":"2016-12-01T12:02:10Z","author_association":"CONTRIBUTOR","body":"Thanks for the quick response @clintongormley. As for what I use it for, see this discussion that I started https://discuss.elastic.co/t/terms-stats-api/67508 and this feature request https://github.com/elastic/elasticsearch/issues/21886. Basically I want to get terms statistics (currently for re-ranking capabilities, and also at the moment outside of 'scripting') and the lack of API got me to try TV and artificial documents, where I send the list of terms I wish to get stats for as an artificial document, to all the shards.\r\n\r\nI would love to send a PR, but I'll need to do some work to setup a dev environment. I.e. I don't have an ES fork, not even Gradle installed ðŸ˜„ , and so I cannot run ES tests, build the code etc. I will start doing that though, cause I wish to be able to contribute to the code (e.g. maybe this terms_stats API), so it seems worth it. In the meanwhile, I think perhaps if you/we implement something like an EmptyTermsEnum which assumes there are no terms to iterate on, and set `topLevelTerms` to such instance, the rest of the code would just work. But, if I want to test it, I need to setup the dev environment...\r\n\r\nAlso, what about that NPE? Do you prefer I report that in a separate bug report?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264164686","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264164686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264164686,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDE2NDY4Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T12:44:36Z","updated_at":"2016-12-01T12:44:36Z","author_association":"CONTRIBUTOR","body":"> but I'll need to do some work to setup a dev environment. I.e. I don't have an ES fork, not even Gradle installed \r\n\r\njust a few easy clicks away :)\r\n\r\n> Also, what about that NPE? Do you prefer I report that in a separate bug report?\r\n\r\nNo, a drive-by-fix would be fine :)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264166888","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264166888","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264166888,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDE2Njg4OA==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T12:56:04Z","updated_at":"2016-12-01T12:56:04Z","author_association":"CONTRIBUTOR","body":"> just a few easy clicks away :)\r\n\r\nIndeed. I've got my fork and gradle set up. Now figuring out what do I need to run to test it actually works :).\r\n\r\n> No, a drive-by-fix would be fine :)\r\n\r\nOh well, I don't know the cause for that yet ;)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264286494","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264286494","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264286494,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDI4NjQ5NA==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-01T20:32:44Z","updated_at":"2016-12-01T20:32:44Z","author_association":"CONTRIBUTOR","body":"@clintongormley I pushed a PR #21922 which fixes the term_statistics bug. I haven't yet addressed the NPE bug as I don't yet know what causes it. I think this should go under a separate commit though. Would appreciate your review and feedback on the changes.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264394411","html_url":"https://github.com/elastic/elasticsearch/issues/21906#issuecomment-264394411","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21906","id":264394411,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDM5NDQxMQ==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-02T07:50:40Z","updated_at":"2016-12-02T07:50:40Z","author_association":"CONTRIBUTOR","body":"I created #21928 to continue tracking the NPE issue.","performed_via_github_app":null}]