{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51401","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51401/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51401/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51401/events","html_url":"https://github.com/elastic/elasticsearch/issues/51401","id":554676652,"node_id":"MDU6SXNzdWU1NTQ2NzY2NTI=","number":51401,"title":"Possibly Incorrect IDF calculation","user":{"login":"jiyer2016","id":27082939,"node_id":"MDQ6VXNlcjI3MDgyOTM5","avatar_url":"https://avatars1.githubusercontent.com/u/27082939?v=4","gravatar_id":"","url":"https://api.github.com/users/jiyer2016","html_url":"https://github.com/jiyer2016","followers_url":"https://api.github.com/users/jiyer2016/followers","following_url":"https://api.github.com/users/jiyer2016/following{/other_user}","gists_url":"https://api.github.com/users/jiyer2016/gists{/gist_id}","starred_url":"https://api.github.com/users/jiyer2016/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiyer2016/subscriptions","organizations_url":"https://api.github.com/users/jiyer2016/orgs","repos_url":"https://api.github.com/users/jiyer2016/repos","events_url":"https://api.github.com/users/jiyer2016/events{/privacy}","received_events_url":"https://api.github.com/users/jiyer2016/received_events","type":"User","site_admin":false},"labels":[{"id":418189364,"node_id":"MDU6TGFiZWw0MTgxODkzNjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Ranking","name":":Search/Ranking","color":"0e8a16","default":false,"description":"Scoring, rescoring, rank evaluation."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-01-24T11:13:08Z","updated_at":"2020-01-24T12:18:14Z","closed_at":"2020-01-24T12:18:14Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version:** 7.4.2\r\n**JVM version:**  \"1.8.0_231\"\r\n**OS version:** windows x64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nES is possibly calculating the IDF incorrectly\r\nSee below to reproduce on a simple index\r\n\r\n**Steps to reproduce**:\r\n**# Step 1 - Create an Index - Make sure that all docs reside on a single shard**\r\n```\r\ncurl -H \"content-type: application/json\" -XPUT localhost:9200/ab -d'{\r\n    \"settings\": {\r\n        \"number_of_shards\": 1\r\n    },\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"x\": {\r\n                \"type\": \"text\"\r\n            },\r\n            \"y\": {\r\n                \"type\": \"text\"\r\n            }\r\n        }\r\n    }\r\n}'\r\n```\r\n\r\n**# Step 2 - Add 4 Documents**\r\n**## NOTE - Only 3 of the 4 documents contain the term \"b\"**\r\n```\r\ncurl -H \"content-type: application/json\" -XPUT localhost:9200/ab/_doc/1 -d'{\r\n    \"x\": \"a\",\r\n    \"y\": \"b\"\r\n}'\r\n```\r\n\r\n```\r\ncurl -H \"content-type: application/json\" -XPUT localhost:9200/ab/_doc/2 -d'{\r\n    \"x\": \"b\",\r\n    \"y\": \"b\"\r\n}'\r\n```\r\n\r\n```\r\ncurl -H \"content-type: application/json\" -XPUT localhost:9200/ab/_doc/5 -d'{\r\n    \"x\": \"a\",\r\n    \"y\": \"a b\"\r\n}'\r\n```\r\n\r\n```\r\ncurl -H \"content-type: application/json\" -XPUT localhost:9200/ab/_doc/6 -d'{\r\n    \"x\": \"a\",\r\n    \"y\": \"a\"\r\n}'\r\n```\r\n\r\n**# Step 3 - Issue a cross-fields search for term \"b\" across fields \"x\" and \"y\"**\r\n```\r\ncurl -H \"content-type: application/json\" -XGET localhost:9200/ab/_search?format=yaml -d '{\r\n\t\"explain\": true,\r\n    \"query\": {\r\n        \"multi_match\": {\r\n            \"query\": \"b\",\r\n            \"fields\": [\"x\", \"y\"],\r\n            \"type\": \"cross_fields\"           \r\n        }\r\n    }\r\n}'\r\n```\r\n\r\n**Issue - Why is n = 4 (number of documents containing term \"b\") in the below ?\r\n\tIt should be n = 3, since only 3 documents were indexed with term \"b\"**\r\n\r\n```\r\n        description: \"weight(x:b in 0) [PerFieldSimilarity], result of:\"\r\n        details:\r\n        - value: 0.105360515\r\n          description: \"score(freq=1.0), product of:\"\r\n          details:\r\n          - value: 2.2\r\n            description: \"boost\"\r\n            details: []\r\n          - value: 0.105360515\r\n            description: \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\"\r\n            details:\r\n            - value: 4\r\n              description: \"n, number of documents containing term\"\r\n              details: []\r\n            - value: 4\r\n              description: \"N, total number of documents with field\"\r\n              details: []\r\n```\r\n\r\n\r\n\r\nComplete Explain Debug:\r\n```\r\ntook: 758\r\ntimed_out: false\r\n_shards:\r\n  total: 1\r\n  successful: 1\r\n  skipped: 0\r\n  failed: 0\r\nhits:\r\n  total:\r\n    value: 3\r\n    relation: \"eq\"\r\n  max_score: 0.38845783\r\n  hits:\r\n  - _shard: \"[ab][0]\"\r\n    _node: \"JTjdssfqSjKmoYsFwMuX3g\"\r\n    _index: \"ab\"\r\n    _type: \"_doc\"\r\n    _id: \"1\"\r\n    _score: 0.38845783\r\n    _source:\r\n      x: \"a\"\r\n      y: \"b\"\r\n    _explanation:\r\n      value: 0.38845783\r\n      description: \"max of:\"\r\n      details:\r\n      - value: 0.38845783\r\n        description: \"weight(y:b in 0) [PerFieldSimilarity], result of:\"\r\n        details:\r\n        - value: 0.38845783\r\n          description: \"score(freq=1.0), product of:\"\r\n          details:\r\n          - value: 2.2\r\n            description: \"boost\"\r\n            details: []\r\n          - value: 0.35667494\r\n            description: \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\"\r\n            details:\r\n            - value: 3\r\n              description: \"n, number of documents containing term\"\r\n              details: []\r\n            - value: 4\r\n              description: \"N, total number of documents with field\"\r\n              details: []\r\n          - value: 0.49504948\r\n            description: \"tf, computed as freq / (freq + k1 * (1 - b + b * dl /avgdl))\\\r\n              \\ from:\"\r\n            details:\r\n            - value: 1.0\r\n              description: \"freq, occurrences of term within document\"\r\n              details: []\r\n            - value: 1.2\r\n              description: \"k1, term saturation parameter\"\r\n              details: []\r\n            - value: 0.75\r\n              description: \"b, length normalization parameter\"\r\n              details: []\r\n            - value: 1.0\r\n              description: \"dl, length of field\"\r\n              details: []\r\n            - value: 1.25\r\n              description: \"avgdl, average length of field\"\r\n              details: []\r\n  - _shard: \"[ab][0]\"\r\n    _node: \"JTjdssfqSjKmoYsFwMuX3g\"\r\n    _index: \"ab\"\r\n    _type: \"_doc\"\r\n    _id: \"2\"\r\n    _score: 0.38845783\r\n    _source:\r\n      x: \"b\"\r\n      y: \"b\"\r\n    _explanation:\r\n      value: 0.38845783\r\n      description: \"max of:\"\r\n      details:\r\n      - value: 0.105360515\r\n        description: \"weight(x:b in 0) [PerFieldSimilarity], result of:\"\r\n        details:\r\n        - value: 0.105360515\r\n          description: \"score(freq=1.0), product of:\"\r\n          details:\r\n          - value: 2.2\r\n            description: \"boost\"\r\n            details: []\r\n          - value: 0.105360515\r\n            description: \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\"\r\n            details:\r\n            - value: 4\r\n              description: \"n, number of documents containing term\"\r\n              details: []\r\n            - value: 4\r\n              description: \"N, total number of documents with field\"\r\n              details: []\r\n          - value: 0.45454544\r\n            description: \"tf, computed as freq / (freq + k1 * (1 - b + b * dl /avgdl))\\\r\n              \\ from:\"\r\n            details:\r\n            - value: 1.0\r\n              description: \"freq, occurrences of term within document\"\r\n              details: []\r\n            - value: 1.2\r\n              description: \"k1, term saturation parameter\"\r\n              details: []\r\n            - value: 0.75\r\n              description: \"b, length normalization parameter\"\r\n              details: []\r\n            - value: 1.0\r\n              description: \"dl, length of field\"\r\n              details: []\r\n            - value: 1.0\r\n              description: \"avgdl, average length of field\"\r\n              details: []\r\n      - value: 0.38845783\r\n        description: \"weight(y:b in 0) [PerFieldSimilarity], result of:\"\r\n        details:\r\n        - value: 0.38845783\r\n          description: \"score(freq=1.0), product of:\"\r\n          details:\r\n          - value: 2.2\r\n            description: \"boost\"\r\n            details: []\r\n          - value: 0.35667494\r\n            description: \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\"\r\n            details:\r\n            - value: 3\r\n              description: \"n, number of documents containing term\"\r\n              details: []\r\n            - value: 4\r\n100  6672  100  6497  100   175   8481    228 --:--:-- --:--:-- --:--:--  8710field\"\r\n              details: []\r\n          - value: 0.49504948\r\n            description: \"tf, computed as freq / (freq + k1 * (1 - b + b * dl /avgdl))\\\r\n              \\ from:\"\r\n            details:\r\n            - value: 1.0\r\n              description: \"freq, occurrences of term within document\"\r\n              details: []\r\n            - value: 1.2\r\n              description: \"k1, term saturation parameter\"\r\n              details: []\r\n            - value: 0.75\r\n              description: \"b, length normalization parameter\"\r\n              details: []\r\n            - value: 1.0\r\n              description: \"dl, length of field\"\r\n              details: []\r\n            - value: 1.25\r\n              description: \"avgdl, average length of field\"\r\n              details: []\r\n  - _shard: \"[ab][0]\"\r\n    _node: \"JTjdssfqSjKmoYsFwMuX3g\"\r\n    _index: \"ab\"\r\n    _type: \"_doc\"\r\n    _id: \"5\"\r\n    _score: 0.28638133\r\n    _source:\r\n      x: \"a\"\r\n      y: \"a b\"\r\n    _explanation:\r\n      value: 0.28638133\r\n      description: \"max of:\"\r\n      details:\r\n      - value: 0.28638133\r\n        description: \"weight(y:b in 0) [PerFieldSimilarity], result of:\"\r\n        details:\r\n        - value: 0.28638133\r\n          description: \"score(freq=1.0), product of:\"\r\n          details:\r\n          - value: 2.2\r\n            description: \"boost\"\r\n            details: []\r\n          - value: 0.35667494\r\n            description: \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\"\r\n            details:\r\n            - value: 3\r\n              description: \"n, number of documents containing term\"\r\n              details: []\r\n            - value: 4\r\n              description: \"N, total number of documents with field\"\r\n              details: []\r\n          - value: 0.36496347\r\n            description: \"tf, computed as freq / (freq + k1 * (1 - b + b * dl /avgdl))\\\r\n              \\ from:\"\r\n            details:\r\n            - value: 1.0\r\n              description: \"freq, occurrences of term within document\"\r\n              details: []\r\n            - value: 1.2\r\n              description: \"k1, term saturation parameter\"\r\n              details: []\r\n            - value: 0.75\r\n              description: \"b, length normalization parameter\"\r\n              details: []\r\n            - value: 2.0\r\n              description: \"dl, length of field\"\r\n              details: []\r\n            - value: 1.25\r\n              description: \"avgdl, average length of field\"\r\n              details: []\r\n```\r\n\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}