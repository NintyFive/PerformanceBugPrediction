{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24139","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24139/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24139/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24139/events","html_url":"https://github.com/elastic/elasticsearch/issues/24139","id":222216359,"node_id":"MDU6SXNzdWUyMjIyMTYzNTk=","number":24139,"title":"[TEST] NPE in UpgradeClusterClientYamlTestSuiteIT#\"Test rolling upgrade for stored scripts between the old namespace and the new namespace\"","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-04-17T20:03:31Z","updated_at":"2017-04-18T12:55:22Z","closed_at":"2017-04-17T23:04:25Z","author_association":"MEMBER","active_lock_reason":null,"body":"Does not reproduce for me.\r\n\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.x+multijob-intake/1028/console\r\n\r\n```\r\ngradle :qa:rolling-upgrade:upgradedClusterTestRunner -Dtests.seed=159A8B0455457423 -Dtests.class=org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT -Dtests.method=\"test {p0=/10_basic/Test rolling upgrade for stored scripts between the old namespace and the new namespace}\" -Dtests.security.manager=true -Dtests.locale=vi-VN -Dtests.timezone=America/Denver -Dtests.rest.suite=upgraded_cluster\r\n```\r\n\r\n```\r\njava.lang.AssertionError: Failure at [/10_basic:139]: hits.total didn't match the expected value:\r\n                    hits.total: expected [2] but was [1]\r\n\r\n\tat __randomizedtesting.SeedInfo.seed([159A8B0455457423:9DCEB4DEFBB919DB]:0)\r\n\tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:379)\r\n\tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.test(ESClientYamlSuiteTestCase.java:359)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1713)\r\n...\r\n```\r\n\r\nSeems to have been caused by an NPE with the script query:\r\n\r\n```\r\n[2017-04-17T13:06:34,138][INFO ][o.e.u.UpgradeClusterClientYamlTestSuiteIT] [test {p0=/10_basic/Test rolling upgrade for stored scripts between the old namespace and the new namespace}]: after test\r\n  1> [2017-04-17T13:06:34,142][INFO ][o.e.u.UpgradeClusterClientYamlTestSuiteIT] Stash dump on failure [{\r\n  1>   \"stash\" : {\r\n  1>     \"body\" : {\r\n  1>       \"took\" : 356,\r\n  1>       \"timed_out\" : false,\r\n  1>       \"_shards\" : {\r\n  1>         \"total\" : 5,\r\n  1>         \"successful\" : 4,\r\n  1>         \"failed\" : 1,\r\n  1>         \"failures\" : [\r\n  1>           {\r\n  1>             \"shard\" : 2,\r\n  1>             \"index\" : \"stored_index\",\r\n  1>             \"node\" : \"wp5TNZyEQ_-TQjpzVjCTlQ\",\r\n  1>             \"reason\" : {\r\n  1>               \"type\" : \"null_pointer_exception\",\r\n  1>               \"reason\" : null\r\n  1>             }\r\n  1>           }\r\n  1>         ]\r\n  1>       },\r\n  1>       \"hits\" : {\r\n  1>         \"total\" : 1,\r\n  1>         \"max_score\" : null,\r\n  1>         \"hits\" : [\r\n  1>           {\r\n  1>             \"_index\" : \"stored_index\",\r\n  1>             \"_type\" : \"test\",\r\n  1>             \"_id\" : \"AVt9TsgfS_0pphnPX_JH\",\r\n  1>             \"_score\" : null,\r\n  1>             \"fields\" : {\r\n  1>               \"script_painless\" : [\r\n  1>                 3.0\r\n  1>               ],\r\n  1>               \"script_expressions\" : [\r\n  1>                 3.0\r\n  1>               ]\r\n  1>             },\r\n  1>             \"sort\" : [\r\n  1>               3.0\r\n  1>             ]\r\n  1>           }\r\n  1>         ]\r\n  1>       }\r\n  1>     }\r\n  1>   }\r\n  1> }]\r\n```\r\n\r\n```\r\norg.elasticsearch.transport.RemoteTransportException: [wp5TNZy][127.0.0.1:42537][indices:data/read/search[phase/query]]\r\nCaused by: org.elasticsearch.search.query.QueryPhaseExecutionException: Query Failed [Failed to execute main query]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:414) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:108) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:246) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:260) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:331) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:328) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:627) [elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.lucene.index.DocValues.docsWithValue(DocValues.java:186) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.codecs.lucene54.Lucene54DocValuesProducer.getDocsWithField(Lucene54DocValuesProducer.java:1101) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.codecs.perfield.PerFieldDocValuesFormat$FieldsReader.getDocsWithField(PerFieldDocValuesFormat.java:341) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.CodecReader.getDocsWithField(CodecReader.java:184) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.FilterLeafReader.getDocsWithField(FilterLeafReader.java:472) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DocValues.getDocsWithField(DocValues.java:321) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.FieldComparator$NumericComparator.getDocsWithValue(FieldComparator.java:172) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.FieldComparator$NumericComparator.doSetNextReader(FieldComparator.java:155) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.SimpleFieldComparator.getLeafComparator(SimpleFieldComparator.java:36) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.FieldValueHitQueue.getComparators(FieldValueHitQueue.java:180) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.TopFieldCollector$SimpleFieldCollector.getLeafCollector(TopFieldCollector.java:100) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.FilterCollector.getLeafCollector(FilterCollector.java:40) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.elasticsearch.search.query.CancellableCollector.getLeafCollector(CancellableCollector.java:61) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:660) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:388) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:108) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:246) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:260) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:331) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:328) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:627) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.5.0-SNAPSHOT.jar:5.5.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) ~[?:1.8.0_121]\r\n```\r\n\r\nWhich is weird, because that NPE seems to be here:\r\n\r\n```java\r\n  public static Bits docsWithValue(final SortedNumericDocValues dv, final int maxDoc) {\r\n    return new Bits() {     // <---------- NPE\r\n      @Override\r\n      public boolean get(int index) {\r\n        dv.setDocument(index);\r\n        return dv.count() != 0;\r\n      }\r\n\r\n      @Override\r\n      public int length() {\r\n        return maxDoc;\r\n      }\r\n    };\r\n  }\r\n```\r\n\r\nAnd I'm not sure how that NPEs?  This was on Fedora 25 / Java 1.8.0_121, perhaps this another one of those flaky NPE cases?  Assigning to @jpountz because it appears to be most directly Lucene related, but /cc @jasontedor because of NPE and @jdconrad because of stored scripts :)","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}