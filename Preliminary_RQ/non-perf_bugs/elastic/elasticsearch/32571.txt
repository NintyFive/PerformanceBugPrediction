{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32571","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32571/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32571/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32571/events","html_url":"https://github.com/elastic/elasticsearch/issues/32571","id":346877939,"node_id":"MDU6SXNzdWUzNDY4Nzc5Mzk=","number":32571,"title":"Unknown license version found after failed upgrade to 6.4.0 staging, rollback to 6.3.2","user":{"login":"russcam","id":208231,"node_id":"MDQ6VXNlcjIwODIzMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/208231?v=4","gravatar_id":"","url":"https://api.github.com/users/russcam","html_url":"https://github.com/russcam","followers_url":"https://api.github.com/users/russcam/followers","following_url":"https://api.github.com/users/russcam/following{/other_user}","gists_url":"https://api.github.com/users/russcam/gists{/gist_id}","starred_url":"https://api.github.com/users/russcam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/russcam/subscriptions","organizations_url":"https://api.github.com/users/russcam/orgs","repos_url":"https://api.github.com/users/russcam/repos","events_url":"https://api.github.com/users/russcam/events{/privacy}","received_events_url":"https://api.github.com/users/russcam/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-02T06:35:41Z","updated_at":"2018-08-02T07:13:01Z","closed_at":"2018-08-02T07:08:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.0 MSI built from Staging zip distribution hash 26ea826c\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\njava version \"1.8.0_92\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_92-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.92-b14, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n```powershell\r\nGet-CimInstance Win32_OperatingSystem | Select-Object Caption, Version, ServicePackMajorVersion, OSArchitecture, CSName\r\n\r\nCaption                 : Microsoft Windows Server 2012 R2 Standard Evaluation\r\nVersion                 : 6.3.9600\r\nServicePackMajorVersion : 0\r\nOSArchitecture          : 64-bit\r\nCSName                  : VAGRANT-2012-R2\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe Windows Installer integration test scenario `SilentInstall-FailUpgrade` tests the failure scenario when upgrading from one version of Elasticsearch to another, using the MSI Windows Installer. The scenario first installs one version, asserts installation is good, then runs an upgrade to upgrade to a later version, deliberately failing the upgrade at the very end of the upgrade process. It then asserts that Elasticsearch has been successfully rolled back to the prior version, that the prior version Elasticsearch service is installed and that Elasticsearch is operable.\r\n\r\nWhen running this scenario with released MSI 6.3.2 version going to a 6.4.0 MSI built from Staging zip distribution hash 26ea826c, the 6.3.2 Elasticsearch service after the failed upgrade fails to start successfully. Checking the elasticsearch log file, the issue is\r\n\r\n```\r\n[2018-08-02T04:57:37,413][ERROR][o.e.g.GatewayMetaState   ] [VAGRANT-2012-R2] failed to read local state, exiting...\r\norg.elasticsearch.ElasticsearchException: java.io.IOException: failed to read [id:23, legacy:false, file:C:\\ProgramData\\Elastic\\Elasticsearch\\data\\nodes\\0\\_state\\global-23.st]\r\n    at org.elasticsearch.ExceptionsHelper.maybeThrowRuntimeAndSuppress(ExceptionsHelper.java:199) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:331) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.MetaStateService.loadGlobalState(MetaStateService.java:112) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.MetaStateService.loadFullState(MetaStateService.java:56) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.GatewayMetaState.<init>(GatewayMetaState.java:88) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.node.Node.<init>(Node.java:432) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.node.Node.<init>(Node.java:252) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:213) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:213) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:326) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:136) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:127) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124) [elasticsearch-cli-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cli.Command.main(Command.java:90) [elasticsearch-cli-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:93) [elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:86) [elasticsearch-6.3.2.jar:6.3.2]\r\nCaused by: java.io.IOException: failed to read [id:23, legacy:false, file:C:\\ProgramData\\Elastic\\Elasticsearch\\data\\nodes\\0\\_state\\global-23.st]\r\n    at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:325) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    ... 15 more\r\nCaused by: org.elasticsearch.ElasticsearchException: Unknown license version found, please upgrade all nodes to the latest elasticsearch-license plugin\r\n    at org.elasticsearch.license.License.fromXContent(License.java:482) ~[?:?]\r\n    at org.elasticsearch.license.LicensesMetaData.fromXContent(LicensesMetaData.java:132) ~[?:?]\r\n    at org.elasticsearch.common.xcontent.NamedXContentRegistry$Entry.lambda$new$0(NamedXContentRegistry.java:63) ~[elasticsearch-x-content-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.common.xcontent.NamedXContentRegistry.parseNamedObject(NamedXContentRegistry.java:141) ~[elasticsearch-x-content-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.common.xcontent.support.AbstractXContentParser.namedObject(AbstractXContentParser.java:433) ~[elasticsearch-x-content-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cluster.metadata.MetaData$Builder.fromXContent(MetaData.java:1177) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cluster.metadata.MetaData$1.fromXContent(MetaData.java:1220) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.cluster.metadata.MetaData$1.fromXContent(MetaData.java:1211) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.MetaDataStateFormat.read(MetaDataStateFormat.java:199) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:320) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n    ... 15 more\r\n```\r\n\r\nSpecifically,\r\n\r\n```\r\norg.elasticsearch.ElasticsearchException: Unknown license version found, please upgrade all nodes to the latest elasticsearch-license plugin\r\n```\r\n\r\nThe configuration file of 6.3.2 after failed upgrade is\r\n\r\n```\r\nbootstrap.memory_lock: false\r\ncluster.name: elasticsearch\r\nhttp.port: 9200\r\nnode.data: true\r\nnode.ingest: true\r\nnode.master: true\r\nnode.max_local_storage_nodes: 1\r\nnode.name: VAGRANT-2012-R2\r\npath.data: C:\\ProgramData\\Elastic\\Elasticsearch\\data\r\npath.logs: C:\\ProgramData\\Elastic\\Elasticsearch\\logs\r\ntransport.tcp.port: 9300\r\nxpack.license.self_generated.type: basic\r\nxpack.security.enabled: false\r\n```\r\n\r\nSince the integration test deliberatelys fail the upgrade _at the very end of the process_, Elasticsearch 6.4.0 Windows Service will have been installed and started, which may now changed the state of data state.\r\n\r\nWould it be expected that 6.3.2 would be able to successfully start after such events? When rolling back from a failed upgrade from 6.3.0 to versions prior to 6.3.x e.g. 6.2.4, I don't recall seeing this issue before.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Clone [`windows-installer` repo](https://github.com/elastic/windows-installers)\r\n 2. Checkout `fix/es-home-fresh-install` branch\r\n 3. Copy 6.4.0 elasticsearch zip distribution from staging build 26ea826c to the `build/in` directory in `windows-installer`\r\n4. Ensure vagrant and virtual box are installed.\r\n5. Ensure access to Windows Vagrant image `elastic/windows-2012_r2-x86_64`\r\n6. Run the following from the root of the repo\r\n\r\n    ```\r\n    .\\build.bat integrate es r:6.3.2,6.4.0 local *FailUpgrade* skiptests -nodestroy -gui\r\n    ```\r\n7. Observe 7 failing tests related to Elasticsearch service 6.3.2 version failing to start after the failed upgrade is rolled back.\r\n\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}