{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8881","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8881/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8881/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8881/events","html_url":"https://github.com/elastic/elasticsearch/issues/8881","id":51567958,"node_id":"MDU6SXNzdWU1MTU2Nzk1OA==","number":8881,"title":"Making ES more robust against \"corrupt\" nodes or node failures causing Master OOM","user":{"login":"bluelu","id":339893,"node_id":"MDQ6VXNlcjMzOTg5Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/339893?v=4","gravatar_id":"","url":"https://api.github.com/users/bluelu","html_url":"https://github.com/bluelu","followers_url":"https://api.github.com/users/bluelu/followers","following_url":"https://api.github.com/users/bluelu/following{/other_user}","gists_url":"https://api.github.com/users/bluelu/gists{/gist_id}","starred_url":"https://api.github.com/users/bluelu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluelu/subscriptions","organizations_url":"https://api.github.com/users/bluelu/orgs","repos_url":"https://api.github.com/users/bluelu/repos","events_url":"https://api.github.com/users/bluelu/events{/privacy}","received_events_url":"https://api.github.com/users/bluelu/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2014-12-10T15:04:23Z","updated_at":"2019-12-17T12:48:44Z","closed_at":"2015-03-02T10:11:35Z","author_association":"NONE","active_lock_reason":null,"body":"Our master node failed with an OOM last night.\n\nWe had one node which couldn't apply the cluster state and had this entry in the node log for each master update:\n\n```\n[2014-12-10 12:41:01,127][WARN ][cluster.service          ] [node] failed to apply updated cluster state:\n.. complete cluster state...\norg.elasticsearch.indices.IndexCreationException: [index] failed to create index\n        at org.elasticsearch.indices.InternalIndicesService.createIndex(InternalIndicesService.java:303)\n        at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyNewIndices(IndicesClusterStateService.java:310)\n        at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:179)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:431)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:153)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.NoClassDefFoundError: Could not initialize class org.elasticsearch.index.codec.docvaluesformat.DocValuesFormats\n        at org.elasticsearch.index.codec.CodecModule.configureDocValuesFormats(CodecModule.java:166)\n        at org.elasticsearch.index.codec.CodecModule.configure(CodecModule.java:179)\n        at org.elasticsearch.common.inject.AbstractModule.configure(AbstractModule.java:60)\n        at org.elasticsearch.common.inject.spi.Elements$RecordingBinder.install(Elements.java:204)\n        at org.elasticsearch.common.inject.spi.Elements.getElements(Elements.java:85)\n        at org.elasticsearch.common.inject.InjectorShell$Builder.build(InjectorShell.java:130)\n        at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:99)\n        at org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:131)\n        at org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:69)\n        at org.elasticsearch.indices.InternalIndicesService.createIndex(InternalIndicesService.java:299)\n        ... 7 more\n```\n\nI don't see any cluster state related exception in the master regarding the update on the cluster state, but other exceptions regarding that node: (might be unrelated):\n\n```\norg.elasticsearch.transport.RemoteTransportException: [node][inet[/node:9300]][internal:cluster/nodes/indices/shard/store[n]]\nCaused by: java.lang.NoClassDefFoundError: Could not initialize class org.apache.lucene.codecs.Codec\n        at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:356)\n        at org.apache.lucene.index.SegmentInfos$1.doBody(SegmentInfos.java:454)\n        at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:906)\n        at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:752)\n        at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:450)\n        at org.elasticsearch.common.lucene.Lucene.readSegmentInfos(Lucene.java:85)\n        at org.elasticsearch.index.store.Store.readSegmentsInfo(Store.java:124)\n        at org.elasticsearch.index.store.Store.access$400(Store.java:80)\n        at org.elasticsearch.index.store.Store$MetadataSnapshot.buildMetadata(Store.java:575)\n        at org.elasticsearch.index.store.Store$MetadataSnapshot.<init>(Store.java:568)\n        at org.elasticsearch.index.store.Store.readMetadataSnapshot(Store.java:317)\n        at org.elasticsearch.indices.store.TransportNodesListShardStoreMetaData.listStoreMetaData(TransportNodesListShardStoreMetaData.java:182)\n        at org.elasticsearch.indices.store.TransportNodesListShardStoreMetaData.nodeOperation(TransportNodesListShardStoreMetaData.java:138)\n        at org.elasticsearch.indices.store.TransportNodesListShardStoreMetaData.nodeOperation(TransportNodesListShardStoreMetaData.java:59)\n        at org.elasticsearch.action.support.nodes.TransportNodesOperationAction$NodeTransportHandler.messageReceived(TransportNodesOperationAction.java:278)\n        at org.elasticsearch.action.support.nodes.TransportNodesOperationAction$NodeTransportHandler.messageReceived(TransportNodesOperationAction.java:269)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.run(MessageChannelHandler.java:275)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n```\n\nI haven't looked at the heapdump of the master node (If needed I can have a look), but I suspect that due to the failed cluster the connection buffer will just grow until there is no space left.\n\nIt turned out the node had a corrupt jar, restarting didn't help and caused the heap to grow, and we had to reploy in order to fix it. Killing the node reduced the heap of the master node again.\n\nWe will add this to our monitoring so it won't appear again.\n\nStill an ES fix (e.g. triggering node restart, shutdown on node, or reducing the max buffer for the connection would be great) making it more robust against such failures would be great.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}