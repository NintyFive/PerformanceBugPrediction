{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43830","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43830/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43830/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43830/events","html_url":"https://github.com/elastic/elasticsearch/issues/43830","id":462792320,"node_id":"MDU6SXNzdWU0NjI3OTIzMjA=","number":43830,"title":"[ML] Possible corrupt write to the normalizer process","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-07-01T15:57:09Z","updated_at":"2020-04-02T12:15:34Z","closed_at":"2020-04-02T12:15:34Z","author_association":"MEMBER","active_lock_reason":null,"body":"Reported for version 6.7.1, these errors were logged.\r\n\r\n```\r\n[2019-06-21T02:52:00,586][ERROR][CLengthEncodedInputParser.cc@169] Parsed field length 808333362 is suspiciously large - assuming corrupt input stream\r\n[2019-06-21T02:52:00,586][ERROR][CLengthEncodedInputParser.cc@56] Failed to parse length encoded header from stream\r\n[2019-06-21T02:52:00,586][FATAL][Main.cc@133] Failed to handle input to be normalized\r\n[2019-06-21T02:52:00,588][ERROR][CLengthEncodedInputParser.cc@147] Incorrect number of fields in input stream record: expected 9 but got 0\r\n[2019-06-21T02:52:00,588][ERROR][CLengthEncodedInputParser.cc@82] Failed to parse length encoded data record from stream\r\n[2019-06-21T02:52:00,588][FATAL][Main.cc@133] Failed to handle input to be normalized\r\n```\r\n\r\nThe corruption could have been caused by an OS level error with the named pipe or it could be that 2 threads were writing to the named pipe at the same time. There is some evidence to support the later as elsewhere in the file the following was reported \r\n\r\n```\r\n[2019-06-20T11:27:01,130][ERROR][CNamedPipeFactory.cc@206] Unable to create named pipe /tmp/elasticsearch-3389134197385528191/normalize_mljob-XXX: File exists\r\n```\r\n\r\nThe error comes [after mkfifo](https://github.com/elastic/ml-cpp/blob/4dd90fa93338667b681364657222715f81c9868a/lib/core/CNamedPipeFactory.cc#L204) which is called when `lstat` fails as it is expected to do because the file should not exist. `lstat` may have failed for a different reason - e.g. no execute permission - or the file is created between the calls to `lstat` and `mkfifo` suggesting 2 normalize processes are at work. Note the named pipe file names are based on the job Id so different processes would create the same file for the same job and from the java side 2 threads could write to the same pipe. \r\n\r\nHowever, `ShortCircuitingRenormalizer` has a semaphore protecting against concurrent invocations of `doRenormalizations` and I cannot see a way that a job could have 2 normalize processes. \r\n","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}