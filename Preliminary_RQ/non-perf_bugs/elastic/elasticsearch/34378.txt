{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34378","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34378/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34378/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34378/events","html_url":"https://github.com/elastic/elasticsearch/issues/34378","id":368614145,"node_id":"MDU6SXNzdWUzNjg2MTQxNDU=","number":34378,"title":"Completion suggester returns mangled documents","user":{"login":"hofrob","id":1058012,"node_id":"MDQ6VXNlcjEwNTgwMTI=","avatar_url":"https://avatars0.githubusercontent.com/u/1058012?v=4","gravatar_id":"","url":"https://api.github.com/users/hofrob","html_url":"https://github.com/hofrob","followers_url":"https://api.github.com/users/hofrob/followers","following_url":"https://api.github.com/users/hofrob/following{/other_user}","gists_url":"https://api.github.com/users/hofrob/gists{/gist_id}","starred_url":"https://api.github.com/users/hofrob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hofrob/subscriptions","organizations_url":"https://api.github.com/users/hofrob/orgs","repos_url":"https://api.github.com/users/hofrob/repos","events_url":"https://api.github.com/users/hofrob/events{/privacy}","received_events_url":"https://api.github.com/users/hofrob/received_events","type":"User","site_admin":false},"labels":[{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-10-10T11:10:37Z","updated_at":"2018-10-19T17:46:56Z","closed_at":"2018-10-19T17:46:56Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: docker.elastic.co/elasticsearch/elasticsearch:6.3.2\r\n\r\n**Kibana**: docker.elastic.co/kibana/kibana:6.3.2\r\n\r\n**Plugins installed**: none\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n1. create index for completion suggest\r\n1. Put 3 documents with a custom ID in the index\r\n1. search the index for a word contained in 2 of the documents\r\n1. get 2 mangled results (field text does not belong to source)\r\n\r\n**Steps to reproduce**:\r\n\r\nThis is *terribly* hard to reproduce. Just anonymising the data but still trying to reproduce this bug was almost impossible. If you change one little thing, it's not reproducable. So maybe this helps in finding the cause of this. If we are doing something wrong, please tell us, we're on our wits end.\r\n\r\nRemoving the ID works in this specific case, but it does not solve the issue completely. The bug would still pop up in our system with different documents.\r\n\r\ncopy paste from kibana:\r\n\r\n```\r\nDELETE test_suggest\r\n\r\nPUT test_suggest\r\n{\r\n  \"mappings\": {\r\n    \"something\": {\r\n      \"properties\": {\r\n        \"what_suggest\":   {\r\n          \"type\":             \"completion\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test_suggest/something/profile_284\r\n{\r\n  \"id\":             \"profile_284\",\r\n  \"term\":           \"ab abcdefghij klmnopq\",\r\n  \"where_suggest\":  [],\r\n  \"street_suggest\": [],\r\n  \"what_suggest\":   [\r\n    {\r\n      \"input\":  \"abcdefghij klmnopq\",\r\n      \"weight\": 3\r\n    }\r\n  ],\r\n  \"value\":          \"ab abcdefghij klmnopq\"\r\n}\r\n\r\nPUT test_suggest/something/profile_285\r\n{\r\n  \"id\":             \"profile_285\",\r\n  \"term\":           \"dr zyxwvu wrong abcdef\",\r\n  \"where_suggest\":  [],\r\n  \"street_suggest\": [],\r\n  \"what_suggest\":   [\r\n    {\r\n      \"input\":  \"zyxwvu wrong\",\r\n      \"weight\": 3\r\n    }\r\n  ],\r\n  \"value\":          \"dr zyxwvu wrong abcdef\"\r\n}\r\n\r\n\r\nPUT test_suggest/something/profile_286\r\n{\r\n  \"id\":             \"profile_286\",\r\n  \"term\":           \"abcd efg hi zyxwvu abcdefgh\",\r\n  \"where_suggest\":  [],\r\n  \"street_suggest\": [],\r\n  \"what_suggest\":   [\r\n    {\r\n      \"input\":  \"zyxwvu abcdefgh\",\r\n      \"weight\": 3\r\n    }\r\n  ],\r\n  \"value\":          \"abcd efg hi zyxwvu abcdefgh\"\r\n}\r\n\r\n\r\nPOST test_suggest/something/_search\r\n{\r\n  \"size\":    20,\r\n  \"suggest\": {\r\n    \"test_suggest\": {\r\n      \"prefix\":     \"zyxwvu\",\r\n      \"completion\": {\r\n        \"field\": \"what_suggest\",\r\n        \"size\":  10,\r\n        \"fuzzy\": {\r\n          \"fuzziness\": 0\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## result of the search:\r\n\r\nThe document in `_source` does not match the value in the field `text`\r\n\r\n```json\r\n{\r\n  \"took\": 4,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"suggest\": {\r\n    \"test_suggest\": [\r\n      {\r\n        \"text\": \"zyxwvu\",\r\n        \"offset\": 0,\r\n        \"length\": 6,\r\n        \"options\": [\r\n          {\r\n            \"text\": \"zyxwvu abcdefgh\",\r\n            \"_index\": \"test_suggest\",\r\n            \"_type\": \"something\",\r\n            \"_id\": \"profile_285\",\r\n            \"_score\": 18,\r\n            \"_source\": {\r\n              \"id\": \"profile_285\",\r\n              \"term\": \"dr zyxwvu wrong abcdef\",\r\n              \"where_suggest\": [],\r\n              \"street_suggest\": [],\r\n              \"what_suggest\": [\r\n                {\r\n                  \"input\": \"zyxwvu wrong\",\r\n                  \"weight\": 3\r\n                }\r\n              ],\r\n              \"value\": \"dr zyxwvu wrong abcdef\"\r\n            }\r\n          },\r\n          {\r\n            \"text\": \"zyxwvu wrong\",\r\n            \"_index\": \"test_suggest\",\r\n            \"_type\": \"something\",\r\n            \"_id\": \"profile_286\",\r\n            \"_score\": 18,\r\n            \"_source\": {\r\n              \"id\": \"profile_286\",\r\n              \"term\": \"abcd efg hi zyxwvu abcdefgh\",\r\n              \"where_suggest\": [],\r\n              \"street_suggest\": [],\r\n              \"what_suggest\": [\r\n                {\r\n                  \"input\": \"zyxwvu abcdefgh\",\r\n                  \"weight\": 3\r\n                }\r\n              ],\r\n              \"value\": \"abcd efg hi zyxwvu abcdefgh\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}