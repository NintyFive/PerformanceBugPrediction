{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55199","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55199/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55199/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55199/events","html_url":"https://github.com/elastic/elasticsearch/issues/55199","id":600034404,"node_id":"MDU6SXNzdWU2MDAwMzQ0MDQ=","number":55199,"title":"SLM Retention Task Always Fails in some Situations","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-04-15T05:37:02Z","updated_at":"2020-08-31T10:51:50Z","closed_at":"2020-08-31T10:51:50Z","author_association":"MEMBER","active_lock_reason":null,"body":"There is a problem with the way the SLM retention task waits for snapshots to complete before running its delete. The following situation appears to never result in the retention task running:\r\n\r\n1. Schedule a snapshot ever day at midnight.\r\n2. Schedule the retention task to run at e.g. 0:10 every day and allow it a maximum runtime of 1h (`slm.retention_duration`).\r\n\r\nNow if our nightly snapshot takes more than 1:10, the retention task will simply time out waiting for the snapshot every time and never execute, leading to a boundless growth in the number of snapshots in the repository.\r\n\r\nRelated issues here: \r\n\r\n1. We are not correctly using the cluster state observer. Instead of using a predicate for the cluster state we want (without snapshots in progress), we keep re-adding it. This means the timeout only comes into play when there are no cluster state updates. With cluster state update batching, we can get into some strange situations here where back to back snapshots result in the observer never executing and being re-added forever.\r\n2. The timeout exception is simply thrown on the CS thread without being caught (which would fail if we had tests). (also it has a typo in it) see https://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java#L537\r\n\r\nThis is actually seen in the wild repeatedly.\r\n```\r\n[instance-0000000051] uncaught exception in thread [elasticsearch[instance-0000000051][generic][T#151]]\r\norg.elasticsearch.ElasticsearchException: java.lang.IllegalStateException: slm retention snapshot deletion out while waiting for ongoing snapshot operations to complete\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask.lambda$maybeDeleteSnapshots$15(SnapshotRetentionTask.java:328) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask$NoSnapshotRunningListener.onTimeout(SnapshotRetentionTask.java:516) ~[?:?]\r\n\tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:325) ~[elasticsearch-7.6.1.jar:7.6.1]\r\n\tat org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:252) ~[elasticsearch-7.6.1.jar:7.6.1]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:598) ~[elasticsearch-7.6.1.jar:7.6.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:633) ~[elasticsearch-7.6.1.jar:7.6.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:830) [?:?]\r\nCaused by: java.lang.IllegalStateException: slm retention snapshot deletion out while waiting for ongoing snapshot operations to complete\r\n\t... 8 more\r\n```\r\n\r\n3. We waste a generic pool thread during the waiting for the snapshot to delete. See https://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java#L347","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}