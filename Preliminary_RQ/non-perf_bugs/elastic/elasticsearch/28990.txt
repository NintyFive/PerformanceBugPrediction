{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28990","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28990/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28990/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28990/events","html_url":"https://github.com/elastic/elasticsearch/issues/28990","id":304314863,"node_id":"MDU6SXNzdWUzMDQzMTQ4NjM=","number":28990,"title":"Script type inference fault when use Update(with script) Rest API","user":{"login":"nezhazheng","id":1982475,"node_id":"MDQ6VXNlcjE5ODI0NzU=","avatar_url":"https://avatars3.githubusercontent.com/u/1982475?v=4","gravatar_id":"","url":"https://api.github.com/users/nezhazheng","html_url":"https://github.com/nezhazheng","followers_url":"https://api.github.com/users/nezhazheng/followers","following_url":"https://api.github.com/users/nezhazheng/following{/other_user}","gists_url":"https://api.github.com/users/nezhazheng/gists{/gist_id}","starred_url":"https://api.github.com/users/nezhazheng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nezhazheng/subscriptions","organizations_url":"https://api.github.com/users/nezhazheng/orgs","repos_url":"https://api.github.com/users/nezhazheng/repos","events_url":"https://api.github.com/users/nezhazheng/events{/privacy}","received_events_url":"https://api.github.com/users/nezhazheng/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-03-12T10:27:10Z","updated_at":"2018-03-13T19:15:58Z","closed_at":"2018-03-13T19:15:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** 2.3.1 (affected almost all version. I tested 5.x 6.x)\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_20\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nFirst of all we already have a doc mapping that include a long field. And we try to update the field with script like ctx._source.longField += longField.\r\nexpected:\r\n2000000000 + 2000000000 = 4000000000\r\nactual:\r\n2000000000 + 2000000000 = -294967296\r\n\r\n**Mapping snippet:**\r\n{\r\n          \"longField\": {\r\n            \"mapping\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"match\": \"longField\"\r\n          }\r\n }\r\n\r\n**Steps to reproduce**:\r\n 1. Post a doc that include a long field that the length is int like below.\r\ncurl .../_update -d '{\"script\":{\"inline\":\"ctx._source.longField += longField\",\"params\":{\"longField\":2000000000}},\"upsert\":{\"id\":\"xxx\",\"word\":\"a\",\"longField\":2000000000}}'\r\n\r\n 2. Do above step again.\r\n\r\nI think the root cause that is when do update es will convert the exists doc to map but with out mapping. The json library will inference the number type just based on the length of the number. \r\nThen the long field maybe lose it type.\r\n","closed_by":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}