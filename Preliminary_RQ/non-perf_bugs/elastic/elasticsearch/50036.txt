{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50036","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50036/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50036/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50036/events","html_url":"https://github.com/elastic/elasticsearch/issues/50036","id":535791323,"node_id":"MDU6SXNzdWU1MzU3OTEzMjM=","number":50036,"title":"NullPointerException in IntervalQueryBuilder.toString()","user":{"login":"prasad2kin","id":16960235,"node_id":"MDQ6VXNlcjE2OTYwMjM1","avatar_url":"https://avatars3.githubusercontent.com/u/16960235?v=4","gravatar_id":"","url":"https://api.github.com/users/prasad2kin","html_url":"https://github.com/prasad2kin","followers_url":"https://api.github.com/users/prasad2kin/followers","following_url":"https://api.github.com/users/prasad2kin/following{/other_user}","gists_url":"https://api.github.com/users/prasad2kin/gists{/gist_id}","starred_url":"https://api.github.com/users/prasad2kin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prasad2kin/subscriptions","organizations_url":"https://api.github.com/users/prasad2kin/orgs","repos_url":"https://api.github.com/users/prasad2kin/repos","events_url":"https://api.github.com/users/prasad2kin/events{/privacy}","received_events_url":"https://api.github.com/users/prasad2kin/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-12-10T15:08:58Z","updated_at":"2019-12-10T16:43:59Z","closed_at":"2019-12-10T16:43:59Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): Version: 7.3.2, Build: oss/tar/1c1faf1/2019-09-06T14:40:30.409026Z, JVM: 1.8.0_162\r\n\r\n**Plugins installed**: All defaults i.e [aggs-matrix-stats, analysis-common, ingest-common, ingest-geoip, ingest-user-agent, lang-expression, lang-mustache, lang-painless, mapper-extras, parent-join, percolator, rank-eval, reindex, repository-url, transport-netty4, advanced-scripts-plugin, analysis-kuromoji, analysis-smartcn]\r\n\r\n**JVM version** (`java -version`): 1.8.0_162\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 18.04 \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nA NullPointerException is thrown when toString() method is called on an instance of IntervalQueryBuilder.\r\n\r\n**Steps to reproduce**:\r\nCreate the following query using the Java code as follows:\r\n```\r\n{\r\n\t\"intervals\": {\r\n\t\t\"test\": {\r\n\t\t\t\"all_of\": {\r\n\t\t\t\t\"intervals\": [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"match\": {\r\n\t\t\t\t\t\t\t\"query\": \"audio\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t\"match\": {\r\n\t\t\t\t\t\t\t\"query\": \"method\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t],\r\n\t\t\t\t\"filter\": {\r\n\t\t\t\t\t\"script\": {\r\n\t\t\t\t\t\t\"source\": \"interval.gaps > distance\",\r\n\t\t\t\t\t\t\"params\": {\r\n\t\t\t\t\t\t\t\"distance\": 2\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\nUse the java code as follows:\r\n```\r\n    private IntervalsSourceProvider createSource(int distance){\r\n        try {\r\n            XContentBuilder xb = jsonBuilder()\r\n                            .startObject()\r\n                                .startObject(\"all_of\")\r\n                                    .startArray(\"intervals\")\r\n                                        .startObject()\r\n                                            .startObject(\"match\")\r\n                                                .field(\"query\", \"audio\")\r\n                                            .endObject()\r\n                                        .endObject()\r\n                                        .startObject()\r\n                                        .startObject(\"match\")\r\n                                        .field(\"query\", \"method\")\r\n                                        .endObject()\r\n                                        .endObject()\r\n                                    .endArray()\r\n                                    .startObject(\"filter\")\r\n                                        .startObject(\"script\")\r\n                                            .field(\"source\", \"interval.gaps > distance\")\r\n                                            .startObject(\"params\")\r\n                                                .field(\"distance\", distance)\r\n                                            .endObject()\r\n                                        .endObject()\r\n                                    .endObject()\r\n                                .endObject()\r\n                            .endObject();\r\n            try(XContentParser parser = XContentFactory.xContent(XContentType.JSON)\r\n                    .createParser(NamedXContentRegistry.EMPTY,\r\n                            DeprecationHandler.THROW_UNSUPPORTED_OPERATION, BytesReference.bytes(xb).streamInput())) {\r\n\r\n                parser.nextToken(); // advance past the first starting object\r\n                parser.nextToken();\r\n                IntervalsSourceProvider is = IntervalsSourceProvider.fromXContent(parser);\r\n                System.out.println((new IntervalQueryBuilder(\"test\", is)).toString());\r\n                return is;\r\n            }\r\n        } catch (IOException e) {\r\n            e.printStackTrace();\r\n        }\r\n        return null;\r\n    }\r\n```\r\nYou will see NPE during `System.out.println((new IntervalQueryBuilder(\"test\", is)).toString());`\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\nexception java.lang.NullPointerException\r\n\tat org.elasticsearch.index.query.IntervalsSourceProvider$IntervalFilter.toXContent(IntervalsSourceProvider.java:777)\r\n\tat org.elasticsearch.common.xcontent.XContentBuilder.value(XContentBuilder.java:857)\r\n\tat org.elasticsearch.common.xcontent.XContentBuilder.value(XContentBuilder.java:850)\r\n\tat org.elasticsearch.common.xcontent.XContentBuilder.field(XContentBuilder.java:842)\r\n\tat org.elasticsearch.index.query.IntervalsSourceProvider$Combine.toXContent(IntervalsSourceProvider.java:422)\r\n\tat org.elasticsearch.index.query.IntervalQueryBuilder.doXContent(IntervalQueryBuilder.java:69)\r\n\tat org.elasticsearch.index.query.AbstractQueryBuilder.toXContent(AbstractQueryBuilder.java:83)\r\n\tat org.elasticsearch.common.Strings.toString(Strings.java:778)\r\n\tat org.elasticsearch.index.query.AbstractQueryBuilder.toString(AbstractQueryBuilder.java:363)\r\n\r\n```\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}