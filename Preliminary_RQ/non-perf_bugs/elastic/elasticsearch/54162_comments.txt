[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603765240","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-603765240","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":603765240,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzc2NTI0MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T10:33:56Z","updated_at":"2020-03-25T10:33:56Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603797348","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-603797348","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":603797348,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzc5NzM0OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T11:51:44Z","updated_at":"2020-03-25T11:51:44Z","author_association":"CONTRIBUTOR","body":"1. https://gradle-enterprise.elastic.co/s/zzidgoauwly4c is `Timed out waiting for the ML templates to be installed`\r\n2. https://gradle-enterprise.elastic.co/s/5grsxebyw367a is `Error creating ML annotations index or aliases: org.elasticsearch.index.IndexNotFoundException: no such index [.ml-annotations-6]`\r\n3. https://gradle-enterprise.elastic.co/s/y7jxn5r7z64gg/ is a `java.util.NoSuchElementException` from https://github.com/elastic/elasticsearch/blob/23943aeb398447492263d5c7a2bf32f5d5d09899/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/TooManyJobsIT.java#L38","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603825755","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-603825755","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":603825755,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzgyNTc1NQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T13:02:08Z","updated_at":"2020-03-25T13:02:08Z","author_association":"MEMBER","body":"The telling stack trace is in the console log\r\n```\r\n\r\n2> java.util.concurrent.ExecutionException: java.util.NoSuchElementException |  \r\n-- | --\r\n  | at __randomizedtesting.SeedInfo.seed([8417034E9E7F8197:BA3760508E9D6C8C]:0) |  \r\n  | at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:266) |  \r\n  | at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:253) |  \r\n  | at org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87) |  \r\n  | at org.elasticsearch.xpack.ml.integration.TooManyJobsIT.testCloseFailedJob(TooManyJobsIT.java:38) |  \r\n  |   |  \r\n  | Caused by: |  \r\n  | java.util.NoSuchElementException |  \r\n  | at com.carrotsearch.hppc.AbstractIterator.next(AbstractIterator.java:41) |  \r\n  | at org.elasticsearch.xpack.ml.job.persistence.JobResultsProvider.lambda$getLatestIndexMappingsAndAddTerms$4(JobResultsProvider.java:337) |  \r\n  | at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) |  \r\n  | at org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) |  \r\n  | at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:70) |  \r\n  | at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:64) |  \r\n  | at org.elasticsearch.action.ActionListener$2.onResponse(ActionListener.java:89) |  \r\n  | at org.elasticsearch.action.admin.indices.mapping.get.TransportGetMappingsAction.doMasterOperation(TransportGetMappingsAction.java:81) |  \r\n  | at org.elasticsearch.action.admin.indices.mapping.get.TransportGetMappingsAction.doMasterOperation(TransportGetMappingsAction.java:42) |  \r\n  | at org.elasticsearch.action.support.master.info.TransportClusterInfoAction.masterOperation(TransportClusterInfoAction.java:51) |  \r\n  | at org.elasticsearch.action.support.master.info.TransportClusterInfoAction.masterOperation(TransportClusterInfoAction.java:33) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:99) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.lambda$doStart$3(TransportMasterNodeAction.java:170) |  \r\n  | at org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) |  \r\n  | at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) |  \r\n  | at org.elasticsearch.common.util.concurrent.EsExecutors$DirectExecutorService.execute(EsExecutors.java:225) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.doStart(TransportMasterNodeAction.java:170) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.start(TransportMasterNodeAction.java:133) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:110) |  \r\n  | at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:59) |  \r\n  | at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:153) |  \r\n  | at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:129) |  \r\n  | at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:64) |  \r\n  | at org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83) |  \r\n  | at org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72) |  \r\n  | at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:396) |  \r\n  | at org.elasticsearch.client.support.AbstractClient$IndicesAdmin.execute(AbstractClient.java:1231) |  \r\n  | at org.elasticsearch.client.support.AbstractClient$IndicesAdmin.getMappings(AbstractClient.java:1437) |  \r\n  | at org.elasticsearch.xpack.core.ClientHelper.executeAsyncWithOrigin(ClientHelper.java:76) |  \r\n  | at org.elasticsearch.xpack.ml.job.persistence.JobResultsProvider.getLatestIndexMappingsAndAddTerms(JobResultsProvider.java:344) |  \r\n  | at org.elasticsearch.xpack.ml.job.persistence.JobResultsProvider.lambda$createJobResultIndex$2(JobResultsProvider.java:311) |  \r\n  | at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) |  \r\n  | at org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) |  \r\n  | at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:70) |  \r\n  | at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:64) |  \r\n  | at org.elasticsearch.action.ActionListener$2.onResponse(ActionListener.java:89) |  \r\n  | at org.elasticsearch.action.ActionListener$4.onResponse(ActionListener.java:163) |  \r\n  | at org.elasticsearch.cluster.metadata.MetaDataCreateIndexService.lambda$createIndex$2(MetaDataCreateIndexService.java:275) |  \r\n  | at org.elasticsearch.action.support.ActiveShardsObserver$1.onNewClusterState(ActiveShardsObserver.java:84) |  \r\n  | at org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onNewClusterState(ClusterStateObserver.java:311) |  \r\n  | at org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.clusterChanged(ClusterStateObserver.java:196) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService.lambda$callClusterStateListeners$6(ClusterApplierService.java:527) |  \r\n  | at java.util.concurrent.ConcurrentHashMap$KeySpliterator.forEachRemaining(ConcurrentHashMap.java:3527) |  \r\n  | at java.util.stream.Streams$ConcatSpliterator.forEachRemaining(Streams.java:743) |  \r\n  | at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService.callClusterStateListeners(ClusterApplierService.java:523) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService.applyChanges(ClusterApplierService.java:498) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService.runTask(ClusterApplierService.java:432) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService.access$100(ClusterApplierService.java:73) |  \r\n  | at org.elasticsearch.cluster.service.ClusterApplierService$UpdateTask.run(ClusterApplierService.java:176) |  \r\n  | at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:693) |  \r\n  | at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:252) |  \r\n  | at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:215) |  \r\n  | at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) |  \r\n  | at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) |  \r\n  | at java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe exception is thrown here because GetMappings returned an empty index mapping. https://github.com/elastic/elasticsearch/blob/ec13c093df44a5b5ad92dcc2c0742709722b9d62/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java#L337 \r\n\r\nThe function is called by an action listener in response to the `.ml-anomalies-X` index being created, this code adds extra mappings to the index after it was created from a template.\r\n\r\nWhat is nice is the single node in the test is a master node and `TransportGetMappingsAction` executes in the calling thread so we seen the full stack trace from `MetaDataCreateIndexService` responding to creating the index to the call to `TransportGetMappingsAction` via the `NodeClient` to the empty index mapping being iterated.\r\n\r\nCould it be the index was created without any mappings?\r\n\r\nFrom the log file \r\n```1> [2020-03-20T11:42:23,587][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_t1] [.ml-anomalies-shared] creating index, cause [api], templates [], shards [1]/[1], mappings []```\r\n\r\nNote the empty mappings, compare with \r\n\r\n```1> [2020-03-20T11:42:23,702][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_t1] [.ml-annotations-6] creating index, cause [api], templates [], shards [1]/[1], mappings [_doc]```\r\n\r\nwhich has a mapping for `_doc`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603838653","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-603838653","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":603838653,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzgzODY1Mw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T13:27:35Z","updated_at":"2020-03-25T13:27:35Z","author_association":"CONTRIBUTOR","body":"So all three failures are in some way related to templates even though the final error that causes failure is different in each.\r\n\r\nGiven that this problem is happening on 7.x but not 7.6, it is probably related to the changes of #51765.  If so it will be a problem in 7.7 as well.  Before 7.7 GA we need to assess whether it's purely a test setup problem or whether it's a problem that could affect users too.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603904485","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-603904485","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":603904485,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzkwNDQ4NQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T15:25:17Z","updated_at":"2020-03-25T15:25:17Z","author_association":"MEMBER","body":"The problem is in the test, it may have been exposed by #51765 or another change.\r\n\r\nThe test waits for the templates to be installed in a `@ Before` method but then the cluster is resized in `startMlCluster(int, int)`\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/23943aeb398447492263d5c7a2bf32f5d5d09899/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/TooManyJobsIT.java#L203\r\n\r\nIn some cases the master node changes and the new master is a brand new node that does not yet have the templates installed. We don't wait for templates on the new master.\r\n\r\nI don't know why this wasn't an issue before, everything fails in CI eventually but I haven't seen this before. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/609752011","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-609752011","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":609752011,"node_id":"MDEyOklzc3VlQ29tbWVudDYwOTc1MjAxMQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-04-06T12:02:49Z","updated_at":"2020-04-06T12:02:49Z","author_association":"MEMBER","body":"I pushed a fix to wait on the ml templates in the newly formed cluster in #54162 and the test is unmuted in the backport #54801 \r\n\r\nLeaving this issue open for now as I am not certain the fix addresses the root cause","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/654755446","html_url":"https://github.com/elastic/elasticsearch/issues/54162#issuecomment-654755446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54162","id":654755446,"node_id":"MDEyOklzc3VlQ29tbWVudDY1NDc1NTQ0Ng==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-07T10:22:17Z","updated_at":"2020-07-07T10:22:17Z","author_association":"CONTRIBUTOR","body":"Closing this since a fix was made and it hasn't been updated since then with more failures.","performed_via_github_app":null}]