[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232165156","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232165156","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232165156,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE2NTE1Ng==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T20:12:08Z","updated_at":"2016-07-12T20:12:08Z","author_association":"MEMBER","body":"I believe this may be related to https://github.com/elastic/elasticsearch/issues/18572 , which is resolved in 2.4.0 by https://github.com/elastic/elasticsearch/pull/18975\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232186135","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232186135","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232186135,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE4NjEzNQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T21:24:11Z","updated_at":"2016-07-12T21:24:11Z","author_association":"CONTRIBUTOR","body":"Its more than that though. Don't compile a new unique script with each request!!! Use `params` !!!!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232193733","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232193733","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232193733,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5MzczMw==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T21:54:32Z","updated_at":"2016-07-12T21:54:32Z","author_association":"CONTRIBUTOR","body":"users that do this, will continue to hit problems, including jvm crapping out with stuff like https://bugs.openjdk.java.net/browse/JDK-8023191\n\nseriously, the root cause is that the scripting api encourages users to send a new unique script with each request. one _symptom_ was that es had a leak of those tons of generated classes. another symptom, will be that the jdk has a code cache leak, not fixed until java 9. Other symptoms will be slow performance, due to compiler thread pressure and other problems.\n\nBut we should address the root cause: there needs to be documentation, limits, something to prevent the anti-pattern.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232195473","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232195473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232195473,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NTQ3Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:01:55Z","updated_at":"2016-07-12T22:01:55Z","author_association":"MEMBER","body":"Relates #8632\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232195574","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232195574","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232195574,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NTU3NA==","user":{"login":"bogdanovich","id":5257258,"node_id":"MDQ6VXNlcjUyNTcyNTg=","avatar_url":"https://avatars1.githubusercontent.com/u/5257258?v=4","gravatar_id":"","url":"https://api.github.com/users/bogdanovich","html_url":"https://github.com/bogdanovich","followers_url":"https://api.github.com/users/bogdanovich/followers","following_url":"https://api.github.com/users/bogdanovich/following{/other_user}","gists_url":"https://api.github.com/users/bogdanovich/gists{/gist_id}","starred_url":"https://api.github.com/users/bogdanovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bogdanovich/subscriptions","organizations_url":"https://api.github.com/users/bogdanovich/orgs","repos_url":"https://api.github.com/users/bogdanovich/repos","events_url":"https://api.github.com/users/bogdanovich/events{/privacy}","received_events_url":"https://api.github.com/users/bogdanovich/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:02:18Z","updated_at":"2016-07-12T22:02:18Z","author_association":"NONE","body":"Would CMSClassUnloadingEnabled flag temporarily fix the problem?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232195607","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232195607","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232195607,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NTYwNw==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:02:27Z","updated_at":"2016-07-12T22:02:27Z","author_association":"CONTRIBUTOR","body":"no.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232196126","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232196126","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232196126,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NjEyNg==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:04:45Z","updated_at":"2016-07-12T22:04:45Z","author_association":"CONTRIBUTOR","body":"The way to prevent the problem, again, is not to send a new unique script with each request. Instead, let the script take parameters, such as `my_var`, whatever parts are changing for each request, and change those parameters via `params`. See https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html, there are examples doing this.\n\nThat means, your script will only be compiled once, and things will be much faster.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232196400","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232196400","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232196400,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NjQwMA==","user":{"login":"bogdanovich","id":5257258,"node_id":"MDQ6VXNlcjUyNTcyNTg=","avatar_url":"https://avatars1.githubusercontent.com/u/5257258?v=4","gravatar_id":"","url":"https://api.github.com/users/bogdanovich","html_url":"https://github.com/bogdanovich","followers_url":"https://api.github.com/users/bogdanovich/followers","following_url":"https://api.github.com/users/bogdanovich/following{/other_user}","gists_url":"https://api.github.com/users/bogdanovich/gists{/gist_id}","starred_url":"https://api.github.com/users/bogdanovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bogdanovich/subscriptions","organizations_url":"https://api.github.com/users/bogdanovich/orgs","repos_url":"https://api.github.com/users/bogdanovich/repos","events_url":"https://api.github.com/users/bogdanovich/events{/privacy}","received_events_url":"https://api.github.com/users/bogdanovich/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:06:01Z","updated_at":"2016-07-12T22:08:02Z","author_association":"NONE","body":"@rmuir Why then it was working fine for months in ES 1.4.4 ?\n\nPS. Thanks for clarifying the issue. We indeed use unique scripts every request and will fix that.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232197445","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232197445","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232197445,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjE5NzQ0NQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-12T22:10:40Z","updated_at":"2016-07-12T22:10:40Z","author_association":"CONTRIBUTOR","body":"Who knows, perhaps ES 1.4.4 didnt leak? Perhaps it leaked slower, because it used groovy without invokedynamic. Not particularly interesting to me.\n\nCMSClassUnloading is not relevant, you are using java 8, so its already on anyway by default. But CMS never stands a chance to collect the class, because of https://github.com/elastic/elasticsearch/issues/18572\n\nBut forget all about that too: because its going to cause all kinds of other problems for your jvm (see my links and comments above), besides being horribly slow. \n\nThat's why i'd rather us not pass around a bunch of aspirin trying to treat symptoms, but address the root cause, which is that its too easy to compile a brand new slightly-different script with each request. Obviously the api invites this (thats what happens when an API's efficiency relies on caching!), but that is hard to fix, so for now at least we should try to add some kind of system limit + documentation encouraging people to do it the fast way (using `params`).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232347137","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232347137","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232347137,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjM0NzEzNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T13:00:08Z","updated_at":"2016-07-13T13:00:08Z","author_association":"CONTRIBUTOR","body":"The docs for scripting have already been improved (see the `Prefer parameters` block on https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html)\n\nWe report the number of compilations and cache evictions in the node stats (`GET _nodes/stats/script`).\n\nThe only other thing I can think of doing is to add a [safeguard](https://github.com/elastic/elasticsearch/issues/11511) which limits the number of compilations per minute to e.g. 10\n\nDoes this sound reasonable?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232348534","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232348534","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232348534,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjM0ODUzNA==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T13:05:54Z","updated_at":"2016-07-13T13:05:54Z","author_association":"CONTRIBUTOR","body":"Can we make the `Prefer parameters` a linkable thing? This would help I think, to communicate the issue more easily/directly when it happens. The text is great.\n\nAs far as compilations safeguard, I have no idea how it should work, but i do think we need something? At least to catch the most extreme cases before the JVM goes belly-up.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232384731","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232384731","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232384731,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjM4NDczMQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T15:06:09Z","updated_at":"2016-07-13T15:06:09Z","author_association":"CONTRIBUTOR","body":"> Can we make the Prefer parameters a linkable thing? This would help I think, to communicate the issue more easily/directly when it happens. The text is great.\n\nSuccess! https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html#prefer-params\n\n> As far as compilations safeguard, I have no idea how it should work, but i do think we need something? At least to catch the most extreme cases before the JVM goes belly-up.\n\nIs it the frequency of compilations or just the total number of compilations causing the problem here?  If the former, then we could add some rate-limiting. If the latter, then the only way of resolving the issue would be to restart a node (which users have to do at the moment anyway).  Should we just be deferring this until 5.0 and Painless?  We're not going to make a breaking change in 2.x now.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232388120","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232388120","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232388120,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjM4ODEyMA==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T15:16:42Z","updated_at":"2016-07-13T15:16:42Z","author_association":"CONTRIBUTOR","body":"Thanks for making that link, I will use it.\n\n> Is it the frequency of compilations or just the total number of compilations causing the problem here? If the former, then we could add some rate-limiting. If the latter, then the only way of resolving the issue would be to restart a node (which users have to do at the moment anyway). Should we just be deferring this until 5.0 and Painless? We're not going to make a breaking change in 2.x now.\n\nAbsolutely we should defer, we don't need to rush anything in, I just want us to think about addressing it. \n\nMainly, I think we want to catch the anti-pattern where its a brand-new-script-per-request vs using params. It doesn't have to be a hard limit, it could be a warning in the logs at a start, i mean we should just try to do something. I think the way the caching works is very unintuitive.\n\nIn some cases, e.g. expressions, doing this might not be such of a problem. Expressions makes a tiny method without loops, and probably will never cause an issue, even with the java bugs. Expressions was actually discussed around the bug in question:\n\n```\nNo loops means no OSR compilation of that bytecode but if it's called\nmillions of times (based on what you said above) then it'll get compiled.\nIt may be that your bytecode generates really small nmethods (you mentioned\nit's simple algebraic expressions) and their generation naturally doesn't\noutpace code cache cleaning.\n```\n\nOn the other hand groovy is more complicated and heavy-duty. Features like groovy closures call out to reflection, in slow ways, and are heavy duty. You can see some of that stuff on the histogram on this issue.\n\nPainless? We don't know yet, someone should benchmark it. It uses java's lambda support, which is faster/more lightweight than groovy closures. Maybe its ok to compile jazillions: maybe its not.\n\nBut even if its \"ok\", it does not give the user good performance. It is faster to avoid doing this stuff on every request, always.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232465904","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232465904","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232465904,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjQ2NTkwNA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T19:47:23Z","updated_at":"2016-07-13T19:47:23Z","author_association":"MEMBER","body":"> As far as compilations safeguard, I have no idea how it should work, but i do think we need something? At least to catch the most extreme cases before the JVM goes belly-up.\n\nI have an idea for this for a \"rate-limiting\" circuit breaker, where we could limit script compilation to something like 10 a minute (or whatever limit) or throw a circuit breaking exception with a helpful message. Maybe that would help in this situation?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232478173","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232478173","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232478173,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjQ3ODE3Mw==","user":{"login":"bogdanovich","id":5257258,"node_id":"MDQ6VXNlcjUyNTcyNTg=","avatar_url":"https://avatars1.githubusercontent.com/u/5257258?v=4","gravatar_id":"","url":"https://api.github.com/users/bogdanovich","html_url":"https://github.com/bogdanovich","followers_url":"https://api.github.com/users/bogdanovich/followers","following_url":"https://api.github.com/users/bogdanovich/following{/other_user}","gists_url":"https://api.github.com/users/bogdanovich/gists{/gist_id}","starred_url":"https://api.github.com/users/bogdanovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bogdanovich/subscriptions","organizations_url":"https://api.github.com/users/bogdanovich/orgs","repos_url":"https://api.github.com/users/bogdanovich/repos","events_url":"https://api.github.com/users/bogdanovich/events{/privacy}","received_events_url":"https://api.github.com/users/bogdanovich/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T20:34:04Z","updated_at":"2016-07-13T20:36:49Z","author_association":"NONE","body":"@dakrone Someone could have 100 different scripts used in their app, and all of them could be compiled during first minute app is running . That would cause circuit beaker exception if it would be implemented the way you are suggesting.\n\nMaybe requests/compilations ratio could be helpful.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232482070","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232482070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232482070,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjQ4MjA3MA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-07-13T20:49:04Z","updated_at":"2016-07-13T20:49:04Z","author_association":"MEMBER","body":"> Someone could have 100 different scripts used in their app, and all of them could be compiled during first minute app is running . That would cause circuit beaker exception if it would be implemented the way you are suggesting.\n\nIt might be possible to thread a flag through for dynamic scripts versus disk-based scripts, so that disk-based scripts are exempt.\n\nStill, 100 different scripts seems like a lot! Once a user gets to that level they may want to restructure their data so they can avoid using scripting so much.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232903098","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232903098","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232903098,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkwMzA5OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T09:18:34Z","updated_at":"2016-07-15T09:18:34Z","author_association":"CONTRIBUTOR","body":"Proposal:  For inline scripts which have no `params` specified, apply a unique-compilations-per-minute limit (eg 10 per minute).  If the limit is breached, delay compilation by eg 1 second, and return a `Warning:` header with the response.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232911895","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232911895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232911895,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkxMTg5NQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T10:03:26Z","updated_at":"2016-07-15T10:03:26Z","author_association":"CONTRIBUTOR","body":"Wouldn't that just make things slower?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232923463","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232923463","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232923463,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkyMzQ2Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T11:03:18Z","updated_at":"2016-07-15T11:03:18Z","author_association":"CONTRIBUTOR","body":"Yes - that's the intention here.  To provide an incentive for users to not hardcode params (along with informing them why their query is slow).  The alternative is simply to throw an exception if the limit is breached.  Either way, limiting it to inline scripts without a params clause (even if no params are needed) limits the impact of this change I think\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232927009","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232927009","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232927009,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkyNzAwOQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T11:21:50Z","updated_at":"2016-07-15T11:21:50Z","author_association":"CONTRIBUTOR","body":"Well, my opinion: I want things to be fast, hence raising the whole discussion about the thing :)\n\nI'm concerned that this warning will not be noticed (which is ok), but then we will make things even slower.\n\nA lot of ES scripting is pretty damn slow, I'm not sure a 1 second delay is going to grab anyone's attention in the way we want.\n\nI think its ok to just log a warning in the system logs and send your warning header too? Just as a start: nothing risky, we are just trying to grab your attention.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232929307","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232929307","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232929307,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkyOTMwNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T11:33:03Z","updated_at":"2016-07-15T11:33:03Z","author_association":"CONTRIBUTOR","body":"Fair enough.  I have high hopes for these `Warning:` headers... just need to get them exposed in the clients\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232977763","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-232977763","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":232977763,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjk3Nzc2Mw==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T15:07:57Z","updated_at":"2016-07-15T15:07:57Z","author_association":"MEMBER","body":"I agree with @rmuir, I think delaying and returning a warning are likely to be ignored. I'm in favor of a hard limit, throw a helpful exception when it's exceeded that forces a user to take action, whether that action is increasing the breaker limit, or switching the way that scripts are sent.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234503830","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-234503830","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":234503830,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDUwMzgzMA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T09:54:19Z","updated_at":"2016-07-22T09:54:19Z","author_association":"CONTRIBUTOR","body":"@dakrone are you working on this? I removed discuss and added adopt me, feel free to change or assign\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234613160","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-234613160","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":234613160,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDYxMzE2MA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T18:00:47Z","updated_at":"2016-07-22T18:00:47Z","author_association":"MEMBER","body":"@s1monw I'm currently working on the breaker for buckets and the translog tool, but I'm planning to work on this after those are done. I'll leave this in \"adoptme\" until then in case someone wants to work on it before I get to it though.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/239810906","html_url":"https://github.com/elastic/elasticsearch/issues/19396#issuecomment-239810906","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19396","id":239810906,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTgxMDkwNg==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-08-15T14:08:30Z","updated_at":"2016-08-15T14:08:30Z","author_association":"CONTRIBUTOR","body":"I think this was solved in #19694 (targeting 5.0). It creates a breaker that'll trip and fail the request quickly if you attempt to compile too many inline scripts. The steady-state limit is 15 scripts a minute. It'll fail if you compile 16 scripts really, really fast but after four seconds it'll let another one through, then another after four seconds, etc. It just won't ever let more than 15 through at a time no matter how many you've \"save up\" by not compiling a script every four seconds.\n\nAnyway, that should make issues like this _super_ obvious.\n","performed_via_github_app":null}]