[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/547996043","html_url":"https://github.com/elastic/elasticsearch/issues/48701#issuecomment-547996043","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48701","id":547996043,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Nzk5NjA0Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-10-30T16:32:37Z","updated_at":"2019-10-30T16:32:37Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/Cluster Coordination)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/573596380","html_url":"https://github.com/elastic/elasticsearch/issues/48701#issuecomment-573596380","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48701","id":573596380,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MzU5NjM4MA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-01-13T10:27:51Z","updated_at":"2020-01-13T10:36:08Z","author_association":"CONTRIBUTOR","body":"I've checked performance of the new storage layer using an EC2 `r4.8xlarge` instance (which is used for dedicated master nodes).\r\n\r\nI've ran the following script:\r\n\r\n```\r\n#!/bin/bash\r\nset -euo pipefail\r\nIFS=$'\\n\\t'\r\n\r\nNUM_INDICES=100\r\nNUM_FIELDS=200\r\nNUM_ALL_INDEX_SETTING_UPDATES=10\r\nNUM_SINGLE_INDEX_SETTING_UPDATES=200\r\n\r\n#Â Start up elasticsearch using bin/elasticsearch -Epath.data=data1,data2,data3,data4 > /dev/null\r\n\r\n# Do not show output of curl commands unless they fail\r\nalias silentcurl='curl --silent --show-error --output /dev/null --fail'\r\n\r\n# Disable allocation and shard limit\r\nsilentcurl -X PUT \"localhost:9200/_cluster/settings?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"persistent\" : {\r\n        \"cluster.routing.allocation.enable\" : \"none\",\r\n        \"cluster.max_shards_per_node\" : \"99999999\"\r\n    }\r\n}\r\n'\r\n\r\n# Delete all indices\r\nsilentcurl -X DELETE \"localhost:9200/*\"\r\n\r\n# Create indices\r\ntime for ((i=1; i <= $NUM_INDICES; i++))\r\ndo\r\n  printf '% -25s (%s)\\r' \"Creating $NUM_INDICES indices:\" $i\r\n  seq 1 $NUM_FIELDS | \\\r\n  jq -R '.' | \\\r\n  jq -s '{mappings:{properties:(map({(\"field\"+.):{type:\"keyword\"}}) | add)}}' | \\\r\n  silentcurl -X PUT \"localhost:9200/index${i}?wait_for_active_shards=0&pretty\" -H 'Content-Type: application/json' -d @-\r\ndone\r\n\r\n# First test: benchmark updating setting on all 1000 indices\r\nprintf \"Updating an index setting $NUM_ALL_INDEX_SETTING_UPDATES times on all $NUM_INDICES indices:\"\r\ntime for ((i=1; i <= $NUM_ALL_INDEX_SETTING_UPDATES; i++))\r\ndo\r\n  silentcurl -X PUT \"localhost:9200/index*/_settings?pretty\" -H 'Content-Type: application/json' \\\r\n  -d \"{ \\\"index.refresh_interval\\\" : \\\"${i}s\\\" }\"\r\ndone\r\n\r\n# Reset setting after first test\r\nsilentcurl -X PUT \"localhost:9200/index*/_settings?pretty\" -H 'Content-Type: application/json' \\\r\n  -d \"{ \\\"index.refresh_interval\\\" : null }\"\r\n\r\n# Second test: benchmark updating setting on only one index\r\nprintf \"Updating an index setting $NUM_SINGLE_INDEX_SETTING_UPDATES times on the first index:\"\r\ntime for ((i=1; i <= $NUM_SINGLE_INDEX_SETTING_UPDATES; i++))\r\ndo\r\n  silentcurl -X PUT \"localhost:9200/index1/_settings?pretty\" -H 'Content-Type: application/json' \\\r\n  -d \"{ \\\"index.refresh_interval\\\" : \\\"${i}s\\\" }\"\r\ndone\r\n\r\n# Reset setting after second test\r\nsilentcurl -X PUT \"localhost:9200/index*/_settings?pretty\" -H 'Content-Type: application/json' \\\r\n  -d \"{ \\\"index.refresh_interval\\\" : null }\"\r\n\r\n# Check on-disk cluster state size\r\nprintf \"On-disk cluster state size\\n\"\r\ndu -h -d 1 data\r\n```\r\n\r\n# Results (always 2 runs shown)\r\n\r\n- `master` branch with single data path, 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t0m2.548s\r\nuser\t0m0.988s\r\nsys\t0m0.403s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m4.935s\r\nuser\t0m0.038s\r\nsys\t0m0.028s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m3.419s\r\nuser\t0m0.760s\r\nsys\t0m0.368s\r\nOn-disk cluster state size\r\n16K\tdata/_state\r\n408K\tdata/indices\r\n424K\tdata\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m1.795s\r\nuser\t0m1.005s\r\nsys\t0m0.350s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m4.477s\r\nuser\t0m0.046s\r\nsys\t0m0.019s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m3.225s\r\nuser\t0m0.788s\r\nsys\t0m0.333s\r\nOn-disk cluster state size\r\n20K\tdata/_state\r\n408K\tdata/indices\r\n428K\tdata\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with single data path, 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t0m3.449s\r\nuser\t0m1.059s\r\nsys\t0m0.340s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m2.467s\r\nuser\t0m0.039s\r\nsys\t0m0.027s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m4.339s\r\nuser\t0m0.733s\r\nsys\t0m0.403s\r\nOn-disk cluster state size\r\n92K\tdata/_state\r\n92K\tdata\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m2.319s\r\nuser\t0m1.060s\r\nsys\t0m0.312s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m2.070s\r\nuser\t0m0.059s\r\nsys\t0m0.007s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m4.109s\r\nuser\t0m0.850s\r\nsys\t0m0.301s\r\nOn-disk cluster state size\r\n92K\tdata/_state\r\n92K\tdata\r\n```\r\n\r\n- `master` branch with single data path, 1000 indices\r\n\r\n```\r\nCreating 1000 indices:    (1000)\r\nreal\t0m34.272s\r\nuser\t0m10.297s\r\nsys\t0m3.390s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m51.559s\r\nuser\t0m0.028s\r\nsys\t0m0.040s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m9.541s\r\nuser\t0m0.770s\r\nsys\t0m0.392s\r\nOn-disk cluster state size\r\n60K\tdata/_state\r\n4.0M\tdata/indices\r\n4.1M\tdata\r\n\r\nCreating 1000 indices:    (1000)\r\nreal\t0m37.330s\r\nuser\t0m10.140s\r\nsys\t0m3.579s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m59.807s\r\nuser\t0m0.042s\r\nsys\t0m0.026s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m9.844s\r\nuser\t0m0.788s\r\nsys\t0m0.372s\r\nOn-disk cluster state size\r\n72K\tdata/_state\r\n4.0M\tdata/indices\r\n4.1M\tdata\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with single data path, 1000 indices\r\n\r\n```\r\nCreating 1000 indices:    (1000)\r\nreal\t0m38.793s\r\nuser\t0m10.445s\r\nsys\t0m3.367s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m26.452s\r\nuser\t0m0.056s\r\nsys\t0m0.011s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m10.410s\r\nuser\t0m0.789s\r\nsys\t0m0.392s\r\nOn-disk cluster state size\r\n244K\tdata/_state\r\n244K\tdata\r\n\r\nCreating 1000 indices:    (1000)\r\nreal\t0m41.959s\r\nuser\t0m10.453s\r\nsys\t0m3.313s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m34.161s\r\nuser\t0m0.055s\r\nsys\t0m0.013s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m10.270s\r\nuser\t0m0.788s\r\nsys\t0m0.384s\r\nOn-disk cluster state size\r\n244K\tdata/_state\r\n244K\tdata\r\n```\r\n\r\n- `master` branch with multi data path (4 paths), 1000 indices\r\n\r\n```\r\nCreating 1000 indices:    (1000)\r\nreal\t0m53.603s\r\nuser\t0m10.565s\r\nsys\t0m3.370s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t2m2.496s\r\nuser\t0m0.045s\r\nsys\t0m0.026s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m13.476s\r\nuser\t0m0.819s\r\nsys\t0m0.393s\r\n\r\nCreating 1000 indices:    (1000)\r\nreal\t0m52.598s\r\nuser\t0m10.621s\r\nsys\t0m3.414s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t1m52.536s\r\nuser\t0m0.047s\r\nsys\t0m0.023s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m13.189s\r\nuser\t0m0.806s\r\nsys\t0m0.390s\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with multi data path (4 paths), 1000 indices\r\n\r\n```\r\nCreating 1000 indices:    (1000)\r\nreal\t1m22.545s\r\nuser\t0m10.684s\r\nsys\t0m3.750s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m25.183s\r\nuser\t0m0.038s\r\nsys\t0m0.028s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m17.648s\r\nuser\t0m0.827s\r\nsys\t0m0.440s\r\n\r\nCreating 1000 indices:    (1000)\r\nreal\t1m22.559s\r\nuser\t0m10.758s\r\nsys\t0m3.664s\r\nUpdating an index setting 10 times on all 1000 indices:\r\nreal\t0m32.036s\r\nuser\t0m0.034s\r\nsys\t0m0.034s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m17.228s\r\nuser\t0m0.856s\r\nsys\t0m0.414s\r\n```\r\n\r\nThe new storage layer is slightly slower when only very little information is written out (e.g. only cluster state version changed), but works much better in case where large cluster states are updated.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/573640217","html_url":"https://github.com/elastic/elasticsearch/issues/48701#issuecomment-573640217","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48701","id":573640217,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MzY0MDIxNw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-01-13T12:28:49Z","updated_at":"2020-01-13T12:28:49Z","author_association":"CONTRIBUTOR","body":"Another test with a `d2.xlarge` instance (3 HDDs, single data path tests use just first HDD, multi data path tests use all 3):\r\n\r\n- `master` branch with single data path, 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t0m11.151s\r\nuser\t0m1.383s\r\nsys\t0m0.504s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m43.830s\r\nuser\t0m0.038s\r\nsys\t0m0.032s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m20.208s\r\nuser\t0m0.833s\r\nsys\t0m0.481s\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m10.090s\r\nuser\t0m1.404s\r\nsys\t0m0.411s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m44.041s\r\nuser\t0m0.034s\r\nsys\t0m0.034s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m19.301s\r\nuser\t0m0.822s\r\nsys\t0m0.473s\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with single data path, 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t0m22.480s\r\nuser\t0m1.436s\r\nsys\t0m0.424s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m5.316s\r\nuser\t0m0.050s\r\nsys\t0m0.018s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m35.772s\r\nuser\t0m0.808s\r\nsys\t0m0.490s\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m19.036s\r\nuser\t0m1.333s\r\nsys\t0m0.467s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m3.760s\r\nuser\t0m0.040s\r\nsys\t0m0.029s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m35.163s\r\nuser\t0m0.855s\r\nsys\t0m0.432s\r\n```\r\n\r\n- `master` branch with single data path, 300 indices\r\n\r\n```\r\nCreating 300 indices:     (300)\r\nreal\t0m32.569s\r\nuser\t0m4.088s\r\nsys\t0m1.474s\r\nUpdating an index setting 10 times on all 300 indices:\r\nreal\t2m13.866s\r\nuser\t0m0.049s\r\nsys\t0m0.026s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m20.795s\r\nuser\t0m0.827s\r\nsys\t0m0.423s\r\n\r\nCreating 300 indices:     (300)\r\nreal\t0m33.505s\r\nuser\t0m3.994s\r\nsys\t0m1.314s\r\nUpdating an index setting 10 times on all 300 indices:\r\nreal\t2m14.220s\r\nuser\t0m0.032s\r\nsys\t0m0.036s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m21.040s\r\nuser\t0m0.796s\r\nsys\t0m0.437s\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with single data path, 300 indices\r\n\r\n```\r\nCreating 300 indices:     (300)\r\nreal\t0m58.257s\r\nuser\t0m4.086s\r\nsys\t0m1.318s\r\nUpdating an index setting 10 times on all 300 indices:\r\nreal\t0m7.818s\r\nuser\t0m0.047s\r\nsys\t0m0.018s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m34.205s\r\nuser\t0m0.845s\r\nsys\t0m0.411s\r\n\r\nCreating 300 indices:     (300)\r\nreal\t0m57.746s\r\nuser\t0m4.111s\r\nsys\t0m1.262s\r\nUpdating an index setting 10 times on all 300 indices:\r\nreal\t0m7.997s\r\nuser\t0m0.048s\r\nsys\t0m0.022s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m33.881s\r\nuser\t0m0.818s\r\nsys\t0m0.433s\r\n```\r\n\r\n- `master` branch with multi data path (3 paths), 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t0m26.011s\r\nuser\t0m1.372s\r\nsys\t0m0.503s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t2m0.492s\r\nuser\t0m0.058s\r\nsys\t0m0.013s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m48.323s\r\nuser\t0m0.859s\r\nsys\t0m0.446s\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m26.063s\r\nuser\t0m1.369s\r\nsys\t0m0.446s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t2m1.355s\r\nuser\t0m0.041s\r\nsys\t0m0.029s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t0m49.706s\r\nuser\t0m0.933s\r\nsys\t0m0.342s\r\n```\r\n\r\n- `reduce-metadata-writes` branch (+ https://github.com/elastic/elasticsearch/pull/50901) with multi data path (3 paths), 100 indices\r\n\r\n```\r\nCreating 100 indices:     (100)\r\nreal\t1m9.086s\r\nuser\t0m1.318s\r\nsys\t0m0.521s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m9.491s\r\nuser\t0m0.046s\r\nsys\t0m0.022s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t1m57.110s\r\nuser\t0m0.911s\r\nsys\t0m0.388s\r\n\r\nCreating 100 indices:     (100)\r\nreal\t0m57.128s\r\nuser\t0m1.328s\r\nsys\t0m0.483s\r\nUpdating an index setting 10 times on all 100 indices:\r\nreal\t0m6.625s\r\nuser\t0m0.059s\r\nsys\t0m0.006s\r\nUpdating an index setting 200 times on the first index:\r\nreal\t1m36.907s\r\nuser\t0m0.876s\r\nsys\t0m0.418s\r\n```\r\n\r\nThe test validates that the size of the cluster state does not impact the new storage mechanism.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/591850439","html_url":"https://github.com/elastic/elasticsearch/issues/48701#issuecomment-591850439","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48701","id":591850439,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MTg1MDQzOQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-02-27T08:41:25Z","updated_at":"2020-02-27T08:41:25Z","author_association":"CONTRIBUTOR","body":"Closing this issue as the work here was merged for 7.6.0","performed_via_github_app":null}]