[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21197876","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21197876","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21197876,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTk3ODc2","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-07-18T16:55:09Z","updated_at":"2013-07-18T16:55:09Z","author_association":"MEMBER","body":"Elasticsearch will not guarantee the unique aspect of an ID when using custom routing. The unique aspect is maintained on the shard level. The cost of trying to make sure the ID is globally unique will be to expensive across the cluster.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21227003","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21227003","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21227003,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMjI3MDAz","user":{"login":"fcrosfly","id":1575457,"node_id":"MDQ6VXNlcjE1NzU0NTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1575457?v=4","gravatar_id":"","url":"https://api.github.com/users/fcrosfly","html_url":"https://github.com/fcrosfly","followers_url":"https://api.github.com/users/fcrosfly/followers","following_url":"https://api.github.com/users/fcrosfly/following{/other_user}","gists_url":"https://api.github.com/users/fcrosfly/gists{/gist_id}","starred_url":"https://api.github.com/users/fcrosfly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fcrosfly/subscriptions","organizations_url":"https://api.github.com/users/fcrosfly/orgs","repos_url":"https://api.github.com/users/fcrosfly/repos","events_url":"https://api.github.com/users/fcrosfly/events{/privacy}","received_events_url":"https://api.github.com/users/fcrosfly/received_events","type":"User","site_admin":false},"created_at":"2013-07-19T01:49:06Z","updated_at":"2013-07-19T01:49:19Z","author_association":"NONE","body":"> _< support\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21228065","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21228065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21228065,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMjI4MDY1","user":{"login":"icedfish","id":1222861,"node_id":"MDQ6VXNlcjEyMjI4NjE=","avatar_url":"https://avatars3.githubusercontent.com/u/1222861?v=4","gravatar_id":"","url":"https://api.github.com/users/icedfish","html_url":"https://github.com/icedfish","followers_url":"https://api.github.com/users/icedfish/followers","following_url":"https://api.github.com/users/icedfish/following{/other_user}","gists_url":"https://api.github.com/users/icedfish/gists{/gist_id}","starred_url":"https://api.github.com/users/icedfish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icedfish/subscriptions","organizations_url":"https://api.github.com/users/icedfish/orgs","repos_url":"https://api.github.com/users/icedfish/repos","events_url":"https://api.github.com/users/icedfish/events{/privacy}","received_events_url":"https://api.github.com/users/icedfish/received_events","type":"User","site_admin":false},"created_at":"2013-07-19T02:29:47Z","updated_at":"2013-07-19T02:38:24Z","author_association":"NONE","body":"@kimchy I known it's hard to maintan the unique globally,  but could you add the issue to the doc page of routing field?  It's totallly not expected to have this problem when I choose to using _routing several months ago >>_<<\n\nI'm trying  to find a way to detect the ids that already be non-unique, and fix the non-unique issue by a batch.\nBut I find it hard to find them...\n\nI try to find the duplicate by term facet count like below:\n\n```\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"facets\": {\n    \"count\": {\n      \"terms\": {\n        \"field\": \"_id\",\n        \"size\": 10,\n        \"order\": \"count\"\n      }\n    }\n  }\n}\n```\n\nBut I found it only works when I test the query on a single node cluster,  but don't work on my production cluster with more nodes, all the count return 1.\nIs it because the index contains too many ids?  (about 10M)\n\nAnd when I sepecific a duplicate id in filter query, it can give the right count nunber :\n\n```\n{\n  \"query\": {\n    \"term\": {\n      \"_id\": \"276052286\"\n    }\n  },\n.....\n}\n```\n\nCould you give me some suggest? thanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21340076","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21340076","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21340076,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMzQwMDc2","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2013-07-22T12:18:26Z","updated_at":"2013-07-22T12:18:26Z","author_association":"MEMBER","body":"@icedfish I added a \"id uniqueness\" section to the doc page for the [_routing field](http://www.elasticsearch.org/guide/reference/mapping/routing-field/).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21347676","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21347676","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21347676,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMzQ3Njc2","user":{"login":"icedfish","id":1222861,"node_id":"MDQ6VXNlcjEyMjI4NjE=","avatar_url":"https://avatars3.githubusercontent.com/u/1222861?v=4","gravatar_id":"","url":"https://api.github.com/users/icedfish","html_url":"https://github.com/icedfish","followers_url":"https://api.github.com/users/icedfish/followers","following_url":"https://api.github.com/users/icedfish/following{/other_user}","gists_url":"https://api.github.com/users/icedfish/gists{/gist_id}","starred_url":"https://api.github.com/users/icedfish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icedfish/subscriptions","organizations_url":"https://api.github.com/users/icedfish/orgs","repos_url":"https://api.github.com/users/icedfish/repos","events_url":"https://api.github.com/users/icedfish/events{/privacy}","received_events_url":"https://api.github.com/users/icedfish/received_events","type":"User","site_admin":false},"created_at":"2013-07-22T14:29:54Z","updated_at":"2013-07-22T14:29:54Z","author_association":"NONE","body":"Hi @javanna could you told me a possible way to find the non-unique ids?  Or there's no way to find them ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21396482","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21396482","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21396482,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMzk2NDgy","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2013-07-23T06:58:29Z","updated_at":"2013-07-23T06:58:29Z","author_association":"MEMBER","body":"Untested, but if you have indexed the id, you could run a terms facet on it (or maybe if you have not indexed it, you can use a `script_field` inside your terms facet - not a hundred percent sure, but maybe worth a try).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21414768","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21414768","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21414768,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNDE0NzY4","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2013-07-23T13:47:11Z","updated_at":"2013-07-23T13:47:11Z","author_association":"MEMBER","body":"terms facet is the simplest way to go, but in order for it to work you will have to fit all ids into memory. The reason for this is that terms facets are calculated on each shard first and then reduced on a single node. But the nature of the problem is that within a shard all ids are unique. So, each shard will have to send a complete set of ids to the reducer where they will have to be de-duplicated. To make long story short, for terms facet to work the `size` parameter on the facet will have to be set to the number of ids and such facet might be too big for your nodes. \n\nA more light-weight solution would be to extract all ids, sort them and then find repeated ids. You can write a script that would use [scan/scroll](http://www.elasticsearch.org/guide/reference/api/search/scroll/) to retrieve all ids in your index or you can use handy [es2unix](https://github.com/elasticsearch/es2unix) script that already has this functionality. After es2unix is installed, you can find duplicate ids by simply running the following script:\n\n```\nes ids user User | sort | uniq -d \n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21471438","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21471438","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21471438,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNDcxNDM4","user":{"login":"icedfish","id":1222861,"node_id":"MDQ6VXNlcjEyMjI4NjE=","avatar_url":"https://avatars3.githubusercontent.com/u/1222861?v=4","gravatar_id":"","url":"https://api.github.com/users/icedfish","html_url":"https://github.com/icedfish","followers_url":"https://api.github.com/users/icedfish/followers","following_url":"https://api.github.com/users/icedfish/following{/other_user}","gists_url":"https://api.github.com/users/icedfish/gists{/gist_id}","starred_url":"https://api.github.com/users/icedfish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icedfish/subscriptions","organizations_url":"https://api.github.com/users/icedfish/orgs","repos_url":"https://api.github.com/users/icedfish/repos","events_url":"https://api.github.com/users/icedfish/events{/privacy}","received_events_url":"https://api.github.com/users/icedfish/received_events","type":"User","site_admin":false},"created_at":"2013-07-24T08:48:14Z","updated_at":"2013-07-24T08:48:14Z","author_association":"NONE","body":"Hi @imotov, thanks for your  help!\nI tried es2unix, but I think there may be something wrong with the scroll function ( I checked the source code es2unix ids function is using the scroll function ) .\nI got much much more ids than the total ids the index should really have , I even find an id appers for 79519 times...\n\nI'll do some more research to locate the issue. I think it's could be my second issue for project ES : ) \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21530110","html_url":"https://github.com/elastic/elasticsearch/issues/3346#issuecomment-21530110","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3346","id":21530110,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTMwMTEw","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2013-07-25T02:41:20Z","updated_at":"2013-07-25T02:41:20Z","author_association":"MEMBER","body":"@icedfish if you have ruby and tire installed, you can try running the following script instead of es2unix.\n\n```\nrequire 'rubygems'\nrequire 'tire'\n\ns = Tire.scan('user', )\ns.each_document do |document|\n  print document._type, \" \", document.id, \"\\n\"\nend\n```\n","performed_via_github_app":null}]