{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6994","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6994/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6994/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6994/events","html_url":"https://github.com/elastic/elasticsearch/issues/6994","id":38560716,"node_id":"MDU6SXNzdWUzODU2MDcxNg==","number":6994,"title":"Within a sub-aggregation of a reverse_nested aggregation, cannot filter on nested fields","user":{"login":"lmeck","id":7913050,"node_id":"MDQ6VXNlcjc5MTMwNTA=","avatar_url":"https://avatars1.githubusercontent.com/u/7913050?v=4","gravatar_id":"","url":"https://api.github.com/users/lmeck","html_url":"https://github.com/lmeck","followers_url":"https://api.github.com/users/lmeck/followers","following_url":"https://api.github.com/users/lmeck/following{/other_user}","gists_url":"https://api.github.com/users/lmeck/gists{/gist_id}","starred_url":"https://api.github.com/users/lmeck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmeck/subscriptions","organizations_url":"https://api.github.com/users/lmeck/orgs","repos_url":"https://api.github.com/users/lmeck/repos","events_url":"https://api.github.com/users/lmeck/events{/privacy}","received_events_url":"https://api.github.com/users/lmeck/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2014-07-23T19:05:05Z","updated_at":"2014-07-28T08:10:20Z","closed_at":"2014-07-28T08:10:20Z","author_association":"NONE","active_lock_reason":null,"body":"I'm unsure if this is a bug or something that wasn't intended to work. In the example below, I'm trying to find the 'foo' object that has the nested 'bar' object named 'bar0'. I then want to know how many nested 'baz' objects the 'foo' contains. After using reverse_nested I can use the first-level fields of 'foo0', but not the nested fields.\n\nUsing my actual data this sometimes did work, which is why I thought there might be a bug here. So for example two root objects would contain a certain nested object ('bar'), but only one was returning a proper count of another nested object (baz). With my example I wasn't able to recreate this.\n\n```\nDELETE /_all\n\nPUT /foos\n\nPUT /foos/foo/_mapping\n{\n  \"foo\": {\n    \"properties\": {\n      \"bar\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"string\"\n          }\n        }\n      },\n      \"baz\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"string\"\n          }\n        }\n      },\n      \"name\": {\n        \"type\": \"string\"\n      }\n    }\n  }\n}\n\nPUT /foos/foo/0\n{\n  \"bar\": [\n    {\n      \"name\": \"bar0\"\n    },\n    {\n      \"name\": \"bar1\"\n    }\n  ],\n  \"baz\": [\n    {\n      \"name\": \"baz0\"\n    },\n    {\n      \"name\": \"baz1\"\n    }\n  ],\n  \"name\": \"foo0\"\n}\nPUT /foos/foo/1\n{\n  \"bar\": [\n    {\n      \"name\": \"bar2\"\n    },\n    {\n      \"name\": \"bar3\"\n    }\n  ],\n  \"baz\": [\n    {\n      \"name\": \"baz2\"\n    },\n    {\n      \"name\": \"baz3\"\n    }\n  ],\n  \"name\": \"foo1\"\n}\n\n#this should give a count of 2 under baz, but it's 0 instead\n\nPOST /foos/foo/_search?pretty\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"bar\": {\n      \"nested\": {\n        \"path\": \"bar\"\n      },\n      \"aggs\": {\n        \"bar_filter\": {\n          \"filter\": {\n            \"bool\": {\n              \"must\": {\n                \"term\": {\n                  \"bar.name\": \"bar0\"\n                }\n              }\n            }\n          },\n          \"aggs\": {\n            \"foo\": {\n              \"reverse_nested\": {},\n              \"aggs\": {\n                \"name\": {\n                  \"terms\": {\n                    \"field\": \"name\"\n                  },\n                  \"aggs\": {\n                    \"baz\": {\n                      \"nested\": {\n                        \"path\": \"baz\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n# this works and give the right number of baz\nPOST /foos/foo/_search?pretty\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"foo_filter\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": {\n            \"term\": {\n              \"name\": \"foo0\"\n            }\n          }\n        }\n      },\n      \"aggs\": {\n        \"baz\": {\n          \"nested\": {\n            \"path\": \"baz\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}