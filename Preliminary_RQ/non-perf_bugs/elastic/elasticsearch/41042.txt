{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41042","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41042/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41042/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41042/events","html_url":"https://github.com/elastic/elasticsearch/issues/41042","id":431241439,"node_id":"MDU6SXNzdWU0MzEyNDE0Mzk=","number":41042,"title":"Watcher attempts to use ILM when ILM is disabled","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-04-09T23:40:10Z","updated_at":"2019-04-12T15:49:47Z","closed_at":"2019-04-12T15:49:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Found in 7.0.0 (BC2), I think this impacts 6.7 as well.\r\n\r\n## To reproduce\r\nStart a node with a trial license and `xpack.ilm.enabled: false`.\r\n\r\nDuring startup, this message will appear in the logs:\r\n```\r\njava.lang.IllegalStateException: failed to find action [org.elasticsearch.xpack.core.indexlifecycle.action.PutLifecycleAction@d06806ea] to execute\r\n\tat org.elasticsearch.client.node.NodeClient.transportAction(NodeClient.java:116) ~[elasticsearch-7.0.0.jar:7.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83) ~[elasticsearch-7.0.0.jar:7.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72) ~[elasticsearch-7.0.0.jar:7.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:393) ~[elasticsearch-7.0.0.jar:7.0.0]\r\n\tat org.elasticsearch.xpack.core.indexlifecycle.client.ILMClient.putLifecyclePolicy(ILMClient.java:42) ~[?:?]\r\n\tat org.elasticsearch.xpack.watcher.support.WatcherIndexTemplateRegistry.lambda$putPolicy$3(WatcherIndexTemplateRegistry.java:195) ~[?:?]\r\n\tat org.elasticsearch.xpack.core.ClientHelper.executeAsyncWithOrigin(ClientHelper.java:82) ~[?:?]\r\n\tat org.elasticsearch.xpack.watcher.support.WatcherIndexTemplateRegistry.lambda$putPolicy$4(WatcherIndexTemplateRegistry.java:178) ~[?:?]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) ~[elasticsearch-7.0.0.jar:7.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:835) [?:?]\r\n```\r\n\r\nAdditionally, the index template will contain `index.lfiecycle.name`:\r\n```\r\nGET _template/.watch-history-9\r\n\r\n{\r\n  \".watch-history-9\": {\r\n    \"order\": 2147483647,\r\n    \"index_patterns\": [\r\n      \".watcher-history-9*\"\r\n    ],\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"format\": \"6\",\r\n        \"lifecycle\": {\r\n          \"name\": \"watch-history-ilm-policy\"\r\n        },\r\n        \"number_of_shards\": \"1\",\r\n        \"auto_expand_replicas\": \"0-1\",\r\n        \"number_of_replicas\": \"0\"\r\n      }\r\n    },\r\n    \"mappings\": {[...elided for brevity...]},\r\n    \"aliases\": {}\r\n  }\r\n}\r\n```\r\n\r\nThe watch history index is created and records history just fine, although it too has `index.lifecycle.name` set (even though ILM is disabled):\r\n```\r\nGET .watcher-history-*\r\n\r\n{\r\n  \".watcher-history-9-2019.04.09\": {\r\n    \"aliases\": {},\r\n    \"mappings\": {[...elided for brevity...]},\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"lifecycle\": {\r\n          \"name\": \"watch-history-ilm-policy\"\r\n        },\r\n        \"number_of_shards\": \"1\",\r\n        \"auto_expand_replicas\": \"0-1\",\r\n        \"provided_name\": \".watcher-history-9-2019.04.09\",\r\n        \"format\": \"6\",\r\n        \"creation_date\": \"1554852639758\",\r\n        \"number_of_replicas\": \"0\",\r\n        \"uuid\": \"b4Mj6GgkQHSP77kyxH2DHA\",\r\n        \"version\": {\r\n          \"created\": \"7000099\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## Root cause\r\n\r\nI believe this is caused by the same root cause as https://github.com/elastic/elasticsearch/issues/40803 - we check this setting via the cluster state:\r\nhttps://github.com/elastic/elasticsearch/blob/9c6231fd223b42da77e7b979ff8b0a0962a9aab6/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/support/WatcherIndexTemplateRegistry.java#L156\r\nBut since `xpack.ilm.enabled` can only be set via `elasticsearch.yml`, reading it from the cluster state will always result in the default value - it must be read from the `Settings` object created from `elasticsearch.yml` at startup.","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}