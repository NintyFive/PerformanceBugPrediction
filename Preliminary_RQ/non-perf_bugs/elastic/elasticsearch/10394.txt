{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394/events","html_url":"https://github.com/elastic/elasticsearch/issues/10394","id":65935801,"node_id":"MDU6SXNzdWU2NTkzNTgwMQ==","number":10394,"title":"Multiword query time synonyms and match queries with the \"and\" operator may not work","user":{"login":"ianribas","id":1250546,"node_id":"MDQ6VXNlcjEyNTA1NDY=","avatar_url":"https://avatars0.githubusercontent.com/u/1250546?v=4","gravatar_id":"","url":"https://api.github.com/users/ianribas","html_url":"https://github.com/ianribas","followers_url":"https://api.github.com/users/ianribas/followers","following_url":"https://api.github.com/users/ianribas/following{/other_user}","gists_url":"https://api.github.com/users/ianribas/gists{/gist_id}","starred_url":"https://api.github.com/users/ianribas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ianribas/subscriptions","organizations_url":"https://api.github.com/users/ianribas/orgs","repos_url":"https://api.github.com/users/ianribas/repos","events_url":"https://api.github.com/users/ianribas/events{/privacy}","received_events_url":"https://api.github.com/users/ianribas/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2015-04-02T14:12:37Z","updated_at":"2018-02-14T13:39:44Z","closed_at":"2017-04-26T11:07:58Z","author_association":"NONE","active_lock_reason":null,"body":"This issue is very similar to what is documented on the entry about [multiword synonyms and phrase queries](http://www.elastic.co/guide/en/elasticsearch/guide/current/multi-word-synonyms.htm) . What is different is that the same kind of problems, when the synonyms are of different lengths (in number of terms), occur when using the standard [`match`](http://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html) query with the `operator` flag set to `and`. In this case too, some documents may unexpectedly not match.\n\nHere is an example that reproduces the behavior:\n\n``` bash\n# delete old index if exists\ncurl -XDELETE 'http://localhost:9200/multiwordsyns?pretty'\n\n# create index with synonym analyzer and mapping\ncurl -XPUT 'http://localhost:9200/multiwordsyns?pretty' -d '{\n    \"settings\" : {\n        \"number_of_replicas\": 0,\n        \"number_of_shards\": 1,\n        \"index\": {\n            \"analysis\": {\n                \"analyzer\": {\n                    \"index_time\": {\n                        \"tokenizer\": \"standard\",\n                        \"filter\": [\"standard\", \"lowercase\"]\n                    },\n                    \"synonym\": {\n                        \"tokenizer\": \"standard\",\n                        \"filter\": [\"standard\", \"lowercase\", \"stop\", \"synonym\"]\n                    }\n                },\n                \"filter\": {\n                    \"synonym\": {\n                        \"type\": \"synonym\",\n                        \"synonyms\": [\n                            \"spider man, spiderman\"\n                        ]\n                    }\n                }\n            }\n        }\n    },\n    \"mappings\": {\n        \"test\": {\n            \"properties\": {\n                \"text\": {\"type\": \"string\", \"index_analyzer\": \"index_time\", \"search_analyzer\": \"synonym\"}\n            }\n        }\n    }\n}'\n\n# index the test documents\ncurl -XPUT 'http://localhost:9200/multiwordsyns/test/1?pretty' -d '{\"text\": \"the adventures of spiderman\"}'\ncurl -XPUT 'http://localhost:9200/multiwordsyns/test/2?pretty' -d '{\"text\": \"what hath man wrought?\"}'\ncurl -XPUT 'http://localhost:9200/multiwordsyns/test/3?pretty' -d '{\"text\": \"that spider is the size of a man\"}'\ncurl -XPUT 'http://localhost:9200/multiwordsyns/test/4?pretty&refresh=true' -d '{\"text\": \"spiders eat insects\"}'\n\n# WRONG! finds only #1, should find #1 & #3\ncurl -XPOST 'http://localhost:9200/multiwordsyns/test/_search?pretty' -d '{\"query\": {\"match\": {\"text\": {\"query\": \"spiderman\", \"operator\": \"and\"}}}}'\n\n# Also WRONG! finds only #1, should find #1 & #3\ncurl -XPOST 'http://localhost:9200/multiwordsyns/test/_search?pretty' -d '{\"query\": {\"match\": {\"text\": {\"query\": \"spider man\", \"operator\": \"and\"}}}}'\n```\n\nAlso available as a gist: https://gist.github.com/ianribas/f76d20c21bb9f5c0df2f\n\nIf the synonyms are applied at index time, the example above works. This can be used as a workaround, but is a choice that has other impacts, as described on the documentation.\n\nIt took us a while to identify this problem, so I thought it was important to at least write it down so it could maybe help others.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}