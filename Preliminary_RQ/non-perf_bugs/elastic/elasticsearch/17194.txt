{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17194","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17194/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17194/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17194/events","html_url":"https://github.com/elastic/elasticsearch/issues/17194","id":141912377,"node_id":"MDU6SXNzdWUxNDE5MTIzNzc=","number":17194,"title":"Groovy script does not work with 'each' function","user":{"login":"sss13579","id":12202922,"node_id":"MDQ6VXNlcjEyMjAyOTIy","avatar_url":"https://avatars2.githubusercontent.com/u/12202922?v=4","gravatar_id":"","url":"https://api.github.com/users/sss13579","html_url":"https://github.com/sss13579","followers_url":"https://api.github.com/users/sss13579/followers","following_url":"https://api.github.com/users/sss13579/following{/other_user}","gists_url":"https://api.github.com/users/sss13579/gists{/gist_id}","starred_url":"https://api.github.com/users/sss13579/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sss13579/subscriptions","organizations_url":"https://api.github.com/users/sss13579/orgs","repos_url":"https://api.github.com/users/sss13579/repos","events_url":"https://api.github.com/users/sss13579/events{/privacy}","received_events_url":"https://api.github.com/users/sss13579/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-03-18T16:17:29Z","updated_at":"2016-03-18T16:40:05Z","closed_at":"2016-03-18T16:20:05Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\n\n2.2.0\n\n**JVM version**:\n\n1.8.0_73\n\n**OS version**:\n\nWindows\n\n**Description of the problem including expected versus actual behavior**:\n\nSeems that script is cached and in this state stops work with 'each' function.\n\n**Steps to reproduce**:\n\nSimplified example. Please do not seek sense in it )\n1. POST http://localhost:9200/testindex/testtype/testid/_update\n   `{\n   \"script\" : {\n       \"inline\" : \"stats.each { key = it.getKey(); value = stats[key]; ctx._source.visits = value.visits; }\",\n       \"params\" : {\n           \"stats\" : {\n               \"internal\" : {\n                   \"visits\" : 10\n               },\n               \"external\" : {\n                   \"visits\" : 20\n               }\n           }\n       }\n   },\n   \"upsert\" : {\n       \"visits\" : 10\n   }\n   }`\n2. Repeat step 1 until it stops work. It may happen on the second time or on the 20th. You will get an error\n   `{\n   \"error\" : {\n       \"root_cause\" : [{\n               \"type\" : \"remote_transport_exception\",\n               \"reason\" : \"[nodename][127.0.0.1:9300][indices:data/write/update[s]]\"\n           }\n       ],\n       \"type\" : \"illegal_argument_exception\",\n       \"reason\" : \"failed to execute script\",\n       \"caused_by\" : {\n           \"type\" : \"script_exception\",\n           \"reason\" : \"failed to run inline script [stats.each { key = it.getKey(); value = stats[key];  ctx._source.visits = value.visits; }] using lang [groovy]\",\n           \"caused_by\" : {\n               \"type\" : \"no_class_def_found_error\",\n               \"reason\" : \"sun/reflect/MethodAccessorImpl\",\n               \"caused_by\" : {\n                   \"type\" : \"class_not_found_exception\",\n                   \"reason\" : \"sun.reflect.MethodAccessorImpl\"\n               }\n           }\n       }\n   },\n   \"status\" : 400\n   }\n   `\n3. If you change inline script (you can simply insert a space) then it starts work. Then go to step 2.\n\n**Provide logs (if relevant)**:\n\nFrom elastic log:\n`[INFO ][rest.suppressed          ] /testindex/testtype/testid/_update Params: {index=testindex, id=testid, type=testtype}\nRemoteTransportException[[nodename][127.0.0.1:9300][indices:data/write/update[s]]]; nested: IllegalArgumentException[failed to execute script]; nested: ScriptException[failed to run inline script [stats.each { key = it.getKey(); value = stats[key]; ctx._source.visits = value.visits; }] using lang [groovy]]; nested: NoClassDefFoundError[sun/reflect/MethodAccessorImpl]; nested: ClassNotFoundException[sun.reflect.MethodAccessorImpl];\nCaused by: java.lang.IllegalArgumentException: failed to execute script\n    at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:256)\n    at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:196)\n    at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:79)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:170)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:164)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:65)\n    at org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:249)\n    at org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:245)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n    at java.lang.Thread.run(Unknown Source)\nCaused by: ScriptException[failed to run inline script [stats.each { key = it.getKey(); value = stats[key]; ctx._source.visits = value.visits; }] using lang [groovy]]; nested: NoClassDefFoundError[sun/reflect/MethodAccessorImpl]; nested: ClassNotFoundException[sun.reflect.MethodAccessorImpl];\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:318)\n    at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:251)\n    ... 12 more\nCaused by: java.lang.NoClassDefFoundError: sun/reflect/MethodAccessorImpl\n    at sun.misc.Unsafe.defineClass(Native Method)\n    at sun.reflect.ClassDefiner.defineClass(Unknown Source)\n    at sun.reflect.MethodAccessorGenerator$1.run(Unknown Source)\n    at sun.reflect.MethodAccessorGenerator$1.run(Unknown Source)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at sun.reflect.MethodAccessorGenerator.generate(Unknown Source)\n    at sun.reflect.MethodAccessorGenerator.generateMethod(Unknown Source)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n    at java.lang.reflect.Method.invoke(Unknown Source)\n    at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:93)\n    at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:325)\n    at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:294)\n    at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1019)\n    at groovy.lang.Closure.call(Closure.java:426)\n    at groovy.lang.Closure.call(Closure.java:442)\n    at org.codehaus.groovy.runtime.DefaultGroovyMethods.callClosureForMapEntry(DefaultGroovyMethods.java:5228)\n    at org.codehaus.groovy.runtime.DefaultGroovyMethods.each(DefaultGroovyMethods.java:2107)\n    at org.codehaus.groovy.runtime.dgm$163.doMethodInvoke(Unknown Source)\n    at 2fe87ca3b157e7fc7a85946504c7142bec5e87df.run(2fe87ca3b157e7fc7a85946504c7142bec5e87df:1)\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript$1.run(GroovyScriptEngineService.java:311)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:308)\n    ... 13 more\nCaused by: java.lang.ClassNotFoundException: sun.reflect.MethodAccessorImpl\n    at java.net.URLClassLoader.findClass(Unknown Source)\n    at java.lang.ClassLoader.loadClass(Unknown Source)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:677)\n    at groovy.lang.GroovyClassLoader$InnerLoader.loadClass(GroovyClassLoader.java:425)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:787)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:775)\n    ... 36 more\n`\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}