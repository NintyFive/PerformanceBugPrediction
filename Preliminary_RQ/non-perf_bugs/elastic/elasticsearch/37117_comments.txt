[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451162804","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-451162804","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":451162804,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTE2MjgwNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-03T14:42:49Z","updated_at":"2019-01-03T14:42:49Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451927181","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-451927181","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":451927181,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTkyNzE4MQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-01-07T13:00:05Z","updated_at":"2019-01-07T13:00:05Z","author_association":"CONTRIBUTOR","body":"The assertion that's failing is https://github.com/elastic/elasticsearch/blob/0000e7c8b524556d7a1bbec94e6c0114fc225bab/server/src/main/java/org/elasticsearch/indices/IndicesQueryCache.java#L191\r\n\r\nCan anyone from @elastic/es-search offer any advice on what might cause this?  Is it because ML is doing some operation on the index while it's being closed?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451929283","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-451929283","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":451929283,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTkyOTI4Mw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-01-07T13:08:45Z","updated_at":"2019-01-07T13:08:45Z","author_association":"CONTRIBUTOR","body":"One more thing is that many failures of this type seem to be running in the Zulu JVM.\r\n\r\nHowever, I found one that isn't: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=opensuse/165/consoleText\r\n\r\nSo it may be that there's something about the Zulu JVM that makes these failures more likely to occur, but it's not the root cause of the problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/452712976","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-452712976","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":452712976,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MjcxMjk3Ng==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2019-01-09T14:22:13Z","updated_at":"2019-01-09T14:22:13Z","author_association":"CONTRIBUTOR","body":"another one here: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+intake/906/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/453167178","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-453167178","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":453167178,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MzE2NzE3OA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-01-10T16:48:42Z","updated_at":"2019-02-19T09:39:46Z","author_association":"MEMBER","body":"There was a failure in `BasicDistributedJobsIT` that looks like it has the same root cause\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+matrix-java-periodic/ES_BUILD_JAVA=java11,ES_RUNTIME_JAVA=java8,nodes=virtual&&linux/172/console\r\n\r\n```\r\njava.lang.AssertionError: 2\r\n\tat __randomizedtesting.SeedInfo.seed([3EDB4FBFCECABCD4:D16E134409CDA259]:0)\r\n\tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:189)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:145)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:130)\r\n\tat org.elasticsearch.indices.IndicesService.doClose(IndicesService.java:297)\r\n\tat org.elasticsearch.common.component.AbstractLifecycleComponent.close(AbstractLifecycleComponent.java:105)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:61)\r\n\tat org.elasticsearch.node.NodeService.close(NodeService.java:135)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n\tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:85)\r\n\tat org.elasticsearch.node.Node.close(Node.java:946)\r\n\tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.close(InternalTestCluster.java:1008)\r\n\tat org.elasticsearch.test.InternalTestCluster.stopNodesAndClients(InternalTestCluster.java:1651)\r\n\tat org.elasticsearch.test.InternalTestCluster.stopNodesAndClient(InternalTestCluster.java:1637)\r\n\tat org.elasticsearch.test.InternalTestCluster.stopRandomDataNode(InternalTestCluster.java:1531)\r\n\tat org.elasticsearch.xpack.ml.integration.BasicDistributedJobsIT.testFailOverBasics_withDataFeeder(BasicDistributedJobsIT.java:121)\r\n```\r\n\r\nIn this test a node is shutdown tripping the assertion which doesn't kill the node but leaves it half running. Later there is the error message from the shutdown node:\r\n\r\n```\r\n  1> [2019-01-10T22:27:02,402][WARN ][o.e.t.TcpTransport       ] [node_t1] send message failed [channel: MockChannel{profile='default', isOpen=false, localAddress=/127.0.0.1:39548, isServerSocket=false}]\r\n  1> java.net.SocketException: Socket is closed\r\n  1> \tat java.net.Socket.getOutputStream(Socket.java:943) ~[?:1.8.0_192]\r\n  1> \tat org.elasticsearch.transport.MockTcpTransport$MockChannel.sendMessage(MockTcpTransport.java:437) [framework-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport.internalSendMessage(TcpTransport.java:758) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport.sendResponse(TcpTransport.java:844) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport.sendResponse(TcpTransport.java:815) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransportChannel.sendResponse(TcpTransportChannel.java:64) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:54) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.HandledTransportAction$ChannelActionListener.onResponse(HandledTransportAction.java:103) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.HandledTransportAction$ChannelActionListener.onResponse(HandledTransportAction.java:87) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:360) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:356) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.search.SearchService$4.doRun(SearchService.java:1116) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:759) [elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n``` \r\n\r\nThe working theory is that some request hits the node during shutdown I've added some debug logging around the likely candidates in 92b519b9c8ccb18eda40de9eb4effb9104cffde6\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/453471938","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-453471938","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":453471938,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MzQ3MTkzOA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-01-11T10:30:48Z","updated_at":"2019-01-11T10:30:48Z","author_association":"MEMBER","body":"@jpountz could you take a look at the assertion failures in `IndicesQueryCache.close` thrown up by this test please. Any insights you have into what the cause may be are much appreciated.\r\n\r\n```\r\njava.lang.AssertionError: {org.apache.lucene.index.IndexReader$CacheKey@b62bec8=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@30fd04c3}\r\n\tat __randomizedtesting.SeedInfo.seed([374793047E6CA339:C9896ED516320174]:0)\r\n\tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:191)\r\n```\r\n\r\nand \r\n\r\n```\r\njava.lang.AssertionError: 2\r\n\tat __randomizedtesting.SeedInfo.seed([3EDB4FBFCECABCD4:D16E134409CDA259]:0)\r\n\tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:189)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460292503","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-460292503","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":460292503,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDI5MjUwMw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-02-04T15:33:20Z","updated_at":"2019-02-04T15:33:20Z","author_association":"MEMBER","body":"Talking to @droberts195, he thinks these failures from today look related. Its a different test though:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=amazon/223/console\r\n\r\n```\r\n ./gradlew :x-pack:plugin:ml:internalClusterTest \\\r\n  -Dtests.seed=2D587A9A8B6E70D8 \\\r\n  -Dtests.class=org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT \\\r\n  -Dtests.method=\"testFullClusterRestart\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-PE \\\r\n  -Dtests.timezone=America/St_Thomas \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nThe logs contain similar failures:\r\n\r\n```\r\n13:53:28 ERROR   12.1s J1 | MlDistributedFailureIT.testFullClusterRestart <<< FAILURES!\r\n13:53:28    > Throwable #1: java.lang.AssertionError: {org.apache.lucene.index.IndexReader$CacheKey@714f684a=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@3d9dc3df, org.apache.lucene.index.IndexReader$CacheKey@1875360d=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@46a79038}\r\n13:53:28    > \tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:191)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:145)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:130)\r\n13:53:28    > \tat org.elasticsearch.indices.IndicesService.doClose(IndicesService.java:284)\r\n13:53:28    > \tat org.elasticsearch.common.component.AbstractLifecycleComponent.close(AbstractLifecycleComponent.java:100)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:61)\r\n13:53:28    > \tat org.elasticsearch.node.NodeService.close(NodeService.java:135)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n13:53:28    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:85)\r\n13:53:28    > \tat org.elasticsearch.node.Node.close(Node.java:857)\r\n13:53:28    > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.close(InternalTestCluster.java:1039)\r\n13:53:28    > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.closeForRestart(InternalTestCluster.java:961)\r\n13:53:28    > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1860)\r\n13:53:28    > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1745)\r\n13:53:28    > \tat org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.lambda$testFullClusterRestart$5(MlDistributedFailureIT.java:113)\r\n13:53:28    > \tat org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.run(MlDistributedFailureIT.java:293)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460338498","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-460338498","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":460338498,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDMzODQ5OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-04T17:33:09Z","updated_at":"2019-02-04T17:33:09Z","author_association":"CONTRIBUTOR","body":"I changed the title of the issue because the things that all these failures have in common are:\r\n\r\n1. `assert stats2.isEmpty() : stats2;` fails in `IndicesQueryCache.close`\r\n2. They're all using the internal cluster test framework\r\n\r\nThe `stats2` variable and the assertion were added in 38f5cc236ac6d06556d25eab81f7b05854b326ca.  The code then underwent a major refactor in 44c653f5a87337a02daf4737bcb34150df509dbe.  The locking was changed but the assertion in `close` stayed the same.  Could it be a problem with visibility of changes between threads that only manifests itself in the internal cluster tests?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461498794","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-461498794","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":461498794,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTQ5ODc5NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T16:28:51Z","updated_at":"2019-02-07T16:28:51Z","author_association":"CONTRIBUTOR","body":"Another example in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.7+internalClusterTest/49/consoleText","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461981946","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-461981946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":461981946,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTk4MTk0Ng==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T23:27:51Z","updated_at":"2019-02-08T23:27:51Z","author_association":"MEMBER","body":"I spent all day trying to reproduce this, but I was unable to.\r\n\r\nThe only thing I could think of that would cause it was related to what @droberts195 says about thread visibility, specifically maybe making this:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/431c4fd55e4f317312bb616c20518deb67e17180/server/src/main/java/org/elasticsearch/indices/IndicesQueryCache.java#L209\r\n\r\nbe `volatile` since that is the determinant of whether stats are removed from the `stats2` map; but that is a shot in the dark and I don't have a way to test it since I haven't been able to reproduce this.\r\n\r\nI'm curious if anyone else has any ideas.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462305402","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-462305402","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":462305402,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjMwNTQwMg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-11T12:06:50Z","updated_at":"2019-02-11T12:18:00Z","author_association":"CONTRIBUTOR","body":"Thanks for looking at this @dakrone.  I agree that `int count` in `StatsAndCount` not being `volatile` is a likely cause of the problem.\r\n\r\nI just had a look at the base class, `LRUQueryCache` in Lucene, and it has the following comment:\r\n\r\n```\r\n  // these variables are volatile so that we do not need to sync reads\r\n  // but increments need to be performed under the lock\r\n```\r\n\r\nSo I guess the base class either had the same problem at one point or else its original author realised the potential problem with visibility of changes.\r\n\r\nOut of all the thousands of CI builds that run we only seem to get a failure of this assertion about twice a week.  None of the 3 tests that have failed because of it have been muted, so it seems like the best way forward is just to make that `int count` `volatile` and see if the failures go away.\r\n\r\nOne more thing though.  Can somebody who is more familiar with this confirm that `ElasticsearchLRUQueryCache.onDocIdSetCache` and `ElasticsearchLRUQueryCache.onDocIdSetEviction` can never get called by two different threads simultaneously?  I guess that's covered by the `// but increments need to be performed under the lock` in the base class, but if not then there's a worse synchronization problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462307805","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-462307805","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":462307805,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjMwNzgwNQ==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2019-02-11T12:17:01Z","updated_at":"2019-02-11T12:17:01Z","author_association":"CONTRIBUTOR","body":"> Can somebody who is more familiar with this confirm that `ElasticsearchLRUQueryCache.onDocIdSetCache` and `ElasticsearchLRUQueryCache.onDocIdSetEviction` can never get called by two different threads simultaneously?\r\n\r\nThe super methods of both assert that the current thread holds the cache's lock, so I think the behaviour here is fine.\r\n\r\n+1 to making `StatsAndCount.count` volatile","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462310184","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-462310184","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":462310184,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjMxMDE4NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-11T12:26:53Z","updated_at":"2019-02-11T12:26:53Z","author_association":"CONTRIBUTOR","body":"> +1 to making `StatsAndCount.count` volatile\r\n\r\nI opened #38714 to do this","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462516189","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-462516189","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":462516189,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjUxNjE4OQ==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2019-02-11T22:13:55Z","updated_at":"2019-02-11T22:13:55Z","author_association":"MEMBER","body":"@droberts195 thanks for opening the PR, I'm going to close this and assume your fix worked (so we don't forget to resolve this). We can always re-open it if we see more of this failure.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462686302","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-462686302","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":462686302,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjY4NjMwMg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T09:35:06Z","updated_at":"2019-02-12T09:35:06Z","author_association":"CONTRIBUTOR","body":"This failed again in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+intake/61/consoleText with the same assertion failure:\r\n\r\n```\r\n   > Throwable #1: java.lang.AssertionError: {org.apache.lucene.index.IndexReader$CacheKey@6cc2c355=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@6557d469}\r\n```\r\n\r\nBefore the assertion failure on closing the query cache was this exception:\r\n\r\n```\r\n  1> [2019-02-12T03:07:14,129][ERROR][o.e.x.m.p.MlMemoryTracker] [node_t1] [full-cluster-restart-job] failed to calculate job established model memory requirement\r\n  1> org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n  1> \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:296) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:139) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:259) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:105) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.lambda$performPhaseOnShard$3(InitialSearchPhase.java:285) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase$1.doRun(InitialSearchPhase.java:172) [elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_202]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_202]\r\n  1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_202]\r\n  1> Caused by: org.elasticsearch.transport.NodeNotConnectedException: [node_t2][127.0.0.1:36011] Node not connected\r\n  1> \tat org.elasticsearch.transport.ConnectionManager.getConnection(ConnectionManager.java:156) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService.getConnection(TransportService.java:557) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.SearchTransportService.getConnection(SearchTransportService.java:411) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.TransportSearchAction.lambda$buildConnectionLookup$6(TransportSearchAction.java:532) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.getConnection(AbstractSearchAsyncAction.java:301) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction.executePhaseOnShard(SearchQueryThenFetchAsyncAction.java:54) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.lambda$performPhaseOnShard$4(InitialSearchPhase.java:259) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.performPhaseOnShard(InitialSearchPhase.java:294) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:114) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase.access$200(InitialSearchPhase.java:50) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:273) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:59) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:441) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1118) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:660) ~[elasticsearch-7.1.0-SNAPSHOT.jar:7.1.0-SNAPSHOT]\r\n  1> \t... 5 more\r\n```\r\n\r\nIn other words, a search failed on one node as the cluster was being shut down because all the other nodes in the cluster were shut down and those other nodes had all the shards for some particular index.\r\n\r\nProbably the reason this failure started being seen when in 6.6 is that the `MlMemoryTracker` is probably the first component ever that could be doing a search at the exact moment an internal test cluster is shut down.\r\n\r\nIn terms of `stats2` in `IndicesQueryCache` it probably means that it can get into an inconsistent state if a search fails due to all the nodes in the cluster holding the shards it wanted to search being shut down at a particular point within the search.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464068672","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-464068672","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":464068672,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDA2ODY3Mg==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-02-15T14:27:48Z","updated_at":"2019-02-15T14:27:48Z","author_association":"CONTRIBUTOR","body":"I think this assertion error might happen if there are ongoing search requests, due to the fact that our use of ref-counting only effectively closes index reader and stores once all in-flight requests have finished. Closing the caches while there are ongoing requests feels wrong, so I opened #38958 which tries to only close caches after in-flight requests are done processing as well.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464590410","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-464590410","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":464590410,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDU5MDQxMA==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-02-18T05:28:54Z","updated_at":"2019-02-18T05:28:54Z","author_association":"CONTRIBUTOR","body":"Another failure:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+internalClusterTest/1412\r\n```\r\n\r\n==> Test Info: seed=407BCF06300EDC8C; jvms=8; suites=12\r\n--\r\nTests with failures:\r\n- org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.testFullClusterRestart\r\n- org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT (suite)\r\nSlow Tests Summary:\r\n86.36s \\| org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT\r\n66.01s \\| org.elasticsearch.xpack.ml.integration.BasicDistributedJobsIT\r\n49.17s \\| org.elasticsearch.xpack.ml.integration.TooManyJobsIT\r\n29.09s \\| org.elasticsearch.xpack.ml.integration.EstablishedMemUsageIT\r\n23.96s \\| org.elasticsearch.xpack.ml.integration.NetworkDisruptionIT\r\n```\r\n\r\n```\r\n04:46:43   1> \tat org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n04:46:43   1> \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:393) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n04:46:43   1> \tat org.elasticsearch.client.FilterClient.doExecute(FilterClient.java:65) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n04:46:43   1> \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:393) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n04:46:43   1> \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:382) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n04:46:43   1> \t... 37 more\r\n04:46:43   1> [2019-02-18T05:45:49,765][INFO ][o.e.x.m.i.MlDistributedFailureIT] [testFullClusterRestart] [MlDistributedFailureIT#testFullClusterRestart]: cleaning up after test\r\n04:46:43   1> [2019-02-18T05:45:49,766][INFO ][o.e.n.Node               ] [testFullClusterRestart] stopping ...\r\n04:46:43   1> [2019-02-18T05:45:49,785][INFO ][o.e.n.Node               ] [testFullClusterRestart] stopped\r\n04:46:43   1> [2019-02-18T05:45:49,785][INFO ][o.e.n.Node               ] [testFullClusterRestart] closing ...\r\n04:46:43   1> [2019-02-18T05:45:49,788][INFO ][o.e.n.Node               ] [testFullClusterRestart] closed\r\n04:46:43   1> [2019-02-18T05:45:49,789][INFO ][o.e.n.Node               ] [testFullClusterRestart] stopping ...\r\n04:46:43   1> [2019-02-18T05:45:49,804][INFO ][o.e.n.Node               ] [testFullClusterRestart] stopped\r\n04:46:43   1> [2019-02-18T05:45:49,804][INFO ][o.e.n.Node               ] [testFullClusterRestart] closing ...\r\n04:46:43   1> [2019-02-18T05:45:49,809][INFO ][o.e.n.Node               ] [testFullClusterRestart] closed\r\n04:46:43   1> [2019-02-18T05:45:49,809][INFO ][o.e.x.m.i.MlDistributedFailureIT] [testFullClusterRestart] after test\r\n04:46:43 ERROR   2.19s J1 | MlDistributedFailureIT.testFullClusterRestart <<< FAILURES!\r\n04:46:43    > Throwable #1: java.lang.AssertionError: {org.apache.lucene.index.IndexReader$CacheKey@431efb34=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@94f55c5}\r\n04:46:43    > \tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:191)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:145)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.closeWhileHandlingException(IOUtils.java:130)\r\n04:46:43    > \tat org.elasticsearch.indices.IndicesService.doClose(IndicesService.java:284)\r\n04:46:43    > \tat org.elasticsearch.common.component.AbstractLifecycleComponent.close(AbstractLifecycleComponent.java:100)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:61)\r\n04:46:43    > \tat org.elasticsearch.node.NodeService.close(NodeService.java:135)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n04:46:43    > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:85)\r\n04:46:43    > \tat org.elasticsearch.node.Node.close(Node.java:857)\r\n04:46:43    > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.close(InternalTestCluster.java:1044)\r\n04:46:43    > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.closeForRestart(InternalTestCluster.java:966)\r\n04:46:43    > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1888)\r\n04:46:43    > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1773)\r\n04:46:43    > \tat \r\n```\r\n\r\nSince there's an approved PR that might fix this, I'm not going to mute the test, but if we can't get that fix in soon we'll need to.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464736630","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-464736630","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":464736630,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDczNjYzMA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-02-18T13:45:25Z","updated_at":"2019-02-18T13:45:25Z","author_association":"CONTRIBUTOR","body":"Agreed, this should have been muted earlier.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464796686","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-464796686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":464796686,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDc5NjY4Ng==","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"created_at":"2019-02-18T16:21:11Z","updated_at":"2019-02-18T16:21:11Z","author_association":"CONTRIBUTOR","body":"Unfortunately https://github.com/elastic/elasticsearch/issues/37117 hasn't fixed the issue.\r\n\r\nThis build has the fix but still fails:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+release-tests/465/consoleFull","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464810825","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-464810825","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":464810825,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDgxMDgyNQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-02-18T17:01:41Z","updated_at":"2019-02-18T17:01:41Z","author_association":"CONTRIBUTOR","body":"Thanks @hendrikmuhs I'll look.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465068968","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-465068968","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":465068968,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTA2ODk2OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-02-19T10:07:40Z","updated_at":"2019-02-19T10:07:40Z","author_association":"CONTRIBUTOR","body":"So it looks like there was an issue with ongoing search requests, but it's not what we have seen in the above test failures (or at least not the only problem that we have seen) given that the stack trace suggests that all indices were already closed when the node got closed. I've opened another pull request (#39099) which fixes some minor issues that I don't expect to be the root cause of what we are seeing here, and which should also make debugging easier. Please don't mute the test yet I'd like to collect some more information.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465076044","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-465076044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":465076044,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTA3NjA0NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-19T10:28:48Z","updated_at":"2019-02-19T10:28:48Z","author_association":"CONTRIBUTOR","body":"Since the `MlMemoryTracker` is the thing that's causing search requests to be started while the node is closing it's probably best if I make `MlLifeCycleService.stop()` tell the `MlMemoryTracker` not to start any more searches and wait for in-progress searches to complete (even though \"completion\" will sometimes mean failing because the other nodes in the cluster have been shut down).\r\n\r\nSince `Node.stop()` is called at the very beginning of `Node.close()` this should fix it.\r\n\r\nI'll work on this today.\r\n\r\nIt looks like lots of components get closed before plugins in `Node.close()`, so trying to make all of them robust to outstanding searches is going to be a long-winded exercise.\r\n\r\nSorry for the disruption to your schedule @jpountz - I should have realised what was going on much earlier.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465081540","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-465081540","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":465081540,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTA4MTU0MA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-02-19T10:45:27Z","updated_at":"2019-02-19T10:45:27Z","author_association":"CONTRIBUTOR","body":"No worries at all @droberts195. I feel like we have an actual bug that the current behavior of `MlLifkeCycleService` is only more likely to expose. +1 to stop firing new requests in stop() though.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466949747","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-466949747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":466949747,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Njk0OTc0Nw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-25T10:00:16Z","updated_at":"2019-02-25T10:00:16Z","author_association":"CONTRIBUTOR","body":"This happened again in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+internalClusterTest/1179/consoleText\r\n\r\nThis included my change to stop the ML memory tracker as part of `Node.stop` before components get closed.\r\n\r\nThe exception has moved on from previous occurrences - now it says no master node:\r\n\r\n```\r\n  1> [2019-02-24T15:07:04,458][INFO ][o.e.x.m.i.MlDistributedFailureIT] [testFullClusterRestart] after test\r\nERROR   11.4s J1 | MlDistributedFailureIT.testFullClusterRestart <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: {org.apache.lucene.index.IndexReader$CacheKey@533b697c=org.elasticsearch.indices.IndicesQueryCache$StatsAndCount@31412048}\r\n   > \tat org.elasticsearch.indices.IndicesQueryCache.close(IndicesQueryCache.java:191)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:61)\r\n   > \tat org.elasticsearch.indices.IndicesService$2.closeInternal(IndicesService.java:265)\r\n   > \tat org.elasticsearch.common.util.concurrent.AbstractRefCounted.decRef(AbstractRefCounted.java:63)\r\n   > \tat org.elasticsearch.indices.IndicesService.doClose(IndicesService.java:309)\r\n   > \tat org.elasticsearch.common.component.AbstractLifecycleComponent.close(AbstractLifecycleComponent.java:100)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:61)\r\n   > \tat org.elasticsearch.node.NodeService.close(NodeService.java:135)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:103)\r\n   > \tat org.elasticsearch.core.internal.io.IOUtils.close(IOUtils.java:85)\r\n   > \tat org.elasticsearch.node.Node.close(Node.java:857)\r\n   > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.close(InternalTestCluster.java:1051)\r\n   > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.closeForRestart(InternalTestCluster.java:972)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1892)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.fullRestart(InternalTestCluster.java:1765)\r\n   > \tat org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.lambda$testFullClusterRestart$5(MlDistributedFailureIT.java:113)\r\n   > \tat org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.run(MlDistributedFailureIT.java:286)\r\n   > \tat org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT.testFullClusterRestart(MlDistributedFailureIT.java:111)\r\n   > \tat java.lang.Thread.run(Thread.java:748)Throwable #2: java.lang.RuntimeException: Had to resort to force-stopping datafeed, something went wrong?\r\n   > \tat org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.deleteAllDatafeeds(BaseMlIntegTestCase.java:294)\r\n   > \tat org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.cleanupWorkaround(BaseMlIntegTestCase.java:207)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n   > Caused by: java.util.concurrent.ExecutionException: MasterNotDiscoveredException[no known master node]\r\n   > \tat org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:266)\r\n   > \tat org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:253)\r\n   > \tat org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87)\r\n   > \tat org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.deleteAllDatafeeds(BaseMlIntegTestCase.java:282)\r\n   > \t... 36 more\r\n   > Caused by: MasterNotDiscoveredException[no known master node]\r\n   > \tat org.elasticsearch.xpack.ml.action.TransportStopDatafeedAction.doExecute(TransportStopDatafeedAction.java:108)\r\n   > \tat org.elasticsearch.xpack.ml.action.TransportStopDatafeedAction.doExecute(TransportStopDatafeedAction.java:43)\r\n   > \tat org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:145)\r\n   > \tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:121)\r\n   > \tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:64)\r\n   > \tat org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83)\r\n   > \tat org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72)\r\n   > \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:393)\r\n   > \tat org.elasticsearch.client.FilterClient.doExecute(FilterClient.java:65)\r\n   > \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:393)\r\n   > \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:382)\r\n   > \tat org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.deleteAllDatafeeds(BaseMlIntegTestCase.java:281)\r\n   > \t... 36 moreThrowable #3: java.lang.RuntimeException: already closed\r\n   > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.getOrBuildNodeClient(InternalTestCluster.java:925)\r\n   > \tat org.elasticsearch.test.InternalTestCluster$NodeAndClient.client(InternalTestCluster.java:904)\r\n   > \tat org.elasticsearch.test.InternalTestCluster$2.next(InternalTestCluster.java:2338)\r\n   > \tat org.elasticsearch.test.InternalTestCluster$2.next(InternalTestCluster.java:2329)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.ensureClusterStateConsistency(ESIntegTestCase.java:1134)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.afterInternal(ESIntegTestCase.java:572)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.cleanUpCluster(ESIntegTestCase.java:2191)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe log confirms that the ML memory tracker is stopped before this happens:\r\n\r\n```\r\n  1> [2019-02-24T15:07:17,363][DEBUG][o.e.x.m.p.MlMemoryTracker] [testJobRelocationIsMemoryAware] ML memory tracker stopped\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466951466","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-466951466","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":466951466,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Njk1MTQ2Ng==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2019-02-25T10:05:11Z","updated_at":"2019-02-25T10:12:58Z","author_association":"CONTRIBUTOR","body":"[build-stats](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-1y,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'stacktrace:%22org.elasticsearch.indices.IndicesQueryCache.close%22'),sort:!(time,desc))) link","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/476114159","html_url":"https://github.com/elastic/elasticsearch/issues/37117#issuecomment-476114159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37117","id":476114159,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjExNDE1OQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-03-25T09:20:52Z","updated_at":"2019-03-25T09:20:52Z","author_association":"CONTRIBUTOR","body":"Since the fixes of #39099 21 days ago the build stats link only shows one failure on 7.x and above.  (It has failed a few more times on 6.6 and 6.7, but they don't have that fix.)\r\n\r\nThat one failure was in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+matrix-java-periodic/ES_BUILD_JAVA=openjdk12,ES_RUNTIME_JAVA=java8fips,nodes=immutable&&linux&&docker/82/, which is on a FIPS JVM and also a number of other tests related to splitting indices also failed, so there may be some interaction there.\r\n\r\nSo it's looking like a combination of #39111 and #39099 have fixed the problems that lead to this issue being raised.  #39111 is in 6.6.2 and above; #39099 is in 7.1.0 and above.","performed_via_github_app":null}]