[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443966640","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-443966640","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":443966640,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0Mzk2NjY0MA==","user":{"login":"howardhuanghua","id":15325213,"node_id":"MDQ6VXNlcjE1MzI1MjEz","avatar_url":"https://avatars0.githubusercontent.com/u/15325213?v=4","gravatar_id":"","url":"https://api.github.com/users/howardhuanghua","html_url":"https://github.com/howardhuanghua","followers_url":"https://api.github.com/users/howardhuanghua/followers","following_url":"https://api.github.com/users/howardhuanghua/following{/other_user}","gists_url":"https://api.github.com/users/howardhuanghua/gists{/gist_id}","starred_url":"https://api.github.com/users/howardhuanghua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/howardhuanghua/subscriptions","organizations_url":"https://api.github.com/users/howardhuanghua/orgs","repos_url":"https://api.github.com/users/howardhuanghua/repos","events_url":"https://api.github.com/users/howardhuanghua/events{/privacy}","received_events_url":"https://api.github.com/users/howardhuanghua/received_events","type":"User","site_admin":false},"created_at":"2018-12-04T04:25:04Z","updated_at":"2018-12-04T04:25:04Z","author_association":"CONTRIBUTOR","body":"We have updated _cluster/settings rest level API to reject setting \"cluster.routing.allocation.node_concurrent_recoveries\" up to 50+ for workaround.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/444406086","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-444406086","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":444406086,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NDQwNjA4Ng==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-12-05T08:48:33Z","updated_at":"2018-12-05T08:48:33Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/446154872","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-446154872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":446154872,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NjE1NDg3Mg==","user":{"login":"Ethan-Zhang","id":3809645,"node_id":"MDQ6VXNlcjM4MDk2NDU=","avatar_url":"https://avatars1.githubusercontent.com/u/3809645?v=4","gravatar_id":"","url":"https://api.github.com/users/Ethan-Zhang","html_url":"https://github.com/Ethan-Zhang","followers_url":"https://api.github.com/users/Ethan-Zhang/followers","following_url":"https://api.github.com/users/Ethan-Zhang/following{/other_user}","gists_url":"https://api.github.com/users/Ethan-Zhang/gists{/gist_id}","starred_url":"https://api.github.com/users/Ethan-Zhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ethan-Zhang/subscriptions","organizations_url":"https://api.github.com/users/Ethan-Zhang/orgs","repos_url":"https://api.github.com/users/Ethan-Zhang/repos","events_url":"https://api.github.com/users/Ethan-Zhang/events{/privacy}","received_events_url":"https://api.github.com/users/Ethan-Zhang/received_events","type":"User","site_admin":false},"created_at":"2018-12-11T10:38:21Z","updated_at":"2018-12-11T10:38:21Z","author_association":"NONE","body":"shall we use ```org.elasticsearch.transport.txGet(long timeout, TimeUnit unit)``` instead of ```txGet()``` to avoid deadlock?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/446196895","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-446196895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":446196895,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NjE5Njg5NQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-12-11T13:11:21Z","updated_at":"2018-12-11T13:11:21Z","author_association":"CONTRIBUTOR","body":"@howardhuanghua thanks for reporting this. This is indeed an issue if the number of concurrent recoveries from a node are higher than the max size of the GENERIC thread pool (which is some value >=128, depending on the number of processors). That said, typically you should not have so many shards per node, and allowing such a high number of `node_concurrent_recoveries` will also not play well with other parts of the system (e.g. shard balancer). Fixing this will require moving this code to be async, which is not a small thing to do. In the meanwhile, we can think about adding a soft-limit to the `node_concurrent_recoveries` setting.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/446948836","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-446948836","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":446948836,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0Njk0ODgzNg==","user":{"login":"howardhuanghua","id":15325213,"node_id":"MDQ6VXNlcjE1MzI1MjEz","avatar_url":"https://avatars0.githubusercontent.com/u/15325213?v=4","gravatar_id":"","url":"https://api.github.com/users/howardhuanghua","html_url":"https://github.com/howardhuanghua","followers_url":"https://api.github.com/users/howardhuanghua/followers","following_url":"https://api.github.com/users/howardhuanghua/following{/other_user}","gists_url":"https://api.github.com/users/howardhuanghua/gists{/gist_id}","starred_url":"https://api.github.com/users/howardhuanghua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/howardhuanghua/subscriptions","organizations_url":"https://api.github.com/users/howardhuanghua/orgs","repos_url":"https://api.github.com/users/howardhuanghua/repos","events_url":"https://api.github.com/users/howardhuanghua/events{/privacy}","received_events_url":"https://api.github.com/users/howardhuanghua/received_events","type":"User","site_admin":false},"created_at":"2018-12-13T12:18:06Z","updated_at":"2018-12-13T12:18:06Z","author_association":"CONTRIBUTOR","body":"@ywelsch, thanks for your comment. Currently, we limit node_concurrent_recoveries setting <=50 in our product environment version based on 6.4.3 as follow,\r\n```\r\nRestClusterUpdateSettingsAction.java prepareRequest function:\r\n\r\n        Settings settings = EMPTY_SETTINGS;\r\n        if (source.containsKey(TRANSIENT)) {\r\n            clusterUpdateSettingsRequest.transientSettings((Map) source.get(TRANSIENT));\r\n            settings = clusterUpdateSettingsRequest.transientSettings();\r\n        }\r\n        if (source.containsKey(PERSISTENT)) {\r\n            clusterUpdateSettingsRequest.persistentSettings((Map) source.get(PERSISTENT));\r\n            settings = clusterUpdateSettingsRequest.persistentSettings();\r\n        }\r\n        \r\n        // we limit node concurrent recoveries, as if incoming+outgoing up to generic thread pool would potentially cause cluster hang.\r\n        if (settings.getAsInt(ThrottlingAllocationDecider.CLUSTER_ROUTING_ALLOCATION_NODE_CONCURRENT_RECOVERIES_SETTING.getKey(), 0) > MAX_CONCURRENT_RECOVERIES\r\n                || settings.getAsInt(ThrottlingAllocationDecider.CLUSTER_ROUTING_ALLOCATION_NODE_CONCURRENT_INCOMING_RECOVERIES_SETTING.getKey(), 0) > MAX_CONCURRENT_RECOVERIES\r\n                || settings.getAsInt(ThrottlingAllocationDecider.CLUSTER_ROUTING_ALLOCATION_NODE_CONCURRENT_OUTGOING_RECOVERIES_SETTING.getKey(), 0) > MAX_CONCURRENT_RECOVERIES) {\r\n            throw new IllegalArgumentException(\"Can't set node concurrent recoveries greater than \" + MAX_CONCURRENT_RECOVERIES +\".\");\r\n        }\r\n```\r\nPlease give us some suggestions if you have, thanks a lot.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/512639709","html_url":"https://github.com/elastic/elasticsearch/issues/36195#issuecomment-512639709","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36195","id":512639709,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMjYzOTcwOQ==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-07-18T02:30:35Z","updated_at":"2019-07-18T02:30:35Z","author_association":"MEMBER","body":"Peer recovery is now non-blocking on both sides (except the relocation handoff step). I am closing this issue as making the handoff step async is optional. @howardhuanghua Thank you for reporting this.","performed_via_github_app":null}]