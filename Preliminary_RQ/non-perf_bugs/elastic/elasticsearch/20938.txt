{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20938","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20938/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20938/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20938/events","html_url":"https://github.com/elastic/elasticsearch/issues/20938","id":182997223,"node_id":"MDU6SXNzdWUxODI5OTcyMjM=","number":20938,"title":"HTTP module does not regard Connection: Close in v5.0.0","user":{"login":"algestam","id":133108,"node_id":"MDQ6VXNlcjEzMzEwOA==","avatar_url":"https://avatars2.githubusercontent.com/u/133108?v=4","gravatar_id":"","url":"https://api.github.com/users/algestam","html_url":"https://github.com/algestam","followers_url":"https://api.github.com/users/algestam/followers","following_url":"https://api.github.com/users/algestam/following{/other_user}","gists_url":"https://api.github.com/users/algestam/gists{/gist_id}","starred_url":"https://api.github.com/users/algestam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/algestam/subscriptions","organizations_url":"https://api.github.com/users/algestam/orgs","repos_url":"https://api.github.com/users/algestam/repos","events_url":"https://api.github.com/users/algestam/events{/privacy}","received_events_url":"https://api.github.com/users/algestam/received_events","type":"User","site_admin":false},"labels":[{"id":152517143,"node_id":"MDU6TGFiZWwxNTI1MTcxNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/REST%20API","name":":Core/Infra/REST API","color":"0e8a16","default":false,"description":"REST infrastructure and utilities"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":442569761,"node_id":"MDU6TGFiZWw0NDI1Njk3NjE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0","name":"v5.0.0","color":"dddddd","default":false,"description":null},{"id":334286612,"node_id":"MDU6TGFiZWwzMzQyODY2MTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-alpha1","name":"v6.0.0-alpha1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-10-14T08:56:16Z","updated_at":"2017-05-09T08:14:53Z","closed_at":"2016-10-16T17:18:09Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0.0-rc1\n\n**Plugins installed**: []\n\n**JVM version**: Java(TM) SE Runtime Environment (build 1.8.0_101-b13)\n\n**OS version**: Ubuntu 16.04 x64\n\n**Description of the problem including expected versus actual behavior**:\n\nWhen setting up a simple monitoring solution for a test instance of elasticsearch 5.0.0 with Nagios, I observed that the Nagios check program `check_http` fails with a socket timeout error:\n\n```\nuser@host:/usr/lib/nagios/plugins# ./check_http -H elasticsearch -p 9200\nCRITICAL - Socket timeout after 10 seconds\n```\n\nThis was a bit strange since it works ok when running on older versions of elasticsearch (tested with 2.3.3).\n\nInvestigated a bit further to check what the `check_http` actually does and tried to replicate the behaviour with netcat revealed a difference between the older elasticsearch installation and the 5.0.0 installation where elasticsearch previously closes a HTTP connection if the request header contains `Connection: Close` where 5.0.0 does not.\n\nThe workaround for getting the Nagios check program to work is to use the `-N` flag that doesn't wait for the document body but simply stops reading after the headers.\n\n**Steps to reproduce**:\n1. Make an API request to elasticsearch with netcat:\n   \n   ```\n   user@host:/# ncat elasticsearchhost 9200\n   GET / HTTP/1.1\n   User-Agent: check_http/v2.1.2 (monitoring-plugins 2.1.2)\n   Connection: Close\n   Host: elasticsearchhost\n   ```\n2. Press enter to view the response\n   \n   ```\n   HTTP/1.1 200 OK\n   content-type: application/json; charset=UTF-8\n   content-length: 351\n   \n   {\n     \"name\" : \"j0-yZSR\",\n     \"cluster_name\" : \"logs\",\n     \"cluster_uuid\" : \"kozqvcWRSxuyRUABAKcINQ\",\n     \"version\" : {\n       \"number\" : \"5.0.0-rc1\",\n       \"build_hash\" : \"13e62e1\",\n       \"build_date\" : \"2016-10-07T16:52:58.798Z\",\n       \"build_snapshot\" : false,\n       \"lucene_version\" : \"6.2.0\"\n     },\n     \"tagline\" : \"You Know, for Search\"\n   }\n   ```\n3. Press enter twice after receiving the response. The server should close the connection but it doesn't. When trying the same procedure on 2.3.3 it closes the connection correctly.\n\nAlso, if changing the header when testing on 2.3.3 to not contain the `Connection: Close` directive, 2.3.3 correctly changes the behavior to keep-alive and will not close the connection.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}