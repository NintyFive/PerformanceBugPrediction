{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8531","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8531/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8531/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8531/events","html_url":"https://github.com/elastic/elasticsearch/issues/8531","id":49207122,"node_id":"MDU6SXNzdWU0OTIwNzEyMg==","number":8531,"title":"Index corruption with delete by query","user":{"login":"mitallast","id":531623,"node_id":"MDQ6VXNlcjUzMTYyMw==","avatar_url":"https://avatars1.githubusercontent.com/u/531623?v=4","gravatar_id":"","url":"https://api.github.com/users/mitallast","html_url":"https://github.com/mitallast","followers_url":"https://api.github.com/users/mitallast/followers","following_url":"https://api.github.com/users/mitallast/following{/other_user}","gists_url":"https://api.github.com/users/mitallast/gists{/gist_id}","starred_url":"https://api.github.com/users/mitallast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitallast/subscriptions","organizations_url":"https://api.github.com/users/mitallast/orgs","repos_url":"https://api.github.com/users/mitallast/repos","events_url":"https://api.github.com/users/mitallast/events{/privacy}","received_events_url":"https://api.github.com/users/mitallast/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-11-18T10:55:00Z","updated_at":"2014-11-18T11:16:29Z","closed_at":"2014-11-18T11:16:29Z","author_association":"NONE","active_lock_reason":null,"body":"I have index with parent \"model\" and child \"sell\" documents at one index with millions of documents and heavy concurrent indexing.\n\nAll nodes works with Oracle Hotspot 8 with 30gb heap, ElasticSearch 1.3.5.\n\nI'm execute delete by query like this:\n\n```\ncurl -XDELETE 'http://127.0.0.1:9200/sells/sell/_query' -d '{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":{\"filters\":[{\"term\":{\"client_id\":123}}]}}}}}]}'\n```\n\nand our index is corrupted with this error message and exception stack trace in logs:\n\n```\n[2014-11-18 12:49:33,650][DEBUG][action.deletebyquery     ] [elastic1] [sells][3], node[hv2718pkQm-5SZq7agcY9g], [P], s[STARTED]: Failed to execute [delete_by_query {[sells][sell], query [{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":{\"filters\":[{\"term\":{\"client_id\":123}}]}}}}}]}] \norg.elasticsearch.index.engine.RefreshFailedEngineException: [sells][3] Refresh failed \n        at org.elasticsearch.index.engine.internal.InternalEngine.refresh(InternalEngine.java:789) \n        at org.elasticsearch.index.engine.internal.InternalEngine.delete(InternalEngine.java:686) \n        at org.elasticsearch.index.shard.service.InternalIndexShard.deleteByQuery(InternalIndexShard.java:465) \n        at org.elasticsearch.action.deletebyquery.TransportShardDeleteByQueryAction.shardOperationOnPrimary(TransportShardDeleteByQueryAction.java:123) \n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:535) \n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction$1.run(TransportShardReplicationOperationAction.java:434) \n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) \n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) \n        at java.lang.Thread.run(Thread.java:745) \nCaused by: java.lang.IllegalStateException: parentFilter must return FixedBitSet; got org.apache.lucene.search.BitsFilteredDocIdSet@74ebc73d \n        at org.elasticsearch.index.search.nested.IncludeNestedDocsQuery$IncludeNestedDocsWeight.scorer(IncludeNestedDocsQuery.java:123) \n        at org.apache.lucene.search.QueryWrapperFilter$1.iterator(QueryWrapperFilter.java:59) \n        at org.apache.lucene.index.BufferedUpdatesStream.applyQueryDeletes(BufferedUpdatesStream.java:554) \n        at org.apache.lucene.index.BufferedUpdatesStream.applyDeletesAndUpdates(BufferedUpdatesStream.java:287) \n        at org.apache.lucene.index.IndexWriter.applyAllDeletesAndUpdates(IndexWriter.java:3322) \n        at org.apache.lucene.index.IndexWriter.maybeApplyDeletes(IndexWriter.java:3313) \n        at org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:425) \n        at org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:292) \n        at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:267) \n        at org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:257) \n        at org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:171) \n        at org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:118) \n        at org.apache.lucene.search.SearcherManager.refreshIfNeeded(SearcherManager.java:58) \n        at org.apache.lucene.search.ReferenceManager.doMaybeRefresh(ReferenceManager.java:176) \n        at org.apache.lucene.search.ReferenceManager.maybeRefresh(ReferenceManager.java:225) \n        at org.elasticsearch.index.engine.internal.InternalEngine.refresh(InternalEngine.java:779) \n        ... 8 more\n```\n\nI cannot reproduce this error on our test stand cluster, sorry. It's seems like a concurrent access error.\n\nWhat's a kind of problem? Does it just bug?\n","closed_by":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"performed_via_github_app":null}