{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9021","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9021/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9021/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9021/events","html_url":"https://github.com/elastic/elasticsearch/issues/9021","id":52546583,"node_id":"MDU6SXNzdWU1MjU0NjU4Mw==","number":9021,"title":"Aggregations: Top-level filters not being considered","user":{"login":"jsnod","id":1916150,"node_id":"MDQ6VXNlcjE5MTYxNTA=","avatar_url":"https://avatars2.githubusercontent.com/u/1916150?v=4","gravatar_id":"","url":"https://api.github.com/users/jsnod","html_url":"https://github.com/jsnod","followers_url":"https://api.github.com/users/jsnod/followers","following_url":"https://api.github.com/users/jsnod/following{/other_user}","gists_url":"https://api.github.com/users/jsnod/gists{/gist_id}","starred_url":"https://api.github.com/users/jsnod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jsnod/subscriptions","organizations_url":"https://api.github.com/users/jsnod/orgs","repos_url":"https://api.github.com/users/jsnod/repos","events_url":"https://api.github.com/users/jsnod/events{/privacy}","received_events_url":"https://api.github.com/users/jsnod/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-12-20T01:25:24Z","updated_at":"2014-12-22T08:54:45Z","closed_at":"2014-12-22T08:54:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In v1.4.1, I've noticed that when running aggregations over documents that have been filtered with a top-level filter, the aggregation is not respecting the filter and is instead operating over _all_ documents.\n\nSimple testcase:\n\n``` javascript\nDELETE /filter_agg_test\nPUT /filter_agg_test/game_event/1\n{\"name\":\"Gretzky\",\"action\":\"goal\"}\nPUT /filter_agg_test/game_event/2\n{\"name\":\"Gretzky\",\"action\":\"assist\"}\nPUT /filter_agg_test/game_event/3\n{\"name\":\"McSorley\",\"action\":\"hit\"}\nPUT /filter_agg_test/game_event/4\n{\"name\":\"Gretzky\",\"action\":\"goal\"}\nPUT /filter_agg_test/game_event/5\n{\"name\":\"Kurri\",\"action\":\"goal\"}\n```\n\nAt this point our index contains documents representing goal totals like so:\n\n```\nGretzky : 2 goals\nKurri   : 1 goal\nMcSorley: 0 goals\n```\n\nHowever, if you run a `terms` aggregation on the `name` field after first running a `term` filter on `action=goal` our aggregation returns McSorley in the buckets:\n\n``` javascript\nGET /filter_agg_test/game_event/_search\n{\n  \"filter\": {\n    \"term\": {\n      \"action\": \"goal\"\n    }\n  },\n  \"aggs\": {\n    \"names\": {\n      \"terms\": {\n        \"field\": \"name\"\n      }\n    }\n  },\n  \"size\": 0\n}\n\nResults:\n   \"aggregations\": {\n      \"names\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"gretzky\",\n               \"doc_count\": 3\n            },\n            {\n               \"key\": \"kurri\",\n               \"doc_count\": 1\n            },\n            {\n               \"key\": \"mcsorley\",\n               \"doc_count\": 1\n            }\n         ]\n      }\n   }\n```\n\nMcSorley should not be present in those results because we used a top-level filter to return only goals.  McSorley has no goals.  It appears as if the aggregation is running over _all_ documents rather than the filtered documents.  You'll see that running the filter by itself works fine (notice no McSorley doc is returned):\n\n``` javascript\nGET /filter_agg_test/game_event/_search\n{\n  \"filter\": {\n    \"term\": {\n      \"action\": \"goal\"\n    }\n  }\n}\n\nResults:\n  \"hits\": {\n      \"total\": 3,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"filter_agg_test\",\n            \"_type\": \"game_event\",\n            \"_id\": \"4\",\n            \"_score\": 1,\n            \"_source\": {\n               \"name\": \"Gretzky\",\n               \"action\": \"goal\"\n            }\n         },\n         {\n            \"_index\": \"filter_agg_test\",\n            \"_type\": \"game_event\",\n            \"_id\": \"5\",\n            \"_score\": 1,\n            \"_source\": {\n               \"name\": \"Kurri\",\n               \"action\": \"goal\"\n            }\n         },\n         {\n            \"_index\": \"filter_agg_test\",\n            \"_type\": \"game_event\",\n            \"_id\": \"1\",\n            \"_score\": 1,\n            \"_source\": {\n               \"name\": \"Gretzky\",\n               \"action\": \"goal\"\n            }\n         }\n      ]\n   }\n```\n\nInterestingly, both filtered queries and filter aggregations work as expected:\n\n**Filtered Query**:\n\n``` javascript\nGET /filter_agg_test/game_event/_search\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"term\": {\n          \"action\": \"goal\"\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"names\": {\n      \"terms\": {\n        \"field\": \"name\"\n      }\n    }\n  },\n  \"size\": 0\n}\n\nResults:\n   \"aggregations\": {\n      \"names\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"gretzky\",\n               \"doc_count\": 2\n            },\n            {\n               \"key\": \"kurri\",\n               \"doc_count\": 1\n            }\n         ]\n      }\n   }\n```\n\n**Filter Aggregation**:\n\n``` javascript\nGET /filter_agg_test/game_event/_search\n{\n  \"aggs\": {\n    \"goals\": {\n      \"filter\": {\n        \"term\": {\n          \"action\": \"goal\"\n        }\n      },\n      \"aggs\": {\n        \"names\": {\n          \"terms\": {\n            \"field\": \"name\"\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n\nResults:\n  \"aggregations\": {\n      \"goals\": {\n         \"doc_count\": 3,\n         \"names\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n               {\n                  \"key\": \"gretzky\",\n                  \"doc_count\": 2\n               },\n               {\n                  \"key\": \"kurri\",\n                  \"doc_count\": 1\n               }\n            ]\n         }\n      }\n   }\n```\n\nExpected results: Aggregations take top-level filters into account.\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}