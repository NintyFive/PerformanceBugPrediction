{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24380","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24380/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24380/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24380/events","html_url":"https://github.com/elastic/elasticsearch/issues/24380","id":224954331,"node_id":"MDU6SXNzdWUyMjQ5NTQzMzE=","number":24380,"title":"Bootstrap mlockall check checks root not elasticsearch user.","user":{"login":"russmac","id":5924967,"node_id":"MDQ6VXNlcjU5MjQ5Njc=","avatar_url":"https://avatars1.githubusercontent.com/u/5924967?v=4","gravatar_id":"","url":"https://api.github.com/users/russmac","html_url":"https://github.com/russmac","followers_url":"https://api.github.com/users/russmac/followers","following_url":"https://api.github.com/users/russmac/following{/other_user}","gists_url":"https://api.github.com/users/russmac/gists{/gist_id}","starred_url":"https://api.github.com/users/russmac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/russmac/subscriptions","organizations_url":"https://api.github.com/users/russmac/orgs","repos_url":"https://api.github.com/users/russmac/repos","events_url":"https://api.github.com/users/russmac/events{/privacy}","received_events_url":"https://api.github.com/users/russmac/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2017-04-28T01:17:39Z","updated_at":"2017-04-28T04:22:18Z","closed_at":"2017-04-28T01:37:18Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.3.2\r\n\r\n**Plugins installed**: [ec2-discovery]\r\n\r\n**JVM version**: openjdk-8-jre-headless:amd64   8u121-b13-1~bpo8+1 \r\n\r\n**OS version**: Debian 8.7\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nBootstrap mlock check checks root user. `su -c 'ulimit -a' elasticsearch -s /bin/bash` shows elasticsearch as unlimited memory locking. However root is limited. This means root must be unlimited (or increased limit) for Elasticsearch to pass bootstrap checks.\r\n\r\n**Steps to reproduce**:\r\n 1. Set elasticsearch user unlimited in /etc/security/limits.conf\r\n```\r\n#/etc/security/limits.conf\r\nelasticsearch soft memlock unlimited\r\nelasticsearch hard memlock unlimited\r\n```\r\n 2. Start SysVinit elasticsearch script installed by Elasticsearch debian package.\r\n 3. Check logs to see memory locking bootstrap check failed. Advising to apply the currently applied ulimits to elasticsearch user.\r\n```\r\n[2017-04-28T01:13:17,948][WARN ][o.e.b.JNANatives         ] Unable to lock JVM Memory: error=12, reason=Cannot allocate memory\r\n[2017-04-28T01:13:17,950][WARN ][o.e.b.JNANatives         ] This can result in part of the JVM being swapped out.\r\n[2017-04-28T01:13:17,950][WARN ][o.e.b.JNANatives         ] Increase RLIMIT_MEMLOCK, soft limit: 65536, hard limit: 65536\r\n[2017-04-28T01:13:17,951][WARN ][o.e.b.JNANatives         ] These can be adjusted by modifying /etc/security/limits.conf, for example: \r\n\t# allow user 'elasticsearch' mlockall\r\n\telasticsearch soft memlock unlimited\r\n\telasticsearch hard memlock unlimited\r\n```\r\n\r\nSysVinit script contains ES user vars correctly and the first process is run as elasticsearch.\r\n```\r\n# Run Elasticsearch as this user ID and group ID\r\nES_USER=elasticsearch\r\nES_GROUP=elasticsearch\r\n```\r\nUnlimiting root memory locking in /etc/security/limits.conf resolves the issue.\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}