[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138473061","html_url":"https://github.com/elastic/elasticsearch/issues/13305#issuecomment-138473061","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13305","id":138473061,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODQ3MzA2MQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-09-08T08:19:59Z","updated_at":"2015-09-08T08:19:59Z","author_association":"MEMBER","body":"This test fails regularly the last 3 weeks:\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/es_core_master_window-2012/1711/\nProject:    es_core_master_window-2012\nRandomization:  8u11,network,heap[1024m],-server +UseConcMarkSweepGC -UseCompressedOops +AggressiveOpts\nDate of build:  Mon, 07 Sep 2015 21:32:27 +0000\nBuild duration: 2 hr 46 min\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/es_core_master_window-2012/1694/\nProject:    es_core_master_window-2012\nRandomization:  8u11,network,heap[512m],-server +UseParallelGC -UseCompressedOops +AggressiveOpts\nDate of build:  Fri, 04 Sep 2015 16:11:54 +0000\nBuild duration: 2 hr 53 min\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/elasticsearch-20-win2012/131/\nProject:    elasticsearch-20-win2012\nRandomization:  8u11,network,heap[512m],-server +UseSerialGC -UseCompressedOops +AggressiveOpts\nDate of build:  Thu, 03 Sep 2015 01:14:29 +0000\nBuild duration: 2 hr 45 min\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/es_core_master_window-2012/1676/\nProject:    es_core_master_window-2012\nRandomization:  7u55,network,heap[1024m],-server +UseConcMarkSweepGC -UseCompressedOops,assert off\nDate of build:  Tue, 01 Sep 2015 15:02:56 +0000\nBuild duration: 2 hr 47 min\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/elasticsearch-20-win2012/98/\nProject:    elasticsearch-20-win2012\nRandomization:  7u55,network,heap[936m],-server +UseParallelGC +UseCompressedOops\nDate of build:  Fri, 28 Aug 2015 00:42:24 +0000\nBuild duration: 2 hr 45 min\n\n---\n\nBuild URL   http://build-us-00.elastic.co/job/elasticsearch-20-win2008/67/\nProject:    elasticsearch-20-win2008\nRandomization:  7u55,network,heap[512m],-server +UseConcMarkSweepGC -UseCompressedOops\nDate of build:  Thu, 20 Aug 2015 19:48:41 +0000\nBuild duration: 1 hr 59 min\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138600921","html_url":"https://github.com/elastic/elasticsearch/issues/13305#issuecomment-138600921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13305","id":138600921,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODYwMDkyMQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2015-09-08T15:30:03Z","updated_at":"2015-09-08T15:30:25Z","author_association":"MEMBER","body":"After looking at the test and the logs, it looks like all failures have the same scenario. \n\nI try to explain my understanding, hopefully I'm not completely wrong:\n\nThe four nodes are started in an asynchronous manner with min.master.nodes set to 3. Node_t0 starts first and try to find other nodes on localhost with unicast. While it tries successive ports,  node_t1, node_t2 and node_t3 also start (all nodes are started asynchronously).\n\nNode_t0 finally connects to another node (let's say, on the port used by node_t1) and gets back a `RemoteTransportException` because the remote node is still initializing and not yet started.\n\nThen the remote node is started and both nodes, node_t0 and node_t1 are connected.\n\nThe same thing happen for node_t2 and node_t3: node_t0 tries to connect and gets a remote exception, then nodes are able to connect to each other.\n\nBut once node_t0 is connected to node_1 and node_2 it elects itself as master:\n\n```\n[node_t0] elected as master, waiting for incoming joins ([2] needed)\n```\n\nand waits for join requests. \n\nAt this point, I suspect that the previous remote exceptions are handled and provoke the disconnection of node_t0 from nodes t1..t3:\n\n```\n[2015-09-04 18:30:57,932][DEBUG][discovery.zen            ] [node_t0] elected as master, waiting for incoming joins ([2] needed)\n[2015-09-04 18:30:57,932][DEBUG][transport.netty          ] [node_t0] disconnecting from [{#zen_unicast_8_YoSSyfnvSnmF0a8ViPEw7w#}{127.0.0.1}{127.0.0.1:9402}{mode=network, zone=b}] due to explicit disconnect call\n[2015-09-04 18:30:57,932][DEBUG][transport.netty          ] [node_t0] disconnecting from [{#zen_unicast_3#}{127.0.0.1}{127.0.0.1:9402}] due to explicit disconnect call\n[2015-09-04 18:30:57,932][DEBUG][transport.netty          ] [node_t0] disconnecting from [{#zen_unicast_6_ESxZGa4IQXymN4ZTTRD9kQ#}{127.0.0.1}{127.0.0.1:9401}{mode=network, zone=b}] due to explicit disconnect call\n[2015-09-04 18:30:57,932][DEBUG][transport.netty          ] [node_t0] disconnecting from [{#zen_unicast_7_ESxZGa4IQXymN4ZTTRD9kQ#}{127.0.0.1}{127.0.0.1:9401}{mode=network, zone=b}] due to explicit disconnect call\n```\n\nnode_t0 will wait for joins but nothing will come and after a given delay:\n\n```\n[2015-09-04 18:31:23,906][WARN ][discovery                ] [node_t0] waited for 30s and no initial state was set by the discovery\n[2015-09-04 18:31:23,906][DEBUG][gateway                  ] [node_t0] can't wait on start for (possibly) reading state from gateway, will do it asynchronously\n[2015-09-04 18:31:23,906][INFO ][node                     ] [node_t0] started\n```\n\nIn the meanwhile, the 3 other nodes keep chatting together and elect another as master:\n\n```\n[2015-09-04 18:31:01,177][DEBUG][discovery.zen            ] [node_t3] elected as master, waiting for incoming joins ([2] needed)\n```\n\nSince the 3 other nodes are correctly connected to each other, the test can create the index \"test\" with 5 shards / 1 replica that will be allocated on the 3 nodes. With the awareness settings, one of the node will get 5 shards allocated, 2 on another one and 3 on the last one.\n","performed_via_github_app":null}]