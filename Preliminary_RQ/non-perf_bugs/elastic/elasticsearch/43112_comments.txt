[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500928674","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-500928674","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":500928674,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDkyODY3NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-11T16:48:51Z","updated_at":"2019-06-11T16:48:51Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501176061","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-501176061","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":501176061,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTE3NjA2MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T08:36:54Z","updated_at":"2019-06-12T08:36:54Z","author_association":"MEMBER","body":"Note: reproduces on 7.2 but not on 7.x for me with the above seed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501193424","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-501193424","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":501193424,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTE5MzQyNA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T09:25:23Z","updated_at":"2019-06-12T09:25:23Z","author_association":"MEMBER","body":"The problem is an edge case where the above query is marked as cachable, but out test logic says its not, most likely because of the `\"query\" : \"NoWt\"` part. Maybe we need to be more carful with random string generation here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501621426","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-501621426","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":501621426,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTYyMTQyNg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-06-13T09:16:31Z","updated_at":"2019-06-13T09:16:31Z","author_association":"MEMBER","body":"For this query in particular:\r\n```\r\n\"simple_query_string\" : {\r\n        \"query\" : \"NoWt\",\r\n        \"flags\" : -1,\r\n        \"default_operator\" : \"or\",\r\n        \"analyze_wildcard\" : false,\r\n        \"quote_field_suffix\" : \"\",\r\n        \"auto_generate_synonyms_phrase_query\" : true,\r\n        \"fuzzy_prefix_length\" : 4,\r\n        \"fuzzy_max_expansions\" : 5,\r\n        \"fuzzy_transpositions\" : true,\r\n        \"boost\" : 1.0\r\n      }\r\n```\r\nthe test framework assumes it should be cacheable (the check in https://github.com/elastic/elasticsearch/blob/7.2/server/src/test/java/org/elasticsearch/index/query/FullTextQueryTestCase.java#L39 lowercases the query term before checking the prefix for \"now\") but in reality the JavaDateMathParser (and also the legacy Joda one) only handle now (and thus flip the \"cacheable\" flag in the seach context) when the prefix is an exact match (no lowercasing).\r\n\r\nI tried changing `FullTextQueryTestCase` to be case sensitive, but that creates other kind of problems with cases where we apply analysis to the query term before it potentially gets fed to a date field, so that doesn't work either.\r\n\r\nLooking at this I think we push too hard on the randomization and handling all edge cases in a generic way in these tests. I think we should exclude query terms that start with \"now\" in whatever case variation from the general test cases and by that avoid the tricky caching detection problems and instead add dedicated tests case just for these edge cases.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501626272","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-501626272","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":501626272,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTYyNjI3Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-06-13T09:30:20Z","updated_at":"2019-06-13T09:30:20Z","author_association":"MEMBER","body":"> I tried changing FullTextQueryTestCase to be case sensitive, but that creates other kind of problems with cases where we apply analysis to the query term before it potentially gets fed to a date field, so that doesn't work either.\r\n\r\nDo you have an example of this ? I could not think of a case where we'd modify the original term before  feeding it to an analyzer.\r\n\r\n> I tried changing FullTextQueryTestCase to be case sensitive, but that creates other kind of problems with cases where we apply analysis to the query term before it potentially gets fed to a date field, so that doesn't work either.\r\n\r\nI agree, if this turns too complicated we can ensure that the random query string doesn't start with `now` but I'd like to understand first why the current solution couldn't work if we don't ignore the case.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501629159","html_url":"https://github.com/elastic/elasticsearch/issues/43112#issuecomment-501629159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43112","id":501629159,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTYyOTE1OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-06-13T09:38:46Z","updated_at":"2019-06-13T09:38:46Z","author_association":"MEMBER","body":"We discussed offline and since we also randomize the forced `analyzer` that is used there is a chance that we lowercase the term. So +1 to remove the randomization to check if a query is cacheable and to make dedicated tests for it on  all full-text queries.","performed_via_github_app":null}]