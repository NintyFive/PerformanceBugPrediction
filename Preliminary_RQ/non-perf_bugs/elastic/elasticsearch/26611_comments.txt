[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329883543","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-329883543","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":329883543,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTg4MzU0Mw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2017-09-15T19:50:29Z","updated_at":"2017-09-15T19:50:41Z","author_association":"MEMBER","body":"@sherry-ger This does not reproduce for me. I have tried with and without xpack, using your example requests, on 5.5, 5.6 and master.  Is there something else about your setup that may be relevant?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330992611","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-330992611","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":330992611,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDk5MjYxMQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2017-09-20T21:56:58Z","updated_at":"2017-09-20T21:56:58Z","author_association":"MEMBER","body":"I was finally able to reproduce this, and it is due to a null Scorer being passed into painless from aggregations. @jpountz Can you or someone that knows aggs take a look? Also note this does not reproduce on 6.0 or master.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331073055","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-331073055","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":331073055,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTA3MzA1NQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T07:17:09Z","updated_at":"2017-09-21T07:17:09Z","author_association":"MEMBER","body":"Thanks @rjernst for digging into this. I'll work on a fix.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331084739","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-331084739","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":331084739,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTA4NDczOQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T08:11:02Z","updated_at":"2017-09-21T08:11:28Z","author_association":"MEMBER","body":"This issue occurs only when terms aggs are executed in `breath_first` mode (which is default here). With `depth_first` no error occurs. \r\n\r\n`BestBucketsDeferringCollector` does not create and delegate a scorer if the aggs are not using scores (`BestBucketsDeferringCollector.java` line 156 (5.6 branch)), which makes sense in this case. The problem is that in `AggregatorFactory.java` line 133, it just delegates a `null` scorer instance. I think that should be changed, if the scorer hasn't been set then the scorer shouldn't be delegated. Also it is just weird to supply a null scorer to `LeafCollector#setScorer(...)`. The jdocs don't mention what happens if someone does this, but I think many implementation will fail if they were supplied with a null scorer. @colings86 What do you think?\r\n\r\nAlthough the bug doesn't manifest in 6.0 and later, I think we should apply this fix on master, 6.x and 6.0 branches too. `ExpressionSearchScript` (and other impls) have been changed to be lenient with a null scorer. There is a TODO about this in `SearchScript#getScore()` method.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331095515","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-331095515","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":331095515,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTA5NTUxNQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T08:56:35Z","updated_at":"2017-09-21T08:56:35Z","author_association":"MEMBER","body":"@martijnvg I agree with all your points, we should not be trying to pass down a scorer if no scorer has been set. I also agree that the fix should be applied to 6.0 6.x and master branches too.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331097807","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-331097807","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":331097807,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTA5NzgwNw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T09:06:08Z","updated_at":"2017-09-21T09:06:08Z","author_association":"MEMBER","body":"Thanks @colings86. I'll open a PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331901629","html_url":"https://github.com/elastic/elasticsearch/issues/26611#issuecomment-331901629","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26611","id":331901629,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTkwMTYyOQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-09-25T14:36:34Z","updated_at":"2017-09-25T14:36:34Z","author_association":"CONTRIBUTOR","body":"Thanks @martijnvg !","performed_via_github_app":null}]