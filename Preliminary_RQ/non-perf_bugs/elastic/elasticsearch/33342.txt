{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33342","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33342/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33342/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33342/events","html_url":"https://github.com/elastic/elasticsearch/issues/33342","id":356378107,"node_id":"MDU6SXNzdWUzNTYzNzgxMDc=","number":33342,"title":"Memory leak in RestClient when elasticsearch takes more than 30 seconds to respond","user":{"login":"appadesai","id":19589270,"node_id":"MDQ6VXNlcjE5NTg5Mjcw","avatar_url":"https://avatars0.githubusercontent.com/u/19589270?v=4","gravatar_id":"","url":"https://api.github.com/users/appadesai","html_url":"https://github.com/appadesai","followers_url":"https://api.github.com/users/appadesai/followers","following_url":"https://api.github.com/users/appadesai/following{/other_user}","gists_url":"https://api.github.com/users/appadesai/gists{/gist_id}","starred_url":"https://api.github.com/users/appadesai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/appadesai/subscriptions","organizations_url":"https://api.github.com/users/appadesai/orgs","repos_url":"https://api.github.com/users/appadesai/repos","events_url":"https://api.github.com/users/appadesai/events{/privacy}","received_events_url":"https://api.github.com/users/appadesai/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2018-09-03T06:50:24Z","updated_at":"2019-02-06T07:49:05Z","closed_at":"2019-02-06T07:49:04Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.1.2, Build: 5b1fea5/2018-01-10T02:35:59.208Z, JVM: 1.8.0_181\r\n\r\n**Plugins installed**: [] None\r\n\r\n**JVM version** (`java -version`):\r\n 1.8.0_181\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS Linux release 7.5.1804 (Core)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\norg.apache.http.concurrent.BasicFuture objects keep building up in jvm heap consuming most of the heap space eventually leading to OutOfMemory error when elasticsearch is under load and does not respond to performRequest call or takes more than 30 seconds to respond.\r\n\r\nError reported by the library in this case is \r\njava.io.IOException:    listener timeout after waiting for [30000] ms\r\n\r\n**Steps to reproduce**:\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. To simulate loaded elasticsearch server, start a webserver to respond to any query with a delay of 200 seconds\r\n     Ex: nodejs server with following script\r\n\r\n```\r\n          var http = require('http');\r\n          var timeout = 100000; //sleep 100 seconds\r\n          http.createServer(function (req, res) {\r\n                 setTimeout((function() {\r\n                       res.writeHead(200, {'Content-Type': 'text/plain'});\r\n                            res.end(\"Hello I am awake\");\r\n                 }), timeout);\r\n          }).listen(9200);\r\n```\r\n\r\n2. Create a java threadpool of 32 threads and continuously submit tasks which should be picked up by each of this thread in the pool\r\n3. Each thread upon getting the request should make a performRequest call with a StringEntity of about 1MB size on a single instance of RestClient shared across all the threads. In our scenario, we make a _bulk request to elasticsearch with 500 update operations.\r\n4. Monitor the heap objects after every 15 minutes and you will notice buildup of BasicFuture objects with strong references from the GC root which do not get released.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nWorkaround:\r\nThis issues is not seen when RestClient.setMaxRetryTimeoutMillis(100000) is used which results in SocketTimeout instead of listener timeout as shown below\r\n                Socket timeout Exception:\r\n    11:11:17.216 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.client.InternalIODispatch - http-outgoing-0 [ACTIVE]\r\nTimeout\r\n    11:11:17.216 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.conn.ManagedNHttpClientConnectionImpl - http-outgoing-0\r\n127.0.0.1:52928<->127.0.0.1:9200[ACTIVE] [rw:w]: Shutdown\r\n    11:11:17.218 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.client.InternalHttpAsyncClient - [exchange: 1]\r\nconnection aborted\r\n    11:11:17.218 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager - Releasing\r\nconnection: [id: http-outgoing-0][route: {}->http://127.0.0.1:9200][total kept\r\nalive: 0; route allocated: 1 of 10; total allocated: 1 of 30]\r\n    11:11:17.218 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager - Connection\r\nreleased: [id: http-outgoing-0][route: {}->http://127.0.0.1:9200][total kept\r\nalive: 0; route allocated: 0 of 10; total allocated: 0 of 30]\r\n    11:11:17.222 [I/O dispatcher 1] DEBUG org.elasticsearch.client.RestClient -\r\nrequest [POST http://127.0.0.1:9200/_bulk] failed\r\njava.net.SocketTimeoutException: null\r\n       at\r\norg.apache.http.nio.protocol.HttpAsyncRequestExecutor.timeout(HttpAsyncRequestExecutor.java:375)\r\n       at\r\norg.apache.http.impl.nio.client.InternalRequestExecutor.timeout(InternalRequestExecutor.java:116)\r\n       at\r\norg.apache.http.impl.nio.client.InternalIODispatch.onTimeout(InternalIODispatch.java:92)\r\n       at\r\norg.apache.http.impl.nio.client.InternalIODispatch.onTimeout(InternalIODispatch.java:39)\r\n       at\r\norg.apache.http.impl.nio.reactor.AbstractIODispatch.timeout(AbstractIODispatch.java:175)\r\n       at\r\norg.apache.http.impl.nio.reactor.BaseIOReactor.sessionTimedOut(BaseIOReactor.java:263)\r\n       at\r\norg.apache.http.impl.nio.reactor.AbstractIOReactor.timeoutCheck(AbstractIOReactor.java:492)\r\n       at\r\norg.apache.http.impl.nio.reactor.BaseIOReactor.validate(BaseIOReactor.java:213)\r\n       at\r\norg.apache.http.impl.nio.reactor.AbstractIOReactor.execute(AbstractIOReactor.java:280)\r\n       at\r\norg.apache.http.impl.nio.reactor.BaseIOReactor.execute(BaseIOReactor.java:104)\r\n       at\r\norg.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor$Worker.run(AbstractMultiworkerIOReactor.java:588)\r\n       at java.lang.Thread.run(Thread.java:748)\r\n    11:11:17.223 [I/O dispatcher 1] DEBUG org.elasticsearch.client.RestClient -\r\nadded host [http://127.0.0.1:9200] to blacklist\r\n    11:11:17.224 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.conn.ManagedNHttpClientConnectionImpl - http-outgoing-0\r\n0.0.0.0:52928<->127.0.0.1:9200[CLOSED][]: Shutdown\r\n    11:11:17.224 [I/O dispatcher 1] DEBUG\r\norg.apache.http.impl.nio.client.InternalIODispatch - http-outgoing-0 [CLOSED]:\r\nDisconnected\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}