{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16716","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16716/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16716/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16716/events","html_url":"https://github.com/elastic/elasticsearch/issues/16716","id":134545019,"node_id":"MDU6SXNzdWUxMzQ1NDUwMTk=","number":16716,"title":"Shard relocations keep failing after node restart","user":{"login":"marek-obuchowicz","id":712751,"node_id":"MDQ6VXNlcjcxMjc1MQ==","avatar_url":"https://avatars1.githubusercontent.com/u/712751?v=4","gravatar_id":"","url":"https://api.github.com/users/marek-obuchowicz","html_url":"https://github.com/marek-obuchowicz","followers_url":"https://api.github.com/users/marek-obuchowicz/followers","following_url":"https://api.github.com/users/marek-obuchowicz/following{/other_user}","gists_url":"https://api.github.com/users/marek-obuchowicz/gists{/gist_id}","starred_url":"https://api.github.com/users/marek-obuchowicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marek-obuchowicz/subscriptions","organizations_url":"https://api.github.com/users/marek-obuchowicz/orgs","repos_url":"https://api.github.com/users/marek-obuchowicz/repos","events_url":"https://api.github.com/users/marek-obuchowicz/events{/privacy}","received_events_url":"https://api.github.com/users/marek-obuchowicz/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"assignees":[{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2016-02-18T10:54:34Z","updated_at":"2016-04-06T10:25:11Z","closed_at":"2016-04-06T10:25:11Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nWe're running ES version 2.1.0. Cluster consits of three nodes (all of them have `node.data` and `node.master` set to true). When doing yesterday rolling restart of nodes (glibc patching), the first server was restarted, shard allocation was set to all and all went great. When second node was restarted, after coming back it was stuck with some shards in 'RELOCATING' state for a few hours. When checked logs, they were constatly flooded with the exception below. I have tried to shut down the node, remove whole data directory and start it again, so that it has fresh state and gets all shard replicas from another nodes. What's strange, the situation repeated:\n\n```\n[2016-02-18 10:31:06,249][WARN ][indices.cluster          ] [psz-ses-02] [products_spryker-2016-02-17-21-39-29] failed to add mapping [product], source [{\"product\":{\"_all\":{\"analyzer\":\"main_analyzer\"},\"pr\njava.lang.IllegalArgumentException: Mapper for [_all] conflicts with existing mapping in other types:\n[mapper [_all] cannot be changed from type [_all] to [string]]\n        at org.elasticsearch.index.mapper.FieldTypeLookup.checkCompatibility(FieldTypeLookup.java:117)\n        at org.elasticsearch.index.mapper.MapperService.checkNewMappersCompatibility(MapperService.java:364)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:315)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:261)\n        at org.elasticsearch.indices.cluster.IndicesClusterStateService.processMapping(IndicesClusterStateService.java:418)\n        at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyMappings(IndicesClusterStateService.java:372)\n        at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:177)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:494)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n```\n\nI do not understand why to mapping problem appears, as the node was fresh and didn't have any indices / mappings.\n\nWe have applied a intermediate workaround during the night - recreate indexes we use (with another name) and drop the old ones. This went smooth - shards (primaries/replicas) were allocated fine on all three nodes and no exceptions since deleting old indices.\n\nToday we wanted to apply the security patches to the third node and repeated situation - restarted third node (according to procedure described on https://www.elastic.co/guide/en/elasticsearch/guide/current/_rolling_restarts.html) - again, when node came back, some shards are stuck in RELOCATING state, which never changes and logs are flooded with the strange exception above.\nNever experienced this situation on earlier ES versions. Not sure if it's a bug, but please check if this could be related to any internals of Eleasticsearch - the operation we executed was very easy rolling cluster restart, which resulted in unstability in two out of three tries.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}