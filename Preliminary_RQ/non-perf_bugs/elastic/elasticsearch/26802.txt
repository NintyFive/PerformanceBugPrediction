{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26802","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26802/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26802/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26802/events","html_url":"https://github.com/elastic/elasticsearch/issues/26802","id":261005372,"node_id":"MDU6SXNzdWUyNjEwMDUzNzI=","number":26802,"title":"Possible Bulk Update Optimizations","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2017-09-27T14:54:08Z","updated_at":"2018-06-13T13:38:27Z","closed_at":"2018-03-28T16:03:58Z","author_association":"MEMBER","active_lock_reason":null,"body":"We had several reports of slow bulk updates in 5.0 and above. Some of them are summarized in #23792. The main issue that led to significant slow down seems to the refresh that is now performed before each update operation. Basically, in order to perform a bulk requests with 1000 updates on the same record we will have to perform refresh 1000 times. This problem can be avoided if we could combine all update operations on the same record within a shard batch into a single update operation, this way we could get away with performing refresh only once. \r\n\r\nFor example, if we have the following bulk request:\r\n```\r\nupdate rec A\r\nupdate rec A\r\nupdate rec B\r\nupdate rec A\r\n```\r\nit currently translates into\r\n```\r\nrefresh // possibly if A was updated in the previous bulk and wasn't refreshed yet\r\nget A\r\nupdate A\r\nindex A\r\n\r\nrefresh // always\r\nget A\r\nupdate A\r\nindex A\r\n\r\n// no refresh - because B wasn't modified in this bulk yet\r\nget B\r\nupdate B\r\nindex B\r\n\r\nrefresh // always\r\nget A\r\nupdate A\r\nindex A\r\n```\r\n\r\nIf we combine all updates together we could transform it \r\n\r\n```\r\nrefresh\r\nget A\r\nupdate A\r\nupdate A\r\nupdate A\r\nindex A\r\nget B\r\nupdate B\r\nindex B\r\n```\r\n\r\nWe would still have an issue if we have a mix of index or delete operations with update operations on the same record in the same bulk request, but, perhaps we can either fall back to the current slow way of doing things or optimize them only as much as we can, for example, we can ignore all updates before index operation and all updates and index operation before delete, etc.\r\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}