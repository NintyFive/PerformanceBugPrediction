{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29890","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29890/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29890/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29890/events","html_url":"https://github.com/elastic/elasticsearch/issues/29890","id":317449052,"node_id":"MDU6SXNzdWUzMTc0NDkwNTI=","number":29890,"title":"[CI] Upgrade YAML tests fail with javax.crypto.IllegalBlockSizeException","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912841668,"node_id":"MDU6TGFiZWw5MTI4NDE2Njg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/License","name":":Security/License","color":"0e8a16","default":false,"description":"License functionality for commercial features"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2018-03-22T14:42:55Z","updated_at":"2018-10-19T11:15:59Z","closed_at":"2018-05-17T04:40:12Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @polyfractal:*\n\nA triplet of upgrade yaml tests seem to be failing all with the same `IllegalBlockSizeException`, and it looks they they are only happening on release CI builds at the moment.  This triplet LINK REDACTED,time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),index:'build-*',interval:auto,query:(query_string:(analyze_wildcard:!t,query:javax.crypto.IllegalBlockSizeException)),sort:!(process.time-start,desc))) but I couldn't see any particular change that may have caused it.\r\n\r\nThe most recent failure was on 6.x, but it seems to be happening on master too.  I'm not sure if it is relevant, but all the failures were on Java `9.0.4+11`\r\n\r\nLINK REDACTED\r\n\r\nTagging @elastic/es-security to start, although I'm not really sure if this is a security issue or something wonky with the release process/build.\r\n\r\nThe relevant exception:\r\n\r\n```\r\nCaused by: java.lang.IllegalStateException: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:182)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:116)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:72)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:71)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:101)\r\n\tat org.elasticsearch.license.LicenseService.registerLicense(LicenseService.java:196)\r\n\tat \r\n```\r\n\r\nFull stack trace from the tests:\r\n\r\n```json\r\n{\r\n  \"stash\" : {\r\n    \"body\" : {\r\n      \"error\" : {\r\n        \"root_cause\" : [\r\n          {\r\n            \"type\" : \"illegal_state_exception\",\r\n            \"reason\" : \"javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\",\r\n            \"stack_trace\" : \"[javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher]; nested: IllegalStateException[javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher]; nested: IllegalBlockSizeException[Input length must be multiple of 16 when decrypting with padded cipher];\r\n\tat org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:640)\r\n\tat org.elasticsearch.ElasticsearchException.generateFailureXContent(ElasticsearchException.java:585)\r\n\tat org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:138)\r\n\tat org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96)\r\n\tat org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:91)\r\n\tat org.elasticsearch.rest.action.RestActionListener.onFailure(RestActionListener.java:58)\r\n\tat org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:91)\r\n\tat org.elasticsearch.action.support.ContextPreservingActionListener.onFailure(ContextPreservingActionListener.java:50)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$1.onFailure(TransportMasterNodeAction.java:160)\r\n\tat org.elasticsearch.action.ActionRunnable.onFailure(ActionRunnable.java:42)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.lang.IllegalStateException: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:182)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:116)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:72)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:71)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:101)\r\n\tat org.elasticsearch.license.LicenseService.registerLicense(LicenseService.java:196)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:64)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:33)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:88)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:167)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n\t... 3 more\r\nCaused by: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:936)\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:847)\r\n\tat com.sun.crypto.provider.AESCipher.engineDoFinal(AESCipher.java:446)\r\n\tat javax.crypto.Cipher.doFinal(Cipher.java:2164)\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:180)\r\n\t... 14 more\"\r\n          }\r\n        ],\r\n        \"type\" : \"illegal_state_exception\",\r\n        \"reason\" : \"javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\",\r\n        \"caused_by\" : {\r\n          \"type\" : \"illegal_block_size_exception\",\r\n          \"reason\" : \"Input length must be multiple of 16 when decrypting with padded cipher\",\r\n          \"stack_trace\" : \"javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:936)\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:847)\r\n\tat com.sun.crypto.provider.AESCipher.engineDoFinal(AESCipher.java:446)\r\n\tat javax.crypto.Cipher.doFinal(Cipher.java:2164)\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:180)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:116)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:72)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:71)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:101)\r\n\tat org.elasticsearch.license.LicenseService.registerLicense(LicenseService.java:196)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:64)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:33)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:88)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:167)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\"\r\n        },\r\n        \"stack_trace\" : \"java.lang.IllegalStateException: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:182)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:116)\r\n\tat org.elasticsearch.license.CryptUtils.readEncryptedPublicKey(CryptUtils.java:72)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:71)\r\n\tat org.elasticsearch.license.LicenseVerifier.verifyLicense(LicenseVerifier.java:101)\r\n\tat org.elasticsearch.license.LicenseService.registerLicense(LicenseService.java:196)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:64)\r\n\tat org.elasticsearch.license.TransportPutLicenseAction.masterOperation(TransportPutLicenseAction.java:33)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:88)\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:167)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:936)\r\n\tat com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:847)\r\n\tat com.sun.crypto.provider.AESCipher.engineDoFinal(AESCipher.java:446)\r\n\tat javax.crypto.Cipher.doFinal(Cipher.java:2164)\r\n\tat org.elasticsearch.license.CryptUtils.decrypt(CryptUtils.java:180)\r\n\t... 14 more\"\r\n      },\r\n      \"status\" : 500\r\n    }\r\n  }\r\n}]\r\n```\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :x-pack-elasticsearch:plugin:integTestRunner \\\r\n  -Dtests.seed=1765FEF2C5106B9 \\\r\n  -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT \\\r\n  -Dtests.method=\"test {p0=upgrade/10_basic/Upgrade test - should fail as index is already up to date}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dbuild.snapshot=false \\\r\n  -Dtests.jvm.argline=\"-Dbuild.snapshot=false\" \\\r\n  -Dtests.locale=ar-LB \\\r\n  -Dtests.timezone=AET \\\r\n  -Dtests.rest.blacklist=getting_started/10_monitor_cluster_health/*,xpack/15_basic/*,license/20_put_license/*\r\n\r\nREPRODUCE WITH: ./gradlew :x-pack-elasticsearch:plugin:integTestRunner \\\r\n  -Dtests.seed=1765FEF2C5106B9 \\\r\n  -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT \\\r\n  -Dtests.method=\"test {p0=upgrade/10_basic/Upgrade info - all}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dbuild.snapshot=false \\\r\n  -Dtests.jvm.argline=\"-Dbuild.snapshot=false\" \\\r\n  -Dtests.locale=ar-LB \\\r\n  -Dtests.timezone=AET \\\r\n  -Dtests.rest.blacklist=getting_started/10_monitor_cluster_health/*,xpack/15_basic/*,license/20_put_license/*\r\n\r\nREPRODUCE WITH: ./gradlew :x-pack-elasticsearch:plugin:integTestRunner \\\r\n  -Dtests.seed=1765FEF2C5106B9 \\\r\n  -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT \\\r\n  -Dtests.method=\"test {p0=upgrade/10_basic/Upgrade test - wait_for_completion:false}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dbuild.snapshot=false \\\r\n  -Dtests.jvm.argline=\"-Dbuild.snapshot=false\" \\\r\n  -Dtests.locale=ar-LB \\\r\n  -Dtests.timezone=AET \\\r\n  -Dtests.rest.blacklist=getting_started/10_monitor_cluster_health/*,xpack/15_basic/*,license/20_put_license/*\r\n```","closed_by":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"performed_via_github_app":null}