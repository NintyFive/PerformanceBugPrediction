{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1583","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1583/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1583/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1583/events","html_url":"https://github.com/elastic/elasticsearch/issues/1583","id":2704490,"node_id":"MDU6SXNzdWUyNzA0NDkw","number":1583,"title":"Update API: Allow to update a document based on a script","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":174398,"node_id":"MDU6TGFiZWwxNzQzOTg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.19.0.RC1","name":"v0.19.0.RC1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":26,"created_at":"2012-01-02T20:01:47Z","updated_at":"2018-06-07T17:22:45Z","closed_at":"2012-01-02T20:02:31Z","author_association":"MEMBER","active_lock_reason":null,"body":"The update action allows to directly update a specific document based on a script. The operation gets the document (collocated with the shard) from the index, runs the script (with optional script language and parameters), and index back the result (also allows to delete, or ignore the operation). \n\nNote, this operation still means full reindex of the document, it just removes some network roundtrips and reduces chances of version conflicts between the get and the index.\n\nFor example, lets index a simple doc:\n\n```\ncurl -XPUT localhost:9200/test/type1/1 -d '{\n    \"counter\" : 1,\n    \"tags\" : [\"red\"]\n}'\n```\n\nNow, we can execute a script that would increment the counter\n\n```\ncurl -XPOST 'localhost:9200/test/type1/1/_update' -d '{\n    \"script\" : \"ctx._source.counter += count\",\n    \"params\" : {\n        \"count\" : 4\n    }\n}'\n```\n\nWe can also add a tag to the list of tags:\n\n```\ncurl -XPOST 'localhost:9200/test/type1/1/_update' -d '{\n    \"script\" : \"ctx._source.tags += tag\",\n    \"params\" : {\n        \"tag\" : \"blue\"\n    }\n}'\n```\n\nAnd, we can delete the doc if the tags contain `blue`, or ignore (noop):\n\n```\ncurl -XPOST 'localhost:9200/test/type1/1/_update' -d '{\n    \"script\" : \"ctx._source.tags.contains(tag) ? ctx.op = \\\"delete\\\" : ctx.op = \\\"none\\\"\",\n    \"params\" : {\n        \"tag\" : \"blue\"\n    }\n}'\n```\n## Parameters:\n- `routing`: Sets the routing that will be used to route the document to the relevant shard.\n- `parent`: Simply sets the routing.\n- `timeout`: Timeout waiting for a shard to become available.\n- `replication`: The replication type for the delete/index operation (`sync` or `async`).\n- `consistency`: The write consistency of the index/delete operation.\n- `retry_on_conflict`: How many times to retry if there is a version conflict between getting the document and indexing / deleting it. Defaults to `0`.\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}