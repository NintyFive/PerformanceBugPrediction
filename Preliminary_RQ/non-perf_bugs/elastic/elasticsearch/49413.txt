{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49413","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49413/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49413/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49413/events","html_url":"https://github.com/elastic/elasticsearch/issues/49413","id":526280984,"node_id":"MDU6SXNzdWU1MjYyODA5ODQ=","number":49413,"title":"Rollover sometimes does not attach Rollover Info to index metadata","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"andreidan","id":1217601,"node_id":"MDQ6VXNlcjEyMTc2MDE=","avatar_url":"https://avatars2.githubusercontent.com/u/1217601?v=4","gravatar_id":"","url":"https://api.github.com/users/andreidan","html_url":"https://github.com/andreidan","followers_url":"https://api.github.com/users/andreidan/followers","following_url":"https://api.github.com/users/andreidan/following{/other_user}","gists_url":"https://api.github.com/users/andreidan/gists{/gist_id}","starred_url":"https://api.github.com/users/andreidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreidan/subscriptions","organizations_url":"https://api.github.com/users/andreidan/orgs","repos_url":"https://api.github.com/users/andreidan/repos","events_url":"https://api.github.com/users/andreidan/events{/privacy}","received_events_url":"https://api.github.com/users/andreidan/received_events","type":"User","site_admin":false},"assignees":[{"login":"andreidan","id":1217601,"node_id":"MDQ6VXNlcjEyMTc2MDE=","avatar_url":"https://avatars2.githubusercontent.com/u/1217601?v=4","gravatar_id":"","url":"https://api.github.com/users/andreidan","html_url":"https://github.com/andreidan","followers_url":"https://api.github.com/users/andreidan/followers","following_url":"https://api.github.com/users/andreidan/following{/other_user}","gists_url":"https://api.github.com/users/andreidan/gists{/gist_id}","starred_url":"https://api.github.com/users/andreidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreidan/subscriptions","organizations_url":"https://api.github.com/users/andreidan/orgs","repos_url":"https://api.github.com/users/andreidan/repos","events_url":"https://api.github.com/users/andreidan/events{/privacy}","received_events_url":"https://api.github.com/users/andreidan/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-11-20T23:49:00Z","updated_at":"2020-01-14T22:58:40Z","closed_at":"2020-01-14T22:58:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): Observed on 6.7.2 and 7.0.1\r\n\r\n## Issue\r\n\r\nI've observed multiple instances where `RolloverInfo` does not get attached to an index when it is rolled over.  In one instance, the cluster was heavily overloaded and had errors processing cluster state updates, in another, a node was rapidly joining, getting removed, rejoining again, and repeating over and over.  This may or may not be relevant.\r\n\r\nThis would normally not be problematic, but ILM relies on the `RolloverInfo` to update the lifecycle reference date following rollover, so when this occurs, ILM encounters an error with a message similar to this one:\r\n```\r\n[2019-10-28T05:50:10,915][ERROR][o.e.x.i.ExecuteStepsUpdateTask] [name] policy [my-policy] for index [my-index-000001] failed on cluster state step [{\"phase\":\"hot\",\"action\":\"rollover\",\"name\":\"update-rollover-lifecycle-date\"}]. Moving to ERROR step\r\n```\r\n\r\nThe step info from the ILM Explain API when this happens:\r\n```\r\n\"step_info\" : {\r\n        \"type\" : \"illegal_state_exception\",\r\n        \"reason\" : \"no rollover info found for [my-index-000001] with alias [my-alias], the index has not yet rolled over with that alias\",\r\n        \"stack_trace\" : \"[omitted for brevity]\"\r\n}\r\n```\r\n\r\n## Workaround\r\nThere is no way to manually attach `RolloverInfo`, so if this happens to an index, ILM must be forcibly moved past this step.  **NOTE THAT THIS MEANS THE CREATION DATE OF THE INDEX WILL BE USED INSTEAD OF THE ROLLOVER DATE** for all following phases. If this is problematic, then the [`index.lifecycle.origination_date` setting in 7.5+](https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ilm-settings.html#_index_level_settings) may be useful.\r\n\r\nTo do this, you can use the following request:\r\n```\r\nPOST _ilm/move/my-index-000001\r\n{\r\n  \"current_step\": { \r\n    \"phase\": \"hot\",\r\n    \"action\": \"rollover\",\r\n    \"name\": \"ERROR\"\r\n  },\r\n  \"next_step\": { \r\n    \"phase\": \"hot\",\r\n    \"action\": \"rollover\",\r\n    \"name\": \"set-indexing-complete\"\r\n  }\r\n}\r\n```","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}