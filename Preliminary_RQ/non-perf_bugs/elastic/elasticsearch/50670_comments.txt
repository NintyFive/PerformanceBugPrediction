[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571215445","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-571215445","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":571215445,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTIxNTQ0NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-01-06T16:49:19Z","updated_at":"2020-01-06T16:49:19Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/CRUD)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571216417","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-571216417","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":571216417,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTIxNjQxNw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-01-06T16:51:36Z","updated_at":"2020-01-06T16:53:52Z","author_association":"CONTRIBUTOR","body":"We discussed a couple of options in Slack:\r\n\r\n1. impose an explicit limit on the number of in-flight dynamic mapping updates on each data node, throttling indexing when that limit is reached.\r\n\r\n2. detect the case where the in-flight mapping updates are already sufficient and, if so, wait locally for those updates to complete instead of sending duplicates to the master.\r\n\r\n3. apply backpressure at the network level (on the master) by stopping reading from the wire before reaching breaking point","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/572379906","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-572379906","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":572379906,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MjM3OTkwNg==","user":{"login":"SpencerLN","id":6659148,"node_id":"MDQ6VXNlcjY2NTkxNDg=","avatar_url":"https://avatars0.githubusercontent.com/u/6659148?v=4","gravatar_id":"","url":"https://api.github.com/users/SpencerLN","html_url":"https://github.com/SpencerLN","followers_url":"https://api.github.com/users/SpencerLN/followers","following_url":"https://api.github.com/users/SpencerLN/following{/other_user}","gists_url":"https://api.github.com/users/SpencerLN/gists{/gist_id}","starred_url":"https://api.github.com/users/SpencerLN/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SpencerLN/subscriptions","organizations_url":"https://api.github.com/users/SpencerLN/orgs","repos_url":"https://api.github.com/users/SpencerLN/repos","events_url":"https://api.github.com/users/SpencerLN/events{/privacy}","received_events_url":"https://api.github.com/users/SpencerLN/received_events","type":"User","site_admin":false},"created_at":"2020-01-09T04:28:31Z","updated_at":"2020-01-09T04:28:31Z","author_association":"NONE","body":"I believe we are running into a very similar issue after an upgrade from 6.8.0 > 7.5.1. In 6.8.0 we would see a couple of minutes where the cluster would apply the new mappings and then recover, while in 7.5.1 we see the number of pending mapping changes reach 30,000+. This quickly results in the master node becoming unresponsive and data nodes repeatedly leaving/joining the cluster due to being unable to contact the master node in a timely manner.\r\n\r\nSince our upgrade, each night at 12 AM (new date based indexes are created at this time) we have had to restart all of our master nodes simultaneously to bring the cluster back to a healthy state. \r\n\r\nIs there any timeline on a potential fix for this issue being made available, or a recommended workaround?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/572467045","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-572467045","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":572467045,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MjQ2NzA0NQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-01-09T09:18:40Z","updated_at":"2020-01-09T09:18:40Z","author_association":"CONTRIBUTOR","body":"@SpencerLN that sounds like this issue indeed.\r\n\r\nAs a general rule, dynamic mappings should be used sparingly in production since they cause indexing to bottleneck on the master. It's much more efficient to use an index template to set up most of the mappings when the index is created, and this is particularly important at the kind of scale that would result in tens of thousands of pending tasks. Dynamic mappings are more appropriate for handling an occasional unexpected field.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/574613601","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-574613601","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":574613601,"node_id":"MDEyOklzc3VlQ29tbWVudDU3NDYxMzYwMQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-01-15T11:12:20Z","updated_at":"2020-01-15T11:12:20Z","author_association":"CONTRIBUTOR","body":"We discussed various options to solving this issue in the distributed sync (and combinations thereof):\r\n- reintroduce blocking the writer thread on the data node once it has a certain number of dynamic mapping updates in-flight.\r\n- deduplicate the mapping updates that are sent to the master, assuming that a large number of these updates would be similar.\r\n- track the number of semi-processed, but uncompleted requests and start rejecting new requests once uncompleted requests reach a certain bound.\r\n- bound the number of in-flight mapping updates on the master node, and reject any new requests coming in. Combine this with a retry/backoff mechanism on the data node side.\r\n\r\nTo get a fix out quickly, I will look at reintroducing the blocking behavior in a first step.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/620004614","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-620004614","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":620004614,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMDAwNDYxNA==","user":{"login":"farin99","id":683343,"node_id":"MDQ6VXNlcjY4MzM0Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/683343?v=4","gravatar_id":"","url":"https://api.github.com/users/farin99","html_url":"https://github.com/farin99","followers_url":"https://api.github.com/users/farin99/followers","following_url":"https://api.github.com/users/farin99/following{/other_user}","gists_url":"https://api.github.com/users/farin99/gists{/gist_id}","starred_url":"https://api.github.com/users/farin99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/farin99/subscriptions","organizations_url":"https://api.github.com/users/farin99/orgs","repos_url":"https://api.github.com/users/farin99/repos","events_url":"https://api.github.com/users/farin99/events{/privacy}","received_events_url":"https://api.github.com/users/farin99/received_events","type":"User","site_admin":false},"created_at":"2020-04-27T13:59:22Z","updated_at":"2020-04-27T13:59:22Z","author_association":"NONE","body":"@ywelsch seems like the code isn't part of any release (not 7.6 or above)\r\nhttps://github.com/elastic/elasticsearch/blob/v7.6.2/server/src/main/java/org/elasticsearch/cluster/action/index/MappingUpdatedAction.java","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/620012319","html_url":"https://github.com/elastic/elasticsearch/issues/50670#issuecomment-620012319","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50670","id":620012319,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMDAxMjMxOQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-04-27T14:10:45Z","updated_at":"2020-04-27T14:10:45Z","author_association":"CONTRIBUTOR","body":"Indeed, looks like I missed the backport to the 7.6 branch, and it also missed the 7.5.2 release (it's on the 7.5 branch, but just after that release), probably backported at the time where the new branches were cut. It was backported to 7.x (i.e. future 7.7.0), so will be released as part of that. I will adapt the labels on the PR.","performed_via_github_app":null}]