{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15756","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15756/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15756/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15756/events","html_url":"https://github.com/elastic/elasticsearch/issues/15756","id":124804731,"node_id":"MDU6SXNzdWUxMjQ4MDQ3MzE=","number":15756,"title":"PathHierarchy vs path_hierarchy","user":{"login":"kstaken","id":283724,"node_id":"MDQ6VXNlcjI4MzcyNA==","avatar_url":"https://avatars0.githubusercontent.com/u/283724?v=4","gravatar_id":"","url":"https://api.github.com/users/kstaken","html_url":"https://github.com/kstaken","followers_url":"https://api.github.com/users/kstaken/followers","following_url":"https://api.github.com/users/kstaken/following{/other_user}","gists_url":"https://api.github.com/users/kstaken/gists{/gist_id}","starred_url":"https://api.github.com/users/kstaken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kstaken/subscriptions","organizations_url":"https://api.github.com/users/kstaken/orgs","repos_url":"https://api.github.com/users/kstaken/repos","events_url":"https://api.github.com/users/kstaken/events{/privacy}","received_events_url":"https://api.github.com/users/kstaken/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null},{"id":266898191,"node_id":"MDU6TGFiZWwyNjY4OTgxOTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.2.0","name":"v2.2.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-01-04T17:42:40Z","updated_at":"2016-01-06T13:51:20Z","closed_at":"2016-01-06T13:51:19Z","author_association":"NONE","active_lock_reason":null,"body":"In versions of Elasticsearch prior to 2.0 the documentation for the path_hierarchy analyzer says the 'type' field has these requirements. \n\n```\nRequired. Must be set to PathHierarchy (case-sensitive).\n```\n\nhttps://www.elastic.co/guide/en/elasticsearch/reference/1.7/analysis-pathhierarchy-tokenizer.html\n\nIn 2.0+ that is now incorrect and if you have an index that uses type: 'PathHierarchy' the upgrade process from 1.7.\\* to 2.\\* fails on each shard of the index. It requires it to be type: 'path_hierarchy'. \n\nWe have a user that has an index with many billions of records in it that uses this analyzer as specified by the 1.7 documentation. This index is so large it is infeasible to reindex to simply change this part of the mapping. Is this an intentional change in 2._? Is there any way to patch the mapping attached to the shards so that an upgrade to 2._ is possible?\n\nNote: this issue is not flagged by the migration plugin. We were testing the upgrade on a test cluster and only discovered the issue when the shards attempted to upgrade. It just logs the following stack repeatedly for each shard and effectively corrupts the index since other indices had upgraded successfully while this type fails. In that scenario the cluster can't be reverted without data loss.\n\n```\n[2015-12-14 18:42:56,825][WARN ][indices.cluster          ] [node] [[logs-2015.12.11][3]] marking and sending shard failed due to [failed to create index]\n[logs-2015.12.11] IndexCreationException[failed to create index]; nested: IllegalArgumentException[Unknown Tokenizer type [PathHierarchy] for [field_tokens]];\n    at org.elasticsearch.indices.IndicesService.createIndex(IndicesService.java:362)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyNewIndices(IndicesClusterStateService.java:307)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:176)\n    at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:494)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalArgumentException: Unknown Tokenizer type [PathHierarchy] for [field_tokens]\n    at org.elasticsearch.index.analysis.AnalysisModule.configure(AnalysisModule.java:267)\n    at org.elasticsearch.common.inject.AbstractModule.configure(AbstractModule.java:61)\n    at org.elasticsearch.common.inject.spi.Elements$RecordingBinder.install(Elements.java:233)\n    at org.elasticsearch.common.inject.spi.Elements.getElements(Elements.java:105)\n    at org.elasticsearch.common.inject.InjectorShell$Builder.build(InjectorShell.java:143)\n    at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:99)\n    at org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:159)\n    at org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:55)\n    at org.elasticsearch.indices.IndicesService.createIndex(IndicesService.java:358)\n    ... 8 more\n```\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}