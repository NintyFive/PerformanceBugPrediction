{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37765","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37765/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37765/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37765/events","html_url":"https://github.com/elastic/elasticsearch/issues/37765","id":402243762,"node_id":"MDU6SXNzdWU0MDIyNDM3NjI=","number":37765,"title":" ES selectively accepts/rejects documents via Elasticsearch .Net BulkAll() method","user":{"login":"HenryQW","id":5896343,"node_id":"MDQ6VXNlcjU4OTYzNDM=","avatar_url":"https://avatars2.githubusercontent.com/u/5896343?v=4","gravatar_id":"","url":"https://api.github.com/users/HenryQW","html_url":"https://github.com/HenryQW","followers_url":"https://api.github.com/users/HenryQW/followers","following_url":"https://api.github.com/users/HenryQW/following{/other_user}","gists_url":"https://api.github.com/users/HenryQW/gists{/gist_id}","starred_url":"https://api.github.com/users/HenryQW/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HenryQW/subscriptions","organizations_url":"https://api.github.com/users/HenryQW/orgs","repos_url":"https://api.github.com/users/HenryQW/repos","events_url":"https://api.github.com/users/HenryQW/events{/privacy}","received_events_url":"https://api.github.com/users/HenryQW/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-01-23T13:38:45Z","updated_at":"2019-07-05T14:53:54Z","closed_at":"2019-07-05T14:53:54Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.5.1 (via docker: docker.elastic.co/elasticsearch/elasticsearch:6.5.1)\r\n\r\n**Plugins installed**:\r\n```yaml\r\nelasticsearch:\r\n    image: docker.elastic.co/elasticsearch/elasticsearch:6.5.1\r\n    container_name: medgate-elasticsearch\r\n    environment:\r\n      - discovery.type=single-node\r\n      - xpack.security.enabled=false\r\n      - xpack.monitoring.enabled=true\r\n      - xpack.ml.enabled=false\r\n      - xpack.graph.enabled=false\r\n      - xpack.watcher.enabled=false\r\n      - ES_JAVA_OPTS=-Xms512m -Xmx512m       \r\n      - bootstrap.memory_lock=true       \r\n    ulimits:\r\n      memlock:\r\n        soft: -1\r\n        hard: -1\r\n    volumes:\r\n      - \"esdata:/usr/share/elasticsearch/data\"\r\n    networks:\r\n      - backend\r\n    expose:\r\n      - \"9200\"\r\n    restart: on-failure\r\n```\r\n**JVM version** (`java -version`):\r\nDefault version comes with the image\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nThe host machine (Linux Server 4.4.0-141-generic 167-Ubuntu SMP Wed Dec 5 10:40:15 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nDocuments are randomly being accepted by ES, for instance docA worked the Nth time but not the (N+M)th time.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Using ElasticClient.Net to post the documents\r\n\t```c#\r\n\t var bulkAllObservable = _client.BulkAll(results, b => b\r\n\t                    .Index(index)\r\n\t                    .Type(type.ToLower())\r\n\t                    .BackOffRetries(2)\r\n\t                    .BackOffTime(\"30s\")\r\n\t                    .RefreshOnCompleted()\r\n\t                    .MaxDegreeOfParallelism(4)\r\n\t                    .BackOffRetries(2)\r\n\t                    .Size(bulkSize));\r\n\t\r\n\t\r\n\t            try\r\n\t            {\r\n\t                bulkAllObservable.Wait(TimeSpan.FromSeconds(30), b => { });\r\n\t            }\r\n\t            catch (Exception ex)\r\n\t            {\r\n\t                _logger.LogWarning(ex, \"Result file format was rejected by ElasticSearch\");\r\n\t            }\r\n\t```\r\n 1. The document, note that in the last `prescription` object, `\"dose-value\": \"-1\"` which is inconsistent with the rest, but ES was happy to take it and assign it with `float` type.\r\n\t```json\r\n\t{\r\n\t  \"text\": \"redacted\",\r\n\t  \"entities\": {\r\n\t    \"Prescription\": [\r\n\t      {\r\n\t        \"indices\": [238, 265],\r\n\t        \"status\": \"continuing\",\r\n\t        \"drug\": \"Sodium Valproate\",\r\n\t        \"drug-type\": \"BNF_generic\",\r\n\t        \"route\": \"unknown\",\r\n\t        \"tense\": \"past\",\r\n\t        \"dose\": \"1000mgs\",\r\n\t        \"dose-value\": 1000.0,\r\n\t        \"dose-unit\": \"mgs\",\r\n\t        \"dose-multiple\": \"1\",\r\n\t        \"frequency\": 2.0,\r\n\t        \"time-unit\": \"day\",\r\n\t        \"interval\": 1.0\r\n\t      },\r\n\t      {\r\n\t        \"indices\": [269, 289],\r\n\t        \"frequency\": 2.0,\r\n\t        \"drug\": \"Zonisamide\",\r\n\t        \"drug-type\": \"BNF_generic\",\r\n\t        \"status\": \"continuing\",\r\n\t        \"tense\": \"present\",\r\n\t        \"dose\": \"250mgs\",\r\n\t        \"route\": \"unknown\",\r\n\t        \"dose-value\": 250.0,\r\n\t        \"dose-unit\": \"mgs\",\r\n\t        \"dose-multiple\": \"1\",\r\n\t        \"time-unit\": \"day\",\r\n\t        \"interval\": 1.0\r\n\t      },\r\n\t      {\r\n\t        \"indices\": [1345, 1368],\r\n\t        \"drug\": \"Sodium Valproate\",\r\n\t        \"drug-type\": \"BNF_generic\",\r\n\t        \"status\": \"continuing\",\r\n\t        \"tense\": \"present\",\r\n\t        \"dose\": \"unknown\",\r\n\t        \"dose-value\": \"-1\",\r\n\t        \"dose-unit\": \"unknown\",\r\n\t        \"dose-multiple\": \"1\",\r\n\t        \"route\": \"unknown\"\r\n\t      }\r\n\t    ]\r\n\t  }\r\n\t}\r\n\t```\r\n 1. The mapping produced, note the aforementioned `dose-value` has the type of float:\r\n\t```json\r\n\t{\r\n\t  \"mapping\": {\r\n\t    \"test123456\": {\r\n\t      \"properties\": {\r\n\t        \"fileName\": {\r\n\t          \"type\": \"text\",\r\n\t          \"fields\": {\r\n\t            \"keyword\": {\r\n\t              \"type\": \"keyword\",\r\n\t              \"ignore_above\": 256\r\n\t            }\r\n\t          }\r\n\t        },\r\n\t        \"id\": {\r\n\t          \"type\": \"text\",\r\n\t          \"fields\": {\r\n\t            \"keyword\": {\r\n\t              \"type\": \"keyword\",\r\n\t              \"ignore_above\": 256\r\n\t            }\r\n\t          }\r\n\t        },\r\n\t        \"result\": {\r\n\t          \"properties\": {\r\n\t            \"Prescription\": {\r\n\t              \"properties\": {\r\n\t                \"Directionality\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"Length of Time\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"Temporality\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"Unit of Time\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"dose\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"dose-multiple\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"dose-unit\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"dose-value\": {\r\n\t                  \"type\": \"float\"\r\n\t                },\r\n\t                \"drug\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"drug-type\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"frequency\": {\r\n\t                  \"type\": \"float\"\r\n\t                },\r\n\t                \"indices\": {\r\n\t                  \"type\": \"long\"\r\n\t                },\r\n\t                \"interval\": {\r\n\t                  \"type\": \"float\"\r\n\t                },\r\n\t                \"route\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"status\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"tense\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"time-unit\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                },\r\n\t                \"when\": {\r\n\t                  \"type\": \"text\",\r\n\t                  \"fields\": {\r\n\t                    \"keyword\": {\r\n\t                      \"type\": \"keyword\",\r\n\t                      \"ignore_above\": 256\r\n\t                    }\r\n\t                  }\r\n\t                }\r\n\t              }\r\n\t            }\r\n\t          }\r\n\t        },\r\n\t        \"resultCreatedDate\": {\r\n\t          \"type\": \"date\"\r\n\t        }\r\n\t      }\r\n\t    }\r\n\t  }\r\n\t}\r\n\t```\r\n1. A screentshot of the document viewed in Kibana, with the above mapping:\t\r\n\t![image](https://user-images.githubusercontent.com/5896343/51610025-8bb14100-1f13-11e9-8988-b66d11bbbb4b.png)\r\n\r\n1. If the aforementioned `\"dose-value\": \"-1\"` is rectified to `\"dose-value\": -1`, ES is happy to accept it everytime, but unfortunately it's not feasible in my use case.\r\n\r\n1. This document (and others) works randomly, I've tried it with:\r\n\t1. A fresh ES instance\r\n\t1. A new index in the existing ES instance\r\n\tThe outcome is still the same where ES selectively takes it in or rejects it.\r\n\r\n**Provide logs (if relevant)**:\r\n```c#\r\n{Elasticsearch.Net.ElasticsearchClientException: BulkAll halted after receiving failures that can not be retried from _bulk\r\n   at Nest.BlockingSubscribeExtensions.WaitOnObservable[TObservable,TObserve,TObserver](TObservable observable, TimeSpan maximumRunTime, Func`3 factory)\r\n   at Nest.BlockingSubscribeExtensions.Wait[T](BulkAllObservable`1 observable, TimeSpan maximumRunTime, Action`1 onNext)}\r\n```\r\n","closed_by":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"performed_via_github_app":null}