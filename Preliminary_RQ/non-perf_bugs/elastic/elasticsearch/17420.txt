{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17420","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17420/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17420/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17420/events","html_url":"https://github.com/elastic/elasticsearch/issues/17420","id":144691617,"node_id":"MDU6SXNzdWUxNDQ2OTE2MTc=","number":17420,"title":"Provide a configuration option:  routing=my-local-shards-only","user":{"login":"sachingsachin","id":6510635,"node_id":"MDQ6VXNlcjY1MTA2MzU=","avatar_url":"https://avatars3.githubusercontent.com/u/6510635?v=4","gravatar_id":"","url":"https://api.github.com/users/sachingsachin","html_url":"https://github.com/sachingsachin","followers_url":"https://api.github.com/users/sachingsachin/followers","following_url":"https://api.github.com/users/sachingsachin/following{/other_user}","gists_url":"https://api.github.com/users/sachingsachin/gists{/gist_id}","starred_url":"https://api.github.com/users/sachingsachin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sachingsachin/subscriptions","organizations_url":"https://api.github.com/users/sachingsachin/orgs","repos_url":"https://api.github.com/users/sachingsachin/repos","events_url":"https://api.github.com/users/sachingsachin/events{/privacy}","received_events_url":"https://api.github.com/users/sachingsachin/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-03-30T19:08:49Z","updated_at":"2019-07-09T16:16:15Z","closed_at":"2019-07-09T16:16:14Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the feature**: Provide a configuration **routing: my-local-shards-only**\n\n**Some background**: We have a 40 node storm cluster that runs 40 kafka-spouts and 80 ES-Bolts with LOCAL_OR_SHUFFLE_GROUPING. ES-cluster has 10 shards with 1 replica each and they run on 10 powerful machines with 100+GB RAM and 32 cores each.\n\n**Problem**: Field-based routing has been removed in 2.x version and the latest elasticsearch-hadoop does not provide a way to route the messages yet ([ES-Hadoop-issue-715](https://github.com/elastic/elasticsearch-hadoop/issues/715)).\n\nSo the bulk request (we have 10k messages batch currently, each message is 0.7 kb roughly) from each bolt is distributed equally among all the shards and that makes it roughly ~1k messages / shard. This is killing the performance. If batch-size is made larger, number of failures increase in storm.\n\nEven if ES-Hadoop implements routing and the bolts start appending a routing-value in their URLs, it **seems** unlikely (I am not sure though) that every bolt will be able to figure out an exact value of routing such that the ES-server that receives the requests process it locally only. This is so because currently the custom-routing is used in the following formula as per [the docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-routing-field.html):\n\n```\n shard_num = hash(_routing) % num_primary_shards\n```\n\nSo to make the ES-server process the bulk request locally, the routing-field value must be such that the _shard_num_ value comes out to be the same value as the current shard (ES-Hadoop sends data to primary shards only if its not configured for client-nodes.) This is difficult to achieve IMO (especially when there are several writers like storm's ES-Bolts).\n\nAn alternative could be to have a configuration **routing: my-local-shards-only** in elastic-search itself which makes ES-servers consume the entire bulk-request locally. On doing so, the clients need not implement any routing and just by ensuring that their request goes to the correct primary, they can achieve a good load balance. Benefits of this approach:\n1. Client need not **guess** an exact value of the _routing_ field such that its consumed locally.\n2. We are sure that there would never be a hop of bulk request from one primary-shard to another primary-shard because it's guaranteed to be consumed locally.\n3. For several clients (like storm/hadoop), there is no code change to implement routing.\n\nIMHO, the load-balancing achieved in this way is no different than the load-balancing achieved by specifying the routing field in the URL (I could be wrong though) because client is responsible to either provide a good routing-field or select the right primary-shards (latter seems to be easier).\n\nOne drawback I do see in the **routing: my-local-shards-only** approach is that lookup-by-ID becomes mostly impossible because clients would not know what routing-field to specify. But for many systems, this is not a concern because they will never do a lookup-by-ID (Example: log search use-case) and even for those cases, one can always search for ID like all other regular fields (scatter-gather)\n\nSorry for the long description :)\n\n**Elasticsearch version**: 2.x\n","closed_by":{"login":"jbaiera","id":875779,"node_id":"MDQ6VXNlcjg3NTc3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/875779?v=4","gravatar_id":"","url":"https://api.github.com/users/jbaiera","html_url":"https://github.com/jbaiera","followers_url":"https://api.github.com/users/jbaiera/followers","following_url":"https://api.github.com/users/jbaiera/following{/other_user}","gists_url":"https://api.github.com/users/jbaiera/gists{/gist_id}","starred_url":"https://api.github.com/users/jbaiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbaiera/subscriptions","organizations_url":"https://api.github.com/users/jbaiera/orgs","repos_url":"https://api.github.com/users/jbaiera/repos","events_url":"https://api.github.com/users/jbaiera/events{/privacy}","received_events_url":"https://api.github.com/users/jbaiera/received_events","type":"User","site_admin":false},"performed_via_github_app":null}