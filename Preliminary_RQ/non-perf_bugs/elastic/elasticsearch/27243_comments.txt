[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/341720867","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-341720867","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":341720867,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MTcyMDg2Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-11-03T14:35:05Z","updated_at":"2017-11-03T14:35:05Z","author_association":"MEMBER","body":"That's possible but that would mean rescoring the collapsed hits per shard and then doing the final collapsing of the rescored hits in the coordinating node. It would not be possible to select the top N uncollapsed and do the collapsing on the rescored docs only. Is it acceptable for your use case @rpedela ?  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/341795845","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-341795845","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":341795845,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MTc5NTg0NQ==","user":{"login":"rpedela","id":1952582,"node_id":"MDQ6VXNlcjE5NTI1ODI=","avatar_url":"https://avatars1.githubusercontent.com/u/1952582?v=4","gravatar_id":"","url":"https://api.github.com/users/rpedela","html_url":"https://github.com/rpedela","followers_url":"https://api.github.com/users/rpedela/followers","following_url":"https://api.github.com/users/rpedela/following{/other_user}","gists_url":"https://api.github.com/users/rpedela/gists{/gist_id}","starred_url":"https://api.github.com/users/rpedela/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpedela/subscriptions","organizations_url":"https://api.github.com/users/rpedela/orgs","repos_url":"https://api.github.com/users/rpedela/repos","events_url":"https://api.github.com/users/rpedela/events{/privacy}","received_events_url":"https://api.github.com/users/rpedela/received_events","type":"User","site_admin":false},"created_at":"2017-11-03T18:55:11Z","updated_at":"2017-11-03T18:55:11Z","author_association":"NONE","body":"The ideal for me would be to collapse first and then rescore the top N collapsed. I don't know if that is equivalent to rescoring the collapsed hits per shard, but it sounds close enough.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342068608","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-342068608","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":342068608,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MjA2ODYwOA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-11-06T07:38:26Z","updated_at":"2017-11-06T07:38:26Z","author_association":"MEMBER","body":"It's not exactly equivalent to a global rescore of the top N collapsed because the rescoring would be per shard first but that's close enough. I'll mark this issue as **adoptme** because I don't have time to work on it right now. @rpedela would you like to contribute a patch for this ?\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/359458897","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-359458897","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":359458897,"node_id":"MDEyOklzc3VlQ29tbWVudDM1OTQ1ODg5Nw==","user":{"login":"fred84","id":208023,"node_id":"MDQ6VXNlcjIwODAyMw==","avatar_url":"https://avatars0.githubusercontent.com/u/208023?v=4","gravatar_id":"","url":"https://api.github.com/users/fred84","html_url":"https://github.com/fred84","followers_url":"https://api.github.com/users/fred84/followers","following_url":"https://api.github.com/users/fred84/following{/other_user}","gists_url":"https://api.github.com/users/fred84/gists{/gist_id}","starred_url":"https://api.github.com/users/fred84/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fred84/subscriptions","organizations_url":"https://api.github.com/users/fred84/orgs","repos_url":"https://api.github.com/users/fred84/repos","events_url":"https://api.github.com/users/fred84/events{/privacy}","received_events_url":"https://api.github.com/users/fred84/received_events","type":"User","site_admin":false},"created_at":"2018-01-22T15:31:07Z","updated_at":"2018-01-22T15:31:07Z","author_association":"CONTRIBUTOR","body":"I want to take this issue. @jimczi could you please look at following example to verify that I'm correctly understand expected behaviour.\r\n\r\nExample\r\n\r\nGiven we have following documents:\r\n\r\n```json\r\n[\r\n  {\"name\": \"elasticsearch\", \"access\": \"public\", \"maintainers\": 30 },\r\n  {\"name\": \"logstash\"     , \"access\": \"public\", \"maintainers\": 20 },\r\n  {\"name\": \"kibana\"       , \"access\": \"public\", \"maintainers\": 10 },\r\n  {\"name\": \"xpack\"        , \"access\": \"private\", \"maintainers\": 20 },\r\n  {\"name\": \"beats\"        , \"access\": \"private\", \"maintainers\": 5 },\r\n  {\"name\": \"security\"     , \"access\": \"private\", \"maintainers\": 2 }\r\n]\r\n```\r\n\r\nQuery:\r\n\r\n```json\r\n{\r\n    \"query\": { \"range\": {\"maintainers\": {\"gt\": 3}}},\r\n\r\n    \"collapse\" : {\r\n        \"field\" : \"access\",\r\n        \"inner_hits\": {\r\n            \"name\": \"most_maintainers\", \r\n            \"size\": 2, \r\n            \"sort\": [{ \"maintainers\": \"desc\" }] \r\n        }\r\n    },\r\n    \"rescore\" : {\r\n        \"query\" : {\r\n            \"rescore_query\" : {\r\n                \"function_score\" : {\r\n                    \"script_score\": {\r\n                        \"script\": {\r\n                            \"source\": \"doc.maintainers.value\"\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n} \r\n```\r\n\r\nExpected result:\r\n\r\n```json\r\n{\r\n  \"hits\" : {\r\n    \"total\" : 5,\r\n    \"max_score\" : 1.0, // default score\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 1.0, // default score\r\n        \"_source\" : {\r\n          \"name\" : \"kibana\",\r\n          \"access\" : \"public\",\r\n          \"maintainers\" : 10\r\n        },\r\n        \"fields\" : {\r\n          \"access\" : [\r\n            \"public\"\r\n          ]\r\n        },\r\n        \"inner_hits\" : {\r\n          \"most_maintainers\" : {\r\n            \"hits\" : {\r\n              \"total\" : 3,\r\n              \"max_score\" : 31, \r\n              \"hits\" : [\r\n                {\r\n                  \"_index\" : \"test\",\r\n                  \"_type\" : \"doc\",\r\n                  \"_id\" : \"1\",\r\n                  \"_score\" : 31, // rescoring applied, 1 + 30\r\n                  \"_source\" : {\r\n                    \"name\" : \"elasticsearch\",\r\n                    \"access\" : \"public\",\r\n                    \"maintainers\" : 30\r\n                  },\r\n                  \"sort\" : [\r\n                    30\r\n                  ]\r\n                },\r\n                {\r\n                  \"_index\" : \"test\",\r\n                  \"_type\" : \"doc\",\r\n                  \"_id\" : \"2\",\r\n                  \"_score\" : 21, // rescoring applied\r\n                  \"_source\" : {\r\n                    \"name\" : \"logstash\",\r\n                    \"access\" : \"public\",\r\n                    \"maintainers\" : 20\r\n                  },\r\n                  \"sort\" : [\r\n                    20\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"5\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"name\" : \"beats\",\r\n          \"access\" : \"private\",\r\n          \"maintainers\" : 5\r\n        },\r\n        \"fields\" : {\r\n          \"access\" : [\r\n            \"private\"\r\n          ]\r\n        },\r\n        \"inner_hits\" : {\r\n          \"most_maintainers\" : {\r\n            \"hits\" : {\r\n              \"total\" : 2,\r\n              \"max_score\" : 21,\r\n              \"hits\" : [\r\n                {\r\n                  \"_index\" : \"test\",\r\n                  \"_type\" : \"doc\",\r\n                  \"_id\" : \"4\",\r\n                  \"_score\" : 21,\r\n                  \"_source\" : {\r\n                    \"name\" : \"xpack\",\r\n                    \"access\" : \"private\",\r\n                    \"maintainers\" : 20\r\n                  },\r\n                  \"sort\" : [\r\n                    20\r\n                  ]\r\n                },\r\n                {\r\n                  \"_index\" : \"test\",\r\n                  \"_type\" : \"doc\",\r\n                  \"_id\" : \"5\",\r\n                  \"_score\" : 6,\r\n                  \"_source\" : {\r\n                    \"name\" : \"beats\",\r\n                    \"access\" : \"private\",\r\n                    \"maintainers\" : 5\r\n                  },\r\n                  \"sort\" : [\r\n                    5\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/359491388","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-359491388","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":359491388,"node_id":"MDEyOklzc3VlQ29tbWVudDM1OTQ5MTM4OA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-22T16:57:41Z","updated_at":"2018-01-22T16:57:41Z","author_association":"MEMBER","body":"the rescoring should be applied to collapsed hits at the top level, not the `inner_hits`. Rescoring `inner_hits` should not be necessary, or at least considered as a different issue. The feature here would be to apply rescoring after collapsing but still on the top level documents. Looking at your example it would first collapse the top documents and then resort them using the rescore function. \r\nThis also means that the best documents after rescoring may not be the best document in the group after rescoring since the collapsing is done **before** the rescoring.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/359700831","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-359700831","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":359700831,"node_id":"MDEyOklzc3VlQ29tbWVudDM1OTcwMDgzMQ==","user":{"login":"fred84","id":208023,"node_id":"MDQ6VXNlcjIwODAyMw==","avatar_url":"https://avatars0.githubusercontent.com/u/208023?v=4","gravatar_id":"","url":"https://api.github.com/users/fred84","html_url":"https://github.com/fred84","followers_url":"https://api.github.com/users/fred84/followers","following_url":"https://api.github.com/users/fred84/following{/other_user}","gists_url":"https://api.github.com/users/fred84/gists{/gist_id}","starred_url":"https://api.github.com/users/fred84/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fred84/subscriptions","organizations_url":"https://api.github.com/users/fred84/orgs","repos_url":"https://api.github.com/users/fred84/repos","events_url":"https://api.github.com/users/fred84/events{/privacy}","received_events_url":"https://api.github.com/users/fred84/received_events","type":"User","site_admin":false},"created_at":"2018-01-23T07:31:38Z","updated_at":"2018-01-23T07:31:38Z","author_association":"CONTRIBUTOR","body":"@jimczi, below is updated example. Is it correct now?\r\n\r\nQuery:\r\n\r\n```json\r\n{\r\n    \"query\": { \"range\": {\"maintainers\": {\"gt\": 3}}},\r\n    \"collapse\" : {\r\n        \"field\" : \"access\"\r\n    },\r\n    \"rescore\" : {\r\n        \"query\" : {\r\n            \"rescore_query\" : {\r\n                \"function_score\" : {\r\n                    \"script_score\": {\r\n                        \"script\": {\r\n                            \"source\": \"doc.maintainers.value\"\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n} \r\n```\r\n\r\nExpected result:\r\n\r\n```json\r\n{\r\n  \"hits\" : {\r\n    \"total\" : 5,\r\n    \"max_score\" : 11.0, // smaller then possible best document score (31.0) because rescoring is done after collapsing\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 11.0, // rescoring applied (10+1)\r\n        \"_source\" : {\r\n          \"name\" : \"kibana\",\r\n          \"access\" : \"public\",\r\n          \"maintainers\" : 10\r\n        },\r\n        \"fields\" : {\r\n          \"access\" : [\r\n            \"public\"\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"5\",\r\n        \"_score\" : 6.0, // rescoring applied (5+1)\r\n        \"_source\" : {\r\n          \"name\" : \"beats\",\r\n          \"access\" : \"private\",\r\n          \"maintainers\" : 5\r\n        },\r\n        \"fields\" : {\r\n          \"access\" : [\r\n            \"private\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/359875443","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-359875443","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":359875443,"node_id":"MDEyOklzc3VlQ29tbWVudDM1OTg3NTQ0Mw==","user":{"login":"rpedela","id":1952582,"node_id":"MDQ6VXNlcjE5NTI1ODI=","avatar_url":"https://avatars1.githubusercontent.com/u/1952582?v=4","gravatar_id":"","url":"https://api.github.com/users/rpedela","html_url":"https://github.com/rpedela","followers_url":"https://api.github.com/users/rpedela/followers","following_url":"https://api.github.com/users/rpedela/following{/other_user}","gists_url":"https://api.github.com/users/rpedela/gists{/gist_id}","starred_url":"https://api.github.com/users/rpedela/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpedela/subscriptions","organizations_url":"https://api.github.com/users/rpedela/orgs","repos_url":"https://api.github.com/users/rpedela/repos","events_url":"https://api.github.com/users/rpedela/events{/privacy}","received_events_url":"https://api.github.com/users/rpedela/received_events","type":"User","site_admin":false},"created_at":"2018-01-23T17:56:27Z","updated_at":"2018-01-23T18:01:36Z","author_association":"NONE","body":"@fred84 Thanks!\r\n\r\n@jimczi Are ```inner_hits``` rescored for the nested and parent/child queries?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/360061374","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-360061374","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":360061374,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDA2MTM3NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-24T08:49:09Z","updated_at":"2018-01-24T08:49:09Z","author_association":"MEMBER","body":"> Are inner_hits rescored for the nested and parent/child queries?\r\n\r\nNo\r\n\r\n@fred84 , yes your example is correct, though the best document per group in your case will depend on the order of the documents in the index since all documents have the same score for the query (the range query uses a constant score).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371314349","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-371314349","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":371314349,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTMxNDM0OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-03-07T22:52:44Z","updated_at":"2018-03-07T22:52:44Z","author_association":"MEMBER","body":"Closed by #28521","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/614806042","html_url":"https://github.com/elastic/elasticsearch/issues/27243#issuecomment-614806042","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27243","id":614806042,"node_id":"MDEyOklzc3VlQ29tbWVudDYxNDgwNjA0Mg==","user":{"login":"damitkwr","id":10078273,"node_id":"MDQ6VXNlcjEwMDc4Mjcz","avatar_url":"https://avatars2.githubusercontent.com/u/10078273?v=4","gravatar_id":"","url":"https://api.github.com/users/damitkwr","html_url":"https://github.com/damitkwr","followers_url":"https://api.github.com/users/damitkwr/followers","following_url":"https://api.github.com/users/damitkwr/following{/other_user}","gists_url":"https://api.github.com/users/damitkwr/gists{/gist_id}","starred_url":"https://api.github.com/users/damitkwr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/damitkwr/subscriptions","organizations_url":"https://api.github.com/users/damitkwr/orgs","repos_url":"https://api.github.com/users/damitkwr/repos","events_url":"https://api.github.com/users/damitkwr/events{/privacy}","received_events_url":"https://api.github.com/users/damitkwr/received_events","type":"User","site_admin":false},"created_at":"2020-04-16T17:59:42Z","updated_at":"2020-04-16T17:59:42Z","author_association":"NONE","body":"The fix was reverted. Can we revisit this functionality? This limitation curtails the use of any LTR algorithms","performed_via_github_app":null}]