{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44330","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44330/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44330/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44330/events","html_url":"https://github.com/elastic/elasticsearch/issues/44330","id":467979112,"node_id":"MDU6SXNzdWU0Njc5NzkxMTI=","number":44330,"title":"_field_caps API fails to return results for an index that contains a rank_feature field","user":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-07-15T07:31:54Z","updated_at":"2019-07-24T18:49:37Z","closed_at":"2019-07-16T23:26:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"For a simple index containing a `rank_feature` field in its mappings:\r\n```\r\n{ \"mappings\": { \"properties\": { \"branches\": { \"type\": \"keyword\" }, \"rank\" : { \"type\": \"rank_feature\" }}}}\r\n```\r\n\r\nthe call to `_field_caps` (`/_field_caps?fields=*`) fails silently and responds with\r\n\r\n```\r\n{\r\n    \"indices\": [\r\n        \"test\"\r\n    ],\r\n    \"fields\": {}\r\n}\r\n```\r\n\r\nbut, upon close inspection and debugging, the following error is getting thrown when trying to establish if the `rank` field is aggregatable:\r\n\r\n```\r\n[elasticsearch] org.elasticsearch.transport.RemoteTransportException: [node-0][127.0.0.1:9300][indices:data/read/field_caps[index][s]]\r\n[elasticsearch] Caused by: java.lang.UnsupportedOperationException: [rank_feature] fields do not support sorting, scripting or aggregating\r\n[elasticsearch]         at org.elasticsearch.index.mapper.RankFeatureFieldMapper$RankFeatureFieldType.fielddataBuilder(RankFeatureFieldMapper.java:167) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.index.mapper.MappedFieldType.isAggregatable(MappedFieldType.java:303) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.fieldcaps.TransportFieldCapabilitiesIndexAction.shardOperation(TransportFieldCapabilitiesIndexAction.java:92) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.fieldcaps.TransportFieldCapabilitiesIndexAction.shardOperation(TransportFieldCapabilitiesIndexAction.java:47) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$1.doRun(TransportSingleShardAction.java:112) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:769) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n[elasticsearch]         at java.lang.Thread.run(Thread.java:834) [?:?]\r\n```\r\n\r\nIt seems the `fielddataBuilder(String fullyQualifiedIndexName)` method throws an `UnsupportedOperationException` while `MappedFieldType`s `isAggregatable()` method catches an `IllegalArgumentException` when calling `fielddataBuilder()`. Should `isAggregatable` deal with `UnsupportedOperationException`s, as well, or `fielddataBuidler` should have a different logic?\r\n\r\nThis is related to https://github.com/elastic/elasticsearch/issues/44320 where the above failure makes SQL to be unable to execute a simple query.","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}