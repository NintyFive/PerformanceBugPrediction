{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25363","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25363/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25363/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25363/events","html_url":"https://github.com/elastic/elasticsearch/issues/25363","id":237921520,"node_id":"MDU6SXNzdWUyMzc5MjE1MjA=","number":25363,"title":"Reindex from remote doesn't work with master's `join` module","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null},{"id":654498781,"node_id":"MDU6TGFiZWw2NTQ0OTg3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-beta1","name":"v6.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-06-22T17:42:47Z","updated_at":"2018-02-14T13:28:14Z","closed_at":"2017-07-07T08:18:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Run something like this:\r\n\r\n```\r\nDELETE /source\r\n\r\nPUT /source\r\n{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"join_field\": {\r\n          \"type\": \"join\",\r\n          \"relations\": {\r\n            \"parent\": \"child\",\r\n            \"child\": \"grand_child\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nDELETE /dest\r\n\r\nPUT /dest\r\n{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"join_field\": {\r\n          \"type\": \"join\",\r\n          \"relations\": {\r\n            \"parent\": \"child\",\r\n            \"child\": \"grand_child\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\nPUT /source/doc/1\r\n{ \"join_field\": { \"name\": \"parent\" } }\r\n\r\nPUT /source/doc/2?routing=1\r\n{ \"join_field\": { \"name\": \"child\", \"parent\": \"1\" } }\r\n\r\nPUT /source/doc/3?routing=1\r\n{ \"join_field\": { \"name\": \"grand_child\", \"parent\": \"2\" } }\r\n\r\nPOST /_refresh\r\n\r\nPOST /_reindex?refresh\r\n{\r\n  \"source\": {\r\n    \"index\": \"source\",\r\n    \"remote\": {\r\n      \"host\": \"http://127.0.0.1:9200\"\r\n    }\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"dest\"\r\n  }\r\n}\r\n```\r\n\r\nAnd it'll blow up with a big stack trace that comes down to:\r\n```\r\n            \"reason\": \"[fields] unknown field [join_field], parser not found\"\r\n```\r\n\r\nThis is because `join` always returns the join field whether you ask for it or not:\r\n```\r\nPOST /source/_search\r\n```\r\nreturns:\r\n```\r\n{\r\n  ...\r\n  \"hits\": {\r\n    \"total\": 3,\r\n    \"max_score\": 1,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"source\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"join_field\": {\r\n            \"name\": \"parent\"\r\n          }\r\n        },\r\n        \"fields\": {\r\n          \"join_field\": [    <---- This\r\n            \"parent\"\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"source\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 1,\r\n        \"_routing\": \"1\",\r\n        \"_source\": {\r\n          \"join_field\": {\r\n            \"name\": \"child\",\r\n            \"parent\": \"1\"\r\n          }\r\n        },\r\n        \"fields\": {\r\n          \"join_field#parent\": [    <---- This\r\n            \"1\"\r\n          ],\r\n          \"join_field\": [    <---- This\r\n            \"child\"\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"source\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"3\",\r\n        \"_score\": 1,\r\n        \"_routing\": \"1\",\r\n        \"_source\": {\r\n          \"join_field\": {\r\n            \"name\": \"grand_child\",\r\n            \"parent\": \"2\"\r\n          }\r\n        },\r\n        \"fields\": {\r\n          \"join_field\": [    <---- This\r\n            \"grand_child\"\r\n          ],\r\n          \"join_field#child\": [    <---- This\r\n            \"2\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nReindex can fix this on its side by ignoring fields it doesn't know about or by doing more complex things like checking the source mapping first. I wonder if a better solution is for `join` not to return the field if it wasn't asked for. I don't believe reindex needs the field to do its job.","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}