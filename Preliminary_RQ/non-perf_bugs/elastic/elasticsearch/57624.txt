{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624/events","html_url":"https://github.com/elastic/elasticsearch/issues/57624","id":630316101,"node_id":"MDU6SXNzdWU2MzAzMTYxMDE=","number":57624,"title":"terminate_after uses heuristic hits value instead of actual","user":{"login":"travisby","id":133506,"node_id":"MDQ6VXNlcjEzMzUwNg==","avatar_url":"https://avatars0.githubusercontent.com/u/133506?v=4","gravatar_id":"","url":"https://api.github.com/users/travisby","html_url":"https://github.com/travisby","followers_url":"https://api.github.com/users/travisby/followers","following_url":"https://api.github.com/users/travisby/following{/other_user}","gists_url":"https://api.github.com/users/travisby/gists{/gist_id}","starred_url":"https://api.github.com/users/travisby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/travisby/subscriptions","organizations_url":"https://api.github.com/users/travisby/orgs","repos_url":"https://api.github.com/users/travisby/repos","events_url":"https://api.github.com/users/travisby/events{/privacy}","received_events_url":"https://api.github.com/users/travisby/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-06-03T20:45:58Z","updated_at":"2020-06-24T11:15:45Z","closed_at":"2020-06-24T11:15:45Z","author_association":"NONE","active_lock_reason":null,"body":"tl;dr:\r\n\r\nI believe there's a regression with using `terminate_after` in searches from es6->7 because of the changes to `track_total_hits` and `hits.total.value` now being a heuristical value.\r\n\r\n------\r\n\r\nHello!\r\n\r\nI've been looking into why kibana filter autocomplete has been so slow after our transition from an es/logstash/kibana-6.4 stack to an es/logstash/kibana-7.6 stack.  We had also made some sharding decisions that were different so we weren't sure if it was us or an ES regression.\r\n\r\nI've reverse-engineered the query [kibana](https://github.com/elastic/kibana/blob/master/src/plugins/data/server/autocomplete/value_suggestions_route.ts#L30-L84) sends to roughly be:\r\n\r\n```\r\nPOST /index-pattern-*/_search?request_cache=false\r\n{\r\n  \"size\": 0,\r\n  \"timeout\": \"1000ms\",\r\n  \"terminate_after\": \"100000\",\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": []\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"suggestions\": {\r\n      \"terms\": {\r\n        \"field\": \"<fieldname>\",\r\n        \"include\": \".*\",\r\n        \"execution_hint\": \"map\",\r\n        \"shard_size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIn our case, index-pattern is something like 30 indices.  In 6 it's 750 shards and 7 220ish, and <fieldname> is a keyword field where everything is ~10 characters (this is all the same data that we've cloned between the two)\r\n\r\nWith `\"profile\": true` we were able to get some interesting results in the head of the request:\r\n\r\nin elasticsearch6:\r\n\r\n```\r\n{\r\n  \"took\": 4034,\r\n  \"timed_out\": false,\r\n  \"terminated_early\": true,\r\n  \"num_reduce_phases\": 2,\r\n  \"_shards\": {\r\n    \"total\": 751,\r\n    \"successful\": 751,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 75100000,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n```\r\n\r\nin es7:\r\n\r\n```\r\n{\r\n  \"took\" : 17771,\r\n  \"timed_out\" : true,\r\n  \"terminated_early\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 228,\r\n    \"successful\" : 228,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 10000,\r\n      \"relation\" : \"gte\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  },\r\n```\r\n\r\nSo, we've taken _much longer_ and we're timing out instead of terminating early, and that's leading to us taking 4x longer.  We even noticed individual profiles are having us reading one shard taking ~seconds.  I'm surprised, and would have expected that we should have been able to read _each individual shard_ at roughly the same speed (thus, terminating_after happening), even if our concurrency was down.\r\n\r\nThe hits.total.value only being 10k instead of something like terminate_after * num_shards seemed suspect.\r\n\r\nI wanted to see if we were getting _anywhere near_ the same results, and added ` \"track_total_hits\": true,` to our query.  Hopefully with this we can get records/s from each shard and know exactly where our bottleneck is.\r\n\r\n```\r\n{\r\n  \"took\" : 1761,\r\n  \"timed_out\" : false,\r\n  \"terminated_early\" : true,\r\n  \"_shards\" : {\r\n    \"total\" : 228,\r\n    \"successful\" : 228,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 21095801,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  },\r\n```\r\n\r\n!!!! that was a lot faster!  And we're terminating_early now.  **the only change was we added track_total_hits: true to our query** \r\n\r\nMy theory is that the circuit breaker for `terminate_after` is using the heuristical value, which now stops counting after 10k, and ends up searching the whole shard instead of respecting `terminate_after`.\r\n\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}