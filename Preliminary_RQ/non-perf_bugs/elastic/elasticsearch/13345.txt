{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345/events","html_url":"https://github.com/elastic/elasticsearch/issues/13345","id":104887578,"node_id":"MDU6SXNzdWUxMDQ4ODc1Nzg=","number":13345,"title":"Check mapping compatibility ignored when upgrading","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2015-09-04T13:09:28Z","updated_at":"2015-09-06T13:33:59Z","closed_at":"2015-09-06T13:33:59Z","author_association":"MEMBER","active_lock_reason":null,"body":"A 2.0 node starts even though there is a conflicting mapping.\n\nSteps to reproduce:\n1. Start a 1.7.1 node\n2. Add an index with field type conflict and add a few documents:\n\n```\nPUT /test\n{\n  \"mappings\": {\n    \"parent\": {},\n    \"child\": {\n      \"_parent\": {\n        \"type\": \"parent\",\n        \"fielddata\": {\n          \"loading\": \"eager_global_ordinals\"\n        }\n      }\n    }\n  }\n}\n\nPUT /test/parent/1\n{}\n\nPUT /test/child/1?parent=1\n{}\n```\n1. Stop the 1.7.1 node\n2. Start a 2.0.0-beta2-SNAPSHOT node\n3. Two things can happen. \n\na) It fails with an error that I can't update like this:\n\n```\nException in thread \"main\" java.lang.IllegalStateException: unable to upgrade the mappings for the index [test], reason: [Mapper for [_parent] conflicts with existing mapping in other types:\n[mapper [_parent] is used by multiple types. Set update_all_types to true to update [fielddata] across all types.]]\nLikely root cause: java.lang.IllegalArgumentException: Mapper for [_parent] conflicts with existing mapping in other types:\n[mapper [_parent] is used by multiple types. Set update_all_types to true to update [fielddata] across all types.]\n    at org.elasticsearch.index.mapper.FieldTypeLookup.checkCompatibility(FieldTypeLookup.java:117)\n    at org.elasticsearch.index.mapper.MapperService.checkNewMappersCompatibility(MapperService.java:345)\n    at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:296)\n    at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:242)\n    at org.elasticsearch.cluster.metadata.MetaDataIndexUpgradeService.checkMappingsCompatibility(MetaDataIndexUpgradeService.java:331)\n    at org.elasticsearch.cluster.metadata.MetaDataIndexUpgradeService.upgradeIndexMetaData(MetaDataIndexUpgradeService.java:113)\n    at org.elasticsearch.gateway.GatewayMetaState.pre20Upgrade(GatewayMetaState.java:226)\n    at org.elasticsearch.gateway.GatewayMetaState.<init>(GatewayMetaState.java:85)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:422)\n    at <<<guice>>>\n    at org.elasticsearch.node.Node.<init>(Node.java:198)\n    at org.elasticsearch.node.NodeBuilder.build(NodeBuilder.java:157)\n    at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:168)\n    at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:267)\n```\n\nb) The node starts with a conflicting mapping\n1. If it fails to start then try to start start it a few more times and eventually the node will start even though a conflicting mapping is active.\n\nThe 2.0.0-beta2 node should never start with a conflicting mapping. I don't know yet what is causing this.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}