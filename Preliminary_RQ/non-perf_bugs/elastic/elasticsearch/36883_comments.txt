[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448935549","html_url":"https://github.com/elastic/elasticsearch/issues/36883#issuecomment-448935549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","id":448935549,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODkzNTU0OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-12-20T09:42:33Z","updated_at":"2018-12-20T09:42:33Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451593260","html_url":"https://github.com/elastic/elasticsearch/issues/36883#issuecomment-451593260","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","id":451593260,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTU5MzI2MA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-01-04T22:54:46Z","updated_at":"2019-01-04T23:01:38Z","author_association":"MEMBER","body":"I was able to shrink the reproduction to the following [shape](https://gist.github.com/imotov/cfd40f9e4a2239b927f1be25ae3e8e3e).\r\n\r\n```\r\nDELETE test\r\nPUT test\r\n{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"shape\": {\r\n          \"type\": \"geo_shape\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test/doc/badshape\r\n{\r\n  \"shape\": \"Polygon ((1 3, 2 2, 1 1, 3 1, 2 2, 3 3, 1 3))\"\r\n}\r\n```\r\n\r\nThat produces a slightly different error:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse field [shape] of type [geo_shape]\"\r\n      }\r\n    ],\r\n    \"type\": \"mapper_parsing_exception\",\r\n    \"reason\": \"failed to parse field [shape] of type [geo_shape]\",\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_argument_exception\",\r\n      \"reason\": \"at least 4 polygon points required\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nHowever, after debugging it seems to be the manifestation of the same issue. Basically when the loop `2 2, 1 1, 3 1, 2 2`  is detected, `PolygonBuilder` tries to split this polygon into 2, but because of a bug in this logic it ends up with 3 polygons, one of which is not closed: `(2 2, 3 3, 1 3)`, `(3 1, 2 2,  1 1, 3 1)`, `(1 3, 2 2, 3 3, 1 3)` if there are more than 3 points in the first polygon,  the `first and last points of the polygon must be the same` exception is thrown if there are 3 points as in my minimal example, the exception is `at least 4 polygon points required`. It seem to be an off by one error because by just staring from another point allows :\r\n\r\n```\r\nPUT test/doc/goodshape\r\n{\r\n  \"shape\": \"Polygon ((3 3, 1 3, 2 2, 1 1, 3 1, 2 2, 3 3))\"\r\n}\r\n``` \r\n\r\nTest that reproduces the issue is here https://github.com/imotov/elasticsearch/commit/8a45cda6654536786f479c8bcebb7dcb1c0daf10\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451877790","html_url":"https://github.com/elastic/elasticsearch/issues/36883#issuecomment-451877790","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","id":451877790,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTg3Nzc5MA==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2019-01-07T09:43:32Z","updated_at":"2019-01-07T09:43:32Z","author_association":"CONTRIBUTOR","body":"Thanks @imotov, yes your example hits the same piece of code the generates the other error. I am wondering if we really need to break the polygon in those cases. I think this is only needed if the polygon crosses the dateline, else let the tessellator work on the given polygon.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/523860521","html_url":"https://github.com/elastic/elasticsearch/issues/36883#issuecomment-523860521","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","id":523860521,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzg2MDUyMQ==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2019-08-22T11:12:40Z","updated_at":"2019-08-22T11:12:40Z","author_association":"CONTRIBUTOR","body":"I think this issue was solved on #41051. The error message we get now looks like:\r\n\r\n```\r\ninvalid_shape_exception: Self-intersection at or near point [-84.7769699,33.4275589,0.0]]\r\n```\r\n\r\n@imotov can you double check?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/524979475","html_url":"https://github.com/elastic/elasticsearch/issues/36883#issuecomment-524979475","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","id":524979475,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNDk3OTQ3NQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-08-26T18:42:40Z","updated_at":"2019-08-26T18:42:40Z","author_association":"MEMBER","body":"Indeed, now I am getting:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse field [shape] of type [geo_shape]\"\r\n      }\r\n    ],\r\n    \"type\": \"mapper_parsing_exception\",\r\n    \"reason\": \"failed to parse field [shape] of type [geo_shape]\",\r\n    \"caused_by\": {\r\n      \"type\": \"invalid_shape_exception\",\r\n      \"reason\": \"Self-intersection at or near point [2.0,2.0,0.0]\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nClosing. \r\n\r\nFixed by  #41051","performed_via_github_app":null}]