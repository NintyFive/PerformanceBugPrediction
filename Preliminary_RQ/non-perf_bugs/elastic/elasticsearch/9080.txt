{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9080","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9080/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9080/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9080/events","html_url":"https://github.com/elastic/elasticsearch/issues/9080","id":53007227,"node_id":"MDU6SXNzdWU1MzAwNzIyNw==","number":9080,"title":"[GEO] GIS envelope validation","user":{"login":"missinglink","id":738069,"node_id":"MDQ6VXNlcjczODA2OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/738069?v=4","gravatar_id":"","url":"https://api.github.com/users/missinglink","html_url":"https://github.com/missinglink","followers_url":"https://api.github.com/users/missinglink/followers","following_url":"https://api.github.com/users/missinglink/following{/other_user}","gists_url":"https://api.github.com/users/missinglink/gists{/gist_id}","starred_url":"https://api.github.com/users/missinglink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/missinglink/subscriptions","organizations_url":"https://api.github.com/users/missinglink/orgs","repos_url":"https://api.github.com/users/missinglink/repos","events_url":"https://api.github.com/users/missinglink/events{/privacy}","received_events_url":"https://api.github.com/users/missinglink/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":157995054,"node_id":"MDU6TGFiZWwxNTc5OTUwNTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.3","name":"v1.4.3","color":"dddddd","default":false,"description":null},{"id":127700367,"node_id":"MDU6TGFiZWwxMjc3MDAzNjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.5.0","name":"v1.5.0","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2014-12-28T19:04:58Z","updated_at":"2014-12-30T17:58:51Z","closed_at":"2014-12-30T17:58:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This is likely related to `spatial4j`. There is an inconsistency _[bug?]_ in the way the `envelope` `geo-shape` type is being validated.\n\n[The docs](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-geo-shape-type.html#_envelope) say that the `envelope` format `\"consists of coordinates for upper left and lower right points of the shape to represent a bounding rectangle\"`.\n\nHowever, being human it's pretty easy to screw this up, of the 4 different ways you can specify the co-ordinates; one is correct, two throw validation errors and one bites you every time by not throwing and messing up all your results.\n\nBelow I've attached a minimal testcase which outlines the 3 different ways you could screw up specifying the `envelope` and the status code and error produced for each.\n\nI would expect the **last request** to error the same as the previous 2 do with a message like `\"maxX must be >= minX: 1.0 to -1.0\"`\n\nhere's an example of the sort of confusion this causes:\n- https://github.com/elasticsearch/elasticsearch/issues/9079\n- https://github.com/elasticsearch/elasticsearch/issues/9067\n\nThere's actually a bunch more like this in the issue tracker so it's pretty `low-hanging-fruit` for resolving much frustration, complaining and time-wasting with GIS bbox queries in ES.\n\n``` bash\n#!/bin/bash\n\n################################################\n# geo_shape envelope validation\n################################################\n\nES='localhost:9200';\n\n# drop index\ncurl -XDELETE \"$ES/foo?pretty=true\" 2>/dev/null;\n\n# create index\ncurl -XPUT \"$ES/foo?pretty=true\" -d'\n{ \n  \"settings\": {\n    \"index\": {\n      \"number_of_shards\": 1,\n      \"number_of_replicas\": 0\n    }\n  },\n  \"mappings\": {\n    \"bar\": {\n      \"properties\": {\n        \"polys\" : {\n          \"type\" : \"geo_shape\",\n          \"tree\" : \"quadtree\",\n          \"tree_levels\" : \"26\"\n        }\n      }\n    }\n  }\n}';\n\n# index a single polygon, so the index isn't empty\ncurl -XPOST \"$ES/foo/bar/1?pretty=true\" -d'\n{\n  \"polys\":{\n    \"type\":\"Polygon\",\n    \"coordinates\":[[\n      [\"-1\",\"1\"],\n      [\"-1\",\"-1\"],\n      [\"1\",\"-1\"],\n      [\"1\",\"1\"],\n      [\"-1\",\"1\"]\n    ]]\n  }\n}';\n\n# top-left / bottom-right (correct)\n#200 OK\ncurl -XPOST \"$ES/foo/_search?pretty=true\" -d'\n{\n  \"query\": {\n    \"geo_shape\": {\n      \"polys\": {\n        \"shape\": {\n          \"type\": \"envelope\",\n          \"coordinates\": [\n            [\"-1\", \"1\"],\n            [\"1\", \"-1\"]\n          ]\n        }\n      }\n    }\n  }\n}';\n\n# bottom-left / top-right (wrong)\n#400 InvalidShapeException[maxY must be >= minY: 1.0 to -1.0]\ncurl -XPOST \"$ES/foo/_search?pretty=true\" -d'\n{\n  \"query\": {\n    \"geo_shape\": {\n      \"polys\": {\n        \"shape\": {\n          \"type\": \"envelope\",\n          \"coordinates\": [\n            [\"-1\", \"-1\"],\n            [\"1\", \"1\"]\n          ]\n        }\n      }\n    }\n  }\n}';\n\n# bottom-right / top-left (wrong)\n#400 InvalidShapeException[maxY must be >= minY: 1.0 to -1.0]\ncurl -XPOST \"$ES/foo/_search?pretty=true\" -d'\n{\n  \"query\": {\n    \"geo_shape\": {\n      \"polys\": {\n        \"shape\": {\n          \"type\": \"envelope\",\n          \"coordinates\": [\n            [\"1\", \"-1\"],\n            [\"-1\", \"1\"]\n          ]\n        }\n      }\n    }\n  }\n}';\n\n# top-right / bottom-left (wrong)\n#200 OK\ncurl -XPOST \"$ES/foo/_search?pretty=true\" -d'\n{\n  \"query\": {\n    \"geo_shape\": {\n      \"polys\": {\n        \"shape\": {\n          \"type\": \"envelope\",\n          \"coordinates\": [\n            [\"1\", \"1\"],\n            [\"-1\", \"-1\"]\n          ]\n        }\n      }\n    }\n  }\n}';\n```\n","closed_by":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"performed_via_github_app":null}