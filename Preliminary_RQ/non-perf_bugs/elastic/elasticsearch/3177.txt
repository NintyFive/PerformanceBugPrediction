{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3177","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3177/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3177/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3177/events","html_url":"https://github.com/elastic/elasticsearch/issues/3177","id":15510842,"node_id":"MDU6SXNzdWUxNTUxMDg0Mg==","number":3177,"title":"NPE in query execution of boolean filter in 0.90.1","user":{"login":"jredburn","id":884775,"node_id":"MDQ6VXNlcjg4NDc3NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/884775?v=4","gravatar_id":"","url":"https://api.github.com/users/jredburn","html_url":"https://github.com/jredburn","followers_url":"https://api.github.com/users/jredburn/followers","following_url":"https://api.github.com/users/jredburn/following{/other_user}","gists_url":"https://api.github.com/users/jredburn/gists{/gist_id}","starred_url":"https://api.github.com/users/jredburn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jredburn/subscriptions","organizations_url":"https://api.github.com/users/jredburn/orgs","repos_url":"https://api.github.com/users/jredburn/repos","events_url":"https://api.github.com/users/jredburn/events{/privacy}","received_events_url":"https://api.github.com/users/jredburn/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":41588718,"node_id":"MDU6TGFiZWw0MTU4ODcxOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.2","name":"v0.90.2","color":"DDDDDD","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2013-06-13T15:17:15Z","updated_at":"2013-06-14T14:18:04Z","closed_at":"2013-06-14T08:01:44Z","author_association":"NONE","active_lock_reason":null,"body":"Attempting to upgrade to 0.90.1 (from 0.90.0) and seeing a new NPE for certain queries (specific generated boolean query with `not` section).\n\nDetails below -- happy to provide more information to help track down but haven't had any luck so far reducing this to simpler case.\n\nThe error is:\n\n```\n[2013-06-13 11:04:12,411][DEBUG][action.search.type       ] [Mop Man] [product-development-1][0], node[2njk8xyQQUSqmjVuG51JiA], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@4e299813]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [product-development-1][0]: query[filtered(ConstantScore(+QueryWrapperFilter(ToParentBlockJoinQuery (filtered(ConstantScore(+cache(properties.name.id:Product Category) +cache(properties.value.id:13351)))->cache(_type:__properties))) QueryWrapperFilter(ToParentBlockJoinQuery (filtered(ConstantScore(+cache(categories.name.id:Product Category) +cache(categories.value.id:13351)))->cache(_type:__categories))) +NotFilter(QueryWrapperFilter(ToParentBlockJoinQuery (filtered(ConstantScore(+cache(properties.name.id:ProductName) +cache(properties.value.id:drive converter)))->cache(_type:__properties))) QueryWrapperFilter(ToParentBlockJoinQuery (filtered(ConstantScore(+cache(categories.name.id:ProductName) +cache(categories.value.id:drive converter)))->cache(_type:__categories))))))->cache(org.elasticsearch.index.search.nested.NonNestedDocsFilter@953b6c6c)],from[0],size[10]: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:138)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:239)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:141)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:206)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:193)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:179)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)\n    at java.lang.Thread.run(Thread.java:680)\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.common.lucene.docset.NotDocIdSet$IteratorBasedIterator.cost(NotDocIdSet.java:168)\n    at org.elasticsearch.common.lucene.docset.AndDocIdSet$IteratorBasedIterator.<init>(AndDocIdSet.java:140)\n    at org.elasticsearch.common.lucene.docset.AndDocIdSet.iterator(AndDocIdSet.java:82)\n    at org.apache.lucene.search.ConstantScoreQuery$ConstantWeight.scorer(ConstantScoreQuery.java:135)\n    at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.filteredScorer(FilteredQuery.java:538)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:133)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:609)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:161)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:482)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:438)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:134)\n    ... 9 more\n```\n\nQuery is:\n\n``` json\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"and\": [\n          {\n            \"or\": [\n              {\n                \"nested\": {\n                  \"path\": \"properties\",\n                  \"query\": {\n                    \"filtered\": {\n                      \"filter\": {\n                        \"and\": [\n                          {\n                            \"term\": {\n                              \"properties.name.id\": \"Product Category\"\n                            }\n                          },\n                          {\n                            \"term\": {\n                              \"properties.value.id\": \"13351\"\n                            }\n                          }\n                        ]\n                      }\n                    }\n                  }\n                }\n              },\n              {\n                \"nested\": {\n                  \"path\": \"categories\",\n                  \"query\": {\n                    \"filtered\": {\n                      \"filter\": {\n                        \"and\": [\n                          {\n                            \"term\": {\n                              \"categories.name.id\": \"Product Category\"\n                            }\n                          },\n                          {\n                            \"term\": {\n                              \"categories.value.id\": \"13351\"\n                            }\n                          }\n                        ]\n                      }\n                    }\n                  }\n                }\n              }\n            ]\n          },\n          {\n            \"not\": {\n              \"or\": [\n                {\n                  \"nested\": {\n                    \"path\": \"properties\",\n                    \"query\": {\n                      \"filtered\": {\n                        \"filter\": {\n                          \"and\": [\n                            {\n                              \"term\": {\n                                \"properties.name.id\": \"ProductName\"\n                              }\n                            },\n                            {\n                              \"term\": {\n                                \"properties.value.id\": \"drive converter\"\n                              }\n                            }\n                          ]\n                        }\n                      }\n                    }\n                  }\n                },\n                {\n                  \"nested\": {\n                    \"path\": \"categories\",\n                    \"query\": {\n                      \"filtered\": {\n                        \"filter\": {\n                          \"and\": [\n                            {\n                              \"term\": {\n                                \"categories.name.id\": \"ProductName\"\n                              }\n                            },\n                            {\n                              \"term\": {\n                                \"categories.value.id\": \"drive converter\"\n                              }\n                            }\n                          ]\n                        }\n                      }\n                    }\n                  }\n                }\n              ]\n            }\n          }\n        ]\n      }\n    }\n  },\n  \"fields\": [\n    \"id\"\n  ]\n}\n```\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}