{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3965","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3965/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3965/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3965/events","html_url":"https://github.com/elastic/elasticsearch/issues/3965","id":21523266,"node_id":"MDU6SXNzdWUyMTUyMzI2Ng==","number":3965,"title":"NullPointerException using \"has_child\" filter after upgrade to v0.90.5","user":{"login":"ajhalani","id":1163503,"node_id":"MDQ6VXNlcjExNjM1MDM=","avatar_url":"https://avatars3.githubusercontent.com/u/1163503?v=4","gravatar_id":"","url":"https://api.github.com/users/ajhalani","html_url":"https://github.com/ajhalani","followers_url":"https://api.github.com/users/ajhalani/followers","following_url":"https://api.github.com/users/ajhalani/following{/other_user}","gists_url":"https://api.github.com/users/ajhalani/gists{/gist_id}","starred_url":"https://api.github.com/users/ajhalani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajhalani/subscriptions","organizations_url":"https://api.github.com/users/ajhalani/orgs","repos_url":"https://api.github.com/users/ajhalani/repos","events_url":"https://api.github.com/users/ajhalani/events{/privacy}","received_events_url":"https://api.github.com/users/ajhalani/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":56772237,"node_id":"MDU6TGFiZWw1Njc3MjIzNw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.6","name":"v0.90.6","color":"e0e0e0","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2013-10-24T13:46:23Z","updated_at":"2014-01-12T06:57:44Z","closed_at":"2013-10-24T19:03:26Z","author_association":"NONE","active_lock_reason":null,"body":"After upgrading from v0.90.1 -> v0.90.5, we noticed that some of our has_child filter queries started to fail on some shards. Following is the request - \n\n```\ncurl -x '' -s -XPOST 'http://localhost:9201/data_index_20131011/vendor/_search?from=0&size=2' -d '\n{\n  \"filter\" : {\n    \"has_child\" : {\n      \"query\" : {\n        \"match\" : {\n          \"set_aside_descriptions\" : {\n            \"query\" : \"No set aside used.\"\n          }\n        }\n      },\n      \"type\" : \"transaction\"\n    }\n  }\n}\n'\n```\n\nGives failure in response \n\n```\n  \"_shards\" : {\n    \"total\" : 4,\n    \"successful\" : 2,\n    \"failed\" : 2,\n    \"failures\" : [ {\n      \"index\" : \"data_index_20131011\",\n      \"shard\" : 0,\n      \"status\" : 500,\n      \"reason\" : \"RemoteTransportException[[mach2.node][inet[/<internal ip>:9301]][search/phase/query]]; nested: QueryPhaseExecutionException[[data_index_20131011][0]: query[ConstantScore(cache(_type:vendor))],from[0],size[2]: Query Failed [Failed to execute main query]]; nested: NullPointerException; \"\n    }, {\n      \"index\" : \"data_index_20131011\",\n      \"shard\" : 1,\n      \"status\" : 500,\n      \"reason\" : \"QueryPhaseExecutionException[[data_index_20131011][1]: query[ConstantScore(cache(_type:vendor))],from[0],size[2]: Query Failed [Failed to execute main query]]; nested: NullPointerException; \"\n    } ]\n  },\n\n```\n\nAnd the error trace from logs - \n\n```\n[2013-10-24 08:54:07,330][TRACE][search                   ] [mach2.node] Query phase failed\norg.elasticsearch.search.query.QueryPhaseExecutionException: [data_index_20131011][0]: query[ConstantScore(cache(_type:vendor))],from[0],size[2]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:138)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:219)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:623)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:612)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.run(MessageChannelHandler.java:269)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n        at java.lang.Thread.run(Thread.java:722)\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.common.lucene.docset.MatchDocIdSet.shortCircuit(MatchDocIdSet.java:82)\n        at org.elasticsearch.index.search.child.HasChildFilter$ParentDocSet.matchDoc(HasChildFilter.java:174)\n        at org.elasticsearch.common.lucene.docset.MatchDocIdSet.get(MatchDocIdSet.java:69)\n        at org.elasticsearch.common.lucene.search.FilteredCollector.collect(FilteredCollector.java:61)\n        at org.apache.lucene.search.Scorer.score(Scorer.java:65)\n        at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.score(ConstantScoreQuery.java:245)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:624)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:162)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:488)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:444)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:134)\n        ... 7 more\n```\n\nThe same query works fine in v0.90.1. It's tough to provide a gist to replicate because the error is data dependent and index size is more than a GB, it only happens for some queries. For e.g. \n`\"query\" : \"blah blah\"` works fine but \n`\"query\" : \"No set aside used.\"` fails. \n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}