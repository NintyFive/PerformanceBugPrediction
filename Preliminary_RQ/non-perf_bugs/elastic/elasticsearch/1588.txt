{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1588","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1588/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1588/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1588/events","html_url":"https://github.com/elastic/elasticsearch/issues/1588","id":2731506,"node_id":"MDU6SXNzdWUyNzMxNTA2","number":1588,"title":"CouchDB river plugin fails to delete documents in multi-type indices","user":{"login":"deverton","id":287143,"node_id":"MDQ6VXNlcjI4NzE0Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/287143?v=4","gravatar_id":"","url":"https://api.github.com/users/deverton","html_url":"https://github.com/deverton","followers_url":"https://api.github.com/users/deverton/followers","following_url":"https://api.github.com/users/deverton/following{/other_user}","gists_url":"https://api.github.com/users/deverton/gists{/gist_id}","starred_url":"https://api.github.com/users/deverton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/deverton/subscriptions","organizations_url":"https://api.github.com/users/deverton/orgs","repos_url":"https://api.github.com/users/deverton/repos","events_url":"https://api.github.com/users/deverton/events{/privacy}","received_events_url":"https://api.github.com/users/deverton/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2012-01-05T03:51:12Z","updated_at":"2012-01-05T04:44:51Z","closed_at":"2012-01-05T04:44:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"We have a CouchDB river configured like this:\n\n``` json\n{\n    \"type\" : \"couchdb\",\n    \"couchdb\" : {\n        \"host\" : \"couchdb-host\",\n        \"port\" : 5984,\n        \"db\" : \"database\",\n        \"script\" : \"ctx._type = ctx.doc.type; if (ctx.doc.parent_id) ctx._parent = ctx.doc.parent_id\"\n    }\n}\n```\n\nThe CouchDB database contains documents of various types which are mapped to Elasticsearch index types. The problem comes when one of those documents is deleted.\n\nThe changes feed doesn't seem to include the document data when a delete occurs so the script configured for the river can't decide the correct _type. Thus Elasticsearch ends up issuing a delete for a document that doesn't exist.\n\nA workaround for this is to create one river per type with a filter function on the changes feed but this won't scale nicely if there's many document types.\n","closed_by":{"login":"deverton","id":287143,"node_id":"MDQ6VXNlcjI4NzE0Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/287143?v=4","gravatar_id":"","url":"https://api.github.com/users/deverton","html_url":"https://github.com/deverton","followers_url":"https://api.github.com/users/deverton/followers","following_url":"https://api.github.com/users/deverton/following{/other_user}","gists_url":"https://api.github.com/users/deverton/gists{/gist_id}","starred_url":"https://api.github.com/users/deverton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/deverton/subscriptions","organizations_url":"https://api.github.com/users/deverton/orgs","repos_url":"https://api.github.com/users/deverton/repos","events_url":"https://api.github.com/users/deverton/events{/privacy}","received_events_url":"https://api.github.com/users/deverton/received_events","type":"User","site_admin":false},"performed_via_github_app":null}