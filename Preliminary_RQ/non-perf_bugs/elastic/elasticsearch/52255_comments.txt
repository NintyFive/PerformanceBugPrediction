[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585098877","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585098877","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585098877,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTA5ODg3Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T08:54:30Z","updated_at":"2020-02-12T08:54:30Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/Discovery-Plugins)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585109764","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585109764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585109764,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTEwOTc2NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T09:20:53Z","updated_at":"2020-02-12T09:33:18Z","author_association":"CONTRIBUTOR","body":"Hi @michael-robbins, thanks for the idea. I have some questions:\r\n\r\n1. Multi-homed hosts make discovery complicated in two different ways: each node must select the correct publish address at startup, and then other nodes must be able to find that address later. The `ec2-discovery` plugin adds features to both aspects and it's not clear if your issue is with the first or the second (or both). Are your nodes selecting the correct publish address? The publish address is reported in a log message from `o.e.t.TransportService` shortly after startup.\r\n\r\n2. ECS, unlike bare EC2, supports [its own DNS-based service discovery mechanism](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-discovery.html) that sounds like it fits your needs. Have you tried this?\r\n\r\n3. Can you work around this using the [file-based seed hosts provider](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-hosts-providers.html#file-based-hosts-provider) by populating the `unicast_hosts.txt` file yourself?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585119015","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585119015","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585119015,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTExOTAxNQ==","user":{"login":"michael-robbins","id":1548818,"node_id":"MDQ6VXNlcjE1NDg4MTg=","avatar_url":"https://avatars1.githubusercontent.com/u/1548818?v=4","gravatar_id":"","url":"https://api.github.com/users/michael-robbins","html_url":"https://github.com/michael-robbins","followers_url":"https://api.github.com/users/michael-robbins/followers","following_url":"https://api.github.com/users/michael-robbins/following{/other_user}","gists_url":"https://api.github.com/users/michael-robbins/gists{/gist_id}","starred_url":"https://api.github.com/users/michael-robbins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michael-robbins/subscriptions","organizations_url":"https://api.github.com/users/michael-robbins/orgs","repos_url":"https://api.github.com/users/michael-robbins/repos","events_url":"https://api.github.com/users/michael-robbins/events{/privacy}","received_events_url":"https://api.github.com/users/michael-robbins/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T09:42:36Z","updated_at":"2020-02-12T09:43:20Z","author_association":"NONE","body":"Thanks for the info Dave! Here's my context/knowledge!\r\n\r\n1. The nodes are selecting the correct publish address (they only see a single address, which is *the* address/interface they are given), no other host network interfaces/IP address are present to confuse the container. All nodes have TCP/9300 to each other, so they have network access to each other in a local 10/8 private range, it's just knowing which IP addresses to talk to which is the problem.\r\n\r\n2. I did look at ECS's Service Discovery, but (and I could just not understand ES here properly), the DNS A record returns multiple IPs (one for each ES node running). So a request to 'es.my.domain.com' will return a list of IP addresses for each node/task running. It doesn't automatically register node1.es.my.domain.com, node2.es.my.domain.com, node3.es.my.domain.com, etc. for each running node.\r\n\r\nWould the above case work if I just hardcoded es.my.domain.com into each node's seed_hosts? (a single host entry, resolving to multiple IPs). And assume that ES will interpret the A record response with multiple IP addresses and connect to each host? If so then that sounds like it might be worth a shot. Otherwise this didn't really sound suitable for me at first glance.\r\n\r\n3. This is probably going to be my backup solution in the mean time, have either a custom entrypoint in the container before ES is initiated that populates that file, or have a sidecar container running that will populate the file. It's probably going to have to be this way forward for now, but it would be nice without having to do this, and discovery-ec2 performing this manual lookup instead. \r\nAll that script would be doing would be emulating discovery-ec2's DescribeInstances but just implementing some further business logic around inspecting the attached network interfaces.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585127011","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585127011","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585127011,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTEyNzAxMQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T10:01:46Z","updated_at":"2020-02-12T10:01:46Z","author_association":"CONTRIBUTOR","body":"> The nodes are selecting the correct publish address\r\n\r\nGood, I hoped for that answer :smile:\r\n\r\n> Would the above case work if I just hardcoded es.my.domain.com into each node's seed_hosts? (a single host entry, resolving to multiple IPs). And assume that ES will interpret the A record response with multiple IP addresses and connect to each host?\r\n\r\nYes, [that's the documented behaviour](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-hosts-providers.html#built-in-hosts-providers):\r\n\r\n> ... If a hostname resolves to multiple IP addresses then Elasticsearch tries to find a seed node at all of these addresses.\r\n\r\nYou should try and arrange for the DNS name to resolve only to the master-eligible nodes' addresses here. There's a limit to how many addresses are returned by AWS's service discovery mechanism (8 IIRC) and you need to ensure that the right addresses aren't squeezed out with inappropriate ones.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585140413","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585140413","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585140413,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTE0MDQxMw==","user":{"login":"michael-robbins","id":1548818,"node_id":"MDQ6VXNlcjE1NDg4MTg=","avatar_url":"https://avatars1.githubusercontent.com/u/1548818?v=4","gravatar_id":"","url":"https://api.github.com/users/michael-robbins","html_url":"https://github.com/michael-robbins","followers_url":"https://api.github.com/users/michael-robbins/followers","following_url":"https://api.github.com/users/michael-robbins/following{/other_user}","gists_url":"https://api.github.com/users/michael-robbins/gists{/gist_id}","starred_url":"https://api.github.com/users/michael-robbins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michael-robbins/subscriptions","organizations_url":"https://api.github.com/users/michael-robbins/orgs","repos_url":"https://api.github.com/users/michael-robbins/repos","events_url":"https://api.github.com/users/michael-robbins/events{/privacy}","received_events_url":"https://api.github.com/users/michael-robbins/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T10:33:18Z","updated_at":"2020-02-12T10:33:18Z","author_association":"NONE","body":"Ahh I missed that line, dang it, thanks for the help mate! I'll have a go at configuring that and giving it a whirl.\r\n\r\nYeah I'll only be provisioning nodes that are master-eligible so that's at least something I don't have to worry about for now.\r\n\r\nCheers for the help!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585145937","html_url":"https://github.com/elastic/elasticsearch/issues/52255#issuecomment-585145937","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52255","id":585145937,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTE0NTkzNw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T10:46:52Z","updated_at":"2020-02-12T10:47:27Z","author_association":"CONTRIBUTOR","body":"Sounds good.\r\n\r\nFWIW I think the original point is a valid one. Today we only look at the addresses that belong to the instance itself and do not consider any attached ENIs, but we could add that if there was enough support for the idea. A quick search doesn't turn up anyone else asking for it before this issue, but if we see some support here then we can always revisit this. Comments and +1s (or even a PR) from the community are welcome.","performed_via_github_app":null}]