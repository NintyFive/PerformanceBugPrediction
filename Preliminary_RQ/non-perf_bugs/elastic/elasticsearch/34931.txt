{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34931","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34931/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34931/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34931/events","html_url":"https://github.com/elastic/elasticsearch/issues/34931","id":374506178,"node_id":"MDU6SXNzdWUzNzQ1MDYxNzg=","number":34931,"title":"Elasticsearch Node fails to rejoin cluster on restart in 6.4.x when SSL configured on transport and no license installed","user":{"login":"bsturg","id":43001889,"node_id":"MDQ6VXNlcjQzMDAxODg5","avatar_url":"https://avatars3.githubusercontent.com/u/43001889?v=4","gravatar_id":"","url":"https://api.github.com/users/bsturg","html_url":"https://github.com/bsturg","followers_url":"https://api.github.com/users/bsturg/followers","following_url":"https://api.github.com/users/bsturg/following{/other_user}","gists_url":"https://api.github.com/users/bsturg/gists{/gist_id}","starred_url":"https://api.github.com/users/bsturg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bsturg/subscriptions","organizations_url":"https://api.github.com/users/bsturg/orgs","repos_url":"https://api.github.com/users/bsturg/repos","events_url":"https://api.github.com/users/bsturg/events{/privacy}","received_events_url":"https://api.github.com/users/bsturg/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2018-10-26T18:53:52Z","updated_at":"2020-02-24T15:51:07Z","closed_at":"2020-02-24T15:51:07Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):  \r\n6.4.x\r\n\r\n**Plugins installed**: []\r\nnone\r\n\r\n\r\n**JVM version** (`java -version`):\r\njava 1.8.0_181\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentos 7.3\r\nLinux elastic1 3.10.0-862.el7.x86_64 #1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nConfiguration:  2 nodes in a cluster.  Only elasticsearch is installed.\r\n.\r\nStarting in 6.4.x (verified it did not exist in 6.3.x), if SSL is implemented on elasticsearch transport and if a license has not been implemented on a cluster, the cluster starts and both nodes join.  \r\n -- This is an invalid configuration since license is not installed, but the behavior changed from previous versions.\r\n.\r\nWhen a node is restarted, it will not be allowed to rejoin a cluster.\r\n.\r\nIn order to allow the node to rejoin the cluster, the other nodes in the cluster must be restarted.\r\n\r\n\r\n**Steps to reproduce**:\r\n#Install 6.4.2 from rpm\r\n\r\nrpm -i elasticsearch-6.4.2.rpm\r\nsystemctl daemon-reload\r\nsystemctl enable elasticsearch.service\r\n\r\n#Generate .p12 - ca and cert\r\n\r\ncd /usr/share/elasticsearch\r\nbin/elasticsearch-certutil ca\r\nbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\r\ncopy .p12 to elasticsearch config\r\n\r\nes=/etc/elasticsearch\r\nmkdir ${es}/certs\r\nchown -R elasticsearch:elasticsearch ${es}/certs\r\ncp elastic-certificates.p12 ${es}/certs\r\nchown -R elasticsearch:elasticsearch ${es}/certs\r\nchmod 644 ${es}/certs/*\r\nls -l ${es}/certs\r\n\r\n#clean up logs and start with a brand new empty db\r\n\r\nrm -rf /var/lib/ela*/nodes\r\nrm -f /var/log/elast*/*\r\nstart elasticsearch and watch logs; once the handshake is completed between master nodes, restart a node\r\n\r\nsystemctl start elasticsearch\r\ntail -f /var/log/el*/*cluster.log\r\n\r\n\r\nRestart one node;  it will not join the cluster.\r\n\r\nErrors seen on node:\r\n[WARN ][o.e.x.s.t.n.SecurityNetty4ServerTransport] [brian-node2] exception caught on transport layer [NettyTcpChannel{localAddress=0.0.0.0/0.0.0.0:9300, remoteAddress=/192.168.200.178:49532}], closing connection\r\nio.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: Received close_notify during handshake\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n[try2.tar.gz](https://github.com/elastic/elasticsearch/files/2520475/try2.tar.gz)\r\n\r\n@inqueue\r\n","closed_by":{"login":"bsturg","id":43001889,"node_id":"MDQ6VXNlcjQzMDAxODg5","avatar_url":"https://avatars3.githubusercontent.com/u/43001889?v=4","gravatar_id":"","url":"https://api.github.com/users/bsturg","html_url":"https://github.com/bsturg","followers_url":"https://api.github.com/users/bsturg/followers","following_url":"https://api.github.com/users/bsturg/following{/other_user}","gists_url":"https://api.github.com/users/bsturg/gists{/gist_id}","starred_url":"https://api.github.com/users/bsturg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bsturg/subscriptions","organizations_url":"https://api.github.com/users/bsturg/orgs","repos_url":"https://api.github.com/users/bsturg/repos","events_url":"https://api.github.com/users/bsturg/events{/privacy}","received_events_url":"https://api.github.com/users/bsturg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}