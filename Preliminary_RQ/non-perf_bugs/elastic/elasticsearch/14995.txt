{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14995","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14995/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14995/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14995/events","html_url":"https://github.com/elastic/elasticsearch/issues/14995","id":118776471,"node_id":"MDU6SXNzdWUxMTg3NzY0NzE=","number":14995,"title":"##如何对aggregations聚合结果在进行条件查询，过滤出符合条件的buck，针对es2.0","user":{"login":"zqr688","id":4476265,"node_id":"MDQ6VXNlcjQ0NzYyNjU=","avatar_url":"https://avatars1.githubusercontent.com/u/4476265?v=4","gravatar_id":"","url":"https://api.github.com/users/zqr688","html_url":"https://github.com/zqr688","followers_url":"https://api.github.com/users/zqr688/followers","following_url":"https://api.github.com/users/zqr688/following{/other_user}","gists_url":"https://api.github.com/users/zqr688/gists{/gist_id}","starred_url":"https://api.github.com/users/zqr688/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zqr688/subscriptions","organizations_url":"https://api.github.com/users/zqr688/orgs","repos_url":"https://api.github.com/users/zqr688/repos","events_url":"https://api.github.com/users/zqr688/events{/privacy}","received_events_url":"https://api.github.com/users/zqr688/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-11-25T07:06:26Z","updated_at":"2015-11-25T07:45:47Z","closed_at":"2015-11-25T07:39:31Z","author_association":"NONE","active_lock_reason":null,"body":"例如\n**一、数据源**\ncurl -XPUT 'http://localhost:9200/order/static_type/1' -d '{  \"orderid\": \"00001\",\"time\":1,\"f1\":\"A\" }'\ncurl -XPUT 'http://localhost:9200/order/static_type/2' -d '{  \"orderid\": \"00001\",\"time\":2,\"f2\":\"B1\" }'\ncurl -XPUT 'http://localhost:9200/order/static_type/3' -d '{  \"orderid\": \"00001\",\"time\":3 ,\"f2\":\"B2\",\"f3\":\"C1\"}'\ncurl -XPUT 'http://localhost:9200/order/static_type/4' -d '{  \"orderid\": \"00001\",\"time\":4 ,\"f3\":\"C2\"}'\ncurl -XPUT 'http://localhost:9200/order/static_type/5' -d '{  \"orderid\": \"00001\",\"time\":5 ,\"f4\":\"D\"}' \ncurl -XPUT 'http://localhost:9200/order/static_type/6' -d '{  \"orderid\": \"00001\",\"time\":6 ,\"f5\":2}'\ncurl -XPUT 'http://localhost:9200/order/static_type/7' -d '{  \"orderid\": \"00002\",\"time\":1 ,\"f1\":\"E\"}'\ncurl -XPUT 'http://localhost:9200/order/static_type/8' -d '{  \"orderid\": \"00002\",\"time\":3 ,\"f1\":\"A\",\"f2\":\"B\"}'\n**二、按orderid做aggregations聚合**\n{\n  \"aggregations\": {\n    \"orderid\": {\n      \"terms\": {\n        \"field\": \"orderid\"\n      },\n      \"aggregations\": {\n        \"f2s\": {\n          \"terms\": {\n            \"field\": \"f2\"\n          }\n        },\n        \"f1s\": {\n          \"terms\": {\n            \"field\": \"f1\"\n          }\n        },\n        \"tmax\": {\n          \"max\": {\n            \"field\": \"time\"\n          }\n        },\n        \"tmin\": {\n          \"min\": {\n            \"field\": \"time\"\n          }\n        }\n      }\n    }\n  }\n}\n**三、结果两条记录：**\n![image](https://cloud.githubusercontent.com/assets/4476265/11390685/66fee60c-9387-11e5-9755-7f8f7cdfe162.png)\n\n**四、想要的结果就是，对三中的两条聚合结果记录集合能够根据orderid，f1s,f2s 作为查询条件，如果不符合查询条件的对应整条不要。**\n相当于将聚合结果作为第二次查询的数据源，例如，**筛选f1s=e  AND f2s =b的结果，想得到的是上述三中00002 这一行数据**。\n**请问需要怎样在上述json上加上筛选条件，谢谢！**\n{\n  \"aggregations\": {\n    \"orderid\": {\n      \"terms\": {\n        \"field\": \"orderid\"\n      },\n      \"aggregations\": {\n        \"f2s\": {\n          \"terms\": {\n            \"field\": \"f2\"\n          }\n        },\n        \"f1s\": {\n          \"terms\": {\n            \"field\": \"f1\"\n          }\n        },\n        \"tmax\": {\n          \"max\": {\n            \"field\": \"time\"\n          }\n        },\n        \"tmin\": {\n          \"min\": {\n            \"field\": \"time\"\n          }\n        }\n      }\n    }\n  }\n}\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}