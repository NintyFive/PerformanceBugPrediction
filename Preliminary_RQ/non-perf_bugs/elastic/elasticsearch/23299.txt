{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23299","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23299/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23299/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23299/events","html_url":"https://github.com/elastic/elasticsearch/issues/23299","id":209333815,"node_id":"MDU6SXNzdWUyMDkzMzM4MTU=","number":23299,"title":"ES Crashes When Using A Nest Document Agg, Then Specifying The Path A Second Time","user":{"login":"neoform","id":3719298,"node_id":"MDQ6VXNlcjM3MTkyOTg=","avatar_url":"https://avatars3.githubusercontent.com/u/3719298?v=4","gravatar_id":"","url":"https://api.github.com/users/neoform","html_url":"https://github.com/neoform","followers_url":"https://api.github.com/users/neoform/followers","following_url":"https://api.github.com/users/neoform/following{/other_user}","gists_url":"https://api.github.com/users/neoform/gists{/gist_id}","starred_url":"https://api.github.com/users/neoform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoform/subscriptions","organizations_url":"https://api.github.com/users/neoform/orgs","repos_url":"https://api.github.com/users/neoform/repos","events_url":"https://api.github.com/users/neoform/events{/privacy}","received_events_url":"https://api.github.com/users/neoform/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-02-22T02:26:57Z","updated_at":"2017-02-22T23:20:21Z","closed_at":"2017-02-22T23:20:21Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.2.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_121\r\n\r\n**OS version**: Debian 8\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Possibly related to Issue**: #23280\r\n\r\n**Steps to reproduce**:\r\n 1. Create an agg that makes use of nested document.\r\n 2. In a sub-agg, list that path a second time.\r\n 3. Execute search\r\n 4. ElasticSearch crashes\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2017-02-21T21:19:15,059][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[ddjlYjR][search][T#3]], exiting\r\njava.lang.AssertionError: null\r\n\tat org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer$1.nextDoc(ToParentBlockJoinQuery.java:289) ~[lucene-join-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:44:23]\r\n\tat org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer$1.advance(ToParentBlockJoinQuery.java:382) ~[lucene-join-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:44:23]\r\n\tat org.elasticsearch.common.lucene.Lucene$3.get(Lucene.java:785) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator$1.collect(FilterAggregator.java:63) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.collectExistingBucket(BucketsAggregator.java:80) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.collectBucket(BucketsAggregator.java:72) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.nested.NestedAggregator$1.collect(NestedAggregator.java:89) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.AggregatorFactory$MultiBucketAggregatorWrapper$1.collect(AggregatorFactory.java:137) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.collectExistingBucket(BucketsAggregator.java:80) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.collectBucket(BucketsAggregator.java:72) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.global.GlobalAggregator$1.collect(GlobalAggregator.java:51) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:82) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:221) ~[lucene-core-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:43:32]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:172) ~[lucene-core-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:43:32]\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:43:32]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:669) ~[lucene-core-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:43:32]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473) ~[lucene-core-6.4.1.jar:6.4.1 72f75b2503fa0aa4f0aff76d439874feb923bb0e - jpountz - 2017-02-01 14:43:32]\r\n\tat org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:127) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:112) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:246) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:360) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$9.messageReceived(SearchTransportService.java:322) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$9.messageReceived(SearchTransportService.java:319) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:610) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.2.1.jar:5.2.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\n```\r\n\r\n**Describe the feature**:\r\n\r\n```javascript\r\n{\r\n    \"timeout\": \"6s\",\r\n    \"index\": \"product\",\r\n    \"type\": \"product\",\r\n    \"from\": 0,\r\n    \"size\": 40,\r\n    \"body\": {\r\n        \"_source\": [\r\n            \"mpn\",\r\n            \"cheapest_product_id\",\r\n            \"price\",\r\n            \"price_discount_percent\",\r\n            \"price_discount_amount\",\r\n            \"product_count\",\r\n            \"rank_weight\",\r\n            \"product.id\",\r\n            \"product.price\",\r\n            \"product.status_id\"\r\n        ],\r\n        \"query\": {\r\n            \"function_score\": {\r\n                \"query\": {\r\n                    \"bool\": {\r\n                        \"filter\": [\r\n                            {\r\n                                \"nested\": {\r\n                                    \"path\": \"product\",\r\n                                    \"query\": {\r\n                                        \"bool\": {\r\n                                            \"filter\": [\r\n                                                {\r\n                                                    \"term\": {\r\n                                                        \"product.status_id\": 1\r\n                                                    }\r\n                                                }\r\n                                            ]\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                \"functions\": [\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"product_count\",\r\n                            \"factor\": 50,\r\n                            \"modifier\": \"log1p\"\r\n                        }\r\n                    },\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"rank_weight\",\r\n                            \"modifier\": \"reciprocal\",\r\n                            \"missing\": 1\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        },\r\n        \"aggs\": {\r\n            \"brands\": {\r\n                \"global\": {},\r\n                \"aggs\": {\r\n                    \"brands\": {\r\n                        \"nested\": {\r\n                            \"path\": \"product.brand\"\r\n                        },\r\n                        \"aggs\": {\r\n                            \"brands\": {\r\n                                \"filter\": {\r\n                                    \"bool\": {\r\n                                        \"filter\": [\r\n                                            {\r\n                                                \"nested\": {\r\n                                                    \"path\": \"product\",\r\n                                                    \"query\": {\r\n                                                        \"bool\": {\r\n                                                            \"filter\": [\r\n                                                                {\r\n                                                                    \"term\": {\r\n                                                                        \"product.status_id\": 1\r\n                                                                    }\r\n                                                                }\r\n                                                            ]\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        ]\r\n                                    }\r\n                                },\r\n                                \"aggs\": {\r\n                                    \"brands\": {\r\n                                        \"nested\": {\r\n                                            \"path\": \"product.brand\"\r\n                                        },\r\n                                        \"aggs\": {\r\n                                            \"brands\": {\r\n                                                \"terms\": {\r\n                                                    \"field\": \"product.brand.id\",\r\n                                                    \"size\": 30\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\nFor comparison, this query does not crash the server.\r\n\r\n```javascript\r\n{\r\n    \"timeout\": \"6s\",\r\n    \"index\": \"product\",\r\n    \"type\": \"product\",\r\n    \"from\": 0,\r\n    \"size\": 40,\r\n    \"body\": {\r\n        \"_source\": [\r\n            \"mpn\",\r\n            \"cheapest_product_id\",\r\n            \"price\",\r\n            \"price_discount_percent\",\r\n            \"price_discount_amount\",\r\n            \"product_count\",\r\n            \"rank_weight\",\r\n            \"product.id\",\r\n            \"product.price\",\r\n            \"product.status_id\"\r\n        ],\r\n        \"query\": {\r\n            \"function_score\": {\r\n                \"query\": {\r\n                    \"bool\": {\r\n                        \"filter\": [\r\n                            {\r\n                                \"nested\": {\r\n                                    \"path\": \"product\",\r\n                                    \"query\": {\r\n                                        \"bool\": {\r\n                                            \"filter\": [\r\n                                                {\r\n                                                    \"term\": {\r\n                                                        \"product.status_id\": 1\r\n                                                    }\r\n                                                }\r\n                                            ]\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                \"functions\": [\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"product_count\",\r\n                            \"factor\": 50,\r\n                            \"modifier\": \"log1p\"\r\n                        }\r\n                    },\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"rank_weight\",\r\n                            \"modifier\": \"reciprocal\",\r\n                            \"missing\": 1\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        },\r\n        \"aggs\": {\r\n            \"brands\": {\r\n                \"global\": {},\r\n                \"aggs\": {\r\n                    \"brands\": {\r\n                        \"filter\": {\r\n                            \"bool\": {\r\n                                \"filter\": [\r\n                                    {\r\n                                        \"nested\": {\r\n                                            \"path\": \"product\",\r\n                                            \"query\": {\r\n                                                \"bool\": {\r\n                                                    \"filter\": [\r\n                                                        {\r\n                                                            \"term\": {\r\n                                                                \"product.status_id\": 1\r\n                                                            }\r\n                                                        }\r\n                                                    ]\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                ]\r\n                            }\r\n                        },\r\n                        \"aggs\": {\r\n                            \"brands\": {\r\n                                \"nested\": {\r\n                                    \"path\": \"product.brand\"\r\n                                },\r\n                                \"aggs\": {\r\n                                    \"brands\": {\r\n                                        \"terms\": {\r\n                                            \"field\": \"product.brand.id\",\r\n                                            \"size\": 30\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}