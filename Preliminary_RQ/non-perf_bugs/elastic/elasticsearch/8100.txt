{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8100","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8100/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8100/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8100/events","html_url":"https://github.com/elastic/elasticsearch/issues/8100","id":45901510,"node_id":"MDU6SXNzdWU0NTkwMTUxMA==","number":8100,"title":"Children aggregation for recursive parent-child relation leads to incorrect results","user":{"login":"whiter4bbit","id":61059,"node_id":"MDQ6VXNlcjYxMDU5","avatar_url":"https://avatars0.githubusercontent.com/u/61059?v=4","gravatar_id":"","url":"https://api.github.com/users/whiter4bbit","html_url":"https://github.com/whiter4bbit","followers_url":"https://api.github.com/users/whiter4bbit/followers","following_url":"https://api.github.com/users/whiter4bbit/following{/other_user}","gists_url":"https://api.github.com/users/whiter4bbit/gists{/gist_id}","starred_url":"https://api.github.com/users/whiter4bbit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whiter4bbit/subscriptions","organizations_url":"https://api.github.com/users/whiter4bbit/orgs","repos_url":"https://api.github.com/users/whiter4bbit/repos","events_url":"https://api.github.com/users/whiter4bbit/events{/privacy}","received_events_url":"https://api.github.com/users/whiter4bbit/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2014-10-15T18:27:47Z","updated_at":"2015-05-30T08:41:18Z","closed_at":"2015-05-30T08:41:16Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nI tried to create recursive parent-child relation:\n\nfamily-mapping.json:\n\n``` javascript\n{\n  \"mappings\": {\n    \"member\": {\n      \"_parent\": {\n        \"type\": \"member\" \n      },\n      \"properties\" : { \n        \"name\" : {\n          \"type\" : \"string\",\n          \"index\" : \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n```\n\nfamily.json:\n\n``` javascript\n{ \"index\" : { \"_id\" : \"1\", \"parent\" : \"0\" } }\n{ \"name\" : \"Abraham Simpson\" }\n{ \"index\" : { \"_id\" : \"2\", \"parent\" : \"1\" } }\n{ \"name\" : \"Homer J Simpson\" }\n{ \"index\" : { \"_id\" : \"3\", \"parent\" : \"2\" } }\n{ \"name\" : \"Bart Simpson\" }\n```\n\naggregation.json:\n\n``` javascript\n{\n  \"aggs\" : {\n    \"parent\" : {\n       \"terms\" : { \"field\" : \"name\" },\n       \"aggs\" : {\n          \"child-members\" : {\n             \"children\" : { \"type\" : \"member\" },\n             \"aggs\" : {\n               \"child-names\" : {\n                 \"terms\" : { \"field\" : \"name\" }\n               }\n             }\n          }\n       }\n    }\n  }\n}\n```\n\nWhen I'm trying to aggregate this data I'm getting child buckets inside parent ones with same name:\n\n``` javascript\n.....\n  \"aggregations\" : {\n    \"parent\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"Abraham Simpson\",\n        \"doc_count\" : 1,\n        \"child-members\" : {\n          \"doc_count\" : 1,\n          \"child-names\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"Abraham Simpson\",\n              \"doc_count\" : 1\n            } ]\n          }\n        }\n      }, {\n        \"key\" : \"Bart Simpson\",\n        \"doc_count\" : 1,\n        \"child-members\" : {\n          \"doc_count\" : 1,\n          \"child-names\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"Bart Simpson\",\n              \"doc_count\" : 1\n            } ]\n          }\n        }\n      }, {\n        \"key\" : \"Homer J Simpson\",\n        \"doc_count\" : 1,\n        \"child-members\" : {\n          \"doc_count\" : 1,\n          \"child-names\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"Homer J Simpson\",\n              \"doc_count\" : 1\n            } ]\n          }\n        }\n      } ]\n    }\n  }\n}\n```\n\nI'm using 1.4.0-beta1 version (downloaded from elasticsearch.org). \n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}