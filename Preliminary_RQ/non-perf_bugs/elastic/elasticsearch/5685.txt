{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5685","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5685/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5685/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5685/events","html_url":"https://github.com/elastic/elasticsearch/issues/5685","id":30848550,"node_id":"MDU6SXNzdWUzMDg0ODU1MA==","number":5685,"title":"Query validation doesn't detect extra JSON properties after the query property","user":{"login":"amarandon","id":101934,"node_id":"MDQ6VXNlcjEwMTkzNA==","avatar_url":"https://avatars2.githubusercontent.com/u/101934?v=4","gravatar_id":"","url":"https://api.github.com/users/amarandon","html_url":"https://github.com/amarandon","followers_url":"https://api.github.com/users/amarandon/followers","following_url":"https://api.github.com/users/amarandon/following{/other_user}","gists_url":"https://api.github.com/users/amarandon/gists{/gist_id}","starred_url":"https://api.github.com/users/amarandon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarandon/subscriptions","organizations_url":"https://api.github.com/users/amarandon/orgs","repos_url":"https://api.github.com/users/amarandon/repos","events_url":"https://api.github.com/users/amarandon/events{/privacy}","received_events_url":"https://api.github.com/users/amarandon/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":85667032,"node_id":"MDU6TGFiZWw4NTY2NzAzMg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.2.0","name":"v1.2.0","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2014-04-04T10:16:56Z","updated_at":"2014-09-08T00:25:08Z","closed_at":"2014-05-12T10:50:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"```\n$ curl -s 'http://localhost:9200/'|grep number\n    \"number\" : \"1.1.0\",\n```\n\nWhen validating a query, adding an extra property **after** the `query` does not trigger a validation error:\n\n``` shell\n$ curl -XPOST 'http://localhost:9200/test/_validate/query?pretty' -d '\n{\"query\": {\"term\" : { \"user\" : \"kimchy\" }}, \"foo\": \"bar\"}\n'\n```\n\n``` json\n{\n  \"valid\" : true,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  }\n}\n```\n\nIf the extra property is placed **before** the `query` property, a validation error is reported.\n\n``` shell\n$ curl -XPOST 'http://localhost:9200/test/_validate/query?pretty' -d '\n{\"foo\": \"bar\", \"query\": {\"term\" : { \"user\" : \"kimchy\" }}}\n'\n```\n\n``` json\n{\n  \"valid\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  }\n}\n```\n\nWhen doing an actual search however, both queries fail:\n\n``` shell\n$ curl 'http://localhost:9200/test/_search?pretty' -d '\n{\"foo\": \"bar\", \"query\": {\"term\" : { \"user\" : \"kimchy\" }}}\n'\n```\n\n``` json\n{\n  \"error\" : \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[FsbLm57PSNeCm5gRjO-uLA][test][4]: SearchParseException[[test][4]: from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"foo\\\": \\\"bar\\\", \\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}}\\n]]]; nested: SearchParseException[[test][4]: from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][3]: SearchParseException[[test][3]: from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"foo\\\": \\\"bar\\\", \\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}}\\n]]]; nested: SearchParseException[[test][3]: from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][2]: SearchParseException[[test][2]: from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"foo\\\": \\\"bar\\\", \\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}}\\n]]]; nested: SearchParseException[[test][2]: from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][0]: SearchParseException[[test][0]: from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"foo\\\": \\\"bar\\\", \\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}}\\n]]]; nested: SearchParseException[[test][0]: from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][1]: SearchParseException[[test][1]: from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"foo\\\": \\\"bar\\\", \\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}}\\n]]]; nested: SearchParseException[[test][1]: from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }]\",\n  \"status\" : 400\n}\n```\n\n``` shell\n$ curl 'http://localhost:9200/test/_search?pretty' -d '\n{\"query\": {\"term\" : { \"user\" : \"kimchy\" }}, \"foo\": \"bar\"}\n'\n```\n\n``` json\n{\n  \"error\" : \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[FsbLm57PSNeCm5gRjO-uLA][test][4]: SearchParseException[[test][4]: query[user:kimchy],from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}, \\\"foo\\\": \\\"bar\\\"}\\n]]]; nested: SearchParseException[[test][4]: query[user:kimchy],from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][3]: SearchParseException[[test][3]: query[user:kimchy],from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}, \\\"foo\\\": \\\"bar\\\"}\\n]]]; nested: SearchParseException[[test][3]: query[user:kimchy],from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][2]: SearchParseException[[test][2]: query[user:kimchy],from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}, \\\"foo\\\": \\\"bar\\\"}\\n]]]; nested: SearchParseException[[test][2]: query[user:kimchy],from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][0]: SearchParseException[[test][0]: query[user:kimchy],from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}, \\\"foo\\\": \\\"bar\\\"}\\n]]]; nested: SearchParseException[[test][0]: query[user:kimchy],from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }{[FsbLm57PSNeCm5gRjO-uLA][test][1]: SearchParseException[[test][1]: query[user:kimchy],from[-1],size[-1]: Parse Failure [Failed to parse source [\\n{\\\"query\\\": {\\\"term\\\" : { \\\"user\\\" : \\\"kimchy\\\" }}, \\\"foo\\\": \\\"bar\\\"}\\n]]]; nested: SearchParseException[[test][1]: query[user:kimchy],from[-1],size[-1]: Parse Failure [No parser for element [foo]]]; }]\",\n  \"status\" : 400\n}\n```\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}