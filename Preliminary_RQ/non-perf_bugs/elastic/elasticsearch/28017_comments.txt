[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355581301","html_url":"https://github.com/elastic/elasticsearch/issues/28017#issuecomment-355581301","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28017","id":355581301,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTU4MTMwMQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-01-05T15:25:15Z","updated_at":"2018-01-05T15:25:15Z","author_association":"CONTRIBUTOR","body":"We discussed this request in Fix-it-Friday.\r\n\r\nFirstly:\r\n> ... properly connecting to all nodes ...\r\n\r\nClients don't connect to _all_ nodes at once, so we interpreted this to mean \"... properly connecting to each node ...\", i.e. that you want to loop through all the nodes and check that the client connects to each one individually. Is that what you meant?\r\n\r\nSecondly, normally a connection from a client only lives for the duration of a single request, so we weren't sure that this'd be a useful thing to expose. The exceptions to this are transport clients and REST clients that use `Connection: keep-alive`. [The transport client is on its way out](https://www.elastic.co/guide/en/elasticsearch/client/java-api/6.0/client.html) and persistent HTTP connections are not commonly used. We concluded that this wouldn't be a sufficiently useful thing to expose to the API.\r\n\r\nThere's already various tools (particularly logging, and OS-level things like `lsof` and `netstat`) to help troubleshoot a connection problem if you find one.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355650318","html_url":"https://github.com/elastic/elasticsearch/issues/28017#issuecomment-355650318","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28017","id":355650318,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTY1MDMxOA==","user":{"login":"robgil","id":1257843,"node_id":"MDQ6VXNlcjEyNTc4NDM=","avatar_url":"https://avatars1.githubusercontent.com/u/1257843?v=4","gravatar_id":"","url":"https://api.github.com/users/robgil","html_url":"https://github.com/robgil","followers_url":"https://api.github.com/users/robgil/followers","following_url":"https://api.github.com/users/robgil/following{/other_user}","gists_url":"https://api.github.com/users/robgil/gists{/gist_id}","starred_url":"https://api.github.com/users/robgil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robgil/subscriptions","organizations_url":"https://api.github.com/users/robgil/orgs","repos_url":"https://api.github.com/users/robgil/repos","events_url":"https://api.github.com/users/robgil/events{/privacy}","received_events_url":"https://api.github.com/users/robgil/received_events","type":"User","site_admin":false},"created_at":"2018-01-05T19:56:53Z","updated_at":"2018-01-05T19:56:53Z","author_association":"NONE","body":"WRT connecting to all nodes: in ECE and EC, requests are apparently load balanced. I don't know whether they are load balanced across all nodes, or just hit one node. I'm trying to determine that behavior, and my request was that I could look to see a list of client connections on ES.\r\n\r\nWRT connections: Yes, we run keepalive everywhere to reduce overhead of instantiating a new connection with every request. \r\n\r\nWRT lsof/netstat: That assumes you have access to the host. With EC, you don't, which makes it hard to troubleshoot connection issues.\r\n\r\nThe other thing im trying to determine with this, is whether the host is getting saturated with connections, and just how many it has concurrently open. Similar to apache mod_status, in mongo (db.serverStatus() and db.serverStatus.connections), mysql (SHOW PROCESSLIST), and so on. Almost all other systems provide this information for monitoring.  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355745107","html_url":"https://github.com/elastic/elasticsearch/issues/28017#issuecomment-355745107","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28017","id":355745107,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTc0NTEwNw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-01-06T12:53:08Z","updated_at":"2018-01-06T12:53:08Z","author_association":"CONTRIBUTOR","body":"I've raised your questions about Cloud with the Elastic Cloud team, but you might be better asking these again in [the ECE discussion forums](https://discuss.elastic.co/c/cloud-enterprise) or with [your EC support service](https://www.elastic.co/blog/announcing-support-for-elastic-cloud-hosted-elasticsearch-standard) as this sort of discussion tends to get lost in this issue tracker.\r\n\r\nNote that `GET /_nodes/stats/http` returns the number of HTTP connections that are currently open, and the total number of connections ever opened.\r\n\r\nAre you actually seeing problems that you think are related to too many connections to individual hosts? What are the symptoms you see? How many connections are you making to your cluster, and how many nodes do you have? Have you determined the number of connections that count as \"saturated\" and, if so, how?\r\n\r\nElasticsearch's networking model is quite different from those in Apache, MySQL and MongoDB. It makes a lot of sense to worry about saturating a host with connections when each connection corresponds to a thread, which is quite a limited resource. Connections in Elasticsearch are not like this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/356232888","html_url":"https://github.com/elastic/elasticsearch/issues/28017#issuecomment-356232888","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28017","id":356232888,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NjIzMjg4OA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-01-09T09:45:10Z","updated_at":"2018-01-09T09:45:10Z","author_association":"CONTRIBUTOR","body":"I spoke about this with @robgil out-of-band. The ultimate origin of this request was a debugging session which we eventually determined to be because the client was sending a subtly malformed request by looking at packet captures. It turns out that this was reported as expected in the Elasticsearch logs but for various reasons we missed or misunderstood the vital messages. The confusion was compounded a little by the proxies that sit between Elasticsearch instances running in EC and the outside world: Elasticsearch dropped the connection as expected, but somewhere in the proxy layers this was turned into a 502 with a misleading message:\r\n\r\n    {\"ok\":false,\"message\":\"Unable to connect to the server.\"}\r\n\r\n`GET /_nodes/stats/http` solves the \"how many connections\" question, and the \"correctly connecting\" question is solved by logs and client-side errors, as long as you are aware of their possible mutilation by intervening proxies. I expect that the logs are also useful in tracking down TLS and authentication issues but if there's something vital that's missing from the logs then we can consider that a separate bug.\r\n\r\nI'm uncomfortable with the security implications of exposing the last command(s) issued on each connection via an API endpoint, and feel this is best determined from the logs too.","performed_via_github_app":null}]