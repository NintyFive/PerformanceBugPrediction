{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42957","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42957/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42957/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42957/events","html_url":"https://github.com/elastic/elasticsearch/issues/42957","id":453118009,"node_id":"MDU6SXNzdWU0NTMxMTgwMDk=","number":42957,"title":"Fuzzy queries don't use distributed frequencies with dfs_query_then_fetch","user":{"login":"metaruslan","id":2231256,"node_id":"MDQ6VXNlcjIyMzEyNTY=","avatar_url":"https://avatars2.githubusercontent.com/u/2231256?v=4","gravatar_id":"","url":"https://api.github.com/users/metaruslan","html_url":"https://github.com/metaruslan","followers_url":"https://api.github.com/users/metaruslan/followers","following_url":"https://api.github.com/users/metaruslan/following{/other_user}","gists_url":"https://api.github.com/users/metaruslan/gists{/gist_id}","starred_url":"https://api.github.com/users/metaruslan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/metaruslan/subscriptions","organizations_url":"https://api.github.com/users/metaruslan/orgs","repos_url":"https://api.github.com/users/metaruslan/repos","events_url":"https://api.github.com/users/metaruslan/events{/privacy}","received_events_url":"https://api.github.com/users/metaruslan/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-06-06T16:08:33Z","updated_at":"2019-10-07T15:57:27Z","closed_at":"2019-10-07T15:57:26Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.4.2 in my linux VM, but I could also reproduce it in 7.1.1 with the official docker image on docker for Mac (examples below are for 6.4.2)\r\n**Plugins installed**: []\r\nNone\r\n**JVM version** (`java -version`):\r\n1.8.0_121\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux mapr-vm 4.14.101-91.76.amzn2.x86_64 #1 SMP Tue Feb 19 17:51:33 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n**Description of the problem including expected versus actual behavior**:\r\nI expect this behavior:\r\n1. scores should be the same for a query run over 1 shard and 10 shards with dfs_query_then_fetch as it's stated here\r\nhttps://www.elastic.co/blog/practical-bm25-part-1-how-shards-affect-relevance-scoring-in-elasticsearch\r\n> his provides the same as having set number_of_shards=1\r\n\r\nThe scores (and explains) are actually different (see 2. and 3. below).\r\n\r\n2. docCount in explain should always represent the complete number of documents if it's 1 shard or 10 shards with dfs_query_then_fetch\r\ndocCount happens to be 1 for one case in explain for 10 shards with dfs_query_then_fetch when there are 3 documents in the index. If it's 1 shard then the number is 3 for that case.\r\n\r\n3. docFreq in explain should always represent the number of non-exact matches for a fuzzy non-exact match, so the score is bigger for a more rare incorrect spelling than more common correct spelling. As mentioned here https://github.com/elastic/elasticsearch/issues/7554\r\n> relying on term frequencies for fuzzy matching doesn't work very well at all. By default, the less frequent misspellings have a higher weight than the more frequent correct spellings. Better to just use fuzzy as a constant_score.\r\n\r\ndocFreq happens to be 2 for a non-exact fuzzy match for 1 shard and it's 1 for 10 shards with dfs_query_then_fetch\r\n\r\n**Steps to reproduce**:\r\n\r\n(See the \"// LOOK HERE\" marks in the pastes below)\r\n\r\nFirst we do it with 1 shard\r\n\r\n```json\r\nPUT foo_index\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 1\r\n  },\r\n  \"mappings\": {\r\n   \"_doc\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"name\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"gender\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"genderCode\": {\r\n          \"properties\": {\r\n            \"display\": {\r\n              \"type\": \"text\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT foo_index/_bulk\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id1\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender1\",\"genderCode\":{\"display\":\"display1\"}}\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id2\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender2\",\"genderCode\":{\"display\":\"display1\"}}\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id3\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender1\",\"genderCode\":{\"display\":\"gender1\"}}\r\n\r\nGET foo_index/_search\r\n{\r\n  \"explain\": true, \r\n  \"_source\": true,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match\": {\r\n            \"name\": \"name1\"\r\n          }\r\n        }\r\n      ],\r\n      \"should\": [\r\n        {\r\n          \"fuzzy\": {\r\n            \"gender\": {\r\n              \"value\": \"gender1\",\r\n              \"prefix_length\": 1\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"fuzzy\": {\r\n            \"genderCode.display\": {\r\n              \"value\": \"gender1\",\r\n              \"prefix_length\": 1\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\nThe result\r\n```json\r\n{\r\n  \"took\": 8,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 3,\r\n    \"max_score\": 1.5843642,\r\n    \"hits\": [\r\n      {\r\n        \"_shard\": \"[foo_index][0]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id3\",\r\n        \"_score\": 1.5843642,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender1\",\r\n          \"genderCode\": {\r\n            \"display\": \"gender1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 1.5843643,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 2) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=2,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.47000363,\r\n              \"description\": \"sum of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.47000363,\r\n                  \"description\": \"weight(gender:gender1 in 2) [PerFieldSimilarity], result of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.47000363,\r\n                      \"description\": \"score(doc=2,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 0.47000363,\r\n                          \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                          \"details\": [\r\n                            {\r\n                              \"value\": 2,\r\n                              \"description\": \"docFreq\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 3,\r\n                              \"description\": \"docCount\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                          \"details\": [\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"termFreq=1.0\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1.2,\r\n                              \"description\": \"parameter k1\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 0.75,\r\n                              \"description\": \"parameter b\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"avgFieldLength\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"fieldLength\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.98082924,\r\n              \"description\": \"weight(genderCode.display:gender1 in 2) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.98082924,\r\n                  \"description\": \"score(doc=2,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.98082924,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n// LOOK HERE, now it is correct\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_shard\": \"[foo_index][0]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id1\",\r\n        \"_score\": 0.60353506,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender1\",\r\n          \"genderCode\": {\r\n            \"display\": \"display1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.60353506,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.47000363,\r\n              \"description\": \"sum of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.47000363,\r\n                  \"description\": \"weight(gender:gender1 in 0) [PerFieldSimilarity], result of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.47000363,\r\n                      \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 0.47000363,\r\n                          \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                          \"details\": [\r\n                            {\r\n                              \"value\": 2,\r\n                              \"description\": \"docFreq\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 3,\r\n                              \"description\": \"docCount\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                          \"details\": [\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"termFreq=1.0\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1.2,\r\n                              \"description\": \"parameter k1\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 0.75,\r\n                              \"description\": \"parameter b\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"avgFieldLength\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"fieldLength\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_shard\": \"[foo_index][0]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id2\",\r\n        \"_score\": 0.5363916,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender2\",\r\n          \"genderCode\": {\r\n            \"display\": \"display1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.5363916,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 1) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=1,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.40286025,\r\n              \"description\": \"sum of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.40286025,\r\n                  \"description\": \"weight(gender:gender2 in 1) [PerFieldSimilarity], result of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.40286025,\r\n                      \"description\": \"score(doc=1,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 0.85714287,\r\n                          \"description\": \"boost\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.47000363,\r\n                          \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                          \"details\": [\r\n                            {\r\n// LOOK HERE, shouldn't it be 1?\r\n                              \"value\": 2,\r\n                              \"description\": \"docFreq\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 3,\r\n                              \"description\": \"docCount\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                          \"details\": [\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"termFreq=1.0\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1.2,\r\n                              \"description\": \"parameter k1\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 0.75,\r\n                              \"description\": \"parameter b\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"avgFieldLength\",\r\n                              \"details\": []\r\n                            },\r\n                            {\r\n                              \"value\": 1,\r\n                              \"description\": \"fieldLength\",\r\n                              \"details\": []\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\nWhy do we have 2 for docFreq for the single non-exact fuzzy match which is\r\nweight(gender:gender2 in 1)?\r\nThis number becomes 1 below for the 10 shards with dfs_query_then_fetch\r\nAlso note that docCount numbers are all good, i.e. all 3's.\r\n\r\nNow let's try 10 shards with dfs_query_then_fetch\r\n```json\r\nDELETE foo_index\r\nPUT foo_index\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 10,\r\n    \"number_of_replicas\": 1\r\n  },\r\n  \"mappings\": {\r\n   \"_doc\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"name\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"gender\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"genderCode\": {\r\n          \"properties\": {\r\n            \"display\": {\r\n              \"type\": \"text\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT foo_index/_bulk\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id1\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender1\",\"genderCode\":{\"display\":\"display1\"}}\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id2\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender2\",\"genderCode\":{\"display\":\"display1\"}}\r\n{\"index\":{\"_index\":\"foo_index\",\"_type\":\"_doc\",\"_id\":\"id3\"}}\r\n{\"name\": \"name1\",\"gender\":\"gender1\",\"genderCode\":{\"display\":\"gender1\"}}\r\n\r\nGET foo_index/_search?search_type=dfs_query_then_fetch\r\n{\r\n  \"explain\": true, \r\n  \"_source\": true,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match\": {\r\n            \"name\": \"name1\"\r\n          }\r\n        }\r\n      ],\r\n      \"should\": [\r\n        {\r\n          \"fuzzy\": {\r\n            \"gender\": {\r\n              \"value\": \"gender1\",\r\n              \"prefix_length\": 1\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"fuzzy\": {\r\n            \"genderCode.display\": {\r\n              \"value\": \"gender1\",\r\n              \"prefix_length\": 1\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe result is\r\n\r\n```json\r\n{\r\n  \"took\": 8,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 10,\r\n    \"successful\": 10,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 3,\r\n    \"max_score\": 0.97424215,\r\n    \"hits\": [\r\n      {\r\n        \"_shard\": \"[foo_index][0]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id2\",\r\n        \"_score\": 0.97424215,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender2\",\r\n          \"genderCode\": {\r\n            \"display\": \"display1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.97424215,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.84071076,\r\n              \"description\": \"weight(gender:gender2 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.84071076,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.85714287,\r\n                      \"description\": \"boost\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 0.98082924,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n// LOOK HERE, now it's seems correct\r\n                          \"value\": 1,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_shard\": \"[foo_index][6]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id3\",\r\n        \"_score\": 0.8912171,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender1\",\r\n          \"genderCode\": {\r\n            \"display\": \"gender1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.8912171,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.47000363,\r\n              \"description\": \"weight(gender:gender1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.47000363,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.47000363,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 2,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.2876821,\r\n              \"description\": \"weight(genderCode.display:gender1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.2876821,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.2876821,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n// LOOK HERE, shouldn't it be 3 as there are 3 documents in the index\r\n                          \"value\": 1,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_shard\": \"[foo_index][7]\",\r\n        \"_node\": \"_R7ajDUEQuO-wZWvxjC84w\",\r\n        \"_index\": \"foo_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"id1\",\r\n        \"_score\": 0.60353506,\r\n        \"_source\": {\r\n          \"name\": \"name1\",\r\n          \"gender\": \"gender1\",\r\n          \"genderCode\": {\r\n            \"display\": \"display1\"\r\n          }\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.60353506,\r\n          \"description\": \"sum of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.13353139,\r\n              \"description\": \"weight(name:name1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.13353139,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.13353139,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\": 0.47000363,\r\n              \"description\": \"weight(gender:gender1 in 0) [PerFieldSimilarity], result of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.47000363,\r\n                  \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 0.47000363,\r\n                      \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 2,\r\n                          \"description\": \"docFreq\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 3,\r\n                          \"description\": \"docCount\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                      \"details\": [\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"termFreq=1.0\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1.2,\r\n                          \"description\": \"parameter k1\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 0.75,\r\n                          \"description\": \"parameter b\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"avgFieldLength\",\r\n                          \"details\": []\r\n                        },\r\n                        {\r\n                          \"value\": 1,\r\n                          \"description\": \"fieldLength\",\r\n                          \"details\": []\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nNow docFreq for weight(gender:gender2 in 0) seems to be correct as it's 1.\r\nBut docCount for weight(genderCode.display:gender1 in 0) seems to be incorrect as it's 1 and all the other docCounts are 3.","closed_by":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"performed_via_github_app":null}