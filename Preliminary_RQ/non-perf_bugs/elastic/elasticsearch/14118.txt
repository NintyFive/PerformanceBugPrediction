{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14118","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14118/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14118/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14118/events","html_url":"https://github.com/elastic/elasticsearch/issues/14118","id":111447701,"node_id":"MDU6SXNzdWUxMTE0NDc3MDE=","number":14118,"title":"Java API _timeout + _msearch returns no aggregations","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-10-14T17:22:55Z","updated_at":"2015-10-15T17:18:34Z","closed_at":"2015-10-15T12:01:06Z","author_association":"NONE","active_lock_reason":null,"body":"It appears that when I add a timeout to an `_msearch` request in the Java client, all my aggregations are ignored and the filtering doesn't take place.\n### Without Timeout\n\n**request**\n\n``` java\nMultiSearchRequestBuilder builder = esClient\n    .prepareMultiSearch()\n    .setIndicesOptions(IndicesOptions.lenientExpandOpen());\n\nSearchRequest req = esClient\n                .prepareSearch(req.getIndices())\n                .setTypes(req.getType())\n                .setSource(mySearchString)\n                .setSearchType(SearchType.COUNT)\n                .request();\n\nbuilder.add(req);\n\nMultiSearchResponse response = esClient\n                .multiSearch(builder.request()).actionGet();\n\nSystem.out.println(response.toString());\n```\n\n**response**\n\n```\n{\n  \"responses\" : [ {\n    \"took\" : 176,\n    \"timed_out\" : false,\n    \"_shards\" : {\n      \"total\" : 12,\n      \"successful\" : 12,\n      \"failed\" : 0\n    },\n    \"hits\" : {\n      \"total\" : 4,\n      \"max_score\" : 0.0,\n      \"hits\" : [ ]\n    },\n    \"aggregations\" : {\n      \"agg_name\" : {\n          \"buckets\": [\n              // etc\n          ]\n      }\n    }\n  } ]\n```\n### With Timeout\n\n**request**\n\n``` java\nMultiSearchRequestBuilder builder = esClient\n    .prepareMultiSearch()\n    .setIndicesOptions(IndicesOptions.lenientExpandOpen());\n\nSearchRequest req = esClient\n                .prepareSearch(req.getIndices())\n                .setTypes(req.getType())\n                .setSource(mySearchString)\n                .setSearchType(SearchType.COUNT)\n                .setTimeout(TimeValue.timeValueSeconds(60))\n                .request();\n\nbuilder.add(req);\n\nMultiSearchResponse response = esClient\n                .multiSearch(builder.request()).actionGet();\n\nSystem.out.println(response.toString());\n```\n\n**response**\n\n```\n{\n  \"responses\" : [ {\n    \"took\" : 43,\n    \"timed_out\" : false,\n    \"_shards\" : {\n      \"total\" : 12,\n      \"successful\" : 12,\n      \"failed\" : 0\n    },\n    \"hits\" : {\n      \"total\" : 38,\n      \"max_score\" : 0.0,\n      \"hits\" : [ ]\n    }\n  } ]\n}\n```\n\nAs far as I know, this should work and I can confirm there is no difference in the query being sent (this is in a unit test). Simply adding the timeout changes the response as above. Maybe I'm being stupid, but this looks like it has to be an ES bug?\n\nI'm using ES 1.7.2, both the node and client lib.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}