[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/209828130","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-209828130","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":209828130,"node_id":"MDEyOklzc3VlQ29tbWVudDIwOTgyODEzMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-04-14T08:35:01Z","updated_at":"2016-04-14T08:35:01Z","author_association":"CONTRIBUTOR","body":"@bleskes could you take a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/209900469","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-209900469","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":209900469,"node_id":"MDEyOklzc3VlQ29tbWVudDIwOTkwMDQ2OQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-04-14T11:54:12Z","updated_at":"2016-04-14T11:54:12Z","author_association":"MEMBER","body":"Thx @ryanhadley . The reason why shard started messages are processed with high priority is that they are needed to process index and search operations and thus have a higher impact that a put mapping which may block some operations. That said they are batched and should be light, so I wonder why they talk long.  Also, it may be that something else is block the put mapping requests.\n\nSince you say you looked at the pending task list, can you maybe share it? I would also be interested to see the output of the hot threads API of the master node while it processes this open index/put mapping requests\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/210084855","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-210084855","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":210084855,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMDA4NDg1NQ==","user":{"login":"ryanhadley","id":18455429,"node_id":"MDQ6VXNlcjE4NDU1NDI5","avatar_url":"https://avatars2.githubusercontent.com/u/18455429?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanhadley","html_url":"https://github.com/ryanhadley","followers_url":"https://api.github.com/users/ryanhadley/followers","following_url":"https://api.github.com/users/ryanhadley/following{/other_user}","gists_url":"https://api.github.com/users/ryanhadley/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanhadley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanhadley/subscriptions","organizations_url":"https://api.github.com/users/ryanhadley/orgs","repos_url":"https://api.github.com/users/ryanhadley/repos","events_url":"https://api.github.com/users/ryanhadley/events{/privacy}","received_events_url":"https://api.github.com/users/ryanhadley/received_events","type":"User","site_admin":false},"created_at":"2016-04-14T18:17:26Z","updated_at":"2016-04-14T18:17:26Z","author_association":"NONE","body":"@bleskes, thank you! I'm trying to get you this additional data (can't believe I didn't save it from before... oops) but it might take me a bit. We worked around the problem on our Prod cluster by pooling open requests in a queue and only running the open requests once every 10 seconds. I have to get a test cluster up and running with enough large indices to close and then open to recreate this.\n\n> That said they are batched and should be light, so I wonder why they talk long.\n\nThey are definitely light and complete very fast. The open request typically takes less than a second per index. The only time it causes issues is when there are many open requests in a row. Which apparently our customers like to do in the early mornings when they show up to work and want to check their reports for new data.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/210130638","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-210130638","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":210130638,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMDEzMDYzOA==","user":{"login":"ryanhadley","id":18455429,"node_id":"MDQ6VXNlcjE4NDU1NDI5","avatar_url":"https://avatars2.githubusercontent.com/u/18455429?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanhadley","html_url":"https://github.com/ryanhadley","followers_url":"https://api.github.com/users/ryanhadley/followers","following_url":"https://api.github.com/users/ryanhadley/following{/other_user}","gists_url":"https://api.github.com/users/ryanhadley/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanhadley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanhadley/subscriptions","organizations_url":"https://api.github.com/users/ryanhadley/orgs","repos_url":"https://api.github.com/users/ryanhadley/repos","events_url":"https://api.github.com/users/ryanhadley/events{/privacy}","received_events_url":"https://api.github.com/users/ryanhadley/received_events","type":"User","site_admin":false},"created_at":"2016-04-14T20:15:20Z","updated_at":"2016-04-14T20:16:29Z","author_association":"NONE","body":"OK, I got enough data in to a test cluster I spun up to recreate the issue.\n\nThis is a 4 server cluster and I got about 500 indices in to it of decent size (50,000 - 100,000 average document count per index). I close all but 200 of the indices and then ran this to start opening the closed indices one at a time:\n\nfor sindex in `curl 'http://localhost:9200/_cluster/state/blocks?pretty' 2>/dev/null | grep \"survey-\" | awk '{print $1}' | sed -e 's/\"//g'`; do echo $sindex; curl -XPOST \"http://localhost:9200/$sindex/_open\"; done\n\nThis was MUCH more stressful on the cluster than what our customers traffic would drive, but it results in the same put-mapping timeout errors while indexing and the same constant listing of URGENT priority tasks in the pending_tasks list while the put-mapping timeouts happen.\n\nAttached are the results of pending_tasks and hot_threads.\n\n[pending_tasks.json.txt](https://github.com/elastic/elasticsearch/files/219885/pending_tasks.json.txt)\n[hot_threads.txt](https://github.com/elastic/elasticsearch/files/219887/hot_threads.txt)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216653290","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-216653290","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":216653290,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjY1MzI5MA==","user":{"login":"lfkeitel","id":6619743,"node_id":"MDQ6VXNlcjY2MTk3NDM=","avatar_url":"https://avatars3.githubusercontent.com/u/6619743?v=4","gravatar_id":"","url":"https://api.github.com/users/lfkeitel","html_url":"https://github.com/lfkeitel","followers_url":"https://api.github.com/users/lfkeitel/followers","following_url":"https://api.github.com/users/lfkeitel/following{/other_user}","gists_url":"https://api.github.com/users/lfkeitel/gists{/gist_id}","starred_url":"https://api.github.com/users/lfkeitel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lfkeitel/subscriptions","organizations_url":"https://api.github.com/users/lfkeitel/orgs","repos_url":"https://api.github.com/users/lfkeitel/repos","events_url":"https://api.github.com/users/lfkeitel/events{/privacy}","received_events_url":"https://api.github.com/users/lfkeitel/received_events","type":"User","site_admin":false},"created_at":"2016-05-03T20:22:40Z","updated_at":"2016-05-03T20:22:40Z","author_association":"NONE","body":"I seem to have come across the same issue. Windows 10 running a single node during the hands-on training. Elasticsearch hung with no indication anything was wrong. When I stopped it, it output the following:\n\n```\n[2016-05-03 14:28:53,418][INFO ][cluster.metadata         ] [web-1] [.kibana] create_mapping [visualization]\n[2016-05-03 14:38:07,643][INFO ][cluster.metadata         ] [web-1] [.kibana] update_mapping [index-pattern]\n[2016-05-03 15:03:36,649][WARN ][rest.suppressed          ] /.kibana Params: {index=.kibana}\nProcessClusterEventTimeoutException[failed to process cluster event (delete-index [.kibana]) within 30s]\n        at org.elasticsearch.cluster.service.InternalClusterService$2$1.run(InternalClusterService.java:349)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n        at java.lang.Thread.run(Unknown Source)\n[2016-05-03 15:03:30,643][WARN ][rest.suppressed          ] /.kibana Params: {index=.kibana}\nProcessClusterEventTimeoutException[failed to process cluster event (delete-index [.kibana]) within 30s]\n        at org.elasticsearch.cluster.service.InternalClusterService$2$1.run(InternalClusterService.java:349)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n        at java.lang.Thread.run(Unknown Source)\n[2016-05-03 14:58:56,366][DEBUG][action.admin.indices.mapping.put] [web-1] failed to put mappings on indices [[.kibana]]\n, type [dashboard]\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231171717","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-231171717","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":231171717,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTE3MTcxNw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T18:48:52Z","updated_at":"2016-07-07T18:48:52Z","author_association":"MEMBER","body":"@ryanhadley sorry for taking so long, but looking at the dumps you sent, it seemes the master is busy processing the refresh mapping commands it gets:\n\n```\n   79.7% (398.6ms out of 500ms) cpu usage by thread 'elasticsearch[ip-10-0-2-97-indexing-01][clusterService#updateTask][T#1]'\n     2/10 snapshots sharing following 12 elements\n       org.elasticsearch.index.mapper.MapperService.addMappers(MapperService.java:425)\n       org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:318)\n       org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:272)\n       org.elasticsearch.cluster.metadata.MetaDataMappingService.executeRefresh(MetaDataMappingService.java:140)\n       org.elasticsearch.cluster.metadata.MetaDataMappingService$RefreshTaskExecutor.execute(MetaDataMappingService.java:79)\n\n```\n\nCan you put your cluster on debug logging and shard the logs? I'm looking for messages that are produced by this line:\n\n```\nlogger.debug(\"[{}] parsed mapping [{}], and got different sources\\noriginal:\\n{}\\nparsed:\\n{}\", index, mappingType, mappingSource, mapperService.documentMapper(mappingType).mappingSource());\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290713961","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-290713961","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":290713961,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcxMzk2MQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T13:37:24Z","updated_at":"2017-03-31T13:37:24Z","author_association":"MEMBER","body":"No further feedback","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292267148","html_url":"https://github.com/elastic/elasticsearch/issues/17744#issuecomment-292267148","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17744","id":292267148,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MjI2NzE0OA==","user":{"login":"ryanhadley","id":18455429,"node_id":"MDQ6VXNlcjE4NDU1NDI5","avatar_url":"https://avatars2.githubusercontent.com/u/18455429?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanhadley","html_url":"https://github.com/ryanhadley","followers_url":"https://api.github.com/users/ryanhadley/followers","following_url":"https://api.github.com/users/ryanhadley/following{/other_user}","gists_url":"https://api.github.com/users/ryanhadley/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanhadley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanhadley/subscriptions","organizations_url":"https://api.github.com/users/ryanhadley/orgs","repos_url":"https://api.github.com/users/ryanhadley/repos","events_url":"https://api.github.com/users/ryanhadley/events{/privacy}","received_events_url":"https://api.github.com/users/ryanhadley/received_events","type":"User","site_admin":false},"created_at":"2017-04-06T18:32:37Z","updated_at":"2017-04-06T18:33:05Z","author_association":"NONE","body":"Sorry I didn't get back to you. But we discovered that we were just expecting things from Elasticsearch that we shouldn't have been expecting. Our cluster state was so large that things that should happen quickly were not happening quick enough. We solved this problem by drastically reducing our cluster state size with more condensed mapping and less indexes total.\r\n\r\nThe cluster state was so large. So large. We did bad things.","performed_via_github_app":null}]