{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33836","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33836/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33836/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33836/events","html_url":"https://github.com/elastic/elasticsearch/issues/33836","id":361433095,"node_id":"MDU6SXNzdWUzNjE0MzMwOTU=","number":33836,"title":"Bulk API with conflicting fields creates randomly different mapping","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-09-18T18:44:12Z","updated_at":"2018-09-20T07:27:54Z","closed_at":"2018-09-20T07:27:54Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.0\r\n\r\n**Steps to reproduce**:\r\n\r\nThe following snippet from the console randomly either indexes both documents or correctly throws an error due to the mapping. The `bar` field contains a string in one document and a number in another, and it seems as if the order of indexing gets changed due to the fact which shard indexes first using dynamic mapping and thus decides about the mapping.\r\n\r\nAn index template or preexisting mapping can properly solve this of course - calling the same endpoint with the same data and getting different results can be confusing for the user though.\r\n\r\n```\r\nDELETE foo\r\n\r\nPUT foo/doc/_bulk\r\n{ \"index\" : { \"_id\" : \"2\" } }\r\n{ \"foo\" : \"spam\", \"bar\" : 123 }\r\n{ \"index\" : { \"_id\" : \"3\" } }\r\n{ \"foo\" : \"bar\", \"bar\" : \"foo\" }\r\n```\r\n\r\nThe first case is this response, where the field gets indexed as a long\r\n\r\n```\r\n# DELETE foo\r\n{\r\n  \"acknowledged\": true\r\n}\r\n\r\n# PUT foo/doc/_bulk\r\n#! Deprecation: the default number of shards will change from [5] to [1] in 7.0.0; if you wish to continue using the default of [5] shards, you must manage this on the create index request or with an index template\r\n{\r\n  \"took\": 526,\r\n  \"errors\": true,\r\n  \"items\": [\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"foo\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"2\",\r\n        \"_version\": 1,\r\n        \"result\": \"created\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 0,\r\n        \"_primary_term\": 1,\r\n        \"status\": 201\r\n      }\r\n    },\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"foo\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"3\",\r\n        \"status\": 400,\r\n        \"error\": {\r\n          \"type\": \"mapper_parsing_exception\",\r\n          \"reason\": \"failed to parse [bar]\",\r\n          \"caused_by\": {\r\n            \"type\": \"illegal_argument_exception\",\r\n            \"reason\": \"\"\"For input string: \"foo\"\"\"\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nthe second case is that both documents are being indexed as string, which happens roghly 50% of the cases\r\n\r\n```\r\n# DELETE foo\r\n{\r\n  \"acknowledged\": true\r\n}\r\n\r\n# PUT foo/doc/_bulk\r\n#! Deprecation: the default number of shards will change from [5] to [1] in 7.0.0; if you wish to continue using the default of [5] shards, you must manage this on the create index request or with an index template\r\n{\r\n  \"took\": 508,\r\n  \"errors\": false,\r\n  \"items\": [\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"foo\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"2\",\r\n        \"_version\": 1,\r\n        \"result\": \"created\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 0,\r\n        \"_primary_term\": 1,\r\n        \"status\": 201\r\n      }\r\n    },\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"foo\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"3\",\r\n        \"_version\": 1,\r\n        \"result\": \"created\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 0,\r\n        \"_primary_term\": 1,\r\n        \"status\": 201\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nYou can verify the different mapping by checking the `bar` field in both cases\r\n\r\n```\r\nGET foo/doc/_mapping?filter_path=**.bar\r\n```","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}