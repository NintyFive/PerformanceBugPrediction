[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536420577","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536420577","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536420577,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQyMDU3Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T06:27:51Z","updated_at":"2019-09-30T06:27:51Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536424070","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536424070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536424070,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQyNDA3MA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T06:40:46Z","updated_at":"2019-09-30T06:40:46Z","author_association":"CONTRIBUTOR","body":"Hi @redbaron4. Thanks for reporting this. A few questions:\r\n- Are these master-eligible nodes?\r\n- Are these closed replicated indices (i.e. are there allocated shards for these indices)? Have these indices been closed in 6.x or 7.x?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536434675","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536434675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536434675,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQzNDY3NQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T07:16:00Z","updated_at":"2019-09-30T07:18:07Z","author_association":"CONTRIBUTOR","body":"I have now managed to reproduce this with data-only nodes:\r\n\r\n```\r\npublic void testRelocatedClosedIndexIssue() throws Exception {\r\n    final String indexName = \"closed-index\";\r\n    List<String> dataNodes = internalCluster().startDataOnlyNodes(2);\r\n    // allocate shard to first data node\r\n    createIndex(indexName, Settings.builder()\r\n        .put(IndexMetaData.SETTING_NUMBER_OF_SHARDS, 1)\r\n        .put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS, 0)\r\n        .put(\"index.routing.allocation.include._name\", String.join(\",\", dataNodes.get(0)))\r\n        .build());\r\n    indexRandom(randomBoolean(), randomBoolean(), randomBoolean(), IntStream.range(0, randomIntBetween(0, 50))\r\n        .mapToObj(n -> client().prepareIndex(indexName, \"_doc\").setSource(\"num\", n)).collect(toList()));\r\n    assertAcked(client().admin().indices().prepareClose(indexName));\r\n    // move single shard to second node\r\n    client().admin().indices().prepareUpdateSettings(indexName).setSettings(Settings.builder()\r\n        .put(\"index.routing.allocation.include._name\", String.join(\",\", dataNodes.get(1)))).get();\r\n    ensureGreen(indexName);\r\n    // give first node a bit of time to clean up the index (including index metadata)\r\n    Thread.sleep(100);\r\n\r\n    internalCluster().fullRestart(); // fails as it can't find the index metadata on the first node\r\n}\r\n```\r\n\r\n\r\nThe same should not happen with master-eligible data nodes though. Can you clarify that point for us? If this only affects data-only nodes we might be able to provide instructions on how to get the node running again, without losing data.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536434705","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536434705","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536434705,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQzNDcwNQ==","user":{"login":"redbaron4","id":4869037,"node_id":"MDQ6VXNlcjQ4NjkwMzc=","avatar_url":"https://avatars2.githubusercontent.com/u/4869037?v=4","gravatar_id":"","url":"https://api.github.com/users/redbaron4","html_url":"https://github.com/redbaron4","followers_url":"https://api.github.com/users/redbaron4/followers","following_url":"https://api.github.com/users/redbaron4/following{/other_user}","gists_url":"https://api.github.com/users/redbaron4/gists{/gist_id}","starred_url":"https://api.github.com/users/redbaron4/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redbaron4/subscriptions","organizations_url":"https://api.github.com/users/redbaron4/orgs","repos_url":"https://api.github.com/users/redbaron4/repos","events_url":"https://api.github.com/users/redbaron4/events{/privacy}","received_events_url":"https://api.github.com/users/redbaron4/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T07:16:07Z","updated_at":"2019-09-30T07:18:53Z","author_association":"NONE","body":"@ywelsch Thanks for looking at this\r\n\r\n- These are not master eligible nodes. There are 3 other master elegible nodes in the cluster (which don't store any data). While doing a rolling upgrade, the script processes all the master eligible nodes first and then moves to data nodes.\r\n\r\nAll data nodes (the kind which show failure) have similar config to one given below\r\n\r\n```\r\ncluster.name: nemo-cluster \r\n\r\nnode.name: esnode1\r\n\r\nbootstrap.memory_lock: true\r\nnetwork.host: _site:ipv4_\r\ndiscovery.zen.ping.unicast.hosts: \r\n    - 10.44.0.43\r\n    - 10.44.0.44\r\n    - 10.44.0.45\r\n    \r\ndiscovery.zen.minimum_master_nodes: 1\r\n\r\n# Fix 9201 for intra cluster comm\r\ntransport.port: 9201\r\n\r\npath.logs: /var/log/elasticsearch\r\npath.data: /data/elasticsearch\r\n\r\n# Settings related to node\r\n\r\nnode.master: false\r\nnode.data: true\r\nnode.ingest: true\r\n\r\n# Monitoring settings (6.3+)\r\nxpack.monitoring.enabled: true\r\n\r\n```\r\n\r\nThe master elgible nodes are `10.44.0.43,44,45` which don't show any failure.\r\n\r\n- Closed indices are mostly created on 7.x. For the latest issue, the indices mentioned in the logs above were created using 7.x","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536442588","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536442588","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536442588,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQ0MjU4OA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T07:39:57Z","updated_at":"2019-09-30T07:39:57Z","author_association":"CONTRIBUTOR","body":"Ok, this confirms my findings. First of all, this is a bug related to how \"closed replicated indices\" (introduced in 7.2) interact with the index metadata storage mechanism, which has special handling for closed indices. On non-master-eligible data nodes, it's possible for the node's `manifest` file (which tracks the relevant metadata state that the node should persist) to become out of sync with what's actually stored on disk, leading to an inconsistency that is then detected at startup, refusing for the node to start up. We will immediately start working on a bug fix for this.\r\n\r\nIn the meanwhile, the following workaround is applicable to get the node running again. This workaround should not lead to any data loss. However, great care must be taken before applying it, preferably backing up the data folder on the node before undertaking the following low-level surgery:\r\n- The first step is to make sure that the node is indeed a data-only node. Doing the following on a master-eligible node can and will put the whole cluster at risk of data loss.\r\n- For every path that is referenced in `path.data`, remove the file named `manifest-N.st` (where `N` is some number) which can be found under `nodes/0/_state/` in the respective data path. After removing this file, the node should properly start up again.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/536443600","html_url":"https://github.com/elastic/elasticsearch/issues/47276#issuecomment-536443600","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47276","id":536443600,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNjQ0MzYwMA==","user":{"login":"redbaron4","id":4869037,"node_id":"MDQ6VXNlcjQ4NjkwMzc=","avatar_url":"https://avatars2.githubusercontent.com/u/4869037?v=4","gravatar_id":"","url":"https://api.github.com/users/redbaron4","html_url":"https://github.com/redbaron4","followers_url":"https://api.github.com/users/redbaron4/followers","following_url":"https://api.github.com/users/redbaron4/following{/other_user}","gists_url":"https://api.github.com/users/redbaron4/gists{/gist_id}","starred_url":"https://api.github.com/users/redbaron4/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redbaron4/subscriptions","organizations_url":"https://api.github.com/users/redbaron4/orgs","repos_url":"https://api.github.com/users/redbaron4/repos","events_url":"https://api.github.com/users/redbaron4/events{/privacy}","received_events_url":"https://api.github.com/users/redbaron4/received_events","type":"User","site_admin":false},"created_at":"2019-09-30T07:43:10Z","updated_at":"2019-09-30T07:43:10Z","author_association":"NONE","body":"Thanks for the work around. I'll try it the next time we face this situation. I almost had the impulse of removing the manifest file but did not do it. I tried to remove offending index entries from the manifest file first which led to consistency checks failure. So I restored the manifest file and desisted from any more tinkerings with it :)\r\n\r\nI hope the bug gets fixed soon.","performed_via_github_app":null}]