{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33080","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33080/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33080/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33080/events","html_url":"https://github.com/elastic/elasticsearch/issues/33080","id":353283259,"node_id":"MDU6SXNzdWUzNTMyODMyNTk=","number":33080,"title":"SQL: generated nested documents queries return incorrect inner_hits","user":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"assignees":[{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-08-23T08:48:05Z","updated_at":"2019-08-08T12:11:55Z","closed_at":"2019-08-08T12:11:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In a scenario involving a `nested` field, the inner_hits results can be incorrect.\r\n```\r\nPUT my_index\r\n{\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"user\": {\r\n          \"type\": \"nested\" \r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT my_index/_doc/1\r\n{\r\n  \"groupName\" : \"fans\",\r\n  \"user\" : [\r\n    {\r\n      \"first\" : \"John\",\r\n      \"last\" :  \"Smith\"\r\n    },\r\n    {\r\n      \"first\" : \"Alice\",\r\n      \"last\" :  \"White\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nWhen selecting all fields, a row is output for each nested doc.\r\n```\r\nPOST _xpack/sql?format=txt\r\n{   \r\n  \"query\": \"select groupName, user.first, user.last from my_index\"\r\n} \r\n\r\ngroupName   |  user.first   |   user.last   \r\n---------------+---------------+---------------\r\nfans           |Alice          |White              \r\nfans           |John           |Smith              \r\n```\r\n\r\nBut if we add a where clause that's satisfied by a combination of the nested docs, then only a single row for a single nested doc is returned.\r\n\r\n```\r\nPOST _xpack/sql?format=txt\r\n{   \r\n  \"query\": \"select groupName, user.first, user.last from my_index where user.first = 'Alice' and user.last = 'Smith'\"\r\n}\r\n\r\ngroupName   |  user.first   |   user.last   \r\n---------------+---------------+---------------\r\nfans           |John           |Smith              \r\n```\r\n\r\nThis is like this because for multiple `nested` queries that have `inner_hits`, if the `inner_hits` blocks are not named (https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-request-inner-hits.html#_options) which happens now in SQL, their results will clash (ES will choose one inner_hit result from the two). Probably the solution is to name differently each `inner_hits` block when they are used for the same `nested` field in multiple statements and, when the results are retrieved, to combine the `inner_hits` results from the multiple named queries of the same \"parent\" document.\r\n\r\nAs an example, for a query like `select user.* from test where \"user.first\"='Alice' and \"user.last\"='Smith'` the generated query (simplified) should be:\r\n\r\n```\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"nested\": {\r\n                        \"query\": {\r\n                            \"term\": {\r\n                                \"user.first.keyword\": {\r\n                                    \"value\": \"Alice\"\r\n                                }\r\n                            }\r\n                        },\r\n                        \"path\": \"user\",\r\n                        \"inner_hits\": {\r\n                            \"size\": 99,\r\n                            \"name\": \"324\"\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"nested\": {\r\n                        \"query\": {\r\n                            \"term\": {\r\n                                \"user.last.keyword\": {\r\n                                    \"value\": \"Smith\"\r\n                                }\r\n                            }\r\n                        },\r\n                        \"path\": \"user\",\r\n                        \"inner_hits\": {\r\n                            \"size\": 99,\r\n                            \"name\": \"419\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    }\r\n```\r\n\r\nAnd the results would look like this:\r\n\r\n```\r\n        \"hits\": [\r\n            {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"_doc\",\r\n                \"_id\": \"3\",\r\n                \"_score\": 2.9267395,\r\n                \"_source\": {\r\n                    \"groupName\": \"players\",\r\n                    \"user\": [\r\n                        {\r\n                            \"first\": \"John\",\r\n                            \"last\": \"Smith\"\r\n                        },\r\n                        {\r\n                            \"first\": \"Alice\"\r\n                        },\r\n                        {\r\n                            \"first\": \"Tom\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"inner_hits\": {\r\n                    \"324\": {\r\n                        \"hits\": {\r\n                            \"total\": 1,\r\n                            \"max_score\": 1.3862944,\r\n                            \"hits\": [\r\n                                {\r\n                                    \"_index\": \"test\",\r\n                                    \"_type\": \"_doc\",\r\n                                    \"_id\": \"3\",\r\n                                    \"_nested\": {\r\n                                        \"field\": \"user\",\r\n                                        \"offset\": 1\r\n                                    },\r\n                                    \"_score\": 1.3862944,\r\n                                    \"_source\": {\r\n                                        \"first\": \"Alice\"\r\n                                    }\r\n                                }\r\n                            ]\r\n                        }\r\n                    },\r\n                    \"419\": {\r\n                        \"hits\": {\r\n                            \"total\": 1,\r\n                            \"max_score\": 1.5404451,\r\n                            \"hits\": [\r\n                                {\r\n                                    \"_index\": \"test\",\r\n                                    \"_type\": \"_doc\",\r\n                                    \"_id\": \"3\",\r\n                                    \"_nested\": {\r\n                                        \"field\": \"user\",\r\n                                        \"offset\": 0\r\n                                    },\r\n                                    \"_score\": 1.5404451,\r\n                                    \"_source\": {\r\n                                        \"first\": \"John\",\r\n                                        \"last\": \"Smith\"\r\n                                    }\r\n                                }\r\n                            ]\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        ]\r\n```\r\n\r\nWithout naming the `inner_hits`, stuff would be missing from the result:\r\n\r\n```\r\n        \"hits\": [\r\n            {\r\n                \"_index\": \"test\",\r\n                \"_type\": \"_doc\",\r\n                \"_id\": \"3\",\r\n                \"_score\": 2.9267395,\r\n                \"_source\": {\r\n                    \"groupName\": \"players\",\r\n                    \"user\": [\r\n                        {\r\n                            \"first\": \"John\",\r\n                            \"last\": \"Smith\"\r\n                        },\r\n                        {\r\n                            \"first\": \"Alice\"\r\n                        },\r\n                        {\r\n                            \"first\": \"Tom\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"inner_hits\": {\r\n                    \"user\": {\r\n                        \"hits\": {\r\n                            \"total\": 1,\r\n                            \"max_score\": 1.5404451,\r\n                            \"hits\": [\r\n                                {\r\n                                    \"_index\": \"test\",\r\n                                    \"_type\": \"_doc\",\r\n                                    \"_id\": \"3\",\r\n                                    \"_nested\": {\r\n                                        \"field\": \"user\",\r\n                                        \"offset\": 0\r\n                                    },\r\n                                    \"_score\": 1.5404451,\r\n                                    \"_source\": {\r\n                                        \"first\": \"John\",\r\n                                        \"last\": \"Smith\"\r\n                                    }\r\n                                }\r\n                            ]\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        ]\r\n```\r\n\r\nOriginal report: https://discuss.elastic.co/t/sql-queries-against-nested-datatypes-may-be-mis-translated/145180","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}