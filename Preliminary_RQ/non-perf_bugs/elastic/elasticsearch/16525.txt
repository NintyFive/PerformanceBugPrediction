{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16525","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16525/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16525/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16525/events","html_url":"https://github.com/elastic/elasticsearch/issues/16525","id":132357166,"node_id":"MDU6SXNzdWUxMzIzNTcxNjY=","number":16525,"title":"NullPointerException for has_child query with avg score_mode and explain turned on","user":{"login":"fxh","id":1321090,"node_id":"MDQ6VXNlcjEzMjEwOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/1321090?v=4","gravatar_id":"","url":"https://api.github.com/users/fxh","html_url":"https://github.com/fxh","followers_url":"https://api.github.com/users/fxh/followers","following_url":"https://api.github.com/users/fxh/following{/other_user}","gists_url":"https://api.github.com/users/fxh/gists{/gist_id}","starred_url":"https://api.github.com/users/fxh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fxh/subscriptions","organizations_url":"https://api.github.com/users/fxh/orgs","repos_url":"https://api.github.com/users/fxh/repos","events_url":"https://api.github.com/users/fxh/events{/privacy}","received_events_url":"https://api.github.com/users/fxh/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-02-09T08:19:18Z","updated_at":"2018-02-14T13:28:39Z","closed_at":"2016-03-04T19:06:53Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version 2.2.0\njava version 1.8.0_25\n\nSteps to reproduce:\n\n```\n# clean start\ncurl -XDELETE localhost:9200/blogs\n\n# prepare parent child relationship\ncurl -XPUT localhost:9200/blogs -d '{\n  \"mappings\": {\n    \"blog_tag\": {\n      \"_parent\" : {\n         \"type\" : \"doc\"\n      }\n    }\n  }\n}'\n\n# index parent document containing the word 'title'\ncurl -XPUT 'http://localhost:9200/blogs/doc/1' -d '{\n    \"message\" : \"my title\"\n}'\n\n# index child document NOT containing the word 'title'\ncurl -XPUT localhost:9200/blogs/blog_tag/1?parent=1 -d '{\n    \"tag\" : \"my tag\"\n}'\n\n# search for any parent or child matching 'title' with explain turned on and\n# 'avg' score_mode for child scoring\ncurl -XGET http://localhost:9200/blogs/_search?pretty -d '{\n    \"explain\": true,\n    \"query\": {\n        \"bool\": {\n            \"should\": [{\n                \"query_string\": {\"query\": \"title\"}\n            }, {\n                \"has_child\": {\n                    \"query\": {\n                        \"query_string\": {\"query\": \"title\"}\n                    },\n                    \"score_mode\": \"avg\",\n                    \"type\": \"blog_tag\"\n                }\n            }]\n        }\n    }\n}'\n```\n\nThe query raises a NullPointerException and returns:\n\n```\n[2016-02-09 09:07:13,740][DEBUG][action.search.type       ] [Manta] [blogs][0], node[oYZDW2pHT6SYvh-uTmIKIQ], [P], v[2], s[STARTED], a[id=dnJfwYnXTcahkyT8g019mQ]: Failed to execute [org.elasticsearch.action.search.SearchRequest@611b4d10]\nRemoteTransportException[[Manta][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerException;\nCaused by: java.lang.NullPointerException\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Occurrences.getOccurrence(GlobalOrdinalsWithScoreCollector.java:375)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Avg.score(GlobalOrdinalsWithScoreCollector.java:229)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreQuery$W.explain(GlobalOrdinalsWithScoreQuery.java:131)\n    at org.apache.lucene.search.BooleanWeight.explain(BooleanWeight.java:148)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:875)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:852)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.explain(ContextIndexSearcher.java:128)\n    at org.elasticsearch.search.fetch.explain.ExplainFetchSubPhase.hitExecute(ExplainFetchSubPhase.java:61)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:187)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:478)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n[2016-02-09 09:07:13,741][DEBUG][action.search.type       ] [Manta] All shards failed for phase: [query_fetch]\nRemoteTransportException[[Manta][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerException;\nCaused by: java.lang.NullPointerException\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Occurrences.getOccurrence(GlobalOrdinalsWithScoreCollector.java:375)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Avg.score(GlobalOrdinalsWithScoreCollector.java:229)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreQuery$W.explain(GlobalOrdinalsWithScoreQuery.java:131)\n    at org.apache.lucene.search.BooleanWeight.explain(BooleanWeight.java:148)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:875)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:852)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.explain(ContextIndexSearcher.java:128)\n    at org.elasticsearch.search.fetch.explain.ExplainFetchSubPhase.hitExecute(ExplainFetchSubPhase.java:61)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:187)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:478)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n[2016-02-09 09:07:13,742][INFO ][rest.suppressed          ] /blogs/_search Params: {pretty=, index=blogs}\nFailed to execute phase [query_fetch], all shards failed; shardFailures {[oYZDW2pHT6SYvh-uTmIKIQ][blogs][0]: RemoteTransportException[[Manta][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerException; }\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:228)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onFailure(TransportSearchTypeAction.java:174)\n    at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:46)\n    at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:821)\n    at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:799)\n    at org.elasticsearch.transport.TransportService$4.onFailure(TransportService.java:361)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: ; nested: NullPointerException;\n    at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:386)\n    at org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:152)\n    at org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:99)\n    at java.lang.Throwable.printStackTrace(Throwable.java:665)\n    at java.lang.Throwable.printStackTrace(Throwable.java:721)\n    at org.apache.log4j.DefaultThrowableRenderer.render(DefaultThrowableRenderer.java:60)\n    at org.apache.log4j.spi.ThrowableInformation.getThrowableStrRep(ThrowableInformation.java:87)\n    at org.apache.log4j.spi.LoggingEvent.getThrowableStrRep(LoggingEvent.java:413)\n    at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:313)\n    at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\n    at org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:251)\n    at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:66)\n    at org.apache.log4j.Category.callAppenders(Category.java:206)\n    at org.apache.log4j.Category.forcedLog(Category.java:391)\n    at org.apache.log4j.Category.log(Category.java:856)\n    at org.elasticsearch.common.logging.log4j.Log4jESLogger.internalInfo(Log4jESLogger.java:125)\n    at org.elasticsearch.common.logging.support.AbstractESLogger.info(AbstractESLogger.java:90)\n    at org.elasticsearch.rest.BytesRestResponse.convert(BytesRestResponse.java:131)\n    at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96)\n    at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:87)\n    at org.elasticsearch.rest.action.support.RestActionListener.onFailure(RestActionListener.java:60)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.raiseEarlyFailure(TransportSearchTypeAction.java:316)\n    ... 10 more\nCaused by: java.lang.NullPointerException\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Occurrences.getOccurrence(GlobalOrdinalsWithScoreCollector.java:375)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreCollector$Avg.score(GlobalOrdinalsWithScoreCollector.java:229)\n    at org.apache.lucene.search.join.GlobalOrdinalsWithScoreQuery$W.explain(GlobalOrdinalsWithScoreQuery.java:131)\n    at org.apache.lucene.search.BooleanWeight.explain(BooleanWeight.java:148)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:875)\n    at org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:852)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.explain(ContextIndexSearcher.java:128)\n    at org.elasticsearch.search.fetch.explain.ExplainFetchSubPhase.hitExecute(ExplainFetchSubPhase.java:61)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:187)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:478)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    ... 3 more\n{\n  \"error\" : {\n    \"root_cause\" : [ {\n      \"type\" : \"null_pointer_exception\",\n      \"reason\" : null\n    } ],\n    \"type\" : \"search_phase_execution_exception\",\n    \"reason\" : \"all shards failed\",\n    \"phase\" : \"query_fetch\",\n    \"grouped\" : true,\n    \"failed_shards\" : [ {\n      \"shard\" : 0,\n      \"index\" : \"blogs\",\n      \"node\" : \"oYZDW2pHT6SYvh-uTmIKIQ\",\n      \"reason\" : {\n        \"type\" : \"null_pointer_exception\",\n        \"reason\" : null\n      }\n    } ]\n  },\n  \"status\" : 500\n}\n```\n\n'avg' is the only score_mode that raises this exception, other modes work correctly. Also if I turn explain off, the exception is not raised.\nIn version 1.3.7 of Elasticsearch the above sequence works without raising an exception. I have not tested any version in-between.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}