[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324804790","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-324804790","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":324804790,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDgwNDc5MA==","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T02:07:14Z","updated_at":"2017-08-25T02:08:19Z","author_association":"NONE","body":"this issue is some like [https://github.com/elastic/elasticsearch/issues/25845](url)\r\nSum Buckets Aggregation does not work with Nested / Reverse Nested Aggregation","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324805609","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-324805609","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":324805609,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDgwNTYwOQ==","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T02:13:35Z","updated_at":"2017-08-25T02:13:35Z","author_association":"NONE","body":"**Other Test cases of help**: \r\nIf inserted a term aggregation, it will give the expected result:\r\n```\r\nSearch Request\r\nPOST /cc-gossip-test-2017.08.24/_search\r\n{\r\n   \"from\": 0,\r\n   \"aggs\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"aggs\": {\r\n            \"snmp.ifXTableStats\": {\r\n               \"filter\": {\r\n                  \"bool\": {\r\n                     \"must\": []\r\n                  }\r\n               },\r\n               \"aggs\": {\r\n                  \"cj6qakw6f00073c5te75udm75\": {\r\n                     \"terms\": {\r\n                        \"field\": \"snmp.ifXTableStats.ifName\",\r\n                        \"size\": 1\r\n                     },\r\n                     \"aggs\": {\r\n                        \"cj6qal8gy00083c5ttt25sajj\": {\r\n                           \"bucket_script\": {\r\n                              \"buckets_path\": {\r\n                                 \"_t_8daa19d0\": \"_t_8daa19d0\"\r\n                              },\r\n                              \"script\": {\r\n                                 \"lang\": \"groovy\",\r\n                                 \"inline\": \"_t_8daa19d0*8/30\"\r\n                              }\r\n                           }\r\n                        },\r\n                        \"_t_8daa19d0\": {\r\n                           \"avg\": {\r\n                              \"field\": \"snmp.ifXTableStats.ifHCInPkts\"\r\n                           }\r\n                        }\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         },\r\n         \"nested\": {\r\n            \"path\": \"snmp.ifXTableStats\"\r\n         }\r\n      }\r\n   },\r\n   \"size\": 0\r\n}\r\n\r\nResponse：\r\n{\r\n   \"took\": 84,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 30400,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"doc_count\": 486400,\r\n         \"snmp.ifXTableStats\": {\r\n            \"doc_count\": 486400,\r\n            \"cj6qakw6f00073c5te75udm75\": {\r\n               \"doc_count_error_upper_bound\": 30400,\r\n               \"sum_other_doc_count\": 456000,\r\n               \"buckets\": [\r\n                  {\r\n                     \"key\": \"aggregate1\",\r\n                     \"doc_count\": 30400,\r\n                     \"_t_8daa19d0\": {\r\n                        \"value\": 502785.6380263158\r\n                     },\r\n                     \"cj6qal8gy00083c5ttt25sajj\": {\r\n                        \"value\": 134076.17014035088\r\n                     }\r\n                  }\r\n               ]\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324806303","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-324806303","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":324806303,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDgwNjMwMw==","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T02:18:43Z","updated_at":"2017-08-25T02:18:43Z","author_association":"NONE","body":"If replaced the empty-filter-aggregation with a meaningless-terms-aggregation, it also works:\r\n```\r\nSearch Request:\r\nPOST /cc-gossip-test-2017.08.24/_search\r\n{\r\n   \"from\": 0,\r\n   \"aggs\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"aggs\": {\r\n            \"snmp.ifXTableStats\": {\r\n               \"terms\": {\r\n                  \"script\": {\r\n                     \"lang\": \"groovy\",\r\n                     \"inline\": \"'total'\"\r\n                  }\r\n               },\r\n               \"aggs\": {\r\n                  \"cj6qal8gy00083c5ttt25sajj\": {\r\n                     \"bucket_script\": {\r\n                        \"buckets_path\": {\r\n                           \"_t_a5bd8820\": \"_t_a5bd8820\"\r\n                        },\r\n                        \"script\": {\r\n                           \"lang\": \"groovy\",\r\n                           \"inline\": \"_t_a5bd8820\"\r\n                        }\r\n                     }\r\n                  },\r\n                  \"_t_a5bd8820\": {\r\n                     \"avg\": {\r\n                        \"field\": \"snmp.ifXTableStats.ifHCInPkts\"\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         },\r\n         \"nested\": {\r\n            \"path\": \"snmp.ifXTableStats\"\r\n         }\r\n      }\r\n   },\r\n   \"size\": 0\r\n}\r\n\r\nResponse:\r\n{\r\n   \"took\": 484,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 30400,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"doc_count\": 486400,\r\n         \"snmp.ifXTableStats\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n               {\r\n                  \"key\": \"total\",\r\n                  \"doc_count\": 486400,\r\n                  \"_t_a5bd8820\": {\r\n                     \"value\": 499477.43625616777\r\n                  },\r\n                  \"cj6qal8gy00083c5ttt25sajj\": {\r\n                     \"value\": 499477.43625616777\r\n                  }\r\n               }\r\n            ]\r\n         }\r\n      }\r\n   }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324806653","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-324806653","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":324806653,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDgwNjY1Mw==","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T02:21:32Z","updated_at":"2017-08-25T02:21:32Z","author_association":"NONE","body":"\r\nIf removed the bucket-script aggregation， it also works as expected：\r\n```\r\nSearch Request:\r\nPOST /cc-gossip-test-2017.08.24/_search\r\n{\r\n   \"from\": 0,\r\n   \"aggs\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"aggs\": {\r\n            \"snmp.ifXTableStats\": {\r\n               \"filter\": {\r\n                  \"bool\": {\r\n                     \"must\": []\r\n                  }\r\n               },\r\n               \"aggs\": {\r\n                  \"_t_a5bd8820\": {\r\n                     \"avg\": {\r\n                        \"field\": \"snmp.ifXTableStats.ifHCInPkts\"\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         },\r\n         \"nested\": {\r\n            \"path\": \"snmp.ifXTableStats\"\r\n         }\r\n      }\r\n   },\r\n   \"size\": 0\r\n}\r\n\r\nRsponse:\r\n{\r\n   \"took\": 64,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 30400,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n   },\r\n   \"aggregations\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"doc_count\": 486400,\r\n         \"snmp.ifXTableStats\": {\r\n            \"doc_count\": 486400,\r\n            \"_t_a5bd8820\": {\r\n               \"value\": 499477.43625616777\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324845044","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-324845044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":324845044,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDg0NTA0NA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T07:28:43Z","updated_at":"2017-08-25T07:28:43Z","author_association":"MEMBER","body":"This actually has nothing to do with the the nested field. The reason your first example above fails is because the `filter` aggregation is not a multi-bucket aggregation. The `bucket_script` aggregation requires that it's parent aggregation is a multi-bucket aggregation.\r\n\r\nIf you use the `filters` aggregation instead of the `filter` aggregation your first example should work.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/341049996","html_url":"https://github.com/elastic/elasticsearch/issues/26376#issuecomment-341049996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","id":341049996,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MTA0OTk5Ng==","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"created_at":"2017-11-01T09:23:08Z","updated_at":"2017-11-01T09:23:08Z","author_association":"NONE","body":"@colings86  thanks a lot, it help me a lot","performed_via_github_app":null}]