{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9271","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9271/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9271/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9271/events","html_url":"https://github.com/elastic/elasticsearch/issues/9271","id":54171799,"node_id":"MDU6SXNzdWU1NDE3MTc5OQ==","number":9271,"title":"`children` aggregation missing documents","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":157995054,"node_id":"MDU6TGFiZWwxNTc5OTUwNTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.3","name":"v1.4.3","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-01-13T10:11:10Z","updated_at":"2015-01-19T10:43:22Z","closed_at":"2015-01-19T10:43:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"There appears to be a bug in the `children` aggregation, which misses one matching document.\n\nThere is a workaround for the bug, by adding an outer aggregation at the parent level.  However, this clutters the query.  Worse, even with the workaround the bug showed up again when I did multiple Children Aggregations (involving one parent type and two distinct children types).\n\n```\nDELETE _all \n\n#  Product Catalogue Index\n\nDELETE /prodcatalog\n\nPUT /prodcatalog\n\n#  Use parent-child mapping to capture a Master Product and its Variant SKUs.\n\nPUT /prodcatalog/masterprod/_mapping\n{  \n   \"masterprod\":{  \n      \"properties\":{  \n         \"brand\":{  \n            \"type\":\"string\",\n            \"index\":\"not_analyzed\"\n         },\n         \"name\":{  \n            \"type\":\"string\"\n         }\n      }\n   }\n}\n\nPUT /prodcatalog/variantsku/_mapping\n{  \n   \"variantsku\":{  \n      \"_parent\":{  \n         \"type\":\"masterprod\"\n      },\n      \"properties\":{  \n         \"color\":{  \n            \"type\":\"string\",\n            \"index\":\"not_analyzed\"\n         },\n         \"size\":{  \n            \"type\":\"string\",\n            \"index\":\"not_analyzed\"\n         }\n      }\n   }\n}\n\nGET /prodcatalog/_mapping\n\n\n#  Index 2 parents and several children.\n\n\nPUT /prodcatalog/masterprod/1\n{\n  \"brand\": \"Levis\",\n  \"name\": \"Style 501\",\n  \"material\": \"Denim\"\n}\n\nPUT /prodcatalog/variantsku/10001?parent=1\n{\n    \"color\" : \"blue\",\n    \"size\"  : \"32\"\n}\n\n\nPUT /prodcatalog/variantsku/10002?parent=1\n{\n    \"color\" : \"blue\",\n    \"size\"  : \"34\"\n}\n\n\nPUT /prodcatalog/variantsku/10003?parent=1\n{\n    \"color\" : \"blue\",\n    \"size\"  : \"36\"\n}\n\n\nPUT /prodcatalog/variantsku/10004?parent=1\n{\n    \"color\" : \"black\",\n    \"size\"  : \"38\"\n}\n\n\nPUT /prodcatalog/variantsku/10005?parent=1\n{\n    \"color\" : \"black\",\n    \"size\"  : \"40\"\n}\n\n\nPUT /prodcatalog/variantsku/10006?parent=1\n{\n    \"color\" : \"gray\",\n    \"size\"  : \"36\"\n}\n\n\nPUT /prodcatalog/masterprod/2\n{\n    \"brand\" : \"Wrangler\",\n    \"name\"  : \"Regular Cut\",\n    \"material\" : \"Leather\"\n}\n\nPUT /prodcatalog/variantsku/20001?parent=2\n{\n    \"color\" : \"blue\",\n    \"size\"  : \"32\"\n}\n\nPUT /prodcatalog/variantsku/20002?parent=2\n{\n    \"color\" : \"blue\",\n    \"size\"  : \"34\"\n}\n\n\nPUT /prodcatalog/variantsku/20003?parent=2\n{\n    \"color\" : \"black\",\n    \"size\"  : \"36\"\n}\n\n\nPUT /prodcatalog/variantsku/20004?parent=2\n{\n    \"color\" : \"black\",\n    \"size\"  : \"38\"\n}\n\n\nPUT /prodcatalog/variantsku/20005?parent=2\n{\n    \"color\" : \"black\",\n    \"size\"  : \"40\"\n}\n\n\nPUT /prodcatalog/variantsku/20006?parent=2\n{\n    \"color\" : \"orange\",\n    \"size\"  : \"36\"\n}\n\n\nPUT /prodcatalog/variantsku/20007?parent=2\n{\n    \"color\" : \"green\",\n    \"size\"  : \"44\"\n}\n\n\n\n\n#  The query below should match the 1 masterprod doc with an orange variantsku.\n#  The aggregations should return 7 refinements for the Children.\n#  BUG: One color Children Aggregation is missing !!\n\nPOST /prodcatalog/masterprod/_search\n{  \n   \"query\":{  \n      \"has_child\":{  \n         \"type\":\"variantsku\",\n         \"score_mode\":\"none\",\n         \"query\":{  \n            \"term\":{  \n               \"color\":\"orange\"\n            }\n         }\n      }\n   },\n   \"aggs\":{  \n      \"my-refinements\":{  \n         \"children\":{  \n            \"type\":\"variantsku\"\n         },\n         \"aggs\":{  \n            \"my-sizes\":{  \n               \"terms\":{  \n                  \"field\":\"variantsku.size\"\n               }\n            },\n            \"my-colors\":{  \n               \"terms\":{  \n                  \"field\":\"variantsku.color\"\n               }\n            }            \n         }\n      }\n   }\n}\n\n\n#  Partial results:\n#  Note that the green variantsku is missing,\n#  and we only have 6 results, though expecting 7.\n\n         \"my-colors\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n               {\n                  \"key\": \"black\",\n                  \"doc_count\": 3\n               },\n               {\n                  \"key\": \"blue\",\n                  \"doc_count\": 2\n               },\n               {\n                  \"key\": \"orange\",\n                  \"doc_count\": 1\n               }\n            ]\n         }\n\n\n\n#  Here is my Workaround.\n#  By adding an aggregation at the parent level (brand),\n#  we no longer lose 1 variantsku document.\n\nPOST /prodcatalog/masterprod/_search\n{\n   \"query\":{  \n      \"has_child\":{  \n         \"type\":\"variantsku\",\n         \"score_mode\":\"none\",\n         \"query\":{  \n            \"term\":{  \n               \"color\":\"orange\"\n            }\n         }\n      }\n   },    \n  \"aggs\": {\n    \"my-brands\": {\n      \"terms\": {\n        \"field\": \"brand\"\n      },\n      \"aggs\": {\n        \"my-refinements\": {\n          \"children\": {\n            \"type\" : \"variantsku\" \n          },\n          \"aggs\": {\n            \"my-colors\": {\n              \"terms\": {\n                \"field\": \"variantsku.color\"\n              }\n            },\n            \"my-sizes\": {\n              \"terms\": {\n                \"field\": \"variantsku.size\"\n              }\n            }\n          }          \n        }\n      }\n    }\n  }\n}\n\n#  Partial Results:\n\n                  \"my-colors\": {\n                     \"doc_count_error_upper_bound\": 0,\n                     \"sum_other_doc_count\": 0,\n                     \"buckets\": [\n                        {\n                           \"key\": \"black\",\n                           \"doc_count\": 3\n                        },\n                        {\n                           \"key\": \"blue\",\n                           \"doc_count\": 2\n                        },\n                        {\n                           \"key\": \"green\",\n                           \"doc_count\": 1\n                        },\n                        {\n                           \"key\": \"orange\",\n                           \"doc_count\": 1\n                        }\n                     ]\n\n\n#  Since we are not interested in a breakdown by brand,\n#  we can use something generic, like _type\n#  which should only return 1 bucket at the parent level.\n#  Again, we no longer lose 1 variantsku document.\n\nPOST /prodcatalog/masterprod/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"variantsku\",\n      \"score_mode\": \"none\",\n      \"query\": {\n        \"term\": {\n          \"color\": \"orange\"\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"my-types\": {\n      \"terms\": {\n        \"field\": \"_type\"\n      },\n      \"aggs\": {\n        \"my-refinements\": {\n          \"children\": {\n            \"type\": \"variantsku\"\n          },\n          \"aggs\": {\n            \"my-colors\": {\n              \"terms\": {\n                \"field\": \"variantsku.color\"\n              }\n            },\n            \"my-sizes\": {\n              \"terms\": {\n                \"field\": \"variantsku.size\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}