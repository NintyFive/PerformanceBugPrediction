{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1800","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1800/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1800/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1800/events","html_url":"https://github.com/elastic/elasticsearch/issues/1800","id":3753758,"node_id":"MDU6SXNzdWUzNzUzNzU4","number":1800,"title":"0.19.0: \"Failed to snapshot translog\" (\"Failed to get [__2mn1]\"), then all 1285 threads are blocked","user":{"login":"alambert","id":69652,"node_id":"MDQ6VXNlcjY5NjUy","avatar_url":"https://avatars2.githubusercontent.com/u/69652?v=4","gravatar_id":"","url":"https://api.github.com/users/alambert","html_url":"https://github.com/alambert","followers_url":"https://api.github.com/users/alambert/followers","following_url":"https://api.github.com/users/alambert/following{/other_user}","gists_url":"https://api.github.com/users/alambert/gists{/gist_id}","starred_url":"https://api.github.com/users/alambert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alambert/subscriptions","organizations_url":"https://api.github.com/users/alambert/orgs","repos_url":"https://api.github.com/users/alambert/repos","events_url":"https://api.github.com/users/alambert/events{/privacy}","received_events_url":"https://api.github.com/users/alambert/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2012-03-21T21:24:28Z","updated_at":"2012-03-22T10:19:41Z","closed_at":"2012-03-21T21:47:09Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi,\n\nI have a three-machine cluster running v0.19.0. After a period of heavy feeding, one machine wrote this to the log:\n\n<pre>\n[2012-03-21 20:46:07,722][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.net.SocketException) caught when processing request: Broken pipe\n[2012-03-21 20:46:07,734][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,722][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.net.SocketException) caught when processing request: Broken pipe\n[2012-03-21 20:46:07,736][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,722][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.net.SocketException) caught when processing request: Broken pipe\n[2012-03-21 20:46:07,736][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,722][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.net.SocketException) caught when processing request: Broken pipe\n[2012-03-21 20:46:07,736][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,775][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 1568768 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,775][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,775][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 2764800 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,776][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,784][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 1421312 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,785][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,803][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 1568768 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,803][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,810][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 1421312 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,810][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,836][WARN ][com.amazonaws.http.AmazonHttpClient] Unable to execute HTTP request: Input stream cannot be reset as 1421312 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,836][WARN ][com.amazonaws.http.AmazonHttpClient] Unable to execute HTTP request: Input stream cannot be reset as 1568768 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,881][INFO ][org.apache.http.impl.client.DefaultHttpClient] I/O exception (java.io.IOException) caught when processing request: Input stream cannot be reset as 2764800 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,882][INFO ][org.apache.http.impl.client.DefaultHttpClient] Retrying request\n[2012-03-21 20:46:07,901][WARN ][index.gateway            ] [aws-e1b-15.xxxxtest.net] [twitter][7] failed to snapshot (scheduled)\norg.elasticsearch.index.gateway.IndexShardGatewaySnapshotFailedException: [twitter][7] Failed to snapshot translog\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.doSnapshot(BlobStoreIndexShardGateway.java:307)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.snapshot(BlobStoreIndexShardGateway.java:160)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:271)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.engine.robin.RobinEngine.snapshot(RobinEngine.java:1043)\n    at org.elasticsearch.index.shard.service.InternalIndexShard.snapshot(InternalIndexShard.java:528)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$SnapshotRunnable.run(IndexShardGatewayService.java:366)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    at java.lang.Thread.run(Thread.java:679)\nCaused by: java.io.IOException: Failed to get [__2mn1]\n    at org.elasticsearch.common.blobstore.support.BlobStores.syncWriteBlob(BlobStores.java:60)\n    at org.elasticsearch.cloud.aws.blobstore.S3ImmutableBlobContainer.writeBlob(S3ImmutableBlobContainer.java:59)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.snapshotTranslog(BlobStoreIndexShardGateway.java:701)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.doSnapshot(BlobStoreIndexShardGateway.java:305)\n    ... 10 more\nCaused by: com.amazonaws.AmazonClientException: Unable to execute HTTP request: Input stream cannot be reset as 1568768 bytes have been written, exceeding the available buffer size of 131072\n    at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:298)\n    at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:170)\n    at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:2632)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1060)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:944)\n    at org.elasticsearch.cloud.aws.blobstore.S3ImmutableBlobContainer$1.run(S3ImmutableBlobContainer.java:48)\n    ... 3 more\nCaused by: java.io.IOException: Input stream cannot be reset as 1568768 bytes have been written, exceeding the available buffer size of 131072\n    at com.amazonaws.services.s3.internal.RepeatableInputStream.reset(RepeatableInputStream.java:84)\n    at com.amazonaws.services.s3.internal.MD5DigestCalculatingInputStream.reset(MD5DigestCalculatingInputStream.java:60)\n    at com.amazonaws.http.RepeatableInputStreamRequestEntity.writeTo(RepeatableInputStreamRequestEntity.java:123)\n    at org.apache.http.entity.HttpEntityWrapper.writeTo(HttpEntityWrapper.java:96)\n    at org.apache.http.impl.client.EntityEnclosingRequestWrapper$EntityWrapper.writeTo(EntityEnclosingRequestWrapper.java:108)\n    at org.apache.http.impl.entity.EntitySerializer.serialize(EntitySerializer.java:120)\n    at org.apache.http.impl.AbstractHttpClientConnection.sendRequestEntity(AbstractHttpClientConnection.java:263)\n    at org.apache.http.impl.conn.AbstractClientConnAdapter.sendRequestEntity(AbstractClientConnAdapter.java:227)\n    at org.apache.http.protocol.HttpRequestExecutor.doSendRequest(HttpRequestExecutor.java:255)\n    at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:123)\n    at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:633)\n    at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:454)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:820)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:754)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:732)\n    at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:266)\n    ... 8 more\n[2012-03-21 20:46:07,927][WARN ][com.amazonaws.http.AmazonHttpClient] Unable to execute HTTP request: Input stream cannot be reset as 2764800 bytes have been written, exceeding the available buffer size of 131072\n[2012-03-21 20:46:07,928][WARN ][index.gateway            ] [aws-e1b-15.xxxxtest.net] [facebook][9] failed to snapshot (scheduled)\norg.elasticsearch.index.gateway.IndexShardGatewaySnapshotFailedException: [facebook][9] Failed to snapshot translog\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.doSnapshot(BlobStoreIndexShardGateway.java:307)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.snapshot(BlobStoreIndexShardGateway.java:160)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:271)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.engine.robin.RobinEngine.snapshot(RobinEngine.java:1043)\n    at org.elasticsearch.index.shard.service.InternalIndexShard.snapshot(InternalIndexShard.java:528)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$SnapshotRunnable.run(IndexShardGatewayService.java:366)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    at java.lang.Thread.run(Thread.java:679)\nCaused by: java.io.IOException: Failed to get [__2ga7]\n    at org.elasticsearch.common.blobstore.support.BlobStores.syncWriteBlob(BlobStores.java:60)\n    at org.elasticsearch.cloud.aws.blobstore.S3ImmutableBlobContainer.writeBlob(S3ImmutableBlobContainer.java:59)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.snapshotTranslog(BlobStoreIndexShardGateway.java:701)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.doSnapshot(BlobStoreIndexShardGateway.java:305)\n    ... 10 more\nCaused by: com.amazonaws.AmazonClientException: Unable to execute HTTP request: Input stream cannot be reset as 2764800 bytes have been written, exceeding the available buffer size of 131072\n    at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:298)\n    at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:170)\n    at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:2632)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1060)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:944)\n    at org.elasticsearch.cloud.aws.blobstore.S3ImmutableBlobContainer$1.run(S3ImmutableBlobContainer.java:48)\n    ... 3 more\nCaused by: java.io.IOException: Input stream cannot be reset as 2764800 bytes have been written, exceeding the available buffer size of 131072\n    at com.amazonaws.services.s3.internal.RepeatableInputStream.reset(RepeatableInputStream.java:84)\n    at com.amazonaws.services.s3.internal.MD5DigestCalculatingInputStream.reset(MD5DigestCalculatingInputStream.java:60)\n    at com.amazonaws.http.RepeatableInputStreamRequestEntity.writeTo(RepeatableInputStreamRequestEntity.java:123)\n    at org.apache.http.entity.HttpEntityWrapper.writeTo(HttpEntityWrapper.java:96)\n    at org.apache.http.impl.client.EntityEnclosingRequestWrapper$EntityWrapper.writeTo(EntityEnclosingRequestWrapper.java:108)\n    at org.apache.http.impl.entity.EntitySerializer.serialize(EntitySerializer.java:120)\n    at org.apache.http.impl.AbstractHttpClientConnection.sendRequestEntity(AbstractHttpClientConnection.java:263)\n    at org.apache.http.impl.conn.AbstractClientConnAdapter.sendRequestEntity(AbstractClientConnAdapter.java:227)\n    at org.apache.http.protocol.HttpRequestExecutor.doSendRequest(HttpRequestExecutor.java:255)\n    at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:123)\n    at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:633)\n    at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:454)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:820)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:754)\n    at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:732)\n    at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:266)\n    ... 8 more\n[2012-03-21 20:46:11,802][WARN ][index.gateway            ] [aws-e1b-15.xxxxtest.net] [facebook][5] failed to snapshot (scheduled)\norg.elasticsearch.index.gateway.IndexShardGatewaySnapshotFailedException: [facebook][5] Failed to perform snapshot (index files)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.doSnapshot(BlobStoreIndexShardGateway.java:246)\n    at org.elasticsearch.index.gateway.blobstore.BlobStoreIndexShardGateway.snapshot(BlobStoreIndexShardGateway.java:160)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:271)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$2.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.engine.robin.RobinEngine.snapshot(RobinEngine.java:1043)\n    at org.elasticsearch.index.shard.service.InternalIndexShard.snapshot(InternalIndexShard.java:528)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService.snapshot(IndexShardGatewayService.java:265)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$SnapshotRunnable.run(IndexShardGatewayService.java:366)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    at java.lang.Thread.run(Thread.java:679)\nCaused by: Status Code: 400, AWS Service: Amazon S3, AWS Request ID: 51D95E9EC62C322C, AWS Error Code: RequestTimeout, AWS Error Message: Your socket connection to the server was not read from or written to within the timeout period. Idle connections will be closed., S3 Extended Request ID: ayC++VYMCFNkYrX1xhULdplw2F1ZTcDiXw20ou+25Yl98oNBd5EvF82vEb4cdGTh\n    at com.amazonaws.http.AmazonHttpClient.handleErrorResponse(AmazonHttpClient.java:548)\n    at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:288)\n    at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:170)\n    at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:2632)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1060)\n    at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:944)\n    at org.elasticsearch.cloud.aws.blobstore.S3ImmutableBlobContainer$1.run(S3ImmutableBlobContainer.java:48)\n    ... 3 more\n</pre>\n\n\nNow the node is unavailable; all 1285 threads are blocked. The full jstack output, additional logs, and verification that the number of open FDs is less than the limit is available https://gist.github.com/f8dcbb7ae2862327c4d4\n\nI'm on IRC as usual. Thank you!\n\nAlex\n","closed_by":{"login":"alambert","id":69652,"node_id":"MDQ6VXNlcjY5NjUy","avatar_url":"https://avatars2.githubusercontent.com/u/69652?v=4","gravatar_id":"","url":"https://api.github.com/users/alambert","html_url":"https://github.com/alambert","followers_url":"https://api.github.com/users/alambert/followers","following_url":"https://api.github.com/users/alambert/following{/other_user}","gists_url":"https://api.github.com/users/alambert/gists{/gist_id}","starred_url":"https://api.github.com/users/alambert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alambert/subscriptions","organizations_url":"https://api.github.com/users/alambert/orgs","repos_url":"https://api.github.com/users/alambert/repos","events_url":"https://api.github.com/users/alambert/events{/privacy}","received_events_url":"https://api.github.com/users/alambert/received_events","type":"User","site_admin":false},"performed_via_github_app":null}