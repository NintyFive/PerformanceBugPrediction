{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/47012","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47012/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47012/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47012/events","html_url":"https://github.com/elastic/elasticsearch/issues/47012","id":497660400,"node_id":"MDU6SXNzdWU0OTc2NjA0MDA=","number":47012,"title":"Data frame transforms doc test leaks notifications index","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-09-24T12:35:57Z","updated_at":"2019-09-25T08:53:45Z","closed_at":"2019-09-25T08:53:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This PR build failed:\r\n\r\nhttps://gradle-enterprise.elastic.co/s/gl7xfw7xuevbm/console-log?task=:docs:integTestRunner\r\n\r\nIt looks like we expected there to be a single active shard (out of 2, i.e. 50%) but in fact there were two active shards (out of 3, i.e. 66â…”%):\r\n\r\n```\r\n\r\norg.elasticsearch.smoketest.DocsClientYamlTestSuiteIT > test {yaml=reference/cluster/health/line_140} FAILED\r\n    java.lang.AssertionError: Failure at [reference/cluster/health:36]: $body didn't match expected value:\r\n                             $body: \r\n               active_primary_shards: expected Integer [1] but was Integer [2]\r\n                       active_shards: expected Integer [1] but was Integer [2]\r\n      active_shards_percent_as_number: expected Double [50.0] but was Double [66.66666666666666]\r\n                        cluster_name: same [integTest]\r\n           delayed_unassigned_shards: same [0]\r\n                 initializing_shards: same [0]\r\n                number_of_data_nodes: same [1]\r\n           number_of_in_flight_fetch: same [0]\r\n                     number_of_nodes: same [1]\r\n             number_of_pending_tasks: same [0]\r\n                   relocating_shards: same [0]\r\n                              status: same [yellow]\r\n      task_max_waiting_in_queue_millis: same [0]\r\n                           timed_out: same [false]\r\n                   unassigned_shards: same [1]\r\n```\r\n\r\nThe failing test runs just after a test from `reference/transform/apis/put-transform`:\r\n\r\n```\r\n1> [2019-09-24T06:09:01,547][INFO ][o.e.s.DocsClientYamlTestSuiteIT] [test] [yaml=reference/transform/apis/put-transform/line_143] before test\r\n1> [2019-09-24T06:09:01,925][INFO ][o.e.s.DocsClientYamlTestSuiteIT] [test] [yaml=reference/transform/apis/put-transform/line_143] after test\r\n1> [2019-09-24T06:09:01,967][INFO ][o.e.s.DocsClientYamlTestSuiteIT] [test] [yaml=reference/cluster/health/line_140] before test\r\n1> [2019-09-24T06:09:02,332][INFO ][o.e.s.DocsClientYamlTestSuiteIT] [test] [yaml=reference/cluster/health/line_140] after test\r\n```\r\n\r\nLooking at the node logs I see that the `.data-frame-notifications-1` index was created, presumably by the previous test, but not cleaned up before the cluster health test started:\r\n\r\n```\r\n[2019-09-24T12:09:01,554][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [kibana_sample_data_ecommerce] creating index, cause [api], templates [], shards [1]/[0], mappings []\r\n[2019-09-24T12:09:01,589][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[kibana_sample_data_ecommerce][0]]]).\r\n[2019-09-24T12:09:01,621][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.data-frame-internal-2] creating index, cause [auto(bulk api)], templates [.data-frame-internal-2], shards [1]/[1], mappings [_doc]\r\n[2019-09-24T12:09:01,621][INFO ][o.e.c.r.a.AllocationService] [node-0] updating number_of_replicas to [0] for indices [.data-frame-internal-2]\r\n[2019-09-24T12:09:01,657][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.data-frame-internal-2][0]]]).\r\n[2019-09-24T12:09:01,705][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.data-frame-notifications-1] creating index, cause [auto(bulk api)], templates [.data-frame-notifications-1], shards [1]/[1], mappings [_doc]\r\n[2019-09-24T12:09:01,706][INFO ][o.e.c.r.a.AllocationService] [node-0] updating number_of_replicas to [0] for indices [.data-frame-notifications-1]\r\n[2019-09-24T12:09:01,731][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [kibana_sample_data_ecommerce/PGkpPb14TrmCHStV6yBaZQ] deleting index\r\n[2019-09-24T12:09:01,731][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [.data-frame-internal-2/NFmRTZ3fSwedxfFHnHoSaw] deleting index\r\n[2019-09-24T12:09:01,820][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.data-frame-notifications-1][0]]]).\r\n[2019-09-24T12:09:01,830][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] removing template [.logstash-management]\r\n[2019-09-24T12:09:01,842][INFO ][o.e.c.m.TemplateUpgradeService] [node-0] Starting template upgrade to version 8.0.0, 1 templates will be updated and 0 will be removed\r\n[2019-09-24T12:09:01,850][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node-0] adding template [.logstash-management] for index patterns [.logstash]\r\n[2019-09-24T12:09:01,862][INFO ][o.e.c.m.TemplateUpgradeService] [node-0] Templates were upgraded successfully to version 8.0.0\r\n[2019-09-24T12:09:01,882][INFO ][o.e.x.i.a.TransportPutLifecycleAction] [node-0] adding index lifecycle policy [watch-history-ilm-policy]\r\n[2019-09-24T12:09:01,905][INFO ][o.e.x.i.a.TransportPutLifecycleAction] [node-0] adding index lifecycle policy [slm-history-ilm-policy]\r\n[2019-09-24T12:09:01,972][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [test1] creating index, cause [api], templates [], shards [1]/[1], mappings []\r\n[2019-09-24T12:09:02,201][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [.data-frame-notifications-1/tf0A8w8-Syib0TWrxJTgDg] deleting index\r\n[2019-09-24T12:09:02,201][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [test1/23XD040xTSCqHS31Yw0AzA] deleting index\r\n```","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}