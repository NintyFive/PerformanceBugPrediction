{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25977","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25977/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25977/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25977/events","html_url":"https://github.com/elastic/elasticsearch/issues/25977","id":246723594,"node_id":"MDU6SXNzdWUyNDY3MjM1OTQ=","number":25977,"title":"Highlight_query with multiple boosted match_phrases only considers the last boost factor. (FVH)","user":{"login":"kori0129","id":23311112,"node_id":"MDQ6VXNlcjIzMzExMTEy","avatar_url":"https://avatars1.githubusercontent.com/u/23311112?v=4","gravatar_id":"","url":"https://api.github.com/users/kori0129","html_url":"https://github.com/kori0129","followers_url":"https://api.github.com/users/kori0129/followers","following_url":"https://api.github.com/users/kori0129/following{/other_user}","gists_url":"https://api.github.com/users/kori0129/gists{/gist_id}","starred_url":"https://api.github.com/users/kori0129/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kori0129/subscriptions","organizations_url":"https://api.github.com/users/kori0129/orgs","repos_url":"https://api.github.com/users/kori0129/repos","events_url":"https://api.github.com/users/kori0129/events{/privacy}","received_events_url":"https://api.github.com/users/kori0129/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-07-31T11:18:48Z","updated_at":"2018-03-23T09:29:25Z","closed_at":"2018-03-23T09:29:25Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\nElasticsearch version: 5.2.0\r\n\r\nPlugins installed: []\r\n\r\nJVM version (java -version): 1.8.0_131\r\n\r\nOS version (uname -a if on a Unix-like system):\r\nLinux 3.10.0-514.6.1.el7.x86_64 #1 SMP Wed Jan 18 13:06:36 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n**Action**: Highlight a field with a highlight_query, using multiple match_phrases with different boost factors in Fast Vector Highlighter\r\n**Expected Behaviour**: Each match_phrase's boost factor is used.\r\n**Actual Behaviour**: Only the last boost factor is used for all match_phrases\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\n 1. Create index with a field with \"term_vector\" : \"with_positions_offsets\", to use Fast Vector Highlighter\r\n```\r\nPUT highlighttest\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 3, \r\n            \"number_of_replicas\" : 2\r\n            \r\n        }\r\n    },\r\n    \"mappings\": {\r\n    \"doc\" : {\r\n      \"properties\": {\r\n        \"body\" : {\r\n          \"type\": \"text\",\r\n          \"term_vector\" : \"with_positions_offsets\" \r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Index a document that has a phrase you want to highlight (Note the \"sugary treat cake\" in the middle of the somethings)\r\n\r\n```\r\nPUT highlighttest/doc/1\r\n{\r\n    \"body\": \"cake cake cake cake cake something something something something something something something something something something something something something something something something something something something something something something something something something something something something something something something sugary treat cake something something something something something something something something something something something something something something something something something something something something something something cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake cake\"\r\n}\r\n```\r\n 3. Query the index with multiple phrase matches and a non-phrase match, the first match phrase having a high boost factor, while the last one having a low. (Note: the slop is irrelevant for this query, but it demonstrates a reason why one would want multiple match phrases with different boost factors)\r\n\r\n```\r\nGET highlighttest/doc/_search\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"should\" :[\r\n                {\r\n                    \"match\": {\r\n                        \"body\":{\r\n                            \"query\":\"sugary treat cake\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"highlight\": {\r\n        \"order\" : \"score\",\r\n        \"fields\": {\r\n            \"body\":{\r\n                \"fragment_size\": 18,\r\n                \"number_of_fragments\": 1,\r\n                \"highlight_query\": {\r\n                    \"bool\": {\r\n                        \"should\" :[\r\n                        {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"query\":\"sugary treat cake\"\r\n                                }\r\n                            }\r\n                        },\r\n                        {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"type\": \"phrase\",\r\n                                    \"query\":\"sugary treat cake\",\r\n                                    \"boost\":1000\r\n                                }\r\n                            }\r\n                        },\r\n                       {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"type\": \"phrase\",\r\n                                    \"query\":\"sugary treat cake\",\r\n                                    \"boost\":0.01,\r\n                                    \"slop\":1\r\n                                }\r\n                            }\r\n                        }\r\n                    ]\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\nThe result is \r\n```\r\n\"highlight\": {\r\n               \"body\": [\r\n                  \"<em>cake</em> <em>cake</em> <em>cake</em> cake\"\r\n               ]\r\n            }\r\n```\r\nMeaning that the very high (1000) boost factor was ignored.\r\n \r\n 4. Now do the same query, but put the highest boost factor last and the lowest first\r\n```\r\nGET highlighttest/doc/_search\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"should\" :[\r\n                {\r\n                    \"match\": {\r\n                        \"body\":{\r\n                            \"query\":\"sugary treat cake\"\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"highlight\": {\r\n        \"order\" : \"score\",\r\n        \"fields\": {\r\n            \"body\":{\r\n                \"fragment_size\": 18,\r\n                \"number_of_fragments\": 1,\r\n                \"highlight_query\": {\r\n                    \"bool\": {\r\n                        \"should\" :[\r\n                        {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"query\":\"sugary treat cake\"\r\n                                }\r\n                            }\r\n                        },\r\n                        {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"type\": \"phrase\",\r\n                                    \"query\":\"sugary treat cake\",\r\n                                    \"boost\":0.01,\r\n                                    \"slop\":1\r\n                                }\r\n                            }\r\n                        },\r\n                        {\r\n                            \"match\": {\r\n                                \"body\":{\r\n                                    \"type\": \"phrase\",\r\n                                    \"query\":\"sugary treat cake\",\r\n                                    \"boost\":1000\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                    ]\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\nNow the result is\r\n```\r\n \"highlight\": {\r\n               \"body\": [\r\n                  \"<em>sugary treat cake</em> something\"\r\n               ]\r\n }\r\n```\r\nWhich shows that this time, the big boost factor was taken into consideration, because it was last.\r\n\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}