{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4248","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4248/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4248/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4248/events","html_url":"https://github.com/elastic/elasticsearch/issues/4248","id":23254011,"node_id":"MDU6SXNzdWUyMzI1NDAxMQ==","number":4248,"title":"Possible improvement for orderly shutdown","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2013-11-25T16:31:42Z","updated_at":"2014-11-28T09:50:20Z","closed_at":"2014-11-28T09:50:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Last week I spent a few hours manually restarting nodes to upgrade to 0.90.7.  Since we want to keep our configured level of redundancy at all non-emergency times I did it by using the shard allocation api to disallow shard from the node being shutdown, waiting until there were no indexes on the node, restarting it, then using the shard allocation api to allow shards back on the node, then waiting for the cluster to re-balance shards.\n\nI wonder if this process could be automated beyond the bash/curl/awk mess that I've been using and if that might let the re-balance operation proceed more quickly.  Would it be possible to:\n1.  Ask the cluster to prepare a node for shutdown.\n2.  The cluster will not allocate replicas to that node until it has finished shutting down.\n2.  The cluster allocates an extra copy of all replicas that that node is hosting.\n3.  Once this is done the node goes through the normal shutdown process.\n4.  When the node comes back up it should rejoin the cluster and announce that replicas that it sill holds.  At this point I think you can let the standard startup and re-balance logic take hold.  The replicas that didn't change will stay on the restarted node and be removed from the node to which they were recently replicated.  Those that did change will be removed from the restarted node and cluster re-balancing will balance the shards again.\n\nI think this strikes a nice balance between the exclude._ip way of shutting down and the disable_allocation way of shutting down.\n\nAt some point it'd be nice if there were some kind of log that could be replayed against out of date replicas so they could recover even if changes had been made.  I wonder if something could be synthesized from the _timestamp field....\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}