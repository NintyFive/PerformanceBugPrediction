{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46127","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46127/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46127/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46127/events","html_url":"https://github.com/elastic/elasticsearch/issues/46127","id":486928148,"node_id":"MDU6SXNzdWU0ODY5MjgxNDg=","number":46127,"title":"Missing right to write transient cluster settings in custom plugin","user":{"login":"olfuerniss","id":30932609,"node_id":"MDQ6VXNlcjMwOTMyNjA5","avatar_url":"https://avatars1.githubusercontent.com/u/30932609?v=4","gravatar_id":"","url":"https://api.github.com/users/olfuerniss","html_url":"https://github.com/olfuerniss","followers_url":"https://api.github.com/users/olfuerniss/followers","following_url":"https://api.github.com/users/olfuerniss/following{/other_user}","gists_url":"https://api.github.com/users/olfuerniss/gists{/gist_id}","starred_url":"https://api.github.com/users/olfuerniss/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olfuerniss/subscriptions","organizations_url":"https://api.github.com/users/olfuerniss/orgs","repos_url":"https://api.github.com/users/olfuerniss/repos","events_url":"https://api.github.com/users/olfuerniss/events{/privacy}","received_events_url":"https://api.github.com/users/olfuerniss/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-08-29T12:29:01Z","updated_at":"2019-10-07T06:51:59Z","closed_at":"2019-10-07T06:51:59Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the feature**:\r\n\r\nI'm using ES Version 7.3.1. When I try to write transient cluster settings - in my custom plugin - it throws an exception that the ```[_system]``` user does not have the ```[cluster:admin/settings/update]``` right. \r\n\r\nAt the moment I'm patching the Java class ```org.elasticsearch.xpack.core.security.authz.privilege.SystemPrivilege.class``` found in the ```x-pack-core-7.3.1.jar``` by adding ```\"cluster:admin/settings/*\",``` to the ```ALLOWED_ACTIONS``` list. Doing this with every ES release is rather annoying. It would be great if you could add the missing right like you already have done with issue #33119 . Thanks!\r\n\r\nExample code to write transient settings:\r\n```\r\nClusterUpdateSettingsRequest settingsUpdateRequest = new ClusterUpdateSettingsRequest();\r\nsettingsUpdateRequest.transientSettings(s);\r\n\r\nClusterUpdateSettingsResponse clusterUpdateSettingsResponse = clientProvider.get().admin().cluster().updateSettings(settingsUpdateRequest).get();\r\nif (clusterUpdateSettingsResponse.isAcknowledged()) {\r\n    LOG.debug(\"Transient cluster setting '\" + structuredSettingName + \"' set to '\" + value + \"'\");\r\n} else {\r\n    LOG.debug(\"Failed to set the transient setting '\" + structuredSettingName + \"' to '\" + value + \"'\");\r\n}\r\n```\r\n\r\nIt will throw the following exception:\r\n```\r\n[2019-08-29T13:57:47,790][ERROR][d.v.b.e.p.BpcConnections ] [node-of-1][es-bpc-plugin] Failed to write the transient cluster setting 'connections'.\r\njava.util.concurrent.ExecutionException: ElasticsearchSecurityException[action [cluster:admin/settings/update] is unauthorized for user [_system]]\r\n\tat org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:266) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:253) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n...\r\n```\r\n\r\nUpdated/patched SystemPrivilege.java (ES 7.3.1)\r\n```\r\n/*\r\n * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\r\n * or more contributor license agreements. Licensed under the Elastic License;\r\n * you may not use this file except in compliance with the Elastic License.\r\n */\r\npackage org.elasticsearch.xpack.core.security.authz.privilege;\r\n\r\nimport org.elasticsearch.index.seqno.RetentionLeaseActions;\r\nimport org.elasticsearch.index.seqno.RetentionLeaseBackgroundSyncAction;\r\nimport org.elasticsearch.index.seqno.RetentionLeaseSyncAction;\r\nimport org.elasticsearch.transport.TransportActionProxy;\r\nimport org.elasticsearch.xpack.core.security.support.Automatons;\r\n\r\nimport java.util.Collections;\r\nimport java.util.function.Predicate;\r\n\r\npublic final class SystemPrivilege extends Privilege {\r\n\r\n    public static SystemPrivilege INSTANCE = new SystemPrivilege();\r\n\r\n    private static final Predicate<String> ALLOWED_ACTIONS = Automatons.predicate(\r\n        \"internal:*\",\r\n        \"cluster:admin/settings/*\",\r\n        \"indices:monitor/*\", // added for monitoring\r\n        \"cluster:monitor/*\",  // added for monitoring\r\n        \"cluster:admin/bootstrap/*\", // for the bootstrap service\r\n        \"cluster:admin/reroute\", // added for DiskThresholdDecider.DiskListener\r\n        \"indices:admin/mapping/put\", // needed for recovery and shrink api\r\n        \"indices:admin/template/put\", // needed for the TemplateUpgradeService\r\n        \"indices:admin/template/delete\", // needed for the TemplateUpgradeService\r\n        \"indices:admin/seq_no/global_checkpoint_sync*\", // needed for global checkpoint syncs\r\n        RetentionLeaseSyncAction.ACTION_NAME + \"*\", // needed for retention lease syncs\r\n        RetentionLeaseBackgroundSyncAction.ACTION_NAME + \"*\", // needed for background retention lease syncs\r\n        RetentionLeaseActions.Add.ACTION_NAME + \"*\", // needed for CCR to add retention leases\r\n        RetentionLeaseActions.Remove.ACTION_NAME + \"*\", // needed for CCR to remove retention leases\r\n        RetentionLeaseActions.Renew.ACTION_NAME + \"*\", // needed for CCR to renew retention leases\r\n        \"indices:admin/settings/update\" // needed for DiskThresholdMonitor.markIndicesReadOnly\r\n    );\r\n\r\n    private static final Predicate<String> PREDICATE = (action) -> {\r\n        // Only allow a proxy action if the underlying action is allowed\r\n        if (TransportActionProxy.isProxyAction(action)) {\r\n            return ALLOWED_ACTIONS.test(TransportActionProxy.unwrapAction(action));\r\n        } else {\r\n            return ALLOWED_ACTIONS.test(action);\r\n        }\r\n    };\r\n\r\n    private SystemPrivilege() {\r\n        super(Collections.singleton(\"internal\"));\r\n    }\r\n\r\n    @Override\r\n    public Predicate<String> predicate() {\r\n        return PREDICATE;\r\n    }\r\n}\r\n```","closed_by":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"performed_via_github_app":null}