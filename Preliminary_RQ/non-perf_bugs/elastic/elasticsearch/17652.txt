{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17652","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17652/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17652/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17652/events","html_url":"https://github.com/elastic/elasticsearch/issues/17652","id":147441638,"node_id":"MDU6SXNzdWUxNDc0NDE2Mzg=","number":17652,"title":"sub aggregations can overwrite bucket fields","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":33660,"node_id":"MDU6TGFiZWwzMzY2MA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebreaking","name":">breaking","color":"d93f0b","default":false,"description":null},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":127075273,"node_id":"MDU6TGFiZWwxMjcwNzUyNzM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/PITA","name":"PITA","color":"e11d21","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-04-11T14:08:19Z","updated_at":"2020-08-19T16:09:28Z","closed_at":"2020-08-19T16:09:18Z","author_association":"MEMBER","active_lock_reason":null,"body":"Consider the following sense script:\n\n```\nGET test/_search\n{\n  \"aggs\": {\n    \"terms\": {\n      \"terms\": {\n        \"field\": \"i\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"key\": {\n          \"max\": {\n            \"field\": \"i\"\n          }\n        },\n        \"doc_count\": {\n          \"bucket_script\": {\n            \"buckets_path\": \"_count\",\n            \"script\": {\n              \"inline\": \"_value\",\n              \"lang\": \"expression\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe sub aggregations to the terms aggregation are named `key` and `doc_count`. In the response these sub-aggregations overwrite the `key` and `doc_count` fields of the bucket (for comparison the normal response without any sub aggregations is at the bottom of this bug report):\n\n```\n{\n  ...\n  \"aggregations\": {\n    \"terms\": {\n      \"doc_count_error_upper_bound\": 0,\n      \"sum_other_doc_count\": 0,\n      \"buckets\": [\n        {\n          \"key\": {\n            \"value\": 2\n          },\n          \"doc_count\": {\n            \"value\": 1\n          }\n        }\n      ]\n    }\n  }\n```\n\nSub aggregations should not be able to overwrite fields in the bucket. Note that this affects all bucket aggregations and other bucket aggregations use other fields. More generally a bucket aggregation has (and should have) no restrictions on the fields it can use in each bucket response.\n\nWe should not fix this by not allowing aggregations to be named `doc_count` or `key`, etc.  That would be a hacky fix that would be hard to maintain (if a bucket aggregation defines a new field in the bucket we would have to remember to add it to the exceptions which is easily missed).\n\nI think we should solve this by name-spacing the sub aggregations under an `aggregations` object in the bucket. This would make the output safer (and avoid this bug), and would match the request format better (where sub aggregations are nested under an `aggs`/`aggregations` object). This would obviously be a breaking change but I think it is an important change to make. If we implement https://github.com/elastic/elasticsearch/issues/11184 we could effectively deprecate the old response format by having it output the new format by default but output the old format if the version parameter is specified on the request (with a version number relevant for the old format). Then we could remove the old format in the next major version.\n\nResponse with no sub-aggregations:\n\n```\n{\n  ...\n  \"aggregations\": {\n    \"terms\": {\n      \"doc_count_error_upper_bound\": 0,\n      \"sum_other_doc_count\": 0,\n      \"buckets\": [\n        {\n          \"key\": 2,\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n}\n```\n","closed_by":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"performed_via_github_app":null}