{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19038","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19038/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19038/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19038/events","html_url":"https://github.com/elastic/elasticsearch/issues/19038","id":161876531,"node_id":"MDU6SXNzdWUxNjE4NzY1MzE=","number":19038,"title":"Incorrect 'key_as_string' response in date_histogram when using 'epoch_millis'  and 'time_zone'","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":342561351,"node_id":"MDU6TGFiZWwzNDI1NjEzNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.4.0","name":"v2.4.0","color":"dddddd","default":false,"description":null},{"id":396750536,"node_id":"MDU6TGFiZWwzOTY3NTA1MzY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha5","name":"v5.0.0-alpha5","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2016-06-23T09:20:17Z","updated_at":"2016-06-30T11:27:35Z","closed_at":"2016-06-29T17:35:57Z","author_association":"MEMBER","active_lock_reason":null,"body":"When doing a `date_histogram` aggregation with `\"format\":\"epoch_millis\"`, the aggregation response key shows the correct value as UTC time stamp, but the `key_as_string` does not reflect that key if a `time_zone` other than UTC is used. Reproduced on 2.3 and master:\n\n```\nPUT /foo\n\nPUT /foo/_mapping/bar\n{\n  \"properties\":{\n    \"timestamp\":{\n      \"type\":\"date\",\n      \"format\":\"epoch_millis\"\n    }\n  }\n}\n\nPOST /foo/bar/1\n{\n  \"timestamp\": 1463875200000\n}\n\nPOST /foo/bar/_search\n{\n  \"aggs\": {\n    \"ts\": {\n      \"date_histogram\": {\n        \"field\": \"timestamp\",\n        \"interval\": \"month\",\n        \"time_zone\": \"+01:00\"\n      }\n    }\n  }\n}\n```\n\nThe aggregation in the response:\n\n```\n\"aggregations\": {\n    \"ts\": {\n      \"buckets\": [\n        {\n          \"key_as_string\": \"1462060800000\",\n          \"key\": 1462057200000,\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n```\n\nThe key correctly represents the date `2016-05-01T00:00:00.000+01:00`, the expectation would for `epoch_millis` format that the `key_as_string` is the same value.\nSame problem happens for `epoch_second` format. With other formats like `date_optional_time` or custom formats `key_as_string` changes correctly according to the keys value.\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}