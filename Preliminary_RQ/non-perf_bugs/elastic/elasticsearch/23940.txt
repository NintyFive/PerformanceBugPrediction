{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23940","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23940/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23940/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23940/events","html_url":"https://github.com/elastic/elasticsearch/issues/23940","id":219869260,"node_id":"MDU6SXNzdWUyMTk4NjkyNjA=","number":23940,"title":"Filter in bool-query unexpectedly sets the minimum_should_match to 0","user":{"login":"roelandvanbatenburg","id":78699,"node_id":"MDQ6VXNlcjc4Njk5","avatar_url":"https://avatars1.githubusercontent.com/u/78699?v=4","gravatar_id":"","url":"https://api.github.com/users/roelandvanbatenburg","html_url":"https://github.com/roelandvanbatenburg","followers_url":"https://api.github.com/users/roelandvanbatenburg/followers","following_url":"https://api.github.com/users/roelandvanbatenburg/following{/other_user}","gists_url":"https://api.github.com/users/roelandvanbatenburg/gists{/gist_id}","starred_url":"https://api.github.com/users/roelandvanbatenburg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roelandvanbatenburg/subscriptions","organizations_url":"https://api.github.com/users/roelandvanbatenburg/orgs","repos_url":"https://api.github.com/users/roelandvanbatenburg/repos","events_url":"https://api.github.com/users/roelandvanbatenburg/events{/privacy}","received_events_url":"https://api.github.com/users/roelandvanbatenburg/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-04-06T11:34:43Z","updated_at":"2017-04-06T15:18:14Z","closed_at":"2017-04-06T15:18:14Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.2.2\r\n\r\n**JVM version**: Oracle Corporation/OpenJDK 64-Bit Server VM/1.8.0_121/25.121-b13\r\n\r\n**OS version**: Linux/4.9.13-moby/amd64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThere is unexpected behaviour when combining should clauses with filter clauses in a bool query.\r\nThe following queries return different results as the second case is entirely in filter mode and thus defaults minimum_should_match to 1 and the first case is in query mode and uses minimum_should_match=0. This is partially documented in https://www.elastic.co/guide/en/elasticsearch/guide/current/bool-query.html#_controlling_precision\r\n\"By default, none of the should clauses are required to match, with one exception: if there are no must clauses, then at least one should clause must match.\". However, this does not mention the filter clause and this seems to behave the same as the must-clause, which is quite unexpected.\r\nI would expect that filter clause does not set the minimum_should_match to 0, similar to must_not clause.\r\n\r\n**Steps to reproduce**:\r\n 1. insert the brown fox data from https://www.elastic.co/guide/en/elasticsearch/guide/current/match-query.html\r\n 2.\r\nGET /my_index/my_type/_search\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": {\r\n        \"bool\": {\r\n          \"filter\": {\r\n            \"match\": {\r\n              \"title\": \"brown\"\r\n            }\r\n          },\r\n          \"should\": [{\r\n            \"match\": {\r\n              \"title\": \"jumps\"\r\n            }\r\n          }]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n-> hits.total: 4 (also matches results without jumps in the title)\r\n```\r\n 3.\r\nGET /my_index/my_type/_search\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"filter\": {\r\n            \"match\": {\r\n              \"title\": \"brown\"\r\n            }\r\n          },\r\n          \"should\": [{\r\n            \"match\": {\r\n              \"title\": \"jumps\"\r\n            }\r\n          }]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n-> hits.total: 2\r\n```","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}