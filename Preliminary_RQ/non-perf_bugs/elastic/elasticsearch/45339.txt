{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45339","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45339/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45339/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45339/events","html_url":"https://github.com/elastic/elasticsearch/issues/45339","id":478526792,"node_id":"MDU6SXNzdWU0Nzg1MjY3OTI=","number":45339,"title":"[DataFrame] batch dataframe transform fails to start after it stopped at runtime","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1442574459,"node_id":"MDU6TGFiZWwxNDQyNTc0NDU5","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.3.1","name":"v7.3.1","color":"dddddd","default":false,"description":""},{"id":1434538947,"node_id":"MDU6TGFiZWwxNDM0NTM4OTQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.4.0","name":"v7.4.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-08-08T15:01:46Z","updated_at":"2019-08-09T12:45:53Z","closed_at":"2019-08-09T12:45:53Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Repro:\r\n - create a batch data frame transform with sufficient amount of data\r\n - start it\r\n - stop it before it can finish, progress should be between 0 and 1\r\n - try to start it again\r\n\r\n-> fails with NPE, see stack trace below\r\n\r\nregression introduced in #44219\r\n\r\nThe issue also applies to continuous data frames, however only during the bootstrap phase until checkpoint 1 has been reached.\r\n\r\nstacktrace from 8.0, also applies to 7.3\r\n```\r\n[2019-08-08T14:45:39,802][INFO ][o.e.x.d.t.DataFrameTransformTask] [xyz] Updating state for data frame transform [fq1405] to [{\"task_state\":\"started\",\"indexer_state\":\"stopped\",\"position\":{\"indexer_position\":{\"@timestamp\":1549675260000,\"airline\":\"KLM\"}},\"checkpoint\":0,\"progress\":{\"total_docs\":86274,\"docs_remaining\":50410,\"percent_complete\":41.56988200384821}}]\r\n[2019-08-08T14:45:39,878][INFO ][o.e.x.d.t.DataFrameTransformPersistentTasksExecutor] [xyz] Successfully completed and scheduled task in node operation\r\n[2019-08-08T14:45:39,887][WARN ][o.e.x.d.t.DataFrameTransformTask] [xyzl] Data frame transform [fq1405] encountered an exception:\r\njava.lang.NullPointerException: null\r\nat org.elasticsearch.xpack.dataframe.transforms.DataFrameIndexer.determineRunStateAtStart(DataFrameIndexer.java:488) ~[data-frame-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n        at org.elasticsearch.xpack.dataframe.transforms.DataFrameIndexer.onStart(DataFrameIndexer.java:159) [data-frame-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n        at org.elasticsearch.xpack.dataframe.transforms.DataFrameTransformTask$ClientDataFrameIndexer.lambda$onStart$3(DataFrameTransformTask.java:633) [data-frame-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n        at org.elasticsearch.xpack.dataframe.transforms.DataFrameTransformTask$ClientDataFrameIndexer.onStart(DataFrameTransformTask.java:663) [data-frame-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n```","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}