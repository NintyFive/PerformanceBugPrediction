[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377183518","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377183518","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377183518,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzE4MzUxOA==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-03-29T09:48:49Z","updated_at":"2018-03-29T09:51:12Z","author_association":"CONTRIBUTOR","body":"The bug was fixed in forbiddenapis. Should come with version 2.6.\r\n\r\nBefore releasing that version, I'd like to put some more effort in silencing the warnings when parsing signatures where the classes are not on classpath.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377189760","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377189760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377189760,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzE4OTc2MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-29T10:13:12Z","updated_at":"2018-03-29T10:13:12Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377224952","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377224952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377224952,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzIyNDk1Mg==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-03-29T12:51:00Z","updated_at":"2018-03-29T12:54:00Z","author_association":"CONTRIBUTOR","body":"Hi @jasontedor, \r\nI figured out how to setup the Java9 sourceset correctly. It works with the actual setup (without forbiddenapis bug fix) only, because the only class that is compiled has no external dependencies and works with compiling against JDK9 runtime only. However, if you create a MR-JAR, the correct compilation setup is:\r\n\r\n- The code in Java9 has to be compiled *after* the main classes. The reason: The Java9 specific code may refer to other classes from the output of main sourceset. This can be done by adding a dependency to the main's sourceSet output. This is optional for the current case, as the `getPid` stuff is self-contained.\r\n- The Java9 sourceset must have the same compile classpath like the main source set, so it also gets the dependencies. This is important for forbiddenapis to work.\r\n\r\nI did this locally like this:\r\n\r\n```diff\r\ndiff --git a/buildSrc/build.gradle b/buildSrc/build.gradle\r\nindex 5256968..f6d5fc6 100644\r\n--- a/buildSrc/build.gradle\r\n+++ b/buildSrc/build.gradle\r\n@@ -94,7 +94,7 @@ dependencies {\r\n   compile 'com.netflix.nebula:gradle-info-plugin:3.0.3'\r\n   compile 'org.eclipse.jgit:org.eclipse.jgit:3.2.0.201312181205-r'\r\n   compile 'com.perforce:p4java:2012.3.551082' // THIS IS SUPPOSED TO BE OPTIONAL IN THE FUTURE....\r\n-  compile 'de.thetaphi:forbiddenapis:2.5'\r\n+  compile 'de.thetaphi:forbiddenapis:2.6-SNAPSHOT'\r\n   compile 'org.apache.rat:apache-rat:0.11'\r\n   compile \"org.elasticsearch:jna:4.5.1\"\r\n }\r\ndiff --git a/server/build.gradle b/server/build.gradle\r\nindex 7b30f57..3eea0cf 100644\r\n--- a/server/build.gradle\r\n+++ b/server/build.gradle\r\n@@ -43,13 +43,22 @@ if (!isEclipse && !isIdea) {\r\n       java {\r\n         srcDirs = ['src/main/java9']\r\n       }\r\n+      compileClasspath += sourceSets.main.compileClasspath\r\n     }\r\n   }\r\n+\r\n+  dependencies {\r\n+    java9Compile sourceSets.main.output\r\n+  }\r\n\r\n   compileJava9Java {\r\n     sourceCompatibility = 9\r\n     targetCompatibility = 9\r\n   }\r\n+\r\n+  forbiddenApisJava9 {\r\n+    targetCompatibility = 9\r\n+  }\r\n\r\n   jar {\r\n     into('META-INF/versions/9') {\r\n```\r\n\r\nThis makes the build work - as said before the extra dependency to main's output is optional, but may be required soon:\r\n\r\n```\r\n> Task :server:java9Classes\r\nSkipping task ':server:java9Classes' as it has no actions.\r\n\r\n:server:java9Classes (Thread[Task worker for ':' Thread 3,5,main]) completed. Took 0.0 secs.\r\n:server:forbiddenApisJava9 (Thread[Task worker for ':' Thread 3,5,main]) started.\r\n\r\n> Task :server:forbiddenApisJava9\r\nTask ':server:forbiddenApisJava9' is not up-to-date because:\r\n  Input property 'classpath' file C:\\Users\\Uwe Schindler\\Projects\\lucene\\es\\elasticsearch\\server\\cli\\build\\distributions\\elasticsearch-cli-7.0.0-alpha1-SNAPSHOT.jar has changed.\r\nReading bundled API signatures: jdk-unsafe-9\r\nReading bundled API signatures: jdk-deprecated-9\r\nReading bundled API signatures: jdk-non-portable\r\nReading bundled API signatures: jdk-system-out\r\nReading API signatures: jar:file:/C:/Users/Uwe%20Schindler/.gradle/caches/jars-3/f2f51995af2698f84880e96f412cac8d/buildSrc-7.0.0-alpha1-SNAPSHOT.jar!/forbidden/jdk-signatures.txt\r\nReading API signatures: jar:file:/C:/Users/Uwe%20Schindler/.gradle/caches/jars-3/f2f51995af2698f84880e96f412cac8d/buildSrc-7.0.0-alpha1-SNAPSHOT.jar!/forbidden/es-all-signatures.txt\r\nLoading classes to check...\r\nScanning classes for violations...\r\nScanned 1 class file(s) for forbidden API invocations (in 0.26s), 0 error(s).\r\n\r\n:server:forbiddenApisJava9 (Thread[Task worker for ':' Thread 3,5,main]) completed. Took 0.618 secs.\r\n:server:forbiddenApisMain (Thread[Task worker for ':' Thread 3,5,main]) started.\r\n\r\n> Task :server:forbiddenApisMain\r\nTask ':server:forbiddenApisMain' is not up-to-date because:\r\n  Input property 'classpath' file C:\\Users\\Uwe Schindler\\Projects\\lucene\\es\\elasticsearch\\server\\cli\\build\\distributions\\elasticsearch-cli-7.0.0-alpha1-SNAPSHOT.jar has changed.\r\nReading bundled API signatures: jdk-unsafe-1.8\r\nReading bundled API signatures: jdk-deprecated-1.8\r\nReading bundled API signatures: jdk-non-portable\r\nReading bundled API signatures: jdk-system-out\r\nReading API signatures: jar:file:/C:/Users/Uwe%20Schindler/.gradle/caches/jars-3/f2f51995af2698f84880e96f412cac8d/buildSrc-7.0.0-alpha1-SNAPSHOT.jar!/forbidden/jdk-signatures.txt\r\nReading API signatures: jar:file:/C:/Users/Uwe%20Schindler/.gradle/caches/jars-3/f2f51995af2698f84880e96f412cac8d/buildSrc-7.0.0-alpha1-SNAPSHOT.jar!/forbidden/es-all-signatures.txt\r\nReading API signatures: jar:file:/C:/Users/Uwe%20Schindler/.gradle/caches/jars-3/f2f51995af2698f84880e96f412cac8d/buildSrc-7.0.0-alpha1-SNAPSHOT.jar!/forbidden/es-server-signatures.txt\r\nLoading classes to check...\r\nScanning classes for violations...\r\nScanned 5538 class file(s) for forbidden API invocations (in 8.47s), 0 error(s).\r\n\r\n:server:forbiddenApisMain (Thread[Task worker for ':' Thread 3,5,main]) completed. Took 9.193 secs.\r\n```\r\n\r\nAs you see, it also scans the Java 9 classes with correct bundled signatures.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377294222","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377294222","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377294222,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzI5NDIyMg==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-03-29T16:33:12Z","updated_at":"2018-03-29T16:34:17Z","author_association":"CONTRIBUTOR","body":"I improved the Java9 config a bit more. Now its expressed without hacks using configurations and inheritance:\r\n\r\n```gradle\r\n// we want to keep the JDKs in our IDEs set to JDK 8 until minimum JDK is bumped to 9 so we do not include this source set in our IDEs\r\nif (!isEclipse && !isIdea) {\r\n  sourceSets {\r\n    java9 {\r\n      java {\r\n        srcDirs = ['src/main/java9']\r\n      }\r\n    }\r\n  }\r\n  \r\n  configurations {\r\n    java9Compile.extendsFrom(compile)\r\n  }\r\n  \r\n  dependencies {\r\n    java9Compile sourceSets.main.output\r\n  }\r\n\r\n  compileJava9Java {\r\n    sourceCompatibility = 9\r\n    targetCompatibility = 9\r\n  }\r\n  \r\n  forbiddenApisJava9 {\r\n    targetCompatibility = 9\r\n  }\r\n\r\n  jar {\r\n    metaInf {\r\n      into 'versions/9'\r\n      from sourceSets.java9.output\r\n    }\r\n    manifest.attributes('Multi-Release': 'true')\r\n  }\r\n}\r\n```\r\n\r\nThis changes:\r\n- each `sourceSet` by default defines a configuration. To not add all dependencies a second time or use a compileClassPath hack, we just make this new configuration extend the `compile` configuration.\r\n- we also add the main's output as dependency (this is still optional, but should be done to be future-proof and to mimic what MR-JARs are doing)\r\n- I also used the JAR tasks `metaInf` config closure, so we don't need to hardcode the path name. This is the recommended way to add stuff to META-INF in Gradle. I found another place (`BuildPlugin`) where the licenses are added, should look the same (@rjernst).\r\n\r\nI think this can already applied to the Java 9 build, just the `forbiddenApisJava9` part commented out, until the bug is fixed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377393626","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377393626","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377393626,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzM5MzYyNg==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-03-29T22:37:07Z","updated_at":"2018-03-29T22:37:07Z","author_association":"CONTRIBUTOR","body":"Hi: Here is the diff of my whole work for correctly setting up the Java9 source sets. It also fixes the issues with the delayed project evaluation that @jasontedor  tried to fix after the builds failed. This now uses projects.tasks.withType() to fix this completely and does not rely on task names.\r\n\r\nhttps://github.com/elastic/elasticsearch/compare/master...uschindler:issues/29292\r\n\r\nI can create a PR that does not yet contain the forbiddenapis update if you want to apply it for fixing the bugs in the Java 9 setup.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377423987","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377423987","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377423987,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzQyMzk4Nw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-03-30T01:59:00Z","updated_at":"2018-03-30T01:59:00Z","author_association":"MEMBER","body":"Please do @uschindler.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377479527","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-377479527","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":377479527,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzQ3OTUyNw==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-03-30T08:43:09Z","updated_at":"2018-03-30T08:43:09Z","author_association":"CONTRIBUTOR","body":"Here is the PR: #29312","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/382272263","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-382272263","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":382272263,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MjI3MjI2Mw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-04-18T06:02:56Z","updated_at":"2018-04-18T06:02:56Z","author_association":"MEMBER","body":"Fixed by #29312","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/382307904","html_url":"https://github.com/elastic/elasticsearch/issues/29292#issuecomment-382307904","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29292","id":382307904,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MjMwNzkwNA==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-04-18T08:29:57Z","updated_at":"2018-04-18T08:29:57Z","author_association":"CONTRIBUTOR","body":"Hi, thanks @rjernst! I had unfortunately no time to release a new forbiddenapis version, but once this is done, I will send another PR - including adding the commented out config option.","performed_via_github_app":null}]