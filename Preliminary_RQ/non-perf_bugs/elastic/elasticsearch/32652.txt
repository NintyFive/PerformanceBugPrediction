{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32652","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32652/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32652/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32652/events","html_url":"https://github.com/elastic/elasticsearch/issues/32652","id":348052047,"node_id":"MDU6SXNzdWUzNDgwNTIwNDc=","number":32652,"title":"Term vectors API crashes for documents that have no term vectors in nested fields","user":{"login":"rafaelglater","id":7691111,"node_id":"MDQ6VXNlcjc2OTExMTE=","avatar_url":"https://avatars3.githubusercontent.com/u/7691111?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelglater","html_url":"https://github.com/rafaelglater","followers_url":"https://api.github.com/users/rafaelglater/followers","following_url":"https://api.github.com/users/rafaelglater/following{/other_user}","gists_url":"https://api.github.com/users/rafaelglater/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelglater/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelglater/subscriptions","organizations_url":"https://api.github.com/users/rafaelglater/orgs","repos_url":"https://api.github.com/users/rafaelglater/repos","events_url":"https://api.github.com/users/rafaelglater/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelglater/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"assignees":[{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-08-06T19:26:50Z","updated_at":"2018-08-24T20:43:46Z","closed_at":"2018-08-24T20:43:46Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 6.3.2\r\n\r\n**JVM version**: 1.8.0_181\r\n\r\n**OS version**: KDE Neon 5.13.4\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen requesting the termvectors of a document with empty terms in a nested field, we get a null pointer exception.\r\n\r\n**Steps to reproduce**:\r\n1.\r\n`PUT /my-index\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1, \r\n    \"similarity\": {\r\n      \"default\": {\r\n        \"type\": \"BM25\"\r\n      }\r\n    },\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"bigram_filter\": {\r\n          \"type\": \"shingle\",\r\n          \"min_shingle_size\": 2,\r\n          \"max_shingle_size\": 2,\r\n          \"output_unigrams\": false\r\n        },\r\n        \"stopwords\": {\r\n          \"type\": \"stop\",\r\n          \"stopwords\": \"_english_\"\r\n        },\r\n        \"kstemmer\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"kstem\"\r\n        },\r\n        \"possessive\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"possessive_english\"\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"bigram_analyzer\": {\r\n          \"type\": \"custom\",\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"lowercase\",\r\n            \"stopwords\",\r\n            \"possessive\",\r\n            \"kstemmer\",\r\n            \"bigram_filter\"\r\n          ]\r\n        },\r\n        \"standard\": {\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"lowercase\",\r\n            \"stopwords\",\r\n            \"possessive\",\r\n            \"kstemmer\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}`\r\n\r\n2.\r\n`PUT /my-index/_mapping/my_doc\r\n{\r\n  \"my_doc\": {\r\n    \"properties\": {\r\n      \"text\": {\"type\":\"text\", \"analyzer\":\"standard\",\r\n               \"term_vector\": \"yes\",\r\n               \"fields\": {\r\n                  \"bigrams\": {\r\n                    \"type\":     \"text\",\r\n                    \"term_vector\": \"yes\",\r\n                    \"analyzer\": \"bigram_analyzer\"\r\n                  }\r\n               }\r\n      },\r\n      \"links\": {\"type\":\"nested\", \r\n                \"properties\":{\r\n                  \"page_id\": {\"type\":\"text\", \"analyzer\":\"standard\"},\r\n                  \"page_name\": {\"type\":\"text\", \"analyzer\":\"standard\",\r\n                    \"fields\": {\r\n                      \"bigrams\": {\r\n                        \"type\":     \"text\",\r\n                        \"analyzer\": \"bigram_analyzer\"\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n      }\r\n    }\r\n  }\r\n}`\r\n\r\n3.\r\nInsert documents with different terms configurations:\r\n\r\n`PUT /my-index/my_doc/111\r\n{\r\n  \"text\": \"a bigram text\",\r\n  \"links\": [{\"page_id\": \"1\", \"page_name\":\"two terms\"},\r\n  {\"page_id\": \"2\", \"page_name\":\"unique\"}\r\n  ]\r\n}`\r\n\r\n`PUT /my-index/my_doc/222\r\n{\r\n  \"text\": \"unigram\",\r\n  \"links\": [{\"page_id\": \"3\", \"page_name\":\"one\"},\r\n  {\"page_id\": \"2\", \"page_name\":\"unique\"}\r\n  ]\r\n}`\r\n\r\n`PUT /my-index/my_doc/333\r\n{\r\n  \"text\": \"\",\r\n  \"links\": [{\"page_id\": \"4\", \"page_name\":\"\"}]\r\n}`\r\n\r\n`PUT /my-index/my_doc/444\r\n{\r\n  \"text\": \"\",\r\n  \"links\": [{\"page_id\": \"4\", \"page_name\":\"\"},\r\n  {\"page_id\": \"2\", \"page_name\":\"unique\"}\r\n  ]\r\n}`\r\n\r\n4.\r\nIf I request the termvectors of documents 111 and 222 it's ok. But when requesting termvectors of document 333 and 444, I get null pointer exception because I have an empty nested field \"page_name\":\r\n\r\n`GET /my-index/my_doc/444/_termvectors\r\n{\r\n  \"fields\" : [\"text\", \"text.bigrams\", \"links.page_name\", \"links.page_name.bigrams\"],\r\n  \"offsets\" : false,\r\n  \"payloads\" : false,\r\n  \"positions\" : false,\r\n  \"term_statistics\" : true,\r\n  \"field_statistics\" : true\r\n}`\r\n\r\n**Provide logs (if relevant)**:\r\n[2018-08-06T16:04:28,002][DEBUG][o.e.a.t.TransportTermVectorsAction] [T3sBXHE] null: failed to execute [org.elasticsearch.action.termvectors.TermVectorsRequest@307d2b7b]\r\norg.elasticsearch.transport.RemoteTransportException: [T3sBXHE][127.0.0.1:9300][indices:data/read/tv[s]]\r\nCaused by: org.elasticsearch.ElasticsearchException: failed to execute term vector request\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:150) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:77) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:89) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:43) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:287) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:280) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:259) [x-pack-security-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:317) [x-pack-security-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:664) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_181]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_181]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\nCaused by: java.lang.NullPointerException\r\n        at org.elasticsearch.action.termvectors.TermVectorsWriter.setFields(TermVectorsWriter.java:82) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TermVectorsResponse.setFields(TermVectorsResponse.java:361) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:146) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:77) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:89) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:43) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:287) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:280) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:259) ~[?:?]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:317) ~[?:?]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:664) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_181]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_181]\r\n        at java.lang.Thread.run(Thread.java:748) ~[?:1.8.0_181]\r\n[2018-08-06T16:04:28,008][WARN ][r.suppressed             ] path: /my-index/my_doc/444/_termvectors, params: {index=my-index, id=444, type=my_doc}\r\norg.elasticsearch.transport.RemoteTransportException: [T3sBXHE][127.0.0.1:9300][indices:data/read/tv[s]]\r\nCaused by: org.elasticsearch.ElasticsearchException: failed to execute term vector request\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:150) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:77) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:89) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:43) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:287) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:280) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:259) [x-pack-security-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:317) [x-pack-security-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:664) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.2.jar:6.3.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_181]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_181]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\nCaused by: java.lang.NullPointerException\r\n        at org.elasticsearch.action.termvectors.TermVectorsWriter.setFields(TermVectorsWriter.java:82) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TermVectorsResponse.setFields(TermVectorsResponse.java:361) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:146) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.index.termvectors.TermVectorsService.getTermVectors(TermVectorsService.java:77) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:89) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.termvectors.TransportTermVectorsAction.shardOperation(TransportTermVectorsAction.java:43) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:287) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:280) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:259) ~[?:?]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:317) ~[?:?]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:664) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_181]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_181]\r\n        at java.lang.Thread.run(Thread.java:748) ~[?:1.8.0_181]\r\n","closed_by":{"login":"rafaelglater","id":7691111,"node_id":"MDQ6VXNlcjc2OTExMTE=","avatar_url":"https://avatars3.githubusercontent.com/u/7691111?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelglater","html_url":"https://github.com/rafaelglater","followers_url":"https://api.github.com/users/rafaelglater/followers","following_url":"https://api.github.com/users/rafaelglater/following{/other_user}","gists_url":"https://api.github.com/users/rafaelglater/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelglater/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelglater/subscriptions","organizations_url":"https://api.github.com/users/rafaelglater/orgs","repos_url":"https://api.github.com/users/rafaelglater/repos","events_url":"https://api.github.com/users/rafaelglater/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelglater/received_events","type":"User","site_admin":false},"performed_via_github_app":null}