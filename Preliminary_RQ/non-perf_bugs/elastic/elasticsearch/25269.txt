{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25269","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25269/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25269/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25269/events","html_url":"https://github.com/elastic/elasticsearch/issues/25269","id":236436286,"node_id":"MDU6SXNzdWUyMzY0MzYyODY=","number":25269,"title":"intermittent MD5 checksum failures when snapshotting using repository-s3","user":{"login":"joachimdraeger","id":17912690,"node_id":"MDQ6VXNlcjE3OTEyNjkw","avatar_url":"https://avatars2.githubusercontent.com/u/17912690?v=4","gravatar_id":"","url":"https://api.github.com/users/joachimdraeger","html_url":"https://github.com/joachimdraeger","followers_url":"https://api.github.com/users/joachimdraeger/followers","following_url":"https://api.github.com/users/joachimdraeger/following{/other_user}","gists_url":"https://api.github.com/users/joachimdraeger/gists{/gist_id}","starred_url":"https://api.github.com/users/joachimdraeger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joachimdraeger/subscriptions","organizations_url":"https://api.github.com/users/joachimdraeger/orgs","repos_url":"https://api.github.com/users/joachimdraeger/repos","events_url":"https://api.github.com/users/joachimdraeger/events{/privacy}","received_events_url":"https://api.github.com/users/joachimdraeger/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-06-16T09:56:52Z","updated_at":"2018-02-14T13:55:58Z","closed_at":"2017-06-21T19:41:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 5.4.0, master\r\n\r\n**Plugins installed**: repository-s3\r\n\r\n**JVM version**: 1.8.0_131-b11\r\n\r\n**OS version**: Darwin Kernel Version 15.4.0: Fri Feb 26 22:08:05 PST 2016; root:xnu-3248.40.184~3/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe are performing hourly snapshots of 10 daily indices. Every day there are 2 to 5 failures on either snapshot or delete snapshot caused by an Exception like this:\r\n`AmazonS3Exception: MD5 local [882AktFOIjwJNFwKqtfj+Q==], remote [LMtTgWbPjpF+Ia25VQtfwg==] are not equal...`\r\nWe have never experienced such issues on 2.4.5 and S3 uploads using the AWS library should be quite reliable.\r\n\r\n**Analysis:**\r\n`AmazonHttpClient` uses `mark`/`reset` on the InputStream to retry failed uploads.\r\nThe checksum used by the `repository-s3` code is calculated in `DefaultS3OutputStream.doUpload()` using a `java.security.DigestInputStream` which apparently does not support `mark`/`reset`.\r\nWhen `AmazonHttpClient` retries after some bytes have already been streamed through the Digest, the checksum will be corrupted.\r\n\r\nThe checksum calculation in the `repository-s3` code is redundant because AWS' `AmazonS3Client. putObject()` does already calculate and compare a checksum locally and on server side. AWS' implementation `MD5DigestCalculatingInputStream` does support `mark`/`reset` on retries.\r\n\r\nThe checksum calculation in the `repository-s3` code does also contain another bug: It compares `putObjectResult.getContentMd5()` with its local checksum which is indeed the local checksum calculated by the S3 client. The remotely calculated MD5 is stored in the ETag property.\r\n\r\nThe solution is to remove the faulty MD5 code from `repository-s3` because the S3 client already takes care for checksum comparison which is retry safe. \r\n\r\n**Steps to reproduce**:\r\n\r\nThe error will occur in production eventually depending on how stable your network connection to S3 is. \r\n\r\nIn a test environment the error will occur eventually when creating snapshots in a loop.\r\n\r\nThere is a way to exhibit the behavior using a debugger : \r\n\r\n 1. Enable remote debugging on a local ES installation\r\n 2. Create an index\r\n 3. Register S3 repository\r\n 4. Put a break-point into the InputStream chain after the `java.security.DigestInputStream`  on the return statement of a `public int read(byte[] b, int off, int len)` method, e.g. in `MD5DigestCalculatingInputStream` line 102 (for master).\r\n5. perform a snapshot\r\n6. When the breakpoint got hit, the `DigestInputStream` already updated its hash. Disable your network connection and continue the program.\r\n7. The next time the breakpoint gets hit, the S3 client is retrying. Enable network connection and continue the program.\r\n8. Observe the Exception in the logs.\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2017-06-09T16:50:02,172][INFO ][o.e.s.SnapshotShardsService] [xrZgqIf] snapshot [elasticsearch-local:20170609t1525-140/4UI1XpYuRhutCG82cfUThA] is done\r\n[2017-06-09T16:50:13,913][WARN ][o.e.s.SnapshotShardsService] [xrZgqIf] [[index4][3]] [elasticsearch-local:20170609t1525-141/SYTtvRUGSiyEBtsMmBvWMw] failed to create snapshot\r\norg.elasticsearch.index.snapshots.IndexShardSnapshotFailedException: Failed to write commit point\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1231) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:815) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:380) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:88) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:334) [elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\nCaused by: java.io.IOException: Unable to upload object elasticsearch/local600/indices/5v3fWPPXQdiTuLkWoXgs1Q/3/snap-SYTtvRUGSiyEBtsMmBvWMw.dat\r\n\tat org.elasticsearch.repositories.s3.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:112) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.DefaultS3OutputStream.flush(DefaultS3OutputStream.java:99) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3OutputStream.flushBuffer(S3OutputStream.java:69) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3OutputStream.close(S3OutputStream.java:87) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobContainer.lambda$writeBlob$2(S3BlobContainer.java:98) ~[?:?]\r\n\tat java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_131]\r\n\tat org.elasticsearch.repositories.s3.SocketAccess.doPrivilegedIOException(SocketAccess.java:48) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobContainer.writeBlob(S3BlobContainer.java:95) ~[?:?]\r\n\tat org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeBlob(ChecksumBlobStoreFormat.java:187) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.write(ChecksumBlobStoreFormat.java:157) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1229) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\t... 9 more\r\nCaused by: com.amazonaws.services.s3.model.AmazonS3Exception: MD5 local [882AktFOIjwJNFwKqtfj+Q==], remote [LMtTgWbPjpF+Ia25VQtfwg==] are not equal... (Service: null; Status Code: 0; Error Code: null; Request ID: null)\r\n\tat org.elasticsearch.repositories.s3.DefaultS3OutputStream.doUpload(DefaultS3OutputStream.java:145) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:110) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.DefaultS3OutputStream.flush(DefaultS3OutputStream.java:99) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3OutputStream.flushBuffer(S3OutputStream.java:69) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3OutputStream.close(S3OutputStream.java:87) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobContainer.lambda$writeBlob$2(S3BlobContainer.java:98) ~[?:?]\r\n\tat java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_131]\r\n\tat org.elasticsearch.repositories.s3.SocketAccess.doPrivilegedIOException(SocketAccess.java:48) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobContainer.writeBlob(S3BlobContainer.java:95) ~[?:?]\r\n\tat org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeBlob(ChecksumBlobStoreFormat.java:187) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.write(ChecksumBlobStoreFormat.java:157) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1229) ~[elasticsearch-6.0.0-alpha3-SNAPSHOT.jar:6.0.0-alpha3-SNAPSHOT]\r\n\t... 9 more\r\n[2017-06-09T16:50:16,866][INFO ][o.e.s.SnapshotShardsService] [xrZgqIf] snapshot [elasticsearch-local:20170609t1525-141/SYTtvRUGSiyEBtsMmBvWMw] is done\r\n```\r\n","closed_by":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}