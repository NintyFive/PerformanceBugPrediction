{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16657","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16657/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16657/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16657/events","html_url":"https://github.com/elastic/elasticsearch/issues/16657","id":133524855,"node_id":"MDU6SXNzdWUxMzM1MjQ4NTU=","number":16657,"title":"Groovy script throws java.lang.NoClassDefFoundError: groovy/lang/Reference","user":{"login":"masaruh","id":572174,"node_id":"MDQ6VXNlcjU3MjE3NA==","avatar_url":"https://avatars3.githubusercontent.com/u/572174?v=4","gravatar_id":"","url":"https://api.github.com/users/masaruh","html_url":"https://github.com/masaruh","followers_url":"https://api.github.com/users/masaruh/followers","following_url":"https://api.github.com/users/masaruh/following{/other_user}","gists_url":"https://api.github.com/users/masaruh/gists{/gist_id}","starred_url":"https://api.github.com/users/masaruh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/masaruh/subscriptions","organizations_url":"https://api.github.com/users/masaruh/orgs","repos_url":"https://api.github.com/users/masaruh/repos","events_url":"https://api.github.com/users/masaruh/events{/privacy}","received_events_url":"https://api.github.com/users/masaruh/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-14T09:28:21Z","updated_at":"2016-02-14T16:24:51Z","closed_at":"2016-02-14T15:15:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Elasticsearch 2.2.0.\n\nCombination of `def` keyword and closure gives the exception.\n\nThis gives java.lang.NoClassDefFoundError: groovy/lang/Reference:\n\n```\nGET index/_search\n{\n  \"script_fields\": {\n    \"test_script\": {\n      \"script\": {\n        \"inline\": \"def val = \\\"\\\"; p.each{ val += it }; val\",\n        \"params\": {\n          \"p\":[\"aaa\", \"bbb\", \"ccc\"]\n        }\n      }\n    }\n  }\n}\n```\n\nThis is fine:\n\n```\nGET index/_search\n{\n  \"script_fields\": {\n    \"test_script\": {\n      \"script\": {\n        \"inline\": \"val = \\\"\\\"; p.each{ val += it }; val\",\n        \"params\": {\n          \"p\":[\"aaa\", \"bbb\", \"ccc\"]\n        }\n      }\n    }\n  }\n}\n```\n\nAdding `permission org.elasticsearch.script.ClassPermission \"groovy.lang.Reference\"` in `modules/lang-groovy/plugin-security.policy` seems to fix the issue.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}