{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791/events","html_url":"https://github.com/elastic/elasticsearch/issues/7791","id":43154201,"node_id":"MDU6SXNzdWU0MzE1NDIwMQ==","number":7791,"title":"top_children and function_score / script_score don't play nice together","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":113234020,"node_id":"MDU6TGFiZWwxMTMyMzQwMjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/stalled","name":"stalled","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2014-09-18T16:44:38Z","updated_at":"2015-11-21T19:04:47Z","closed_at":"2015-11-21T19:04:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Consider the following scenario, executed with 1.3.2:\n\n``` json\nDELETE /test\n\nPUT /test\n{\n  \"settings\": {\"number_of_replicas\": 0,\"number_of_shards\": 1}, \n  \"mappings\": {\n    \"tagged-page\":{\n        \"_parent\": {\n           \"type\": \"pages\"\n        },\n        \"properties\": {\n            \"name\": {\n              \"type\": \"string\",\"index\": \"not_analyzed\"\n            },\n            \"score\": {\n              \"type\": \"float\"\n            }\n        }\n    },\n    \"pages\": {\n      \"properties\": {\n        \"title\":{\"type\": \"string\", \"index\": \"no\" }\n      }\n    }\n  }\n}\n\nPOST /test/pages/1\n{\n    \"title\":\"page1\"\n}\n\nPOST /test/tagged-page?parent=1\n{\n    \"name\":\"foo\", \"score\":1.0\n}\n\nPOST /test/tagged-page?parent=1\n{\n    \"name\":\"bar\", \"score\":5.0\n}\n\nPOST /test/pages/2\n{\n    \"title\":\"page2\"\n}\n\nPOST /test/tagged-page?parent=2\n{\"name\":\"cafe\", \"score\":5.0 }\n\nPOST /test/tagged-page?parent=2\n{\"name\":\"bar\", \"score\":1.0}\n\nPOST /test/pages/3\n{\n    \"title\":\"page3\"\n}\n\nPOST /test/tagged-page?parent=3\n{\"name\":\"foo\", \"score\":100.0 }\n\nPOST /test/tagged-page?parent=3\n{\"name\":\"bar\", \"score\":3.0}\n\nPOST /test/pages/4\n{\n    \"title\":\"page4\"\n}\n\nPOST /test/tagged-page?parent=4\n{\"name\":\"foo\", \"score\":5.0 }\n\nPOST /test/tagged-page?parent=4\n{\"name\":\"bar\", \"score\":20.0}\n\nPOST /test/pages/5\n{\n    \"title\":\"page5\"\n}\n\nPOST /test/tagged-page?parent=5\n{\"name\":\"foo\", \"score\":3.0 }\n\nPOST /test/pages/6\n{\n    \"title\":\"page6\"\n}\n\nPOST /test/tagged-page?parent=6\n{\"name\":\"cafe\", \"score\":2.0}\n\nPOST /test/_refresh\n\nPOST /test/pages/_search\n{\n  \"query\": {\n    \"top_children\" : {\n        \"type\": \"tagged-page\",\n        \"query\": {\n            \"function_score\": {\n                \"query\": {\n                    \"term\": {\n                        \"name\": \"foo\"\n                    }\n                },\n                \"script_score\": {\n                    \"lang\" : \"groovy\",\n                    \"script\": \"doc[\\\"score\\\"].value\"\n                }\n            }\n        },\n        \"score\" : \"max\",\n        \"factor\" : 5,\n        \"incremental_factor\" : 2\n    }\n  }\n}\n```\n\nI get the following error:\n\n``` json\n{\n   \"error\": \"SearchPhaseExecutionException[Failed to execute phase [query_fetch], all shards failed; shardFailures {[BDBL4U4jTbCVsGvmCYzGpg][test][0]: QueryPhaseExecutionException[[test][0]: query[filtered(score_child[tagged-page/pages](filtered(function score (name:foo,function=script[doc[\\\"score\\\"].value], params [null]))->cache(_type:tagged-page)))->cache(_type:pages)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: RuntimeException[org.elasticsearch.script.groovy.GroovyScriptExecutionException: ElasticsearchIllegalArgumentException[No field found for [score] in mapping with types [pages]]]; nested: GroovyScriptExecutionException[ElasticsearchIllegalArgumentException[No field found for [score] in mapping with types [pages]]]; }]\",\n   \"status\": 500\n}\n```\n\nNote the `No field found for [score] in mapping with types [pages]`. Meaning, function_score was trying to execute the script_score within the context of the query to pages, instead of against the internal query to tagged-page as I would expect.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}