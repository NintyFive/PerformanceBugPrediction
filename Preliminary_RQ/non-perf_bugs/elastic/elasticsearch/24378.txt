{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24378","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24378/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24378/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24378/events","html_url":"https://github.com/elastic/elasticsearch/issues/24378","id":224903952,"node_id":"MDU6SXNzdWUyMjQ5MDM5NTI=","number":24378,"title":"Run As Security Violation Issue","user":{"login":"smudgekick","id":7727038,"node_id":"MDQ6VXNlcjc3MjcwMzg=","avatar_url":"https://avatars1.githubusercontent.com/u/7727038?v=4","gravatar_id":"","url":"https://api.github.com/users/smudgekick","html_url":"https://github.com/smudgekick","followers_url":"https://api.github.com/users/smudgekick/followers","following_url":"https://api.github.com/users/smudgekick/following{/other_user}","gists_url":"https://api.github.com/users/smudgekick/gists{/gist_id}","starred_url":"https://api.github.com/users/smudgekick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smudgekick/subscriptions","organizations_url":"https://api.github.com/users/smudgekick/orgs","repos_url":"https://api.github.com/users/smudgekick/repos","events_url":"https://api.github.com/users/smudgekick/events{/privacy}","received_events_url":"https://api.github.com/users/smudgekick/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"assignees":[{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-04-27T20:29:59Z","updated_at":"2017-04-27T21:09:21Z","closed_at":"2017-04-27T21:07:27Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:  5.3.1\r\n\r\n**Plugins installed**: [x-pack]\r\n\r\n**JVM version**: 1.8\r\n\r\n**OS version**: Mac OS 10.12.4 \r\n\r\n**Description of the problem including expected versus actual behavior**: When making a request using the header: \"es-security-runas-user\" against a user who's role includes a template query using {{_user.username}}...  we would expect the value of the {{_user.username}} to reflect the run as user but it is reflecting the active user.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create a role that uses a {{_user.username}} placeholder in a template as a document level security query.  \r\n\r\nExample:\r\n```\r\n{\r\n\t\"template\": {\r\n\t\t\"inline\": {\r\n\t\t\t\"match\": {\r\n\t\t\t\t\"acl\": \"{{_user.username}}\"\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n2.  Create 2 users both assigned to the role create above.  \r\n3.  Add some documents with a field called \"acl\" as an array of usernames.\r\n4.  Setup your data so that the active user should have some documents returned and the run as user should have different documents returned.\r\n5.  Connect as one of the users, but query with the “run as” header set as the other user.\r\n6.  This should show the documents for the run as user and not the active user.\r\n\r\nHowever, that is not happening.\r\n\r\nWhen we query using the superuser we get the full dataset as expected:\r\n```\r\ncurl -u elastic -XGET 'http://localhost:9200/customer1/general/_search?pretty'\r\nEnter host password for user 'elastic':\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 2,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"customer1\",\r\n        \"_type\" : \"general\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"foo\" : \"baz\",\r\n          \"acl\" : [\r\n            \"u1234\",\r\n            \"billybadboy\"\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"customer1\",\r\n        \"_type\" : \"general\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"foo\" : \"bar\",\r\n          \"acl\" : [\r\n            \"u1234\",\r\n            \"u4321\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWhen we query using the user: u4321 we get 1 document as expected:\r\n```\r\ncurl -u u4321 -XGET 'http://localhost:9200/customer1/general/_search?pretty' \r\nEnter host password for user 'u4321':\r\n{\r\n  \"took\" : 3,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"customer1\",\r\n        \"_type\" : \"general\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"foo\" : \"bar\",\r\n          \"acl\" : [\r\n            \"u1234\",\r\n            \"u4321\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\nWhen we query using the user: billybadboy and \"run-as\" u4321 we get 1 document but u4321 is not on the acl.  The document that is returned is for billybadboy because he is in the acl:\r\n```\r\ncurl -H \"es-security-runas-user: u4321\" -u billybadboy -GET 'http://localhost:9200/customer1/general/_search?pretty'\r\nEnter host password for user 'billybadboy':\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"customer1\",\r\n        \"_type\" : \"general\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"foo\" : \"baz\",\r\n          \"acl\" : [\r\n            \"u1234\",\r\n            \"billybadboy\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWe suspect this is happening because {{_user.username}} is not reflecting the impersonated user.\r\n\r\n\r\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}