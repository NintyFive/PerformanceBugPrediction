[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384294913","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-384294913","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":384294913,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDI5NDkxMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-25T13:53:28Z","updated_at":"2018-04-25T13:53:28Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384299143","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-384299143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":384299143,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDI5OTE0Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-04-25T14:05:30Z","updated_at":"2018-04-25T14:05:30Z","author_association":"CONTRIBUTOR","body":"This is the expected behavior. The reason for this is that Elasticsearch relies on the analyzer to split everything that it in-between query operators into terms. `\"`, `OR` and `AND` are query operators. And the analyzer on `keyword` fields is a `keyword` analyzer. So a `query_string` query on `3150185 J3050` is parsed as a query on the term `3150185 J3050`.\r\n\r\nI'm adding the `discuss` label here in case we think there should be a way to configure this, by somehow configuring a `whitespace` search analyzer on the field.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384331693","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-384331693","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":384331693,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDMzMTY5Mw==","user":{"login":"ontology-rory","id":23317326,"node_id":"MDQ6VXNlcjIzMzE3MzI2","avatar_url":"https://avatars1.githubusercontent.com/u/23317326?v=4","gravatar_id":"","url":"https://api.github.com/users/ontology-rory","html_url":"https://github.com/ontology-rory","followers_url":"https://api.github.com/users/ontology-rory/followers","following_url":"https://api.github.com/users/ontology-rory/following{/other_user}","gists_url":"https://api.github.com/users/ontology-rory/gists{/gist_id}","starred_url":"https://api.github.com/users/ontology-rory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ontology-rory/subscriptions","organizations_url":"https://api.github.com/users/ontology-rory/orgs","repos_url":"https://api.github.com/users/ontology-rory/repos","events_url":"https://api.github.com/users/ontology-rory/events{/privacy}","received_events_url":"https://api.github.com/users/ontology-rory/received_events","type":"User","site_admin":false},"created_at":"2018-04-25T15:36:08Z","updated_at":"2018-04-25T15:36:08Z","author_association":"NONE","body":"in the real index where I noticed the issue, there is a custom analyser for the index. I removed it for a simpler test case\r\n\r\n```\r\n    ....\r\n      \"analysis\": {\r\n        \"filter\": {\r\n          \"OntoFilter\": { ... }\r\n        },\r\n        \"analyzer\": {\r\n          \"default\": {\r\n            \"filter\": [\r\n              \"OntoFilter\",\r\n              \"lowercase\"\r\n            ],\r\n            \"tokenizer\": \"whitespace\"\r\n          }\r\n        }\r\n    ....\r\n```\r\n\r\nwould that not get picked up for the field or does keyword analyser trump the default analyser set on the index?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384345166","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-384345166","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":384345166,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDM0NTE2Ng==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-04-25T16:15:36Z","updated_at":"2018-04-25T16:15:36Z","author_association":"CONTRIBUTOR","body":"The default analyzer only applies to `text` fields. I suspect that `label` is a `keyword` in your mappings?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384901565","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-384901565","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":384901565,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDkwMTU2NQ==","user":{"login":"ontology-rory","id":23317326,"node_id":"MDQ6VXNlcjIzMzE3MzI2","avatar_url":"https://avatars1.githubusercontent.com/u/23317326?v=4","gravatar_id":"","url":"https://api.github.com/users/ontology-rory","html_url":"https://github.com/ontology-rory","followers_url":"https://api.github.com/users/ontology-rory/followers","following_url":"https://api.github.com/users/ontology-rory/following{/other_user}","gists_url":"https://api.github.com/users/ontology-rory/gists{/gist_id}","starred_url":"https://api.github.com/users/ontology-rory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ontology-rory/subscriptions","organizations_url":"https://api.github.com/users/ontology-rory/orgs","repos_url":"https://api.github.com/users/ontology-rory/repos","events_url":"https://api.github.com/users/ontology-rory/events{/privacy}","received_events_url":"https://api.github.com/users/ontology-rory/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T08:24:17Z","updated_at":"2018-04-27T08:24:17Z","author_association":"NONE","body":"it was - looking at changing the indexing structure now to see if that helps","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385408389","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-385408389","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":385408389,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTQwODM4OQ==","user":{"login":"ontology-rory","id":23317326,"node_id":"MDQ6VXNlcjIzMzE3MzI2","avatar_url":"https://avatars1.githubusercontent.com/u/23317326?v=4","gravatar_id":"","url":"https://api.github.com/users/ontology-rory","html_url":"https://github.com/ontology-rory","followers_url":"https://api.github.com/users/ontology-rory/followers","following_url":"https://api.github.com/users/ontology-rory/following{/other_user}","gists_url":"https://api.github.com/users/ontology-rory/gists{/gist_id}","starred_url":"https://api.github.com/users/ontology-rory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ontology-rory/subscriptions","organizations_url":"https://api.github.com/users/ontology-rory/orgs","repos_url":"https://api.github.com/users/ontology-rory/repos","events_url":"https://api.github.com/users/ontology-rory/events{/privacy}","received_events_url":"https://api.github.com/users/ontology-rory/received_events","type":"User","site_admin":false},"created_at":"2018-04-30T14:06:57Z","updated_at":"2018-04-30T14:07:26Z","author_association":"NONE","body":"So after tweaking the code a bit I now have the following index structure\r\n\r\n```\r\n{\r\n  \"ontoindex\": {\r\n    \"aliases\": {},\r\n    \"mappings\": {\r\n      \"document\": {\r\n        \"properties\": {\r\n          \"OntoFields\": {\r\n            \"type\": \"nested\",\r\n            \"properties\": {\r\n              \"key\": {\r\n                \"type\": \"keyword\"\r\n              },\r\n              \"value\": {\r\n                \"type\": \"text\",\r\n                \"copy_to\": [ \"OntoAll\" ]\r\n              }\r\n            }\r\n          },\r\n          \"OntoAll\": {\r\n            \"type\": \"text\"\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"analysis\": {\r\n          \"filter\": {\r\n            \"OntoFilter\": {\r\n              \"split_on_numerics\": \"true\",\r\n              \"generate_word_parts\": \"true\",\r\n              \"preserve_original\": \"true\",\r\n              \"catenate_words\": \"false\",\r\n              \"generate_number_parts\": \"true\",\r\n              \"catenate_all\": \"false\",\r\n              \"split_on_case_change\": \"true\",\r\n              \"type\": \"word_delimiter_graph\",\r\n              \"catenate_numbers\": \"false\"\r\n            }\r\n          },\r\n          \"analyzer\": {\r\n            \"default\": {\r\n              \"filter\": [\r\n                \"OntoFilter\",\r\n                \"lowercase\"\r\n              ],\r\n              \"tokenizer\": \"whitespace\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nPrevious, the mappings were very dynamic and in the worst case we could end up with 7500+ fields in the mapping :-(\r\nSpun it round to a more KV-like pattern and then set the type to `text` for the value and _all_ field. The queries then work as expected.\r\n\r\n```\r\nGET _search\r\n{\r\n  \"from\": 0,\r\n  \"size\": 10,\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"default_field\": \"OntoAll\",\r\n      \"default_operator\": \"AND\",\r\n      \"query\": \"3150185 J3050\"\r\n    }\r\n  },\r\n  \"explain\": false\r\n}\r\n```\r\n\r\nThanks for you helping me fix this - happy for you to close as non issue","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386602739","html_url":"https://github.com/elastic/elasticsearch/issues/30131#issuecomment-386602739","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30131","id":386602739,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NjYwMjczOQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-05-04T13:33:50Z","updated_at":"2018-05-04T13:33:50Z","author_association":"CONTRIBUTOR","body":"I'll close as a non issue, but we agreed to follow up on the idea to make it possible to split keywords on whitespace at query time: #30393.","performed_via_github_app":null}]