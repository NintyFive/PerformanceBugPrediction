{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48803","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48803/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48803/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48803/events","html_url":"https://github.com/elastic/elasticsearch/issues/48803","id":516072777,"node_id":"MDU6SXNzdWU1MTYwNzI3Nzc=","number":48803,"title":"Receiving status code 500 on pipeline failures for bulk ingestion requests","user":{"login":"simitt","id":5555349,"node_id":"MDQ6VXNlcjU1NTUzNDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5555349?v=4","gravatar_id":"","url":"https://api.github.com/users/simitt","html_url":"https://github.com/simitt","followers_url":"https://api.github.com/users/simitt/followers","following_url":"https://api.github.com/users/simitt/following{/other_user}","gists_url":"https://api.github.com/users/simitt/gists{/gist_id}","starred_url":"https://api.github.com/users/simitt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simitt/subscriptions","organizations_url":"https://api.github.com/users/simitt/orgs","repos_url":"https://api.github.com/users/simitt/repos","events_url":"https://api.github.com/users/simitt/events{/privacy}","received_events_url":"https://api.github.com/users/simitt/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-11-01T12:05:12Z","updated_at":"2019-11-14T15:53:09Z","closed_at":"2019-11-14T15:53:09Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.4.0 (also confirmed with 7.0.0)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): openjdk 13\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): mac\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nElasticsearch returns status code `500` for events sent to the bulk API when an applied pipeline fails processing an event, and has no failure handling (`ignore_failure` or `on_failure`) defined for the pipeline. \r\nI would except a status code `4xx` as the processing fails based on invalid data, and not based on a server issue. \r\n\r\n**Steps to reproduce**:\r\n(0) Create some pipeline, with no failure handling, in this example the geo-ip pipeline:\r\n```\r\nPUT _ingest/pipeline/sample\r\n{\r\n  \"processors\" : [\r\n    {\r\n      \"geoip\" : {\r\n        \"database_file\" : \"GeoLite2-City.mmdb\",\r\n        \"field\" : \"client.ip\",\r\n        \"target_field\" : \"client.geo\",\r\n        \"ignore_missing\" : true\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n(1) Ingest data using the bulk API and applying the pipeline\r\n```\r\nPOST /_bulk\r\n{ \"index\" : { \"_index\" : \"my-index\", \"pipeline\" : \"sample\" } }\r\n{ \"client\" : { \"ip\": \"unknown\"} }\r\n```\r\nThe ingestion fails, as the registered pipeline expects the `client.ip` to be an IP address, but instead a random string is sent.\r\n\r\nResponse:\r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"ingest_took\" : 50,\r\n  \"errors\" : true,\r\n  \"items\" : [\r\n    {\r\n      \"index\" : {\r\n        \"_index\" : \"my-index\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : null,\r\n        \"status\" : 500,\r\n        \"error\" : {\r\n          \"type\" : \"exception\",\r\n          \"reason\" : \"java.lang.IllegalArgumentException: java.lang.IllegalArgumentException: 'unknown' is not an IP string literal.\",\r\n          \"caused_by\" : {\r\n            \"type\" : \"illegal_argument_exception\",\r\n            \"reason\" : \"java.lang.IllegalArgumentException: 'unknown' is not an IP string literal.\",\r\n            \"caused_by\" : {\r\n              \"type\" : \"illegal_argument_exception\",\r\n              \"reason\" : \"'unknown' is not an IP string literal.\"\r\n            }\r\n          },\r\n          \"header\" : {\r\n            \"processor_type\" : \"geoip\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}