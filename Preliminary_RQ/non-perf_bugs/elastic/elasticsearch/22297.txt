{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22297","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22297/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22297/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22297/events","html_url":"https://github.com/elastic/elasticsearch/issues/22297","id":196872433,"node_id":"MDU6SXNzdWUxOTY4NzI0MzM=","number":22297,"title":"cluster.routing.allocation.exclude._ip using a space after each comma only uses the first ip","user":{"login":"geekpete","id":2070843,"node_id":"MDQ6VXNlcjIwNzA4NDM=","avatar_url":"https://avatars2.githubusercontent.com/u/2070843?v=4","gravatar_id":"","url":"https://api.github.com/users/geekpete","html_url":"https://github.com/geekpete","followers_url":"https://api.github.com/users/geekpete/followers","following_url":"https://api.github.com/users/geekpete/following{/other_user}","gists_url":"https://api.github.com/users/geekpete/gists{/gist_id}","starred_url":"https://api.github.com/users/geekpete/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geekpete/subscriptions","organizations_url":"https://api.github.com/users/geekpete/orgs","repos_url":"https://api.github.com/users/geekpete/repos","events_url":"https://api.github.com/users/geekpete/events{/privacy}","received_events_url":"https://api.github.com/users/geekpete/received_events","type":"User","site_admin":false},"labels":[{"id":144457604,"node_id":"MDU6TGFiZWwxNDQ0NTc2MDQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Settings","name":":Core/Infra/Settings","color":"0e8a16","default":false,"description":"Settings infrastructure and APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"assignees":[{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2016-12-21T08:21:44Z","updated_at":"2017-01-17T14:51:05Z","closed_at":"2017-01-17T14:51:05Z","author_association":"MEMBER","active_lock_reason":null,"body":"\r\n**Elasticsearch version**:\r\nReproducible on:\r\n - 5.1.1\r\n - 2.3.3\r\nand I suspect all versions in between.\r\n\r\n**Plugins installed**: []\r\nx-pack (this issue should be reproducible without this plugin installed.)\r\n\r\n**JVM version**:\r\n1.8.0_111\r\n\r\n**OS version**:\r\nUbuntu - Linux peter-Inspiron-7520 4.4.0-53-generic #74-Ubuntu SMP Fri Dec 2 15:59:10 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\nAlso tested on OSX Sierra\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen allocating shards away from more than one node using `cluster.routing.allocation.exclude._ip`, specifying a space after the comma in the comma delimited list causes only the first ip to be used in the exclusion (though all are listed in cluster settings), all subsequent ips in the list are ignored.\r\n\r\nMy test setup was a couple of machines, with one machine running two instances of ES on different ports and the other with a single instance of elasticsearch, clustered over a network.\r\nThe machine with two instances used the same ip address but different ports and my testing was to exclude the shards from allocating to the machine running the single instance.\r\n\r\nThe method I used for this was to exclude both an unused ip (ot used by any node in the cluster) and the ip of the single instance host, by listing the unused ip first in the list.\r\n\r\nThe effect was that the first ip in the list was the only one used for the exclusion if using a space after the comma in the list. Though cluster settings showed the entire string when retrieving the settings again. So it was Elasticsearch reading that string but only using the first ip in the list.\r\nWithout using any spaces, all the ips in the list were successfully excluded.\r\n\r\nI suggest we either:\r\n - have Elasticsearch strip out the whitespace after commas\r\n - or we specify a strict format that does not allow spaces after the commas and reject any calls to the API that send an \"invalid\" string with spaces after the commas with an error message telling the user why it was rejected\r\n - and with either of the above options, validate that the ips in the list are valid ipv4 or ipv6 ip addresses and throw an error if they are not valid (if we don't do this already)\r\n\r\nThe current user experience with this configuration setting is poor and needs to be fixed so that Elasticsearch does not \"fail\" silently and also behaves predictably.\r\nDocumentation should also be improved to reflect detail around how Elasticsearch works after whatever method is chosen to fix the bug.\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\n# exclude list using fake first ip and real second ip\r\n#\r\n\r\n# first with space after comma, nothing happens since only the first (unused) ip is recognised in the cluster allocation exclusion\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.exclude._ip\" : \"192.168.178.35, 192.168.178.21\"\r\n  }\r\n}\r\n\r\n# second with the space after the comma removed, which ensures all ips are recognized in the allocation exclusion\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.exclude._ip\" : \"192.168.178.35,192.168.178.21\"\r\n  }\r\n}\r\n\r\n# reset to no ips to reallocate shards evenly again\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.exclude._ip\" : \"\"\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\nLogs only show:\r\n```\r\n[2016-12-21T16:51:37,778][INFO ][o.e.c.s.ClusterSettings  ] [mac] updating [cluster.routing.allocation.exclude.] from [{}] to [{\"_ip\":\"192.168.178.35, 192.168.178.21\"}]\r\n[2016-12-21T16:51:58,775][INFO ][o.e.c.s.ClusterSettings  ] [mac] updating [cluster.routing.allocation.exclude.] from [{\"_ip\":\"192.168.178.35, 192.168.178.21\"}] to [{\"_ip\":\"192.168.178.35,192.168.178.21\"}]\r\n[2016-12-21T16:53:16,101][INFO ][o.e.c.s.ClusterSettings  ] [mac] updating [cluster.routing.allocation.exclude.] from [{\"_ip\":\"192.168.178.35,192.168.178.21\"}] to [{\"_ip\":\"\"}]\r\n```","closed_by":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}