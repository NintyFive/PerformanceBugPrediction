{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30627","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30627/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30627/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30627/events","html_url":"https://github.com/elastic/elasticsearch/issues/30627","id":323373839,"node_id":"MDU6SXNzdWUzMjMzNzM4Mzk=","number":30627,"title":"Inconsistent ingest pipeline support for REST bulk API","user":{"login":"keithmo","id":408525,"node_id":"MDQ6VXNlcjQwODUyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/408525?v=4","gravatar_id":"","url":"https://api.github.com/users/keithmo","html_url":"https://github.com/keithmo","followers_url":"https://api.github.com/users/keithmo/followers","following_url":"https://api.github.com/users/keithmo/following{/other_user}","gists_url":"https://api.github.com/users/keithmo/gists{/gist_id}","starred_url":"https://api.github.com/users/keithmo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keithmo/subscriptions","organizations_url":"https://api.github.com/users/keithmo/orgs","repos_url":"https://api.github.com/users/keithmo/repos","events_url":"https://api.github.com/users/keithmo/events{/privacy}","received_events_url":"https://api.github.com/users/keithmo/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-05-15T20:37:10Z","updated_at":"2018-07-19T18:59:50Z","closed_at":"2018-07-19T18:59:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.2.4, Build: ccec39f/2018-04-12T20:37:28.497551Z, JVM: 1.8.0_66\r\n\r\n**Plugins installed**: []\r\nNone\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_66\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_66-b17)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.66-b17, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin keithmo-air.local 17.5.0 Darwin Kernel Version 17.5.0: Fri Apr 13 19:32:32 PDT 2018; root:xnu-4570.51.2~1/RELEASE_X86_64 x86_64\r\n(macOS High Sierra, 10.13.4)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nIngest pipelines are not honored for all bulk operation types.\r\n\r\n**Steps to reproduce**:\r\n```\r\n#!/bin/bash\r\n\r\nHOST=http://localhost:9200\r\nINDEX=test-index\r\nTYPE=testdoc\r\nPIPELINE=my_pipeline\r\nID01=01\r\nID02=02\r\nID03=03\r\nID04=04\r\nID05=05\r\nID06=06\r\nID07=07\r\nID08=08\r\nID09=09\r\nID10=10\r\n\r\nfunction show_document {\r\n    ID=$1\r\n    echo \"document ${ID}: $(curl -s ${HOST}/${INDEX}/${TYPE}/${ID})\"\r\n}\r\n\r\necho \"VERSION\"\r\ncurl -s \"${HOST}\"\r\necho\r\n\r\necho \"DELETE pipeline ${PIPELINE}\"\r\ncurl -sX DELETE \"${HOME}/_ingest/pipeline/${PIPELINE}\" > /dev/null\r\necho \"CREATE pipeline ${PIPELINE}\"\r\ncurl -sX PUT \"localhost:9200/_ingest/pipeline/${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{\r\n    \\\"description\\\" : \\\"Adds ${PIPELINE} audit field\\\",\r\n    \\\"processors\\\" : [\r\n        {\r\n            \\\"set\\\" : {\r\n                \\\"field\\\": \\\"${PIPELINE}\\\",\r\n                \\\"value\\\": \\\"pipeline value\\\"\r\n            }\r\n        }\r\n    ]\r\n}\r\n\" > /dev/null\r\necho\r\n\r\necho \"DELETE index ${INDEX}\"\r\ncurl -sX DELETE \"${HOST}/${INDEX}\" > /dev/null\r\necho \"CREATE index ${INDEX}\"\r\ncurl -sX PUT \"${HOST}/${INDEX}\" -H \"Content-Type: application/json\" -d\"\r\n{\r\n    \\\"settings\\\" : {\r\n        \\\"index\\\" : {\r\n            \\\"number_of_shards\\\" : 1,\r\n            \\\"number_of_replicas\\\" : 0\r\n        }\r\n    }\r\n}\r\n\" > /dev/null\r\necho\r\n\r\necho \"CREATE ${ID01} via PUT\"\r\ncurl -sX PUT \"${HOST}/${INDEX}/${TYPE}/${ID01}?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d \"\r\n{ \\\"data\\\": \\\"my ID=${ID01}\\\" }\r\n\" > /dev/null\r\nshow_document ${ID01}\r\n\r\necho \"CREATE ${ID02} via POST bulk.index\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"index\\\" : { \\\"_id\\\" : \\\"${ID02}\\\" } }\r\n{ \\\"data\\\": \\\"my ID=${ID02}\\\" }\r\n\" > /dev/null\r\nshow_document ${ID02}\r\n\r\necho \"CREATE ${ID03} via POST bulk.update/doc doc_as_upsert=true\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"update\\\" : { \\\"_id\\\" : \\\"${ID03}\\\" } }\r\n{ \\\"doc\\\": { \\\"data\\\": \\\"my ID=${ID03}\\\" }, \\\"doc_as_upsert\\\": true }\r\n\" > /dev/null\r\nshow_document ${ID03}\r\n\r\necho \"CREATE ${ID04} via POST bulk.update/script/upsert\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"update\\\" : { \\\"_id\\\" : \\\"${ID04}\\\" } }\r\n{ \\\"script\\\" : { \\\"source\\\" : \\\"ctx._source.counter++;\\\" }, \\\"upsert\\\" : { \\\"data\\\":\\\"my ID=${ID04}\\\" } }\r\n\" > /dev/null\r\nshow_document ${ID04}\r\n\r\necho \"CREATE ${ID05} and ${ID06} via POST bulk.index and bulk.update/script/upsert\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"index\\\" : { \\\"_id\\\" : \\\"${ID05}\\\" } }\r\n{ \\\"data\\\": \\\"my ID=${ID05}\\\" }\r\n{ \\\"update\\\" : { \\\"_id\\\" : \\\"${ID06}\\\" } }\r\n{ \\\"script\\\" : { \\\"source\\\" : \\\"ctx._source.counter++;\\\" }, \\\"upsert\\\" : { \\\"data\\\":\\\"my ID=${ID06}\\\" } }\r\n\" > /dev/null\r\nshow_document ${ID05}\r\nshow_document ${ID06}\r\n\r\necho \"CREATE ${ID07} and ${ID08} via POST bulk.index and bulk.update/doc doc_as_upsert=true\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"index\\\" : { \\\"_id\\\" : \\\"${ID07}\\\" } }\r\n{ \\\"data\\\": \\\"my ID=${ID07}\\\" }\r\n{ \\\"update\\\" : { \\\"_id\\\" : \\\"${ID08}\\\" } }\r\n{ \\\"doc\\\": { \\\"data\\\": \\\"my ID=${ID08}\\\" }, \\\"doc_as_upsert\\\": true }\r\n\" > /dev/null\r\nshow_document ${ID07}\r\nshow_document ${ID08}\r\n\r\necho \"CREATE ${ID09} and ${ID10} via POST bulk.update/doc doc_as_upsert=true and bulk.index\"\r\ncurl -sX POST \"${HOST}/${INDEX}/${TYPE}/_bulk?pipeline=${PIPELINE}\" -H \"Content-Type: application/json\" -d\"\r\n{ \\\"update\\\" : { \\\"_id\\\" : \\\"${ID09}\\\" } }\r\n{ \\\"doc\\\": { \\\"data\\\": \\\"my ID=${ID09}\\\" }, \\\"doc_as_upsert\\\": true }\r\n{ \\\"index\\\" : { \\\"_id\\\" : \\\"${ID10}\\\" } }\r\n{ \\\"data\\\": \\\"my ID=${ID10}\\\" }\r\n\" > /dev/null\r\nshow_document ${ID09}\r\nshow_document ${ID10}\r\n```\r\nOutput:\r\n```\r\nVERSION\r\n{\r\n  \"name\" : \"keithmo-air.local\",\r\n  \"cluster_name\" : \"keithmosearch\",\r\n  \"cluster_uuid\" : \"cnHN05YyT0u-LyjXYegKeg\",\r\n  \"version\" : {\r\n    \"number\" : \"6.2.4\",\r\n    \"build_hash\" : \"ccec39f\",\r\n    \"build_date\" : \"2018-04-12T20:37:28.497551Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"7.2.1\",\r\n    \"minimum_wire_compatibility_version\" : \"5.6.0\",\r\n    \"minimum_index_compatibility_version\" : \"5.0.0\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\nDELETE pipeline my_pipeline\r\nCREATE pipeline my_pipeline\r\n\r\nDELETE index test-index\r\nCREATE index test-index\r\n\r\nCREATE 01 via PUT\r\ndocument 01: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"01\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=01\"}}\r\nCREATE 02 via POST bulk.index\r\ndocument 02: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"02\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=02\"}}\r\nCREATE 03 via POST bulk.update/doc doc_as_upsert=true\r\ndocument 03: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"03\",\"_version\":1,\"found\":true,\"_source\":{\"data\":\"my ID=03\"}}\r\nCREATE 04 via POST bulk.update/script/upsert\r\ndocument 04: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"04\",\"_version\":1,\"found\":true,\"_source\":{\"data\":\"my ID=04\"}}\r\nCREATE 05 and 06 via POST bulk.index and bulk.update/script/upsert\r\ndocument 05: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"05\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=05\"}}\r\ndocument 06: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"06\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=06\"}}\r\nCREATE 07 and 08 via POST bulk.index and bulk.update/doc doc_as_upsert=true\r\ndocument 07: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"07\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=07\"}}\r\ndocument 08: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"08\",\"_version\":1,\"found\":true,\"_source\":{\"data\":\"my ID=08\"}}\r\nCREATE 09 and 10 via POST bulk.update/doc doc_as_upsert=true and bulk.index\r\ndocument 09: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"09\",\"_version\":1,\"found\":true,\"_source\":{\"data\":\"my ID=09\"}}\r\ndocument 10: {\"_index\":\"test-index\",\"_type\":\"testdoc\",\"_id\":\"10\",\"_version\":1,\"found\":true,\"_source\":{\"my_pipeline\":\"pipeline value\",\"data\":\"my ID=10\"}}\r\n```\r\nNote that `CREATE 03 via POST bulk.update/doc doc_as_upsert=true` and `CREATE 04 via POST bulk.update/script/upsert` fail to run the pipeline, while `CREATE 07 and 08 via POST bulk.index and bulk.update/doc doc_as_upsert=true` and `CREATE 09 and 10 via POST bulk.update/doc doc_as_upsert=true and bulk.index` each run the pipeline partially (on one of the two docs per API call).","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}