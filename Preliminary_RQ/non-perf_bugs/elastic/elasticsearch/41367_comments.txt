[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484781586","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484781586","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484781586,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDc4MTU4Ng==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T06:34:12Z","updated_at":"2019-04-19T06:34:12Z","author_association":"MEMBER","body":"Assuming that you use the cluster health api to determine the status, maybe in you case use the index filter option to determine the status of specific indices? So GET `/_cluster/health/production-indices*` instead of GET `/_cluster/health`? This way if there are problems with less important indices, then no alarms will go off.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484787461","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484787461","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484787461,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDc4NzQ2MQ==","user":{"login":"gary-harpaz","id":6260714,"node_id":"MDQ6VXNlcjYyNjA3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/6260714?v=4","gravatar_id":"","url":"https://api.github.com/users/gary-harpaz","html_url":"https://github.com/gary-harpaz","followers_url":"https://api.github.com/users/gary-harpaz/followers","following_url":"https://api.github.com/users/gary-harpaz/following{/other_user}","gists_url":"https://api.github.com/users/gary-harpaz/gists{/gist_id}","starred_url":"https://api.github.com/users/gary-harpaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gary-harpaz/subscriptions","organizations_url":"https://api.github.com/users/gary-harpaz/orgs","repos_url":"https://api.github.com/users/gary-harpaz/repos","events_url":"https://api.github.com/users/gary-harpaz/events{/privacy}","received_events_url":"https://api.github.com/users/gary-harpaz/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T07:07:01Z","updated_at":"2019-04-19T07:07:01Z","author_association":"NONE","body":"I'm not sure this is just monitoring issue.\r\nBecause this is non recoverable (primary shard disappeard) I think it blocks recovery of other shards that do have replicas.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484806441","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484806441","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484806441,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDgwNjQ0MQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T08:23:55Z","updated_at":"2019-04-19T08:23:55Z","author_association":"MEMBER","body":"Are you observing that yellow indices are not recovering their replica shards? \r\n\r\nIf an index is red then it should not block other indices that are yellow from recovering their replica shards. The global cluster status in your case will remain to be red, because for certain indices there are no primary shards for recovery to start recovery. So deleting these indices will change the global status from red to green.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484818556","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484818556","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484818556,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDgxODU1Ng==","user":{"login":"gary-harpaz","id":6260714,"node_id":"MDQ6VXNlcjYyNjA3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/6260714?v=4","gravatar_id":"","url":"https://api.github.com/users/gary-harpaz","html_url":"https://github.com/gary-harpaz","followers_url":"https://api.github.com/users/gary-harpaz/followers","following_url":"https://api.github.com/users/gary-harpaz/following{/other_user}","gists_url":"https://api.github.com/users/gary-harpaz/gists{/gist_id}","starred_url":"https://api.github.com/users/gary-harpaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gary-harpaz/subscriptions","organizations_url":"https://api.github.com/users/gary-harpaz/orgs","repos_url":"https://api.github.com/users/gary-harpaz/repos","events_url":"https://api.github.com/users/gary-harpaz/events{/privacy}","received_events_url":"https://api.github.com/users/gary-harpaz/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T09:03:12Z","updated_at":"2019-04-19T09:03:12Z","author_association":"NONE","body":"The node that crashed contained a lot of shards from different indices.\nWhat I observed is that all of them were marked red, whether they had\nreplicas or not. The global status was red.\nAfter several hours the cluster did not recover.\nI used the explain api and it told me about the missing primary shard of\nthe logs index. I then deleted the all the logs indices as they are non\nessential.\nOnly then things started to improve and eventually the cluster recovered.\nI conclude that the problem with non essential index was blocking cluster\nrecovery which is bad behavior.\n\nThis was a sterfull event which required fast action as production system\nis down. So I can't really say if its a bug or able to reproduce this under\ncertain conditions.\n\n\nOn Fri, Apr 19, 2019, 11:25 Martijn van Groningen <notifications@github.com>\nwrote:\n\n> Are you observing that yellow indices are not recovering their replica\n> shards?\n>\n> If an index is red then it should not block other indices that are yellow\n> from recovering their replica shards. The global cluster status in your\n> case will remain to be red, because for certain indices there are no\n> primary shards for recovery to start recovery. So deleting these indices\n> will change the global status from red to green.\n>\n> â€”\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484806441>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/ABPYP2WNFH4EKU4UB5ZGRIDPRF6YZANCNFSM4HHCBOCA>\n> .\n>\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484848668","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484848668","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484848668,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDg0ODY2OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T10:45:57Z","updated_at":"2019-04-19T10:45:57Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484849095","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484849095","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484849095,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDg0OTA5NQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T10:47:23Z","updated_at":"2019-04-19T10:47:23Z","author_association":"MEMBER","body":"@gary-harpaz What ES version is your production cluster running?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484850023","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484850023","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484850023,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDg1MDAyMw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T10:51:09Z","updated_at":"2019-04-19T10:51:09Z","author_association":"MEMBER","body":"Also did you run the allocation explain on allocated shard for one of the logs index or the essential indices? I'm interested in what the output was of the allocation api for one of the essential indices.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/484904688","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484904688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":484904688,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NDkwNDY4OA==","user":{"login":"gary-harpaz","id":6260714,"node_id":"MDQ6VXNlcjYyNjA3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/6260714?v=4","gravatar_id":"","url":"https://api.github.com/users/gary-harpaz","html_url":"https://github.com/gary-harpaz","followers_url":"https://api.github.com/users/gary-harpaz/followers","following_url":"https://api.github.com/users/gary-harpaz/following{/other_user}","gists_url":"https://api.github.com/users/gary-harpaz/gists{/gist_id}","starred_url":"https://api.github.com/users/gary-harpaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gary-harpaz/subscriptions","organizations_url":"https://api.github.com/users/gary-harpaz/orgs","repos_url":"https://api.github.com/users/gary-harpaz/repos","events_url":"https://api.github.com/users/gary-harpaz/events{/privacy}","received_events_url":"https://api.github.com/users/gary-harpaz/received_events","type":"User","site_admin":false},"created_at":"2019-04-19T14:00:27Z","updated_at":"2019-04-19T14:00:27Z","author_association":"NONE","body":"6.0.1\r\n\r\nI executed explain without specifying which index . The result complained about one of the logs indices.\r\nAfter logs deletion during the recovery when I use explain on one of the essential indices it said:\r\n\"allocate_explanation\": \"cannot allocate because a previous copy of the primary shard existed but can no longer be found on the nodes in the cluster\"\r\nWhich is a mystery to me. You see this error and you think it is final. But later this index did manage to recover.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485716874","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-485716874","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":485716874,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTcxNjg3NA==","user":{"login":"gary-harpaz","id":6260714,"node_id":"MDQ6VXNlcjYyNjA3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/6260714?v=4","gravatar_id":"","url":"https://api.github.com/users/gary-harpaz","html_url":"https://github.com/gary-harpaz","followers_url":"https://api.github.com/users/gary-harpaz/followers","following_url":"https://api.github.com/users/gary-harpaz/following{/other_user}","gists_url":"https://api.github.com/users/gary-harpaz/gists{/gist_id}","starred_url":"https://api.github.com/users/gary-harpaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gary-harpaz/subscriptions","organizations_url":"https://api.github.com/users/gary-harpaz/orgs","repos_url":"https://api.github.com/users/gary-harpaz/repos","events_url":"https://api.github.com/users/gary-harpaz/events{/privacy}","received_events_url":"https://api.github.com/users/gary-harpaz/received_events","type":"User","site_admin":false},"created_at":"2019-04-23T09:06:59Z","updated_at":"2019-04-23T09:06:59Z","author_association":"NONE","body":"Update on this issue.\r\nAfter internal review of this incident we discovered that older essential indices were changed to have 0 replicas by retention process. We did this to save space. This explains why essential indices (older ones) were also status red when node crashed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485767627","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-485767627","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":485767627,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTc2NzYyNw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-23T11:41:55Z","updated_at":"2019-04-23T11:41:55Z","author_association":"MEMBER","body":"Thanks for the update and explanation.\r\n\r\nI would suggest use the cat shards api to figure out which shards are not allocated and then use the allocation explain api to figure out why specific shards don't allocate automatically.\r\n\r\n> \"allocate_explanation\": \"cannot allocate because a previous copy of the primary shard existed but can no longer be found on the nodes in the cluster\"\r\n\r\nThis means that a shard can not be restored, because the only existing copy of it is missing. Bringing back the node that had a copy of this shard, should fix this.\r\n\r\nAlso it turns out that there is already a way to give priority during shard recovery between indices.\r\nBasically unallocated primaries are always allocated first then unallocated shards based on the `index.priority` index setting. This defaults to 1, but for your essential indices you can overwrite this.\r\n\r\nGiven the cluster health request can be send to check the status of specific indices then I think this issue can be closed?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/486157699","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-486157699","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":486157699,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NjE1NzY5OQ==","user":{"login":"gary-harpaz","id":6260714,"node_id":"MDQ6VXNlcjYyNjA3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/6260714?v=4","gravatar_id":"","url":"https://api.github.com/users/gary-harpaz","html_url":"https://github.com/gary-harpaz","followers_url":"https://api.github.com/users/gary-harpaz/followers","following_url":"https://api.github.com/users/gary-harpaz/following{/other_user}","gists_url":"https://api.github.com/users/gary-harpaz/gists{/gist_id}","starred_url":"https://api.github.com/users/gary-harpaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gary-harpaz/subscriptions","organizations_url":"https://api.github.com/users/gary-harpaz/orgs","repos_url":"https://api.github.com/users/gary-harpaz/repos","events_url":"https://api.github.com/users/gary-harpaz/events{/privacy}","received_events_url":"https://api.github.com/users/gary-harpaz/received_events","type":"User","site_admin":false},"created_at":"2019-04-24T10:03:40Z","updated_at":"2019-04-24T10:03:40Z","author_association":"NONE","body":"No :)\r\nI still would like those indices marked with 0 replicas to not trouble me if node crashes.\r\nDon't want them to be marked red. Don't want global status to be red.\r\n\r\nDoes the \"previous copy of a primary shard exitsted\" error stay forever? Until I delete the index? How long does it stay?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/486253667","html_url":"https://github.com/elastic/elasticsearch/issues/41367#issuecomment-486253667","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41367","id":486253667,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NjI1MzY2Nw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2019-04-24T14:07:08Z","updated_at":"2019-04-24T14:07:08Z","author_association":"MEMBER","body":"We discussed issue and this is not a feature that Elasticsearch will support. To Elasticsearch, missing primary shards is a problematic situation that requires your attention, regardless of the index these shards belong to. Otherwise why do these indices exist in Elasticsearch to begin with? Maybe these indices are now not important anymore, but they were at some point in time. \r\n\r\nThe [filtering support in the cluster health api](https://github.com/elastic/elasticsearch/issues/41367#issuecomment-484781586) should be sufficient to monitor the important indices in your cluster. In the case you want to continue to rely on the global status then you can think about writing a script that either [force allocates an empty primary shards](https://www.elastic.co/guide/en/elasticsearch/reference/6.0/cluster-reroute.html#_forced_allocation_on_unrecoverable_errors) or deletes the not important indices when the global status is red. This is something that Elasticsearch will never do automatically, because both actions involve deleting data, so writing a custom script is required.\r\n\r\n> Does the \"previous copy of a primary shard exitsted\" error stay forever? Until I delete the index? How long does it stay?\r\n\r\nThat message will disappear when one of the following events occurs:\r\n1) The primary shard was able to recover when the node that original had a copy re-joins the cluster.\r\n2) An empty primary shard is forcefully allocated.\r\n3) The index is deleted.","performed_via_github_app":null}]