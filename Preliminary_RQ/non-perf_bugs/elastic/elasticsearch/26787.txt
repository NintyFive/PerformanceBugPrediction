{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26787","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26787/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26787/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26787/events","html_url":"https://github.com/elastic/elasticsearch/issues/26787","id":260463674,"node_id":"MDU6SXNzdWUyNjA0NjM2NzQ=","number":26787,"title":"Histogram aggregation fails on NaN","user":{"login":"thomas11","id":12074,"node_id":"MDQ6VXNlcjEyMDc0","avatar_url":"https://avatars0.githubusercontent.com/u/12074?v=4","gravatar_id":"","url":"https://api.github.com/users/thomas11","html_url":"https://github.com/thomas11","followers_url":"https://api.github.com/users/thomas11/followers","following_url":"https://api.github.com/users/thomas11/following{/other_user}","gists_url":"https://api.github.com/users/thomas11/gists{/gist_id}","starred_url":"https://api.github.com/users/thomas11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomas11/subscriptions","organizations_url":"https://api.github.com/users/thomas11/orgs","repos_url":"https://api.github.com/users/thomas11/repos","events_url":"https://api.github.com/users/thomas11/events{/privacy}","received_events_url":"https://api.github.com/users/thomas11/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-09-26T01:36:07Z","updated_at":"2017-10-06T15:58:31Z","closed_at":"2017-10-06T15:58:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nVersion: 5.6.1, Build: 667b497/2017-09-14T19:22:05.189Z, JVM: 1.8.0_141\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version** (`java -version`):\r\n\r\nopenjdk version \"1.8.0_92\"\r\nOpenJDK Runtime Environment (Zulu 8.15.0.1-win64) (build 1.8.0_92-b15)\r\nOpenJDK 64-Bit Server VM (Zulu 8.15.0.1-win64) (build 25.92-b15, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nWindows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe histogram aggregation fails on a field of type double when \"NaN\" is indexed.\r\n\r\n**Steps to reproduce**:\r\n\r\nIndex:\r\n\r\n```\r\n{\r\n    \"mappings\": {\r\n        \"docs\": {\r\n            \"dynamic\": false,\r\n            \"properties\": {\r\n                \"BaseRate\": {\r\n                    \"type\": \"double\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nTest document (one is enough):\r\n\r\n```\r\n        {\r\n            \"BaseRate\": \"NaN\"\r\n        }\r\n```\r\n\r\nAggregation request:\r\n\r\n```\r\n{\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    },\r\n    \"aggregations\": {\r\n        \"BaseRate\": {\r\n            \"histogram\": {\r\n                \"field\": \"BaseRate\",\r\n                \"interval\": \"10\"\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThis causes:\r\n\r\n```\r\n[2017-09-25T18:07:20,671][WARN ][r.suppressed             ] path: /nan-histogram/docs/_search, params: {index=nan-histogram, type=docs}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException:\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:272) [elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:623) [elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.6.1.jar:5.6.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_141]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_141]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_141]\r\nCaused by: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0\r\n        at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[?:1.8.0_141]\r\n        at java.util.ArrayList.get(ArrayList.java:429) ~[?:1.8.0_141]\r\n        at org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.reduceBuckets(InternalHistogram.java:274) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.doReduce(InternalHistogram.java:360) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:119) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:77) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:513) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:490) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:408) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:725) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n        ... 3 more\r\n```\r\n\r\n**Probable root cause**:\r\n\r\nIn InternalHistogram.reduceBuckets, the loop compares top.current.key != key (line 272 in 5.6.1). Both variables are doubles, in this case with the value Double.NaN, and Nan != Nan.","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}