{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51034","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51034/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51034/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51034/events","html_url":"https://github.com/elastic/elasticsearch/issues/51034","id":550142324,"node_id":"MDU6SXNzdWU1NTAxNDIzMjQ=","number":51034,"title":"NullPointer in PinnedQuery","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1789304462,"node_id":"MDU6TGFiZWwxNzg5MzA0NDYy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.7.0","name":"v7.7.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-01-15T11:56:57Z","updated_at":"2020-04-14T14:28:20Z","closed_at":"2020-01-15T18:29:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"An issue in 7.5.1 was reported by @gingerwizard where pinned queries cause a null pointer exception when `track_total_hits` is set to true. To reproduce the conditions for the error I found I had to have two documents, one with search terms in two fields and the other in only one field.\r\nStack trace:\r\n\r\n\tat org.apache.lucene.search.DisjunctionMaxScorer.advanceShallow(DisjunctionMaxScorer.java:80) ~[lucene-core-8.3.0.jar:8.3.0 2aa586909b911e66e1d8863aa89f173d69f86cd2 - ishan - 2019-10-25 23:10:03]\r\n\tat org.apache.lucene.search.CappedScoreQuery$1$1.get(CappedScoreQuery.java:127) ~[?:?]\r\n\tat org.apache.lucene.search.CappedScoreQuery$1.scorer(CappedScoreQuery.java:152) ~[?:?]\r\n\tat org.apache.lucene.search.DisjunctionMaxQuery$DisjunctionMaxWeight.scorer(DisjunctionMaxQuery.java:139) ~[lucene-core-8.3.0.jar:8.3.0 2aa586909b911e66e1d8863aa89f173d69f86cd2 - ishan - 2019-10-25 23:10:03]\r\n\tat org.apache.lucene.search.Weight.bulkScorer(Weight.java:181) ~[lucene-core-8.3.0.jar:8.3.0 2aa586909b911e66e1d8863aa89f173d69f86cd2 - ishan - 2019-10-25 23:10:03]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher$1.bulkScorer(ContextIndexSearcher.java:162) ~[elasticsearch-7.5.1.jar:7.5.1]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.searchInternal(ContextIndexSearcher.java:189) ~[elasticsearch-7.5.1.jar:7.5.1]\r\n\r\nReproduction: \r\n\r\n\tPUT localhost:9200/test/ \r\n\t{\r\n\t\t\"settings\": {\r\n\t\t\t\"number_of_shards\": \"1\",\r\n\t\t\t\"number_of_replicas\": \"0\"\r\n\t\t},\r\n\t\t\"mappings\": {\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"name\": {\r\n\t\t\t\t\t\"type\": \"text\"\r\n\t\t\t\t},\r\n\t\t\t\t\"description\": {\r\n\t\t\t\t\t\"type\": \"text\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tPOST localhost:9200/test/_doc/1 \r\n\t{\r\n\t\t\"description\" : \"foo bar\"\r\n\t}\r\n\r\n\tPOST localhost:9200/test/_doc/2\r\n\t{\r\n\t\t\"name\": \"foo \",\r\n\t\t\"description\": \"foo too\"\r\n\t}\r\n\r\n\r\n\tGET localhost:9200/test/_search \r\n\t{\r\n\t\t\"track_total_hits\": true,\r\n\t\t\"query\": {\r\n\t\t\t\"pinned\": {\r\n\t\t\t\t\"ids\": [\r\n\t\t\t\t\t\"1\"\r\n\t\t\t\t],\r\n\t\t\t\t\"organic\": {\r\n\t\t\t\t\t\"query_string\": {\r\n\t\t\t\t\t\t\"query\": \"foo\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n### Cause\r\nThe call to `DisjunctionMaxScorer.advanceShallow` fails because of this code in the implementation where the object is null:\r\n\r\n    return disjunctionBlockPropagator.advanceShallow(target);\r\n\r\n@jpountz - is the best fix to add a \"if not null\" safeguard to [this Lucene line](https://github.com/apache/lucene-solr/blob/master/lucene/core/src/java/org/apache/lucene/search/DisjunctionMaxScorer.java#L80) or for our calling [CappedScoreQuery code](https://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/search-business-rules/src/main/java/org/apache/lucene/search/CappedScoreQuery.java#L127) to add a scoring-mode check before attempting to invoke this under the wrong conditions.","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}