{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1036","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1036/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1036/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1036/events","html_url":"https://github.com/elastic/elasticsearch/issues/1036","id":1062367,"node_id":"MDU6SXNzdWUxMDYyMzY3","number":1036,"title":"ArrayIndexOutOfBoundsException during has_child query","user":{"login":"jasongilman","id":192983,"node_id":"MDQ6VXNlcjE5Mjk4Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/192983?v=4","gravatar_id":"","url":"https://api.github.com/users/jasongilman","html_url":"https://github.com/jasongilman","followers_url":"https://api.github.com/users/jasongilman/followers","following_url":"https://api.github.com/users/jasongilman/following{/other_user}","gists_url":"https://api.github.com/users/jasongilman/gists{/gist_id}","starred_url":"https://api.github.com/users/jasongilman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasongilman/subscriptions","organizations_url":"https://api.github.com/users/jasongilman/orgs","repos_url":"https://api.github.com/users/jasongilman/repos","events_url":"https://api.github.com/users/jasongilman/events{/privacy}","received_events_url":"https://api.github.com/users/jasongilman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2011-06-15T16:51:31Z","updated_at":"2011-06-17T17:04:37Z","closed_at":"2011-06-17T17:04:05Z","author_association":"NONE","active_lock_reason":null,"body":"I was unable to come up a with a scenario that will reproduce this reliably.  The problem is difficult to reproduce and timing of the search seems to cause the issue.  I'm hoping the stack trace might make it obvious where the problem is.  During a has_child query we will sometimes get the following stack trace:\n\n[2011-06-15 12:24:59,985][DEBUG][action.search.type       ] [Fallen One] [echo][0], node[9BjO9kriT5i52ryyeST4NQ], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@4c8a7c5]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [echo][0]: query[ConstantScore(org.elasticsearch.common.lucene.search.AndFilter@1419a704)],from[0],size[10],sort[<custom:\"provider_id\": org.elasticsearch.index.field.data.strings.StringFieldDataType$1@5bfdde41>,<custom:\"start_date\": org.elasticsearch.index.field.data.longs.LongFieldDataType$1@780aac95>]: Query Failed [Failed to execute child query [filtered(ConstantScore(org.elasticsearch.common.lucene.search.AndFilter@3b82c1e8))->FilterCacheFilterWrapper(_type:granule_minimum_bounding_rectangle)]]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:155)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:222)\n        at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:134)\n        at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:76)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:192)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.access$000(TransportSearchTypeAction.java:75)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.run(TransportSearchTypeAction.java:151)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:680)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 3\n        at org.elasticsearch.index.cache.id.simple.SimpleIdReaderTypeCache.parentIdByDoc(SimpleIdReaderTypeCache.java:53)\n        at org.elasticsearch.index.query.type.child.ChildCollector.collect(ChildCollector.java:72)\n        at org.apache.lucene.search.Scorer.score(Scorer.java:90)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:519)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:177)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:332)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:148)\n        ... 9 more\n\nThis is an example of the query that could cause the issue\n{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":[{\"has_child\":{\"type\":\"granule_minimum_bounding_rectangle\",\"query\":{\"constant_score\":{\"filter\":{\"and\":[{\"and\":[{\"range\":{\"north\":{\"from\":15.0,\"to\":90.0}}},{\"range\":{\"south\":{\"from\":-90.0,\"to\":15.001}}}]},{\"or\":[{\"and\":[{\"or\":[{\"range\":{\"west\":{\"from\":-180.0,\"to\":15.0001}}},{\"range\":{\"east\":{\"from\":14.9991,\"to\":180.0}}}]},{\"term\":{\"antimeridian\":true}}]},{\"and\":[{\"range\":{\"west\":{\"from\":-180.0,\"to\":15.0001}}},{\"range\":{\"east\":{\"from\":14.9991,\"to\":180.0}}}]}]}]}}}}},{\"or\":[{\"term\":{\"provider_id\":\"PROV1\"}},{\"term\":{\"provider_id\":\"PROV2\"}}]}]}}},\"fields\":[\"dataset_id\",\"granule_ur\"],\"sort\":[\"provider_id\",\"start_date\"],\"from\":0,\"size\":10}\n\nI can provide more information if needed.\n","closed_by":{"login":"jasongilman","id":192983,"node_id":"MDQ6VXNlcjE5Mjk4Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/192983?v=4","gravatar_id":"","url":"https://api.github.com/users/jasongilman","html_url":"https://github.com/jasongilman","followers_url":"https://api.github.com/users/jasongilman/followers","following_url":"https://api.github.com/users/jasongilman/following{/other_user}","gists_url":"https://api.github.com/users/jasongilman/gists{/gist_id}","starred_url":"https://api.github.com/users/jasongilman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasongilman/subscriptions","organizations_url":"https://api.github.com/users/jasongilman/orgs","repos_url":"https://api.github.com/users/jasongilman/repos","events_url":"https://api.github.com/users/jasongilman/events{/privacy}","received_events_url":"https://api.github.com/users/jasongilman/received_events","type":"User","site_admin":false},"performed_via_github_app":null}