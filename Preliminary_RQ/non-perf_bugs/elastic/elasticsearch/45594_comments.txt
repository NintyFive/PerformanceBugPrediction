[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521509536","html_url":"https://github.com/elastic/elasticsearch/issues/45594#issuecomment-521509536","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45594","id":521509536,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTUwOTUzNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T04:30:07Z","updated_at":"2019-08-15T04:30:07Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521664558","html_url":"https://github.com/elastic/elasticsearch/issues/45594#issuecomment-521664558","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45594","id":521664558,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTY2NDU1OA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T14:37:48Z","updated_at":"2019-08-15T14:37:48Z","author_association":"MEMBER","body":"Can you describe how you reproduced this in more detail? When I run through the same behavior the second execute call returns with the snapshot name, which then fails (as expected) with a warning in the logs and registers it as a failed snapshot in the SLM policy\r\n\r\n```\r\n[elasticsearch] [2019-08-15T08:35:23,107][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy [daily-snapshots] issuing create snapshot [production-snap-2019.08.15-sdycfgceq1ozhvqhbdhyfg]\r\n[elasticsearch] [2019-08-15T08:35:23,145][INFO ][o.e.s.SnapshotsService   ] [node-0] snapshot [repo:production-snap-2019.08.15-sdycfgceq1ozhvqhbdhyfg/eXVrbzxrRHmceBWpy70iPQ] started\r\n[elasticsearch] [2019-08-15T08:35:23,188][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.slm-history-1-2019.08] creating index, cause [auto(bulk api)], templates [.slm-history], shards [1]/[0], mappings [_doc]\r\n\r\n\r\n[elasticsearch] [2019-08-15T08:35:27,333][INFO ][o.e.x.s.SnapshotLifecycleTask] [node-0] snapshot lifecycle policy [daily-snapshots] issuing create snapshot [production-snap-2019.08.15-e4coq5clrdaatbhcbzb93q]\r\n[elasticsearch] [2019-08-15T08:35:27,356][WARN ][o.e.s.SnapshotsService   ] [node-0] [repo][production-snap-2019.08.15-e4coq5clrdaatbhcbzb93q] failed to create snapshot\r\n[elasticsearch] org.elasticsearch.snapshots.ConcurrentSnapshotExecutionException: [repo:production-snap-2019.08.15-e4coq5clrdaatbhcbzb93q]  a snapshot is already running\r\n[elasticsearch] \tat org.elasticsearch.snapshots.SnapshotsService$1.execute(SnapshotsService.java:286) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:47) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:697) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.MasterService.calculateTaskOutputs(MasterService.java:319) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.MasterService.runTasks(MasterService.java:214) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.MasterService$Batcher.run(MasterService.java:151) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:699) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:252) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:215) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch] \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n[elasticsearch] \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n[elasticsearch] \tat java.lang.Thread.run(Thread.java:834) [?:?]\r\n```\r\n\r\nRepo/policy I'm using:\r\n\r\n```\r\nPUT /_snapshot/repo\r\n{\r\n  \"type\": \"fs\",\r\n  \"settings\": {\r\n    \"location\": \"repo\",\r\n    \"max_snapshot_bytes_per_sec\": \"10b\"\r\n  }\r\n}\r\n\r\nPUT /_slm/policy/daily-snapshots\r\n{\r\n  \"schedule\": \"1 2 3 * * ?\",\r\n  \"name\": \"<production-snap-{now/d}>\",\r\n  \"repository\": \"repo\",\r\n  \"config\": {\r\n    \"indices\": [\"foo-*\", \"important\"],\r\n    \"ignore_unavailable\": true,\r\n    \"include_global_state\": false\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521702433","html_url":"https://github.com/elastic/elasticsearch/issues/45594#issuecomment-521702433","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45594","id":521702433,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTcwMjQzMw==","user":{"login":"jen-huang","id":1965714,"node_id":"MDQ6VXNlcjE5NjU3MTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1965714?v=4","gravatar_id":"","url":"https://api.github.com/users/jen-huang","html_url":"https://github.com/jen-huang","followers_url":"https://api.github.com/users/jen-huang/followers","following_url":"https://api.github.com/users/jen-huang/following{/other_user}","gists_url":"https://api.github.com/users/jen-huang/gists{/gist_id}","starred_url":"https://api.github.com/users/jen-huang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jen-huang/subscriptions","organizations_url":"https://api.github.com/users/jen-huang/orgs","repos_url":"https://api.github.com/users/jen-huang/repos","events_url":"https://api.github.com/users/jen-huang/events{/privacy}","received_events_url":"https://api.github.com/users/jen-huang/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T16:20:31Z","updated_at":"2019-08-15T16:26:48Z","author_association":"NONE","body":"@dakrone The approximate total size of my indices is 22mb and I set my repo to 1kb per second. Here is a sequence of my requests:\r\n\r\n```json\r\n# Repo configuration\r\n# GET /_snapshot/slow-repo\r\n{\r\n  \"slow-repo\" : {\r\n    \"type\" : \"fs\",\r\n    \"settings\" : {\r\n      \"location\" : \"test\",\r\n      \"max_snapshot_bytes_per_sec\" : \"1kb\"\r\n    }\r\n  }\r\n}\r\n\r\n# Policy configuration\r\n# GET /_slm/policy/slow-test\r\n{\r\n  \"slow-test\" : {\r\n    \"version\" : 1,\r\n    \"modified_date_millis\" : 1565885533675,\r\n    \"policy\" : {\r\n      \"name\" : \"slow-test\",\r\n      \"schedule\" : \"0 0 0 ? * 7\",\r\n      \"repository\" : \"slow-repo\",\r\n      \"config\" : { }\r\n    },\r\n    \"next_execution_millis\" : 1566000000000\r\n  }\r\n}\r\n\r\n# Executing policy the first time\r\n# PUT /_slm/policy/slow-test/_execute\r\n{\r\n  \"snapshot_name\" : \"slow-test-_wl2wwbpseudgpqlbosnnq\"\r\n}\r\n\r\n# Checking policy information after executing - in progress information is listed\r\n# GET /_slm/policy/slow-test\r\n{\r\n  \"slow-test\" : {\r\n    \"version\" : 1,\r\n    \"modified_date_millis\" : 1565885533675,\r\n    \"policy\" : {\r\n      \"name\" : \"slow-test\",\r\n      \"schedule\" : \"0 0 0 ? * 7\",\r\n      \"repository\" : \"slow-repo\",\r\n      \"config\" : { }\r\n    },\r\n    \"last_success\" : {\r\n      \"snapshot_name\" : \"slow-test-_wl2wwbpseudgpqlbosnnq\",\r\n      \"time\" : 1565885694939\r\n    },\r\n    \"next_execution_millis\" : 1566000000000,\r\n    \"in_progress\" : {\r\n      \"name\" : \"slow-test-_wl2wwbpseudgpqlbosnnq\",\r\n      \"uuid\" : \"9kEheisWQ5i_4IlT0AamMg\",\r\n      \"state\" : \"STARTED\",\r\n      \"start_time_millis\" : 1565885694668\r\n    }\r\n  }\r\n}\r\n\r\n# Executing policy the second time time - it times out\r\n# PUT /_slm/policy/slow-test/_execute\r\n{\r\n  \"statusCode\": 504,\r\n  \"error\": \"Gateway Time-out\",\r\n  \"message\": \"Client request timeout\"\r\n}\r\n```\r\n\r\nThe failure from the second execution does not show up in in policy information or ES logs **until** I delete the snapshot that is currently in progress. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522952746","html_url":"https://github.com/elastic/elasticsearch/issues/45594#issuecomment-522952746","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45594","id":522952746,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjk1Mjc0Ng==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-08-20T10:23:54Z","updated_at":"2019-08-20T10:23:54Z","author_association":"MEMBER","body":"@dakrone I think might now what's going on here.\r\nThe transport handler for executing a policy runs on the snapshot pool. So if you're already doing snapshot things, then executing a policy might not work because there's no thread available to handle the request on the snapshot pool.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522991872","html_url":"https://github.com/elastic/elasticsearch/issues/45594#issuecomment-522991872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45594","id":522991872,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjk5MTg3Mg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-08-20T12:30:08Z","updated_at":"2019-08-20T12:30:08Z","author_association":"MEMBER","body":"@jen-huang I opened https://github.com/elastic/elasticsearch/pull/45727 with a suggested fix. If you still have the reproducer setup ready for this, feel free to try it out :)","performed_via_github_app":null}]