[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466353893","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466353893","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466353893,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjM1Mzg5Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T10:40:34Z","updated_at":"2019-02-22T10:40:34Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466370160","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466370160","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466370160,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjM3MDE2MA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T11:45:17Z","updated_at":"2019-02-22T11:45:17Z","author_association":"MEMBER","body":"Also reproduces on `master` :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466430207","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466430207","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466430207,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjQzMDIwNw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T15:12:46Z","updated_at":"2019-02-22T15:12:46Z","author_association":"CONTRIBUTOR","body":"It seems that we are not correctly flushing all completed operations before taking the snapshot. The offending shard flushes with one operation still in-flight (NB local checkpoint is 66, max seqno is 67):\r\n\r\n```\r\n  1> [2019-02-22T17:39:09,611][TRACE][o.e.i.e.Engine           ] [node_s1] [efr][0] committing writer with commit data [{local_checkpoint=66, max_unsafe_auto_id_timestamp=-1, translog_uuid=f9ujzyJ6QAKvJkRhG8R85w, min_retained_seq_no=0, history_uuid=ZVFJ1nDmSJuqoKqG2J_N-w, translog_generation=3, max_seq_no=67}]\r\n```\r\n\r\nThen a short while later we contemplate doing another flush prior to the snapshot but decide to do nothing:\r\n\r\n```\r\n  1> [2019-02-22T17:39:10,486][TRACE][o.e.i.e.Engine           ] [node_s1] [efr][0] start flush for snapshot\r\n  1> [2019-02-22T17:39:10,487][TRACE][o.e.i.e.Engine           ] [node_s1] [efr][0] acquired flush lock immediately\r\n  1> [2019-02-22T17:39:10,487][TRACE][o.e.i.e.Engine           ] [node_s1] [efr][0] finish flush for snapshot\r\n```\r\n\r\nOnce the snapshot completes we delete the index and restore it:\r\n\r\n```\r\n  1> [2019-02-22T17:39:11,837][TRACE][o.e.i.e.Engine           ] [node_s0] [efr][0] recovered maximum sequence number [67] and local checkpoint [66]\r\n```\r\n\r\nWe _should_ be filling in the gap with a `NoOp` that gets recorded to the translog, but it seems that we do not:\r\n\r\n```\r\n  1> [2019-02-22T17:39:12,291][TRACE][o.e.i.r.RecoverySourceHandler] [node_s0] [efr][0][recover to node_s1] recovery [phase2]: sending batch of 0 ops\r\n```\r\n\r\nI am looking harder at the gap-filling logic now.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466452325","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466452325","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466452325,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjQ1MjMyNQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T16:14:35Z","updated_at":"2019-02-22T16:14:35Z","author_association":"CONTRIBUTOR","body":"@dnhatn I suspect that the issue with gap-filling lies here:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/e00e7003fcf75a5d61ea02320c84fd366afd5535/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java#L259-L264\r\n\r\nWhen restoring from a snapshot, this advances the local checkpoint but does not put corresponding entries in the translog, so by the time we get to `fillSeqNoGaps()` there don't seem to be any gaps to fill. Below is a repository containing a snapshot that exhibits the problem. It's possible to restore its primaries (really the `efr` index is all you need) but peer recoveries from those primaries will fail. Could you take a look?\r\n\r\n[issue-39299-repo.tar.gz](https://github.com/elastic/elasticsearch/files/2894771/issue-39299-repo.tar.gz)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466457211","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466457211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466457211,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjQ1NzIxMQ==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T16:28:34Z","updated_at":"2019-02-22T16:28:34Z","author_association":"MEMBER","body":"@DaveCTurner I was about to ping you. That's the root cause indeed. Great find!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466515590","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-466515590","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":466515590,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjUxNTU5MA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T19:22:32Z","updated_at":"2019-02-22T19:23:41Z","author_association":"MEMBER","body":"This is an unreleased bug that relates to #38237 and #38904. This bug only affects the snapshot/restore with soft-deletes enabled.\r\n\r\nSince #38237, we initialize the local_checkpoint of the restoring shard with the local_checkpoint of the restoring commit (previously we assigned the max_seq_no to the local_checkpoint). This change exposes that refilling LocalCheckpointTracker does not play well with \"fillSeqNoGaps\". Suppose the restoring commit consists of seq-0, seq-2, and seq-3 (seq-1 is not in the commit), then \"fillSeqNoGaps\" method will add NoOp for seq-1 because after seq-1 is filled the local checkpoint jumps to 3. A peer-recovery will fail since we don't have enough history in translog. This bug is very similar to #39000. If we [remove the sequence number range check](https://github.com/elastic/elasticsearch/pull/39006) in peer-recovery, then this issue would be resolved. Moreover, to maintain the safe commit assumption, I think we need to [flush](https://github.com/elastic/elasticsearch/pull/39153/commits/f3ef90d84db7de4d3055696ced76a373d4332793) after fillSeqNoGaps.\r\n\r\n/cc @ywelsch @jasontedor","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/467148252","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-467148252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":467148252,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NzE0ODI1Mg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-02-25T19:28:13Z","updated_at":"2019-02-25T19:28:13Z","author_association":"MEMBER","body":"This issue is resolved by #39006.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667150776","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-667150776","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":667150776,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzE1MDc3Ng==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T14:32:39Z","updated_at":"2020-07-31T14:32:39Z","author_association":"MEMBER","body":"I've seen this test fail in apparently the same way, see https://gradle-enterprise.elastic.co/s/j7gznmtonko42 . I will reopen, let me know if you prefer a new issue for this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667155275","html_url":"https://github.com/elastic/elasticsearch/issues/39299#issuecomment-667155275","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39299","id":667155275,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzE1NTI3NQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T14:41:56Z","updated_at":"2020-07-31T14:41:56Z","author_association":"MEMBER","body":"This seems like a different issue:\r\n\r\n```\r\n  1> [2020-07-31T04:23:01,375][INFO ][o.e.c.r.a.AllocationService] [node_sm0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[zxapvwy][4]]]).\r\n  1> [2020-07-31T04:23:06,653][INFO ][o.e.r.f.FsBlobStoreRepositoryIT] [testSnapshotAndRestore] ensureGreen timed out, cluster state:\r\n```\r\n\r\nsomehow we entered a green state and 5s later timed out waiting for that green state. My suspicion is that this was just a randomly very slow CI run, but I'll investigate a little to see if we can make this wait more resilient :)","performed_via_github_app":null}]