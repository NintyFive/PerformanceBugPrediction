{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19364","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19364/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19364/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19364/events","html_url":"https://github.com/elastic/elasticsearch/issues/19364","id":164863242,"node_id":"MDU6SXNzdWUxNjQ4NjMyNDI=","number":19364,"title":"Allow bucket_script to operate on date_range buckets.","user":{"login":"pmusa","id":361280,"node_id":"MDQ6VXNlcjM2MTI4MA==","avatar_url":"https://avatars0.githubusercontent.com/u/361280?v=4","gravatar_id":"","url":"https://api.github.com/users/pmusa","html_url":"https://github.com/pmusa","followers_url":"https://api.github.com/users/pmusa/followers","following_url":"https://api.github.com/users/pmusa/following{/other_user}","gists_url":"https://api.github.com/users/pmusa/gists{/gist_id}","starred_url":"https://api.github.com/users/pmusa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmusa/subscriptions","organizations_url":"https://api.github.com/users/pmusa/orgs","repos_url":"https://api.github.com/users/pmusa/repos","events_url":"https://api.github.com/users/pmusa/events{/privacy}","received_events_url":"https://api.github.com/users/pmusa/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-07-11T15:18:57Z","updated_at":"2016-08-22T17:38:13Z","closed_at":"2016-08-22T17:38:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Executing a bucket_script in the result of a date_range aggregation returns a cast error.\n\n```\nDELETE test\n\nPUT test/test/1\n{\n  \"tag\": \"a\",\n  \"time\": \"2016-05-10\",\n  \"value1\": 10,\n  \"value2\": 12\n}\n\nPUT test/test/2\n{\n  \"tag\": \"a\",\n  \"time\": \"2016-05-10\",\n  \"value1\": 10,\n  \"value2\": 12\n}\n\nPUT test/test/3\n{\n  \"tag\": \"b\",\n  \"time\": \"2016-05-10\",\n  \"value1\": 10,\n  \"value2\": 12\n}\n\nGET test/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"b1\": {\n      \"terms\": {\n        \"field\": \"tag\",\n        \"size\": 2\n      },      \n      \"aggs\": {\n        \"m1\": {\n          \"avg\": {\n            \"field\": \"value1\"\n          }\n        },\n        \"m2\": {\n          \"max\": {\n            \"field\": \"value2\"\n          }\n        },\n        \"s1\": {\n          \"bucket_script\": {\n            \"buckets_path\": {\n              \"v1\": \"m1\",\n              \"v2\": \"m2\"\n            },\n            \"script\": \"v1*v2\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nGET test/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"b1\": {\n      \"date_range\": {\n        \"field\": \"time\",\n        \"ranges\": [\n          {\n            \"from\": \"2016-05-09\",\n            \"to\": \"2016-05-11\"\n          }\n        ]\n      },     \n      \"aggs\": {\n        \"m1\": {\n          \"avg\": {\n            \"field\": \"value1\"\n          }\n        },\n        \"m2\": {\n          \"max\": {\n            \"field\": \"value2\"\n          }\n        },\n        \"s1\": {\n          \"bucket_script\": {\n            \"buckets_path\": {\n              \"v1\": \"m1\",\n              \"v2\": \"m2\"\n            },\n            \"script\": \"v1*v2\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe last aggregation execution returns the following.\n\n```\n{\n   \"error\": {\n      \"root_cause\": [],\n      \"type\": \"reduce_search_phase_exception\",\n      \"reason\": \"[reduce] \",\n      \"phase\": \"merge\",\n      \"grouped\": true,\n      \"failed_shards\": [],\n      \"caused_by\": {\n         \"type\": \"class_cast_exception\",\n         \"reason\": \"org.joda.time.DateTime cannot be cast to java.lang.Number\"\n      }\n   },\n   \"status\": 503\n}\n```\n\nEven if we solve this issue the above example will still fail without #14600.\n\nUsing the hack on #14600 the following works:\n\n```\nGET test/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"b1\": {\n      \"filters\": {\n        \"filters\": {\n          \"a\": {\n            \"range\": {\n              \"time\": {\n                \"gte\": \"2016-05-09\",\n                \"lte\": \"2016-05-11\"\n              }\n            }\n          }\n        }\n      },      \n      \"aggs\": {\n        \"m1\": {\n          \"avg\": {\n            \"field\": \"value1\"\n          }\n        },\n        \"m2\": {\n          \"max\": {\n            \"field\": \"value2\"\n          }\n        },\n        \"s1\": {\n          \"bucket_script\": {\n            \"buckets_path\": {\n              \"v1\": \"m1\",\n              \"v2\": \"m2\"\n            },\n            \"script\": \"v1*v2\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n/cc @colings86 \n","closed_by":{"login":"tsouza","id":122435,"node_id":"MDQ6VXNlcjEyMjQzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/122435?v=4","gravatar_id":"","url":"https://api.github.com/users/tsouza","html_url":"https://github.com/tsouza","followers_url":"https://api.github.com/users/tsouza/followers","following_url":"https://api.github.com/users/tsouza/following{/other_user}","gists_url":"https://api.github.com/users/tsouza/gists{/gist_id}","starred_url":"https://api.github.com/users/tsouza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsouza/subscriptions","organizations_url":"https://api.github.com/users/tsouza/orgs","repos_url":"https://api.github.com/users/tsouza/repos","events_url":"https://api.github.com/users/tsouza/events{/privacy}","received_events_url":"https://api.github.com/users/tsouza/received_events","type":"User","site_admin":false},"performed_via_github_app":null}