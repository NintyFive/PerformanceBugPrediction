{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28720","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28720/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28720/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28720/events","html_url":"https://github.com/elastic/elasticsearch/issues/28720","id":298096726,"node_id":"MDU6SXNzdWUyOTgwOTY3MjY=","number":28720,"title":"[BUG] ES 6.0 - Duplicate Alias after rollover timeout","user":{"login":"shaharmor","id":10861920,"node_id":"MDQ6VXNlcjEwODYxOTIw","avatar_url":"https://avatars3.githubusercontent.com/u/10861920?v=4","gravatar_id":"","url":"https://api.github.com/users/shaharmor","html_url":"https://github.com/shaharmor","followers_url":"https://api.github.com/users/shaharmor/followers","following_url":"https://api.github.com/users/shaharmor/following{/other_user}","gists_url":"https://api.github.com/users/shaharmor/gists{/gist_id}","starred_url":"https://api.github.com/users/shaharmor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaharmor/subscriptions","organizations_url":"https://api.github.com/users/shaharmor/orgs","repos_url":"https://api.github.com/users/shaharmor/repos","events_url":"https://api.github.com/users/shaharmor/events{/privacy}","received_events_url":"https://api.github.com/users/shaharmor/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"}],"state":"closed","locked":false,"assignee":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"assignees":[{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2018-02-18T16:17:11Z","updated_at":"2018-02-23T03:45:50Z","closed_at":"2018-02-19T14:21:03Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.0.0, Build: 8f0685b/2017-11-10T18:41:22.859Z, JVM: 1.8.0_151\r\n\r\n**Plugins installed**: [repository-azure]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_151\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_151-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux xxx-001 4.11.0-1014-azure #14-Ubuntu SMP Tue Oct 17 12:10:56 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have a cron job that runs the `rollover` command on an alias named `customers` every 1 hour, at 1 minute past the start of the hour.\r\nThe job has been running for the past few months flawlessly.\r\n\r\nWe recently (1 hour ago) had a critical issue that caused Elasticsearch to become un-writeable.\r\n\r\nThe cluster architecture is as follow:\r\n3 master nodes\r\n3 hot data nodes \r\n3 cold data nodes\r\n\r\nAlias points to an index on the hot data nodes only.\r\n\r\nWhat happened is that 3 seconds before the cronjob started, one of the **cold** data nodes suddenly rebooted (Not related to Elasticsearch).\r\nRelevant log:\r\n```\r\n[2018-02-18T15:00:58,703][DEBUG][o.e.a.a.c.n.s.TransportNodesStatsAction] [elasticsearch-master-001] failed to execute on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.ReceiveTimeoutTransportException: [elasticsearch-data-cold-003][10.0.0.52:9300][cluster:monitor/nodes/stats[n]] request_id [40478282] timed out after [15001ms]\r\n\tat org.elasticsearch.transport.TransportService$TimeoutHandler.run(TransportService.java:953) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n```\r\n\r\n3 seconds later the cronjob started and tried to rollover the index, as seen in these logs:\r\n```\r\n[2018-02-18T15:01:01,831][INFO ][o.e.c.m.MetaDataCreateIndexService] [elasticsearch-master-001] [customers-raw-003282] creating index, cause [rollover_index], templates [customers-raw], shards [6]/[1], mappings [_default_]\r\n```\r\n\r\n30 seconds later, with no other logs in the middle, the rollover times out because of the crashed server:\r\n\r\n```\r\n[2018-02-18T15:01:34,026][WARN ][o.e.d.z.PublishClusterStateAction] [elasticsearch-master-001] timed out waiting for all nodes to process published state [474491] (timeout [30s], pending nodes: [{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}])\r\n[2018-02-18T15:01:34,107][WARN ][o.e.c.s.MasterService    ] [elasticsearch-master-001] cluster state update task [create-index [customers-raw-003282], cause [rollover_index]] took [32.2s] above the warn threshold of 30s\r\n[2018-02-18T15:01:56,881][DEBUG][o.e.a.a.i.s.TransportIndicesStatsAction] [elasticsearch-master-001] failed to execute [indices:monitor/stats] on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.NodeDisconnectedException: [elasticsearch-data-cold-003][10.0.0.52:9300][indices:monitor/stats[n]] disconnected\r\n[2018-02-18T15:01:56,881][DEBUG][o.e.a.a.i.s.TransportIndicesStatsAction] [elasticsearch-master-001] failed to execute [indices:monitor/stats] on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.NodeDisconnectedException: [elasticsearch-data-cold-003][10.0.0.52:9300][indices:monitor/stats[n]] disconnected\r\n[2018-02-18T15:01:56,899][DEBUG][o.e.a.a.c.n.s.TransportNodesStatsAction] [elasticsearch-master-001] failed to execute on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.NodeDisconnectedException: [elasticsearch-data-cold-003][10.0.0.52:9300][cluster:monitor/nodes/stats[n]] disconnected\r\n[2018-02-18T15:01:58,094][WARN ][o.e.c.NodeConnectionsService] [elasticsearch-master-001] failed to connect to node {elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} (tried [1] times)\r\norg.elasticsearch.transport.ConnectTransportException: [elasticsearch-data-cold-003][10.0.0.52:9300] connect_timeout[30s]\r\n\tat org.elasticsearch.transport.netty4.Netty4Transport.connectToChannels(Netty4Transport.java:284) ~[?:?]\r\n\tat org.elasticsearch.transport.TcpTransport.openConnection(TcpTransport.java:591) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TcpTransport.connectToNode(TcpTransport.java:495) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:334) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:321) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.NodeConnectionsService.validateAndConnectIfNeeded(NodeConnectionsService.java:154) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.NodeConnectionsService$ConnectionChecker.doRun(NodeConnectionsService.java:183) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\nCaused by: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: 10.0.0.52/10.0.0.52:9300\r\n\tat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]\r\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]\r\n\tat io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]\r\n\tat io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:340) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) ~[?:?]\r\n\t... 1 more\r\nCaused by: java.net.ConnectException: Connection refused\r\n\tat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]\r\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]\r\n\tat io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:352) ~[?:?]\r\n\tat io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:340) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:632) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[?:?]\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[?:?]\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) ~[?:?]\r\n\t... 1 more\r\n```\r\n\r\nFollowing that are some errors about timeouts and the removal of the crashed server from the pool:\r\n\r\n```\r\n[2018-02-18T15:01:59,964][INFO ][o.e.c.s.MasterService    ] [elasticsearch-master-001] zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(transport disconnected)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} transport disconnected], zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(failed to ping, tried [3] times, each with maximum [30s] timeout)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} failed to ping, tried [3] times, each with maximum [30s] timeout], reason: removed {{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold},}\r\n[2018-02-18T15:02:26,908][DEBUG][o.e.a.a.c.n.s.TransportNodesStatsAction] [elasticsearch-master-001] failed to execute on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.NodeNotConnectedException: [elasticsearch-data-cold-003][10.0.0.52:9300] Node not connected\r\n\tat org.elasticsearch.transport.TcpTransport.getConnection(TcpTransport.java:657) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TcpTransport.getConnection(TcpTransport.java:121) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.getConnection(TransportService.java:532) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:508) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction.start(TransportNodesAction.java:197) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction.doExecute(TransportNodesAction.java:89) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction.doExecute(TransportNodesAction.java:52) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:167) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:139) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:81) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:405) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient$ClusterAdmin.execute(AbstractClient.java:712) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient$ClusterAdmin.nodesStats(AbstractClient.java:808) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.updateNodeStats(InternalClusterInfoService.java:254) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.refresh(InternalClusterInfoService.java:290) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.maybeRefresh(InternalClusterInfoService.java:275) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.access$500(InternalClusterInfoService.java:68) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService$SubmitReschedulingClusterInfoUpdatedJob.lambda$run$0(InternalClusterInfoService.java:222) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n[2018-02-18T15:02:26,933][DEBUG][o.e.a.a.i.s.TransportIndicesStatsAction] [elasticsearch-master-001] failed to execute [indices:monitor/stats] on node [qbtMFuBaSfCWbVztvvi6Kg]\r\norg.elasticsearch.transport.NodeNotConnectedException: [elasticsearch-data-cold-003][10.0.0.52:9300] Node not connected\r\n\tat org.elasticsearch.transport.TcpTransport.getConnection(TcpTransport.java:657) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TcpTransport.getConnection(TcpTransport.java:121) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.getConnection(TransportService.java:532) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:495) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$AsyncAction.sendNodeRequest(TransportBroadcastByNodeAction.java:322) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$AsyncAction.start(TransportBroadcastByNodeAction.java:311) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction.doExecute(TransportBroadcastByNodeAction.java:234) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction.doExecute(TransportBroadcastByNodeAction.java:79) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:167) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:139) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:81) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:405) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient$IndicesAdmin.execute(AbstractClient.java:1253) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.client.support.AbstractClient$IndicesAdmin.stats(AbstractClient.java:1574) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.updateIndicesStats(InternalClusterInfoService.java:268) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.refresh(InternalClusterInfoService.java:319) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.maybeRefresh(InternalClusterInfoService.java:275) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService.access$500(InternalClusterInfoService.java:68) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.cluster.InternalClusterInfoService$SubmitReschedulingClusterInfoUpdatedJob.lambda$run$0(InternalClusterInfoService.java:222) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n[2018-02-18T15:02:29,994][WARN ][o.e.d.z.PublishClusterStateAction] [elasticsearch-master-001] timed out waiting for all nodes to process published state [474493] (timeout [30s], pending nodes: [{elasticsearch-master-003}{vLonCmnMQFCn4TZMNtYb6w}{V2lQPN1kSP2RnWzmpIvAYg}{10.0.0.45}{10.0.0.45:9300}, {elasticsearch-data-cold-002}{6cMfsHpHTxuQN_wcZ8FC6w}{BbOL9NBSRBSTYk3egr4Ijg}{10.0.0.38}{10.0.0.38:9300}{type=cold}, {elasticsearch-master-002}{0pqpLYZdQK-0O26N1Uts2Q}{CXWV6KDqQiGnrXkMk5fdXg}{10.0.0.44}{10.0.0.44:9300}, {elasticsearch-data-cold-001}{B93cHubSRa2i3ogHi7NoMA}{2MaiGuzrRiuEwjZcPiGGKw}{10.0.0.37}{10.0.0.37:9300}{type=cold}])\r\n[2018-02-18T15:02:29,994][INFO ][o.e.c.s.ClusterApplierService] [elasticsearch-master-001] removed {{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold},}, reason: apply cluster state (from master [master {elasticsearch-master-001}{KGg45JFdTDaySNwmNIX3_w}{TWQ_nJjXS-aQqrIxaPlQeA}{10.0.0.43}{10.0.0.43:9300} committed version [474493] source [zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(transport disconnected)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} transport disconnected], zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(failed to ping, tried [3] times, each with maximum [30s] timeout)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} failed to ping, tried [3] times, each with maximum [30s] timeout]]])\r\n[2018-02-18T15:02:56,544][INFO ][o.e.c.r.DelayedAllocationService] [elasticsearch-master-001] scheduling reroute for delayed shards in [459ms] (2691 delayed shards)\r\n[2018-02-18T15:02:56,578][WARN ][o.e.c.s.MasterService    ] [elasticsearch-master-001] cluster state update task [zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(transport disconnected)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} transport disconnected], zen-disco-node-failed({elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold}), reason(failed to ping, tried [3] times, each with maximum [30s] timeout)[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{FRoU1ZGfTZuR2VTfkCD3WQ}{10.0.0.52}{10.0.0.52:9300}{type=cold} failed to ping, tried [3] times, each with maximum [30s] timeout]] took [59.5s] above the warn threshold of 30s\r\n[2018-02-18T15:03:26,737][INFO ][o.e.c.s.MasterService    ] [elasticsearch-master-001] zen-disco-node-join[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{hJMBK9RrRTGXlsPTbBxqlg}{10.0.0.52}{10.0.0.52:9300}{type=cold}], reason: added {{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{hJMBK9RrRTGXlsPTbBxqlg}{10.0.0.52}{10.0.0.52:9300}{type=cold},}\r\n[2018-02-18T15:03:29,381][INFO ][o.e.c.s.ClusterApplierService] [elasticsearch-master-001] added {{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{hJMBK9RrRTGXlsPTbBxqlg}{10.0.0.52}{10.0.0.52:9300}{type=cold},}, reason: apply cluster state (from master [master {elasticsearch-master-001}{KGg45JFdTDaySNwmNIX3_w}{TWQ_nJjXS-aQqrIxaPlQeA}{10.0.0.43}{10.0.0.43:9300} committed version [474495] source [zen-disco-node-join[{elasticsearch-data-cold-003}{qbtMFuBaSfCWbVztvvi6Kg}{hJMBK9RrRTGXlsPTbBxqlg}{10.0.0.52}{10.0.0.52:9300}{type=cold}]]])\r\n```\r\n\r\nWhat happened following that whole thing is that Elasticsearch created the new alias (As it should have, because we called the rollover command), but it **did not delete** the old alias, thus reaching a point that is has **two** aliases, both named `customers` pointing to two **different** indices, as can be seen here:\r\n\r\n```\r\n# curl -s 'localhost:9200/_cat/aliases?v' | sort\r\nalias     index                filter routing.index routing.search\r\ncustomers customers-raw-003281     -      -             -\r\ncustomers customers-raw-003282     -      -             -\r\n```\r\n\r\nThe `customers-raw-003281` is the old index that was supposed to be rolled-over to `customers-raw-003282` by the cronjob. Apparently it managed to roll it over but not delete the old alias.\r\nThis caused the entire cluster to become un-writeable to the `customers` alias because Elasticsearch didn't know where to write the data to (I guess).\r\n\r\nWe had to manually delete the old alias reference so that the cluster will be writeable again.\r\n\r\nThere were no logs what so ever about the problem, and we had to manually figure it out by ourselves.\r\n\r\nElasticsearch appeared to be operating (health status green), nothing in the logs.\r\n\r\nLogstash only logged a message that it has an issue that it can retry and kept retrying for ever, again, with no specific log about the error.\r\n","closed_by":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}