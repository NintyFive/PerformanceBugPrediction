{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36318","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36318/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36318/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36318/events","html_url":"https://github.com/elastic/elasticsearch/issues/36318","id":388287371,"node_id":"MDU6SXNzdWUzODgyODczNzE=","number":36318,"title":"Use scheduleUnlessShuttingDown when appropriate","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":862527366,"node_id":"MDU6TGFiZWw4NjI1MjczNjY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Resiliency","name":":Core/Infra/Resiliency","color":"0e8a16","default":false,"description":"Keep running when everything is ok. Die quickly if things go horribly wrong."},{"id":837440720,"node_id":"MDU6TGFiZWw4Mzc0NDA3MjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Erefactoring","name":">refactoring","color":"dddddd","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"assignees":[{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-12-06T16:17:07Z","updated_at":"2019-01-28T08:02:46Z","closed_at":"2019-01-28T08:02:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Today we catch `ESRejectedExecutionException` in the following files:\r\n- [x] [InternalClusterInfoService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java)\r\n- [x] [ClusterApplierService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java)\r\n- [x] [MasterService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/cluster/service/MasterService.java)\r\n- [x] [EsThreadPoolExecutor](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/common/util/concurrent/EsThreadPoolExecutor.java)\r\n- [x] [MasterFaultDetection](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/discovery/zen/MasterFaultDetection.java)\r\n- [x] [NodesFaultDetection](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/discovery/zen/NodesFaultDetection.java)\r\n- [x] [WorkerBulkByScrollTaskState](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/index/reindex/WorkerBulkByScrollTaskState.java)\r\n- [x] [IndicesStore](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/indices/store/IndicesStore.java)\r\n- [x] [Scheduler](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/threadpool/Scheduler.java)\r\n- [x] [ThreadPool](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java)\r\n- [x] [TransportKeepAlive](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/transport/TransportKeepAlive.java)\r\n- [x] [TransportService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/main/java/org/elasticsearch/transport/TransportService.java)\r\n- [x] [EsExecutorsTests](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/test/java/org/elasticsearch/common/util/concurrent/EsExecutorsTests.java)\r\n- [x] [FixedThreadPoolTests](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/server/src/test/java/org/elasticsearch/threadpool/FixedThreadPoolTests.java)\r\n- [x] [ShardFollowTasksExecutor](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java)\r\n- [x] [MlDailyMaintenanceService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlDailyMaintenanceService.java)\r\n- [x] [AutodetectProcessManager](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectProcessManager.java)\r\n- [x] [NativeAutodetectProcessFactory](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/NativeAutodetectProcessFactory.java)\r\n- [x] [AutoDetectResultProcessor](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutoDetectResultProcessor.java)\r\n- [x] [NativeNormalizerProcessFactory](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/normalizer/NativeNormalizerProcessFactory.java)\r\n- [x] [CleanerService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/cleaner/CleanerService.java)\r\n- [x] [ExecutionService](https://github.com/elastic/elasticsearch/blob/afeb3992b3bfc8587de7d1acd074b9efeb3ac775/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/execution/ExecutionService.java)\r\n\r\nMany of these cases follow this pattern:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/f1135ef0ceb9c8d74ba4589c285d3cb05e908bcb/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutoDetectResultProcessor.java#L387-L397\r\n\r\nThey could therefore perhaps mostly be replaced by calls to `ThreadPool#scheduleUnlessShuttingDown()`:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/6ac0cb1842b85d5a93f036c9d0790ecb4b2b1fc3/server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java#L355-L366\r\n\r\nThis is a meta-issue to investigate this refactoring in case it's too big to do in one step.","closed_by":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}