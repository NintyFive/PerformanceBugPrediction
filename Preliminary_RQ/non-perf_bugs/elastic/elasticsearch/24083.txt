{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24083","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24083/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24083/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24083/events","html_url":"https://github.com/elastic/elasticsearch/issues/24083","id":221491596,"node_id":"MDU6SXNzdWUyMjE0OTE1OTY=","number":24083,"title":"InternalTopHistTests fails with a particular seed on master","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":620636309,"node_id":"MDU6TGFiZWw2MjA2MzYzMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-alpha2","name":"v6.0.0-alpha2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-04-13T08:21:59Z","updated_at":"2017-06-06T09:00:37Z","closed_at":"2017-05-04T17:48:49Z","author_association":"MEMBER","active_lock_reason":null,"body":"Reproduce command: \r\n```\r\ngradle :core:test -Dtests.seed=4CB60CE3DF057B4C -Dtests.class=org.elasticsearch.search.aggregations.metrics.tophits.InternalTopHitsTests -Dtests.method=\"testReduceRandom\" -Dtests.security.manager=true -Dtests.locale=sr-Latn-ME -Dtests.timezone=America/Mendoza\r\n```\r\n\r\nerror:\r\n```\r\nFAILURE 1.28s | InternalTopHitsTests.testReduceRandom <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: Didn't match expected value:\r\n   >                           hits:\r\n   >                             hits: same [empty list]\r\n   >                        max_score: expected [1.4E-45] but not found\r\n   >                            total: same [368137]\r\n   >    at __randomizedtesting.SeedInfo.seed([4CB60CE3DF057B4C:8C8BA0F2F958E21A]:0)\r\n   >    at org.elasticsearch.test.ESTestCase.assertEqualsWithErrorMessageFromXContent(ESTestCase.java:1037)\r\n   >    at org.elasticsearch.search.aggregations.metrics.tophits.InternalTopHitsTests.assertReduced(InternalTopHitsTests.java:159)\r\n   >    at org.elasticsearch.search.aggregations.metrics.tophits.InternalTopHitsTests.assertReduced(InternalTopHitsTests.java:52)\r\n   >    at org.elasticsearch.search.aggregations.InternalAggregationTestCase.testReduceRandom(InternalAggregationTestCase.java:81)\r\n   >    at java.lang.Thread.run(Thread.java:745)\r\n  2> NOTE: leaving temporary files on disk at: /Users/colings86/dev/work/git/elasticsearch-lucene7/core/build/testrun/test/J0/temp/org.elasticsearch.search.aggregations.metrics.tophits.InternalTopHitsTests_4CB60CE3DF057B4C-001\r\n  2> NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=1027, maxMBSortInHeap=5.568395574389006, sim=RandomSimilarity(queryNorm=false): {}, locale=sr-Latn-ME, timezone=America/Mendoza\r\n  2> NOTE: Mac OS X 10.12.4 x86_64/Oracle Corporation 1.8.0_112 (64-bit)/cpus=8,threads=1,free=469457424,total=514850816\r\n  2> NOTE: All tests run in this JVM: [InternalTopHitsTests]\r\nCompleted [1/1] in 2.59s, 1 test, 1 failure <<< FAILURES!\r\n```\r\n\r\nIt looks like in this case we have 1 shard to reduce which has an unmapped top hits response. The test expects the max score to be `Float.MIN_VALUE` but the actual max score is `Float.NaN`. Maybe the test should be checking if there are any hits an setting the expected max score to `Float.NAN`?\r\n\r\n/cc @nik9000  does that sound sensible to you?","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}