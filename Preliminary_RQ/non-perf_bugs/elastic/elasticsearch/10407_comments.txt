[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89102489","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-89102489","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":89102489,"node_id":"MDEyOklzc3VlQ29tbWVudDg5MTAyNDg5","user":{"login":"aphyr","id":3748,"node_id":"MDQ6VXNlcjM3NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/3748?v=4","gravatar_id":"","url":"https://api.github.com/users/aphyr","html_url":"https://github.com/aphyr","followers_url":"https://api.github.com/users/aphyr/followers","following_url":"https://api.github.com/users/aphyr/following{/other_user}","gists_url":"https://api.github.com/users/aphyr/gists{/gist_id}","starred_url":"https://api.github.com/users/aphyr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aphyr/subscriptions","organizations_url":"https://api.github.com/users/aphyr/orgs","repos_url":"https://api.github.com/users/aphyr/repos","events_url":"https://api.github.com/users/aphyr/events{/privacy}","received_events_url":"https://api.github.com/users/aphyr/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T01:06:21Z","updated_at":"2015-04-03T01:06:21Z","author_association":"NONE","body":"Potentially related: the worst data-loss incidents seem related to long-lasting split-brain, where after a 120-second partition isolating a single primary is resolved, the original node _and_ a newly elected node both believe they're the primary--even after exchanging traffic.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89107918","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-89107918","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":89107918,"node_id":"MDEyOklzc3VlQ29tbWVudDg5MTA3OTE4","user":{"login":"aphyr","id":3748,"node_id":"MDQ6VXNlcjM3NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/3748?v=4","gravatar_id":"","url":"https://api.github.com/users/aphyr","html_url":"https://github.com/aphyr","followers_url":"https://api.github.com/users/aphyr/followers","following_url":"https://api.github.com/users/aphyr/following{/other_user}","gists_url":"https://api.github.com/users/aphyr/gists{/gist_id}","starred_url":"https://api.github.com/users/aphyr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aphyr/subscriptions","organizations_url":"https://api.github.com/users/aphyr/orgs","repos_url":"https://api.github.com/users/aphyr/repos","events_url":"https://api.github.com/users/aphyr/events{/privacy}","received_events_url":"https://api.github.com/users/aphyr/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T01:33:42Z","updated_at":"2015-04-03T01:33:42Z","author_association":"NONE","body":"Here's a particularly rough case, losing 25% of documents with only primary-isolating partitions:\n\n``` clj\n{:valid? false,\n :lost\n \"#{50..53 125..128 130..149 151..170 172..194 196..217 219..239 241..263 265..286 288..309 311..331 333..355 357..378 380..392 394}\",\n :recovered\n \"#{400 448..449 451 453..454 456..459 461..464 466..469 471..474 476..484 486..489 491..494 496..498 516 619 624 629 634 639 644 647..649 651..654 656..659 661..665 667..669 671..675 677..680 682..684 686..689 691 877..879 882..884 887..889 892..894 897..899 902..904 907..909 912..914 917..919}\",\n :ok\n \"#{0..49 400 448..449 451 453..454 456..459 461..464 466..469 471..474 476..484 486..489 491..494 496..499 501..537 539..561 563..583 585..606 608..617 619 624 629 634 639 644 647..649 651..654 656..659 661..665 667..669 671..675 677..680 682..684 686..689 691..694 696..713 715..737 739..758 760..783 785..804 806..829 831..848 850 877..879 882..884 887..889 892..894 897..899 902..904 907..909 912..914 917..919 922..924 927..938 940..942 944..956 958..960 962..975 977..979 981..993 995..998 1000..1012 1014..1016 1018..1030 1032..1035 1037..1039}\",\n :recovered-frac 7/65,\n :unexpected-frac 0,\n :unexpected \"#{}\",\n :lost-frac 261/1040,\n :ok-frac 53/104}\n```\n\nThis test is 600 seconds long, where the network is stable for 10 seconds, then all nodes considering themselves the primary are isolated for 120 seconds, then the network heals and the cycle repeats. We give the cluster 20 seconds of guaranteed healthy network, then wait for the health endpoint to return green on all nodes, then wait a while just in case, and do a final read.\n\n``` clj\n            :generator (gen/phases\n                         (->> (range)\n                              (map (fn [x] {:type  :invoke\n                                            :f     :add\n                                            :value x}))\n                              gen/seq\n                              (gen/stagger 1/10)\n                              (gen/delay 1)\n                              (gen/nemesis\n                                (gen/seq (cycle\n                                           [(gen/sleep 10)\n                                            {:type :info :f :start}\n                                            (gen/sleep 120)\n                                            {:type :info :f :stop}])))\n                              (gen/time-limit 600))\n                         (gen/nemesis\n                           (gen/phases\n                             (gen/once {:type :info :f :stop})\n                             (gen/sleep 20)))\n                         (gen/clients\n                           (gen/once {:type :invoke :f :read})))}))\n```\n\nIn this test, we isolate [n4], then [n5], then [n4], and then something interesting happens: both n5 _and_ n4 consider themselves primaries, even after 120 seconds of n4 being isolated. On the next cycle round, n2 and n4 both consider themselves primaries!\n\nIn an attempt to speed up fault detection (this network is virtual with negligible latency and no contention except during simulated partitions), I've lowered the ping timeouts to the order of 2-3 seconds--the cluster seems to detect failures within ~10 seconds normally, but sometimes gets stuck!\n\n``` yaml\ndiscovery.zen.ping.timeout: 3s\n\n# After joining, send a join request with this timeout? Docs are kinda unclear\n# here.\ndiscovery.zen.join_timeout: 5s\n\n# Fault detection timeouts. Our network is super reliable and uncongested\n# except when we explicitly simulate failure, so I'm gonna lower these to speed\n# up cluster convergence.\ndiscovery.zen.fd.ping_interval: 1s\ndiscovery.zen.fd.ping_timeout: 1s\ndiscovery.zen.fd.ping_retries: 2\n\n# Publish cluster state updates more frequently\ndiscovery.zen.publish_timeout: 5s\n```\n\nI've uploaded the Jepsen history, set analysis, and elasticsearch logs (timestamps are perfectly coordinated--they're LXC containers) to https://aphyr.com/media/es-create-loss.tar.gz, if you'd like to take a look. :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89195569","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-89195569","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":89195569,"node_id":"MDEyOklzc3VlQ29tbWVudDg5MTk1NTY5","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T06:59:43Z","updated_at":"2015-04-03T06:59:43Z","author_association":"MEMBER","body":"Thx @aphyr \n\n> Elasticsearch can still lose inserted documents when a single primary node is isolated by a simple network partition\n\nThis might be #7572 , which is also documented here: http://www.elastic.co/guide/en/elasticsearch/resiliency/current/#_loss_of_documents_during_network_partition_status_ongoing \n\n> Other times, the cluster seems to get really confused\n\nThis one feels like something else, but it will require some research. Can you share the exact commit of Jepsen you used? That will help understand what exactly happened.  I'm also curious to see what effect @dakrone 's [suggestion to use scan scroll](https://twitter.com/thnetos/status/583387248759971840) will have. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89378714","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-89378714","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":89378714,"node_id":"MDEyOklzc3VlQ29tbWVudDg5Mzc4NzE0","user":{"login":"aphyr","id":3748,"node_id":"MDQ6VXNlcjM3NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/3748?v=4","gravatar_id":"","url":"https://api.github.com/users/aphyr","html_url":"https://github.com/aphyr","followers_url":"https://api.github.com/users/aphyr/followers","following_url":"https://api.github.com/users/aphyr/following{/other_user}","gists_url":"https://api.github.com/users/aphyr/gists{/gist_id}","starred_url":"https://api.github.com/users/aphyr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aphyr/subscriptions","organizations_url":"https://api.github.com/users/aphyr/orgs","repos_url":"https://api.github.com/users/aphyr/repos","events_url":"https://api.github.com/users/aphyr/events{/privacy}","received_events_url":"https://api.github.com/users/aphyr/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T18:11:27Z","updated_at":"2015-04-03T18:11:27Z","author_association":"NONE","body":"Hi @bleskes! This is from Jepsen 4fdf509d82620ac59b4daf4e6a21f9495c73e68a--just `cd elasticsearch; lein test`. I've been breaking up the test suites in hopes of actually having Jepsen As A Library instead of a big monolithic hairball, haha. Slow going so far. ;-)\n\nI've also switched to using scan scroll, but it doesn't seem to have any effect on observed data loss--I can reproduce it with both a `size: n` query or a scrolling one.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90621695","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-90621695","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":90621695,"node_id":"MDEyOklzc3VlQ29tbWVudDkwNjIxNjk1","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2015-04-07T16:02:48Z","updated_at":"2015-04-07T16:02:48Z","author_association":"MEMBER","body":"Hi @aphyr , I've been looking through the https://aphyr.com/media/es-create-loss.tar.gz logs that you provided, however, it looks like the history.edn timestamps are nanoseconds relative to the time that the test was started.\n\nCould you add or modify the timestamps to be absolute instead of relative so we can correlate the logs from the ES instances to the Jepsen history?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90982197","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-90982197","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":90982197,"node_id":"MDEyOklzc3VlQ29tbWVudDkwOTgyMTk3","user":{"login":"aphyr","id":3748,"node_id":"MDQ6VXNlcjM3NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/3748?v=4","gravatar_id":"","url":"https://api.github.com/users/aphyr","html_url":"https://github.com/aphyr","followers_url":"https://api.github.com/users/aphyr/followers","following_url":"https://api.github.com/users/aphyr/following{/other_user}","gists_url":"https://api.github.com/users/aphyr/gists{/gist_id}","starred_url":"https://api.github.com/users/aphyr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aphyr/subscriptions","organizations_url":"https://api.github.com/users/aphyr/orgs","repos_url":"https://api.github.com/users/aphyr/repos","events_url":"https://api.github.com/users/aphyr/events{/privacy}","received_events_url":"https://api.github.com/users/aphyr/received_events","type":"User","site_admin":false},"created_at":"2015-04-08T17:31:39Z","updated_at":"2015-04-08T17:31:39Z","author_association":"NONE","body":"Sorry, I've got a huge backlog at the moment and have to get slides prepped, but you can just flip https://github.com/aphyr/jepsen/blob/master/jepsen/src/jepsen/core.clj#L114 to use (System/currentTimeMillis) if you want unix timestamps. Be advised that Jepsen has facilities for lying to the database about what time it is--those aren't currently in play on the Elasticsearch tests, but I wouldn't rely on the log timestamps going forward. ;-)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/97022642","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-97022642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":97022642,"node_id":"MDEyOklzc3VlQ29tbWVudDk3MDIyNjQy","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2015-04-28T11:14:09Z","updated_at":"2015-04-28T11:14:09Z","author_association":"MEMBER","body":"A quick update on this one - we have put some time into reproducing this and it looks more and more like #7572 . I will post an update once this becomes definite (or if anything else comes up).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/218735617","html_url":"https://github.com/elastic/elasticsearch/issues/10407#issuecomment-218735617","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","id":218735617,"node_id":"MDEyOklzc3VlQ29tbWVudDIxODczNTYxNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-12T11:55:11Z","updated_at":"2016-05-12T11:55:11Z","author_association":"CONTRIBUTOR","body":"Closed as duplicate of #7572\n","performed_via_github_app":null}]