{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16164","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16164/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16164/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16164/events","html_url":"https://github.com/elastic/elasticsearch/issues/16164","id":128044560,"node_id":"MDU6SXNzdWUxMjgwNDQ1NjA=","number":16164,"title":"Third level of aggregation sometimes results in missing sub-bucket data","user":{"login":"zdrummond","id":1627527,"node_id":"MDQ6VXNlcjE2Mjc1Mjc=","avatar_url":"https://avatars3.githubusercontent.com/u/1627527?v=4","gravatar_id":"","url":"https://api.github.com/users/zdrummond","html_url":"https://github.com/zdrummond","followers_url":"https://api.github.com/users/zdrummond/followers","following_url":"https://api.github.com/users/zdrummond/following{/other_user}","gists_url":"https://api.github.com/users/zdrummond/gists{/gist_id}","starred_url":"https://api.github.com/users/zdrummond/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zdrummond/subscriptions","organizations_url":"https://api.github.com/users/zdrummond/orgs","repos_url":"https://api.github.com/users/zdrummond/repos","events_url":"https://api.github.com/users/zdrummond/events{/privacy}","received_events_url":"https://api.github.com/users/zdrummond/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2016-01-21T23:19:49Z","updated_at":"2016-02-28T22:26:08Z","closed_at":"2016-02-24T17:32:11Z","author_association":"NONE","active_lock_reason":null,"body":"When I ask ES for an aggregation, by time, of the sum of a size by ID; I get a result where some events work correctly (end up in bucket with the correct term key), but other data, seemingly randomly, ends up with a blank term key\n\nFor example, with this as my aggs\n\n```\n \"aggs\": {\n    \"2\": {\n      \"date_histogram\": {\n        \"field\": \"@timestamp\",\n        \"interval\": \"1m\",\n        \"time_zone\": \"America/Los_Angeles\",\n        \"min_doc_count\": 1,\n        \"extended_bounds\": {\n          \"min\": 1452209723842,\n          \"max\": 1452214986379\n        }\n      },\n      \"aggs\": {\n        \"3\": {\n          \"terms\": {\n            \"field\": \"collection_id.raw\",\n            \"size\": 0,\n            \"order\": {\n              \"1\": \"desc\"\n            }\n          },\n          \"aggs\": {\n            \"1\": {\n              \"sum\": {\n                \"field\": \"size\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n```\n\nI get the the following result \n...\n\n```\n \"aggregations\": {\n    \"2\": {\n      \"buckets\": [\n        {\n          \"3\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n----->      \"buckets\": []         <---- NOTE: This is where the data is missing\n          },\n          \"key_as_string\": \"2016-01-07T15:38:00.000-08:00\",\n          \"key\": 1452209880000,\n          \"doc_count\": 1\n        },\n        {\n          \"3\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n              {\n                \"1\": {\n                  \"value\": 140355866\n                },\n                \"key\": \"19488\",\n                \"doc_count\": 43\n              }\n            ]\n          },\n          \"key_as_string\": \"2016-01-07T16:59:00.000-08:00\",\n          \"key\": 1452214740000,\n          \"doc_count\": 43\n        },\n        {\n          \"3\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n              {\n                \"1\": {\n                  \"value\": 63037240\n                },\n                \"key\": \"19488\",\n                \"doc_count\": 8\n              }\n            ]\n          },\n          \"key_as_string\": \"2016-01-07T17:01:00.000-08:00\",\n          \"key\": 1452214860000,\n          \"doc_count\": 8\n        }\n      ]\n    }\n  }\n```\n\nNote that I get three buckets. Two of them have a value in their \"sub\" `buckets`, one of them does not. \n\nIf i dig into the Event data, I see nothing odd about them, Here is a snippet for an event that does get into a well defined bucket, \n\n```\n@timestamp      January 7th 2016, 16:59:32.000\nt@version       1\nt_id        AVIevu0_l2HWhQn5VZHu\nt_index     logstash-2016.01.08\n...     \ncollection_id       19488\n```\n\nand one that does not. Note they have all the same keys, and very similar values. \n\n```\n@timestamp      January 7th 2016, 15:38:33.000\nt@version       1\nt_id        AVIedMH2l2HWhQn5U0QH\nt_index     logstash-2016.01.07\n...\ncollection_id       19456\n```\n\nNo idea what is going on, and what makes some data special and others not so much.\n","closed_by":{"login":"zdrummond","id":1627527,"node_id":"MDQ6VXNlcjE2Mjc1Mjc=","avatar_url":"https://avatars3.githubusercontent.com/u/1627527?v=4","gravatar_id":"","url":"https://api.github.com/users/zdrummond","html_url":"https://github.com/zdrummond","followers_url":"https://api.github.com/users/zdrummond/followers","following_url":"https://api.github.com/users/zdrummond/following{/other_user}","gists_url":"https://api.github.com/users/zdrummond/gists{/gist_id}","starred_url":"https://api.github.com/users/zdrummond/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zdrummond/subscriptions","organizations_url":"https://api.github.com/users/zdrummond/orgs","repos_url":"https://api.github.com/users/zdrummond/repos","events_url":"https://api.github.com/users/zdrummond/events{/privacy}","received_events_url":"https://api.github.com/users/zdrummond/received_events","type":"User","site_admin":false},"performed_via_github_app":null}