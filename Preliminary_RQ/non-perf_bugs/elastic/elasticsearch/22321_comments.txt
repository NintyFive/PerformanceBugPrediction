[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/268991646","html_url":"https://github.com/elastic/elasticsearch/issues/22321#issuecomment-268991646","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321","id":268991646,"node_id":"MDEyOklzc3VlQ29tbWVudDI2ODk5MTY0Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-23T13:44:32Z","updated_at":"2016-12-23T13:44:32Z","author_association":"CONTRIBUTOR","body":"@martijnvg please could you take a look","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269328528","html_url":"https://github.com/elastic/elasticsearch/issues/22321#issuecomment-269328528","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321","id":269328528,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTMyODUyOA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-12-27T13:48:56Z","updated_at":"2016-12-27T13:48:56Z","author_association":"MEMBER","body":"@clintongormley This looks to be caused by the fact breadth first collection mode is used. Using the same query with depth first collection mode succeeds:\r\n\r\n```\r\ncurl -XPOST \"http://localhost:9200/test/test/_search\" -d'\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"multi_match\": {\r\n            \"query\": \"apple iphone\",\r\n            \"fields\": [\r\n              \"name\",\r\n              \"content\"\r\n            ]\r\n          }\r\n        }\r\n      ],\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"brand_id\": {\r\n              \"value\": 26303000\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"global\": {\r\n      \"global\": {},\r\n      \"aggs\": {\r\n        \"brand\": {\r\n          \"terms\": {\r\n            \"field\": \"brand_id\",\r\n            \"collect_mode\" : \"depth_first\"\r\n          },\r\n          \"aggs\": {\r\n            \"name\": {\r\n              \"top_hits\": {\r\n                \"size\": 1\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\nLooking at `BestBucketsDeferringCollector.java`, it doesn't take into account that it may be used in a global aggregation when scores are needed. For example that the main query has matches for all segments and that the saved docids are the same to the matching docid with the main query are not true. I'll try to think about a proper fix.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/288786609","html_url":"https://github.com/elastic/elasticsearch/issues/22321#issuecomment-288786609","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321","id":288786609,"node_id":"MDEyOklzc3VlQ29tbWVudDI4ODc4NjYwOQ==","user":{"login":"sundarv85","id":11090193,"node_id":"MDQ6VXNlcjExMDkwMTkz","avatar_url":"https://avatars0.githubusercontent.com/u/11090193?v=4","gravatar_id":"","url":"https://api.github.com/users/sundarv85","html_url":"https://github.com/sundarv85","followers_url":"https://api.github.com/users/sundarv85/followers","following_url":"https://api.github.com/users/sundarv85/following{/other_user}","gists_url":"https://api.github.com/users/sundarv85/gists{/gist_id}","starred_url":"https://api.github.com/users/sundarv85/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sundarv85/subscriptions","organizations_url":"https://api.github.com/users/sundarv85/orgs","repos_url":"https://api.github.com/users/sundarv85/repos","events_url":"https://api.github.com/users/sundarv85/events{/privacy}","received_events_url":"https://api.github.com/users/sundarv85/received_events","type":"User","site_admin":false},"created_at":"2017-03-23T16:56:12Z","updated_at":"2017-03-23T16:56:58Z","author_association":"NONE","body":"+1 \r\n\r\nElasticsearch version: 5.1.1\r\n\r\nOS version: Ubuntu 14, x86_64\r\n\r\nWe are also facing the same issue with on a parent-child, terms+top_hit aggregation. On the below question, we get a null_pointer_exception, unless we add the above suggested workaround of `\"collect_mode\" : \"depth_first\"`\r\n\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"filter\": {\r\n            \"ids\": {\r\n              \"type\": \"parenttype\",\r\n              \"values\": [\r\n                \"AVr69LpqdvPuInEFv3Bg33\"\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"test\": {\r\n      \"aggregations\": {\r\n        \"stats\": {\r\n          \"aggregations\": {\r\n            \"usersuser.id\": {\r\n              \"aggregations\": {\r\n                \"fetchSources\": {\r\n                  \"top_hits\": {\r\n                    \"_source\": {\r\n                      \"excludes\": [],\r\n                      \"includes\": [\r\n                        \"name\",\r\n                      ]\r\n                    },\r\n                    \"size\": 1\r\n                  }\r\n                }\r\n              },\r\n              \"terms\": {\r\n                \"field\": \"uniqueid\",\r\n                \"size\": 500,\r\n                \"collect_mode\": \"depth_first\"  ==> Only addition of this fixes the problem\r\n              }\r\n            }\r\n          },\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"range\": {\r\n                    \"timestamp\": {\r\n                      \"from\": \"now-1d\",\r\n                      \"include_lower\": true,\r\n                      \"include_upper\": true,\r\n                      \"to\": null\r\n                    }\r\n                  }\r\n                },\r\n                {\r\n                  \"term\": {\r\n                    \"pid\": \"pqdvPuI\"\r\n                  }\r\n                },\r\n                {\r\n                  \"parent_id\": {\r\n                    \"id\": \"AVr69LpqdvPuInEFv3Bg33\",\r\n                    \"type\": \"childtype\"\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"children\": {\r\n        \"type\": \"childtype\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null}]