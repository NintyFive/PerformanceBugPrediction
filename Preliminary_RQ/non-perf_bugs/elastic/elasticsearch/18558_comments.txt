[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/221398381","html_url":"https://github.com/elastic/elasticsearch/issues/18558#issuecomment-221398381","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18558","id":221398381,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMTM5ODM4MQ==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-05-24T20:55:34Z","updated_at":"2016-05-24T20:55:34Z","author_association":"CONTRIBUTOR","body":"Could be related (though not the same) as: https://github.com/elastic/elasticsearch/issues/17767\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/221847588","html_url":"https://github.com/elastic/elasticsearch/issues/18558#issuecomment-221847588","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18558","id":221847588,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMTg0NzU4OA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-05-26T11:37:14Z","updated_at":"2016-05-26T11:37:14Z","author_association":"CONTRIBUTOR","body":"The lines that lead to the failure are\n\n```\nassertAcked(client().admin().indices().prepareDelete(\"test\"));\nmeta = gwMetaState.loadMetaState();\n```\n\nTo understand why this fails, it is important to know that acknowledgment of deletion can happen before the new cluster state containing the deletion has been written to disk, even if the cluster is only single-node.\nNow, the way `loadMetaState` works is by listing the directory contents to find the _latest_ meta state file.  Latest means state file with highest version identifier attached to it. In a second step, it tries to read the file. If the meta state file has been replaced in the meanwhile by an updated version (and the old version deleted), we try to read the file that has been deleted.\n\nloadMetaState() is only safe to call from the cluster state update thread, the same thread where we write the state files.\n\nTo fix the test, we could add the line\n\n```\nassertBusy(() -> assertThat(client().admin().cluster().preparePendingClusterTasks().get().getPendingTasks(), empty()));\n```\n\nbetween the index deletion and loadMetaState(). @bleskes what do you think?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/221849910","html_url":"https://github.com/elastic/elasticsearch/issues/18558#issuecomment-221849910","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18558","id":221849910,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMTg0OTkxMA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-05-26T11:50:26Z","updated_at":"2016-05-26T11:50:35Z","author_association":"MEMBER","body":"I think there are two things that are wrong here:\n\n1) Delete index should wait for both node ack and cluster publishing to complete.\n2) loadMetaState() and state writign should be thread safe. It's very trappy now.  We could do through in memory locks, but file based RW locks will be better. @s1monw any thoughts here?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/221936070","html_url":"https://github.com/elastic/elasticsearch/issues/18558#issuecomment-221936070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18558","id":221936070,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMTkzNjA3MA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-05-26T17:18:14Z","updated_at":"2016-05-26T17:18:14Z","author_association":"CONTRIBUTOR","body":"I've opened #18602 for the first issue.\n","performed_via_github_app":null}]