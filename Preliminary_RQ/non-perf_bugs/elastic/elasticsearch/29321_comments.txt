[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/377607686","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-377607686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":377607686,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NzYwNzY4Ng==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-30T19:52:03Z","updated_at":"2018-03-30T19:52:03Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/379113976","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-379113976","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":379113976,"node_id":"MDEyOklzc3VlQ29tbWVudDM3OTExMzk3Ng==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-04-06T00:20:05Z","updated_at":"2018-04-06T00:28:19Z","author_association":"CONTRIBUTOR","body":"I looked at this today. It appears to me that the majority of connections use the `TransportService` `openConnection` method to open the connection (which is not managed by the `TransportService`). However, one node is picked as the \"handshake node\". This node is officially added to the `TransportService` through the `connectToNode` method. I *think* that this means that the cross-cluster search profile is stored in the `TransportService` and used for that node's connection (if it is registered first).\r\n\r\nI'm not super familiar with the cross-cluster search design. But I assume registering the handshake node with the `TransportService` is intentional @s1monw?\r\n\r\nWe should consider:\r\n1. If we want cross-cluster search nodes to be registered with the `TransportService`.\r\n2. Adding validation to prevent adding your the current cluster as a cluster for cross-cluster search.\r\n\r\nIn `RemoteClusterConnection`: \r\n\r\n```\r\n     try {\r\n        handshakeNode = transportService.handshake(connection, remoteProfile.getHandshakeTimeout().millis(),\r\n            (c) -> remoteClusterName.get() == null ? true : c.equals(remoteClusterName.get()));\r\n    } catch (IllegalStateException ex) {\r\n        logger.warn((Supplier<?>) () -> new ParameterizedMessage(\"seed node {} cluster name mismatch expected \" +\r\n            \"cluster name {}\", connection.getNode(), remoteClusterName.get()), ex);\r\n        throw ex;\r\n    }\r\n                            if (nodePredicate.test(handshakeNode) && connectedNodes.size() < maxNumRemoteConnections) {\r\n        transportService.connectToNode(handshakeNode, remoteProfile);\r\n        connectedNodes.add(handshakeNode);\r\n    }\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385705154","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-385705154","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":385705154,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTcwNTE1NA==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-05-01T15:48:13Z","updated_at":"2018-05-01T15:48:13Z","author_association":"CONTRIBUTOR","body":"I just wanted to ping about this issue @s1monw. @jasontedor wanted me to investigate and the last comment I posted was the results of what I found. I'm not sure what action we want to take now (such as: preventing adding the current cluster in settings or if there is something about the \"handshake node\" concept that we need to change).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/393544394","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-393544394","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":393544394,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzU0NDM5NA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-05-31T14:14:56Z","updated_at":"2018-05-31T14:14:56Z","author_association":"CONTRIBUTOR","body":"@tbrooks8 this can only happen if we are connecting to a node in the same cluster right? I mean if it's a remote node we should be connected to it. so is this what is happening here?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/393548743","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-393548743","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":393548743,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzU0ODc0Mw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-05-31T14:28:05Z","updated_at":"2018-05-31T14:28:05Z","author_association":"CONTRIBUTOR","body":"I think a simple fix would be a to compare the local cluster uuid to the remote uuid and then don't pass the profie. This should be doable. @tbrooks8 @javanna   WDYT?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/393602949","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-393602949","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":393602949,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzYwMjk0OQ==","user":{"login":"treyd","id":2250205,"node_id":"MDQ6VXNlcjIyNTAyMDU=","avatar_url":"https://avatars1.githubusercontent.com/u/2250205?v=4","gravatar_id":"","url":"https://api.github.com/users/treyd","html_url":"https://github.com/treyd","followers_url":"https://api.github.com/users/treyd/followers","following_url":"https://api.github.com/users/treyd/following{/other_user}","gists_url":"https://api.github.com/users/treyd/gists{/gist_id}","starred_url":"https://api.github.com/users/treyd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/treyd/subscriptions","organizations_url":"https://api.github.com/users/treyd/orgs","repos_url":"https://api.github.com/users/treyd/repos","events_url":"https://api.github.com/users/treyd/events{/privacy}","received_events_url":"https://api.github.com/users/treyd/received_events","type":"User","site_admin":false},"created_at":"2018-05-31T17:04:24Z","updated_at":"2018-05-31T17:04:24Z","author_association":"NONE","body":"Just wanted to add my perspective as a user about the CCS configuration and adding a remote cluster pointing to itself... to me, it actually makes more sense to have the same cross cluster search configuration in all clusters who are using each other for search.  My use case (described also in https://github.com/elastic/elasticsearch/issues/27006#issuecomment-393599946) has multiple clusters that I deploy along side a multi-data center system to index that system's logs, and so I'd like each cluster to be able to search across logs in both data centers.  I'd prefer to have the same CCS configuration in both clusters, e.g.:\r\n\r\n```\r\nsearch:\r\n    remote:\r\n        region1: \r\n            seeds: 10.0.10.10:9300\r\n        region2: \r\n            seeds: 10.0.20.10:9301\r\n```\r\n\r\nThis also has the benefit of being able to use the search API the same way in both clusters (e.g. `GET *:logstash-*/_search`), and explicitly see which cluster the results are coming from.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/393701013","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-393701013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":393701013,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzcwMTAxMw==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-05-31T22:25:53Z","updated_at":"2018-05-31T22:25:53Z","author_association":"CONTRIBUTOR","body":"@s1monw - I don't follow your suggested fix. But essentially as @treyd describes, some users reuse cross-cluster search configs between clusters. This leads to a configs having the \"local\" cluster added to the `search.remote` configs.\r\n\r\nWhen we open a connection to the remote cluster nodes, we create a managed connection in the `TransportService`. Once the `TransportService` has a connection opened it reuses that for further attempts to create a open a managed connection. So if the `RemoteClusterConnection` opens a connection to a local node before the normal connection is opened by the cluster, the remote cluster search connection is used for normal cluster operations (by the `TransportService`). Unfortunately, the remote cluster connection does not have connections configured for normal cluster operations such as `bulk`. This eventually leads to an exception being thrown.\r\n\r\nIt seems to me that a reasonable fix would be to detect if the node is a member of the local cluster, do not open a managed connection from the `RemoteClusterConnection`, and log a warning.\r\n\r\nIf we knew the cluster uuid of the node we are connecting to prior opening a managed connection that would work. We do open a non-managed connection and make a `HandshakeRequest`. The `HandshakeResponse` returns the `clusterName`. Is that the uuid you are referring to? We could propagate the `HandshakeResponse` back from the `TransportService` (right now we only pass the `DiscoveryNode` back) to know if this node belongs to the local cluster.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394404363","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-394404363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":394404363,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDQwNDM2Mw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T15:50:08Z","updated_at":"2018-06-04T15:50:08Z","author_association":"CONTRIBUTOR","body":"> It seems to me that a reasonable fix would be to detect if the node is a member of the local cluster, do not open a managed connection from the RemoteClusterConnection, and log a warning.\r\n\r\n++\r\n\r\n> If we knew the cluster uuid of the node we are connecting to prior opening a managed connection that would work. We do open a non-managed connection and make a HandshakeRequest. The HandshakeResponse returns the clusterName. Is that the uuid you are referring to? We could propagate the HandshakeResponse back from the TransportService (right now we only pass the DiscoveryNode back) to know if this node belongs to the local cluster.\r\n\r\nthat's the one I was referring to. Yet, I think we could also skip adding the managed connection until we fetch the cluster state and only add it there if we really need to. WDYT?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394411538","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-394411538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":394411538,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDQxMTUzOA==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T16:11:21Z","updated_at":"2018-06-04T16:11:21Z","author_association":"CONTRIBUTOR","body":"> that's the one I was referring to. Yet, I think we could also skip adding the managed connection until we fetch the cluster state and only add it there if we really need to. WDYT?\r\n\r\nYes I think that fix would work.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395328495","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-395328495","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":395328495,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTMyODQ5NQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-06-07T07:57:00Z","updated_at":"2018-06-07T07:57:00Z","author_association":"CONTRIBUTOR","body":"@tbrooks8 are you going to look into it?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395646951","html_url":"https://github.com/elastic/elasticsearch/issues/29321#issuecomment-395646951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29321","id":395646951,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTY0Njk1MQ==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T04:56:24Z","updated_at":"2018-06-08T04:56:24Z","author_association":"CONTRIBUTOR","body":"Yeah sometime in the next few days.","performed_via_github_app":null}]