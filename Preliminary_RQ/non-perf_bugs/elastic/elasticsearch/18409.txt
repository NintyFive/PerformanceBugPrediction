{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18409","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18409/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18409/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18409/events","html_url":"https://github.com/elastic/elasticsearch/issues/18409","id":155281260,"node_id":"MDU6SXNzdWUxNTUyODEyNjA=","number":18409,"title":"Using nested agg after reverse_nested shows higher count than expected","user":{"login":"chevin99","id":7562346,"node_id":"MDQ6VXNlcjc1NjIzNDY=","avatar_url":"https://avatars0.githubusercontent.com/u/7562346?v=4","gravatar_id":"","url":"https://api.github.com/users/chevin99","html_url":"https://github.com/chevin99","followers_url":"https://api.github.com/users/chevin99/followers","following_url":"https://api.github.com/users/chevin99/following{/other_user}","gists_url":"https://api.github.com/users/chevin99/gists{/gist_id}","starred_url":"https://api.github.com/users/chevin99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chevin99/subscriptions","organizations_url":"https://api.github.com/users/chevin99/orgs","repos_url":"https://api.github.com/users/chevin99/repos","events_url":"https://api.github.com/users/chevin99/events{/privacy}","received_events_url":"https://api.github.com/users/chevin99/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-05-17T14:55:52Z","updated_at":"2016-05-17T18:44:22Z","closed_at":"2016-05-17T18:44:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.2.0\n**JVM version**:\njava version \"1.8.0_05\"\nJava(TM) SE Runtime Environment (build 1.8.0_05-b13)\nJava HotSpot(TM) 64-Bit Server VM (build 25.5-b02, mixed mode)\n\n**OS version**: OSX Yosemite 10.10.2\n\nI am doing this:\n1. Grouping by a nested field: `nested_path.nested_field`\n2. Using a reverse_nested agg so I can apply this filter: `non_nested_field == \"yay\"`\n3. Using a nested agg so I can then get a count of the nested field I am grouping by: `nested_path.nested_field`\n\nProblem: By using the reverse_nested agg I am getting a higher doc_count than I would expect.\n\nHere is the mapping and docs I am indexing:\n\n```\nPUT /my_index\n{\n   \"mappings\": {\n      \"my_type\": {\n         \"properties\": {\n            \"nested_path\": {\n               \"type\": \"nested\",\n               \"properties\": {\n                  \"nested_field\": {\n                     \"type\": \"string\"\n                  }\n               }\n            },\n            \"non_nested_field\": {\n               \"type\": \"string\"\n            }\n         }\n      }\n   }\n}\n\nPOST /my_index/my_type/1\n{\n  \"non_nested_field\": \"whoray\",\n  \"nested_path\": [\n    {\n      \"nested_field\": \"yes\"\n    },\n    {\n      \"nested_field\": \"yes\"\n    },\n    {\n      \"nested_field\": \"no\"\n    }\n  ]\n}\n\nPOST /my_index/my_type/2\n{\n  \"non_nested_field\": \"yay\",\n  \"nested_path\": [\n    {\n      \"nested_field\": \"maybe\"\n    },\n    {\n      \"nested_field\": \"no\"\n    }\n  ]\n}\n```\n\nSearch request:\n\n```\nPOST my_index/my_type/_search\n{\n   \"aggs\": {\n      \"nested_option\": {\n         \"nested\": {\n            \"path\": \"nested_path\"\n         },\n         \"aggs\": {\n            \"group_list\": {\n               \"terms\": {\n                  \"field\": \"nested_path.nested_field\",\n                  \"size\": 100\n               },\n               \"aggs\": {\n                  \"level_1\": {\n                     \"reverse_nested\": {},\n                     \"aggs\": {\n                        \"level_2\": {\n                           \"filter\": {\n                              \"term\": {\n                                 \"non_nested_field\": \"yay\"\n                              }\n                           },\n                           \"aggs\": {\n                              \"level_3\": {\n                                 \"nested\": {\n                                    \"path\": \"nested_path\"\n                                 },\n                                 \"aggs\": {\n                                    \"stat\": {\n                                       \"value_count\": {\n                                          \"field\": \"nested_path.nested_field\"\n                                       }\n                                    }\n                                 }\n                              }\n                           }\n                        }\n                     }\n                  }\n               }\n            }\n         }\n      }\n   },\n   \"size\": 0\n}\n```\n\nPart of the response I get is this:\n\n```\n{  \n  \"aggregations\": {\n    \"nested_option\": {\n      \"doc_count\": 5,\n      \"group_list\": {\n        \"buckets\": [\n          {\n            \"key\": \"no\",\n            \"doc_count\": 2,\n            \"level_1\": {\n              \"doc_count\": 2,\n              \"level_2\": {\n                \"doc_count\": 1,\n                \"level_3\": {\n                  \"doc_count\": 2,\n                  \"stat\": {\n                    \"value\": 2\n                  }\n                }\n              }\n            }\n          }\n          //.... \n        ]\n      }\n    }\n  }\n}\n```\n\nIn the first element of the buckets array in the response, `level_1.level_2.doc_count` is 1, and this is correct, because there's only one of the two docs indexed where `nested_path.nested_field == \"no\"` and `non_nested_field == \"yay\"`. But `level_1.level_2.level_3.doc_count` in the response is 2. It should only be 1. This seems like a bug to me.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}