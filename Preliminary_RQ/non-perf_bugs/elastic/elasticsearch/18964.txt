{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18964","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18964/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18964/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18964/events","html_url":"https://github.com/elastic/elasticsearch/issues/18964","id":161091753,"node_id":"MDU6SXNzdWUxNjEwOTE3NTM=","number":18964,"title":"ReplicaAfterPrimaryActiveAllocationDecider prevent shard promotion","user":{"login":"floragunn","id":11678154,"node_id":"MDQ6VXNlcjExNjc4MTU0","avatar_url":"https://avatars3.githubusercontent.com/u/11678154?v=4","gravatar_id":"","url":"https://api.github.com/users/floragunn","html_url":"https://github.com/floragunn","followers_url":"https://api.github.com/users/floragunn/followers","following_url":"https://api.github.com/users/floragunn/following{/other_user}","gists_url":"https://api.github.com/users/floragunn/gists{/gist_id}","starred_url":"https://api.github.com/users/floragunn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/floragunn/subscriptions","organizations_url":"https://api.github.com/users/floragunn/orgs","repos_url":"https://api.github.com/users/floragunn/repos","events_url":"https://api.github.com/users/floragunn/events{/privacy}","received_events_url":"https://api.github.com/users/floragunn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-06-19T20:51:57Z","updated_at":"2016-06-20T07:08:30Z","closed_at":"2016-06-20T07:08:30Z","author_association":"NONE","active_lock_reason":null,"body":"I have a three node ES 2.3.3 cluster with an index `myindex` consisting of one shard an 2 replicas and a few document in it. If i should down all nodes and then start only one of them the  `myindex`status is red with all shards unassigned. If i now change the replica count of  `myindex` to 1 or 0 the index becomes green. \n\nSteps to reproduce:\n- Start one ES node (Version 2.3.3)\n- Create a new empty index `myindex` with one shard and two (or more) replicas\n- Shutdown ES\n- Start ES, cluster is red and you will see logs like that:\n\n<pre>\n[2016-06-19 22:30:34,519][TRACE][gateway                  ] [Ent] found state file: [id:7, legacy:false, file:/Users/temp/alloc-test/elasticsearch-2.3.3-2/data/altest_12771/nodes/0/indices/myindex/_state/state-7.st]\n[2016-06-19 22:30:34,545][TRACE][gateway                  ] [Ent] found state file: [id:7, legacy:false, file:/Users/temp/alloc-test/elasticsearch-2.3.3-2/data/altest_12771/nodes/0/indices/myindex/_state/state-7.st]\n[2016-06-19 22:30:37,674][TRACE][gateway                  ] [Ent] found state file: [id:7, legacy:false, file:/Users/temp/alloc-test/elasticsearch-2.3.3-2/data/altest_12771/nodes/0/indices/myindex/_state/state-7.st]\n[2016-06-19 22:30:37,713][TRACE][gateway                  ] [Ent] [myindex][0] fetching [shard_started] from [uQ85ko_PTaudfHrjdj00vw]\n[2016-06-19 22:30:37,713][TRACE][gateway                  ] [Ent] [myindex][0] loading local shard state info\n[2016-06-19 22:30:37,713][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]: ignoring allocation, still fetching shard started state\n[2016-06-19 22:30:37,714][TRACE][gateway                  ] [Ent] found state file: [id:1, legacy:false, file:/Users/temp/alloc-test/elasticsearch-2.3.3-2/data/altest_12771/nodes/0/indices/myindex/0/_state/state-1.st]\n[2016-06-19 22:30:37,715][DEBUG][gateway                  ] [Ent] [myindex][0] shard state info found: [version [4], primary [false]]\n[2016-06-19 22:30:37,715][TRACE][gateway                  ] [Ent] [myindex][0] processing fetched [shard_started] results\n[2016-06-19 22:30:37,716][TRACE][gateway                  ] [Ent] [myindex][0] marking uQ85ko_PTaudfHrjdj00vw as done for [shard_started]\n[2016-06-19 22:30:37,716][TRACE][gateway                  ] [Ent] [myindex][0] scheduling reroute for post_response\n[2016-06-19 22:30:37,719][TRACE][cluster.routing.allocation.decider] [Ent] Can not allocate [[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]] on node [uQ85ko_PTaudfHrjdj00vw] due to [ReplicaAfterPrimaryActiveAllocationDecider]\n[2016-06-19 22:30:37,719][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]: ignoring allocation, can't be allocated on any node\n[2016-06-19 22:30:37,719][TRACE][cluster.routing.allocation.decider] [Ent] Can not allocate [[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]] on node [uQ85ko_PTaudfHrjdj00vw] due to [ReplicaAfterPrimaryActiveAllocationDecider]\n[2016-06-19 22:30:37,719][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]: ignoring allocation, can't be allocated on any node\n-- index [myindex]\n----shard_id [myindex][0]\n--------[myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n--------[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n--------[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n--------[myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n--------[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n--------[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]\n[2016-06-19 22:30:37,734][TRACE][gateway                  ] [Ent] [myindex] writing state, reason [freshly created]\n[2016-06-19 22:30:37,754][TRACE][gateway                  ] [Ent] [[myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]] on node [{Ent}{uQ85ko_PTaudfHrjdj00vw}{127.0.0.1}{127.0.0.1:9300}] has version [4] of shard\n[2016-06-19 22:30:37,754][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]] candidates for allocation: [[Ent] -> 4, ]\n[2016-06-19 22:30:37,754][DEBUG][gateway                  ] [Ent] [myindex][0] found 1 allocations of [myindex][0], node[null], [P], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]], highest version: [4]\n[2016-06-19 22:30:37,754][DEBUG][gateway                  ] [Ent] [myindex][0]: not allocating, number_of_allocated_shards_found [1]\n[2016-06-19 22:30:37,757][TRACE][cluster.routing.allocation.decider] [Ent] Can not allocate [[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]] on node [uQ85ko_PTaudfHrjdj00vw] due to [ReplicaAfterPrimaryActiveAllocationDecider]\n[2016-06-19 22:30:37,757][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]: ignoring allocation, can't be allocated on any node\n[2016-06-19 22:30:37,757][TRACE][cluster.routing.allocation.decider] [Ent] Can not allocate [[myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]] on node [uQ85ko_PTaudfHrjdj00vw] due to [ReplicaAfterPrimaryActiveAllocationDecider]\n[2016-06-19 22:30:37,757][TRACE][gateway                  ] [Ent] [myindex][0], node[null], [R], v[0], s[UNASSIGNED], unassigned_info[[reason=CLUSTER_RECOVERED], at[2016-06-19T20:30:37.687Z]]: ignoring allocation, can't be allocated on any node\n</pre>\n\n\nEnvironment:\n- Elasticsearch 2.3.3\n- OS: Mac\n- JVM: 1.8.0_45 (Oracle)\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}