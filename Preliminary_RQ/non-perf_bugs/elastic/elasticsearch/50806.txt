{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50806","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50806/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50806/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50806/events","html_url":"https://github.com/elastic/elasticsearch/issues/50806","id":547634327,"node_id":"MDU6SXNzdWU1NDc2MzQzMjc=","number":50806,"title":"Add searchable snapshots actions to ILM","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"andreidan","id":1217601,"node_id":"MDQ6VXNlcjEyMTc2MDE=","avatar_url":"https://avatars2.githubusercontent.com/u/1217601?v=4","gravatar_id":"","url":"https://api.github.com/users/andreidan","html_url":"https://github.com/andreidan","followers_url":"https://api.github.com/users/andreidan/followers","following_url":"https://api.github.com/users/andreidan/following{/other_user}","gists_url":"https://api.github.com/users/andreidan/gists{/gist_id}","starred_url":"https://api.github.com/users/andreidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreidan/subscriptions","organizations_url":"https://api.github.com/users/andreidan/orgs","repos_url":"https://api.github.com/users/andreidan/repos","events_url":"https://api.github.com/users/andreidan/events{/privacy}","received_events_url":"https://api.github.com/users/andreidan/received_events","type":"User","site_admin":false},"assignees":[{"login":"andreidan","id":1217601,"node_id":"MDQ6VXNlcjEyMTc2MDE=","avatar_url":"https://avatars2.githubusercontent.com/u/1217601?v=4","gravatar_id":"","url":"https://api.github.com/users/andreidan","html_url":"https://github.com/andreidan","followers_url":"https://api.github.com/users/andreidan/followers","following_url":"https://api.github.com/users/andreidan/following{/other_user}","gists_url":"https://api.github.com/users/andreidan/gists{/gist_id}","starred_url":"https://api.github.com/users/andreidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreidan/subscriptions","organizations_url":"https://api.github.com/users/andreidan/orgs","repos_url":"https://api.github.com/users/andreidan/repos","events_url":"https://api.github.com/users/andreidan/events{/privacy}","received_events_url":"https://api.github.com/users/andreidan/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2020-01-09T18:02:43Z","updated_at":"2020-04-13T22:19:38Z","closed_at":"2020-04-13T22:19:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Today, here is how to turn an index into a searchable snapshot on the `feature/searchable-snapshot` branch:\r\n\r\n```\r\n## Create normal repository for taking the snapshot\r\nPUT /_snapshot/backing_repo\r\n{\r\n  \"settings\": {\r\n    \"location\": \"/Users/davidturner/src/elasticsearch-master/repo/backing\"\r\n  },\r\n  \"type\": \"fs\"\r\n}\r\n\r\n## Create searchable repository for the restore\r\nPUT /_snapshot/searchable_repo\r\n{\r\n  \"settings\": {\r\n    \"location\": \"/Users/davidturner/src/elasticsearch-master/repo/backing\",\r\n    \"delegate_type\": \"fs\"\r\n  },\r\n  \"type\": \"searchable\"\r\n}\r\n\r\n## Create and populate the index\r\nPUT /original\r\n{\r\n  \"settings\": {\r\n    \"index.number_of_replicas\": 0\r\n  },\r\n  \"aliases\": {\r\n    \"alias\": {}\r\n  }\r\n}\r\n\r\nPOST /original/_bulk?refresh\r\n{\"index\":{}}\r\n{\"foo\":\"bar\"}\r\n{\"index\":{}}\r\n{\"baz\":\"quux\"}\r\n\r\nPOST /original/_flush\r\n\r\n## Force-merge it to a single segment (optional)\r\n\r\nPOST /original/_forcemerge?max_num_segments=1\r\n\r\n## Verify that there are docs in the index\r\n\r\nGET /alias/_search\r\n{\r\n  \"size\": 0\r\n}\r\n\r\n# {\r\n#   \"took\": 1,\r\n#   \"_shards\": {\r\n#     \"skipped\": 0,\r\n#     \"successful\": 1,\r\n#     \"total\": 1,\r\n#     \"failed\": 0\r\n#   },\r\n#   \"timed_out\": false,\r\n#   \"hits\": {\r\n#     \"max_score\": null,\r\n#     \"total\": {\r\n#       \"value\": 2,\r\n#       \"relation\": \"eq\"\r\n#     },\r\n#     \"hits\": []\r\n#   }\r\n# }\r\n\r\n## Take a snapshot of the target index\r\n\r\nPOST /_snapshot/backing_repo/snap?wait_for_completion=true\r\n{\r\n  \"indices\": \"original\",\r\n  \"include_global_state\": false\r\n}\r\n\r\n## Restore the snapshot to a different name\r\n\r\nPOST /_snapshot/searchable_repo/snap/_restore\r\n{\r\n  \"indices\": \"original\",\r\n  \"rename_pattern\": \"original\",\r\n  \"rename_replacement\": \"snapped\"\r\n}\r\n\r\nGET /_cluster/health?wait_for_status=green\r\n\r\n## Adjust the alias to point to the restored index and delete the original index\r\n\r\nPOST /_aliases\r\n{\r\n  \"actions\": [\r\n    {\r\n      \"add\": {\r\n        \"alias\": \"alias\",\r\n        \"index\": \"snapped\"\r\n      }\r\n    },\r\n    {\r\n      \"remove\": {\r\n        \"alias\": \"alias\",\r\n        \"index\": \"original\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\nDELETE /original\r\n\r\n## Verify that there's still two docs visible to searches\r\n\r\nGET /alias/_search\r\n{\r\n  \"size\": 0\r\n}\r\n\r\n# {\r\n#   \"took\": 2,\r\n#   \"_shards\": {\r\n#     \"skipped\": 0,\r\n#     \"successful\": 1,\r\n#     \"total\": 1,\r\n#     \"failed\": 0\r\n#   },\r\n#   \"timed_out\": false,\r\n#   \"hits\": {\r\n#     \"max_score\": null,\r\n#     \"total\": {\r\n#       \"value\": 2,\r\n#       \"relation\": \"eq\"\r\n#     },\r\n#     \"hits\": []\r\n#   }\r\n# }\r\n\r\n## ðŸš€\r\n```\r\n\r\nThis is too much to expect of our users, and it would be much better if ILM would guide the index through this process instead. We propose an ILM action to convert an index to a searchable snapshot, performing the steps above, to take place after the `Force Merge` action in the warm phase and after the `Freeze` action in the cold phase. As of today it is not possible to freeze a searchable snapshot but we may add that functionality in future. It is possible to run the `Set Priority`, `Allocate`, and `Delete` actions on a searchable snapshot.\r\n\r\nOf particular note is the snapshotting step: we take a snapshot of the single index. This avoids needing to retain a cluster-wide snapshot simply to preserve this single index. It's important that we retain this snapshot until after the index itself is deleted. Once the index is deleted we may (or may not) want to delete the corresponding snapshot.","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}