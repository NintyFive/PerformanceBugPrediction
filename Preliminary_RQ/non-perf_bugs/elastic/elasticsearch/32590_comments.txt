[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409967593","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-409967593","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":409967593,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTk2NzU5Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-02T15:29:07Z","updated_at":"2018-08-02T15:29:07Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410074769","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-410074769","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":410074769,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDA3NDc2OQ==","user":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"created_at":"2018-08-02T21:33:45Z","updated_at":"2018-08-02T21:33:45Z","author_association":"CONTRIBUTOR","body":"@jamiesmith Forgive me if I missed it, but I don't see the full script posted anywhere, just the snippet.  Do you have the full script easily available?  I'd like to use it to try to reproduce this issue locally.  Thanks in advance.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410108632","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-410108632","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":410108632,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDEwODYzMg==","user":{"login":"jamiesmith","id":220994,"node_id":"MDQ6VXNlcjIyMDk5NA==","avatar_url":"https://avatars3.githubusercontent.com/u/220994?v=4","gravatar_id":"","url":"https://api.github.com/users/jamiesmith","html_url":"https://github.com/jamiesmith","followers_url":"https://api.github.com/users/jamiesmith/followers","following_url":"https://api.github.com/users/jamiesmith/following{/other_user}","gists_url":"https://api.github.com/users/jamiesmith/gists{/gist_id}","starred_url":"https://api.github.com/users/jamiesmith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jamiesmith/subscriptions","organizations_url":"https://api.github.com/users/jamiesmith/orgs","repos_url":"https://api.github.com/users/jamiesmith/repos","events_url":"https://api.github.com/users/jamiesmith/events{/privacy}","received_events_url":"https://api.github.com/users/jamiesmith/received_events","type":"User","site_admin":false},"created_at":"2018-08-03T00:35:59Z","updated_at":"2018-08-03T00:35:59Z","author_association":"NONE","body":"the steps are all that you need to do:\r\n\r\n```\r\ncurl -O https://snapshots.elastic.co/docker/kibana-6.4.0-SNAPSHOT.tar.gz\r\ndocker load -i kibana-6.4.0-SNAPSHOT.tar.gz\r\n\r\ncurl -O https://snapshots.elastic.co/docker/elasticsearch-6.4.0-SNAPSHOT.tar.gz\r\ndocker load -i elasticsearch-6.4.0-SNAPSHOT.tar.gz \r\n\r\necho pause 10 for docker to settle\r\n\r\n# for some reason compose isn't ready to run yet\r\nsleep 10\r\n\r\n# you need the attached compose file\r\ndocker-compose --file dc.txt up --detach\r\n\r\ndocker logs --follow localtesting_6.4.0_elasticsearch\r\n```\r\n\r\nthe dc.txt file is attached to the first issue\r\n\r\nYou don't have to _do_ anything - the errors appear in the logs about a minute after the node starts","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410174159","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-410174159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":410174159,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDE3NDE1OQ==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2018-08-03T07:48:08Z","updated_at":"2018-08-03T07:48:08Z","author_association":"MEMBER","body":"@jdconrad the script is part of a watch that monitoring installs when x-pack is enabled. See [here](https://github.com/elastic/elasticsearch/blob/6.x/x-pack/plugin/monitoring/src/main/resources/monitoring/watches/elasticsearch_nodes.json#L154)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410309808","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-410309808","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":410309808,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDMwOTgwOA==","user":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"created_at":"2018-08-03T16:40:51Z","updated_at":"2018-08-03T16:40:51Z","author_association":"CONTRIBUTOR","body":"@jamiesmith @spinscale Thanks for the info.  I'll take a look at that script and see if I can get it to repro locally.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410333091","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-410333091","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":410333091,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDMzMzA5MQ==","user":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"created_at":"2018-08-03T18:07:59Z","updated_at":"2018-08-03T18:08:16Z","author_association":"CONTRIBUTOR","body":"@spinscale @jamiesmith  This is a standard NullPointerException given as part of a poor error message (note error message improvement is on the painless roadmap).  A method is being called against a def type that is null.  After reviewing the script there are several places this could occur.  \r\n\r\nCalls against def types include the following:\r\n```latestNodes.entrySet()```\r\n```previousNodes.entrySet()```\r\n\r\nIt's possible I'm missing other calls against def that could be null but those two stand out.\r\n\r\n@spinscale I don't know a huge amount about the data being accessed here, is it possible the source for latestNodes or previousNodes is null and not an empty Map?  Should these be checked for in this script?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413645848","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-413645848","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":413645848,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzY0NTg0OA==","user":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"created_at":"2018-08-16T18:43:23Z","updated_at":"2018-08-16T19:43:56Z","author_association":"CONTRIBUTOR","body":"The formatted Painless script for easier viewing:\r\n\r\n```\r\nvoid formatResults(StringBuilder message, String type, Map typeMap) {\r\n    if (typeMap.empty == false) {\r\n        message.append(' Node');\r\n\r\n        if (typeMap.size() != 1) {\r\n            message.append('s were');\r\n        } else {\r\n            message.append(' was');\r\n        }\r\n\r\n        message.append(' ').append(type).append(' [').append(typeMap.size()).append(']: ').append(typeMap.values().\r\n                stream().collect(Collectors.joining(', ', '[', ']'))).append('.');\r\n    }\r\n}\r\n\r\nctx.vars.email_recipient = (ctx.payload.kibana_settings.hits.total > 0) ?\r\n        ctx.payload.kibana_settings.hits.hits[0]._source.kibana_settings.xpack.default_admin_email : null;\r\n\r\ndef clusterState = ctx.payload.check.hits.hits[0]._source.cluster_state;\r\ndef persistentUuidToName = [:];\r\ndef latestNodes = clusterState.nodes;\r\ndef ephemeralUuidToPersistentUuid = [:];\r\ndef payload = [\r\n        'timestamp': ctx.execution_time,\r\n        'updated_timestamp': ctx.execution_time,\r\n        'resolved_timestamp': ctx.execution_time,\r\n        'metadata': ctx.metadata.xpack,\r\n        'prefix': 'Elasticsearch cluster nodes have changed!',\r\n        'nodes': [\r\n                'hash': clusterState.nodes_hash,\r\n                'added': persistentUuidToName,\r\n                'removed': [:],\r\n                'restarted': [:]\r\n        ]\r\n];\r\n\r\nfor (def latestNode : latestNodes.entrySet()) {\r\n    persistentUuidToName[latestNode.key] = latestNode.value.name;\r\n    ephemeralUuidToPersistentUuid[latestNode.value.ephemeral_id] = latestNode.key;\r\n}\r\n\r\ndef previousNodes = ctx.payload.check.hits.hits[1]._source.cluster_state.nodes;\r\ndef previousPersistentUuidToName = [:];\r\nfor (def previousNode : previousNodes.entrySet()) {\r\n    if (persistentUuidToName.containsKey(previousNode.key) == false) {\r\n        payload.nodes.removed[previousNode.key] = previousNode.value.name;\r\n    } else {\r\n        if (ephemeralUuidToPersistentUuid.containsKey(previousNode.value.ephemeral_id) == false) {\r\n            payload.nodes.restarted[previousNode.key] = persistentUuidToName[previousNode.key];\r\n        }\r\n\r\n        persistentUuidToName.remove(previousNode.key);\r\n    }\r\n}\r\n\r\nStringBuilder message = new StringBuilder();\r\nformatResults(message, 'removed', payload.nodes.removed);\r\nformatResults(message, 'added', payload.nodes.added);\r\nformatResults(message, 'restarted', payload.nodes.restarted);\r\npayload.message = message.toString().trim();\r\n\r\nreturn payload;\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413661502","html_url":"https://github.com/elastic/elasticsearch/issues/32590#issuecomment-413661502","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32590","id":413661502,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzY2MTUwMg==","user":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"created_at":"2018-08-16T19:40:40Z","updated_at":"2018-08-16T19:41:10Z","author_association":"CONTRIBUTOR","body":"@jasontedor figured out the cause of the NPE is ctx.payload.kibana_settings.hits.hits[0]._source.kibana_settings.xpack can be null.  He proposed the following fix:\r\n\r\n```\r\n(ctx.payload.kibana_settings.hits.total > 0) ? ctx.payload.kibana_settings.hits.hits[0]._source.kibana_settings.xpack.default_admin_email : null\r\n```\r\n\r\nto\r\n\r\n```\r\n(ctx.payload.kibana_settings.hits.total > 0 && ctx.payload.kibana_settings.hits.hits[0]._source.kibana_settings.xpack != null) ? ctx.payload.kibana_settings.hits.hits[0]._source.kibana_settings.xpack.default_admin_email : null\r\n```\r\n\r\nThis affects more than just this script, so all of them need to be updated.","performed_via_github_app":null}]