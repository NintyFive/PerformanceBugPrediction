[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60904924","html_url":"https://github.com/elastic/elasticsearch/issues/8269#issuecomment-60904924","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8269","id":60904924,"node_id":"MDEyOklzc3VlQ29tbWVudDYwOTA0OTI0","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2014-10-29T11:01:38Z","updated_at":"2014-10-29T11:01:38Z","author_association":"CONTRIBUTOR","body":"Oh, `preference=_primary` seems to be giving same number all the time. Probably different nodes serialize numbers differently.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60905977","html_url":"https://github.com/elastic/elasticsearch/issues/8269#issuecomment-60905977","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8269","id":60905977,"node_id":"MDEyOklzc3VlQ29tbWVudDYwOTA1OTc3","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-10-29T11:11:32Z","updated_at":"2014-10-29T11:11:32Z","author_association":"CONTRIBUTOR","body":"@bobrik did you use dynamic mapping to create these fields?  If so, I think you have inconsistent mappings on different shards.  This is a known problem.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60906220","html_url":"https://github.com/elastic/elasticsearch/issues/8269#issuecomment-60906220","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8269","id":60906220,"node_id":"MDEyOklzc3VlQ29tbWVudDYwOTA2MjIw","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2014-10-29T11:13:41Z","updated_at":"2014-10-29T11:13:41Z","author_association":"CONTRIBUTOR","body":"@clintongormley nope, mapping is copied from another index before reindexing documents so mapping for all fields is static.\n\nCan you point me to issue for different mappings on different shards? I'd like to be updated about it too.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/61302582","html_url":"https://github.com/elastic/elasticsearch/issues/8269#issuecomment-61302582","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8269","id":61302582,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMzAyNTgy","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-10-31T18:04:49Z","updated_at":"2014-10-31T18:04:49Z","author_association":"CONTRIBUTOR","body":"We are using doubles for the sum aggregation (so that you don't overflow but just start losing accuracy if your sum is very large).\n\nDoubles have 52 bits of mantissa, so the accuracy loss will start if you need more than 52 bits to store the sum. The accuracy loss on these doubles is going to depend on the order of the operations. And since replicas are allowed to store documents in a different order, doubles will not be added in the same order on all shards. I made a quick Java reproduction to show the issue:\n\n``` java\n  private static double sum(List<Double> l) {\n    double sum = 0;\n    for (double d : l) {\n      sum += d;\n    }\n    return sum;\n  }\n\n  public static void main(String[] args) throws IOException {\n    Random r = new Random(0);\n    List<Double> values = new ArrayList<>();\n    for (int i = 0; i < 10; ++i) {\n      double d = r.nextDouble() * (1L << (50 + r.nextInt(12)));\n      values.add(d);\n    }\n    System.out.println(sum(values));\n    Collections.shuffle(values);\n    System.out.println(sum(values));\n  }\n```\n\nwhich prints\n\n```\n1.81539321826034048E18\n1.81539321826034022E18\n```\n\n(see how the last digits differ)\n\nI believe this would explain why you only see this issue on high sums (greater than 2^52) and not when forcing execution on the primary (since iteration order is going to be the same)?\n\nI don't know if there is something open about the issue that Clinton mentioned, but basically dynamic mappings create mappings locally before propagating to the master. So they could end up being different on different nodes based on the documents that they received. And from that point, things can potentially go wild if you have eg. relocations since data can be indexed as longs and interpreted as doubles. We are thinking about making dynamic mappings consult the master before updating the mapping like regular mapping updates and although it would improve safety, it could also make things slower (think about 1000 consecutive documents, each introducing one new field).\n","performed_via_github_app":null}]