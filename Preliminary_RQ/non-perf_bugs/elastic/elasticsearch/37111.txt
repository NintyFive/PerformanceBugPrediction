{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37111","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37111/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37111/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37111/events","html_url":"https://github.com/elastic/elasticsearch/issues/37111","id":395586040,"node_id":"MDU6SXNzdWUzOTU1ODYwNDA=","number":37111,"title":"[CI] IndexShardIT.testShardHasMemoryBufferOnTranslogRecover failure","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-01-03T14:10:45Z","updated_at":"2019-01-05T09:15:34Z","closed_at":"2019-01-05T09:15:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This reproduces on master:\r\n```\r\nREPRODUCE WITH: ./gradlew :server:integTest \\\r\n  -Dtests.seed=9EC7D98FCA15BCE6 \\\r\n  -Dtests.class=org.elasticsearch.index.shard.IndexShardIT \\\r\n  -Dtests.method=\"testShardHasMemoryBufferOnTranslogRecover\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sv \\\r\n  -Dtests.timezone=Pacific/Auckland \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nThe resulting error is:\r\n```\r\nERROR   4.25s | IndexShardIT.testShardHasMemoryBufferOnTranslogRecover <<< FAILURES!\r\n   > Throwable #1: [test/rCQ777wBRcmIfm1spp2jiA][[test][0]] IndexShardRecoveryException[failed to recover from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: NoSuchFileException[file \"_0.cfs\" is already pending delete];\r\n   >    at __randomizedtesting.SeedInfo.seed([9EC7D98FCA15BCE6:42E398DA205C6200]:0)\r\n   >    at org.elasticsearch.index.shard.StoreRecovery.internalRecoverFromStore(StoreRecovery.java:429)\r\n   >    at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromStore$0(StoreRecovery.java:95)\r\n   >    at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:302)\r\n   >    at org.elasticsearch.index.shard.StoreRecovery.recoverFromStore(StoreRecovery.java:93)\r\n   >    at org.elasticsearch.index.shard.IndexShard.recoverFromStore(IndexShard.java:1657)\r\n   >    at org.elasticsearch.index.shard.IndexShardIT.recoverShard(IndexShardIT.java:636)\r\n   >    at org.elasticsearch.index.shard.IndexShardIT.testShardHasMemoryBufferOnTranslogRecover(IndexShardIT.java:560)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n   >    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n   >    at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n   >    at java.base/java.lang.Thread.run(Thread.java:834)\r\n   > Caused by: [test/rCQ777wBRcmIfm1spp2jiA][[test][0]] EngineCreationFailureException[failed to create engine]; nested: NoSuchFileException[file \"_0.cfs\" is already pending delete];\r\n   >    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:204)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:165)\r\n   >    at org.elasticsearch.index.engine.InternalEngineFactory.newReadWriteEngine(InternalEngineFactory.java:25)\r\n   >    at org.elasticsearch.index.shard.IndexShard.innerOpenEngineAndTranslog(IndexShard.java:1418)\r\n   >    at org.elasticsearch.index.shard.IndexShard.openEngineAndRecoverFromTranslog(IndexShard.java:1372)\r\n   >    at org.elasticsearch.index.shard.StoreRecovery.internalRecoverFromStore(StoreRecovery.java:424)\r\n   >    ... 42 more\r\n   > Caused by: java.nio.file.NoSuchFileException: file \"_0.cfs\" is already pending delete\r\n   >    at org.apache.lucene.store.FSDirectory.deleteFile(FSDirectory.java:338)\r\n   >    at org.apache.lucene.store.FileSwitchDirectory.deleteFile(FileSwitchDirectory.java:151)\r\n   >    at org.apache.lucene.store.FilterDirectory.deleteFile(FilterDirectory.java:63)\r\n   >    at org.elasticsearch.index.store.ByteSizeCachingDirectory.deleteFile(ByteSizeCachingDirectory.java:175)\r\n   >    at org.apache.lucene.store.FilterDirectory.deleteFile(FilterDirectory.java:63)\r\n   >    at org.elasticsearch.index.store.Store$StoreDirectory.deleteFile(Store.java:721)\r\n   >    at org.elasticsearch.index.store.Store$StoreDirectory.deleteFile(Store.java:726)\r\n   >    at org.apache.lucene.store.LockValidatingDirectoryWrapper.deleteFile(LockValidatingDirectoryWrapper.java:38)\r\n   >    at org.apache.lucene.index.IndexFileDeleter.deleteFile(IndexFileDeleter.java:696)\r\n   >    at org.apache.lucene.index.IndexFileDeleter.deleteFiles(IndexFileDeleter.java:690)\r\n   >    at org.apache.lucene.index.IndexFileDeleter.<init>(IndexFileDeleter.java:238)\r\n   >    at org.apache.lucene.index.IndexWriter.<init>(IndexWriter.java:898)\r\n   >    at org.elasticsearch.index.engine.InternalEngine$AssertingIndexWriter.<init>(InternalEngine.java:2580)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.createWriter(InternalEngine.java:2107)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.createWriter(InternalEngine.java:2097)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:199)\r\n   >    ... 47 more\r\n```\r\n\r\n`FileSwitchDirectory` makes me think this is related to the addition of `hybridfs`, especially given that this only started failing yesterday afternoon, after #36668 was merged.","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}