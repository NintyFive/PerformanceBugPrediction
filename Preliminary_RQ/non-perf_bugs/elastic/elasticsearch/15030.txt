{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15030","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15030/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15030/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15030/events","html_url":"https://github.com/elastic/elasticsearch/issues/15030","id":118946603,"node_id":"MDU6SXNzdWUxMTg5NDY2MDM=","number":15030,"title":"indexed script with terms aggregation not working.","user":{"login":"luizamboni","id":2022359,"node_id":"MDQ6VXNlcjIwMjIzNTk=","avatar_url":"https://avatars2.githubusercontent.com/u/2022359?v=4","gravatar_id":"","url":"https://api.github.com/users/luizamboni","html_url":"https://github.com/luizamboni","followers_url":"https://api.github.com/users/luizamboni/followers","following_url":"https://api.github.com/users/luizamboni/following{/other_user}","gists_url":"https://api.github.com/users/luizamboni/gists{/gist_id}","starred_url":"https://api.github.com/users/luizamboni/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luizamboni/subscriptions","organizations_url":"https://api.github.com/users/luizamboni/orgs","repos_url":"https://api.github.com/users/luizamboni/repos","events_url":"https://api.github.com/users/luizamboni/events{/privacy}","received_events_url":"https://api.github.com/users/luizamboni/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-11-26T00:19:42Z","updated_at":"2016-11-05T14:21:36Z","closed_at":"2015-11-28T17:46:51Z","author_association":"NONE","active_lock_reason":null,"body":"hi peoble, i` m have problems with terms aggregation in scripts, indexed scripts..\n\nHere is a ES website link about this use:\n\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-script\n\nIt is saying that all script types are accepted, and shows an example for inline and file script. Under the file example it explains if want use indexed script need change key \"file\" in json by \"id\" key.\n\ninline example\n\n``` javascript\n{\n    \"aggs\" : {\n        \"genders\" : {\n            \"terms\" : {\n                \"script\" : \"doc['gender'].value\"\n            }\n        }\n    }\n}\n```\n\nfile example\n\n``` javascript\n{\n    \"aggs\" : {\n        \"genders\" : {\n            \"terms\" : {\n                \"script\" : {\n                    \"file\": \"my_script\",\n                    \"params\": {\n                        \"field\": \"gender\"\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nand tip under file example in website explains if must need change key \"file\" in json by \"id\" key to use indexed script.\n\nok...all fine here.\n\ni have a groovy indexed script named \"test_field\", for test.\nit code is\n\n``` groovy\n return \"test field\";\n```\n\nwell...then not are any doubt about script error becouse the simplicity of it.\n\nwhen in a query i use this script in script_fields it works perfect\n\n``` javascript\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"seller_id\": 1\n          }\n        }\n      ]\n    }\n  },\n  \"script_fields\": {\n    \"statuses\": {\n      \"id\": \"test_field\",\n      \"params\": {\n        \"concurrent_ids\": [\n          1,\n          2,\n          3,\n          4\n        ]\n      }\n    }\n  }\n}\n```\n\nwhen i use the same script in aggs how describe in use of indexed scripts\n\n``` javascript\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"seller_id\": 1\n          }\n        }\n      ]\n    }\n  },\n  \"aggs\": {\n    \"statuses\": {\n      \"terms\": {\n        \"script\": {\n          \"id\": \"test_field\",\n          \"params\": {\n            \"concurrent_ids\": [\n              1,\n              2,\n              3,\n              4\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nreceive the error: \n\n``` javascript\n{\n  \"error\": \"SearchPhaseExecutionException[Failed to execute phase [query_fetch], all shards failed; shardFailures {[5j_srZt-TDatRuMytEMuQA][4ninjas_products_development][0]: SearchParseException[[4ninjas_products_development][0]: query[+ConstantScore(seller_id: \\u0001\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0001)],from[-1],size[-1]: Parse Failure [Failed to parse source [{\\n  \\\"query\\\": {\\n    \\\"bool\\\": {\\n      \\\"must\\\": [\\n        {\\n          \\\"term\\\": {\\n            \\\"seller_id\\\": 1\\n          }\\n        }\\n      ]\\n    }\\n  },\\n  \\\"aggs\\\": {\\n    \\\"statuses\\\": {\\n      \\\"terms\\\": {\\n        \\\"script\\\": {\\n          \\\"id\\\": \\\"test_field\\\",\\n          \\\"params\\\": {\\n            \\\"concurrent_ids\\\": [\\n              1,\\n              2,\\n              3,\\n              4\\n            ]\\n          }\\n        }\\n      }\\n    }\\n  }\\n}]]]; nested: SearchParseException[[4ninjas_products_development][0]: query[+ConstantScore(seller_id: \\u0001\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0001)],from[-1],size[-1]: Parse Failure [Unknown key for a START_OBJECT in [statuses]: [script].]]; }]\",\n  \"status\": 400\n}\n```\n\nwhen i change to inline script\n\n``` javascript\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"seller_id\": 1\n          }\n        }\n      ]\n    }\n  },\n  \"aggs\": {\n    \"statuses\": {\n      \"terms\": {\n        \"script\": \"return \\\"test status\\\";\",\n        \"params\": {\n          \"concurrent_ids\": [\n            1,\n            2,\n            3,\n            4\n          ]\n        }\n      }\n    }\n  }\n}\n```\n\nit works perfect...\n\nwhat gone wrong ?\n- Indexed scripts is activated\n- sandboad for indexed scripts is \"off\"\n- Indexed scripts works perfect in filters and script_fields\n- in aggregation scripts using \"file\" make the same error too... \n\nthe version of Elasticseach is:\n\n``` javascript\nversion: {\n    number: \"1.7.1\",\n    build_hash: \"b88f43fc40b0bcd7f173a1f9ee2e97816de80b19\",\n    build_timestamp: \"2015-07-29T09:54:16Z\",\n    build_snapshot: false,\n    lucene_version: \"4.10.4\"\n}\n```\n\nI search in internet, google, discus...and no find any similar example. Can be a bug. Please can you help me if not ? I had much work to explain exactly the point end formating this question me better display, and better understanding in github format.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}