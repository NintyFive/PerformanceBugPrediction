{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11947","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11947/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11947/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11947/events","html_url":"https://github.com/elastic/elasticsearch/issues/11947","id":92107669,"node_id":"MDU6SXNzdWU5MjEwNzY2OQ==","number":11947,"title":"Use of pre and post filters throws \"TokenStream contract violation: close() call missing\"","user":{"login":"jhariani","id":688874,"node_id":"MDQ6VXNlcjY4ODg3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/688874?v=4","gravatar_id":"","url":"https://api.github.com/users/jhariani","html_url":"https://github.com/jhariani","followers_url":"https://api.github.com/users/jhariani/followers","following_url":"https://api.github.com/users/jhariani/following{/other_user}","gists_url":"https://api.github.com/users/jhariani/gists{/gist_id}","starred_url":"https://api.github.com/users/jhariani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhariani/subscriptions","organizations_url":"https://api.github.com/users/jhariani/orgs","repos_url":"https://api.github.com/users/jhariani/repos","events_url":"https://api.github.com/users/jhariani/events{/privacy}","received_events_url":"https://api.github.com/users/jhariani/received_events","type":"User","site_admin":false},"labels":[{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-06-30T14:21:30Z","updated_at":"2018-05-10T09:52:31Z","closed_at":"2015-10-02T13:43:26Z","author_association":"NONE","active_lock_reason":null,"body":"This happens when using the standard analyzer as a pre and post filter after a direct candidate generator (ES 1.6). When this query was run in a multi-node environment, the error seemed to persist and required a rolling restart.  For example: \n\n``` json\n{ \"suggest\" : {\n    \"text\" : \"pizeo\",\n    \"simple_phrase\" : {\n      \"phrase\" : {\n        \"analyzer\" : \"english\",\n        \"field\" : \"synopses\",\n        \"direct_generator\" : [ {\n          \"field\" : \"synopses\",\n          \"suggest_mode\" : \"always\",\n          \"min_word_length\" : 1\n        }, {\n          \"field\" : \"synopses\",\n          \"suggest_mode\" : \"always\",\n          \"min_word_length\" : 1,\n          \"pre_filter\" : \"standard\",\n          \"post_filter\" : \"standard\"\n        } ]\n      }\n    }\n  }\n}\n```\n\nWill throw this error:\n\n``` json\n{\n   \"took\": 21,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 4,\n      \"successful\": 1,\n      \"failed\": 3,\n      \"failures\": [\n         {\n            \"index\": \"project\",\n            \"shard\": 0,\n            \"status\": 500,\n            \"reason\": \"IllegalStateException[TokenStream contract violation: close() call missing]\"\n         },\n         {\n            \"index\": \"project\",\n            \"shard\": 2,\n            \"status\": 500,\n            \"reason\": \"IllegalStateException[TokenStream contract violation: close() call missing]\"\n         },\n         {\n            \"index\": \"project\",\n            \"shard\": 3,\n            \"status\": 500,\n            \"reason\": \"IllegalStateException[TokenStream contract violation: close() call missing]\"\n         }\n      ]\n   },\n   \"suggest\": {\n      \"simple_phrase\": [\n         {\n            \"text\": \"pizo\",\n            \"offset\": 0,\n            \"length\": 4,\n            \"options\": []\n         }\n      ]\n   }\n}\n```\n\n[2015-06-30 10:16:05,888][DEBUG][action.search.type       ] [Wiz Kid] [project][0], node[OhG1Vc65RPyjCcSlXDbCJQ], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@7bd06ad7] lastShard [true]\njava.lang.IllegalStateException: TokenStream contract violation: close() call missing\n    at org.apache.lucene.analysis.Tokenizer.setReader(Tokenizer.java:90)\n    at org.apache.lucene.analysis.Analyzer$TokenStreamComponents.setReader(Analyzer.java:323)\n    at org.apache.lucene.analysis.standard.StandardAnalyzer$1.setReader(StandardAnalyzer.java:133)\n    at org.apache.lucene.analysis.Analyzer.tokenStream(Analyzer.java:147)\n    at org.elasticsearch.search.suggest.SuggestUtils.analyze(SuggestUtils.java:119)\n    at org.elasticsearch.search.suggest.SuggestUtils.analyze(SuggestUtils.java:115)\n    at org.elasticsearch.search.suggest.phrase.DirectCandidateGenerator.preFilter(DirectCandidateGenerator.java:133)\n    at org.elasticsearch.search.suggest.phrase.DirectCandidateGenerator.frequency(DirectCandidateGenerator.java:92)\n    at org.elasticsearch.search.suggest.phrase.DirectCandidateGenerator$2.nextToken(DirectCandidateGenerator.java:155)\n    at org.elasticsearch.search.suggest.SuggestUtils.analyze(SuggestUtils.java:130)\n    at org.elasticsearch.search.suggest.SuggestUtils.analyze(SuggestUtils.java:122)\n    at org.elasticsearch.search.suggest.SuggestUtils.analyze(SuggestUtils.java:115)\n    at org.elasticsearch.search.suggest.phrase.DirectCandidateGenerator.postFilter(DirectCandidateGenerator.java:148)\n    at org.elasticsearch.search.suggest.phrase.DirectCandidateGenerator.drawCandidates(DirectCandidateGenerator.java:122)\n    at org.elasticsearch.search.suggest.phrase.MultiCandidateGeneratorWrapper.drawCandidates(MultiCandidateGeneratorWrapper.java:52)\n    at org.elasticsearch.search.suggest.phrase.NoisyChannelSpellChecker.getCorrections(NoisyChannelSpellChecker.java:116)\n    at org.elasticsearch.search.suggest.phrase.PhraseSuggester.innerExecute(PhraseSuggester.java:98)\n    at org.elasticsearch.search.suggest.phrase.PhraseSuggester.innerExecute(PhraseSuggester.java:54)\n    at org.elasticsearch.search.suggest.Suggester.execute(Suggester.java:43)\n    at org.elasticsearch.search.suggest.SuggestPhase.execute(SuggestPhase.java:85)\n    at org.elasticsearch.search.suggest.SuggestPhase.execute(SuggestPhase.java:74)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:170)\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:289)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:300)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:231)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:228)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n","closed_by":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"performed_via_github_app":null}