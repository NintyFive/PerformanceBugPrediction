{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39780","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39780/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39780/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39780/events","html_url":"https://github.com/elastic/elasticsearch/issues/39780","id":418147420,"node_id":"MDU6SXNzdWU0MTgxNDc0MjA=","number":39780,"title":"ClassCastException returned when calling Watcher Stats API endpoint","user":{"login":"russcam","id":208231,"node_id":"MDQ6VXNlcjIwODIzMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/208231?v=4","gravatar_id":"","url":"https://api.github.com/users/russcam","html_url":"https://github.com/russcam","followers_url":"https://api.github.com/users/russcam/followers","following_url":"https://api.github.com/users/russcam/following{/other_user}","gists_url":"https://api.github.com/users/russcam/gists{/gist_id}","starred_url":"https://api.github.com/users/russcam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/russcam/subscriptions","organizations_url":"https://api.github.com/users/russcam/orgs","repos_url":"https://api.github.com/users/russcam/repos","events_url":"https://api.github.com/users/russcam/events{/privacy}","received_events_url":"https://api.github.com/users/russcam/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-03-07T06:18:56Z","updated_at":"2019-03-08T19:51:40Z","closed_at":"2019-03-08T19:51:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.5.3\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\n\r\njava 10.0.1 2018-04-17\r\nJava(TM) SE Runtime Environment 18.3 (build 10.0.1+10)\r\nJava HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.1+10, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nWindows 10 Pro 64 bit.\r\n\r\n```powershell\r\n> [System.Environment]::OSVersion.Version\r\n\r\nMajor  Minor  Build  Revision\r\n-----  -----  -----  --------\r\n10     0      17134  0\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nClassCastException returned when calling Watcher Stats API endpoint:\r\n\r\n>  \"java.util.concurrent.FutureTask cannot be cast to org.elasticsearch.xpack.watcher.execution.ExecutionService$WatchExecutionTask\"\r\n\r\n**Steps to reproduce**:\r\n\r\nAs part of the integration tests for the .NET client, the [Watcher Stats API tests](https://github.com/elastic/elasticsearch-net/blob/7bef2ca95e0b58662e2cc46192e3698ddff7de0a/src/Tests/Tests/XPack/Watcher/WatcherStats/WatcherStatsApiTests.cs) (`GET /_xpack/watcher/stats/_all?pretty=true&error_trace=true`) return the following error response:\r\n\r\n```json\r\nSeeing a Watcher related error when running the .NET client integration tests against 6.5.3. The test for getting the watcher stats (`GET: /_xpack/watcher/stats/_all?pretty=true&error_trace=true`) is returning:\r\n\r\n{\r\n  \"_nodes\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 0,\r\n    \"failed\" : 1,\r\n    \"failures\" : [\r\n      {\r\n        \"type\" : \"failed_node_exception\",\r\n        \"reason\" : \"Failed node [Rn1e1D_ET9qY10uO80BpNA]\",\r\n        \"node_id\" : \"Rn1e1D_ET9qY10uO80BpNA\",\r\n        \"caused_by\" : {\r\n          \"type\" : \"class_cast_exception\",\r\n          \"reason\" : \"java.util.concurrent.FutureTask cannot be cast to org.elasticsearch.xpack.watcher.execution.ExecutionService$WatchExecutionTask\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"cluster_name\" : \"ephemeral-cluster-fc0970\",\r\n  \"manually_stopped\" : false,\r\n  \"stats\" : [ ]\r\n}\r\n```\r\n\r\nThis looks like it might be an internal exception as opposed to an exception initiated by the action of the test. \r\n\r\nThe test [sets up a watch as part of the setup](https://github.com/elastic/elasticsearch-net/blob/7bef2ca95e0b58662e2cc46192e3698ddff7de0a/src/Tests/Tests/XPack/Watcher/WatcherStats/WatcherStatsApiTests.cs#L35-L57) and then [executes that watch just before calling the Watcher Stats API endpoint](https://github.com/elastic/elasticsearch-net/blob/7bef2ca95e0b58662e2cc46192e3698ddff7de0a/src/Tests/Tests/XPack/Watcher/WatcherStats/WatcherStatsApiTests.cs#L63-L76). Since the tests that run against an `XPackCluster` can run concurrently however, it is entirely possible that there are other watches with specific states that could also be returned in the Watcher Stats response which is causing this error, so it _may_ not reproduce with just the watch that is set up; I've run this test a few times in isolation and not seen the error response.\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}