{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35989","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35989/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35989/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35989/events","html_url":"https://github.com/elastic/elasticsearch/issues/35989","id":385217371,"node_id":"MDU6SXNzdWUzODUyMTczNzE=","number":35989,"title":"Deepsort/deterministic toJson Mustache function","user":{"login":"ypid-geberit","id":36660054,"node_id":"MDQ6VXNlcjM2NjYwMDU0","avatar_url":"https://avatars1.githubusercontent.com/u/36660054?v=4","gravatar_id":"","url":"https://api.github.com/users/ypid-geberit","html_url":"https://github.com/ypid-geberit","followers_url":"https://api.github.com/users/ypid-geberit/followers","following_url":"https://api.github.com/users/ypid-geberit/following{/other_user}","gists_url":"https://api.github.com/users/ypid-geberit/gists{/gist_id}","starred_url":"https://api.github.com/users/ypid-geberit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ypid-geberit/subscriptions","organizations_url":"https://api.github.com/users/ypid-geberit/orgs","repos_url":"https://api.github.com/users/ypid-geberit/repos","events_url":"https://api.github.com/users/ypid-geberit/events{/privacy}","received_events_url":"https://api.github.com/users/ypid-geberit/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-11-28T11:11:50Z","updated_at":"2018-12-17T14:52:17Z","closed_at":"2018-12-12T15:49:09Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\nThe Mustache function `{{#toJosn}}` is not deterministic meaning that the order of keys in a dictionary can change when templating the same data multiple times. This is an issue for unit/integration testing where exact matches are required. On ES 6.2.4 I never had those issues. Now on ES 6.5.1 dictionaries are serialized not deterministical.\r\n\r\nI am surprised that this has not caused issues for the unit tests of Elasticsearch itself. Example: https://github.com/elastic/elasticsearch/pull/18856/files#diff-ba0eba6caacd2ed288fbac13b74086eaR239\r\n\r\nMaybe it only happens for more nested data structures. I found the issue while writing an Elasticsearch watch like this:\r\n\r\n```YAML\r\n---\r\n\r\n# yamllint disable rule:line-length rule:comments-indentation\r\n\r\nmetadata:\r\n\r\n  ## Use an offset to allow events to travel thought their pipeline.\r\n  ## See: https://discuss.elastic.co/t/ensure-that-watcher-does-not-miss-documents-logs/127780/1\r\n  time_offset: '5m'\r\n  time_window: '1m'\r\n\r\ntrigger:\r\n  schedule:\r\n    ## Based on ctx.metadata.time_window.\r\n    ## Everyone triggers jobs at second 0 so this one is triggered at second 50\r\n    ## every minute.\r\n    cron:\r\n      - '50 * *    * * ?'\r\n\r\ninput:\r\n  search:\r\n    ## Based on ctx.metadata.time_window.\r\n    timeout: '40s'\r\n    request:\r\n\r\n      indices:\r\n        - 'log_network-switch__*'\r\n\r\n      body:\r\n\r\n        size: 100\r\n\r\n        query:\r\n          bool:\r\n            filter:\r\n              - match_phrase:\r\n                  host:\r\n                    query: 'gnu'\r\n\r\ncondition:\r\n  compare:\r\n    ctx.payload.hits.total:\r\n      gt: 0\r\n\r\nactions:\r\n  log:\r\n    logging:\r\n      level: info\r\n      text: 'Watch query hits: {{#toJson}}ctx.payload.hits.hits{{/toJson}}'\r\n```\r\n\r\n(Yes, YAML is awesome, also for watch definitions. Ref: https://github.com/elastic/examples/pull/239)\r\n\r\nMaybe also other parameters like pretty, indent could be passed to `{{#toJosn}}` similar to `{{#join}}`. Ref: https://github.com/elastic/elasticsearch/pull/18856/\r\n\r\nI at first used:\r\n\r\n```YAML\r\n      text: 'Watch query hits: {{ctx.payload.hits.hits}}'\r\n```\r\n\r\nbut this is also not deterministic.","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}