{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51606","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51606/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51606/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51606/events","html_url":"https://github.com/elastic/elasticsearch/issues/51606","id":556829978,"node_id":"MDU6SXNzdWU1NTY4Mjk5Nzg=","number":51606,"title":"[ML] Automatically map interval to fixed/calendar interval in datafeed aggs","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":151933706,"node_id":"MDU6TGFiZWwxNTE5MzM3MDY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eupgrade","name":">upgrade","color":"c7def8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"assignees":[{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-01-29T12:27:31Z","updated_at":"2020-04-28T15:24:13Z","closed_at":"2020-04-28T15:24:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Since #33727 went into 7.2 `interval` is deprecated in date histograms.  New date histograms should use `fixed_interval` or `calendar_interval` instead.  In 8.x it is likely that date histograms containing `interval` will be considered invalid.\r\n\r\nML datafeed configs are persisted and are likely to contain `interval` rather than `fixed_interval` or `calendar_interval`; they definitely will if they were first created in a version earlier than 7.2.  Such datafeed configs will be invalid in 8.0, so prior to 8.0 we _must_ do something about this, but there is no reason we cannot start sooner.\r\n\r\nThe best course of action would seem to be to silently rewrite datafeed configs that contain a `date_histogram` aggregation with an `interval` setting to have whichever of `fixed_interval` or `calendar_interval` preserves the current behaviour.\r\n\r\nWe can do this unconditionally providing the oldest node in the cluster is on version 7.2 or above.\r\n\r\nRollups already does this silent behaviour-preserving rewriting, although rollup configs are stored in cluster state which makes this considerably easier than for the ML configs that are stored in an index.\r\n\r\nThe code that does the translation for rollups is in:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/bd01cce31cc5e81959ae9f7614c4114b625bb9bf/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/rollup/job/DateHistogramGroupConfig.java#L65-L85\r\n\r\nand:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/bd01cce31cc5e81959ae9f7614c4114b625bb9bf/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/rollup/job/DateHistogramGroupConfig.java#L167-L174\r\n\r\nThat should be considered as the spec for how to do a silent behaviour-preserving rewrite.\r\n\r\nThe extra complexity in ML is deciding where to do the migration for datafeed configs that wouldn't otherwise be rewritten.  If we do it in the datafeed config parser then that ensures that newly submitted configs and datafeed configs that are updated will get translated.  Then we would just need to find an appropriate place to do it for existing datafeed configs - maybe on master node election providing the oldest node in the cluster is version 7.2 or above?\r\n\r\nThere are also some currently muted tests that should be reenabled when the work is done:\r\n\r\n1. https://github.com/elastic/elasticsearch/blob/be849b2a4de0a7c093a563de9786f7cac708861c/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfigTests.java#L545\r\n2. https://github.com/elastic/elasticsearch/blob/be849b2a4de0a7c093a563de9786f7cac708861c/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedUpdateTests.java#L60","closed_by":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"performed_via_github_app":null}