[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136798527","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-136798527","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":136798527,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjc5ODUyNw==","user":{"login":"felipegs","id":420000,"node_id":"MDQ6VXNlcjQyMDAwMA==","avatar_url":"https://avatars3.githubusercontent.com/u/420000?v=4","gravatar_id":"","url":"https://api.github.com/users/felipegs","html_url":"https://github.com/felipegs","followers_url":"https://api.github.com/users/felipegs/followers","following_url":"https://api.github.com/users/felipegs/following{/other_user}","gists_url":"https://api.github.com/users/felipegs/gists{/gist_id}","starred_url":"https://api.github.com/users/felipegs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/felipegs/subscriptions","organizations_url":"https://api.github.com/users/felipegs/orgs","repos_url":"https://api.github.com/users/felipegs/repos","events_url":"https://api.github.com/users/felipegs/events{/privacy}","received_events_url":"https://api.github.com/users/felipegs/received_events","type":"User","site_admin":false},"created_at":"2015-09-01T17:07:31Z","updated_at":"2015-09-01T17:07:31Z","author_association":"NONE","body":"we are using elasticsearch 1.7.1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136800010","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-136800010","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":136800010,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjgwMDAxMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-09-01T17:13:02Z","updated_at":"2015-09-01T17:13:02Z","author_association":"CONTRIBUTOR","body":"@colings86 could you take a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137013728","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-137013728","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":137013728,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzAxMzcyOA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-09-02T10:13:27Z","updated_at":"2015-09-02T10:13:27Z","author_association":"MEMBER","body":"@felipegs I'm going to try and reproduce this to see what might be going on buy in the mean time would you be able to do the following:\n- Confirm that the same errors happen when the `responseTime` agg is removed? (I expect it to be the case but asking for completeness\n- Confirm whether the errors occur when the `filters` aggregation is removed and the `scripted_metric` aggregation is run on its own?\n- Confirm which of the scripts the error is occurring in by removing the reduce script and seeing if the errors occur and then removing the combine script as well and seeing if the errors occur?\n- Confirm if the failing shards are always shards 0 and 2 of `events-gateway-29-20150901` or if the shards change each time?\n- Confirm if the errors only occur on that index (`events-gateway-29-20150901`) or if they occur on other indices too?\n\nThanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137026665","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-137026665","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":137026665,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzAyNjY2NQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-09-02T10:48:20Z","updated_at":"2015-09-02T10:48:20Z","author_association":"MEMBER","body":"I have managed to reproduce the issue using the steps in this gist: https://gist.github.com/colings86/0ee1159ee113e4992457\n\nThis is done on a 2-node cluster running version 1.7.1.\n\nIt seems that for me the error consistently occurs and it always on the same 2 shards.\n\nI have a look into what is causing this now\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137030948","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-137030948","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":137030948,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzAzMDk0OA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-09-02T11:03:17Z","updated_at":"2015-09-02T11:03:17Z","author_association":"MEMBER","body":"So the problem seems to be with the way you are initialising `_combine` in the `combine_script`. To initialise an empty map you should use `_combine = [:]` and then populate that map as you are currently (see http://www.groovy-lang.org/groovy-dev-kit.html#Collections-Maps for more details). By using `{}` i think (I'm not an expert in groovy) you are creating a new object type in groovy which Elasticsearch will not know how to serialise. The reason you only get the error for 2 of the shards is probably because they are the non-local shards being used in the request. The local shards (the ones on the same node which received the request from the client) will not need to serialise those objects to send them back for the reduce phase.\n\nI'm going to close this issue as the aggregation is working as expected in that the object emitted from the scripts need to be either primitive types, strings, maps of these types or an array of the types here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137034693","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-137034693","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":137034693,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzAzNDY5Mw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-09-02T11:14:06Z","updated_at":"2015-09-02T11:14:06Z","author_association":"MEMBER","body":"I've updated the documentation for the `scripted_metric` aggregation to be clearer on what types are valid to return from the scripts: https://github.com/elastic/elasticsearch/commit/1d9905a798e350f4a732790cb8731df8ab016059\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137064514","html_url":"https://github.com/elastic/elasticsearch/issues/13250#issuecomment-137064514","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13250","id":137064514,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzA2NDUxNA==","user":{"login":"diegossilveira","id":347380,"node_id":"MDQ6VXNlcjM0NzM4MA==","avatar_url":"https://avatars1.githubusercontent.com/u/347380?v=4","gravatar_id":"","url":"https://api.github.com/users/diegossilveira","html_url":"https://github.com/diegossilveira","followers_url":"https://api.github.com/users/diegossilveira/followers","following_url":"https://api.github.com/users/diegossilveira/following{/other_user}","gists_url":"https://api.github.com/users/diegossilveira/gists{/gist_id}","starred_url":"https://api.github.com/users/diegossilveira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegossilveira/subscriptions","organizations_url":"https://api.github.com/users/diegossilveira/orgs","repos_url":"https://api.github.com/users/diegossilveira/repos","events_url":"https://api.github.com/users/diegossilveira/events{/privacy}","received_events_url":"https://api.github.com/users/diegossilveira/received_events","type":"User","site_admin":false},"created_at":"2015-09-02T12:56:16Z","updated_at":"2015-09-02T12:56:16Z","author_association":"NONE","body":"Thank you for the reply @colings86! We will make some tests and I will let you know if we find some other problems.  \n","performed_via_github_app":null}]