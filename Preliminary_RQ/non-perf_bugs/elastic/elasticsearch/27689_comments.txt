[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/350046183","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-350046183","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":350046183,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MDA0NjE4Mw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-12-07T17:59:18Z","updated_at":"2018-01-11T19:55:55Z","author_association":"MEMBER","body":"I did some digging and this has to do with the fact that we treat aliases in the remove command as wild card expressions and [resolve them in advance](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/action/admin/indices/alias/TransportIndicesAliasesAction.java#L142) against the cluster state before we run the command. This means that if the alias was not there when we started, the remove command will  never be executed when the cluster state update.  I think this is trappy as there is no correlation between the cluster state that this pre filtering is run on and the cluster state which actually serves as base for the commands execution. On top of it it doesn't account for relationship between commands. I think we should not prefilter and resolve wild cards when we execute the commands on the cluster state thread.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385048583","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-385048583","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":385048583,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTA0ODU4Mw==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T18:02:34Z","updated_at":"2018-05-02T11:24:23Z","author_association":"CONTRIBUTOR","body":"I added the [discuss] label because I would like to discuss this in the context of eagerness to validate. This issue comes up with regards to #28231, and #30195. This also influences whether certain data-structures that are useful for early validation have value in being created as metadata is being changed and built by alias actions, rather than being re-created and validated all at once after all actions (whether legal or not, depending on the order) when the final MetaData is being built and validated (re: #29575).\r\n\r\n\r\nto highlight some examples that all behave differently:\r\n\r\n```\r\nPUT foo\r\n\r\n# add alias, then remove alias\r\n# 1st call: alias created. 2nd call: alias removed\r\nPOST _aliases\r\n{\r\n  \"actions\": [\r\n    { \"add\": { \"index\": \"foo\", \"alias\": \"logs\" } },\r\n    { \"remove\": {\"index\": \"foo\", \"alias\": \"logs\" } }\r\n  ]\r\n}\r\n\r\n# remove alias, then add alias\r\n# after all calls: alias created\r\nPOST _aliases\r\n{\r\n  \"actions\": [\r\n    { \"remove\": {\"index\": \"foo\", \"alias\": \"logs\" } },\r\n    { \"add\": { \"index\": \"foo\", \"alias\": \"logs\" } }\r\n  ]\r\n}\r\n\r\n# remove_index, then add alias\r\n# after all calls: exception thrown when trying to add alias, index remains.\r\nPOST _aliases\r\n{\r\n  \"actions\": [\r\n    { \"remove_index\": {\"index\": \"foo\"} },\r\n    { \"add\": { \"index\": \"foo\", \"alias\": \"logs\" } }\r\n  ]\r\n}\r\n\r\n# add alias, twice, updated\r\n# after all calls: last alias metadata definition wins\r\nPOST _aliases\r\n{\r\n  \"actions\": [\r\n    { \"add\": { \"index\": \"foo\",\"alias\": \"logs\", \"filter\": { \"exists\": { \"field\": \"FIELD_NAME\" } }}},\r\n    { \"add\": { \"index\": \"foo\",\"alias\": \"logs\" }}\r\n  ]\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408423956","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-408423956","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":408423956,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODQyMzk1Ng==","user":{"login":"tomcallahan","id":15988488,"node_id":"MDQ6VXNlcjE1OTg4NDg4","avatar_url":"https://avatars1.githubusercontent.com/u/15988488?v=4","gravatar_id":"","url":"https://api.github.com/users/tomcallahan","html_url":"https://github.com/tomcallahan","followers_url":"https://api.github.com/users/tomcallahan/followers","following_url":"https://api.github.com/users/tomcallahan/following{/other_user}","gists_url":"https://api.github.com/users/tomcallahan/gists{/gist_id}","starred_url":"https://api.github.com/users/tomcallahan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomcallahan/subscriptions","organizations_url":"https://api.github.com/users/tomcallahan/orgs","repos_url":"https://api.github.com/users/tomcallahan/repos","events_url":"https://api.github.com/users/tomcallahan/events{/privacy}","received_events_url":"https://api.github.com/users/tomcallahan/received_events","type":"User","site_admin":false},"created_at":"2018-07-27T13:48:50Z","updated_at":"2018-07-27T13:48:50Z","author_association":"CONTRIBUTOR","body":"@bleskes what would you like to do on this issue?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409235047","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-409235047","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":409235047,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTIzNTA0Nw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T14:11:35Z","updated_at":"2018-07-31T14:11:35Z","author_association":"MEMBER","body":"@tomcallahan we discussed it in the core infra sync a while ago and agree that the actions should be applied one by one, modifying things as they go, based on the output of the previous command. If I recall correctly, the conversation went with validating correctness on every step. That said, is write index validation ended being done once in the end, so we might need to revisit it.\r\n\r\nBottom line - it's a valid issue and someone needs to pick it up. I expect more work here as the alias code needs some cleanup IMO. I believe that is also what made @mayya-sharipova fight an up hill battle with her PR. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409320746","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-409320746","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":409320746,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTMyMDc0Ng==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T18:25:12Z","updated_at":"2018-07-31T18:25:12Z","author_association":"CONTRIBUTOR","body":"@bleskes  To confirm, you were saying that we need to take another approach for this. So, I am going to close my previous PR on this, and somebody else can work on it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410522885","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-410522885","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":410522885,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUyMjg4NQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T14:12:23Z","updated_at":"2018-08-05T14:12:23Z","author_association":"MEMBER","body":"@mayya-sharipova I think your PR is an improvement but indeed, this should be picked up in a more structural way. I'm OK with you just closing it, if you're not going to spend more time in that area (and otherwise we need to finish that discussion we started)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533261284","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-533261284","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":533261284,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzI2MTI4NA==","user":{"login":"ddreonomy","id":47988107,"node_id":"MDQ6VXNlcjQ3OTg4MTA3","avatar_url":"https://avatars3.githubusercontent.com/u/47988107?v=4","gravatar_id":"","url":"https://api.github.com/users/ddreonomy","html_url":"https://github.com/ddreonomy","followers_url":"https://api.github.com/users/ddreonomy/followers","following_url":"https://api.github.com/users/ddreonomy/following{/other_user}","gists_url":"https://api.github.com/users/ddreonomy/gists{/gist_id}","starred_url":"https://api.github.com/users/ddreonomy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ddreonomy/subscriptions","organizations_url":"https://api.github.com/users/ddreonomy/orgs","repos_url":"https://api.github.com/users/ddreonomy/repos","events_url":"https://api.github.com/users/ddreonomy/events{/privacy}","received_events_url":"https://api.github.com/users/ddreonomy/received_events","type":"User","site_admin":false},"created_at":"2019-09-19T18:49:43Z","updated_at":"2019-09-19T18:49:43Z","author_association":"NONE","body":"Does that mean that renaming an alias is not working properly? \r\n\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/6.2/indices-aliases.html\r\n```\r\nPOST /_aliases\r\n{\r\n    \"actions\" : [\r\n        { \"remove\" : { \"index\" : \"test1\", \"alias\" : \"alias1\" } },\r\n        { \"add\" : { \"index\" : \"test2\", \"alias\" : \"alias1\" } }\r\n    ]\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533264371","html_url":"https://github.com/elastic/elasticsearch/issues/27689#issuecomment-533264371","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27689","id":533264371,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzI2NDM3MQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2019-09-19T18:58:36Z","updated_at":"2019-09-19T18:58:36Z","author_association":"CONTRIBUTOR","body":"@ddreonomy The renaming of alias should work well.  If you experience any problem, please create a separate issue.\r\nThis PR is about adding/removing alias for the same index.","performed_via_github_app":null}]