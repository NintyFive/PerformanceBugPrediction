{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53118","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53118/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53118/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53118/events","html_url":"https://github.com/elastic/elasticsearch/issues/53118","id":575534626,"node_id":"MDU6SXNzdWU1NzU1MzQ2MjY=","number":53118,"title":"NullPointException using span_multi fuzzy query","user":{"login":"GeorgeAp","id":35894485,"node_id":"MDQ6VXNlcjM1ODk0NDg1","avatar_url":"https://avatars1.githubusercontent.com/u/35894485?v=4","gravatar_id":"","url":"https://api.github.com/users/GeorgeAp","html_url":"https://github.com/GeorgeAp","followers_url":"https://api.github.com/users/GeorgeAp/followers","following_url":"https://api.github.com/users/GeorgeAp/following{/other_user}","gists_url":"https://api.github.com/users/GeorgeAp/gists{/gist_id}","starred_url":"https://api.github.com/users/GeorgeAp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GeorgeAp/subscriptions","organizations_url":"https://api.github.com/users/GeorgeAp/orgs","repos_url":"https://api.github.com/users/GeorgeAp/repos","events_url":"https://api.github.com/users/GeorgeAp/events{/privacy}","received_events_url":"https://api.github.com/users/GeorgeAp/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-04T16:02:09Z","updated_at":"2020-03-05T09:54:48Z","closed_at":"2020-03-05T09:54:48Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --6.8.2`)\r\n\r\n**JVM version** (`1.8.0_242`)\r\n\r\n**OS version** (`18.04.1-Ubuntu`)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning the query below yields `NullPointException` on a one node cluster indexed with two documents. \r\n```\r\ncurl -H'Content-Type: application/json' -XGET \"localhost:9200/_search?pretty\" -d '\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"span_near\": {\r\n            \"clauses\": [\r\n              {\r\n                \"span_term\": {\r\n                  \"description\":\"deposition\"\r\n                }\r\n              },\r\n              {\r\n                \"span_multi\": {\r\n                  \"match\": {\r\n                    \"fuzzy\": {\r\n                      \"description\": {\r\n                        \"value\": \"foobarbaz\"\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n**Documents used**\r\nI indexed the two documents below on the single node.\r\n```\r\n{\"index\": {\"_index\": \"cb-6f24372d6c504f9a86f279d564bbad03-deposition\", \"_type\": \"doc\", \"_id\": \"0008c2f77ab24e7abfbdc42a32927631\"}}\r\n{\"id\":\"0008c2f77ab24e7abfbdc42a32927631\",\"case_id\":\"6f24372d6c504f9a86f279d564bbad03\",\"deposition_date\":\"2019-03-01\",\"action_metadata\":{\"user_id\":\"97817a7034e64108b9c4174e4daf39f1\",\"created_on\":\"2020-02-19T17:53:25.388000-06:00\"},\"last_action_metadata\":{\"user_id\":\"97817a7034e64108b9c4174e4daf39f1\",\"created_on\":\"2020-02-19T17:53:25.388000-06:00\"},\"case_witness_id\":\"3aef25d14a614f0a8704e95573ae176d\",\"deposition_doc_count\":1,\"selection_count\":1,\"applied_tag_count\":0,\"applied_note_count\":0,\"sort_values\":{\"case_witness_first_name\":\"Jim\",\"case_witness_last_name\":\"Smith\",\"case_witness_case_impact\":2,\"case_witness_party_affiliation\":\"Defendant\"},\"@culled\":false,\"@version\":1,\"deposition_doc_count_by_type\":[{\"document_count\":1,\"deposition_doc_type\":\"TRANSCRIPT\"}]}\r\n{\"index\": {\"_index\": \"cb-6f24372d6c504f9a86f279d564bbad03-case-witness\", \"_type\": \"doc\", \"_id\": \"3aef25d14a614f0a8704e95573ae176d\"}}\r\n{\"id\":\"3aef25d14a614f0a8704e95573ae176d\",\"case_id\":\"6f24372d6c504f9a86f279d564bbad03\",\"depositions_count\":1,\"description\":\"CaseWitness1\",\"case_impact\":2,\"notes\":\"Abignarrative\",\"party_affiliation\":\"Defendant\",\"is_expert\":true,\"area_of_expertise\":\"practicallyeverything\",\"witness_id\":\"0a5df20c0207487fa6b1a31e7577b890\",\"first_name\":\"Jim\",\"last_name\":\"Smith\",\"full_name\":\"JimSmith\",\"@culled\":false,\"@version\":1}\r\n```\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Start a one node cluster on `Elasticsearch 6.8.2` with the two documents above.\r\n 2. Execute the query above.\r\n 3. `NullPointException` occurs on every run.\r\n\r\n**Error log**\r\n```\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.lucene.search.FuzzyTermsEnum.<init>(FuzzyTermsEnum.java:119) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.FuzzyQuery.getTermsEnum(FuzzyQuery.java:154) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.MultiTermQuery$RewriteMethod.getTermsEnum(MultiTermQuery.java:78) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.elasticsearch.common.lucene.search.SpanBooleanQueryRewriteWithMaxClause$1.collectTerms(SpanBooleanQueryRewriteWithMaxClause.java:95) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.lucene.search.SpanBooleanQueryRewriteWithMaxClause$1.rewrite(SpanBooleanQueryRewriteWithMaxClause.java:75) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.lucene.search.SpanBooleanQueryRewriteWithMaxClause.rewrite(SpanBooleanQueryRewriteWithMaxClause.java:117) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.apache.lucene.search.spans.SpanMultiTermQueryWrapper.rewrite(SpanMultiTermQueryWrapper.java:121) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.spans.SpanNearQuery.rewrite(SpanNearQuery.java:251) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.ConstantScoreQuery.rewrite(ConstantScoreQuery.java:50) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.BoostQuery.rewrite(BoostQuery.java:81) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.apache.lucene.search.IndexSearcher.rewrite(IndexSearcher.java:686) ~[lucene-core-7.7.0.jar:7.7.0 8c831daf4eb41153c25ddb152501ab5bae3ea3d5 - jimczi - 2019-02-04 23:16:28]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.rewrite(ContextIndexSearcher.java:106) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.DefaultSearchContext.preProcess(DefaultSearchContext.java:263) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.query.QueryPhase.preProcess(QueryPhase.java:91) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService.createContext(SearchService.java:649) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:596) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:387) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService.access$100(SearchService.java:126) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:359) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:355) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService$4.doRun(SearchService.java:1107) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_242]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_242]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_242]```\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}