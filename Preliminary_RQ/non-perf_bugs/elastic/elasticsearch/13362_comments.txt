[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138089429","html_url":"https://github.com/elastic/elasticsearch/issues/13362#issuecomment-138089429","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362","id":138089429,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODA4OTQyOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-09-06T14:20:37Z","updated_at":"2015-09-06T14:20:37Z","author_association":"CONTRIBUTOR","body":"Hi @jimmyjones2 \n\nI'm guessing you're on a version before 1.6?  There is a bug (which appears to be fixed in 1.6.0) but it is different from what you describe. It can be reproduced as follows:\n\n```\nDELETE *\nDELETE /_template/repro\n\nPUT /_template/repro\n{\n  \"template\": \"repro\",\n  \"mappings\": {\n    \"_default_\": {\n      \"include_in_all\": false,\n      \"_all\": {\n        \"analyzer\": \"keyword\"\n      },\n      \"properties\": {\n        \"field1\": {\n          \"type\": \"string\"\n        },\n        \"field2\": {\n          \"type\": \"string\",\n          \"include_in_all\": true\n        }\n      }\n    }\n  }\n}\n```\n\nNote: Your template sets the `analyzer` on the `_all` field to `keyword`, which is definitely not what you want to do for reasons described below.\n\nCreate documents with the `@version` field:\n\n```\nPOST _bulk \n{\"index\":{\"_id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"hello\",\"field2\":\"bye\",\"@version\": \"1\"}\n{\"index\":{\"_id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"dog\",\"field2\":\"cat\",\"@version\": \"1\"}\n```\n\nThe mapping indicates that `field1` and `@version` have `include_in_all` set to `false`, and `field2` set to `true`, which is what you expect:\n\n```\nGET _mapping\n```\n\nHowever, the `_all` field is not as expected:\n\n```\nGET _search?size=0\n{\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"_all\",\n        \"size\": 10\n      }\n    }\n  }\n}\n```\n\nThe `_all` field includes `bye`, which is correct, but it also includes the single term `cat 1` which is incorrect.  For some reason it included the `@version` field value as well, even though the final mapping is correct.\n\nThis also demonstrates why you don't want to set the analyzer for the `_all` field to `keyword`. Field values are not added to `_all` as multiple values but as a single string joined by spaces, so the `keyword` analyzer just ends up indexing a single term for the `_all` field. On top of that, the order that fields are added to `_all` is non-deterministic.\n\nEither way, the index template/mapping issue appears to have been fixed already so I'll close this issue\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138097670","html_url":"https://github.com/elastic/elasticsearch/issues/13362#issuecomment-138097670","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362","id":138097670,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODA5NzY3MA==","user":{"login":"jimmyjones2","id":2991805,"node_id":"MDQ6VXNlcjI5OTE4MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/2991805?v=4","gravatar_id":"","url":"https://api.github.com/users/jimmyjones2","html_url":"https://github.com/jimmyjones2","followers_url":"https://api.github.com/users/jimmyjones2/followers","following_url":"https://api.github.com/users/jimmyjones2/following{/other_user}","gists_url":"https://api.github.com/users/jimmyjones2/gists{/gist_id}","starred_url":"https://api.github.com/users/jimmyjones2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimmyjones2/subscriptions","organizations_url":"https://api.github.com/users/jimmyjones2/orgs","repos_url":"https://api.github.com/users/jimmyjones2/repos","events_url":"https://api.github.com/users/jimmyjones2/events{/privacy}","received_events_url":"https://api.github.com/users/jimmyjones2/received_events","type":"User","site_admin":false},"created_at":"2015-09-06T16:24:54Z","updated_at":"2015-09-06T16:24:54Z","author_association":"CONTRIBUTOR","body":"@clintongormley Running 1.7.1 and that shows the issue. Tried 2.0beta1 and that worked fine.\n\nThe reason I used the keyword analyzer is I've got mutliple fields containing filenames which can contain spaces and I didn't want the additional terms created that the default analyzer of _all would, but I didn't realise _all_ the terms marked with include_in_all got merged - thanks for clearing that up! Was trying to workaround #13214, nevermind!\n","performed_via_github_app":null}]