{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579/events","html_url":"https://github.com/elastic/elasticsearch/issues/21579","id":189486379,"node_id":"MDU6SXNzdWUxODk0ODYzNzk=","number":21579,"title":"BUG: Bucket Script Aggregation","user":{"login":"DoychinDoychev","id":23104056,"node_id":"MDQ6VXNlcjIzMTA0MDU2","avatar_url":"https://avatars1.githubusercontent.com/u/23104056?v=4","gravatar_id":"","url":"https://api.github.com/users/DoychinDoychev","html_url":"https://github.com/DoychinDoychev","followers_url":"https://api.github.com/users/DoychinDoychev/followers","following_url":"https://api.github.com/users/DoychinDoychev/following{/other_user}","gists_url":"https://api.github.com/users/DoychinDoychev/gists{/gist_id}","starred_url":"https://api.github.com/users/DoychinDoychev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DoychinDoychev/subscriptions","organizations_url":"https://api.github.com/users/DoychinDoychev/orgs","repos_url":"https://api.github.com/users/DoychinDoychev/repos","events_url":"https://api.github.com/users/DoychinDoychev/events{/privacy}","received_events_url":"https://api.github.com/users/DoychinDoychev/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2016-11-15T19:40:44Z","updated_at":"2016-11-19T13:09:06Z","closed_at":"2016-11-19T13:09:06Z","author_association":"NONE","active_lock_reason":null,"body":"Hi there,\r\n\r\nI think there is a bug in _Bucket Script Aggregation_. I have two examples - one working and the other one is not.\r\n\r\n**WORKING EXAMPLE**\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"time\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"startTime\",\r\n        \"interval\": \"day\"\r\n      }, \r\n      \"aggs\": {\r\n        \"dislike\": {\r\n          \"filter\" : { \"term\": { \"type\": \"Dislike\" } },\r\n          \"aggs\": {\r\n            \"dislike-values\": {\r\n              \"value_count\" : { \r\n                \"script\" : {\r\n                  \"inline\" : \"doc\",\r\n                  \"lang\" : \"groovy\"\r\n                }\r\n              } \r\n            }\r\n          }\r\n        },\r\n        \"follow\": {\r\n          \"filter\" : { \"term\": { \"type\": \"Follow\" } },\r\n          \"aggs\": {\r\n            \"follow-values\": {\r\n              \"value_count\" : { \r\n                \"script\" : {\r\n                  \"inline\" : \"doc\",\r\n                  \"lang\" : \"groovy\"\r\n                }\r\n              } \r\n            }\r\n          }\r\n        },\r\n        \"connected_users\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"follow\": \"follow>follow-values\",\r\n              \"dislike\": \"dislike>dislike-values\"\r\n            },\r\n            \"script\": \"follow - dislike\",\r\n            \"gap_policy\": \"insert_zeros\"\r\n          }\r\n        }\r\n        \r\n      }\r\n    }\r\n  }\r\n}\r\n``` \r\nNOTICE \r\n```      \r\n\"date_histogram\": {\r\n        \"field\": \"startTime\",\r\n        \"interval\": \"day\"\r\n      }, \r\n```\r\n\r\n**NOT WORKING**\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"time\": {\r\n      \"date_range\": {\r\n        \"field\": \"startTime\",\r\n          \"ranges\": [\r\n              { \r\n                \"to\": \"now-1d\"\r\n              }, \r\n              { \r\n                \"to\": \"now-2d\"\r\n              }\r\n            ]\r\n      },\r\n      \"aggs\": {\r\n        \"dislike\": {\r\n          \"filter\" : { \"term\": { \"type\": \"Dislike\" } },\r\n          \"aggs\": {\r\n            \"dislike-values\": {\r\n              \"value_count\" : { \r\n                \"script\" : {\r\n                  \"inline\" : \"doc\",\r\n                  \"lang\" : \"groovy\"\r\n                }\r\n              } \r\n            }\r\n          }\r\n        },\r\n        \"follow\": {\r\n          \"filter\" : { \"term\": { \"type\": \"Follow\" } },\r\n          \"aggs\": {\r\n            \"follow-values\": {\r\n              \"value_count\" : { \r\n                \"script\" : {\r\n                  \"inline\" : \"doc\",\r\n                  \"lang\" : \"groovy\"\r\n                }\r\n              } \r\n            }\r\n          }\r\n        },\r\n        \"connected_users\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"follow\": \"follow>follow-values\",\r\n              \"dislike\": \"dislike>dislike-values\"\r\n            },\r\n            \"script\": \"follow - dislike\",\r\n            \"gap_policy\": \"insert_zeros\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nNOTICE\r\n```\r\n      \"date_range\": {\r\n        \"field\": \"startTime\",\r\n          \"ranges\": [\r\n              { \r\n                \"to\": \"now-1d\"\r\n              }, \r\n              { \r\n                \"to\": \"now-2d\"\r\n              }\r\n            ]\r\n      },\r\n```\r\nthis gives \r\n```\r\n{\r\n   \"error\": {\r\n      \"root_cause\": [],\r\n      \"type\": \"reduce_search_phase_exception\",\r\n      \"reason\": \"[reduce] \",\r\n      \"phase\": \"fetch\",\r\n      \"grouped\": true,\r\n      \"failed_shards\": [],\r\n      \"caused_by\": {\r\n         \"type\": \"null_pointer_exception\",\r\n         \"reason\": null\r\n      }\r\n   },\r\n   \"status\": 503\r\n}\r\n```\r\nin Sense.\r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}