{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18715","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18715/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18715/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18715/events","html_url":"https://github.com/elastic/elasticsearch/issues/18715","id":158273948,"node_id":"MDU6SXNzdWUxNTgyNzM5NDg=","number":18715,"title":"Terms Aggregation does not match underlying documents...","user":{"login":"astropuffin","id":7584665,"node_id":"MDQ6VXNlcjc1ODQ2NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/7584665?v=4","gravatar_id":"","url":"https://api.github.com/users/astropuffin","html_url":"https://github.com/astropuffin","followers_url":"https://api.github.com/users/astropuffin/followers","following_url":"https://api.github.com/users/astropuffin/following{/other_user}","gists_url":"https://api.github.com/users/astropuffin/gists{/gist_id}","starred_url":"https://api.github.com/users/astropuffin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astropuffin/subscriptions","organizations_url":"https://api.github.com/users/astropuffin/orgs","repos_url":"https://api.github.com/users/astropuffin/repos","events_url":"https://api.github.com/users/astropuffin/events{/privacy}","received_events_url":"https://api.github.com/users/astropuffin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-06-03T01:30:36Z","updated_at":"2016-06-03T11:31:26Z","closed_at":"2016-06-03T11:31:26Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.1\n\n**JVM version**: (not sure, using found)\n\n**OS version**: (using found)\n\n**Description of the problem including expected versus actual behavior**:\nI'm trying out a new metrics system, and I need to do math on the numerical values. The values reported in the aggregation are wrong, even though the values in the actual documents are correct.\n\nrequest:\n\n``` json\nGET metrics-2016.06.02/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"values\" : {\n      \"terms\": {\n        \"field\": \"value\"\n      }\n    }\n  }\n}\n```\n\ncondensed response:\n\n``` json\n{\n  \"hits\": {\n    \"hits\": [\n      {\n        \"_id\": \"AVUSjXsGy-UE6d0LYWba\",\n        \"_source\": {\n          \"value\": 1464895109\n        }\n      },\n      {\n        \"_id\": \"AVUSjaJqy-UE6d0LYXgO\",\n        \"_source\": {\n          \"value\": 1464895119\n        }\n      }\n    ]\n  },\n  \"aggregations\": {\n    \"values\": {\n      \"buckets\": [\n        {\n          \"key\": 1464895104,\n          \"doc_count\": 2\n        }\n      ]\n    }\n  }\n}\n```\n\nNote: each document has a unique value in the field \"value\", yet the aggregation groups them together into a single bucket. This is wrong and seriously cramping my style. If I wanted to bucket them together in ranges I would have done that instead.\n\nI tried using \"execution_hint\" as documented [here](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-execution-hint), but it had no effect.\n\n**Steps to reproduce**:\nsee above.\n\nNote:\nI had to obfuscate the documents/results slightly, so I apologize if I got a syntax error somewhere.\n\n**Provide logs (if relevant)**:\nadditional information:\n\nfull response:\n\n``` json\n{\n  \"took\": 3,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 1,\n    \"successful\": 1,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 2,\n    \"max_score\": 1,\n    \"hits\": [\n{\n        \"_index\": \"metrics-2016.06.02\",\n        \"_type\": \"metric\",\n        \"_id\": \"AVUSjXsGy-UE6d0LYWba\",\n        \"_score\": 1,\n        \"_source\": {\n          \"value\": 1464895109,\n          \"mtype\": \"timestamp\",\n          \"unit\": \"seconds\",\n          \"@timestamp\": \"2016-06-02T19:18:29.237Z\",\n          \"type\": \"metric\"\n        }\n      },\n      {\n        \"_index\": \"metrics-2016.06.02\",\n        \"_type\": \"metric\",\n        \"_id\": \"AVUSjaJqy-UE6d0LYXgO\",\n        \"_score\": 1,\n        \"_source\": {\n          \"value\": 1464895119,\n          \"mtype\": \"timestamp\",\n          \"unit\": \"seconds\",\n          \"@timestamp\": \"2016-06-02T19:18:39.328Z\",\n          \"type\": \"metric\"\n        }\n      }\n    ]\n  },\n  \"aggregations\": {\n    \"values\": {\n      \"doc_count_error_upper_bound\": 0,\n      \"sum_other_doc_count\": 0,\n      \"buckets\": [\n        {\n          \"key\": 1464895104,\n          \"doc_count\": 2\n        }\n      ]\n    }\n  }\n}\n```\n\nMy index template:\n\n``` json\n{\n  \"template\": \"metrics-*\",\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"5s\"\n    }\n  },\n  \"mappings\": {\n    \"_default_\": {\n      \"dynamic_templates\": [\n        {\n          \"strings\": {\n            \"match\": \"*\",\n            \"match_mapping_type\": \"string\",\n            \"mapping\": { \"type\": \"string\",  \"doc_values\": true, \"index\": \"not_analyzed\" }\n          }\n        }\n      ],\n      \"_all\":            { \"enabled\": true },\n      \"_source\":         { \"enabled\": true },\n      \"properties\": {\n        \"@timestamp\":    { \"type\": \"date\",    \"doc_values\": true },\n        \"value\":         { \"type\": \"float\",   \"doc_values\": true, \"coerce\": true }\n      }\n    }\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}