{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420/events","html_url":"https://github.com/elastic/elasticsearch/issues/13420","id":105581535,"node_id":"MDU6SXNzdWUxMDU1ODE1MzU=","number":13420,"title":"Nested sort inside a top hits inside a reverse nested doesn't work","user":{"login":"ericrenard","id":6536793,"node_id":"MDQ6VXNlcjY1MzY3OTM=","avatar_url":"https://avatars0.githubusercontent.com/u/6536793?v=4","gravatar_id":"","url":"https://api.github.com/users/ericrenard","html_url":"https://github.com/ericrenard","followers_url":"https://api.github.com/users/ericrenard/followers","following_url":"https://api.github.com/users/ericrenard/following{/other_user}","gists_url":"https://api.github.com/users/ericrenard/gists{/gist_id}","starred_url":"https://api.github.com/users/ericrenard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericrenard/subscriptions","organizations_url":"https://api.github.com/users/ericrenard/orgs","repos_url":"https://api.github.com/users/ericrenard/repos","events_url":"https://api.github.com/users/ericrenard/events{/privacy}","received_events_url":"https://api.github.com/users/ericrenard/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-09-09T11:54:45Z","updated_at":"2015-09-10T10:38:12Z","closed_at":"2015-09-10T10:38:12Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\nI'm facing something that looks like a bug. I have a simple document model : my documents are items, and inside these items there are categories.\nI want to get a list of categories with a certain type, and for each of these categories, a list of top items belonging to this category, sorted on the category rank. So I'm doing a top hits inside reverse nested \n\nMapping example :\n\n```\nPOST /bugth\n{\n    \"mappings\": \n    {        \n        \"item\" : {\n            \"properties\" : {\n                \"id\" : { \"type\" : \"integer\" },\n                \"categories\" : { \n                    \"type\" : \"nested\",\n                    \"properties\" : {\n                        \"id\" : { \"type\" : \"integer\" },\n                        \"type\" : { \"type\" : \"integer\" },\n                        \"rank\" : { \"type\" : \"integer\" }\n                    }\n                }\n            }\n        }        \n    }\n}\n```\n\nSome data to test :\n\n```\nPUT /bugth/item/3\n{\n    \"id\": 3,\n    \"categories\": [{\n        \"id\": 1,\n        \"type\": 1,\n        \"rank\": 15\n    }, {\n        \"id\": 2,\n        \"type\": 1,\n        \"rank\": 1\n    }]\n}\n\nPUT /bugth/item/2\n{\n    \"id\": 2,\n    \"categories\": [{\n        \"id\": 1,\n        \"type\": 1,\n        \"rank\": 10\n    }, {\n        \"id\": 2,\n        \"type\": 1,\n        \"rank\": 5\n    },\n    {\n        \"id\": 3,\n        \"type\": 2,\n        \"rank\": 20\n    }]\n}\n\nPUT /bugth/item/1\n{\n    \"id\": 1,\n    \"categories\": {\n        \"id\": 1,\n        \"type\": 1,\n        \"rank\": 0\n    }\n}\n```\n\nFinally the search query :\n\n```\nPOST /bugth/item/_search\n{\n    \"size\": 0,\n    \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"match_all\": {}\n      }\n    }\n  },\n  \"aggs\": {\n      \"categories\": {                        \n          \"nested\": {\n              \"path\": \"categories\"\n          },\n          \"aggs\": {\n              \"filteredcategories\": {\n                  \"filter\": {\n                      \"bool\": {\n                          \"must\": {\n                              \"term\": { \"categories.type\": 1}\n                          }                          \n                      }\n                  },\n                  \"aggs\": {\n                      \"top_categories\": {\n                          \"terms\": {\n                              \"field\": \"categories.id\"\n                          },\n                          \"aggs\": {\n                              \"top_items\": {\n                                  \"reverse_nested\": {                                \n                                  },\n                                  \"aggs\": {                          \n                                      \"top_items_per_categories\": {                              \n                                          \"top_hits\": {                   \n                                              \"sort\": [\n                                                {\n                                                  \"categories.rank\": {\n                                                    \"order\": \"asc\",\n                                                    \"mode\": \"max\"\n                                                  }\n                                                }                                                \n                                              ]\n                                              }\n                                          }\n                                      }\n                                  }\n                              }\n                          }\n                      }\n                  }\n                }\n          }\n      }    \n    }\n}\n```\n\nUltimately, I want to sort by the category rank of the current bucket but I don't know how to refer to the bucket id inside the sort clause.\nAnyways, sorting by any nested property doesn't work (sort doesn't apply). However, sorting by a base property of item do work correctly.\n\nIs this a bug or just me doing my query the wrong way ?\n\nThanks\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}