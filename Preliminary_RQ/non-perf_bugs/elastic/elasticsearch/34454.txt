{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34454","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34454/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34454/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34454/events","html_url":"https://github.com/elastic/elasticsearch/issues/34454","id":370145189,"node_id":"MDU6SXNzdWUzNzAxNDUxODk=","number":34454,"title":"Backup .security","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"assignees":[{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2018-10-15T12:43:45Z","updated_at":"2020-02-06T18:03:07Z","closed_at":"2020-02-06T18:03:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"At present backing up the `.security` is achieved using the common [snapshot](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html) APIs. The problem is that the snapshot and restore actions require a _superuser_ if the snapshot will be including the _.security_ index. This is a problem because periodic snapshotting is a good practice but using a _superuser_ for it is obscuring the benefits.\r\n\r\n_A superuser is a user having the \"superuser\" role.\r\nOnly a superuser is able to read or write the \".security\" index, as well as list it (in wildcards)._\r\n \r\nThe Security Index contains:\r\n * Tokens - used to authn users without password; a token is shorter lived than a password\r\n * Users - attributes and hashed password for users under the Native & Reserved Realm\r\n * Role Mappings - rules that assign users (based on their attributes) to roles\r\n * Roles - description of permissions for each role\r\n * App Privileges - description of app privileges (outside of ES authz model, eg Kibana Spaces)\r\n\r\nRight now, snapshotting is equivalent to reading the index because the user can add a repository and then restore it under a cluster of its own control. Likewise, restoring is equivalent to writing the index, hence the tight authorization enforcement when the \".security\" index is included.\r\n\r\nSnapshot and Restore are authorized as cluster actions by the manage privilege. This privilege is required irrespective of the indices being snapshotted. The manage cluster privilege is a very powerful privilege.\r\n\r\n_The proposed action plan will be based upon the existing snapshot and restore infra as opposed to using separate APIs. All the following changes concern only the snapshot operation. The restore operation should not be automated and is OK for it to require superuser. Moreover, this superuser should reside in the file realm because the .security has to be closed before restoring and therefore it cannot be used for this operation._\r\n\r\n_EDITED 16.04.19_\r\n_EDITED 25.06.19_\r\n\r\n### Proposed action plan\r\n1. [x] create _read-only system role_ for snapshotting _internal indices_ (no other actions allowed, including _restore_ which will still require _superuser_ privileges); ~the _internal indices_ set remains to be defined but it will include _.security_~ it is `.security`, `.security-6` and `.security-7` (and potentially `.security-tokens` and `.security-tokens-7`) .\r\n  This has been completed by merging:\r\n  * https://github.com/elastic/elasticsearch/pull/37577\r\n  * https://github.com/elastic/elasticsearch/pull/37774\r\n  * https://github.com/elastic/elasticsearch/pull/35820\r\n2. [x] fork ephemeral contents of the _.security_ index to another security index sibling. This sibling should not be ordinarily snapshoted or restored ~(but should be optionally included).~ This index is called `.snapshot-tokens` and the work has been completed by merging and backporting:\r\n  * [Security Tokens moved to a new separate index](https://github.com/elastic/elasticsearch/pull/40742).\r\n3.  ~support client ~library~ encryption for at least one [repository type](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html#_repository_plugins) . Encryption on the cloud client appears to be more promising than encryption on the repository side because the latter might not be compatible with incremental snapshotting.\r\nThe client side encryption of the cloud client SDKs is patchy: some support it - AWS, others don't - GCS, and they offer various controls over the key format and where it can reside. Moreover key rotation looks like a taboo topic if you opt to store the encryption key outside the provider's \"Vault Service\". For this matter we've opted for a flexible solution, in which we do encryption via the Java API so that we can store the encryption key in the node's keystore file, but also the key handler could designate a key (eg address in the \"Vault Service\") that is meaningful only to the cloud library SDK.~\r\n~This is in-progress with the pre-requisite work of:~\r\n*  ~[Consistent Secure Settings](https://github.com/elastic/elasticsearch/pull/40416) because data nodes with different encryption keys would amount to hard to detect failure mode.~\r\n* ~[Client Side Encrypted Snapshot Repositories](https://github.com/elastic/elasticsearch/issues/41910)~\r\nIn the last team's meeting we decided to remove the `encrypted snapshot repo` prerequisite of this feature's (`Backup .security`). Chief reason being that the main motivation for this feature now comes from users with _encryption at rest_ and _key management_ policies; these requirements are on a different level than we originally anticipated, so the complexity of this feature now outgrows the complexity of the `Backup .security` for which encryption is only a nice to have.\r\n4. [x] [Document](https://github.com/elastic/elasticsearch/pull/42970) ~(and maybe enforce)~ the snapshotting of the _.security_ index ~only~ to a repository with encryption capabilities (see previous point). Documentation of the complete snapshot-restore flow (creating the file based role and user, closing .security, etc...)  is also required.\r\n\r\n\r\n","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}