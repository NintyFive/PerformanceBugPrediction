[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16701223","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16701223","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16701223,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAxMjIz","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T09:22:46Z","updated_at":"2013-04-20T09:22:46Z","author_association":"CONTRIBUTOR","body":"sorry, forgot the version. This happens on 0.90.RC2 and also on the last build I had for RC3. Didn't use to happen on 0.20 afaik, but didn't check it.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16702481","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16702481","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16702481,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAyNDgx","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T11:21:25Z","updated_at":"2013-04-20T11:21:25Z","author_association":"MEMBER","body":"This is not a shard issue, it also happens with one shard - and it also fails with 0.20.\n\nTo me it looks like your MVEL script is not correct and cannot be parsed. Check the last part of your error message, not the first name of the exception you are seeing.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16702573","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16702573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16702573,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAyNTcz","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T11:29:05Z","updated_at":"2013-04-20T11:29:05Z","author_association":"CONTRIBUTOR","body":"I did check the message and the line where it happens in the code. The exception is thrown at \nShardFieldDocSortedHitQueue line 102(final BytesRef s1 = (BytesRef) docA.fields[i];). \nDidn't look much more into it, but as far as I know the script is correct, it's been running in production with 0.20.4. and also, just grabbed a 0.20.4 release, tested and it works fine. Doesn't on 0.90.0 though. Unless I'm doing something very wrong and not realizing, it still seems like a bug to me.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16702704","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16702704","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16702704,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAyNzA0","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T11:41:11Z","updated_at":"2013-04-20T11:41:11Z","author_association":"MEMBER","body":"you sample above is not working, thats why I was confused. You put single ticks inside of the curl query and confused the shell with that as you also used them for the whole json data.\nSlightly changing and running your query now does not give me an exception either. Something still has to be different I guess. Any hints to get it reproduced for me?\n\n```\ncurl -XGET http://localhost:9200/script/test/_search -d '{\"query\":{\"match_all\":{}},\"fields\":\"\",\"sort\":[{\"_script\":{\"script\":\"if ( ! _source.groups_code.empty ) { result = ($.date in _source.groups_code if $.id == id); if ( ! result.empty ) { result[0] } }\",\"type\":\"string\",\"reverse\":true,\"params\":{\"id\":47642}}}]}'\n\n{\"took\":269,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":2,\"max_score\":null,\"hits\":[{\"_index\":\"script\",\"_type\":\"test\",\"_id\":\"1\",\"_score\":null,\"sort\":[\"2010-08-12T07:54:55Z\"]},{\"_index\":\"script\",\"_type\":\"test\",\"_id\":\"2\",\"_score\":null,\"sort\":[\"2010-05-04T12:10:54Z\"]}]}}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16702772","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16702772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16702772,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAyNzcy","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T11:47:53Z","updated_at":"2013-04-20T11:47:53Z","author_association":"CONTRIBUTOR","body":"From your response: {\"took\":269,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\ncould you try it with 2 shards? For 1 shard it works fine for me too\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16702792","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16702792","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16702792,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAyNzky","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T11:49:04Z","updated_at":"2013-04-20T11:49:04Z","author_association":"CONTRIBUTOR","body":"I mean, more than 1 shard on 0.90. On 0.20 works fine\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/16703398","html_url":"https://github.com/elastic/elasticsearch/issues/2920#issuecomment-16703398","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2920","id":16703398,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NzAzMzk4","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2013-04-20T12:41:27Z","updated_at":"2013-04-20T12:41:27Z","author_association":"MEMBER","body":"Ok, I can reproduce it now, just do this:\n\n```\ncurl -X DELETE localhost:9200/script\n\ncurl -XPOST http://localhost:9200/script -d '{\"settings\": { \"index.number_of_replicas\": 0, \"index.number_of_shards\": 2}}'\n\ncurl -XPUT http://localhost:9200/script/test/_mapping -d '{\"profile\":{\"dynamic\":\"strict\",\"properties\":{\"id\":{\"type\":\"integer\",\"index\":\"not_analyzed\",\"store\":\"yes\"},\"groups_code\":{\"properties\":{\"id\":{\"type\":\"integer\",\"index\":\"not_analyzed\"},\"date\":{\"type\":\"date\",\"index\":\"not_analyzed\",\"format\":\"date_time_no_millis\"}}}}}}'\n\ncurl -XPUT http://localhost:9200/script/test/1 -d '{\"groups_code\":[{\"id\":47642,\"date\":\"2010-08-12T07:54:55Z\"}]}'\ncurl -XPUT http://localhost:9200/script/test/2 -d '{\"groups_code\":[{\"id\":47642,\"date\":\"2010-05-04T12:10:54Z\"}]}'\n\ncurl -XGET http://localhost:9200/script/test/_search -d '{\"query\":{\"match_all\":{}},\"fields\":\"\",\"sort\":[{\"_script\":{\"script\":\"if ( ! _source.groups_code.empty ) { result = ($.date in _source.groups_code if $.id == id); if ( ! result.empty ) { result[0] } else { \\u0027\\u0027 } }\",\"type\":\"string\",\"reverse\":true,\"params\":{\"id\":47642}}}]}'\n```\n\nAnd to make it even simpler, this leads to the exception as well:\n\n```\ncurl -XGET http://localhost:9200/script/test/_search -d '{\"query\":{\"match_all\":{}},\"fields\":\"\",\"sort\":[{\"_script\":{\"script\":\"\\u0027\\u0027\",\"type\":\"string\" }}]}'\n```\n\nLooks like we forgot to change a BytesRef to a string (might explain that it happens since we switched to lucene 4 with ES 0.90). So yeah, bug.\n\nMany many thanks for your time reporting and explaining!\n","performed_via_github_app":null}]