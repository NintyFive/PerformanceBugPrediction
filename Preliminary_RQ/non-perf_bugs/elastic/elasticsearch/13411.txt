{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13411","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13411/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13411/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13411/events","html_url":"https://github.com/elastic/elasticsearch/issues/13411","id":105528447,"node_id":"MDU6SXNzdWUxMDU1Mjg0NDc=","number":13411,"title":"can not get document id in Scripted Metric Aggregation","user":{"login":"759803573","id":9429246,"node_id":"MDQ6VXNlcjk0MjkyNDY=","avatar_url":"https://avatars2.githubusercontent.com/u/9429246?v=4","gravatar_id":"","url":"https://api.github.com/users/759803573","html_url":"https://github.com/759803573","followers_url":"https://api.github.com/users/759803573/followers","following_url":"https://api.github.com/users/759803573/following{/other_user}","gists_url":"https://api.github.com/users/759803573/gists{/gist_id}","starred_url":"https://api.github.com/users/759803573/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/759803573/subscriptions","organizations_url":"https://api.github.com/users/759803573/orgs","repos_url":"https://api.github.com/users/759803573/repos","events_url":"https://api.github.com/users/759803573/events{/privacy}","received_events_url":"https://api.github.com/users/759803573/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-09-09T06:22:15Z","updated_at":"2015-09-11T05:28:58Z","closed_at":"2015-09-11T05:28:58Z","author_association":"NONE","active_lock_reason":null,"body":"I have same error data in ES. \nThe error field is word_count. Its value is calculated by field(sentence).\nso I want to get these document id ,then use bulk to update.\nuse  Scripted Metric Aggregation  I can get _index and _type   ,but can not get _id.\n- for example I can get _index and _type\n\n``` json\n {\n    \"size\":0,\n    \"aggs\":{\n      \"err_ids\": {\n        \"scripted_metric\": {\n           \"init_script\" : \"_agg[\\\"count\\\"]=0;_agg[\\\"err_ids\\\"]=[];\",\n           \"map_script\" : \"if(_agg[\\\"count\\\"]==0){_agg[\\\"err_ids\\\"].add([doc._index,doc._type]);_agg[\\\"count\\\"]=1}\",\n           \"combine_script\" : \"return _agg[\\\"err_ids\\\"]\",\n           \"reduce_script\" : \"return _aggs\"\n                          }\n                 }\n    }\n }\n{\n  \"took\" : 38,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 32448,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"err_ids\" : {\n      \"value\" : [ [ [ [ \"als-552b873f6d6f6e176d040000-2015.09.07\" ], [ \"als_production\" ] ] ] ]\n    }\n  }\n}\n```\n- but the _id is null\n\n``` json\n{\n    \"size\":0,\n    \"aggs\":{\n      \"err_ids\": {\n        \"scripted_metric\": {\n           \"init_script\" : \"_agg[\\\"count\\\"]=0;_agg[\\\"err_ids\\\"]=[];\",\n           \"map_script\" : \"if(_agg[\\\"count\\\"]==0){_agg[\\\"err_ids\\\"].add([doc._id,doc._id.value]);_agg[\\\"count\\\"]=1}\",\n           \"combine_script\" : \"return _agg[\\\"err_ids\\\"]\",\n           \"reduce_script\" : \"return _aggs\"\n                          }\n                 }\n    }\n }\n{\n  \"took\" : 43,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 32448,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"err_ids\" : {\n      \"value\" : [ [ [ [ ], null ] ] ]\n    }\n  }\n}\n```\n\nnow I use script filter get these ids ,but it is not convenient to use\n\n``` json\n {\n    \"size\":10,\n    \"fields\":[],\n    \"filter\":{\n      \"script\": {\n           \"script\" : \"(doc[\\\"word_count\\\"].value != doc[\\\"sentence\\\"].value.toString().split(/\\\\s+/).length)\"\n                 }\n    }\n }\n{\n  \"took\" : 108,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 32346,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"als-xxxxxxxxxxxxx-2015.09.07\",\n      \"_type\" : \"als_production\",\n      \"_id\" : \"AU-oW1n_q-7mSo1II5ZH\",\n      \"_score\" : 1.0\n    },\n   ......ï¼½\n }\n}\n```\n","closed_by":{"login":"759803573","id":9429246,"node_id":"MDQ6VXNlcjk0MjkyNDY=","avatar_url":"https://avatars2.githubusercontent.com/u/9429246?v=4","gravatar_id":"","url":"https://api.github.com/users/759803573","html_url":"https://github.com/759803573","followers_url":"https://api.github.com/users/759803573/followers","following_url":"https://api.github.com/users/759803573/following{/other_user}","gists_url":"https://api.github.com/users/759803573/gists{/gist_id}","starred_url":"https://api.github.com/users/759803573/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/759803573/subscriptions","organizations_url":"https://api.github.com/users/759803573/orgs","repos_url":"https://api.github.com/users/759803573/repos","events_url":"https://api.github.com/users/759803573/events{/privacy}","received_events_url":"https://api.github.com/users/759803573/received_events","type":"User","site_admin":false},"performed_via_github_app":null}