{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33769","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33769/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33769/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33769/events","html_url":"https://github.com/elastic/elasticsearch/issues/33769","id":360883019,"node_id":"MDU6SXNzdWUzNjA4ODMwMTk=","number":33769,"title":"Deprecated credentials overwrite client settings in all configured repository clients","user":{"login":"pebrc","id":697790,"node_id":"MDQ6VXNlcjY5Nzc5MA==","avatar_url":"https://avatars0.githubusercontent.com/u/697790?v=4","gravatar_id":"","url":"https://api.github.com/users/pebrc","html_url":"https://github.com/pebrc","followers_url":"https://api.github.com/users/pebrc/followers","following_url":"https://api.github.com/users/pebrc/following{/other_user}","gists_url":"https://api.github.com/users/pebrc/gists{/gist_id}","starred_url":"https://api.github.com/users/pebrc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pebrc/subscriptions","organizations_url":"https://api.github.com/users/pebrc/orgs","repos_url":"https://api.github.com/users/pebrc/repos","events_url":"https://api.github.com/users/pebrc/events{/privacy}","received_events_url":"https://api.github.com/users/pebrc/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-09-17T13:59:51Z","updated_at":"2018-09-19T20:18:55Z","closed_at":"2018-09-19T20:18:55Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.x\r\n\r\n**Plugins installed**: [discovery-file, found-elasticsearch, repository-s3]\r\n\r\n**JVM version** (`java -version`): 1.8.0_144; 25.144-b01;\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):Linux 4.4.0-1048-aws #57-Ubuntu SMP\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nConfiguring a s3 repository that uses deprecated credentials specified directly in the repository client settings overwrites the credentials in all repository clients. \r\n\r\nExpected behaviour would be that the legacy credentials are only used to populate the settings object that corresponds to the repository/client that actually specified them.\r\n\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\n 1. configure a s3 repository (`repository 1`) that [uses secure credentials](https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository-s3-client.html) and a non-default client name\r\n 2. verify that this repository works \r\n 3. configure a second repository using the default client name and deprecated credentials specified directly in the request creating the repository e.g. \r\n\r\n```\r\n\"repository-2\": {\r\n    \"type\": \"s3\",\r\n    \"settings\": {\r\n      \"bucket\": \"bucket-name\",\r\n      \"access_key\": \"your-access-key\",\r\n      \"secret_key\": \"your-secret-key\"\r\n    }\r\n  }\r\n```\r\n4. verify that the `repository 2` works\r\n5. find that access to `repository 1`  is now denied\r\n\r\n\r\n**Additional information**:\r\n\r\n`POST _nodes/reload_secure_settings` is a workaround which restores the secure credentials for `repository 1`  but \"breaks\" `repository 2` in the process.\r\n\r\nScreenshot of a heap dump I took from the cluster, see the legacy credentials being propagated into both settings objects\r\n![screen shot 2018-09-17 at 15 05 57](https://user-images.githubusercontent.com/697790/45627244-ce5c9b80-ba91-11e8-9ea2-9e317def4ba4.png)\r\n\r\nLooking at the s3 repository plugin code the deprecated credentials seem to be propagated into every S3ClientSettings object when the S3 repository object holding the legacy credentials is constructed: \r\nhttps://github.com/elastic/elasticsearch/blob/4108722052707c4d9acc1b211e6fd2f77885dcc2/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java#L163-L174\r\n\r\nCalled here with on settings retrieved from the S3Service object:\r\nhttps://github.com/elastic/elasticsearch/blob/b1bf643e41b2bf2bc1360887b4768836c9159214/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Repository.java#L251-L254\r\n\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}