{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15820","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15820/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15820/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15820/events","html_url":"https://github.com/elastic/elasticsearch/issues/15820","id":125378052,"node_id":"MDU6SXNzdWUxMjUzNzgwNTI=","number":15820,"title":"memory leak in BitsetFilterCache","user":{"login":"jamesjin","id":2654909,"node_id":"MDQ6VXNlcjI2NTQ5MDk=","avatar_url":"https://avatars2.githubusercontent.com/u/2654909?v=4","gravatar_id":"","url":"https://api.github.com/users/jamesjin","html_url":"https://github.com/jamesjin","followers_url":"https://api.github.com/users/jamesjin/followers","following_url":"https://api.github.com/users/jamesjin/following{/other_user}","gists_url":"https://api.github.com/users/jamesjin/gists{/gist_id}","starred_url":"https://api.github.com/users/jamesjin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jamesjin/subscriptions","organizations_url":"https://api.github.com/users/jamesjin/orgs","repos_url":"https://api.github.com/users/jamesjin/repos","events_url":"https://api.github.com/users/jamesjin/events{/privacy}","received_events_url":"https://api.github.com/users/jamesjin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-01-07T11:41:37Z","updated_at":"2016-01-12T14:01:29Z","closed_at":"2016-01-08T08:59:28Z","author_association":"NONE","active_lock_reason":null,"body":"When we have many indices and part of them contains nested type, we can find that the heap is cost by BitsetFilterCache very quickly. It can be reproduced on ES2.1 under the default setting. Here is the steps:\n1. create two indices \"index1\" and \"index2\"\n2. add type \"tweet\" with nested type \"comments\" to \"index1\"\n3. add a new tweet doc to \"index1\"\n4. wait until it finishes the refresh\n5. dump the heap, you can find that the \"loadedFilters\" field of BitsetFilterCache of \"index2\" contains the query result of \"index1\".\n\nAnd the root cause is:\n\nBitSetProducerWarmer does not check the index name in the method BitSetProducerWarmer#warmNewReaders. And IndicesWarmer notifies every BitSetProducerWarmer even the indexShard does not belong to the index of the BitSetProducerWarmer\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}