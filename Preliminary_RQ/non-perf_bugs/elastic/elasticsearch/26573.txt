{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26573","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26573/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26573/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26573/events","html_url":"https://github.com/elastic/elasticsearch/issues/26573","id":256684320,"node_id":"MDU6SXNzdWUyNTY2ODQzMjA=","number":26573,"title":"Decouple global checkpoint sync from a shard falling idle","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null},{"id":699760326,"node_id":"MDU6TGFiZWw2OTk3NjAzMjY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-rc1","name":"v6.0.0-rc1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2017-09-11T12:27:10Z","updated_at":"2018-02-14T14:07:17Z","closed_at":"2017-09-21T19:34:14Z","author_association":"MEMBER","active_lock_reason":null,"body":"Global checkpoints are inlined with replication operations. This means that a replication request from a primary to a replica carries the global checkpoint on the primary to the replica who then updates its local knowledge of the global checkpoint. There's a problem though in that the replica will always be lagging. Consider the last indexing operation on a shard. This operation will carry the global checkpoint known to the primary at the time that the primary completed the operation but before the replicas have completed the operation; by definition, this global checkpoint can not be equal to what the global checkpoint could advance to after the operation completes. When the replicas complete the operation, their local checkpoint will advance and they will relay this information back to the primary so that the global checkpoint could now advance further. Without a follow-up operation, the local knowledge of the global checkpoint on the replicas will never advance. To account for this, today we send a background global checkpoint sync when the primary shard falls idle. This carries problems though:\r\n - the shard idle timer is by default five minutes, a long time to wait for the global checkpoint to advance\r\n - there's no follow-up sync if a replica misses the sync when the shard idle timer fires\r\n - there's an inherent race condition where the primary shard could fall idle before an on-going operation completes, meaning that there will never be a background sync when that operation does complete\r\n\r\nTo account for this, we are going to decouple the background sync from a shard falling idle, and instead add a periodic background sync that sends a sync if there is a replica that is behind the global checkpoint on the primary.","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}