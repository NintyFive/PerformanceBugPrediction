{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32875","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32875/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32875/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32875/events","html_url":"https://github.com/elastic/elasticsearch/issues/32875","id":350869635,"node_id":"MDU6SXNzdWUzNTA4Njk2MzU=","number":32875,"title":"Highlighting with a large field value causes an exception that brings data nodes down","user":{"login":"jorgelbg","id":1291846,"node_id":"MDQ6VXNlcjEyOTE4NDY=","avatar_url":"https://avatars2.githubusercontent.com/u/1291846?v=4","gravatar_id":"","url":"https://api.github.com/users/jorgelbg","html_url":"https://github.com/jorgelbg","followers_url":"https://api.github.com/users/jorgelbg/followers","following_url":"https://api.github.com/users/jorgelbg/following{/other_user}","gists_url":"https://api.github.com/users/jorgelbg/gists{/gist_id}","starred_url":"https://api.github.com/users/jorgelbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jorgelbg/subscriptions","organizations_url":"https://api.github.com/users/jorgelbg/orgs","repos_url":"https://api.github.com/users/jorgelbg/repos","events_url":"https://api.github.com/users/jorgelbg/events{/privacy}","received_events_url":"https://api.github.com/users/jorgelbg/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-08-15T16:08:35Z","updated_at":"2018-08-16T07:53:29Z","closed_at":"2018-08-16T07:53:29Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): `6.2.3` / `6.3.2`\r\n\r\n**Plugins installed**: `x-pack`\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\njava version \"1.8.0_152\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_152-b16)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.152-b16, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n```\r\nLinux elastic4 3.16.0-4-amd64 #1 SMP Debian 3.16.51-3 (2017-12-13) x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIf a query with a very long field value is fired against the cluster, like the one shown below *with highlighting enabled*\r\n\r\nℹ️ _Full query can be found in: https://gist.github.com/jorgelbg/ff86aa5632b802f6bcf49c2f6ef90492_\r\n\r\n```\r\n{\r\n  \"version\": true,\r\n  \"size\": 500,\r\n  \"sort\": [\r\n    {\r\n      \"@timestamp\": {\r\n        \"order\": \"desc\",\r\n        \"unmapped_type\": \"boolean\"\r\n      }\r\n    }\r\n  ],\r\n  \"_source\": {\r\n    \"excludes\": [\r\n      \r\n    ]\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"interval\": \"12h\",\r\n        \"time_zone\": \"Europe/Berlin\",\r\n        \"min_doc_count\": 1\r\n      }\r\n    }\r\n  },\r\n  \"stored_fields\": [\r\n    \"*\"\r\n  ],\r\n  \"script_fields\": {\r\n    \r\n  },\r\n  \"docvalue_fields\": [\r\n    \"@timestamp\"\r\n  ],\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match_all\": {\r\n            \r\n          }\r\n        },\r\n        {\r\n          \"match_phrase\": {\r\n            \"exception\": {\r\n              \"query\": \"<VERY_LONG_TERM>\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": 1533074400000,\r\n              \"lte\": 1535752799999,\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"filter\": [\r\n        \r\n      ],\r\n      \"should\": [\r\n        \r\n      ],\r\n      \"must_not\": [\r\n        \r\n      ]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [\r\n      \"@kibana-highlighted-field@\"\r\n    ],\r\n    \"post_tags\": [\r\n      \"@/kibana-highlighted-field@\"\r\n    ],\r\n    \"fields\": {\r\n      \"*\": {\r\n        \r\n      }\r\n    },\r\n    \"fragment_size\": 2147483647\r\n  }\r\n}\r\n```\r\n\r\nHits the data nodes, the cluster logs a StackOverflowError and dies with the following error:\r\n\r\n```\r\njava.lang.StackOverflowError: null\r\n\tat org.apache.lucene.util.automaton.DaciukMihovAutomatonBuilder.replaceOrRegister(DaciukMihovAutomatonBuilder.java:324) ~[lucene-core-7.2.1.jar:7.2.1 b2b6438b37073bee1fca40374e85bf91aa457c0b - ubuntu - 2018-01-10 00:48:43]\r\n\tat org.apache.lucene.util.automaton.DaciukMihovAutomatonBuilder.replaceOrRegister(DaciukMihovAutomatonBuilder.java:324) ~[lucene-core-7.2.1.jar:7.2.1 b2b6438b37073bee1fca40374e85bf91aa457c0b - ubuntu - 2018-01-10 00:48:43]\r\n\tat org.apache.lucene.util.automaton.DaciukMihovAutomatonBuilder.replaceOrRegister(DaciukMihovAutomatonBuilder.java:324) ~[lucene-core-7.2.1.jar:7.2.1 b2b6438b37073bee1fca40374e85bf91aa457c0b - ubuntu - 2018-01-10 00:48:43]\r\n```\r\n\r\nThe `exception` field is stored as a `keyword` type. This is related to the bug fixed in (https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d78feb2) but since this is in for Lucene 7.5/8.0 probably some safeguard needs to be added from the elasticsearch side.\r\n\r\n```json\r\n\"exception\": {\r\n    \"type\": \"keyword\"\r\n},\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nWe've encountered this issue in our production cluster, and was able to reproduce it successfully in Elasticsearch 6.2.3/6.3.2 running in a local Docker container:\r\n\r\n1. Run an `elasticsearch/elasticsearch` container:\r\n\r\n```sh\r\n$ docker run -p 9200:9200 -p 9300:9300 -e \"discovery.type=single-node\" docker.elastic.co/elasticsearch/elasticsearch:6.3.2\r\n```\r\n\r\n2. Create a new index with the `exception` field mapped to a `keyword` type:\r\n\r\n```\r\nPUT /php\r\n{\r\n  \"mappings\": {\r\n    \"logs\": {\r\n      \"_all\": {\r\n        \"enabled\": false\r\n      },\r\n      \"properties\": {\r\n        \"exception\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n3. Add a sample document with some long random text on the `exception` field.\r\n\r\n4. Fire the query. (Could be done from Kibana, just by adding a filter on the given field/value)\r\n\r\nI think this relates to #27517. The danger is not only about slow execution but it could easily take a cluster partially/entirely down.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}