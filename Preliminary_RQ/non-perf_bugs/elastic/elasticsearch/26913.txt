{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26913","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26913/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26913/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26913/events","html_url":"https://github.com/elastic/elasticsearch/issues/26913","id":263482527,"node_id":"MDU6SXNzdWUyNjM0ODI1Mjc=","number":26913,"title":"ECS Task IAM profile credentials ignored in repository-s3 plugin","user":{"login":"JeffDownie","id":5860910,"node_id":"MDQ6VXNlcjU4NjA5MTA=","avatar_url":"https://avatars1.githubusercontent.com/u/5860910?v=4","gravatar_id":"","url":"https://api.github.com/users/JeffDownie","html_url":"https://github.com/JeffDownie","followers_url":"https://api.github.com/users/JeffDownie/followers","following_url":"https://api.github.com/users/JeffDownie/following{/other_user}","gists_url":"https://api.github.com/users/JeffDownie/gists{/gist_id}","starred_url":"https://api.github.com/users/JeffDownie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JeffDownie/subscriptions","organizations_url":"https://api.github.com/users/JeffDownie/orgs","repos_url":"https://api.github.com/users/JeffDownie/repos","events_url":"https://api.github.com/users/JeffDownie/events{/privacy}","received_events_url":"https://api.github.com/users/JeffDownie/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"vladimirdolzhenko","id":209440,"node_id":"MDQ6VXNlcjIwOTQ0MA==","avatar_url":"https://avatars0.githubusercontent.com/u/209440?v=4","gravatar_id":"","url":"https://api.github.com/users/vladimirdolzhenko","html_url":"https://github.com/vladimirdolzhenko","followers_url":"https://api.github.com/users/vladimirdolzhenko/followers","following_url":"https://api.github.com/users/vladimirdolzhenko/following{/other_user}","gists_url":"https://api.github.com/users/vladimirdolzhenko/gists{/gist_id}","starred_url":"https://api.github.com/users/vladimirdolzhenko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vladimirdolzhenko/subscriptions","organizations_url":"https://api.github.com/users/vladimirdolzhenko/orgs","repos_url":"https://api.github.com/users/vladimirdolzhenko/repos","events_url":"https://api.github.com/users/vladimirdolzhenko/events{/privacy}","received_events_url":"https://api.github.com/users/vladimirdolzhenko/received_events","type":"User","site_admin":false},"assignees":[{"login":"vladimirdolzhenko","id":209440,"node_id":"MDQ6VXNlcjIwOTQ0MA==","avatar_url":"https://avatars0.githubusercontent.com/u/209440?v=4","gravatar_id":"","url":"https://api.github.com/users/vladimirdolzhenko","html_url":"https://github.com/vladimirdolzhenko","followers_url":"https://api.github.com/users/vladimirdolzhenko/followers","following_url":"https://api.github.com/users/vladimirdolzhenko/following{/other_user}","gists_url":"https://api.github.com/users/vladimirdolzhenko/gists{/gist_id}","starred_url":"https://api.github.com/users/vladimirdolzhenko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vladimirdolzhenko/subscriptions","organizations_url":"https://api.github.com/users/vladimirdolzhenko/orgs","repos_url":"https://api.github.com/users/vladimirdolzhenko/repos","events_url":"https://api.github.com/users/vladimirdolzhenko/events{/privacy}","received_events_url":"https://api.github.com/users/vladimirdolzhenko/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2017-10-06T15:20:59Z","updated_at":"2018-07-19T10:54:39Z","closed_at":"2018-07-19T10:54:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 5.6.2\r\n\r\n**Plugins installed**: [repository-s3]\r\n\r\n**JVM version** (`java -version`): Doesn't seem to matter\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Doesn't seem to matter\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen using the repository-s3 plugin from within an ECS Task that has an [ECS Task IAM role\r\n](http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html), the repository-s3 instead loads the underlying ec2 host's credentials, which appears to be contrary (or at least unexpected!), based on what is in the [usage guide](https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/repository-s3-usage.html)\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Install elasticsearch 5.6.2 on a docker container\r\n 2. Use docker container in a task definition on AWS ECS\r\n 3. Give task definition an IAM role with access to an s3 bucket\r\n 4. Give EC2 instance an IAM role that denies access to s3 bucket\r\n 5. Install repository-s3 plugin using `elasticsearch-plugin install repository-s3`\r\n 6. Start elasticsearch\r\n 7. Attempt to create a repository using as specified at [https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/repository-s3-repository.html#repository-s3-repository](https://www.elastic.co/guide/en/elasticsearch/plugins/5.6/repository-s3-repository.html#repository-s3-repository), which fails.\r\n 8. Note that the aws cli is, however able to access the s3 bucket from inside the container correctly (e.g., aws s3 ls s3::/<BUCKET_NAME> works).\r\n\r\n**Believed cause**:\r\n\r\nI believe I've tracked the issue down to https://github.com/elastic/elasticsearch/blob/16431a660188a7fb799de12df22a3193fbb491ec/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/InternalAwsS3Service.java#L172, which uses an [InstanceProfileCredentialsProvider](http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/InstanceProfileCredentialsProvider.html), rather than the [DefaultAWSCredentialsProviderChain](http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html), which I would have thought would be more appropriate, unless I am missing something?","closed_by":{"login":"vladimirdolzhenko","id":209440,"node_id":"MDQ6VXNlcjIwOTQ0MA==","avatar_url":"https://avatars0.githubusercontent.com/u/209440?v=4","gravatar_id":"","url":"https://api.github.com/users/vladimirdolzhenko","html_url":"https://github.com/vladimirdolzhenko","followers_url":"https://api.github.com/users/vladimirdolzhenko/followers","following_url":"https://api.github.com/users/vladimirdolzhenko/following{/other_user}","gists_url":"https://api.github.com/users/vladimirdolzhenko/gists{/gist_id}","starred_url":"https://api.github.com/users/vladimirdolzhenko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vladimirdolzhenko/subscriptions","organizations_url":"https://api.github.com/users/vladimirdolzhenko/orgs","repos_url":"https://api.github.com/users/vladimirdolzhenko/repos","events_url":"https://api.github.com/users/vladimirdolzhenko/events{/privacy}","received_events_url":"https://api.github.com/users/vladimirdolzhenko/received_events","type":"User","site_admin":false},"performed_via_github_app":null}