[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71531678","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-71531678","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":71531678,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNTMxNjc4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-26T20:27:26Z","updated_at":"2015-01-26T20:27:26Z","author_association":"CONTRIBUTOR","body":"Hi @dimzak \n\nWhat's the new mapping for the `ts`  field, in the `delivery-logs-index.prod-20150126` index?  What does your template look like? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71618901","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-71618901","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":71618901,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNjE4OTAx","user":{"login":"dimzak","id":4560173,"node_id":"MDQ6VXNlcjQ1NjAxNzM=","avatar_url":"https://avatars3.githubusercontent.com/u/4560173?v=4","gravatar_id":"","url":"https://api.github.com/users/dimzak","html_url":"https://github.com/dimzak","followers_url":"https://api.github.com/users/dimzak/followers","following_url":"https://api.github.com/users/dimzak/following{/other_user}","gists_url":"https://api.github.com/users/dimzak/gists{/gist_id}","starred_url":"https://api.github.com/users/dimzak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimzak/subscriptions","organizations_url":"https://api.github.com/users/dimzak/orgs","repos_url":"https://api.github.com/users/dimzak/repos","events_url":"https://api.github.com/users/dimzak/events{/privacy}","received_events_url":"https://api.github.com/users/dimzak/received_events","type":"User","site_admin":false},"created_at":"2015-01-27T09:55:50Z","updated_at":"2015-01-27T10:00:07Z","author_association":"NONE","body":"It's the same!! Nothing changed from 1.3.5\n\n`GET delivery-logs-index.prod-20150126/_mapping/`:\npart of response:\n\n``` json\n \"ts\": {\n                  \"type\": \"date\",\n                  \"doc_values\": true,\n                  \"format\": \"dateOptionalTime\"\n               },\n               \"uid\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"doc_values\": true\n               }\n```\n\ntemplate is a little different actually:\npart response:\n\n``` json\n\"uid\": {\n                  \"index\": \"not_analyzed\",\n                  \"doc_values\": true,\n                  \"type\": \"string\"\n               },\n               \"ts\": {\n                  \"index\": \"not_analyzed\",\n                  \"doc_values\": true,\n                  \"type\": \"date\"\n               },\n```\n\nTo reproduce this change locally:\n\n``` json\ncurl -XPUT \"http://localhost:9200/_template/template_1\" -d'\n{\n  \"template\": \"te*\",\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"main\": {\n      \"properties\": {\n        \"name\": {\n          \"index\": \"not_analyzed\",\n          \"type\": \"string\",\n          \"doc_values\": true\n        },\n        \"ts\": {\n          \"index\": \"not_analyzed\",\n          \"type\": \"date\",\n          \"doc_values\": true\n        },\n        \"type\": {\n          \"index\": \"not_analyzed\",\n          \"type\": \"string\"\n        }\n      }\n    }\n  }\n}'\n```\n\n```\nPUT /test/\n```\n\n```\nGET /test/_mapping\n```\n\n``` json\n{\n   \"test\": {\n      \"mappings\": {\n         \"main\": {\n            \"properties\": {\n               \"name\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"doc_values\": true\n               },\n               \"ts\": {\n                  \"type\": \"date\",\n                  \"doc_values\": true,\n                  \"format\": \"dateOptionalTime\"\n               },\n               \"type\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nAs far as I understand `ts` is mapped wrong by template(`index not_analyzed` not working) but that worked ok in 1.3.5 ???\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71623652","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-71623652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":71623652,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNjIzNjUy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-27T10:32:36Z","updated_at":"2015-01-27T10:32:36Z","author_association":"CONTRIBUTOR","body":"Hi @dimzak \n\nI've tried this out on 1.3.7 and it works correctly.  The `index: not_analyzed` doesn't interfere with the doc values setting.\n\nIn your example, you set the number of shards to 1.  Is that the same as you have in your real settings?  I'm wondering if your mappings are out of sync across multiple shards.\n\nCould you paste the output of this request please:\n\n```\ncurl -XGET \"http://localhost:9200/_nodes/stats/indices/fielddata?fields=ts&level=shards\"\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71625500","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-71625500","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":71625500,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNjI1NTAw","user":{"login":"dimzak","id":4560173,"node_id":"MDQ6VXNlcjQ1NjAxNzM=","avatar_url":"https://avatars3.githubusercontent.com/u/4560173?v=4","gravatar_id":"","url":"https://api.github.com/users/dimzak","html_url":"https://github.com/dimzak","followers_url":"https://api.github.com/users/dimzak/followers","following_url":"https://api.github.com/users/dimzak/following{/other_user}","gists_url":"https://api.github.com/users/dimzak/gists{/gist_id}","starred_url":"https://api.github.com/users/dimzak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimzak/subscriptions","organizations_url":"https://api.github.com/users/dimzak/orgs","repos_url":"https://api.github.com/users/dimzak/repos","events_url":"https://api.github.com/users/dimzak/events{/privacy}","received_events_url":"https://api.github.com/users/dimzak/received_events","type":"User","site_admin":false},"created_at":"2015-01-27T10:48:02Z","updated_at":"2015-01-27T10:48:02Z","author_association":"NONE","body":"I tried above request on real environment:\nIt returns for all shards of today index this:\n\n``` json\n\"delivery-logs-index.prod-20150126\": [\n                  {\n                     \"3\": {\n                        \"routing\": {\n                           \"state\": \"STARTED\",\n                           \"primary\": false,\n                           \"node\": \"Hnfn3gBHROqgXf44kFy2nQ\",\n                           \"relocating_node\": null\n                        },\n                        \"fielddata\": {\n                           \"memory_size_in_bytes\": 556041606,\n                           \"evictions\": 166,\n                           \"fields\": {\n                              \"ts\": {\n                                 \"memory_size_in_bytes\": 147910272\n                              }\n                           }\n                        }\n                     }\n                  }\n               ]\n              ...\n\"delivery-logs-index.prod-20150126\": [\n                  {\n                     \"6\": {\n                        \"routing\": {\n                           \"state\": \"STARTED\",\n                           \"primary\": true,\n                           \"node\": \"WM9Qx7hOTMmufiztVI3FQg\",\n                           \"relocating_node\": null\n                        },\n                        \"fielddata\": {\n                           \"memory_size_in_bytes\": 387633584,\n                           \"evictions\": 445,\n                           \"fields\": {\n                              \"ts\": {\n                                 \"memory_size_in_bytes\": 145310504\n                              }\n                           }\n                        }\n                     }\n                  },\n                  {\n                     \"10\": {\n                        \"routing\": {\n                           \"state\": \"STARTED\",\n                           \"primary\": false,\n                           \"node\": \"WM9Qx7hOTMmufiztVI3FQg\",\n                           \"relocating_node\": null\n                        },\n                        \"fielddata\": {\n                           \"memory_size_in_bytes\": 410697652,\n                           \"evictions\": 413,\n                           \"fields\": {\n                              \"ts\": {\n                                 \"memory_size_in_bytes\": 148780992\n                              }\n                           }\n                        }\n                     }\n                  }\n               ],\n```\n\nAll shards have `ts` in `fielddata`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71656551","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-71656551","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":71656551,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNjU2NTUx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-27T14:33:02Z","updated_at":"2015-01-27T14:33:02Z","author_association":"CONTRIBUTOR","body":"@jpountz any ideas here?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/76511504","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-76511504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":76511504,"node_id":"MDEyOklzc3VlQ29tbWVudDc2NTExNTA0","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-02-28T05:20:39Z","updated_at":"2015-02-28T05:20:39Z","author_association":"CONTRIBUTOR","body":"@jpountz pinging again - any ideas here?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/76520516","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-76520516","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":76520516,"node_id":"MDEyOklzc3VlQ29tbWVudDc2NTIwNTE2","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-02-28T10:25:34Z","updated_at":"2015-02-28T10:25:34Z","author_association":"CONTRIBUTOR","body":"Sorry I missed the previous ping.\n\nI don't see any suspicious change in the changelog between 1.3.5 and 1.3.7 (this is the migration which has been done right?). I'm wondering if you have several mappings that have a `ts` field on your indices and doc values are only enabled on one of them? It could explain the issue since the mapping which is taken into account for fielddata depends on the order in which they have been parsed (the first wins).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/94438652","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-94438652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":94438652,"node_id":"MDEyOklzc3VlQ29tbWVudDk0NDM4NjUy","user":{"login":"dimzak","id":4560173,"node_id":"MDQ6VXNlcjQ1NjAxNzM=","avatar_url":"https://avatars3.githubusercontent.com/u/4560173?v=4","gravatar_id":"","url":"https://api.github.com/users/dimzak","html_url":"https://github.com/dimzak","followers_url":"https://api.github.com/users/dimzak/followers","following_url":"https://api.github.com/users/dimzak/following{/other_user}","gists_url":"https://api.github.com/users/dimzak/gists{/gist_id}","starred_url":"https://api.github.com/users/dimzak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimzak/subscriptions","organizations_url":"https://api.github.com/users/dimzak/orgs","repos_url":"https://api.github.com/users/dimzak/repos","events_url":"https://api.github.com/users/dimzak/events{/privacy}","received_events_url":"https://api.github.com/users/dimzak/received_events","type":"User","site_admin":false},"created_at":"2015-04-20T12:27:46Z","updated_at":"2015-04-20T12:27:46Z","author_association":"NONE","body":"Hi @jpountz, sorry for the delay...\nMigration was 1.3.5 -> 1.3.7\n\nUnfortunately it was not a double mapping thing, but I managed to reproduce the exact error in an amazon environment( pure v1.3.7 without migration from 1.3.5).\n\nI believe the problem is that `ts` field exists also in nested documents(sorry if I forgot to mention it earlier)\n\nand so with the below mapping:\n\n``` json\n\"mappings\": {\n   \"track-event\": {\n      \"dynamic\": \"strict\",\n      \"_all\": {\n         \"enabled\": false\n      },\n      \"_parent\": {\n         \"type\": \"ad-request\"\n      },\n      \"_routing\": {\n         \"required\": true\n      },\n      \"_timestamp\": {\n         \"enabled\": true,\n         \"store\": true\n      },\n      \"properties\": {\n         \"chid\": {\n            \"type\": \"string\",\n            \"index\": \"not_analyzed\"\n         },\n         \"event\": {\n            \"type\": \"string\",\n            \"index\": \"not_analyzed\"\n         },\n         \"ts\": {\n            \"type\": \"date\",\n            \"format\": \"dateOptionalTime\"\n         }\n      }\n   },\n   \"ad-request\": {\n      \"dynamic\": \"strict\",\n      \"_all\": {\n         \"enabled\": false\n      },\n      \"_id\": {\n         \"path\": \"rid\"\n      },\n      \"_timestamp\": {\n         \"enabled\": true,\n         \"store\": true\n      },\n      \"properties\": {\n         \"chid\": {\n            \"type\": \"string\",\n            \"index\": \"not_analyzed\"\n         }\n         \"track_events\": {\n            \"type\": \"nested\",\n            \"include_in_parent\": true,\n            \"dynamic\": \"strict\",\n            \"properties\": {\n               \"chid\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n               },\n               \"event\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n               },\n               \"ts\": {\n                  \"type\": \"date\",\n                  \"format\": \"dateOptionalTime\"\n               }\n            }\n         },\n         \"ts\": {\n            \"type\": \"date\",\n            \"doc_values\": true,\n            \"format\": \"dateOptionalTime\"\n         },\n         \"event\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"doc_values\": true\n         },\n         \"uid\": {\n            \"type\": \"string\",\n            \"index\": \"not_analyzed\",\n            \"doc_values\": true\n         }\n      }\n   }\n}\n```\n\nboth `ts` and `event` even though they are stored as `doc_values`, when searching `fielddata` result is:\n`GET /delivery-logs-index.prod-*/_stats/fielddata?fields=ts,uid,event`\n\nResult:\n\n``` json\n{\n   \"_shards\": {\n      \"total\": 600,\n      \"successful\": 600,\n      \"failed\": 0\n   },\n   \"_all\": {\n      \"primaries\": {\n         \"fielddata\": {\n            \"memory_size_in_bytes\": 29238124,\n            \"evictions\": 0,\n            \"fields\": {\n               \"ts\": {\n                  \"memory_size_in_bytes\": 17727368\n               },\n               \"event\": {\n                  \"memory_size_in_bytes\": 4929652\n               }\n            }\n         }\n      },\n      \"total\": {\n         \"fielddata\": {\n            \"memory_size_in_bytes\": 52637682,\n            \"evictions\": 0,\n            \"fields\": {\n               \"ts\": {\n                  \"memory_size_in_bytes\": 35516768\n               },\n               \"event\": {\n                  \"memory_size_in_bytes\": 7405266\n               }\n            }\n         }\n      }\n   },\n```\n\nSo this has something to do with the nested object ? \n`uid` which is only available on `parent` seems to be working fine.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/95573298","html_url":"https://github.com/elastic/elasticsearch/issues/9419#issuecomment-95573298","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9419","id":95573298,"node_id":"MDEyOklzc3VlQ29tbWVudDk1NTczMjk4","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-04-23T12:42:27Z","updated_at":"2015-04-23T12:42:27Z","author_association":"CONTRIBUTOR","body":"@dimzak Thanks for the details. The issue here is that `ts` is mapped with `doc_values: true` on `ad-request` and false on `track-event`. Since fielddata is per-index, this can trigger two bad cases, either Elasticsearch will  consider that this field has doc values and all documents of the `track_event` type will look like they don't have a value for `ts` or Elasticsearch will consider that this field does not have doc values and build in-memory fielddata even for the `ad-request` field.\n\nI'm closing this issue in favour of #8871.\n","performed_via_github_app":null}]