{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25912","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25912/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25912/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25912/events","html_url":"https://github.com/elastic/elasticsearch/issues/25912","id":245764085,"node_id":"MDU6SXNzdWUyNDU3NjQwODU=","number":25912,"title":"date_histogram and offset / interval","user":{"login":"marsu-p","id":16148208,"node_id":"MDQ6VXNlcjE2MTQ4MjA4","avatar_url":"https://avatars3.githubusercontent.com/u/16148208?v=4","gravatar_id":"","url":"https://api.github.com/users/marsu-p","html_url":"https://github.com/marsu-p","followers_url":"https://api.github.com/users/marsu-p/followers","following_url":"https://api.github.com/users/marsu-p/following{/other_user}","gists_url":"https://api.github.com/users/marsu-p/gists{/gist_id}","starred_url":"https://api.github.com/users/marsu-p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marsu-p/subscriptions","organizations_url":"https://api.github.com/users/marsu-p/orgs","repos_url":"https://api.github.com/users/marsu-p/repos","events_url":"https://api.github.com/users/marsu-p/events{/privacy}","received_events_url":"https://api.github.com/users/marsu-p/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-07-26T15:35:37Z","updated_at":"2017-07-27T12:52:25Z","closed_at":"2017-07-27T12:52:25Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n\r\n\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: \r\nServer: 2.2.0\r\nAPI: 5.4\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\n1.8.0_74\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): \r\nLFS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nAccording to:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/5.5/search-aggregations-bucket-datehistogram-aggregation.html#_offset\r\n\r\nInterval and Offset accept TimeValues as defined here:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/5.5/common-options.html#time-units\r\n\r\nWith ES 5.x, offset and interval can also take an integer, but not with ES 2.2. This leads to errors of the form:\r\n`Unknown key for a VALUE_NUMBER in [requestsPerTime]: [interval]`\r\n`Unknown key for a VALUE_NUMBER in [requestsPerTime]: [offset]`\r\nDateHistogramParser.java sets in every case an interval and offset in millis, even if it is not set.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. preparing the data:\r\n```\r\nPUT myindex\r\n{\r\n    \"mappings\":{\r\n        \"mymapping\":{\r\n            \"properties\":{\r\n                \"@version\":{\r\n                    \"type\":\"string\",\r\n                    \"index\":\"no\"\r\n                },\r\n                \"@timestamp\":{\r\n                    \"type\":\"date\"\r\n                },\r\n                \"log_timestamp\":{\r\n                    \"type\":\"date\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\nPUT myindex/mymapping/1\r\n{\r\n    \"log_timestamp\" : \"2017-07-26T13:55:00Z\"\r\n\r\n}\r\nPUT myindex/mymapping/2\r\n{\r\n    \"log_timestamp\" : \"2017-07-26T15:25:00Z\"\r\n}\r\nPUT myindex/mymapping/3\r\n{\r\n    \"log_timestamp\" : \"2017-07-26T15:00:00Z\"\r\n}\r\n```\r\n\r\n2. java code:\r\n```\r\nAggregationBuilder timeRangeAggregation = AggregationBuilders.dateHistogram(\"entriesPerTime\").field(\"log_timestamp\")\r\n        .interval(\"2h\");\r\n```\r\n3. resulting query:\r\n```\r\n  \"aggregations\": {\r\n    \"entriesPerTime\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"log_timestamp\",\r\n        \"interval\": 7200000,\r\n        \"offset\": 0,\r\n        \"order\": {\r\n          \"_key\": \"asc\"\r\n        },\r\n        \"keyed\": false\r\n      }\r\n    }\r\n  }\r\n```\r\n`offset` is obsolete and `interval` does not match the specification, thus the query does not work on ES 2.2 server.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}