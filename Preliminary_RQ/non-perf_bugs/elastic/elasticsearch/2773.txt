{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2773","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2773/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2773/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2773/events","html_url":"https://github.com/elastic/elasticsearch/issues/2773","id":11973301,"node_id":"MDU6SXNzdWUxMTk3MzMwMQ==","number":2773,"title":"Sort Fails with AIOOB exception if field has rarely a value.","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":29805870,"node_id":"MDU6TGFiZWwyOTgwNTg3MA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.0.RC1","name":"v0.90.0.RC1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2013-03-13T13:37:21Z","updated_at":"2013-03-13T14:15:05Z","closed_at":"2013-03-13T14:15:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I ran into this playing with kibana-dashboard this morning and I am very suprised that our tests don't catch that. It seems we using numDocs as an upperBound rather than numOrds in the sorting code....\n\n```\norg.elasticsearch.search.query.QueryPhaseExecutionException: [twitter][1]: query[filtered(place.country:united _all:states)->cache(created-at:[1363171743730 TO 1363175343730])],from[0],size[100],sort[<custom:\"place.country\": org.elasticsearch.index.fielddata.fieldcomparator.BytesRefFieldComparatorSource@38aa2a95>!]: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:139)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:242)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:141)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:205)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:192)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:178)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    at java.lang.Thread.run(Thread.java:722)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 2538\n    at org.apache.lucene.util.packed.Direct8.get(Direct8.java:52)\n    at org.elasticsearch.index.fielddata.plain.PagedBytesAtomicFieldData$BytesValues.getValueByOrd(PagedBytesAtomicFieldData.java:143)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator.binarySearch(BytesRefOrdValComparator.java:459)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator.binarySearch(BytesRefOrdValComparator.java:452)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator.setBottom(BytesRefOrdValComparator.java:431)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator$PerSegmentComparator.setBottom(BytesRefOrdValComparator.java:165)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator.setNextReader(BytesRefOrdValComparator.java:410)\n    at org.elasticsearch.index.fielddata.fieldcomparator.BytesRefOrdValComparator$PerSegmentComparator.setNextReader(BytesRefOrdValComparator.java:155)\n    at org.apache.lucene.search.TopFieldCollector$OneComparatorNonScoringCollector.setNextReader(TopFieldCollector.java:97)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:602)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:192)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:572)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:524)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:501)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:345)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:128)\n    ... 9 more\n```\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}