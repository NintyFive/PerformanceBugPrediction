{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15059","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15059/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15059/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15059/events","html_url":"https://github.com/elastic/elasticsearch/issues/15059","id":119171200,"node_id":"MDU6SXNzdWUxMTkxNzEyMDA=","number":15059,"title":"IndicesService.canDeleteShardContent() takes a lot of CPU and time because of regex that is executed against the Settings","user":{"login":"centic9","id":548322,"node_id":"MDQ6VXNlcjU0ODMyMg==","avatar_url":"https://avatars0.githubusercontent.com/u/548322?v=4","gravatar_id":"","url":"https://api.github.com/users/centic9","html_url":"https://github.com/centic9","followers_url":"https://api.github.com/users/centic9/followers","following_url":"https://api.github.com/users/centic9/following{/other_user}","gists_url":"https://api.github.com/users/centic9/gists{/gist_id}","starred_url":"https://api.github.com/users/centic9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/centic9/subscriptions","organizations_url":"https://api.github.com/users/centic9/orgs","repos_url":"https://api.github.com/users/centic9/repos","events_url":"https://api.github.com/users/centic9/events{/privacy}","received_events_url":"https://api.github.com/users/centic9/received_events","type":"User","site_admin":false},"labels":[{"id":144457604,"node_id":"MDU6TGFiZWwxNDQ0NTc2MDQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Settings","name":":Core/Infra/Settings","color":"0e8a16","default":false,"description":"Settings infrastructure and APIs"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-11-27T10:22:21Z","updated_at":"2015-12-03T09:04:20Z","closed_at":"2015-12-03T09:04:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When analyzing some high CPU that we encountered when working with many indices on an Elasticsearch 2.0 clusters. We tried to use 600 indexes with 12 shards here to see where we max out the system.\n\nWe saw that quite some time is spent running regex-matches in the Settings-Builder on the IndicesStore.clusterChanged() event. \n\nIt seems this is executed many times during cluster-change events, as this is run in a loop over all entries in the ShardRoutingsTable:\n\n```\n    for (IndexRoutingTable indexRoutingTable : event.state().routingTable()) {\n        for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n            if (shardCanBeDeleted(event.state(), indexShardRoutingTable)) {\n```\n\nSee the following extract when using Dynatrace to do some performance analysis, out of the 19 seconds spent in the clusterChanged() method, nearly 6 are needed just for constructing the IndexSettings again and again:\n\n<img width=\"774\" alt=\"elasticsearch_candeleteshardcontent_highcpu_2015-11-27_09-05-42\" src=\"https://cloud.githubusercontent.com/assets/548322/11438382/bffdbcd8-94f4-11e5-831f-7f3a9dc305a9.png\">\n\nI checked the code to ensure this is still the same on newer branches for 2.1, 2.x and master.\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}