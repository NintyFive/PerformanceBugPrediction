{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5483","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5483/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5483/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5483/events","html_url":"https://github.com/elastic/elasticsearch/issues/5483","id":29884526,"node_id":"MDU6SXNzdWUyOTg4NDUyNg==","number":5483,"title":"Unexpected mvel update NullPointerException","user":{"login":"ctrochalakis","id":1865,"node_id":"MDQ6VXNlcjE4NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1865?v=4","gravatar_id":"","url":"https://api.github.com/users/ctrochalakis","html_url":"https://github.com/ctrochalakis","followers_url":"https://api.github.com/users/ctrochalakis/followers","following_url":"https://api.github.com/users/ctrochalakis/following{/other_user}","gists_url":"https://api.github.com/users/ctrochalakis/gists{/gist_id}","starred_url":"https://api.github.com/users/ctrochalakis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctrochalakis/subscriptions","organizations_url":"https://api.github.com/users/ctrochalakis/orgs","repos_url":"https://api.github.com/users/ctrochalakis/repos","events_url":"https://api.github.com/users/ctrochalakis/events{/privacy}","received_events_url":"https://api.github.com/users/ctrochalakis/received_events","type":"User","site_admin":false},"labels":[{"id":175206,"node_id":"MDU6TGFiZWwxNzUyMDY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.18.3","name":"v0.18.3","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-03-21T08:14:25Z","updated_at":"2014-05-07T16:00:23Z","closed_at":"2014-05-07T16:00:16Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nWe hit an interesting bug a few days ago with our testing cluster. It appears that if we do 2 consecutive updates to a document, **right after an elasticsearch restart**, the second update fails with `NullPointerException`. If we run the test script a second time (without restarting the server), the update succeeds.\n\nOur test script that demostrates the issue:\n\n```\n# sudo /etc/init.d/elasticsearch restart && sleep 10 && bash test_es_mvel_issue\n\necho \"Delete everything\"\ncurl -X DELETE 'http://localhost:9200/_all?pretty'\n\necho \"Create test index\"\ncurl -X PUT 'http://localhost:9200/test?pretty'\n\necho \"Add a document\"\ncurl -X PUT 'http://localhost:9200/test/tweet/1?pretty' -d '{\n  \"smth\": \"m\"\n}'\n\necho \"Issue an update using mvel\"\ncurl -X POST 'http://localhost:9200/test/tweet/1/_update?pretty' -d '{\n  \"script\": \"foreach(field : updates.entrySet()) { ctx._source[field.key] = field.value; }\",\n  \"params\": {\n    \"updates\": {\n      \"1\": 1,\n      \"2\": 1,\n      \"3\": 1,\n      \"availability\": null,\n      \"5\": 1,\n      \"a\": 1,\n      \"b\": 1,\n      \"c\": 1,\n      \"d\": 1,\n      \"e\": 1,\n      \"f\": 1,\n      \"g\": 1,\n      \"h\": 1,\n      \"i\": 1,\n      \"j\": 1,\n      \"k\": 1,\n      \"l\": 1,\n      \"m\": 1,\n      \"n\": 1,\n      \"o\": 1,\n      \"p\": 1,\n      \"q\": 1,\n      \"r\": 1,\n      \"s\": 1,\n      \"t\": 1,\n      \"flter\": 1\n    }\n  }\n}'\n\necho \"Issue a second update\"\ncurl -X POST 'http://localhost:9200/test/tweet/1/_update?pretty' -d '{\n  \"script\": \"foreach(field : updates.entrySet()) { ctx._source[field.key] = field.value; }\",\n  \"params\": {\n    \"updates\": {\n      \"1\": 1,\n      \"2\": 1,\n      \"3\": 1,\n      \"availability\": null,\n      \"5\": 1,\n      \"a\": 1,\n      \"b\": 1,\n      \"c\": 1,\n      \"d\": 1,\n      \"e\": 1,\n      \"f\": 1,\n      \"g\": 1,\n      \"h\": 1,\n      \"i\": 1,\n      \"j\": 1,\n      \"k\": 1,\n      \"l\": 1,\n      \"m\": 1,\n      \"n\": 1,\n      \"o\": 1,\n      \"p\": 1,\n      \"q\": 1,\n      \"r\": 1,\n      \"s\": 1,\n      \"t\": 1,\n      \"flter\": 1\n    }\n  }\n}'\n\n#2014-03-20T15:20:30+02:00 [400] (0.016s)\n#\n# {\n#   \"error\": \"ElasticSearchIllegalArgumentException[failed to execute script]; nested: NullPointerException; \",\n#   \"status\": 400\n# \n# }\n\n```\n\nThe bug is reproducible to all elasticsearch versions (0.90, 1.0, 1.1, master).\n\nSome interesting points that we noticed:\n- It seems to depend on the payload, if we remove an attribute from the `updates` hash everything works.\n- If we add some whitespace to the second's update mvel script, the update succeeds. Probably because it skips a cache.\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}