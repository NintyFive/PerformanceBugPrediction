[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/472714547","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-472714547","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":472714547,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MjcxNDU0Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-14T05:56:21Z","updated_at":"2019-03-14T05:56:21Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/472714555","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-472714555","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":472714555,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MjcxNDU1NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-14T05:56:22Z","updated_at":"2019-03-14T05:56:22Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-docs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/472824946","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-472824946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":472824946,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MjgyNDk0Ng==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-03-14T12:06:23Z","updated_at":"2019-03-14T12:06:23Z","author_association":"CONTRIBUTOR","body":"This generalization of the formula related to the [shrink](https://www.elastic.co/guide/en/elasticsearch/reference/6.7/indices-shrink-index.html) / [split](https://www.elastic.co/guide/en/elasticsearch/reference/6.7/indices-split-index.html) functionality. \r\n\r\nShrinking is efficiently implemented by directly combining and merging Lucene segments from different shards. When shrinking an index from 10 to 5 primary shards, for example, shards 0 and 1 from the old index get merged into shard 0 of the new index, shards 2 and 3 of the old index are merged into shard 1 of the new index, etc. This way of combining old shards into new shards, while extremely efficient, means however that the documents no longer belong to the right shard if you were to apply the simple `shard_num = hash(_routing) % num_primary_shards` formula to this new index with only 5 primary shards. If document \"xyz\" was previously routed to shard 3 in the old index, it now needs to route shard 1 in the new index. To achieve this, the routing is now calculated as if the new index would still have 10 shards (this is the `num_routing_shards` value), which gives you a number between 0 and 9, and then we account for the factor by which we shrunk the original index, by dividing by 2 (`routingFactor`, which is 10 / 5 = 2), giving us a number between 0 and 4. The original formula therefore becomes `shard_num = (hash(_routing) % num_routing_shards) / routing_factor`.\r\n\r\nSplitting is also efficiently implemented again using similar tricks (see split docs). When splitting an index from 5 to 10 primary shards, for example, shard 0 from the old index is split into shards 0 and 1 of the new index, shard 1 of the old index is split into shards 2 and 3 of the new index, etc. This way of splitting shards into new shards, while extremely efficient, means however that the documents no longer belong to the right shard if you were to apply the simple `shard_num = hash(_routing) % num_primary_shards` formula to this new index with 10 primary shards (same story as for shrinking). If document \"xyz\" was previously routed to shard 1 in the old index, it now needs to route to shard 2 or shard 3 in the new index. We need it to be either 2 or 3, though, using a deterministic formula. This is achieved with the following trick. Assume that the shard that we are splitting from 5 to 10 shards had previously been shrunk from 10 to 5 shards. In that case the shrunken index would be using `num_routing_shards = 10` and `routing_factor = 2`. By adapting the `routing_factor` from 2 to 1, the split index with 10 shards would map documents again in the same way as the original index with 10 shards. The key observation here is that if we have a large enough `num_routing_shards` value, we can easily split shards by adapting the `routing_factor`.\r\n\r\nWhile Elasticsearch 6.x requires you to specify a high enough `num_routing_shards` value at index creation time in order to do splitting for that index, Elasticsearch 7.x [chooses a large default value](https://github.com/elastic/elasticsearch/blob/83e9d0b9c63589f1dc5bda8abb6b10b27502ef71/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java#L820-L836) for this at index creation time that is designed to allow you to split this index by factors of 2 up to a maximum of 1024 shards (see docs for split in 6.x and 7.x).\r\n\r\nThis means that for an ES 7.x index with 10 primary shards and default settings, the document \"xyz\" will possibly be mapped to a different shard than for an ES 6.x index with 10 primary shards and default settings, as 6.x indices use `num_routing_shards = num_primary_shards` as the default, which allows the formula `shard_num = (hash(_routing) % num_routing_shards) / routing_factor` to be a generalization of the original `shard_num = hash(_routing) % num_primary_shards` formula.\r\n\r\n@kunisen I hope this explanation helps with understanding the formula in the code (I've tried to keep it as concise as I could, and am happy to elaborate on some of these parts more if you want). I'm not sure yet how and where to document this generalization of the formula, given that the additional complexity of the generalized formula might cause more confusion to a reader than the simplified one and requires a bit more context to explain.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/472829973","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-472829973","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":472829973,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MjgyOTk3Mw==","user":{"login":"kunisen","id":30574753,"node_id":"MDQ6VXNlcjMwNTc0NzUz","avatar_url":"https://avatars2.githubusercontent.com/u/30574753?v=4","gravatar_id":"","url":"https://api.github.com/users/kunisen","html_url":"https://github.com/kunisen","followers_url":"https://api.github.com/users/kunisen/followers","following_url":"https://api.github.com/users/kunisen/following{/other_user}","gists_url":"https://api.github.com/users/kunisen/gists{/gist_id}","starred_url":"https://api.github.com/users/kunisen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kunisen/subscriptions","organizations_url":"https://api.github.com/users/kunisen/orgs","repos_url":"https://api.github.com/users/kunisen/repos","events_url":"https://api.github.com/users/kunisen/events{/privacy}","received_events_url":"https://api.github.com/users/kunisen/received_events","type":"User","site_admin":false},"created_at":"2019-03-14T12:21:36Z","updated_at":"2019-03-14T12:21:36Z","author_association":"NONE","body":"Very clear explanation and no any doubts now!\r\nThanks for the great write up!\r\nI think it’s important to have experts explained this but not just I read something from code, and now my goal is achieved.\r\nReally appreciate your help! @ywelsch","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/541270069","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-541270069","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":541270069,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MTI3MDA2OQ==","user":{"login":"debadair","id":362578,"node_id":"MDQ6VXNlcjM2MjU3OA==","avatar_url":"https://avatars1.githubusercontent.com/u/362578?v=4","gravatar_id":"","url":"https://api.github.com/users/debadair","html_url":"https://github.com/debadair","followers_url":"https://api.github.com/users/debadair/followers","following_url":"https://api.github.com/users/debadair/following{/other_user}","gists_url":"https://api.github.com/users/debadair/gists{/gist_id}","starred_url":"https://api.github.com/users/debadair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/debadair/subscriptions","organizations_url":"https://api.github.com/users/debadair/orgs","repos_url":"https://api.github.com/users/debadair/repos","events_url":"https://api.github.com/users/debadair/events{/privacy}","received_events_url":"https://api.github.com/users/debadair/received_events","type":"User","site_admin":false},"created_at":"2019-10-12T01:37:57Z","updated_at":"2019-10-12T01:37:57Z","author_association":"CONTRIBUTOR","body":"[docs issue triage]","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542963260","html_url":"https://github.com/elastic/elasticsearch/issues/40027#issuecomment-542963260","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40027","id":542963260,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Mjk2MzI2MA==","user":{"login":"kunisen","id":30574753,"node_id":"MDQ6VXNlcjMwNTc0NzUz","avatar_url":"https://avatars2.githubusercontent.com/u/30574753?v=4","gravatar_id":"","url":"https://api.github.com/users/kunisen","html_url":"https://github.com/kunisen","followers_url":"https://api.github.com/users/kunisen/followers","following_url":"https://api.github.com/users/kunisen/following{/other_user}","gists_url":"https://api.github.com/users/kunisen/gists{/gist_id}","starred_url":"https://api.github.com/users/kunisen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kunisen/subscriptions","organizations_url":"https://api.github.com/users/kunisen/orgs","repos_url":"https://api.github.com/users/kunisen/repos","events_url":"https://api.github.com/users/kunisen/events{/privacy}","received_events_url":"https://api.github.com/users/kunisen/received_events","type":"User","site_admin":false},"created_at":"2019-10-17T02:01:50Z","updated_at":"2019-10-17T02:01:50Z","author_association":"NONE","body":"thanks again and close the ticket","performed_via_github_app":null}]