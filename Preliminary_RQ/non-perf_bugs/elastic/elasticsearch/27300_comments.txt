[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342697011","html_url":"https://github.com/elastic/elasticsearch/issues/27300#issuecomment-342697011","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27300","id":342697011,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MjY5NzAxMQ==","user":{"login":"xgwu","id":10510416,"node_id":"MDQ6VXNlcjEwNTEwNDE2","avatar_url":"https://avatars2.githubusercontent.com/u/10510416?v=4","gravatar_id":"","url":"https://api.github.com/users/xgwu","html_url":"https://github.com/xgwu","followers_url":"https://api.github.com/users/xgwu/followers","following_url":"https://api.github.com/users/xgwu/following{/other_user}","gists_url":"https://api.github.com/users/xgwu/gists{/gist_id}","starred_url":"https://api.github.com/users/xgwu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xgwu/subscriptions","organizations_url":"https://api.github.com/users/xgwu/orgs","repos_url":"https://api.github.com/users/xgwu/repos","events_url":"https://api.github.com/users/xgwu/events{/privacy}","received_events_url":"https://api.github.com/users/xgwu/received_events","type":"User","site_admin":false},"created_at":"2017-11-08T03:10:11Z","updated_at":"2017-11-08T03:36:35Z","author_association":"NONE","body":"It looks like this relates to log4j's  ReusableLogEventFactory, which set MutableLogEvent as thread_local.\r\n```\r\npublic class ReusableLogEventFactory implements LogEventFactory {\r\n    private static final ThreadNameCachingStrategy THREAD_NAME_CACHING_STRATEGY = ThreadNameCachingStrategy.create();\r\n    private static final Clock CLOCK = ClockFactory.getClock();\r\n\r\n    private static ThreadLocal<MutableLogEvent> mutableLogEventThreadLocal = new ThreadLocal<>();\r\n    private final ContextDataInjector injector = ContextDataInjectorFactory.createInjector();\r\n```\r\n\r\nI tried adding -Dlog4j2.enable.threadlocals=false to ES's jvm.options. Bulk exception won't retain huge memory since then. So I think this is the way to get around the problem. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342703619","html_url":"https://github.com/elastic/elasticsearch/issues/27300#issuecomment-342703619","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27300","id":342703619,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MjcwMzYxOQ==","user":{"login":"xgwu","id":10510416,"node_id":"MDQ6VXNlcjEwNTEwNDE2","avatar_url":"https://avatars2.githubusercontent.com/u/10510416?v=4","gravatar_id":"","url":"https://api.github.com/users/xgwu","html_url":"https://github.com/xgwu","followers_url":"https://api.github.com/users/xgwu/followers","following_url":"https://api.github.com/users/xgwu/following{/other_user}","gists_url":"https://api.github.com/users/xgwu/gists{/gist_id}","starred_url":"https://api.github.com/users/xgwu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xgwu/subscriptions","organizations_url":"https://api.github.com/users/xgwu/orgs","repos_url":"https://api.github.com/users/xgwu/repos","events_url":"https://api.github.com/users/xgwu/events{/privacy}","received_events_url":"https://api.github.com/users/xgwu/received_events","type":"User","site_admin":false},"created_at":"2017-11-08T03:54:38Z","updated_at":"2017-11-08T03:54:38Z","author_association":"NONE","body":"This log4j reference [Garbage-free Steady State Logging](https://logging.apache.org/log4j/2.x/manual/garbagefree.html) explains the possibility of memory leaks.\r\n\r\n> Garbage-free logging in Log4j 2.6 is partially implemented by reusing objects in ThreadLocal fields, and partially by reusing buffers when converting text to bytes.\r\n> \r\n> ThreadLocal fields holding non-JDK classes can cause memory leaks in web applications when the application server's thread pool continues to reference these fields after the web application is undeployed. To avoid causing memory leaks, Log4j will not use these ThreadLocals when it detects that it is used in a web application (when the javax.servlet.Servlet class is in the classpath, or when system property log4j2.is.webapp is set to \"true\").","performed_via_github_app":null}]