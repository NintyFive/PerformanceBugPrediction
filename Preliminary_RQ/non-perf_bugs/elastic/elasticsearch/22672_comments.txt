[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273451764","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-273451764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":273451764,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzQ1MTc2NA==","user":{"login":"makeyang","id":13898618,"node_id":"MDQ6VXNlcjEzODk4NjE4","avatar_url":"https://avatars2.githubusercontent.com/u/13898618?v=4","gravatar_id":"","url":"https://api.github.com/users/makeyang","html_url":"https://github.com/makeyang","followers_url":"https://api.github.com/users/makeyang/followers","following_url":"https://api.github.com/users/makeyang/following{/other_user}","gists_url":"https://api.github.com/users/makeyang/gists{/gist_id}","starred_url":"https://api.github.com/users/makeyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/makeyang/subscriptions","organizations_url":"https://api.github.com/users/makeyang/orgs","repos_url":"https://api.github.com/users/makeyang/repos","events_url":"https://api.github.com/users/makeyang/events{/privacy}","received_events_url":"https://api.github.com/users/makeyang/received_events","type":"User","site_admin":false},"created_at":"2017-01-18T11:27:45Z","updated_at":"2017-01-18T11:27:45Z","author_association":"CONTRIBUTOR","body":"just a thought: \r\n1. when update mapping route to a master and before it is publishing to all data nodes, network partition happens\r\n2. new master is elected and another update mapping route to new master. \r\n3. this 2 mapping has conflict\r\n4. when old master come back and it tried to rejoin the cluster, will this cause this exception?\r\nI'll try it tomorrow.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273676209","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-273676209","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":273676209,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzY3NjIwOQ==","user":{"login":"makeyang","id":13898618,"node_id":"MDQ6VXNlcjEzODk4NjE4","avatar_url":"https://avatars2.githubusercontent.com/u/13898618?v=4","gravatar_id":"","url":"https://api.github.com/users/makeyang","html_url":"https://github.com/makeyang","followers_url":"https://api.github.com/users/makeyang/followers","following_url":"https://api.github.com/users/makeyang/following{/other_user}","gists_url":"https://api.github.com/users/makeyang/gists{/gist_id}","starred_url":"https://api.github.com/users/makeyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/makeyang/subscriptions","organizations_url":"https://api.github.com/users/makeyang/orgs","repos_url":"https://api.github.com/users/makeyang/repos","events_url":"https://api.github.com/users/makeyang/events{/privacy}","received_events_url":"https://api.github.com/users/makeyang/received_events","type":"User","site_admin":false},"created_at":"2017-01-19T03:59:25Z","updated_at":"2017-01-19T07:11:49Z","author_association":"CONTRIBUTOR","body":"I try this and it is still no reproduce. can anybody share anything?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273708118","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-273708118","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":273708118,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzcwODExOA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-01-19T08:13:04Z","updated_at":"2017-01-19T08:13:14Z","author_association":"MEMBER","body":"@makeyang can you share a bit more context? is this a cluster with dedicated master nodes? is this an old index (created with <=1.x code). Since this is an initializing primary, it seems something happened before - was the cluster restarted? is this a restore from a snapshot? any networking issues?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273730832","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-273730832","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":273730832,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzczMDgzMg==","user":{"login":"makeyang","id":13898618,"node_id":"MDQ6VXNlcjEzODk4NjE4","avatar_url":"https://avatars2.githubusercontent.com/u/13898618?v=4","gravatar_id":"","url":"https://api.github.com/users/makeyang","html_url":"https://github.com/makeyang","followers_url":"https://api.github.com/users/makeyang/followers","following_url":"https://api.github.com/users/makeyang/following{/other_user}","gists_url":"https://api.github.com/users/makeyang/gists{/gist_id}","starred_url":"https://api.github.com/users/makeyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/makeyang/subscriptions","organizations_url":"https://api.github.com/users/makeyang/orgs","repos_url":"https://api.github.com/users/makeyang/repos","events_url":"https://api.github.com/users/makeyang/events{/privacy}","received_events_url":"https://api.github.com/users/makeyang/received_events","type":"User","site_admin":false},"created_at":"2017-01-19T10:02:41Z","updated_at":"2017-01-19T10:03:34Z","author_association":"CONTRIBUTOR","body":"@bleskes  \r\n1. no, it's not a cluster with dedicated master nodes. master&data nodes are integrated together with seperate gateway node. it's 3 data&master integrated nodes with 4 dedicated gateway nodes.\r\n2. no, it's not an old index. the index was created & maintained in the same cluster and the cluster version is 2.1\r\n3. we update conflict mapping by not knowing why and then we found out that some shards can't be allocated. then we restart some data&master node\r\n4. then it keep throw exceptions.\r\n\r\nI paste 3 data&master nodes log here:\r\nhttps://github.com/makeyang/grocery/blob/master/15921.txt\r\nhttps://github.com/makeyang/grocery/blob/master/8045.txt\r\nhttps://github.com/makeyang/grocery/blob/master/8047.txt","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273813262","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-273813262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":273813262,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzgxMzI2Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-01-19T15:52:34Z","updated_at":"2017-01-19T15:52:34Z","author_association":"CONTRIBUTOR","body":"This is a bug in the mapping code. I've got a simple reproduction on a single-node 2.1.0 cluster:\r\n\r\n```\r\ncurl -XPUT localhost:9200/my_index\r\n\r\ncurl -XPUT localhost:9200/my_index/_mapping/type1 -d '\r\n{\r\n  \"properties\": {\r\n    \"account\": {\r\n      \"type\": \"string\",\r\n      \"index\": \"not_analyzed\",\r\n      \"doc_values\": true\r\n    }\r\n  }\r\n}\r\n'\r\n\r\ncurl -XPUT localhost:9200/my_index/_mapping/type2 -d '\r\n{\r\n  \"properties\": {\r\n    \"account\": {\r\n      \"type\": \"string\",\r\n      \"index\": \"not_analyzed\",\r\n      \"doc_values\": false\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\nThen restart the node and see it fail recovering. If it does not fail the first time, restart a few more times, the failure depends on the order in which type mappings are applied, which is somewhat non-deterministic (hashmaps).\r\n\r\nThe issue is that the mapping ends up with conflicting values for the \"account\" doc-values field (which is not properly detected by ES 2.1.0):\r\n\r\n```\r\n{\r\n    \"my_index\": {\r\n        \"mappings\": {\r\n            \"type1\": {\r\n                \"properties\": {\r\n                    \"account\": {\r\n                        \"index\": \"not_analyzed\",\r\n                        \"type\": \"string\"\r\n                    }\r\n                }\r\n            },\r\n            \"type2\": {\r\n                \"properties\": {\r\n                    \"account\": {\r\n                        \"doc_values\": false,\r\n                        \"index\": \"not_analyzed\",\r\n                        \"type\": \"string\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\ni.e. doc_values is enabled for the \"account\" field in type1 but disabled in type2, which is inconsistent. The validation only detects this based on the ordering in which type1 and type2 are applied when applying the mapping on the node.\r\n\r\nES 2.4.4 updates the mapping correctly and yields the following consistent mapping after applying the above steps:\r\n\r\n```\r\n{\r\n    \"my_index\": {\r\n        \"mappings\": {\r\n            \"type1\": {\r\n                \"properties\": {\r\n                    \"account\": {\r\n                        \"doc_values\": false,\r\n                        \"index\": \"not_analyzed\",\r\n                        \"type\": \"string\"\r\n                    }\r\n                }\r\n            },\r\n            \"type2\": {\r\n                \"properties\": {\r\n                    \"account\": {\r\n                        \"doc_values\": false,\r\n                        \"index\": \"not_analyzed\",\r\n                        \"type\": \"string\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nHow to fix this? You can make the mapping consistent again by disabling doc_values for the form_index/lockUser field for all types in that index:\r\n\r\nIn my above example, the mapping can be made consistent again by updating it as follows:\r\n\r\n```\r\ncurl -XPUT localhost:9200/my_index/_mapping/type1?update_all_types=true -d '\r\n{\r\n  \"properties\": {\r\n    \"account\": {\r\n      \"type\": \"string\",\r\n      \"index\": \"not_analyzed\",\r\n      \"doc_values\": false\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\nThis command might fail the first time you execute it, as it runs again into the non-determinism issue. Just repeat the command a few times until you get `{\"acknowledged\":true}`.\r\n\r\nOnce the mapping has been fixed (and only thereafter), I recommend an upgrade to ES 2.4.4, preferably even to 5.x.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/274386523","html_url":"https://github.com/elastic/elasticsearch/issues/22672#issuecomment-274386523","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22672","id":274386523,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NDM4NjUyMw==","user":{"login":"makeyang","id":13898618,"node_id":"MDQ6VXNlcjEzODk4NjE4","avatar_url":"https://avatars2.githubusercontent.com/u/13898618?v=4","gravatar_id":"","url":"https://api.github.com/users/makeyang","html_url":"https://github.com/makeyang","followers_url":"https://api.github.com/users/makeyang/followers","following_url":"https://api.github.com/users/makeyang/following{/other_user}","gists_url":"https://api.github.com/users/makeyang/gists{/gist_id}","starred_url":"https://api.github.com/users/makeyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/makeyang/subscriptions","organizations_url":"https://api.github.com/users/makeyang/orgs","repos_url":"https://api.github.com/users/makeyang/repos","events_url":"https://api.github.com/users/makeyang/events{/privacy}","received_events_url":"https://api.github.com/users/makeyang/received_events","type":"User","site_admin":false},"created_at":"2017-01-23T02:51:13Z","updated_at":"2017-01-23T02:51:13Z","author_association":"CONTRIBUTOR","body":"@ywelsch \r\nafter dig more: i setup a cluster with one dedicated master and one dedicated data node. and below test will throw exception too:\r\ncurl -XPUT /my_index2 -d'\r\n{\t\"settings\" : { \"index\" : {  \"number_of_shards\" : 1,\"number_of_replicas\" : 0  }}}\r\n'\r\n\r\ncurl -XPUT /my_index2/_mapping/type1 -d '\r\n{\r\n  \"properties\": {\r\n    \"account\": {\r\n      \"type\": \"string\"\r\n    }\r\n  }\r\n}\r\n'\r\n\r\ncurl -XPUT /my_index2/_mapping/type2 -d '\r\n{  \"properties\": {    \"account\": {\t  \"index\": \"not_analyzed\",      \"type\": \"string\"    }  }\r\n}\r\n'\r\n\r\nand then I found that below issues are trying to fix mapping problem:\r\nhttps://github.com/elastic/elasticsearch/issues/15049\r\nhttps://github.com/elastic/elasticsearch/issues/15057\r\nhttps://github.com/elastic/elasticsearch/pull/17568\r\n\r\nso basiclly we can close this issue. ","performed_via_github_app":null}]