{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30005","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30005/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30005/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30005/events","html_url":"https://github.com/elastic/elasticsearch/issues/30005","id":317453798,"node_id":"MDU6SXNzdWUzMTc0NTM3OTg=","number":30005,"title":"[ML] Jobs fail to auto-close due to timeout when stopping the datafeed","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"assignees":[{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2018-04-12T17:26:06Z","updated_at":"2018-07-12T13:44:03Z","closed_at":"2018-07-12T13:44:02Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @sophiec20:*\n\nFound in 6.3.0 `{\r\n  \"build\" : {\r\n    \"hash\" : \"a47564f\",\r\n    \"date\" : \"2018-04-09T21:45:51.347364Z\"\r\n  },`\r\n\r\nShowcase server, 2 node cluster on gcp\r\n\r\nSome jobs failed to auto-close due to a timeout when trying to remove the datafeed persistent task.\r\n\r\nSystem was running 6 concurrent jobs, all on gallery2018 data. These jobs were started 5s apart using the same script. All configs were identifal, except for the function used. The datafeed start request contained the same start and end dates `Datafeed started (from: 1970-01-02T10:00:00.000Z to: 2018-12-31T00:00:00.000Z)`. The 6 jobs had the following configs:\r\n```\r\nmin(bytes) partition=status influencers=clientip,status bucket=1h *\r\nmax(bytes) partition=status influencers=clientip,status bucket=1h *\r\nmean(bytes) partition=status influencers=clientip,status bucket=1h *\r\nmedian(bytes) partition=status influencers=clientip,status bucket=1h\r\nvarp(bytes) partition=status influencers=clientip,status bucket=1h\r\nsum(bytes) partition=status influencers=clientip,status bucket=1h\r\n```\r\n\r\nAn end date was specified, so I would expect the jobs to auto-close after they had finished processing the data in the index.\r\n\r\nAll jobs completed, however 3 of the jobs (see *) remained open. Their datafeeds were stopped. The errors are logged below. \r\n\r\n```\r\n[2018-04-11T23:30:34,129][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-mean-bytes-p-status-clientip-status-1h] 900000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:30:54,324][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-min-bytes-p-status-clientip-status-1h] 1000000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:31:01,912][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-sum-bytes-p-status-clientip-status-1h] 700000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:31:16,142][INFO ][o.e.x.m.d.DatafeedJob    ] [ga-min-bytes-p-status-clientip-status-1h] Lookback has finished\r\n[2018-04-11T23:31:16,142][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] attempt to stop datafeed [datafeed-ga-min-bytes-p-status-clientip-status-1h] for job [ga-min-bytes-p-status-clientip-status-1h]\r\n[2018-04-11T23:31:16,143][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] try lock [20s] to stop datafeed [datafeed-ga-min-bytes-p-status-clientip-status-1h] for job [ga-min-bytes-p-status-clientip-status-1h]...\r\n[2018-04-11T23:31:16,143][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] stopping datafeed [datafeed-ga-min-bytes-p-status-clientip-status-1h] for job [ga-min-bytes-p-status-clientip-status-1h], acquired [true]...\r\n[2018-04-11T23:31:16,143][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] datafeed [datafeed-ga-min-bytes-p-status-clientip-status-1h] for job [ga-min-bytes-p-status-clientip-status-1h] has been stopped\r\n[2018-04-11T23:31:16,736][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-mean-bytes-p-status-clientip-status-1h] 1000000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:31:31,956][INFO ][o.e.x.m.d.DatafeedJob    ] [ga-mean-bytes-p-status-clientip-status-1h] Lookback has finished\r\n[2018-04-11T23:31:31,956][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] attempt to stop datafeed [datafeed-ga-mean-bytes-p-status-clientip-status-1h] for job [ga-mean-bytes-p-status-clientip-status-1h]\r\n[2018-04-11T23:31:31,956][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] try lock [20s] to stop datafeed [datafeed-ga-mean-bytes-p-status-clientip-status-1h] for job [ga-mean-bytes-p-status-clientip-status-1h]...\r\n[2018-04-11T23:31:31,956][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] stopping datafeed [datafeed-ga-mean-bytes-p-status-clientip-status-1h] for job [ga-mean-bytes-p-status-clientip-status-1h], acquired [true]...\r\n[2018-04-11T23:31:31,957][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] datafeed [datafeed-ga-mean-bytes-p-status-clientip-status-1h] for job [ga-mean-bytes-p-status-clientip-status-1h] has been stopped\r\n[2018-04-11T23:31:36,150][ERROR][o.e.x.m.d.DatafeedManager] Failed to remove datafeed persistent task - will not auto close job [ga-min-bytes-p-status-clientip-status-1h]\r\njava.lang.IllegalStateException: timed out after 20s\r\n        at org.elasticsearch.persistent.PersistentTasksService$WaitForPersistentTaskStatusListener.onTimeout(PersistentTasksService.java:199) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.persistent.PersistentTasksService$1.onTimeout(PersistentTasksService.java:164) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:244) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:576) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:573) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n[2018-04-11T23:31:36,154][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-sum-bytes-p-status-clientip-status-1h] 800000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:31:51,958][ERROR][o.e.x.m.d.DatafeedManager] Failed to remove datafeed persistent task - will not auto close job [ga-mean-bytes-p-status-clientip-status-1h]\r\njava.lang.IllegalStateException: timed out after 20s\r\n        at org.elasticsearch.persistent.PersistentTasksService$WaitForPersistentTaskStatusListener.onTimeout(PersistentTasksService.java:199) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.persistent.PersistentTasksService$1.onTimeout(PersistentTasksService.java:164) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:244) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:576) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:573) [elasticsearch-6.3.0-SNAPSHOT.jar:6.3.0-SNAPSHOT]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n[2018-04-11T23:32:07,180][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-sum-bytes-p-status-clientip-status-1h] 900000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:32:34,798][INFO ][o.e.x.m.j.p.DataCountsReporter] [node2] [ga-sum-bytes-p-status-clientip-status-1h] 1000000 records written to autodetect; missingFieldCount=0, invalidDateCount=0, outOfOrderCount=0\r\n[2018-04-11T23:32:44,739][INFO ][o.e.x.m.d.DatafeedJob    ] [ga-sum-bytes-p-status-clientip-status-1h] Lookback has finished\r\n[2018-04-11T23:32:44,739][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] attempt to stop datafeed [datafeed-ga-sum-bytes-p-status-clientip-status-1h] for job [ga-sum-bytes-p-status-clientip-status-1h]\r\n[2018-04-11T23:32:44,739][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] try lock [20s] to stop datafeed [datafeed-ga-sum-bytes-p-status-clientip-status-1h] for job [ga-sum-bytes-p-status-clientip-status-1h]...\r\n[2018-04-11T23:32:44,739][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] stopping datafeed [datafeed-ga-sum-bytes-p-status-clientip-status-1h] for job [ga-sum-bytes-p-status-clientip-status-1h], acquired [true]...\r\n[2018-04-11T23:32:44,739][INFO ][o.e.x.m.d.DatafeedManager] [no_realtime] datafeed [datafeed-ga-sum-bytes-p-status-clientip-status-1h] for job [ga-sum-bytes-p-status-clientip-status-1h] has been stopped\r\n[2018-04-11T23:33:04,477][INFO ][o.e.x.m.j.p.a.AutodetectProcessManager] [node2] Closing job [ga-sum-bytes-p-status-clientip-status-1h], because [close job (api)]\r\n[2018-04-11T23:33:04,488][INFO ][o.e.x.m.j.p.l.CppLogMessageHandler] [ga-sum-bytes-p-status-clientip-status-1h] [autodetect/10435] EMAIL REDACTED Handled 1023038 records\r\n[2018-04-11T23:33:04,488][INFO ][o.e.x.m.j.p.l.CppLogMessageHandler] [ga-sum-bytes-p-status-clientip-status-1h] [autodetect/10435] EMAIL REDACTED Pruning all models\r\n[2018-04-11T23:33:04,589][INFO ][o.e.x.m.j.p.a.NativeAutodetectProcess] [ga-sum-bytes-p-status-clientip-status-1h] State output finished\r\n[2018-04-11T23:33:04,897][INFO ][o.e.x.m.j.p.a.o.AutoDetectResultProcessor] [ga-sum-bytes-p-status-clientip-status-1h] 7259 buckets parsed from autodetect output\r\n[2018-04-11T23:33:09,161][INFO ][o.e.x.m.j.p.a.AutodetectCommunicator] [ga-sum-bytes-p-status-clientip-status-1h] job closed\r\n```\r\n\r\nThe Job messages looked fine, although it was missing the final `Job is closing` message.\r\n\r\n![image](https://user-images.githubusercontent.com/4185750/38693268-49cf0298-3e7e-11e8-8fe2-9fee868232a6.png)\r\n","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}