{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42661","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42661/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42661/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42661/events","html_url":"https://github.com/elastic/elasticsearch/issues/42661","id":449661997,"node_id":"MDU6SXNzdWU0NDk2NjE5OTc=","number":42661,"title":"elasticsearch-shard can't  remove corrupted parts.","user":{"login":"UnicornChan","id":30858427,"node_id":"MDQ6VXNlcjMwODU4NDI3","avatar_url":"https://avatars2.githubusercontent.com/u/30858427?v=4","gravatar_id":"","url":"https://api.github.com/users/UnicornChan","html_url":"https://github.com/UnicornChan","followers_url":"https://api.github.com/users/UnicornChan/followers","following_url":"https://api.github.com/users/UnicornChan/following{/other_user}","gists_url":"https://api.github.com/users/UnicornChan/gists{/gist_id}","starred_url":"https://api.github.com/users/UnicornChan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UnicornChan/subscriptions","organizations_url":"https://api.github.com/users/UnicornChan/orgs","repos_url":"https://api.github.com/users/UnicornChan/repos","events_url":"https://api.github.com/users/UnicornChan/events{/privacy}","received_events_url":"https://api.github.com/users/UnicornChan/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"assignees":[{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2019-05-29T08:16:56Z","updated_at":"2019-06-07T10:17:14Z","closed_at":"2019-06-07T10:17:14Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nDiscovered in version 6.5.4, then, I reproduce the bug in 7.1.0. \r\nVersion: 7.1.0, Build: default/rpm/606a173/2019-05-16T00:43:15.323135Z, JVM: 1.8.0_162\r\n\r\n**Plugins installed**: no plugin\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_162\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux node-1 3.10.0-514.el7.x86_64 CentOS Linux release 7.3\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhile insert data to index, power cut. After I recovery the cluster, there is a shard unassigned.\r\nThe log reported:\r\n> \"Caused by: java.io.EOFException: read past EOF. pos [32595685] length: [22920] end: [32595697]\"\r\n\r\n    I find docs say that `elasticsearch-translog` and `elasticsearch-shard` tools could delete the corrupted translog data, so that I will lost data only in translog.\r\nBut unfortunately, `elasticsearch-translog` and `elasticsearch-shard` report the error \r\n> \"Caused by: java.io.EOFException: read past EOF. pos [32595685] length: [22920] end: [32595697]\"\r\n\r\n too. which means I will lost all data in this shard.\r\n    I guess the elasticsearch record offset first, write datas to translog file second. while offset write successful, but datas  write failure. The bug appearã€‚\r\n\r\n\r\n**Steps to reproduce**:\r\nIt's little probability to reproduce the bug by power cut. So I reproduce the bug by delete translog file.\r\n 1. Kill elasticsearch process while insert data.\r\n 2. cd translog dir, delete some bytes in `.tlog` file.\r\n 3. restart cluster,  sometimes report `checksum error`, which `elasticsearch-shard` could fix. sometimes `read past EOF` report, `elasticsearch-shard` could not fix.\r\n 4. if report `read past EOF` error, close cluster,\r\n 5. run `bin/elasticsearch-shard remove-corrupted-data --index test --shard-id 0`, `read past EOF` error appear agin.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n> \"stacktrace\": [\"org.elasticsearch.index.engine.EngineException: failed to recover from translog\",\r\n\"at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslogInternal(InternalEngine.java:444) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:414) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:109) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.IndexShard.openEngineAndRecoverFromTranslog(IndexShard.java:1401) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.StoreRecovery.internalRecoverFromStore(StoreRecovery.java:433) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromStore$0(StoreRecovery.java:95) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:308) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.StoreRecovery.recoverFromStore(StoreRecovery.java:93) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.IndexShard.recoverFromStore(IndexShard.java:1687) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$9(IndexShard.java:2340) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) [elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\",\r\n\"at java.lang.Thread.run(Thread.java:835) [?:?]\",\r\n\"Caused by: java.io.EOFException: read past EOF. pos [32595685] length: [22920] end: [32595697]\",\r\n\"at org.elasticsearch.common.io.Channels.readFromFileChannelWithEofException(Channels.java:103) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.translog.TranslogSnapshot.readBytes(TranslogSnapshot.java:104) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.translog.BaseTranslogReader.checksummedStream(BaseTranslogReader.java:110) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.translog.TranslogSnapshot.readOperation(TranslogSnapshot.java:81) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.translog.TranslogSnapshot.next(TranslogSnapshot.java:70) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.translog.MultiSnapshot.next(MultiSnapshot.java:78) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.IndexShard.runTranslogRecovery(IndexShard.java:1357) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.shard.IndexShard.lambda$openEngineAndRecoverFromTranslog$5(IndexShard.java:1395) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslogInternal(InternalEngine.java:442) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"... 13 more\"] }\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}