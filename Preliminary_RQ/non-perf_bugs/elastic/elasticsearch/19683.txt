{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19683","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19683/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19683/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19683/events","html_url":"https://github.com/elastic/elasticsearch/issues/19683","id":168315471,"node_id":"MDU6SXNzdWUxNjgzMTU0NzE=","number":19683,"title":"Cardinality aggregation not working with term aggregation using include/exclude filters","user":{"login":"dobariya","id":10497122,"node_id":"MDQ6VXNlcjEwNDk3MTIy","avatar_url":"https://avatars0.githubusercontent.com/u/10497122?v=4","gravatar_id":"","url":"https://api.github.com/users/dobariya","html_url":"https://github.com/dobariya","followers_url":"https://api.github.com/users/dobariya/followers","following_url":"https://api.github.com/users/dobariya/following{/other_user}","gists_url":"https://api.github.com/users/dobariya/gists{/gist_id}","starred_url":"https://api.github.com/users/dobariya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dobariya/subscriptions","organizations_url":"https://api.github.com/users/dobariya/orgs","repos_url":"https://api.github.com/users/dobariya/repos","events_url":"https://api.github.com/users/dobariya/events{/privacy}","received_events_url":"https://api.github.com/users/dobariya/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-07-29T12:36:41Z","updated_at":"2016-07-30T21:46:34Z","closed_at":"2016-07-30T21:45:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elastic version-2.3.3**:\n\n**JVM-1.8**:\n\n**OS-Windows Server 2008 R2**:\n\n**We want distinct count on each term aggregation performed so we used below query to perform the same using cardinality aggregation with term aggregation.But we found that cardinality is not working when used \"include filters\" with term aggregation.Total distinct names in ES we have 20 and after include filters is applied we have distinct 4 names but cardinality is not able to get and always return 20.Please look into this or else correct me if i have missed anything to get the desired output.**:\n\nQuery\n\n```\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"filter\": {\n      \"filter\": {},\n      \"aggs\": {\n        \"Names\": {\n          \"terms\": {\n            \"field\": \"names\",\n            \"size\": 100,\n            \"order\": [\n              {\n                \"_count\": \"desc\"\n              }\n            ],\n            \"include\":\"da.*\"            \n          }\n        },\n        \"count\": {\n          \"cardinality\": {\n            \"field\": \"names\"\n          }\n        }        \n      }\n    }\n  }\n}\n```\n\nReturned result\n\n```\n{\n  \"took\": 2,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 1,\n    \"successful\": 1,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 74204,\n    \"max_score\": 0,\n    \"hits\": []\n  },\n  \"aggregations\": {\n    \"filter\": {\n      \"doc_count\": 74204,\n      \"Names\": {\n        \"doc_count_error_upper_bound\": 0,\n        \"sum_other_doc_count\": 0,\n        \"buckets\": [\n          {\n            \"key\": \"daren_farmer\",\n            \"doc_count\": 9437\n          },\n          {\n            \"key\": \"dan_hyvl\",\n            \"doc_count\": 4003\n          },\n          {\n            \"key\": \"danny_mccarty\",\n            \"doc_count\": 2092\n          },\n          {\n            \"key\": \"dana_davis\",\n            \"doc_count\": 2073\n          }\n        ]\n      },\n      \"count\": {\n        \"value\": 20\n      }\n    }\n  }\n}\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}