[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/623756729","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-623756729","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":623756729,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMzc1NjcyOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-05-04T23:15:13Z","updated_at":"2020-05-04T23:15:13Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra (:Core/Infra/Logging)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/623990630","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-623990630","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":623990630,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMzk5MDYzMA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2020-05-05T11:06:06Z","updated_at":"2020-05-05T11:10:43Z","author_association":"MEMBER","body":"The underlying problem here is that Log4j doesn't do *any* cleanup of loggers, once a logger is created, it is forever registered in the logger registry and there is no cleanup. This is why we introduced `PrefixLogger`, so that we *can* have, for example, per-index loggers that *are* cleaned up when the index is no longer allocated to a node. However, using per-index loggers in the slow logs with separate log-levels per such logger means that we can not use the `PrefixLogger` mechanism. It requires that Log4j create a logger for each slow log logger, and that will be forever maintained in the registry. Using per-index loggers in the slow log is therefore fatal. We effectively have two options then:\r\n - if we want to maintain per-index slow log settings, we have to use a single logger, but implement the logging level decision-making ourselves\r\n - remove per-index slow log settings\r\n\r\nI'm not sure that I see the benefits of per-index slow log settings. If I want to log what is slow, I would want that for all of my indices. Therefore, I advocate that we remove per-index slow log settings.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624008870","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-624008870","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":624008870,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDAwODg3MA==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-05-05T11:51:46Z","updated_at":"2020-05-05T11:51:46Z","author_association":"CONTRIBUTOR","body":"There is a https://logging.apache.org/log4j/2.x/log4j-api/apidocs/org/apache/logging/log4j/spi/LoggerRegistry.WeakMapFactory.html that possibly could help us.\r\nI probably need to educate myself better on this, sadly the log4j2 docs are not very detailed on the subject.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624010085","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-624010085","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":624010085,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDAxMDA4NQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2020-05-05T11:54:12Z","updated_at":"2020-05-05T11:54:12Z","author_association":"MEMBER","body":"The weak map factory is designed for web servers like Tomcat where there are servlets that carry various context used when creating the logger. Using the weak map factory in Elasticsearch means replacing the logger registry which means replacing the logger context (since it holds a private reference to the logger registry and can not be controlled) which means replacing the logger context factory. It's a lot of hoops to jump through and we end up copying a lot of Log4j behavior. Again, I question the value of per-index slow log settings to begin with. Let's start with what features we want, and then engineer the solution.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/625097063","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-625097063","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":625097063,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNTA5NzA2Mw==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-05-07T08:02:08Z","updated_at":"2020-05-07T08:02:08Z","author_association":"CONTRIBUTOR","body":"we discussed this during core-infra sync on 6th May. The conclusion is that we will deprecate the use of changing log level per index in 7.x and remove it in 8. We will still allow changing thresholds per index. To fix a memory leak in 7.x we will revert the change that creates a new log4j logger per index and will do a \"manual\" check of index name/package checks.\r\n\r\nIn ES8 we will no longer allow changing  log level per index. That means `index.search.slowlog.level: info` will be removed.\r\nIf a slowlog is required for specific index/index pattern, it will have to be changed using thresholds. \r\n\r\nThe option of maintaining current behaviour was rejected. It would require to maintain too many classes from log4j2.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/634708686","html_url":"https://github.com/elastic/elasticsearch/issues/56171#issuecomment-634708686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56171","id":634708686,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNDcwODY4Ng==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-05-27T14:42:21Z","updated_at":"2020-05-27T14:42:21Z","author_association":"CONTRIBUTOR","body":"closed by https://github.com/elastic/elasticsearch/pull/56708","performed_via_github_app":null}]