[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/666445168","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-666445168","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":666445168,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NjQ0NTE2OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-07-30T15:16:22Z","updated_at":"2020-07-30T15:16:22Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667159309","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667159309","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667159309,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzE1OTMwOQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T14:50:08Z","updated_at":"2020-07-31T14:50:08Z","author_association":"CONTRIBUTOR","body":"Same thing in https://gradle-enterprise.elastic.co/s/ouvoly2gv5m4a\r\n\r\n```\r\norg.elasticsearch.client.ResponseException: method [DELETE], host [http://127.0.0.1:54989], URI [/_ml/data_frame/analytics/bar], status line [HTTP/1.1 503 Service Unavailable]\t\r\n\t{\"error\":{\"root_cause\":[],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[]},\"status\":503}\r\n```\r\n\r\nThis happens in the cleanup code after the test completes, in `MlRestTestStateCleaner.deleteAllDataFrameAnalytics()`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667163293","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667163293","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667163293,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzE2MzI5Mw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T14:56:51Z","updated_at":"2020-07-31T14:56:51Z","author_association":"MEMBER","body":"Another occurrence: https://gradle-enterprise.elastic.co/s/ouvoly2gv5m4a","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667171438","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667171438","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667171438,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzE3MTQzOA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T15:11:07Z","updated_at":"2020-07-31T15:24:47Z","author_association":"CONTRIBUTOR","body":"The server side log for that last failure shows this:\r\n\r\n```\r\n[2020-07-31T14:32:42,487][INFO ][o.e.x.c.m.u.MlIndexAndAlias] [integTest-0] About to create first concrete index [.ml-stats-000001] with alias [.ml-stats-write]\r\n[2020-07-31T14:32:42,493][INFO ][o.e.c.m.MetadataCreateIndexService] [integTest-0] [.ml-stats-000001] creating index, cause [api], templates [.ml-stats], shards [1]/[1]\r\n[2020-07-31T14:32:42,493][INFO ][o.e.c.r.a.AllocationService] [integTest-0] updating number_of_replicas to [0] for indices [.ml-stats-000001]\r\n[2020-07-31T14:32:42,494][DEBUG][o.e.c.c.PublicationTransportHandler] [integTest-0] received diff cluster state version [5683] with uuid [OHsvjifSS6my7tN1ogOq5g], diff size [1107]\r\n[2020-07-31T14:32:42,539][DEBUG][o.e.c.c.C.CoordinatorPublication] [integTest-0] publication ended successfully: Publication{term=1, version=5683}\r\n[2020-07-31T14:32:42,540][INFO ][o.e.x.i.IndexLifecycleTransition] [integTest-0] moving index [.ml-stats-000001] from [null] to [{\"phase\":\"new\",\"action\":\"complete\",\"name\":\"complete\"}] in policy [ml-size-based-ilm-policy]\r\n[2020-07-31T14:32:42,540][DEBUG][o.e.c.c.PublicationTransportHandler] [integTest-0] received diff cluster state version [5684] with uuid [sO5GrF17TWuywmGeF21c5A], diff size [502]\r\n[2020-07-31T14:32:42,545][WARN ][r.suppressed             ] [integTest-0] path: /_ml/data_frame/analytics/bar, params: {id=bar}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:554) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:309) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:585) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onShardFailure(AbstractSearchAsyncAction.java:393) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.access$100(AbstractSearchAsyncAction.java:68) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction$1.onFailure(AbstractSearchAsyncAction.java:245) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:59) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:403) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService$6.handleException(TransportService.java:638) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1172) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1281) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1255) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:61) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportChannel.sendErrorResponse(TransportChannel.java:56) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.action.support.ChannelActionListener.onFailure(ChannelActionListener.java:51) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.search.SearchService.lambda$runAsync$0(SearchService.java:414) ~[elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:710) [elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.10.0-SNAPSHOT.jar:7.10.0-SNAPSHOT]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_221]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_221]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_221]\r\n```\r\n\r\nTherefore it seems likely that the problem happens when deleting the job stats while the stats index isn't yet ready.  This also ties up with `\"failed_shards\":[]` in the exception message - all shards failed yet no failed shards implies no shards at all were queried.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667201180","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667201180","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667201180,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzIwMTE4MA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T16:05:30Z","updated_at":"2020-07-31T16:05:30Z","author_association":"CONTRIBUTOR","body":"I think the problem may be coming from the async nature of the `TrainedModelStatsService`.\r\n\r\nSuppose a test does something that triggers the `TrainedModelStatsService` to start operating.  That will then continue to operate in the background while other tests run.\r\n\r\nThe cleanup in between tests will delete all the indices.  `TrainedModelStatsService` will put the `.ml-stats` index back as soon as it notices it's gone.  This may then catch out other tests that didn't expect it to exist.\r\n\r\nIn the most recent failure mentioned in this issue the failed test is `Test get stats given multiple analytics`.  That doesn't actually start any jobs, so you would not expect the `.ml-stats` index to exist at the end of it.  Data frame analytics jobs create the stats index when they are started, and the start endpoint won't return until the index is in yellow state.  So _something else_ must have created the `.ml-stats` index while the test was running and `TrainedModelStatsService` is the prime suspect.\r\n\r\nLooking at the run up to the failure, `Test create and delete pipeline with inference processor` ran about 1 second before it.  In `TrainedModelStatsService` `PERSISTENCE_INTERVAL = TimeValue.timeValueSeconds(1)`, so that would explain why the stats index got created during `Test get stats given multiple analytics`.\r\n\r\n```\r\n1> [2020-07-31T16:32:41,562][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/inference_processor/Test create and delete pipeline with inference processor] before test |  \r\n1> [2020-07-31T16:32:42,009][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/inference_processor/Test create and delete pipeline with inference processor] after test |  \r\n1> [2020-07-31T16:32:42,019][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/jobs_crud/Test put job with inconsistent model snapshot settings] before test |  \r\n1> [2020-07-31T16:32:42,037][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/jobs_crud/Test put job with inconsistent model snapshot settings] after test |  \r\n1> [2020-07-31T16:32:42,047][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/data_frame_analytics_crud/Test get stats given multiple analytics] before test |  \r\n1> [2020-07-31T16:32:42,733][INFO ][o.e.s.MlWithSecurityIT   ] [test] [yaml=ml/data_frame_analytics_crud/Test get stats given multiple analytics] after test |  \r\n2> REPRODUCE WITH: gradlew ':x-pack:plugin:ml:qa:ml-with-security:integTestRunner' --tests \"org.elasticsearch.smoketest.MlWithSecurityIT.test {yaml=ml/data_frame_analytics_crud/Test get stats given multiple analytics}\" -Dtests.seed=AFA936579D314669 -Dtests.security.manager=true -Dtests.locale=pt-BR -Dtests.timezone=Europe/Amsterdam -Druntime.java=8 -Dtests.rest.blacklist=ml/ml_classic_analyze/Test analyze API with an analyzer that does what we used to do in native code,ml/calendar_crud/Test get calendar given missing,ml/calendar_crud/Test cannot create calendar with name _all,ml/calendar_crud/Test PageParams with ID is invalid,ml/calendar_crud/Test post calendar events given empty events,ml/calendar_crud/Test put calendar given id contains invalid chars,ml/calendar_crud/Test delete event from non existing calendar,ml/calendar_crud/Test delete job from non existing calendar,ml/custom_all_field/Test querying custom all field,ml/datafeeds_crud/Test delete datafeed with missing id,ml/datafeeds_crud/Test put datafeed referring to missing job_id,ml/datafeeds_crud/Test put datafeed with invalid query,ml/datafeeds_crud/Test put datafeed with security headers in the body,ml/datafeeds_crud/Test update datafeed with missing id,ml/data_frame_analytics_crud/Test put config with security headers in the body,ml/data_frame_analytics_crud/Test put config with create_time in the body,ml/data_frame_analytics_crud/Test put config with version in the body,ml/data_frame_analytics_crud/Test put config with inconsistent body/param ids,ml/data_frame_analytics_crud/Test put config with invalid id,ml/data_frame_analytics_crud/Test put config with invalid dest index name,ml/data_frame_analytics_crud/Test put config with pattern dest index name,ml/data_frame_analytics_crud/Test put config with missing concrete source index,ml/data_frame_analytics_crud/Test put config with missing wildcard source index,ml/data_frame_analytics_crud/Test put config with dest index same as source index,ml/data_frame_analytics_crud/Test put config with dest index matching multiple indices,ml/data_frame_analytics_crud/Test put config with dest index included in source via alias,ml/data_frame_analytics_crud/Test put config with remote source index,ml/data_frame_analytics_crud/Test put config with unknown top level field,ml/data_frame_analytics_crud/Test put config with unknown field in outlier detection analysis,ml/data_frame_analytics_crud/Test put config given analyzed_fields include field excluded by source,ml/data_frame_analytics_crud/Test put config given missing source,ml/data_frame_analytics_crud/Test put config given source with empty index array,ml/data_frame_analytics_crud/Test put config given source with empty string in index array,ml/data_frame_analytics_crud/Test put config given source without index,ml/data_frame_analytics_crud/Test put config given missing dest,ml/data_frame_analytics_crud/Test put config given dest index contains uppercase chars,ml/data_frame_analytics_crud/Test put config given dest with empty index,ml/data_frame_analytics_crud/Test put config given dest without index,ml/data_frame_analytics_crud/Test put config given missing analysis,ml/data_frame_analytics_crud/Test put config given empty analysis,ml/data_frame_analytics_crud/Test max model memory limit,ml/data_frame_analytics_crud/Test put outlier_detection given n_neighbors is negative,ml/data_frame_analytics_crud/Test put outlier_detection given n_neighbors is zero,ml/data_frame_analytics_crud/Test put outlier_detection given feature_influence_threshold is negative,ml/data_frame_analytics_crud/Test put outlier_detection given feature_influence_threshold is greater than one,ml/data_frame_analytics_crud/Test put outlier_detection given outlier_fraction is negative,ml/data_frame_analytics_crud/Test put outlier_detection given outlier_fraction is greater than one,ml/data_frame_analytics_crud/Test put regression given dependent_variable is not defined,ml/data_frame_analytics_crud/Test put regression given negative lambda,ml/data_frame_analytics_crud/Test put regression given negative gamma,ml/data_frame_analytics_crud/Test put regression given eta less than 1e-3,ml/data_frame_analytics_crud/Test put regression given eta greater than one,ml/data_frame_analytics_crud/Test put regression given max_trees is zero,ml/data_frame_analytics_crud/Test put regression given max_trees is greater than 2k,ml/data_frame_analytics_crud/Test put regression given feature_bag_fraction is negative,ml/data_frame_analytics_crud/Test put regression given feature_bag_fraction is greater than one,ml/data_frame_analytics_crud/Test put regression given training_percent is less than one,ml/data_frame_analytics_crud/Test put regression given training_percent is greater than hundred,ml/data_frame_analytics_crud/Test put regression given loss_function_parameter is zero,ml/data_frame_analytics_crud/Test put regression given loss_function_parameter is negative,ml/data_frame_analytics_crud/Test put classification given dependent_variable is not defined,ml/data_frame_analytics_crud/Test put classification given negative lambda,ml/data_frame_analytics_crud/Test put classification given negative gamma,ml/data_frame_analytics_crud/Test put classification given eta less than 1e-3,ml/data_frame_analytics_crud/Test put classification given eta greater than one,ml/data_frame_analytics_crud/Test put classification given max_trees is zero,ml/data_frame_analytics_crud/Test put classification given max_trees is greater than 2k,ml/data_frame_analytics_crud/Test put classification given feature_bag_fraction is negative,ml/data_frame_analytics_crud/Test put classification given feature_bag_fraction is greater than one,ml/data_frame_analytics_crud/Test put classification given num_top_classes is less than zero,ml/data_frame_analytics_crud/Test put classification given num_top_classes is greater than 1k,ml/data_frame_analytics_crud/Test put classification given training_percent is less than one,ml/data_frame_analytics_crud/Test put classification given training_percent is greater than hundred,ml/estimate_model_memory/Test missing overall cardinality,ml/estimate_model_memory/Test missing max bucket cardinality,ml/evaluate_data_frame/Test given missing index,ml/evaluate_data_frame/Test given index does not exist,ml/evaluate_data_frame/Test given missing evaluation,ml/evaluate_data_frame/Test outlier_detection auc_roc given actual_field is always true,ml/evaluate_data_frame/Test outlier_detection auc_roc given actual_field is always false,ml/evaluate_data_frame/Test outlier_detection given evaluation with empty metrics,ml/evaluate_data_frame/Test outlier_detection given missing actual_field,ml/evaluate_data_frame/Test outlier_detection given missing predicted_probability_field,ml/evaluate_data_frame/Test outlier_detection given precision with threshold less than zero,ml/evaluate_data_frame/Test outlier_detection given recall with threshold less than zero,ml/evaluate_data_frame/Test outlier_detection given confusion_matrix with threshold less than zero,ml/evaluate_data_frame/Test outlier_detection given precision with empty thresholds,ml/evaluate_data_frame/Test outlier_detection given recall with empty thresholds,ml/evaluate_data_frame/Test outlier_detection given confusion_matrix with empty thresholds,ml/evaluate_data_frame/Test classification given evaluation with empty metrics,ml/evaluate_data_frame/Test classification given missing actual_field,ml/evaluate_data_frame/Test classification given missing predicted_field,ml/evaluate_data_frame/Test regression given evaluation with empty metrics,ml/evaluate_data_frame/Test regression given missing actual_field,ml/evaluate_data_frame/Test regression given missing predicted_field,ml/explain_data_frame_analytics/Test neither job id nor body,ml/explain_data_frame_analytics/Test both job id and body,ml/explain_data_frame_analytics/Test missing job,ml/explain_data_frame_analytics/Test empty data frame given body,ml/delete_job_force/Test cannot force delete a non-existent job,ml/delete_model_snapshot/Test delete snapshot missing snapshotId,ml/delete_model_snapshot/Test delete snapshot missing job_id,ml/delete_model_snap  2> shot/Test delete with in-use model,ml/filter_crud/Test create filter api with mismatching body ID,ml/filter_crud/Test create filter given invalid filter_id,ml/filter_crud/Test get filter API with bad ID,ml/filter_crud/Test non-existing filter,ml/filter_crud/Test update filter given remove item is not present,ml/filter_crud/Test get all filter given index exists but no mapping for filter_id,ml/get_datafeed_stats/Test get datafeed stats given missing datafeed_id,ml/get_datafeeds/Test get datafeed given missing datafeed_id,ml/inference_crud/Test delete given used trained model,ml/inference_crud/Test delete with missing model,ml/inference_crud/Test get given missing trained model,ml/inference_crud/Test get given expression without matches and allow_no_match is false,ml/inference_crud/Test put ensemble with empty models,ml/inference_crud/Test put ensemble with tree where tree has out of bounds feature_names index,ml/inference_crud/Test put model with empty input.field_names,ml/inference_crud/Test PUT model where target type and inference config mismatch,ml/inference_processor/Test create processor with missing mandatory fields,ml/inference_stats_crud/Test get stats given missing trained model,ml/inference_stats_crud/Test get stats given expression without matches and allow_no_match is false,ml/jobs_crud/Test cannot create job with existing categorizer state document,ml/jobs_crud/Test cannot create job with existing quantiles document,ml/jobs_crud/Test cannot create job with existing result document,ml/jobs_crud/Test cannot create job with model snapshot id set,ml/jobs_crud/Test cannot decrease model_memory_limit below current usage,ml/jobs_crud/Test get job API with non existing job id,ml/jobs_crud/Test put job after closing results index,ml/jobs_crud/Test put job after closing state index,ml/jobs_crud/Test put job with inconsistent body/param ids,ml/jobs_crud/Test put job with inconsistent model snapshot settings,ml/jobs_crud/Test put job with time field in analysis_config,ml/jobs_crud/Test put job with duplicate detector configurations,ml/jobs_crud/Test job with categorization_analyzer and categorization_filters,ml/jobs_get/Test get job given missing job_id,ml/jobs_get_result_buckets/Test mutually-exclusive params,ml/jobs_get_result_buckets/Test mutually-exclusive params via body,ml/jobs_get_result_categories/Test with invalid param combinations,ml/jobs_get_result_categories/Test with invalid param combinations via body,ml/jobs_get_result_overall_buckets/Test overall buckets given missing job,ml/jobs_get_result_overall_buckets/Test overall buckets given non-matching expression and not allow_no_jobs,ml/jobs_get_result_overall_buckets/Test overall buckets given top_n is 0,ml/jobs_get_result_overall_buckets/Test overall buckets given top_n is negative,ml/jobs_get_result_overall_buckets/Test overall buckets given invalid start param,ml/jobs_get_result_overall_buckets/Test overall buckets given invalid end param,ml/jobs_get_result_overall_buckets/Test overall buckets given bucket_span is smaller than max job bucket_span,ml/jobs_get_stats/Test get job stats given missing job,ml/jobs_get_stats/Test no exception on get job stats with missing index,ml/job_groups/Test put job with empty group,ml/job_groups/Test put job with group that matches an job id,ml/job_groups/Test put job with group that matches its id,ml/job_groups/Test put job with id that matches an existing group,ml/job_groups/Test put job with invalid group,ml/ml_info/Test ml info,ml/pipeline_inference/Test setting results field is invalid,ml/post_data/Test Flush data with invalid parameters,ml/post_data/Test flushing and posting a closed job,ml/post_data/Test open and close with non-existent job id,ml/post_data/Test POST data with invalid parameters,ml/preview_datafeed/Test preview missing datafeed,ml/revert_model_snapshot/Test revert model with invalid snapshotId,ml/start_data_frame_analytics/Test start given missing source index,ml/start_data_frame_analytics/Test start outlier_detection given source index has no fields,ml/start_data_frame_analytics/Test start regression given source index only has dependent variable,ml/start_data_frame_analytics/Test start with inconsistent body/param ids,ml/start_data_frame_analytics/Test start given dest index is not empty,ml/start_data_frame_analytics/Test start with compatible fields but no data,ml/start_stop_datafeed/Test start datafeed job, but not open,ml/start_stop_datafeed/Test start non existing datafeed,ml/start_stop_datafeed/Test stop non existing datafeed,ml/update_model_snapshot/Test without description,ml/validate/Test invalid job config,ml/validate/Test job config is invalid because model snapshot id set,ml/validate/Test job config that is invalid only because of the job ID,ml/validate/Test job config with duplicate detector configurations,ml/validate_detector/Test invalid detector,ml/delete_forecast/Test delete on _all forecasts not allow no forecasts,ml/delete_forecast/Test delete forecast on missing forecast,ml/set_upgrade_mode/Attempt to open job when upgrade_mode is enabled,ml/set_upgrade_mode/Setting upgrade_mode to enabled,ml/set_upgrade_mode/Setting upgrade mode to disabled from enabled,ml/set_upgrade_mode/Test setting upgrade_mode to false when it is already false\r\n```\r\n\r\nWe have had situations before where the test harness and the server code fight each other to delete and recreate indices and/or index templates.  I am not sure what the solution is in this case.  @benwtrent is there a way we can cancel the `TrainedModelStatsService` in the cleanup that runs in between YAML tests so that it's only running in tests that actually test inference?  Another alternative might be to tell the cleanup in between tests not to delete the `.ml-stats*` indices, any change any tests that want to assert on the contents of it to explicitly delete all documents from it as their first step.  Maybe there is a solution that is better still.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667201989","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667201989","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667201989,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzIwMTk4OQ==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T16:07:10Z","updated_at":"2020-07-31T16:07:10Z","author_association":"MEMBER","body":"@droberts195 would better integration with node lifecycle fix it? Or are these nodes the same between tests?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667204301","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667204301","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667204301,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzIwNDMwMQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T16:11:24Z","updated_at":"2020-07-31T16:11:24Z","author_association":"CONTRIBUTOR","body":"> Or are these nodes the same between tests?\r\n\r\nIt's a single node for the whole test suite.\r\n\r\nIf you download https://storage.cloud.google.com/elasticsearch-ci-artifacts/jobs/elastic+elasticsearch+7.x+multijob-windows-compatibility/os=windows-2012-r2/build/132.tar.bz2, expand it and then look in `x-pack/plugin/ml/qa/ml-with-security/build/testclusters/integTest-0/logs/integTest.log` you can see everything that node did during the test suite.  You can see it ran for 11 minutes.\r\n\r\nIt would be too slow if a separate JVM had to be spun up for every YAML test.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/667231060","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-667231060","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":667231060,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NzIzMTA2MA==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T17:03:13Z","updated_at":"2020-07-31T17:14:24Z","author_association":"MEMBER","body":"@droberts195 what if delete analytics job didn't throw when there was a problem deleting from the stats index?\r\n\r\nI suppose at that point there is the worry of leftover stats documents :/ But we would have this issue in production anyways if a user ran into this. \r\n\r\n> is there a way we can cancel the TrainedModelStatsService\r\n\r\nYaml tests require all interactions are done via a REST API. So, if we added something like this, it would have to be an API call. \r\n\r\nThere is also no way to wait for the stats service to become idle (outside of a separate API call).\r\n\r\nIngest pipeline deletion is is a cluster state removal action. Then other things are triggered off of that, so there is no way to put a `wait` there.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/669147412","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-669147412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":669147412,"node_id":"MDEyOklzc3VlQ29tbWVudDY2OTE0NzQxMg==","user":{"login":"andreidan","id":1217601,"node_id":"MDQ6VXNlcjEyMTc2MDE=","avatar_url":"https://avatars2.githubusercontent.com/u/1217601?v=4","gravatar_id":"","url":"https://api.github.com/users/andreidan","html_url":"https://github.com/andreidan","followers_url":"https://api.github.com/users/andreidan/followers","following_url":"https://api.github.com/users/andreidan/following{/other_user}","gists_url":"https://api.github.com/users/andreidan/gists{/gist_id}","starred_url":"https://api.github.com/users/andreidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreidan/subscriptions","organizations_url":"https://api.github.com/users/andreidan/orgs","repos_url":"https://api.github.com/users/andreidan/repos","events_url":"https://api.github.com/users/andreidan/events{/privacy}","received_events_url":"https://api.github.com/users/andreidan/received_events","type":"User","site_admin":false},"created_at":"2020-08-05T11:47:57Z","updated_at":"2020-08-05T11:47:57Z","author_association":"CONTRIBUTOR","body":"Another failure https://gradle-enterprise.elastic.co/s/2p4o7efd3lmrk","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/669211706","html_url":"https://github.com/elastic/elasticsearch/issues/60462#issuecomment-669211706","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60462","id":669211706,"node_id":"MDEyOklzc3VlQ29tbWVudDY2OTIxMTcwNg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-08-05T14:02:05Z","updated_at":"2020-08-05T14:02:05Z","author_association":"CONTRIBUTOR","body":"> what if delete analytics job didn't throw when there was a problem deleting from the stats index?\r\n\r\nWe discussed this in the team meeting and agreed to do this.\r\n\r\nPlus we'll also clean up orphaned stats documents in the nightly maintenance like we clean up orphaned state documents.","performed_via_github_app":null}]