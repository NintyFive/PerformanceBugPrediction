[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278875985","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278875985","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278875985,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg3NTk4NQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T07:26:04Z","updated_at":"2017-02-10T07:26:04Z","author_association":"MEMBER","body":"Thx @liuyaopeng but I find it hard to understand what went wrong. Can you maybe give concrete examples of API calls and responses?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278880473","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278880473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278880473,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg4MDQ3Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T07:55:52Z","updated_at":"2017-02-10T07:55:52Z","author_association":"CONTRIBUTOR","body":"Hi @liuyaopeng \r\n\r\nI've just tested this with 5 shards and 7 slices and it worked perfectly.  If you're still having problems, I'd start with opening an issue in the forums https://discuss.elastic.co with a complete recreation.  If you do find a bug, then please open an issue with the recreation.\r\n\r\nthanks","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278899136","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278899136","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278899136,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg5OTEzNg==","user":{"login":"liuyaopeng","id":16117490,"node_id":"MDQ6VXNlcjE2MTE3NDkw","avatar_url":"https://avatars3.githubusercontent.com/u/16117490?v=4","gravatar_id":"","url":"https://api.github.com/users/liuyaopeng","html_url":"https://github.com/liuyaopeng","followers_url":"https://api.github.com/users/liuyaopeng/followers","following_url":"https://api.github.com/users/liuyaopeng/following{/other_user}","gists_url":"https://api.github.com/users/liuyaopeng/gists{/gist_id}","starred_url":"https://api.github.com/users/liuyaopeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuyaopeng/subscriptions","organizations_url":"https://api.github.com/users/liuyaopeng/orgs","repos_url":"https://api.github.com/users/liuyaopeng/repos","events_url":"https://api.github.com/users/liuyaopeng/events{/privacy}","received_events_url":"https://api.github.com/users/liuyaopeng/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T09:38:21Z","updated_at":"2017-02-10T10:45:53Z","author_association":"NONE","body":"@Hi @clintongormley \r\nThank you for your reply.I did some experiments. \r\nHere is my code:\r\n\r\n```\r\n        int totalResults = 0;\r\n        int s = 7;\r\n        List<String> keys = new ArrayList<>();\r\n        for (int i = 0; i < s; i++) {\r\n            int j = 0;\r\n            SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();\r\n            searchSourceBuilder.size(Integer.MAX_VALUE);\r\n            searchSourceBuilder.query(QueryBuilders.matchAllQuery());\r\n            searchSourceBuilder.slice(new SliceBuilder(i, s));\r\n            Settings settings = Settings.builder().put(\"client.transport.sniff\", true).put(\"cluster.name\", \"elasticsearch-gennlife-ark-2.0\").build();\r\n            TransportClient client = null;\r\n            client = (new PreBuiltTransportClient(settings, new Class[0])).addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(\"10.0.0.66\"), 9301));\r\n\r\n            SearchRequestBuilder builder = client.prepareSearch(new String[]{\"yantai_hospital_clinical_patients\"}).setTypes(new String[]{\"patients\"}).setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setSource(searchSourceBuilder);\r\n\r\n\r\n            SearchResponse responsesearch = (SearchResponse) builder.setScroll(\"5m\").setSize(500).execute().actionGet();\r\n\r\n            totalResults += responsesearch.getHits().getHits().length;\r\n            int expectedSliceResults = (int) responsesearch.getHits().getTotalHits();\r\n            int numSliceResults = responsesearch.getHits().getHits().length;\r\n            String scrollId = responsesearch.getScrollId();\r\n\r\n            for (SearchHit hit : responsesearch.getHits().getHits()) {\r\n                keys.add(hit.getId());\r\n            }\r\n\r\n            while (responsesearch.getHits().getHits().length > 0) {\r\n                responsesearch = client.prepareSearchScroll(\"test\")\r\n                        .setScrollId(scrollId)\r\n                        .setScroll(new Scroll(TimeValue.timeValueSeconds(10)))\r\n                        .get();\r\n                scrollId = responsesearch.getScrollId();\r\n                totalResults += responsesearch.getHits().getHits().length;\r\n                numSliceResults += responsesearch.getHits().getHits().length;\r\n                for (SearchHit hit : responsesearch.getHits().getHits()) {\r\n                    keys.add(hit.getId());\r\n                }\r\n            }\r\n\r\n\r\n            client.close();\r\n\r\n            System.out.println(\"slice:\" + i + \",\" + numSliceResults);\r\n        }\r\n        System.out.println(\"total:\" + totalResults);\r\n    \r\n```\r\nI have 5 shards, total 11501 docs.\r\nThe following is the case of 7slice output\r\n\r\n> slice:0,1168\r\nslice:1,1155\r\nslice:2,2282\r\nslice:3,2333\r\nslice:4,2284\r\nslice:5,1167\r\nslice:6,1120\r\ntotal:11509\r\n\r\nOur elasticsearch server version is 5.1.1ï¼Œmy elasticsearch client is 5.2.0. i has try it on http,This is also the case.\r\n\r\nThanks\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278917473","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278917473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278917473,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODkxNzQ3Mw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T11:07:11Z","updated_at":"2017-02-10T11:07:11Z","author_association":"MEMBER","body":"@liuyaopeng I tried to reproduce your issue but couldn't. I checked with 5.1.1, 5.2, 5.3, 5.x and master, they all returned the expected number of hits using your code (and random data). \r\n> I have 5 shards, total 11501 docs.\r\n\r\nAre you sure ? ;)\r\nAre you adding/deleting/updating documents during your test ? Can you try to do:\r\n\r\n````\r\nGET yantai_hospital_clinical_patients/patients/_search\r\n{\r\n}\r\n````\r\n.. and check the `hits.total` returned in the response. Is it 11501 ?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278921772","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278921772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278921772,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODkyMTc3Mg==","user":{"login":"liuyaopeng","id":16117490,"node_id":"MDQ6VXNlcjE2MTE3NDkw","avatar_url":"https://avatars3.githubusercontent.com/u/16117490?v=4","gravatar_id":"","url":"https://api.github.com/users/liuyaopeng","html_url":"https://github.com/liuyaopeng","followers_url":"https://api.github.com/users/liuyaopeng/followers","following_url":"https://api.github.com/users/liuyaopeng/following{/other_user}","gists_url":"https://api.github.com/users/liuyaopeng/gists{/gist_id}","starred_url":"https://api.github.com/users/liuyaopeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuyaopeng/subscriptions","organizations_url":"https://api.github.com/users/liuyaopeng/orgs","repos_url":"https://api.github.com/users/liuyaopeng/repos","events_url":"https://api.github.com/users/liuyaopeng/events{/privacy}","received_events_url":"https://api.github.com/users/liuyaopeng/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T11:31:04Z","updated_at":"2017-02-10T11:31:04Z","author_association":"NONE","body":"@jimczi \r\n\r\n> \"took\": 10,\r\n\"timed_out\": false,\r\n\"_shards\": {\r\n\"total\": 5,\r\n\"successful\": 5,\r\n\"failed\": 0\r\n},\r\n\"hits\": {\r\n\"total\": 11501,\r\n\r\nHere was the  response header.\r\nWhere i test, nobody doing adding/deleting/updating for the  documents.\r\n\r\nI found that each with a slice query out the number of data is not unique, is a random change. For example, slice0, there may be 1168 or 1160. Or other numbers. So it will cause the total number of inconsistencies.\r\nDo you know what the situation is? Do you  have any ideas to fix it?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278922430","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-278922430","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":278922430,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODkyMjQzMA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T11:35:00Z","updated_at":"2017-02-10T11:35:00Z","author_association":"MEMBER","body":"> I found that each with a slice query out the number of data is not unique, is a random change. For example, slice0, there may be 1168 or 1160. Or other numbers. So it will cause the total number of inconsistencies.\r\n\r\nThis should not happen unless you have replicas out of sync. The slice query choose a set of replica to run the query and stick to it for the whole scroll. Each slice is independent and can choose a different replica to perform the request so I suspect that you have replicas with different number of documents. Can you check that ? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/279117000","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-279117000","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":279117000,"node_id":"MDEyOklzc3VlQ29tbWVudDI3OTExNzAwMA==","user":{"login":"liuyaopeng","id":16117490,"node_id":"MDQ6VXNlcjE2MTE3NDkw","avatar_url":"https://avatars3.githubusercontent.com/u/16117490?v=4","gravatar_id":"","url":"https://api.github.com/users/liuyaopeng","html_url":"https://github.com/liuyaopeng","followers_url":"https://api.github.com/users/liuyaopeng/followers","following_url":"https://api.github.com/users/liuyaopeng/following{/other_user}","gists_url":"https://api.github.com/users/liuyaopeng/gists{/gist_id}","starred_url":"https://api.github.com/users/liuyaopeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuyaopeng/subscriptions","organizations_url":"https://api.github.com/users/liuyaopeng/orgs","repos_url":"https://api.github.com/users/liuyaopeng/repos","events_url":"https://api.github.com/users/liuyaopeng/events{/privacy}","received_events_url":"https://api.github.com/users/liuyaopeng/received_events","type":"User","site_admin":false},"created_at":"2017-02-11T03:14:17Z","updated_at":"2017-02-11T03:14:40Z","author_association":"NONE","body":"@jimczi \r\nI checked the replica of the problem,\r\nbut I could not found any problem about that.\r\n\r\n> yantai_hospital_clinical_patients 1 r STARTED 2275 11.9mb 10.0.0.66 node-66\r\nyantai_hospital_clinical_patients 1 p STARTED 2275 11.9mb 10.0.0.67 node-67\r\nyantai_hospital_clinical_patients 2 p STARTED 2282 13.6mb 10.0.0.66 node-66\r\nyantai_hospital_clinical_patients 2 r STARTED 2282 13.6mb 10.0.0.67 node-67\r\nyantai_hospital_clinical_patients 4 p STARTED 2284 12.5mb 10.0.0.66 node-66\r\nyantai_hospital_clinical_patients 4 r STARTED 2284 12.5mb 10.0.0.67 node-67\r\nyantai_hospital_clinical_patients 3 r STARTED 2333   13mb 10.0.0.66 node-66\r\nyantai_hospital_clinical_patients 3 p STARTED 2333   13mb 10.0.0.67 node-67\r\nyantai_hospital_clinical_patients 0 p STARTED 2327 12.9mb 10.0.0.66 node-66\r\nyantai_hospital_clinical_patients 0 r STARTED 2327 12.9mb 10.0.0.67 node-67\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/279212496","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-279212496","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":279212496,"node_id":"MDEyOklzc3VlQ29tbWVudDI3OTIxMjQ5Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-12T11:36:17Z","updated_at":"2017-02-12T11:36:17Z","author_association":"CONTRIBUTOR","body":"@liuyaopeng can you provide your index to us so that we can try to replicate on our side?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/279275419","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-279275419","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":279275419,"node_id":"MDEyOklzc3VlQ29tbWVudDI3OTI3NTQxOQ==","user":{"login":"liuyaopeng","id":16117490,"node_id":"MDQ6VXNlcjE2MTE3NDkw","avatar_url":"https://avatars3.githubusercontent.com/u/16117490?v=4","gravatar_id":"","url":"https://api.github.com/users/liuyaopeng","html_url":"https://github.com/liuyaopeng","followers_url":"https://api.github.com/users/liuyaopeng/followers","following_url":"https://api.github.com/users/liuyaopeng/following{/other_user}","gists_url":"https://api.github.com/users/liuyaopeng/gists{/gist_id}","starred_url":"https://api.github.com/users/liuyaopeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liuyaopeng/subscriptions","organizations_url":"https://api.github.com/users/liuyaopeng/orgs","repos_url":"https://api.github.com/users/liuyaopeng/repos","events_url":"https://api.github.com/users/liuyaopeng/events{/privacy}","received_events_url":"https://api.github.com/users/liuyaopeng/received_events","type":"User","site_admin":false},"created_at":"2017-02-13T01:43:46Z","updated_at":"2017-02-13T02:50:09Z","author_association":"NONE","body":"@clintongormley \r\nI asked my leader .\r\nOur data is confidential,so i can't send to you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408344193","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-408344193","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":408344193,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODM0NDE5Mw==","user":{"login":"wuxmer","id":6848085,"node_id":"MDQ6VXNlcjY4NDgwODU=","avatar_url":"https://avatars0.githubusercontent.com/u/6848085?v=4","gravatar_id":"","url":"https://api.github.com/users/wuxmer","html_url":"https://github.com/wuxmer","followers_url":"https://api.github.com/users/wuxmer/followers","following_url":"https://api.github.com/users/wuxmer/following{/other_user}","gists_url":"https://api.github.com/users/wuxmer/gists{/gist_id}","starred_url":"https://api.github.com/users/wuxmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuxmer/subscriptions","organizations_url":"https://api.github.com/users/wuxmer/orgs","repos_url":"https://api.github.com/users/wuxmer/repos","events_url":"https://api.github.com/users/wuxmer/events{/privacy}","received_events_url":"https://api.github.com/users/wuxmer/received_events","type":"User","site_admin":false},"created_at":"2018-07-27T08:04:05Z","updated_at":"2018-07-27T08:04:05Z","author_association":"NONE","body":"@liuyaopeng The same bug occurs in my project, have u fix it now ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408346834","html_url":"https://github.com/elastic/elasticsearch/issues/23096#issuecomment-408346834","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23096","id":408346834,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODM0NjgzNA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-07-27T08:15:19Z","updated_at":"2018-07-27T08:15:19Z","author_association":"MEMBER","body":"@wuxmer which version are you using ? This bug is fixed since 5.3.1 so if you have an issue with slicing in a version that has the fix you should open another issue.","performed_via_github_app":null}]