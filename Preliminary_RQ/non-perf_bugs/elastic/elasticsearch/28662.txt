{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28662","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28662/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28662/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28662/events","html_url":"https://github.com/elastic/elasticsearch/issues/28662","id":296752211,"node_id":"MDU6SXNzdWUyOTY3NTIyMTE=","number":28662,"title":"AccessControlException when restoring backup from azure repository","user":{"login":"okke-formsma","id":486179,"node_id":"MDQ6VXNlcjQ4NjE3OQ==","avatar_url":"https://avatars3.githubusercontent.com/u/486179?v=4","gravatar_id":"","url":"https://api.github.com/users/okke-formsma","html_url":"https://github.com/okke-formsma","followers_url":"https://api.github.com/users/okke-formsma/followers","following_url":"https://api.github.com/users/okke-formsma/following{/other_user}","gists_url":"https://api.github.com/users/okke-formsma/gists{/gist_id}","starred_url":"https://api.github.com/users/okke-formsma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/okke-formsma/subscriptions","organizations_url":"https://api.github.com/users/okke-formsma/orgs","repos_url":"https://api.github.com/users/okke-formsma/repos","events_url":"https://api.github.com/users/okke-formsma/events{/privacy}","received_events_url":"https://api.github.com/users/okke-formsma/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"assignees":[{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-02-13T14:17:13Z","updated_at":"2018-03-01T14:45:31Z","closed_at":"2018-02-21T21:13:38Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** \r\nVersion: 6.2.1, Build: 7299dc3/2018-02-07T19:34:26.990113Z, JVM: 1.8.0_161\r\n\r\n**Plugins installed**: [repository-azure]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_161\"                                             \r\nJava(TM) SE Runtime Environment (build 1.8.0_161-b12)                \r\nJava HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)     \r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux elastic6-dev 4.13.0-32-generic #35-Ubuntu SMP Thu Jan 25 09:13:46 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI'm restoring a backup from elasticsearch 5 (or 6) to an elasticsearch 6 machine using the azure-repository plugin. All index definitions seem to be restored properly, but many shards fail (>50%). Some shards are successfully recovered.\r\n\r\nThis seems similar to a previous issue; https://github.com/elastic/elasticsearch/issues/25931\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2018-02-13T14:04:54,847][WARN ][o.e.c.a.s.ShardStateAction] [ela6dev1] [xxx-2017-05][1] received shard failed for shard id [[xxx-2017-05][1]], allocation id [B_vVqxR5SGKfRoSLOZAW9Q], primary term [0], message [failed recovery], failure [RecoveryFailedException[[xxx-2017-05][1]: Recovery failed on {ela6dev1}{6LKL387lRjuE9mDdWWoanQ}{Ip9YutruRCyl7vjIv7M3WA}{10.2.30.4}{10.2.30.4:9300}]; nested: IndexShardRecoveryException[failed recovery]; nested: IndexShardRestoreFailedException[restore failed]; nested: IndexShardRestoreFailedException[failed to restore snapshot [2018-02-03/Pj8IMfHASyOCkl9rv9xO3Q]]; nested: RuntimeException[java.security.AccessControlException: access denied (\"java.net.SocketPermission\" \"xxxelasticbackup.blob.core.windows.net:443\" \"connect,resolve\")]; nested: AccessControlException[access denied (\"java.net.SocketPermission\" \"xxxelasticbackup.blob.core.windows.net:443\" \"connect,resolve\")]; ]\r\norg.elasticsearch.indices.recovery.RecoveryFailedException: [xxx-2017-05][1]: Recovery failed on {ela6dev1}{6LKL387lRjuE9mDdWWoanQ}{Ip9YutruRCyl7vjIv7M3WA}{10.2.30.4}{10.2.30.4:9300}\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2065) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:566) [elasticsearch-6.2.1.jar:6.2.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\nCaused by: org.elasticsearch.index.shard.IndexShardRecoveryException: failed recovery\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:342) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        ... 4 more\r\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: restore failed\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:463) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        ... 4 more\r\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: failed to restore snapshot [2018-02-03/Pj8IMfHASyOCkl9rv9xO3Q]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:827) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        ... 4 more\r\nCaused by: java.lang.RuntimeException: java.security.AccessControlException: access denied (\"java.net.SocketPermission\" \"xxxelasticbackup.blob.core.windows.net:443\" \"connect,resolve\")\r\n        at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1506) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:3036) ~[?:?]\r\n        at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:489) ~[?:1.8.0_161]\r\n        at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347) ~[?:?]\r\n        at com.microsoft.azure.storage.StorageException.translateException(StorageException.java:76) ~[?:?]\r\n        at com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:199) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.CloudBlob.downloadRangeInternal(CloudBlob.java:1492) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.dispatchRead(BlobInputStream.java:255) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.readInternal(BlobInputStream.java:448) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.read(BlobInputStream.java:420) ~[?:?]\r\n        at org.elasticsearch.index.snapshots.blobstore.SlicedInputStream.read(SlicedInputStream.java:92) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:133) ~[?:1.8.0_161]\r\n        at org.elasticsearch.index.snapshots.blobstore.RateLimitingInputStream.read(RateLimitingInputStream.java:69) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:107) ~[?:1.8.0_161]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restoreFile(BlobStoreRepository.java:1572) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restore(BlobStoreRepository.java:1515) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:825) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        ... 4 more\r\nCaused by: java.security.AccessControlException: access denied (\"java.net.SocketPermission\" \"xxxelasticbackup.blob.core.windows.net:443\" \"connect,resolve\")\r\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472) ~[?:1.8.0_161]\r\n        at java.security.AccessController.checkPermission(AccessController.java:884) ~[?:1.8.0_161]\r\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:549) ~[?:1.8.0_161]\r\n        at java.lang.SecurityManager.checkConnect(SecurityManager.java:1051) ~[?:1.8.0_161]\r\n        at sun.net.www.http.HttpClient.openServer(HttpClient.java:541) ~[?:?]\r\n        at sun.net.www.protocol.https.HttpsClient.<init>(HttpsClient.java:264) ~[?:?]\r\n        at sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:367) ~[?:?]\r\n        at sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:191) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1156) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1050) ~[?:?]\r\n        at sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:177) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1564) ~[?:?]\r\n        at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1492) ~[?:?]\r\n        at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480) ~[?:1.8.0_161]\r\n        at sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:347) ~[?:?]\r\n        at com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:119) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.CloudBlob.downloadRangeInternal(CloudBlob.java:1492) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.dispatchRead(BlobInputStream.java:255) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.readInternal(BlobInputStream.java:448) ~[?:?]\r\n        at com.microsoft.azure.storage.blob.BlobInputStream.read(BlobInputStream.java:420) ~[?:?]\r\n        at org.elasticsearch.index.snapshots.blobstore.SlicedInputStream.read(SlicedInputStream.java:92) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:133) ~[?:1.8.0_161]\r\n        at org.elasticsearch.index.snapshots.blobstore.RateLimitingInputStream.read(RateLimitingInputStream.java:69) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:107) ~[?:1.8.0_161]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restoreFile(BlobStoreRepository.java:1572) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restore(BlobStoreRepository.java:1515) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:825) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.1.jar:6.2.1]\r\n        ... 4 more\r\n[2018-02-13T14:04:54,920][WARN ][o.e.c.m.MetaDataMappingService] [ela6dev1] [xxx-2017-03] re-syncing mappings with cluster state because of types [[xxx]]\r\n```","closed_by":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"performed_via_github_app":null}