[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/392091849","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-392091849","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":392091849,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MjA5MTg0OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-25T15:20:43Z","updated_at":"2018-05-25T15:20:43Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402715000","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-402715000","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":402715000,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjcxNTAwMA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-07-05T13:04:51Z","updated_at":"2018-07-05T13:04:51Z","author_association":"MEMBER","body":"@tbrooks8 I think this one and #29613 may just be the same issue of lingering sockets that was fixed for some situations in https://github.com/elastic/elasticsearch/pull/26764.\r\n\r\nWhen I run the full `SimpleNetty4TransportTests` suite I'm left with ~700 lingering (I guess this could be an issue on CI when other tests ran before that that may have leaked some resources already as well) sockets in `TIME_WAIT` on my machine. If I run the suit in a loop it fails pretty quickly with either a timeout or a bind exception because of that.\r\n\r\nIf I force \r\n```\r\nbootstrap.option(ChannelOption.SO_LINGER, 0);\r\n```\r\n\r\nin `org.elasticsearch.transport.netty4.Netty4Transport#createBootstrap` I can run that suite in a loop of 1k+ iterations without trouble.\r\n\r\nAs far as I can see we're leaking those sockets when `org.elasticsearch.transport.TcpTransport.NodeChannels#close` is called, but the lifecycle check doesn't pass in \r\n\r\n```\r\n        @Override\r\n        public void close() {\r\n            if (closed.compareAndSet(false, true)) {\r\n                try {\r\n                    if (lifecycle.stopped()) {\r\n```\r\n\r\nbecause it's still in `STARTED` so the setting of linger to `0` doesn't happen in https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/transport/TcpTransport.java#L485 and we're stuck with a bunch of connections in `TIME_WAIT`.\r\n\r\nI don't understand enough of how the lifecycle of those `close` calls and `TcpTransport` works here to fix this, but maybe the above helps a little :) ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/403625797","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-403625797","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":403625797,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMzYyNTc5Nw==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-07-09T21:26:38Z","updated_at":"2018-07-09T21:26:38Z","author_association":"CONTRIBUTOR","body":"Thanks for the research @original-brownbear. I think what is happening is that we only set SO_LINGER on client connections. But that means \"accepted\" connections are in TIME_WAIT. And client connections that are closed because of those closed accepted connections (before lifecycle has stopped), are also in TIME_WAIT.\r\n\r\nI'll think about this some. I kind of think we should maybe just have a system property for the build that means we ALWAYS set SO_LINGER = 0. But do not mess with SO_LINGER for the actual running instances of Elasticsearch. @jasontedor / @s1monw thoughts?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/403791225","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-403791225","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":403791225,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMzc5MTIyNQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-07-10T11:32:40Z","updated_at":"2018-07-10T11:32:40Z","author_association":"MEMBER","body":"@tbrooks8 \r\n\r\n> I kind of think we should maybe just have a system property for the build that means we ALWAYS set SO_LINGER = 0. But do not mess with SO_LINGER for the actual running instances of Elasticsearch.\r\n\r\nCouldn't we get some other instabilities from all of a sudden sending `RST` everywhere instead of closing clean because we then throw \"Connection reset by peer\" instead of reading `-1` (or empty) in some places? (I don't know enough about all our Netty handlers to answer that).\r\nBut if that's not a concern I think it's just fine :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430258252","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-430258252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":430258252,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI1ODI1Mg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T14:25:35Z","updated_at":"2018-10-16T14:25:35Z","author_association":"CONTRIBUTOR","body":"@tbrooks8 @original-brownbear any updates on this and  #29613","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430260946","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-430260946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":430260946,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI2MDk0Ng==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T14:32:26Z","updated_at":"2018-10-16T14:32:26Z","author_association":"MEMBER","body":"@s1monw we're waiting on some feedback here I think, there's a question above in https://github.com/elastic/elasticsearch/issues/30876#issuecomment-403625797 for you (I'm + 1 on the suggestion).\r\n \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430269425","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-430269425","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":430269425,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI2OTQyNQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T14:53:49Z","updated_at":"2018-10-16T14:53:49Z","author_association":"CONTRIBUTOR","body":"@original-brownbear can we cut a PR for this and discuss it there please?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430271675","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-430271675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":430271675,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI3MTY3NQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T14:59:22Z","updated_at":"2018-10-16T15:04:56Z","author_association":"MEMBER","body":"@s1monw sure will add one for this shortly","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/435442718","html_url":"https://github.com/elastic/elasticsearch/issues/30876#issuecomment-435442718","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30876","id":435442718,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNTQ0MjcxOA==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-11-02T16:52:08Z","updated_at":"2018-11-02T16:52:08Z","author_association":"CONTRIBUTOR","body":"Closed as a number of PRs to reduce connections have been merged.","performed_via_github_app":null}]