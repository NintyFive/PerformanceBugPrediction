[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/505407372","html_url":"https://github.com/elastic/elasticsearch/issues/43577#issuecomment-505407372","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43577","id":505407372,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNTQwNzM3Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-25T11:41:38Z","updated_at":"2019-06-25T11:41:38Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/505515968","html_url":"https://github.com/elastic/elasticsearch/issues/43577#issuecomment-505515968","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43577","id":505515968,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNTUxNTk2OA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-06-25T16:15:31Z","updated_at":"2019-06-25T16:15:31Z","author_association":"MEMBER","body":"/cc @pcsanwald this looks somewhat similar to the failure in https://github.com/elastic/elasticsearch/issues/39497, perhaps related?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/505526035","html_url":"https://github.com/elastic/elasticsearch/issues/43577#issuecomment-505526035","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43577","id":505526035,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNTUyNjAzNQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-06-25T16:42:30Z","updated_at":"2019-06-25T16:42:30Z","author_association":"MEMBER","body":"Had a quick look, and found the problem area. Or at least, the point where multiple buckets are being generated, don't know enough about auto histo to know where the actual cause is.\r\n\r\nWhen you execute the above query (at a time that is a non-multiple of 30 minute), multiple buckets are generated when the coordinator is merging consecutive buckets.\r\n\r\nAt [`InternalAutoDateHistogram#mergeConsecutiveBuckets()`](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/InternalAutoDateHistogram.java#L545), we merge buckets when `i % mergeInterval == 0`.  Under this condition, we have ~18 reduced buckets total, 10 have accumulated into `sameKeyedBuckets` and 8 are left to process.  The first 10 merge into a bucket (because the `mergeInterval` is 10), and the leftover 8 get merged into a separate bucket after the loop exits.\r\n\r\nDepending on when the agg executes, sometimes it switches to 5min intervals so the values involved change slightly, but the behavior is basically the same.\r\n\r\nBy pure accident, I executed at a half-hour mark (12:30) and got a single bucket.  Once the half-hour mark passed (12:31) it went back to two buckets. \r\n\r\nI don't know enough about the merging logic to know what's going on, but I think this is probably the area that's broken.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/505540913","html_url":"https://github.com/elastic/elasticsearch/issues/43577#issuecomment-505540913","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43577","id":505540913,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNTU0MDkxMw==","user":{"login":"pcsanwald","id":163306,"node_id":"MDQ6VXNlcjE2MzMwNg==","avatar_url":"https://avatars1.githubusercontent.com/u/163306?v=4","gravatar_id":"","url":"https://api.github.com/users/pcsanwald","html_url":"https://github.com/pcsanwald","followers_url":"https://api.github.com/users/pcsanwald/followers","following_url":"https://api.github.com/users/pcsanwald/following{/other_user}","gists_url":"https://api.github.com/users/pcsanwald/gists{/gist_id}","starred_url":"https://api.github.com/users/pcsanwald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pcsanwald/subscriptions","organizations_url":"https://api.github.com/users/pcsanwald/orgs","repos_url":"https://api.github.com/users/pcsanwald/repos","events_url":"https://api.github.com/users/pcsanwald/events{/privacy}","received_events_url":"https://api.github.com/users/pcsanwald/received_events","type":"User","site_admin":false},"created_at":"2019-06-25T17:22:26Z","updated_at":"2019-06-25T17:22:26Z","author_association":"CONTRIBUTOR","body":"This does seem quite similar to the failure case and would explain why it's been so tricky to reproduce (I'm currently doing a very long run).","performed_via_github_app":null}]