{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10680","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10680/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10680/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10680/events","html_url":"https://github.com/elastic/elasticsearch/issues/10680","id":69616913,"node_id":"MDU6SXNzdWU2OTYxNjkxMw==","number":10680,"title":"ES do not wait for all shards being closed before shutdown/restart","user":{"login":"somebody32","id":25742,"node_id":"MDQ6VXNlcjI1NzQy","avatar_url":"https://avatars0.githubusercontent.com/u/25742?v=4","gravatar_id":"","url":"https://api.github.com/users/somebody32","html_url":"https://github.com/somebody32","followers_url":"https://api.github.com/users/somebody32/followers","following_url":"https://api.github.com/users/somebody32/following{/other_user}","gists_url":"https://api.github.com/users/somebody32/gists{/gist_id}","starred_url":"https://api.github.com/users/somebody32/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somebody32/subscriptions","organizations_url":"https://api.github.com/users/somebody32/orgs","repos_url":"https://api.github.com/users/somebody32/repos","events_url":"https://api.github.com/users/somebody32/events{/privacy}","received_events_url":"https://api.github.com/users/somebody32/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2015-04-20T15:45:14Z","updated_at":"2020-11-11T22:00:25Z","closed_at":"2015-05-04T14:57:04Z","author_association":"NONE","active_lock_reason":null,"body":"Hi!\n\nI have a one node setup and spotted that if I create a lot of indices/shards and then immediatly will try to restart the server, it will come back online in the red state with a couple of unassigned shards and errors in log like this:\n\n```\nCaused by: java.io.EOFException: read past EOF:   \nNIOFSIndexInput(path=\"/var/lib/elasticsearch/elasticsearch/nodes/0/indices/intelligence-reports-2014.05.01/3/index/segments_2â€)\n```\n\nThe problem is that ES starts to flush shards to the hard drive, but does not manage to do that in time, so some shards remain unflushed.\n\nInit script that comes bundled with ES gives 20 seconds for it to finish all preparations:\nstart-stop-daemon --stop --pidfile \"$PID_FILE\" \\ --user \"$ES_USER\" \\ --retry=TERM/20/KILL/5 > /dev/null\n\nIf you bump that period, ES have [hardcoded rule to do that in 30 secs](https://github.com/elastic/elasticsearch/blob/master/src/main/java/org/elasticsearch/indices/IndicesService.java#L153), otherwise:\n\n```\n[2015-04-21 15:04:03,558][INFO ][node ] [collaboration] stopping ...   \n [2015-04-21 15:04:33,581][WARN ][indices ] [collaboration] Not all shards are closed yet, waited 30sec - stopping service    \n[2015-04-21 15:04:33,581][INFO ][node ] [collaboration] stopped    \n[2015-04-21 15:04:33,581][INFO ][node ] [collaboration] closing ...    \n[2015-04-21 15:04:33,587][INFO ][node ] [collaboration] closed\n```\n\nI know that I can \"fix\" this by send `flush` after massive write is finished, but why ES needs to kill himself after 30 secs and does not wait for shards to close?\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}