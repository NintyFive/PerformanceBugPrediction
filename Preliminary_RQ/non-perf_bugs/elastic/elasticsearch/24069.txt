{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24069","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24069/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24069/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24069/events","html_url":"https://github.com/elastic/elasticsearch/issues/24069","id":221297393,"node_id":"MDU6SXNzdWUyMjEyOTczOTM=","number":24069,"title":"TimeoutExceptions on REST Client - with fix proposal","user":{"login":"Sanne","id":42573,"node_id":"MDQ6VXNlcjQyNTcz","avatar_url":"https://avatars0.githubusercontent.com/u/42573?v=4","gravatar_id":"","url":"https://api.github.com/users/Sanne","html_url":"https://github.com/Sanne","followers_url":"https://api.github.com/users/Sanne/followers","following_url":"https://api.github.com/users/Sanne/following{/other_user}","gists_url":"https://api.github.com/users/Sanne/gists{/gist_id}","starred_url":"https://api.github.com/users/Sanne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sanne/subscriptions","organizations_url":"https://api.github.com/users/Sanne/orgs","repos_url":"https://api.github.com/users/Sanne/repos","events_url":"https://api.github.com/users/Sanne/events{/privacy}","received_events_url":"https://api.github.com/users/Sanne/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":15,"created_at":"2017-04-12T15:17:04Z","updated_at":"2019-08-23T10:04:16Z","closed_at":"2018-05-09T09:00:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n\r\n5.3\r\n\r\n**Plugins installed**: N/A\r\n\r\n**JVM version**: All\r\n\r\n**OS version**: Any\r\n\r\nWhile running integration tests for the Hibernate Search project we noticed some requests failing for TimeoutException on rather slow machines. I initially thought it was a \"just a timeout\", but investigating I actually identified a problem caused by the default configuration applied by the Elasticsearch REST client.\r\n\r\nThe Apache Async HTTP client being used has a pool for Non-blocking HTTP connections, implemented by `org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager`. This pool has a connection property which can be set via `org.apache.http.client.config.RequestConfig.Builder.connectionRequestTimeout`, but the name seems to have been confusing (it certainly confused me).\r\n\r\nThis configuration property validates if the Request is stale; for some reason it's also applied to instances of `org.apache.http.nio.pool.LeaseRequest` , and the next lease instance is validated from a queue of requests even after the execution of a successul client Request. When this second request is expired, the whole execution is marked with a TimeoutException.\r\n\r\nTo clarify: the client code sends a request A to the Elasticsearch server. A is processed fine, and the response is handled fine as well. *after* this, the state of A is marked as \"timed out\" because the next request in the PoolingNHttpClientConnectionManager is an expired lease instance.\r\nI suspect this is a bug in the Apache Async client code as the error handling is essentially returning an exception which seems out of place.\r\n\r\nThe solution for us was extremely simple: set this property to zero, to disable this lease mechanism.\r\n\r\nThis mechanism is disabled by default in the Apache Async Http library, but the Elasticsearch client overrides this with its own default:\r\n org.elasticsearch.client.RestClientBuilder.DEFAULT_CONNECTION_REQUEST_TIMEOUT_MILLIS\r\n\r\nI'd recommend to set this default to zero as well. The name of the property is probably misleading? It's not really applied to the request processing on the Elasticsearch server, it's applied to the \"request to the connection pool\".\r\n\r\nThanks!\r\n\r\nRelates to:\r\n - https://hibernate.atlassian.net/browse/HSEARCH-2681\r\n\r\nI think it's the same problem mentioned here:\r\n - https://discuss.elastic.co/t/elasticsearch-in-docker-and-the-restclient-often-got-java-util-concurrent-timeoutexception/68118\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}