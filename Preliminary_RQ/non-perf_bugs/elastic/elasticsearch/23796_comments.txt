[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290643841","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-290643841","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":290643841,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDY0Mzg0MQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T07:58:13Z","updated_at":"2017-03-31T07:58:13Z","author_association":"MEMBER","body":"Full script to reproduce:\r\n```\r\nPUT test\r\n{\r\n  \"mappings\": {\r\n    \"mydocument\": {\r\n      \"properties\": {\r\n        \"mynesteddocuments\": {\r\n          \"type\": \"nested\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test/mydocument/1\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54321,\r\n  \"mynesteddocuments\": []\r\n}\r\n\r\nPOST test/mydocument/2\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54322,\r\n  \"mynesteddocuments\": [{ \"foo:\": \"bar\"}]\r\n}\r\n\r\nPOST test/mydocument/3\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54323,\r\n  \"mynesteddocuments\": [{ \"foo:\": \"bar\"}]\r\n}\r\n\r\nGET test/_search\r\n{\r\n  \"_source\": {\r\n    \"excludes\": [\r\n      \"mynesteddocuments.intprop\"\r\n    ]\r\n  },\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```\r\n\r\nNote that in the above the source filtering is excluding `mynesteddocuments.intprop` which does not exist on any of the nested documents. If you instead exclude `intprop` (see below) the document with no nested docs is returned with `\"mynesteddocuments\": []`, so the `mynesteddocuments`array is only not printed when the source excludes is excluding fields in the nested document.\r\n\r\n```\r\nGET test/_search\r\n{\r\n  \"_source\": {\r\n    \"excludes\": [\r\n      \"intprop\"\r\n    ]\r\n  },\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290644245","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-290644245","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":290644245,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDY0NDI0NQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T08:00:09Z","updated_at":"2017-03-31T12:29:49Z","author_association":"MEMBER","body":"Also note that this is not specific to nested documents. If you index the array as an embedded object (See below) you can reproduce the same thing:\r\n\r\n```\r\nDELETE test\r\n\r\nPOST test/mydocument/1\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54321,\r\n  \"mynesteddocuments\": []\r\n}\r\n\r\nPOST test/mydocument/2\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54322,\r\n  \"mynesteddocuments\": [{ \"foo:\": \"bar\"}]\r\n}\r\n\r\nPOST test/mydocument/3\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54323,\r\n  \"mynesteddocuments\": [{ \"foo:\": \"bar\"}]\r\n}\r\n\r\nGET test/_search\r\n{\r\n  \"_source\": {\r\n    \"excludes\": [\r\n      \"mynesteddocuments.intprop\"\r\n    ]\r\n  },\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290703512","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-290703512","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":290703512,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcwMzUxMg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T12:51:33Z","updated_at":"2017-03-31T12:51:33Z","author_association":"CONTRIBUTOR","body":"This needs more investigation - need to figure out the edge cases before we can figure out how to make things more consistent.\r\n\r\nWhat should we do with dots in field names eg `foo.bar.baz` and you exclude `foo.bar`?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308057297","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-308057297","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":308057297,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODA1NzI5Nw==","user":{"login":"b-viguier","id":5537799,"node_id":"MDQ6VXNlcjU1Mzc3OTk=","avatar_url":"https://avatars2.githubusercontent.com/u/5537799?v=4","gravatar_id":"","url":"https://api.github.com/users/b-viguier","html_url":"https://github.com/b-viguier","followers_url":"https://api.github.com/users/b-viguier/followers","following_url":"https://api.github.com/users/b-viguier/following{/other_user}","gists_url":"https://api.github.com/users/b-viguier/gists{/gist_id}","starred_url":"https://api.github.com/users/b-viguier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/b-viguier/subscriptions","organizations_url":"https://api.github.com/users/b-viguier/orgs","repos_url":"https://api.github.com/users/b-viguier/repos","events_url":"https://api.github.com/users/b-viguier/events{/privacy}","received_events_url":"https://api.github.com/users/b-viguier/received_events","type":"User","site_admin":false},"created_at":"2017-06-13T09:17:55Z","updated_at":"2017-06-13T09:34:30Z","author_association":"NONE","body":"Hi!\r\nWe have a lot of issues on our API because of this breaking change‚Ä¶ Instead of just returning an empty array, we have now to deal with the case where the field is missing and to replace it with an empty array *on the fly*, in order to prevent all our applications to crash when testing the length of the array‚Ä¶ üòû \r\n\r\nIs it acceptable to restore previous behavior in a fix release?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308058728","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-308058728","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":308058728,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODA1ODcyOA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-06-13T09:23:27Z","updated_at":"2017-06-13T09:23:27Z","author_association":"MEMBER","body":"@b-viguier yeah, this is a tricky area where we tried to fix things only ending up breaking something else (in this case your use case, sorry for that). We have decided to take a step back and think about the entire source filtering logic, including more edge cases. No ETA known at the moment.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308061526","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-308061526","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":308061526,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODA2MTUyNg==","user":{"login":"b-viguier","id":5537799,"node_id":"MDQ6VXNlcjU1Mzc3OTk=","avatar_url":"https://avatars2.githubusercontent.com/u/5537799?v=4","gravatar_id":"","url":"https://api.github.com/users/b-viguier","html_url":"https://github.com/b-viguier","followers_url":"https://api.github.com/users/b-viguier/followers","following_url":"https://api.github.com/users/b-viguier/following{/other_user}","gists_url":"https://api.github.com/users/b-viguier/gists{/gist_id}","starred_url":"https://api.github.com/users/b-viguier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/b-viguier/subscriptions","organizations_url":"https://api.github.com/users/b-viguier/orgs","repos_url":"https://api.github.com/users/b-viguier/repos","events_url":"https://api.github.com/users/b-viguier/events{/privacy}","received_events_url":"https://api.github.com/users/b-viguier/received_events","type":"User","site_admin":false},"created_at":"2017-06-13T09:34:21Z","updated_at":"2017-06-13T09:34:21Z","author_association":"NONE","body":"@bleskes Thank you very much for this feedback and your work about this.\r\nWe stay tuned for any news üëç ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/373680598","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-373680598","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":373680598,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MzY4MDU5OA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-03-16T11:03:38Z","updated_at":"2018-03-16T11:03:38Z","author_association":"MEMBER","body":"@elastic/es-search-aggs ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/423339539","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-423339539","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":423339539,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMzMzOTUzOQ==","user":{"login":"MacMcIrish","id":8932818,"node_id":"MDQ6VXNlcjg5MzI4MTg=","avatar_url":"https://avatars3.githubusercontent.com/u/8932818?v=4","gravatar_id":"","url":"https://api.github.com/users/MacMcIrish","html_url":"https://github.com/MacMcIrish","followers_url":"https://api.github.com/users/MacMcIrish/followers","following_url":"https://api.github.com/users/MacMcIrish/following{/other_user}","gists_url":"https://api.github.com/users/MacMcIrish/gists{/gist_id}","starred_url":"https://api.github.com/users/MacMcIrish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MacMcIrish/subscriptions","organizations_url":"https://api.github.com/users/MacMcIrish/orgs","repos_url":"https://api.github.com/users/MacMcIrish/repos","events_url":"https://api.github.com/users/MacMcIrish/events{/privacy}","received_events_url":"https://api.github.com/users/MacMcIrish/received_events","type":"User","site_admin":false},"created_at":"2018-09-20T21:28:24Z","updated_at":"2018-09-20T21:28:24Z","author_association":"CONTRIBUTOR","body":"For anyone else suffering from this issue, we were able to set up a workaround to return the empty lists by including the name of the nested parent in the `_source` in `6.3.0`\r\n\r\nExample:\r\n\r\nFor indexed model\r\n```json\r\n{\r\n  \"foo\": {\r\n    \"id\": \"value1\",\r\n    \"bar\": []\r\n  }\r\n}\r\n```\r\n   \r\n\r\n    $ curl elasticsearch:9200/foo/_search -d '{\"_source\": [\"id\", \"bar.id\"]}` -H 'Content-Type: application/json'\r\n```json\r\n{\r\n    \"_shards\": {\r\n        \"failed\": 0,\r\n        \"skipped\": 0,\r\n        \"successful\": 5,\r\n        \"total\": 5\r\n    },\r\n    \"hits\": {\r\n        \"hits\": [\r\n            {\r\n                ...\r\n                \"_source\": {\r\n                    \"id\": \"value1\"\r\n                },\r\n                \"_type\": \"foo\"\r\n            }\r\n        ],\r\n        \"max_score\": 1.0,\r\n        \"total\": 1\r\n    }\r\n}\r\n```\r\n\r\nWe were able to fix by adding \"bar\" to the `_source`\r\n\r\n    $ curl elasticsearch:9200/foo/_search -d '{\"_source\": [\"id\", \"bar\", \"bar.id\"]}` -H 'Content-Type: application/json'\r\n```json\r\n{\r\n    \"_shards\": {\r\n        \"failed\": 0,\r\n        \"skipped\": 0,\r\n        \"successful\": 5,\r\n        \"total\": 5\r\n    },\r\n    \"hits\": {\r\n        \"hits\": [\r\n            {\r\n                ...\r\n                \"_source\": {\r\n                    \"id\": \"value1\",\r\n                    \"bar\": []\r\n                },\r\n                \"_type\": \"foo\"\r\n            }\r\n        ],\r\n        \"max_score\": 1.0,\r\n        \"total\": 1\r\n    }\r\n}\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/425683791","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-425683791","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":425683791,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNTY4Mzc5MQ==","user":{"login":"simlu","id":1539747,"node_id":"MDQ6VXNlcjE1Mzk3NDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1539747?v=4","gravatar_id":"","url":"https://api.github.com/users/simlu","html_url":"https://github.com/simlu","followers_url":"https://api.github.com/users/simlu/followers","following_url":"https://api.github.com/users/simlu/following{/other_user}","gists_url":"https://api.github.com/users/simlu/gists{/gist_id}","starred_url":"https://api.github.com/users/simlu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simlu/subscriptions","organizations_url":"https://api.github.com/users/simlu/orgs","repos_url":"https://api.github.com/users/simlu/repos","events_url":"https://api.github.com/users/simlu/events{/privacy}","received_events_url":"https://api.github.com/users/simlu/received_events","type":"User","site_admin":false},"created_at":"2018-09-30T00:16:41Z","updated_at":"2018-09-30T00:16:41Z","author_association":"NONE","body":"While our solution described by @MacMcIrish works, it also returns more data that was not explicitly requested. We now prune the result in application logic again as a second step.\r\n\r\nOverall this is quite a costly bug for us. Would really like to see this fixed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/467656526","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-467656526","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":467656526,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NzY1NjUyNg==","user":{"login":"MacMcIrish","id":8932818,"node_id":"MDQ6VXNlcjg5MzI4MTg=","avatar_url":"https://avatars3.githubusercontent.com/u/8932818?v=4","gravatar_id":"","url":"https://api.github.com/users/MacMcIrish","html_url":"https://github.com/MacMcIrish","followers_url":"https://api.github.com/users/MacMcIrish/followers","following_url":"https://api.github.com/users/MacMcIrish/following{/other_user}","gists_url":"https://api.github.com/users/MacMcIrish/gists{/gist_id}","starred_url":"https://api.github.com/users/MacMcIrish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MacMcIrish/subscriptions","organizations_url":"https://api.github.com/users/MacMcIrish/orgs","repos_url":"https://api.github.com/users/MacMcIrish/repos","events_url":"https://api.github.com/users/MacMcIrish/events{/privacy}","received_events_url":"https://api.github.com/users/MacMcIrish/received_events","type":"User","site_admin":false},"created_at":"2019-02-26T23:22:00Z","updated_at":"2019-02-26T23:22:00Z","author_association":"CONTRIBUTOR","body":"Any update on this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471113691","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-471113691","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":471113691,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTExMzY5MQ==","user":{"login":"MacMcIrish","id":8932818,"node_id":"MDQ6VXNlcjg5MzI4MTg=","avatar_url":"https://avatars3.githubusercontent.com/u/8932818?v=4","gravatar_id":"","url":"https://api.github.com/users/MacMcIrish","html_url":"https://github.com/MacMcIrish","followers_url":"https://api.github.com/users/MacMcIrish/followers","following_url":"https://api.github.com/users/MacMcIrish/following{/other_user}","gists_url":"https://api.github.com/users/MacMcIrish/gists{/gist_id}","starred_url":"https://api.github.com/users/MacMcIrish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MacMcIrish/subscriptions","organizations_url":"https://api.github.com/users/MacMcIrish/orgs","repos_url":"https://api.github.com/users/MacMcIrish/repos","events_url":"https://api.github.com/users/MacMcIrish/events{/privacy}","received_events_url":"https://api.github.com/users/MacMcIrish/received_events","type":"User","site_admin":false},"created_at":"2019-03-08T23:33:17Z","updated_at":"2019-03-08T23:33:17Z","author_association":"CONTRIBUTOR","body":"This issue has become a problem for us again, we have some very large nested fields that we cannot reliably trim out of our response due to needing the above workaround. This has led to huge response sizes and long JSON parsing times.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/487184740","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-487184740","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":487184740,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzE4NDc0MA==","user":{"login":"simlu","id":1539747,"node_id":"MDQ6VXNlcjE1Mzk3NDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1539747?v=4","gravatar_id":"","url":"https://api.github.com/users/simlu","html_url":"https://github.com/simlu","followers_url":"https://api.github.com/users/simlu/followers","following_url":"https://api.github.com/users/simlu/following{/other_user}","gists_url":"https://api.github.com/users/simlu/gists{/gist_id}","starred_url":"https://api.github.com/users/simlu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simlu/subscriptions","organizations_url":"https://api.github.com/users/simlu/orgs","repos_url":"https://api.github.com/users/simlu/repos","events_url":"https://api.github.com/users/simlu/events{/privacy}","received_events_url":"https://api.github.com/users/simlu/received_events","type":"User","site_admin":false},"created_at":"2019-04-26T20:06:30Z","updated_at":"2019-04-26T20:06:30Z","author_association":"NONE","body":"We now improved our workaround from above with a multi stage fix.\r\n\r\n0) This will require maintaining a schema locally that needs to be in sync with elasticsearch and differentiates between single and array nested docs\r\n1) Further all (nested) docs have to have an id (or otherwise always present) field\r\n2) Before a request is made: For the fields requested, also request all the ids of all implicitly requested parent docs (this is necessary for multi nested array targets)\r\n3) For all nested docs in your local schema that are arrays, where the direct parent is present in the result but the nested docs are not, inject an empty array\r\n4) Prune all ids that were not originally requested\r\n\r\nShortcomings: Can not differentiate between an empty array and an array that was not indexed. For us this is not an issue, but this depends on your use case.\r\n\r\nNot great, but this seems to work so far :crossed_fingers: ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/611491567","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-611491567","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":611491567,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMTQ5MTU2Nw==","user":{"login":"somdevmehta","id":29984211,"node_id":"MDQ6VXNlcjI5OTg0MjEx","avatar_url":"https://avatars2.githubusercontent.com/u/29984211?v=4","gravatar_id":"","url":"https://api.github.com/users/somdevmehta","html_url":"https://github.com/somdevmehta","followers_url":"https://api.github.com/users/somdevmehta/followers","following_url":"https://api.github.com/users/somdevmehta/following{/other_user}","gists_url":"https://api.github.com/users/somdevmehta/gists{/gist_id}","starred_url":"https://api.github.com/users/somdevmehta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somdevmehta/subscriptions","organizations_url":"https://api.github.com/users/somdevmehta/orgs","repos_url":"https://api.github.com/users/somdevmehta/repos","events_url":"https://api.github.com/users/somdevmehta/events{/privacy}","received_events_url":"https://api.github.com/users/somdevmehta/received_events","type":"User","site_admin":false},"created_at":"2020-04-09T12:04:35Z","updated_at":"2020-04-09T12:04:35Z","author_association":"NONE","body":"Do we have any update on this issue ? \r\nI can see that the changed source filtering behavior still exists in the latest version 7.3.6.\r\n\r\nCan we not implement flag based configuration where the user can choose between new and old behavior ? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624916478","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-624916478","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":624916478,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDkxNjQ3OA==","user":{"login":"jclausen","id":5255645,"node_id":"MDQ6VXNlcjUyNTU2NDU=","avatar_url":"https://avatars3.githubusercontent.com/u/5255645?v=4","gravatar_id":"","url":"https://api.github.com/users/jclausen","html_url":"https://github.com/jclausen","followers_url":"https://api.github.com/users/jclausen/followers","following_url":"https://api.github.com/users/jclausen/following{/other_user}","gists_url":"https://api.github.com/users/jclausen/gists{/gist_id}","starred_url":"https://api.github.com/users/jclausen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jclausen/subscriptions","organizations_url":"https://api.github.com/users/jclausen/orgs","repos_url":"https://api.github.com/users/jclausen/repos","events_url":"https://api.github.com/users/jclausen/events{/privacy}","received_events_url":"https://api.github.com/users/jclausen/received_events","type":"User","site_admin":false},"created_at":"2020-05-06T22:07:15Z","updated_at":"2020-05-06T22:17:36Z","author_association":"NONE","body":"I'll chime in since this has been open since 2017 with no resolution and is a problematic and  unexpected behavior that differs from the expectation:  that source excludes would exclude only the _explicit_ exclusion keys in the document and **_not_** omit keys not explicitly requested for exclusion.  \r\n\r\nSeems like this should be a priority issue, as it requires consumers to code around behavior and minimizes the value of source exclusions in streamlining or redacting documents. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624928296","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-624928296","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":624928296,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDkyODI5Ng==","user":{"login":"simlu","id":1539747,"node_id":"MDQ6VXNlcjE1Mzk3NDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1539747?v=4","gravatar_id":"","url":"https://api.github.com/users/simlu","html_url":"https://github.com/simlu","followers_url":"https://api.github.com/users/simlu/followers","following_url":"https://api.github.com/users/simlu/following{/other_user}","gists_url":"https://api.github.com/users/simlu/gists{/gist_id}","starred_url":"https://api.github.com/users/simlu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simlu/subscriptions","organizations_url":"https://api.github.com/users/simlu/orgs","repos_url":"https://api.github.com/users/simlu/repos","events_url":"https://api.github.com/users/simlu/events{/privacy}","received_events_url":"https://api.github.com/users/simlu/received_events","type":"User","site_admin":false},"created_at":"2020-05-06T22:41:04Z","updated_at":"2020-05-06T22:41:04Z","author_association":"NONE","body":"@jclausen Very much agreed. We use our workaround at scale (millions of queries per day) and it works really well.\r\n\r\nHowever resolving this properly would allow us to remove quite a bit of hacky code.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/676421860","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-676421860","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":676421860,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NjQyMTg2MA==","user":{"login":"somdevmehta","id":29984211,"node_id":"MDQ6VXNlcjI5OTg0MjEx","avatar_url":"https://avatars2.githubusercontent.com/u/29984211?v=4","gravatar_id":"","url":"https://api.github.com/users/somdevmehta","html_url":"https://github.com/somdevmehta","followers_url":"https://api.github.com/users/somdevmehta/followers","following_url":"https://api.github.com/users/somdevmehta/following{/other_user}","gists_url":"https://api.github.com/users/somdevmehta/gists{/gist_id}","starred_url":"https://api.github.com/users/somdevmehta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somdevmehta/subscriptions","organizations_url":"https://api.github.com/users/somdevmehta/orgs","repos_url":"https://api.github.com/users/somdevmehta/repos","events_url":"https://api.github.com/users/somdevmehta/events{/privacy}","received_events_url":"https://api.github.com/users/somdevmehta/received_events","type":"User","site_admin":false},"created_at":"2020-08-19T14:10:44Z","updated_at":"2020-08-19T14:17:17Z","author_association":"NONE","body":"@javanna \r\n\r\nWhile **exclusions** seems to be fixed in version 7.9.0. I am wondering if there is a similar change planned for **inclusions** as well.\r\n\r\nConsider the following scenario.\r\n\r\n`POST /test/_doc/1\r\n{\r\n\"field\" : \"value\",\r\n\"array\": [],\r\n\"object\" : {}\r\n}\r\n\r\nPOST /test/_doc/2\r\n{\r\n\"field\" : \"value\",\r\n\"array\": [{ \"exclude\": \"bar\"}],\r\n\"object\": { \"exclude\": \"bar\" }\r\n}\r\n\r\nPOST /test/_doc/3\r\n{\r\n\"field\" : \"value\",\r\n\"array\": [{ \"exclude\": \"bar\"}, {\"include\" : \"bar\"}],\r\n\"object\": { \"exclude\": \"bar\", \"include\" : \"bar\" }\r\n}\r\n\r\nPOST /test/_search?pretty\r\n{\r\n\"_source\": {\"includes\": [\"name\",\"object.include\",\"array.include\"] }\r\n}\r\n\r\n{\r\n\"hits\": [\r\n{\r\n\"_index\": \"test\",\r\n\"_type\": \"_doc\",\r\n\"_id\": \"82HEBnQBxtHMu64O7lFB\",\r\n\"_score\": 1,\r\n\"_source\": {}\r\n},\r\n{\r\n\"_index\": \"test\",\r\n\"_type\": \"_doc\",\r\n\"_id\": \"9GHFBnQBxtHMu64OElFU\",\r\n\"_score\": 1,\r\n\"_source\": {}\r\n},\r\n{\r\n\"_index\": \"test\",\r\n\"_type\": \"_doc\",\r\n\"_id\": \"9WHFBnQBxtHMu64ONFGE\",\r\n\"_score\": 1,\r\n\"_source\": {\r\n\"array\": [\r\n{\r\n\"include\": \"bar\"\r\n}\r\n],\r\n\"object\": {\r\n\"include\": \"bar\"\r\n}\r\n}\r\n}\r\n]\r\n}`\r\n\r\nShouldn't the first 2 results include empty Arrays/Objects as well ? Not including them creates a bigger problem for nested scenario as shown below,\r\n\r\n`PUT /test1\r\n{\r\n\"mappings\": {\r\n\"properties\": {\r\n\"product\": { \"type\": \"text\" },\r\n\"Users\": {\r\n\"type\": \"nested\",\r\n\"properties\": {\r\n\"name\": { \"type\": \"text\" },\r\n\"Address\": {\r\n\"type\": \"nested\",\r\n\"properties\": {\r\n\"country\": { \"type\": \"text\" }\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n\r\nPOST /test1/_doc/1\r\n{\r\n\"product\": \"Laptop\",\r\n\"Users\": [\r\n{ \"name\": \"user1\", \"Address\": [{ \"country\": \"country1\" }] },\r\n{ \"name\": \"user2\", \"Address\": [] },\r\n{ \"name\": \"user3\", \"Address\": [{ \"country\": \"country2\" }] },\r\n{ \"name\": \"user4\", \"Address\": [{ \"country\": \"country3\" }] }\r\n]\r\n}\r\n\r\nPOST /test1/_doc/_search\r\n{\r\n\"query\": {\r\n\"nested\": {\r\n\"path\": \"Users.Address\",\r\n\"inner_hits\":{},\r\n\"query\": {\r\n\"match\" :{ \"Users.Address.country\": \"country2\"}\r\n}\r\n}\r\n},\r\n\"_source\": [\"Users.Address.country\"]\r\n}\r\n\r\n\"hits\": {\r\n\"total\": {\r\n\"value\": 1,\r\n\"relation\": \"eq\"\r\n},\r\n\"max_score\": 0.9808291,\r\n\"hits\": [\r\n{\r\n\"_index\": \"test1\",\r\n\"_type\": \"_doc\",\r\n\"_id\": \"1\",\r\n\"_score\": 0.9808291,\r\n\"_source\": {\r\n\"Users\": [\r\n{\r\n\"Address\": [\r\n{\r\n\"country\": \"country1\"\r\n}\r\n]\r\n},\r\n{\r\n\"Address\": [\r\n{\r\n\"country\": \"country2\"\r\n}\r\n]\r\n},\r\n{\r\n\"Address\": [\r\n{\r\n\"country\": \"country3\"\r\n}\r\n]\r\n}\r\n]\r\n},\r\n\"inner_hits\": {\r\n\"Users.Address\": {\r\n\"hits\": {\r\n\"total\": {\r\n\"value\": 1,\r\n\"relation\": \"eq\"\r\n},\r\n\"max_score\": 0.9808291,\r\n\"hits\": [\r\n{\r\n\"_index\": \"test1\",\r\n\"_type\": \"_doc\",\r\n\"_id\": \"1\",\r\n\"_nested\": {\r\n\"field\": \"Users\",\r\n\"offset\": 2,\r\n\"_nested\": {\r\n\"field\": \"Address\",\r\n\"offset\": 0\r\n}\r\n},\r\n\"_score\": 0.9808291,\r\n\"_source\": {\r\n\"country\": \"country2\"\r\n}\r\n}\r\n]\r\n}\r\n}\r\n}\r\n}\r\n]\r\n}`\r\n\r\nIn above response Innher_hits is giving Users[2].Address[0] as a match for condition country= \"country2\". However, in the _source object Users[2] appears at index 1 of Users Array. This creates reliability concerns for offset attribute. For elastic-search versions prior to 5.X, we used to get empty [] if no nested attribute was found and offsets could be reliably used to pull data from _source object.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/712709166","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-712709166","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":712709166,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMjcwOTE2Ng==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T09:09:17Z","updated_at":"2020-10-20T09:09:17Z","author_association":"MEMBER","body":"heya @somdevmehta sorry it took me so long to reply to your comment. I did some digging on this, and I think with inclusions you can have empty arrays preserved by including them explicitly. In your example you would do `\"_source\": {\"includes\": [\"name\",\"object\",\"object.include\",\"array\",\"array.include\"] }`. The point is that when including, only what you explicitly included will be added to the response. For exclusions it is a bit different as you are excluding and expect all the rest to stay, while before my fix we would remove arrays and objects when they were left empty.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/712719090","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-712719090","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":712719090,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMjcxOTA5MA==","user":{"login":"somdevmehta","id":29984211,"node_id":"MDQ6VXNlcjI5OTg0MjEx","avatar_url":"https://avatars2.githubusercontent.com/u/29984211?v=4","gravatar_id":"","url":"https://api.github.com/users/somdevmehta","html_url":"https://github.com/somdevmehta","followers_url":"https://api.github.com/users/somdevmehta/followers","following_url":"https://api.github.com/users/somdevmehta/following{/other_user}","gists_url":"https://api.github.com/users/somdevmehta/gists{/gist_id}","starred_url":"https://api.github.com/users/somdevmehta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somdevmehta/subscriptions","organizations_url":"https://api.github.com/users/somdevmehta/orgs","repos_url":"https://api.github.com/users/somdevmehta/repos","events_url":"https://api.github.com/users/somdevmehta/events{/privacy}","received_events_url":"https://api.github.com/users/somdevmehta/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T09:25:55Z","updated_at":"2020-10-20T09:25:55Z","author_association":"NONE","body":"Hey @javanna , Thanks for your reply. The problem I see while including the parent attribute (\"array\" in above case) in _source is that it will cause a lot of unnecessary attributes to appear in response. In my example, assuming that every array element is a JSONObject with 50 + attributes each, then all of these will be returned in the response, even though only 1 or 2 are actually needed. Also, such workaround was not required for versions before 5.X.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/712725155","html_url":"https://github.com/elastic/elasticsearch/issues/23796#issuecomment-712725155","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","id":712725155,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMjcyNTE1NQ==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T09:36:09Z","updated_at":"2020-10-20T09:36:09Z","author_association":"MEMBER","body":"you are right thanks for the feedback @somdevmehta would you mind opening a new issue to track this please?","performed_via_github_app":null}]