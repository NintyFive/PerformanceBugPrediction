{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21685","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21685/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21685/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21685/events","html_url":"https://github.com/elastic/elasticsearch/issues/21685","id":190558434,"node_id":"MDU6SXNzdWUxOTA1NTg0MzQ=","number":21685,"title":"Sort by nested string field yields unexpected results","user":{"login":"orweinberger","id":1876045,"node_id":"MDQ6VXNlcjE4NzYwNDU=","avatar_url":"https://avatars3.githubusercontent.com/u/1876045?v=4","gravatar_id":"","url":"https://api.github.com/users/orweinberger","html_url":"https://github.com/orweinberger","followers_url":"https://api.github.com/users/orweinberger/followers","following_url":"https://api.github.com/users/orweinberger/following{/other_user}","gists_url":"https://api.github.com/users/orweinberger/gists{/gist_id}","starred_url":"https://api.github.com/users/orweinberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orweinberger/subscriptions","organizations_url":"https://api.github.com/users/orweinberger/orgs","repos_url":"https://api.github.com/users/orweinberger/repos","events_url":"https://api.github.com/users/orweinberger/events{/privacy}","received_events_url":"https://api.github.com/users/orweinberger/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-11-20T13:33:14Z","updated_at":"2018-02-14T13:26:45Z","closed_at":"2016-11-21T12:29:05Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:2.4.1\r\n\r\n**JVM version**: 1.8.0\r\n\r\n**OS version**: Ubuntu 14.04\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen sorting on nested string fields, we get a `null` sorting value and results are unsorted.\r\n\r\n**Steps to reproduce**:\r\n 1. Set the mapping for the index with a nested string field:\r\n\r\n```\r\n\"normalized\": {\r\n  \"type\": \"nested\",\r\n  \"properties\": {\r\n    \"timestamp\": {\r\n    \"index\": \"not_analyzed\",\r\n    \"type\": \"string\"\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Insert a few documents and run the following query:\r\n\r\n```\r\n\"sort\": {\r\n    \"normalized.timestamp\": {\r\n      \"order\": \"desc\"\r\n    }\r\n}\r\n````\r\n 3. Notice the `sort` key in the results returning as `null`\r\n\r\n**Notes**:\r\n\r\nIt's important to note that although the field name is `timestamp` it contains a string, however to my understanding, range queries and sorting should still work, my timestamp format is: `2016-11-20T12:57:27.493000Z`\r\n\r\nWhen I run the same query in v1.7.4 results are returned correctly, also, looking at the documentation it looks like I might need to change the sort to:\r\n\r\n```\r\n  \"sort\": [\r\n    {\r\n      \"normalized.timestamp\": {\r\n        \"order\": \"desc\",\r\n        \"nested_filter\": {\r\n          \"range\": {\r\n            \"normalized.timestamp\": {\r\n              \"gte\": \"2016-11-20T00:00:00\",\r\n              \"lte\": \"2016-11-20T23:59:59\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n```\r\n\r\nHowever, running this in v2.4.1 also yields a `null` for the sort key and results are returned unsorted.\r\nI went through the breaking changes between 1.x and 2.x and couldn't find any mention to something that may interfere with the above search. Another thing I tried and **did** work was using `inner_hits` but this looks like a bit of a workaround and I would much prefer just using sort in the top level DSL.","closed_by":{"login":"orweinberger","id":1876045,"node_id":"MDQ6VXNlcjE4NzYwNDU=","avatar_url":"https://avatars3.githubusercontent.com/u/1876045?v=4","gravatar_id":"","url":"https://api.github.com/users/orweinberger","html_url":"https://github.com/orweinberger","followers_url":"https://api.github.com/users/orweinberger/followers","following_url":"https://api.github.com/users/orweinberger/following{/other_user}","gists_url":"https://api.github.com/users/orweinberger/gists{/gist_id}","starred_url":"https://api.github.com/users/orweinberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orweinberger/subscriptions","organizations_url":"https://api.github.com/users/orweinberger/orgs","repos_url":"https://api.github.com/users/orweinberger/repos","events_url":"https://api.github.com/users/orweinberger/events{/privacy}","received_events_url":"https://api.github.com/users/orweinberger/received_events","type":"User","site_admin":false},"performed_via_github_app":null}