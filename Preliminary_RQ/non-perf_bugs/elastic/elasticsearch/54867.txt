{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54867","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54867/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54867/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54867/events","html_url":"https://github.com/elastic/elasticsearch/issues/54867","id":595708340,"node_id":"MDU6SXNzdWU1OTU3MDgzNDA=","number":54867,"title":"TLS certs may not be picked up if updated at ES startup","user":{"login":"sebgl","id":1050393,"node_id":"MDQ6VXNlcjEwNTAzOTM=","avatar_url":"https://avatars1.githubusercontent.com/u/1050393?v=4","gravatar_id":"","url":"https://api.github.com/users/sebgl","html_url":"https://github.com/sebgl","followers_url":"https://api.github.com/users/sebgl/followers","following_url":"https://api.github.com/users/sebgl/following{/other_user}","gists_url":"https://api.github.com/users/sebgl/gists{/gist_id}","starred_url":"https://api.github.com/users/sebgl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebgl/subscriptions","organizations_url":"https://api.github.com/users/sebgl/orgs","repos_url":"https://api.github.com/users/sebgl/repos","events_url":"https://api.github.com/users/sebgl/events{/privacy}","received_events_url":"https://api.github.com/users/sebgl/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"assignees":[{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-04-07T08:59:31Z","updated_at":"2020-04-16T16:47:36Z","closed_at":"2020-04-16T16:47:36Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: any (observed with 6.8.5 and 7.6.1)\r\n\r\nI think we spotted a bug where TLS transport certificates are not picked up by Elasticsearch, if they are updated on disk around the same time Elasticsearch starts. See [this issue in ECK repository](https://github.com/elastic/cloud-on-k8s/issues/2823).\r\n\r\nIt's not easy to reproduce, but we observed it happening several time across multiple rolling upgrade scenarios. The following seems to be happening:\r\n\r\n* ES is running, and configured to use a transport TLS certificate file on disk. Any modification on this file is correctly picked up.\r\n* We trigger a rolling upgrade on the cluster. When a node is restarted, it may restart with a different IP address (we're running in Kubernetes). As a result, ECK generates a new certificate to match the new IP address, and replaces the existing one on disk.\r\n* In case we're not lucky, this happens when Elasticsearch (re)starts:\r\n    * It picks the existing certificates on disk: the old ones with the old IP address, that has not been replaced yet\r\n    * At that point the certificate file is updated\r\n    * Elasticsearch starts monitoring the filesystem for any change on certificates file. We missed the certificate update here, and still serve the old certificate that does not exist on the disk anymore. The new cert on disk does not get picked up until it gets modified again.\r\n\r\nI can imagine this is unlikely to happen since most people won't manipulate TLS certificates while Elasticsearch is still starting. However this is what happens in ECK, since we cannot know the node IP address until the Pod is created, at which point Elasticsearch is starting already.\r\n\r\nMore generally, as a user, I would expect Elasticsearch to pick up my TLS certificate file, whether I create/update them before Elasticsearch starts, during the startup, or after Elasticsearch is started. Having a small time window where this is not the case feels like a bug?\r\n\r\nA quick chat with @ywangd confirmed, from reading the code, that there's a time window between loading certificates and watching for changes where any update is not accounted for.","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}