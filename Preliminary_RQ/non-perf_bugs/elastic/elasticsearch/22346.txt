{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22346","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22346/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22346/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22346/events","html_url":"https://github.com/elastic/elasticsearch/issues/22346","id":197517433,"node_id":"MDU6SXNzdWUxOTc1MTc0MzM=","number":22346,"title":"Highlight issue using Simple Query Search with \"term_vector\":\"with_positions_offsets\" option along with language analyzer","user":{"login":"evertramos","id":905951,"node_id":"MDQ6VXNlcjkwNTk1MQ==","avatar_url":"https://avatars1.githubusercontent.com/u/905951?v=4","gravatar_id":"","url":"https://api.github.com/users/evertramos","html_url":"https://github.com/evertramos","followers_url":"https://api.github.com/users/evertramos/followers","following_url":"https://api.github.com/users/evertramos/following{/other_user}","gists_url":"https://api.github.com/users/evertramos/gists{/gist_id}","starred_url":"https://api.github.com/users/evertramos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/evertramos/subscriptions","organizations_url":"https://api.github.com/users/evertramos/orgs","repos_url":"https://api.github.com/users/evertramos/repos","events_url":"https://api.github.com/users/evertramos/events{/privacy}","received_events_url":"https://api.github.com/users/evertramos/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2016-12-25T22:33:59Z","updated_at":"2017-05-08T16:21:10Z","closed_at":"2016-12-26T10:06:20Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1\r\n\r\n**Plugins installed**: [ingest-attachment]\r\n\r\n**JVM version**: OpenJDK version \"1.8.0_102\"\r\n\r\n**OS version**: boot2docker and Ubuntu 14.0 (docker version of elasticsearch 5.0 container)\r\n\r\n**Description of the problem including expected versus actual behavior**: When indexing a content (pdf file content) we expected to have, under the _simple_query_search_, using double quote (\"searched phrase\"), the results highlighted as it does with regular search. But if we use as is recommended in ES docs of [Highlighting attachments](https://www.elastic.co/guide/en/elasticsearch/plugins/5.1/mapper-attachments-highlighting.html) the option **\"term_vector\":\"with_positions_offsets\"** along with an analyzer, I tested **english** and **brazilian**, the highlight does not show up under the query search, using the simple query search with double quotes, if you have any **stopword** in your search string.\r\n\r\nResume...\r\n\r\nif you have any stop word in your search, the highlight simply does not show up in your results! if you use **\"term_vector\":\"with_positions_offsets\"** along with an analyzer (**english** and **brazilian** tested).\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create an Index:\r\n```\r\nPUT 127.0.0.1:9200/my_index\r\n{\r\n  \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 1\r\n        }\r\n    },\r\n    \"mappings\" : {\r\n        \"my_type\" : {\r\n          \"_source\" : {\r\n            \"enabled\" : true\r\n        },\r\n            \"properties\" : {\r\n                \"name\" : { \r\n                  \"type\" : \"string\",\r\n                  \"store\" : true\r\n              },\r\n                \"attachment.content\" : { \r\n                  \"type\" : \"text\",\r\n                  \"analyzer\" : \"english\",\r\n                  \"term_vector\" : \"with_positions_offsets\",\r\n                  \"store\" : true\r\n              }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n 2. Create a pipeline:\r\n```\r\nPUT 127.0.0.1:9200/_ingest/pipeline/attachment\r\n{\r\n  \"description\" : \"Extract attachment information\",\r\n  \"processors\" : [\r\n    {\r\n      \"attachment\" : {\r\n        \"field\" : \"content\",\r\n        \"indexed_chars\" : -1\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n 3. Index something:\r\n```\r\nPUT 127.0.0.1:9200/my_index/my_type/1?pipeline=attachment\r\n{\r\n  \"name\" : \"The english team\"\r\n  \"content\" : \"V2UgYXJlIHRoZSBlbmdsaXNoIHRlYW0=\"\r\n}\r\n```\r\n\r\n4. Do the search with **simple_query_string** as of the [official docs sample](https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-simple-query-string-query.html#_simple_query_string_syntax), using quotes:\r\n```\r\nGET 127.0.0.1:9200/my_index/_search?pretty=true\r\n{\r\n    \"stored_fields\" : [\"name\"],\r\n    \"size\" : 15,\r\n\t\"query\" : {\r\n        \"simple_query_string\" : {\r\n            \"query\" : \"\\\"we are the english team\\\"\",\r\n            \"fields\" : [\"attachment.content\"],\r\n            \"default_operator\" : \"and\"\r\n        }\r\n\t},\r\n\t\r\n\t\"highlight\" : {\r\n\t    \"number_of_fragments\" : 3,\r\n\t    \"fragment_size\" : 50,\r\n\t    \"fields\" : {\r\n\t\t\t\"attachment.content\" : {\r\n\t\t\t    \"highlight_query\" : {\r\n\t\t\t        \"simple_query_string\" : {\r\n\t\t\t            \"query\" : \"\\\"we are the english team\\\"\",\r\n\t\t\t            \"fields\" : [\"attachment.content\"],\r\n\t\t\t            \"default_operator\" : \"and\"\r\n\t\t\t        }\r\n\t\t\t    }\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nSo,\r\n\r\ni. if you take of the stop words from the search as of searching only for \"english team\" it will bring the highlight;\r\n\r\nii. if you remove the analyzer from your mapping, it will bring the highlight, but I believe analyzer are very important, at least for our project today, which is in Portuguese;\r\n\r\niii. last thing if you remove the term vector option **\"term_vector\":\"with_positions_offsets\"** it also works... but it becomes very, very slow, so, not possible to use this way.\r\n\r\nPlease if this is not an issue, forgive taking your time, but it took over weeks trying to solve this and tested everything I could to solve it, even using \"query_string\" to substitute simple query, which did not work, and simple query options are so great that I believe could not be substituted.\r\n\r\nThanks!\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}