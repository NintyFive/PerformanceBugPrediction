{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5048","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5048/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5048/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5048/events","html_url":"https://github.com/elastic/elasticsearch/issues/5048","id":27138629,"node_id":"MDU6SXNzdWUyNzEzODYyOQ==","number":5048,"title":"aggregation error ArrayIndexOutOfBoundsException","user":{"login":"j0hnsmith","id":118963,"node_id":"MDQ6VXNlcjExODk2Mw==","avatar_url":"https://avatars1.githubusercontent.com/u/118963?v=4","gravatar_id":"","url":"https://api.github.com/users/j0hnsmith","html_url":"https://github.com/j0hnsmith","followers_url":"https://api.github.com/users/j0hnsmith/followers","following_url":"https://api.github.com/users/j0hnsmith/following{/other_user}","gists_url":"https://api.github.com/users/j0hnsmith/gists{/gist_id}","starred_url":"https://api.github.com/users/j0hnsmith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j0hnsmith/subscriptions","organizations_url":"https://api.github.com/users/j0hnsmith/orgs","repos_url":"https://api.github.com/users/j0hnsmith/repos","events_url":"https://api.github.com/users/j0hnsmith/events{/privacy}","received_events_url":"https://api.github.com/users/j0hnsmith/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":82340516,"node_id":"MDU6TGFiZWw4MjM0MDUxNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.2","name":"v1.0.2","color":"dddddd","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2014-02-07T14:38:28Z","updated_at":"2014-07-17T11:11:36Z","closed_at":"2014-03-04T08:58:09Z","author_association":"NONE","active_lock_reason":null,"body":"mapping extract\n\n```\n                \"extension\": {\n                    \"type\": \"string\", // eg .xls, no empty fields\n                    \"index\": \"not_analyzed\",\n                },\n                \"sharepath\": {\n                    \"type\": \"string\", // eg //1.2.3.4/Someshare/, no empty fields\n                    \"index\": \"not_analyzed\",\n                },\n                \"doc_type\": {\n                    \"type\": \"string\", // eg Spreadsheet Files, no empty fields\n                    \"index\": \"not_analyzed\"\n                },\n```\n\nquery works\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"and\": [\n          {\n            \"range\": {\n              \"modified\": {\n                \"lt\": 1391775892000\n              }\n            }\n          }\n        ]\n      },\n      \"query\": {\n        \"match_all\": {}\n      }\n    }\n  },\n  \"aggs\": {\n    \"sharepath\": {\n      \"terms\": {\n        \"field\": \"sharepath\",\n        \"size\": 2147483647\n      },\n      \"aggs\": {\n        \"total_size_sharepath\": {\n          \"filter\": {\n              \"term\": {\n                  \"doc_type\": \"Spreadsheet Files\"\n              }\n          },\n          \"aggs\": {\n            \"total_size\": {\n              \"stats\": {\n                \"field\": \"size\"\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n```\n\nquery fails (more or less same query as before)\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"and\": [\n          {\n            \"range\": {\n              \"modified\": {\n                \"lt\": 1391775892000\n              }\n            }\n          }\n        ]\n      },\n      \"query\": {\n        \"match_all\": {}\n      }\n    }\n  },\n  \"aggs\": {\n    \"extension\": {\n      \"terms\": {\n        \"field\": \"extension\",  // previously 'sharepath' which works\n        \"size\": 2147483647\n      },\n      \"aggs\": {\n        \"total_size_extension\": {\n          \"filter\": {\n            \"term\": {\n              \"doc_type\": \"Spreadsheet Files\"\n            }\n          },\n          \"aggs\": {\n            \"total_size\": {\n              \"stats\": {\n                \"field\": \"size\"\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n```\n\nStacktrace\n\n```\n[2014-02-07 14:07:35,301][DEBUG][action.search.type       ] [Copycat] [files_v1][3], node[XlVxAUsKRNinZGxwgkLyeg], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@71c8e67c]\njava.lang.ArrayIndexOutOfBoundsException: 51\n  at org.elasticsearch.common.util.BigArrays$LongArrayWrapper.get(BigArrays.java:118)\n  at org.elasticsearch.search.aggregations.bucket.BucketsAggregator.bucketDocCount(BucketsAggregator.java:79)\n  at org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator.buildAggregation(FilterAggregator.java:73)\n  at org.elasticsearch.search.aggregations.bucket.BucketsAggregator.bucketAggregations(BucketsAggregator.java:88)\n  at org.elasticsearch.search.aggregations.bucket.terms.StringTermsAggregator.buildAggregation(StringTermsAggregator.java:121)\n  at org.elasticsearch.search.aggregations.bucket.terms.StringTermsAggregator.buildAggregation(StringTermsAggregator.java:41)\n  at org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:132)\n  at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:137)\n  at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:230)\n  at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:202)\n  at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n  at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:216)\n  at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:203)\n  at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:186)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1146)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n  at java.lang.Thread.run(Thread.java:701)\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}