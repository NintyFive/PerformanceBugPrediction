[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146206265","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146206265","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146206265,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjIwNjI2NQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T14:10:40Z","updated_at":"2015-10-07T14:10:40Z","author_association":"CONTRIBUTOR","body":"Is it ever legal to pass a metadata field (_id,_version, _ttl etc) in the body of a doc? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146256809","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146256809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146256809,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI1NjgwOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T16:38:42Z","updated_at":"2015-10-07T16:38:42Z","author_association":"CONTRIBUTOR","body":"No, not any more.  \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146258585","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146258585","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146258585,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI1ODU4NQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T16:45:32Z","updated_at":"2015-10-07T16:45:32Z","author_association":"CONTRIBUTOR","body":"OK. Trying out a patch that checks MapperService.isMetadataField() for legal fieldnames in the doc body. Anything else we need to tighten up in naming?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146263431","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146263431","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146263431,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI2MzQzMQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T17:04:23Z","updated_at":"2015-10-07T17:04:23Z","author_association":"CONTRIBUTOR","body":"I added a simple check in DocumentParser:\n\n```\nif (MapperService.isMetadataField(currentFieldName)) {\n    throw new MapperParsingException(\"Reserved field name [\" + currentFieldName + \"] passed in document body\");\n}\n```\n\nThe tests that failed were mainly \"testIncludeInObjectBackcompat\".\n- org.elasticsearch.index.mapper.ttl.TTLMappingTests.testIncludeInObjectBackcompat\n- org.elasticsearch.index.mapper.parent.ParentMappingTests.testParentNotSet\n- org.elasticsearch.index.mapper.parent.ParentMappingTests.testParentSetInDocBackcompat\n- org.elasticsearch.index.mapper.all.SimpleAllMapperTests.testIncludeInObjectBackcompat\n- org.elasticsearch.index.mapper.routing.RoutingTypeMapperTests.testIncludeInObjectBackcompat\n- org.elasticsearch.index.mapper.timestamp.TimestampMappingTests.testIncludeInObjectBackcompat\n- org.elasticsearch.index.mapper.id.IdMappingTests.testIncludeInObjectBackcompat\n\nThey look to check metadata-fields-in-the-body are safely ignored i.e have a comment like this:\n\n```\n        // _routing in a document never worked, so backcompat is ignoring the field\n```\n\nSo do we break backcompat and now no longer tolerate these metadata fields by throwing exceptions?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146273624","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146273624","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146273624,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI3MzYyNA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T17:42:02Z","updated_at":"2015-10-07T17:42:02Z","author_association":"MEMBER","body":"@markharwood No, we should not break backcompat. Here is the original PR that was supposed to block this: #11074. Prior to that PR, each meta field could override `includeInObject()` to return `true`, which would cause the mapper for that meta field to be added to the rest of the mappers for document types. Thus when encountering the field while parsing the document, it would find the metadata mapper, and parse. There was also logic inside the metadata mapper that allowed this parsing.\n\nFor backcompat, I kept the parsing logic in metadata mappers that supported it before. This can be removed in master, as well as the backcompat check to add select metadata fields to the regular mappers.  What must be happening here is the metadata mappers are still getting added to the regular mappers map. This shouldn't be happening on a new index. I'm still investigating why that is happening...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146274945","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146274945","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146274945,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI3NDk0NQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T17:46:28Z","updated_at":"2015-10-07T17:46:28Z","author_association":"MEMBER","body":"One thing I notice is we should have an extra check similar to what you propose (but the impl of isMetadataField needs to be updated, because the list of metadata fields should no longer be static, because they can be added by plugins, as _size is now a plugin). So we should add your check, but guard with a backcompat check.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146275157","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146275157","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146275157,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI3NTE1Nw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T17:47:27Z","updated_at":"2015-10-07T17:47:27Z","author_association":"MEMBER","body":"This will block the action earlier, since right now, from the \"good\" case in Clint's example, you can see the field was actually parsed and it is trying to add the field to the mappings. This is too late.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146276519","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146276519","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146276519,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjI3NjUxOQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T17:52:39Z","updated_at":"2015-10-07T17:52:39Z","author_association":"MEMBER","body":"Note that fixing `isMetadataField` will require a little plumbing. This should not be a static method, which means passing down the metadata fields list when creating `GetResult`, and then doing the check before creating `GetField` (so get field should have a flag, instead of the current `isMetadataField()` which calls the static `MapperService` method.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146304112","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146304112","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146304112,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjMwNDExMg==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-10-07T19:32:40Z","updated_at":"2015-10-07T19:32:40Z","author_association":"MEMBER","body":"I have a change I'm testing that is minimally invasive for backport to 2.0. I will make a followup to cleanup `isMetadataField` to work with metadata fields added by plugins, but that requires a larger change to how metadata fields are added.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/146474834","html_url":"https://github.com/elastic/elasticsearch/issues/13740#issuecomment-146474834","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13740","id":146474834,"node_id":"MDEyOklzc3VlQ29tbWVudDE0NjQ3NDgzNA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-10-08T09:41:50Z","updated_at":"2015-10-08T09:41:50Z","author_association":"CONTRIBUTOR","body":"Closed by #14003\n","performed_via_github_app":null}]