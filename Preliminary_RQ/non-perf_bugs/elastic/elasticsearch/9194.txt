{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9194","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9194/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9194/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9194/events","html_url":"https://github.com/elastic/elasticsearch/issues/9194","id":53730172,"node_id":"MDU6SXNzdWU1MzczMDE3Mg==","number":9194,"title":"Succes of nested query depends on unrelated data field","user":{"login":"ewrdk","id":5536716,"node_id":"MDQ6VXNlcjU1MzY3MTY=","avatar_url":"https://avatars0.githubusercontent.com/u/5536716?v=4","gravatar_id":"","url":"https://api.github.com/users/ewrdk","html_url":"https://github.com/ewrdk","followers_url":"https://api.github.com/users/ewrdk/followers","following_url":"https://api.github.com/users/ewrdk/following{/other_user}","gists_url":"https://api.github.com/users/ewrdk/gists{/gist_id}","starred_url":"https://api.github.com/users/ewrdk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ewrdk/subscriptions","organizations_url":"https://api.github.com/users/ewrdk/orgs","repos_url":"https://api.github.com/users/ewrdk/repos","events_url":"https://api.github.com/users/ewrdk/events{/privacy}","received_events_url":"https://api.github.com/users/ewrdk/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2015-01-08T09:27:40Z","updated_at":"2015-01-08T13:02:41Z","closed_at":"2015-01-08T11:18:37Z","author_association":"NONE","active_lock_reason":null,"body":"# Description of problem\n\nWe have encountered a very weird problem: We create an index with a mapping containing nested structures. We then make a query using a range on validFrom and validTo dates. This works in the example below (ie. we get a result). When we add a single field (named \"dataAdgang\") both to the mapping and the data then the query no longer works (an empty result is returned). Reproduced using version 1.4.2.\n\nWorking example:\n`curl -XPOST --data @mapping-nested-works.json localhost:9200/nestedworks`\n`curl -XPOST --data @4000800895-nested-works.json localhost:9200/nestedworks/virksomhed/1`\n`curl -XGET --data @nested-query.json http://localhost:9200/nestedworks/_search?pretty`\n\nExample that is not working:\n`curl -XPOST --data @mapping-nested-notworking.json localhost:9200/nestednotworking`\n`curl -XPOST --data @4000800895-nested-notworking.json localhost:9200/nestednotworking/virksomhed/1`\n`curl -XGET --data @nested-query.json http://localhost:9200/nestednotworking/_search?pretty`\n# Content of the files\n\nnested-query.json:\n`{\"filter\":{\"nested\":{\"path\":\"virksomhed.Vrvirksomhed.virksomhedsstatus\",\"query\":{\"bool\":{\"must\":[{\"range\":{\"gyldigFra\":{\"lt\":\"2011-08-20\"}}},{\"range\":{\"gyldigTil\":{\"gt\":\"2011-08-20\"}}}]}}}}}`\n\nmapping-nested-works.json:\n`{\n    \"mappings\" : {\n      \"virksomhed\" : {\n        \"properties\" : {\n          \"Vrvirksomhed\" : {\n            \"properties\" : {\n              \"cvrNummer\" : {\n                \"type\" : \"string\"\n              },\n              \"enhedsNummer\" : {\n                \"type\" : \"long\"\n              },\n              \"enhedstype\" : {\n                \"type\" : \"string\"\n              },\n              \"fejlRegistreret\" : {\n                \"type\" : \"boolean\"\n              },\n              \"fejlVedIndlaesning\" : {\n                \"type\" : \"boolean\"\n              },\n              \"harFremtidigAendring\" : {\n                \"type\" : \"boolean\"\n              },\n              \"livsforloeb\" : {\n                \"type\" : \"nested\",\n                \"properties\" : {\n                      \"gyldigFra\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                      \"gyldigTil\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                  \"sidstOpdateret\" : {\n                    \"type\" : \"date\",\n                    \"format\" : \"dateOptionalTime\"\n                  }\n                }\n              },\n              \"samtId\" : {\n                \"type\" : \"long\"\n              },\n              \"sidstIndlaest\" : {\n                \"type\" : \"date\",\n                \"format\" : \"dateOptionalTime\"\n              },\n              \"sidstOpdateret\" : {\n                \"type\" : \"date\",\n                \"format\" : \"dateOptionalTime\"\n              },\n              \"virksomhedsstatus\" : {\n                \"type\" : \"nested\",\n                \"properties\" : {\n                      \"gyldigFra\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                      \"gyldigTil\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                  \"sidstOpdateret\" : {\n                    \"type\" : \"date\",\n                    \"format\" : \"dateOptionalTime\"\n                  },\n                  \"status\" : {\n                    \"type\" : \"string\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n}\n`\n\n4000800895-nested-works.json:\n`{\"Vrvirksomhed\":{\"cvrNummer\":10237513,\"livsforloeb\":[{\"gyldigFra\":\"1972-12-19\",\"gyldigTil\":\"2002-12-18\",\"sidstOpdateret\":\"1999-10-16T19:49:47.000+02:00\"}],\"virksomhedsstatus\":[{\"status\":\"NORMAL\",\"gyldigFra\":\"1972-12-19\",\"gyldigTil\":\"1991-11-07\",\"sidstOpdateret\":\"2014-09-24T00:00:00.000+02:00\"},{\"status\":\"NORMAL\",\"gyldigFra\":\"2011-08-19\",\"gyldigTil\":\"2011-09-01\",\"sidstOpdateret\":\"2014-09-24T00:00:00.000+02:00\"}],\"samtId\":2,\"enhedsNummer\":4000800895,\"enhedstype\":\"VIRKSOMHED\",\"sidstIndlaest\":\"2015-01-05T14:44:58.582+01:00\",\"sidstOpdateret\":\"2014-11-03T00:00:00.000+01:00\",\"fejlRegistreret\":false,\"fejlVedIndlaesning\":false,\"harFremtidigAendring\":false}}`\n\nmapping-nested-notworking.json:\n`{\n    \"mappings\" : {\n      \"virksomhed\" : {\n        \"properties\" : {\n          \"Vrvirksomhed\" : {\n            \"properties\" : {\n              \"cvrNummer\" : {\n                \"type\" : \"string\"\n              },\n              \"dataAdgang\" : {\n                \"type\" : \"long\"\n              },\n              \"enhedsNummer\" : {\n                \"type\" : \"long\"\n              },\n              \"enhedstype\" : {\n                \"type\" : \"string\"\n              },\n              \"fejlRegistreret\" : {\n                \"type\" : \"boolean\"\n              },\n              \"fejlVedIndlaesning\" : {\n                \"type\" : \"boolean\"\n              },\n              \"harFremtidigAendring\" : {\n                \"type\" : \"boolean\"\n              },\n              \"livsforloeb\" : {\n                \"type\" : \"nested\",\n                \"properties\" : {\n                      \"gyldigFra\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                      \"gyldigTil\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                  \"sidstOpdateret\" : {\n                    \"type\" : \"date\",\n                    \"format\" : \"dateOptionalTime\"\n                  }\n                }\n              },\n              \"samtId\" : {\n                \"type\" : \"long\"\n              },\n              \"sidstIndlaest\" : {\n                \"type\" : \"date\",\n                \"format\" : \"dateOptionalTime\"\n              },\n              \"sidstOpdateret\" : {\n                \"type\" : \"date\",\n                \"format\" : \"dateOptionalTime\"\n              },\n              \"virksomhedsstatus\" : {\n                \"type\" : \"nested\",\n                \"properties\" : {\n                      \"gyldigFra\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                      \"gyldigTil\" : {\n                        \"type\" : \"date\",\n                        \"format\" : \"dateOptionalTime\"\n                      },\n                  \"sidstOpdateret\" : {\n                    \"type\" : \"date\",\n                    \"format\" : \"dateOptionalTime\"\n                  },\n                  \"status\" : {\n                    \"type\" : \"string\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n}\n`\n\n4000800895-nested-notworking.json:\n`{\"Vrvirksomhed\":{\"cvrNummer\":10237513,\"livsforloeb\":[{\"gyldigFra\":\"1972-12-19\",\"gyldigTil\":\"2002-12-18\",\"sidstOpdateret\":\"1999-10-16T19:49:47.000+02:00\"}],\"virksomhedsstatus\":[{\"status\":\"NORMAL\",\"gyldigFra\":\"1972-12-19\",\"gyldigTil\":\"1991-11-07\",\"sidstOpdateret\":\"2014-09-24T00:00:00.000+02:00\"},{\"status\":\"NORMAL\",\"gyldigFra\":\"2011-08-19\",\"gyldigTil\":\"2011-09-01\",\"sidstOpdateret\":\"2014-09-24T00:00:00.000+02:00\"}],\"samtId\":2,\"dataAdgang\":0,\"enhedsNummer\":4000800895,\"enhedstype\":\"VIRKSOMHED\",\"sidstIndlaest\":\"2015-01-05T14:44:58.582+01:00\",\"sidstOpdateret\":\"2014-11-03T00:00:00.000+01:00\",\"fejlRegistreret\":false,\"fejlVedIndlaesning\":false,\"harFremtidigAendring\":false}}`\n","closed_by":{"login":"ewrdk","id":5536716,"node_id":"MDQ6VXNlcjU1MzY3MTY=","avatar_url":"https://avatars0.githubusercontent.com/u/5536716?v=4","gravatar_id":"","url":"https://api.github.com/users/ewrdk","html_url":"https://github.com/ewrdk","followers_url":"https://api.github.com/users/ewrdk/followers","following_url":"https://api.github.com/users/ewrdk/following{/other_user}","gists_url":"https://api.github.com/users/ewrdk/gists{/gist_id}","starred_url":"https://api.github.com/users/ewrdk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ewrdk/subscriptions","organizations_url":"https://api.github.com/users/ewrdk/orgs","repos_url":"https://api.github.com/users/ewrdk/repos","events_url":"https://api.github.com/users/ewrdk/events{/privacy}","received_events_url":"https://api.github.com/users/ewrdk/received_events","type":"User","site_admin":false},"performed_via_github_app":null}