{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020/events","html_url":"https://github.com/elastic/elasticsearch/issues/25020","id":233108326,"node_id":"MDU6SXNzdWUyMzMxMDgzMjY=","number":25020,"title":"NullPointerException in Scripted metric aggregation reduce script when used within terms and filter aggs","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-06-02T08:12:23Z","updated_at":"2017-06-02T10:02:07Z","closed_at":"2017-06-02T10:02:07Z","author_association":"MEMBER","active_lock_reason":null,"body":"This bug was first raised in this forum topic: https://discuss.elastic.co/t/elasticsearch-5-3-scripted-metric-reduce-script-running-twice/87784\r\n\r\nTo reproduce this start a fresh cluster and running the following (note this script will delete any existing index named `test`):\r\n```\r\n\r\n\r\nGET test/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"a\": {\r\n      \"terms\": {\r\n        \"field\": \"id\",\r\n        \"size\": 10\r\n      },\r\n      \"aggs\": {\r\n        \"measure\" : {\r\n          \"filter\" : {\r\n            \"bool\" : {\r\n              \"must\" : [\r\n                {\r\n                  \"terms\" : {\r\n                    \"foo.bar\" : [\r\n                      \"foo\"\r\n                    ],\r\n                    \"boost\" : 1.0\r\n                  }\r\n                },\r\n                {\r\n                  \"terms\" : {\r\n                    \"foo.baz\" : [\r\n                      \"bar\"\r\n                    ],\r\n                    \"boost\" : 1.0\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"aggregations\" : {\r\n           \"profit\": {\r\n      \"scripted_metric\": {\r\n                \"init_script\" : \"params._agg.transactions = []\",\r\n                \"map_script\" : \"params._agg.transactions.add(1)\", \r\n                \"combine_script\" : \"double profit = 0; for (t in params._agg.transactions) { profit += t } return profit\",\r\n                \"reduce_script\" : \"double profit = 0; for (a in params._aggs) { profit += a } return profit\"\r\n            }\r\n    }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe search request will fail with:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"\",\r\n    \"phase\": \"fetch\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [],\r\n    \"caused_by\": {\r\n      \"type\": \"script_exception\",\r\n      \"reason\": \"runtime error\",\r\n      \"script_stack\": [\r\n        \"profit += a } \",\r\n        \"^---- HERE\"\r\n      ],\r\n      \"script\": \"double profit = 0; for (a in params._aggs) { profit += a } return profit\",\r\n      \"lang\": \"painless\",\r\n      \"caused_by\": {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    }\r\n  },\r\n  \"status\": 503\r\n}\r\n```\r\nWhich is weird because `profit` should not be null since its a declared local variable in the script.\r\n\r\nIf the reduce script is replaced with:\r\n```\r\n\"reduce_script\" : \"Debug.explain(params._aggs)\"\r\n```\r\nThe error becomes:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"\",\r\n    \"phase\": \"fetch\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [],\r\n    \"caused_by\": {\r\n      \"type\": \"script_exception\",\r\n      \"reason\": \"runtime error\",\r\n      \"painless_class\": \"ArrayList\",\r\n      \"to_string\": \"[2.0]\",\r\n      \"java_class\": \"java.util.ArrayList\",\r\n      \"script_stack\": [\r\n        \"Debug.explain(params._aggs)\",\r\n        \"                    ^---- HERE\"\r\n      ],\r\n      \"script\": \"Debug.explain(params._aggs)\",\r\n      \"lang\": \"painless\",\r\n      \"caused_by\": {\r\n        \"type\": \"painless_explain_error\",\r\n        \"reason\": null\r\n      }\r\n    }\r\n  },\r\n  \"status\": 503\r\n}\r\n```\r\nWhich is strange because its showing that `params._aggs` has a value.\r\n\r\nI have tried to reproduce with combinations of the above documents but so far have only managed to reproduce this with these 10 documents so I am yet to determine the exactly criteria for reproducing this bug.","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}