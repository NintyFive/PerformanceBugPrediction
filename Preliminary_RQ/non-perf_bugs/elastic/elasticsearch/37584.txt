{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37584","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37584/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37584/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37584/events","html_url":"https://github.com/elastic/elasticsearch/issues/37584","id":400410495,"node_id":"MDU6SXNzdWU0MDA0MTA0OTU=","number":37584,"title":"Inner_hits in should clauses override each other","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-01-17T18:40:34Z","updated_at":"2019-02-01T14:53:51Z","closed_at":"2019-02-01T14:53:51Z","author_association":"MEMBER","active_lock_reason":null,"body":"This issues is somewhat similar to #16218, but it manifests itself if two `should` clauses contain `has_child` with `inner_hits` and different queries and only one of the query in the last clause doesn't matches the document returned by the first clause.\r\n\r\nThis is a repro for 6.x\r\n\r\n```\r\nDELETE test\r\nPUT test\r\n{\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"my_join_field\": {\r\n          \"type\": \"join\",\r\n          \"relations\": {\r\n            \"question\": \"answer\"\r\n          }\r\n        },\r\n        \"text\": {\r\n          \"type\": \"text\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test/_doc/_bulk\r\n{\"index\":{\"_id\": \"1\"}}\r\n{\"text\": \"This is a question\",\"my_join_field\": {\"name\": \"question\"}}\r\n{\"index\":{\"_id\": \"2\"}}\r\n{\"text\": \"This is another question\",\"my_join_field\": {\"name\": \"question\"}}\r\n{\"index\":{\"_id\": \"3\", \"_routing\": \"1\"}}\r\n{\"text\": \"This is an answer\", \"my_join_field\": {\"name\": \"answer\",\"parent\":\"1\"}}\r\n{\"index\":{\"_id\": \"4\", \"_routing\": \"1\"}}\r\n{\"text\": \"This is another answer\", \"my_join_field\": {\"name\": \"answer\",\"parent\":\"1\"}}\r\n\r\nPOST test/_search\r\n\r\n# Doesn't return inner hits\r\nPOST test/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"has_child\": {\r\n            \"type\": \"answer\",\r\n            \"query\": {\r\n              \"match\": {\r\n                \"text\": \"answer\"\r\n              }\r\n            },\r\n            \"inner_hits\": {}\r\n          }\r\n        },\r\n        {\r\n          \"has_child\": {\r\n            \"type\": \"answer\",\r\n            \"query\": {\r\n              \"match\": {\r\n                \"text\": \"noanswer\"\r\n              }\r\n            },\r\n            \"inner_hits\": {}\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n\r\n# Returns inner hits:\r\nPOST test/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"has_child\": {\r\n            \"type\": \"answer\",\r\n            \"query\": {\r\n              \"match\": {\r\n                \"text\": \"noanswer\"\r\n              }\r\n            },\r\n            \"inner_hits\": {}\r\n          }\r\n        },\r\n        {\r\n          \"has_child\": {\r\n            \"type\": \"answer\",\r\n            \"query\": {\r\n              \"match\": {\r\n                \"text\": \"answer\"\r\n              }\r\n            },\r\n            \"inner_hits\": {}\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n``` \r\nRepro for 7.x can be found [here](https://gist.github.com/imotov/53c2a81b7ba0db2663a50a3f6d8fa7e3)\r\n\r\nOriginally reported in https://discuss.elastic.co/t/inner-hits-has-child/164627/10","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}