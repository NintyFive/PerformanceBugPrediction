[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63027798","html_url":"https://github.com/elastic/elasticsearch/issues/8477#issuecomment-63027798","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8477","id":63027798,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDI3Nzk4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-14T09:13:21Z","updated_at":"2014-11-14T09:13:21Z","author_association":"CONTRIBUTOR","body":"Hi @CostyaRegev \n\nNothing that you show from the logs here indicates the root of the problem.  However, from previous conversations with your team, i know that you have very high filter cache eviction rates.  In other words, you are caching lots of filters which you never reuse.\n\nI think you're running into #8249.  The filter cache size doesn't take the cache key into account, just the value.  I think you're filling up your heap with all of these cache keys, where the key is much bigger than the value.  Then you're never reusing these filters, so you keep adding more filters, until you OOM.\n\nWe made a change in 1.3.5 to make each cached entry count for a minimum amount, even if it was smaller, so that each cached entry has more weight.  This should help you.\n\nBut the real fix (as we've told you before) is to figure out which filters should be cached and which should not, and to disable caching for those filters. Building a cached filter is more expensive than just using a filter, so it only makes sense to do on those filters which are frequently reused.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63038262","html_url":"https://github.com/elastic/elasticsearch/issues/8477#issuecomment-63038262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8477","id":63038262,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDM4MjYy","user":{"login":"cregev","id":7669819,"node_id":"MDQ6VXNlcjc2Njk4MTk=","avatar_url":"https://avatars1.githubusercontent.com/u/7669819?v=4","gravatar_id":"","url":"https://api.github.com/users/cregev","html_url":"https://github.com/cregev","followers_url":"https://api.github.com/users/cregev/followers","following_url":"https://api.github.com/users/cregev/following{/other_user}","gists_url":"https://api.github.com/users/cregev/gists{/gist_id}","starred_url":"https://api.github.com/users/cregev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cregev/subscriptions","organizations_url":"https://api.github.com/users/cregev/orgs","repos_url":"https://api.github.com/users/cregev/repos","events_url":"https://api.github.com/users/cregev/events{/privacy}","received_events_url":"https://api.github.com/users/cregev/received_events","type":"User","site_admin":false},"created_at":"2014-11-14T10:22:42Z","updated_at":"2014-11-14T10:22:42Z","author_association":"NONE","body":"Hi @clintongormley \n\nWe have disabled most of our caching by using doc_values for those fields(btw , we reindex all our cluster with new mapping settings (most of the fields are doc_values), but we are still facing problems with the cluster.\n\nFor example every time we restart our cluster our Indecies ID Cache starts with a relatively high number \nwhich does not make sense because we are not using a parent-child queries, thus  i need to run Elasticsearch's api for cleaning the ID cache  after every restart.\n\nHow this situation can happen ?\n\nThanks,\nCostya\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63043886","html_url":"https://github.com/elastic/elasticsearch/issues/8477#issuecomment-63043886","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8477","id":63043886,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDQzODg2","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-14T11:03:31Z","updated_at":"2014-11-14T11:03:31Z","author_association":"CONTRIBUTOR","body":"@CostyaRegev doc values is to do with fielddata, not filter caching.  When you see your memory usage rising, try clearing the filter cache:\n\n```\nPOST /_cache/clear?filter\n```\n\nAnd see if your heap drops (it may take up to a minute).  That will confirm my diagnosis.\n\nFor the ID cache - that is built eagerly, not at query time.  And there is no point in clearing it because it will just be rebuilt (at least for new segments).  However, if you are not using parent/child queries at all (which makes me wonder why you have the feature enabled) then you can set fielddata loading to `lazy`.\n\nBut really, if you need parent/child, then you need the memory to hold the IDs, in which case you either need more RAM or more nodes.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63219136","html_url":"https://github.com/elastic/elasticsearch/issues/8477#issuecomment-63219136","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8477","id":63219136,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMjE5MTM2","user":{"login":"cregev","id":7669819,"node_id":"MDQ6VXNlcjc2Njk4MTk=","avatar_url":"https://avatars1.githubusercontent.com/u/7669819?v=4","gravatar_id":"","url":"https://api.github.com/users/cregev","html_url":"https://github.com/cregev","followers_url":"https://api.github.com/users/cregev/followers","following_url":"https://api.github.com/users/cregev/following{/other_user}","gists_url":"https://api.github.com/users/cregev/gists{/gist_id}","starred_url":"https://api.github.com/users/cregev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cregev/subscriptions","organizations_url":"https://api.github.com/users/cregev/orgs","repos_url":"https://api.github.com/users/cregev/repos","events_url":"https://api.github.com/users/cregev/events{/privacy}","received_events_url":"https://api.github.com/users/cregev/received_events","type":"User","site_admin":false},"created_at":"2014-11-16T13:36:42Z","updated_at":"2014-11-16T13:36:42Z","author_association":"NONE","body":"Hi Clinton ,\n\nOur cluster crashed today couple of times , and indeed it helped clearing the filter cache after i cleared the filter cache the cluster was back to normal , but something strange that happened is:\nOne of the data nodes got JavaOutOfMemory , then i cleared the filter cache but the data nodes= did not return the cluster , moreover then that i entered the host and checked that the service of elasticsearch was running but when i tried \"curl -XGET localhost:9200/_cluster/health?pretty \" is did  not succeed connecting the cluster i had to kill -9 the process in order to restart the service and only then the node joined back the cluster.\n\nMy question is this : when a node gets a JavaOutOfMemory should not it rejoin the cluster again after the process is restarted ? \n\nAnother anomaly that i found is that when i use \"curl -XPOST 'http://localhost:9200/_shutdown'\" the shutdown api it does not shutdown all the nodes in the cluster , only part of them...\nWho can this situation happen?\n\nThanks,\nCostya.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63292832","html_url":"https://github.com/elastic/elasticsearch/issues/8477#issuecomment-63292832","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8477","id":63292832,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMjkyODMy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-17T11:38:31Z","updated_at":"2014-11-17T11:38:31Z","author_association":"CONTRIBUTOR","body":"Hi @CostyaRegev \n\nAfter an OOM, the node is in an undefine state and has to be restarted.  It sounds like you are getting into a split brain condition.  You need to deal with the underlying problem which sounds like it is the cache key issue.  Upgrading will help, but really you need to stop caching filters which are not reused.\n","performed_via_github_app":null}]