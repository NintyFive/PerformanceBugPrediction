{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31805","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31805/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31805/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31805/events","html_url":"https://github.com/elastic/elasticsearch/issues/31805","id":338361632,"node_id":"MDU6SXNzdWUzMzgzNjE2MzI=","number":31805,"title":"Getting fields and their values of a top_hits sub-aggregation of a date_histogram","user":{"login":"spiewok","id":3295038,"node_id":"MDQ6VXNlcjMyOTUwMzg=","avatar_url":"https://avatars3.githubusercontent.com/u/3295038?v=4","gravatar_id":"","url":"https://api.github.com/users/spiewok","html_url":"https://github.com/spiewok","followers_url":"https://api.github.com/users/spiewok/followers","following_url":"https://api.github.com/users/spiewok/following{/other_user}","gists_url":"https://api.github.com/users/spiewok/gists{/gist_id}","starred_url":"https://api.github.com/users/spiewok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spiewok/subscriptions","organizations_url":"https://api.github.com/users/spiewok/orgs","repos_url":"https://api.github.com/users/spiewok/repos","events_url":"https://api.github.com/users/spiewok/events{/privacy}","received_events_url":"https://api.github.com/users/spiewok/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-07-04T19:27:43Z","updated_at":"2018-07-06T10:10:40Z","closed_at":"2018-07-06T10:10:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version:** 6.1.2\r\n\r\n**HighLevelRestClient:** 6.1.2/6.1.3/6.1.4\r\n\r\n**JVM version (java -version):** Java(TM) SE Runtime Environment (build 1.8.0_131-b11)\r\n\r\n**OS version (uname -a if on a Unix-like system)**: macOS High Sierra 10.13.4 (Darwin Kernel Version 17.5.0)\r\n\r\n**Description of the problem including expected versus actual behavior:**\r\nNot able to access source fields while fetching a top_hits aggregation per bucket of a date_histogram aggregation with the HighLevelRestClient\r\n\r\n**Steps to reproduce:**\r\n\r\n**Index structure (json):**\r\n[\r\n{\"id\":289105,\"sourceId\":\"2\",\"xId\":\"1\",\"vivaId\":\"7\",\"xDensity\":1,\"xTimestamp\":\"2018-06-01T23:22:52Z\",\"xValue1\":20000,\"xValue2\":0,\"xValue3\":0,\"xValue4\":0,\"xStringValue1\":\"\",\"xStringValue2\":\"\",\"xStringValue3\":\"\",\"xStringValue4\":\"\",\"checksum\":\"\",\"createdAt\":\"2018-06-25T16:18:45Z\",\"xDataType\":\"ABSOLUTE\"},\r\n{\"id\":289108,\"sourceId\":\"2\",\"xId\":\"1\",\"vivaId\":\"7\",\"xDensity\":1,\"xTimestamp\":\"2018-06-02T08:00:52Z\",\"xValue1\":10000,\"xValue2\":0,\"xValue3\":0,\"xValue4\":0,\"xStringValue1\":\"\",\"xStringValue2\":\"\",\"xStringValue3\":\"\",\"xStringValue4\":\"\",\"checksum\":\"\",\"createdAt\":\"2018-06-25T16:25:45Z\",\"xDataType\":\"ABSOLUTE\"},\r\n{\"id\":289091,\"sourceId\":\"2\",\"xId\":\"1\",\"vivaId\":\"5\",\"xDensity\":1,\"xTimestamp\":\"2018-06-02T23:22:52Z\",\"xValue1\":10000,\"xValue2\":0,\"xValue3\":0,\"xValue4\":0,\"xStringValue1\":\"\",\"xStringValue2\":\"\",\"xStringValue3\":\"\",\"xStringValue4\":\"\",\"checksum\":\"\",\"createdAt\":\"2018-06-05T09:23:34Z\",\"xDataType\":\"OUT\"}]\r\n\r\n**Query:**\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match\": {\r\n            \"vivaId\": {\r\n              \"query\": \"7\",\r\n              \"operator\": \"OR\",\r\n              \"prefix_length\": 0,\r\n              \"max_expansions\": 50,\r\n              \"fuzzy_transpositions\": true,\r\n              \"lenient\": false,\r\n              \"zero_terms_query\": \"NONE\",\r\n              \"boost\": 1\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"xTimestamp\": {\r\n              \"from\": \"2018-06-01T00:00:00Z\",\r\n              \"to\": \"2018-06-05T23:59:00Z\",\r\n              \"include_lower\": true,\r\n              \"include_upper\": true,\r\n              \"boost\": 1\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"dateHisto\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"xTimestamp\",\r\n        \"interval\": \"1d\",\r\n        \"offset\": 0,\r\n        \"order\": {\r\n          \"_key\": \"asc\"\r\n        },\r\n        \"keyed\": false,\r\n        \"min_doc_count\": 0,\r\n        \"extended_bounds\": {\r\n          \"min\": 1527811200000,\r\n          \"max\": 1528243140000\r\n        }\r\n      },\r\n      \"aggregations\": {\r\n        \"top_values\": {\r\n          \"top_hits\": {\r\n            \"from\": 0,\r\n            \"size\": 1,\r\n            \"version\": false,\r\n            \"explain\": false,\r\n            \"_source\": {\r\n              \"includes\": [],\r\n              \"excludes\": []\r\n            },\r\n            \"sort\": [\r\n              {\r\n                \"xTimestamp\": {\r\n                  \"order\": \"desc\"\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\n**Output:**\r\n\"buckets\":[\r\n   {\r\n      \"key_as_string\":\"2018-06-01T00:00:00.000Z\",\r\n      \"key\":1527811200000,\r\n      \"doc_count\":3,\r\n      \"top_values\":{\r\n         \"hits\":{\r\n            \"total\":3,\r\n            \"max_score\":null,\r\n            \"hits\":[\r\n               {\r\n                  \"_index\":\"xdata\",\r\n                  \"_type\":\"doc\",\r\n                  \"_id\":\"289105\",\r\n                  \"_score\":null,\r\n                  \"_source\":{\r\n                     \"id\":289105,\r\n                     \"sourceId\":\"2\",\r\n                     \"xId\":\"1\",\r\n                     \"vivaId\":\"7\",\r\n                     \"xDensity\":1,\r\n                     \"xTimestamp\":\"2018-06-01T23:22:52Z\",\r\n                     \"xValue1\":20000,\r\n                     \"xValue2\":0,\r\n                     \"xValue3\":0,\r\n                     \"xValue4\":0,\r\n                     \"xStringValue1\":\"\",\r\n                     \"xStringValue2\":\"\",\r\n                     \"xStringValue3\":\"\",\r\n                     \"xStringValue4\":\"\",\r\n                     \"checksum\":\"\",\r\n                     \"createdAt\":\"2018-06-25T16:18:45Z\",\r\n                     \"xDataType\":\"ABSOLUTE\"\r\n                  },\r\n                  \"sort\":[\r\n                     1527895372000\r\n                  ]\r\n               }\r\n            ]\r\n         }\r\n      }\r\n   }\r\n\r\nSo the output from elasticsearch (if done manually) is all right. The \"_source\" is included.\r\n\r\nIf I now do the query with the HighLevelRestClient which is like:\r\n        SearchRequest searchRequest = new SearchRequest(ELASTICSEARCH_INDEX);\r\n\r\n        QueryBuilder rangeQueryBuilder = rangeQuery(\"xTimestamp\")\r\n            .gte(from)\r\n            .lte(to);\r\n\r\n        BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();\r\n        queryBuilder.must(matchQuery(\"vivaId\", vivaId));\r\n        queryBuilder.must(rangeQueryBuilder);\r\n\r\n        DateHistogramAggregationBuilder dateHistogram = new DateHistogramAggregationBuilder(\"dateHisto\");\r\n        dateHistogram.field(\"xTimestamp\");\r\n        ExtendedBounds bounds = new ExtendedBounds(from.toEpochMilli(), to.toEpochMilli());\r\n        dateHistogram.extendedBounds(bounds);\r\n\r\n        switch (resolution) {\r\n            case DAY:\r\n                dateHistogram.dateHistogramInterval(DateHistogramInterval.DAY);\r\n                break;\r\n            case MONTH:\r\n                dateHistogram.dateHistogramInterval(DateHistogramInterval.MONTH);\r\n                break;\r\n            case HOUR:\r\n                dateHistogram.dateHistogramInterval(DateHistogramInterval.HOUR);\r\n                break;\r\n            case WEEK:\r\n                dateHistogram.dateHistogramInterval(DateHistogramInterval.WEEK);\r\n                break;\r\n        }\r\n\r\n        \r\n        TopHitsAggregationBuilder aggregator = new TopHitsAggregationBuilder(\"top_values\");\r\n        aggregator.fetchSource(true);\r\n        aggregator.sort(\"xTimestamp\", SortOrder.DESC);\r\n        aggregator.size(1);\r\n\r\n        dateHistogram.subAggregation(aggregator);\r\n\r\n        searchRequest.source(new SearchSourceBuilder()\r\n            .query(queryBuilder)\r\n            .aggregation(dateHistogram)\r\n            .size(0)\r\n        );\r\n\r\n        SearchResponse searchResponse = client.search(searchRequest);\r\n        Aggregations aggs = searchResponse.getAggregations();\r\n        ParsedDateHistogram histogram = aggs.get(\"dateHisto\");\r\n\r\nthere is no way to access the \"_source\", and therefore, I can't get the fields and their values.\r\n\r\nSo, if I do for instance: \r\n_((ParsedTopHits)histogram.getBuckets().get(0).getAggregations().get(\"top_values\")).getHits().getHits()[0].getFields()_\r\n\r\nthe size of the fields is zero, though I state \"fetch source\", as seen above. And it's there if I do the query directly within in elasticsearch.\r\n\r\nIs this a bug, or do I do something fundamentally wrong?\r\n\r\n![bildschirmfoto 2018-07-04 um 21 18 34](https://user-images.githubusercontent.com/3295038/42292093-4929fe86-7fd0-11e8-9144-1e4db747e2ae.png)\r\n\r\n\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}