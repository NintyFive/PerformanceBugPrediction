{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28220","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28220/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28220/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28220/events","html_url":"https://github.com/elastic/elasticsearch/issues/28220","id":288591650,"node_id":"MDU6SXNzdWUyODg1OTE2NTA=","number":28220,"title":"Aggregations enhancement - better memory usage estimates to avoid circuit breaking","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-01-15T13:19:36Z","updated_at":"2020-06-24T17:41:03Z","closed_at":"2020-06-24T17:41:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In a recent [discuss forum post](https://discuss.elastic.co/t/elasticsearch-aggregation-encounters-circuit-breaking-exception/115454) a user reported circuit breaking exceptions when using a large number of `avg` aggregations nested under two layers of `terms` aggregations.\r\nInternally, the estimated memory cost of handling the request was (badly) estimated to be nearly 3GB in size but the actual size should have been much smaller. In part, this is due to a [one-size-fits-all](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java#L106) cost which is added for every aggregation which is hard-coded to 5kb in the aggregator base class.\r\n\r\nFor some aggregations this is often an underestimate (e.g. cardinality agg) while for simple metric aggregations like the `avg` aggregation it is a large over-estimate (which led to the circuit breaker error in the case mentioned above).\r\n\r\nThe solution requires \r\n1) A change to AggregatorBase to allow subclasses to override a new \"getWeight\" method.\r\n2) Changes to metric aggregations like `avg` to provide a better estimate of their memory cost.\r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}