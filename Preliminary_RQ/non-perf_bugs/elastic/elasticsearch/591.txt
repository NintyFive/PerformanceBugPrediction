{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/591","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/591/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/591/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/591/events","html_url":"https://github.com/elastic/elasticsearch/issues/591","id":501829,"node_id":"MDU6SXNzdWU1MDE4Mjk=","number":591,"title":"Search: Date Histogram Facet","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":65354,"node_id":"MDU6TGFiZWw2NTM1NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.15.0","name":"v0.15.0","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2011-01-02T13:07:11Z","updated_at":"2011-01-02T13:08:01Z","closed_at":"2011-01-02T13:08:01Z","author_association":"MEMBER","active_lock_reason":null,"body":"The current histogram facet works with dates, but has some problems when handling them, specifically, it does not allow for custom time zones to be set, as well as does not support `month` and `year` intervals (only lower level weeks/days/hours).\n\nThe `date_histogram` allows for specific handling when the (key) field faceting on is of type date. Here is an example:\n\n```\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"facets\" : {\n        \"histo1\" : {\n            \"date_histogram\" : {\n                \"field\" : \"field_name\",\n                \"interval\" : \"day\"\n            }\n        }\n    }\n}\n```\n## Interval\n\nThe `interval` allows to set the interval at which buckets will be created for each hit. It allows for the constant values of `year`, `month`, `day`, `hour`, `minute`. \n\nThe specific constant values also support setting rounding by appending `:` to it, and then the rounding value. For example: `day:ceiling`. The values are:\n- `floor`: (the default), rounds to the lowest whole unit of this field.\n- `ceiling`: Rounds to the highest whole unit of this field.\n- `half_floor`: Round to the nearest whole unit of this field. If the given millisecond value is closer to the floor or is exactly halfway, this function behaves like `floor`. If the millisecond value is closer to the ceiling, this function behaves like `ceiling`.\n- `half_ceiling`: Round to the nearest whole unit of this field. If the given millisecond value is closer to the floor, this function behaves like `floor`. If the millisecond value is closer to the ceiling or is exactly halfway, this function behaves like `ceiling`.\n- `half_even`: Round to the nearest whole unit of this field. If the given millisecond value is closer to the floor, this function behaves like `floor`. If the millisecond value is closer to the ceiling, this function behaves like `ceiling`. If the millisecond value is exactly halfway between the floor and ceiling, the ceiling is chosen over the floor only if it makes this field's value even.\n\nIt also support time value setting like `1.5h` (up to `w` for weeks).\n## Time Zone\n\nBy default, times are stored as UTC milliseconds since the epoch. Thus, all computation and \"bucketing\" / \"rounding\" is done on UTC. It is possible to provide a `zone` value, which will cause all computations to take the relevant zone into account. The time returned for each bucket/entry is milliseconds since the epoch of the provided time zone.\n\nThe `zone` value accepts either a numeric value for the hours offset, for example: `\"zone\" : -2`. It also accepts a format of hours and minutes, like `\"zone\" : \"-02:30\"`.\n\nAnother option is to provide a time zone accepted as one of the values listed here: http://joda-time.sourceforge.net/timezones.html.\n## Value Field\n\nThe `date_histogram` facet allows to use a different key (of type date) which controls the bucketing, with a different value field which will then return the `total` and `mean` for that field values of the hits within the relevant bucket. For example:\n\n```\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"facets\" : {\n        \"histo1\" : {\n            \"histogram\" : {\n                \"key_field\" : \"timestamp\",\n                \"value_field\" : \"price\",\n                \"interval\" : \"day\"\n            }\n        }\n    }\n}\n```\n## Script Value Field\n\nA script can be used to compute the value that will then be used to compute the `total` and `mean` for a bucket. For example:\n\n```\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"facets\" : {\n        \"histo1\" : {\n            \"histogram\" : {\n                \"key_field\" : \"timestamp\",\n                \"value_script\" : \"doc['price'].value * 2\",\n                \"interval\" : \"day\"\n            }\n        }\n    }\n}\n```\n","closed_by":null,"performed_via_github_app":null}