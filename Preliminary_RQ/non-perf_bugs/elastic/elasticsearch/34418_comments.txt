[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429295039","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-429295039","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":429295039,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTI5NTAzOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T11:30:20Z","updated_at":"2018-10-12T11:30:20Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429295153","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-429295153","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":429295153,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTI5NTE1Mw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T11:30:50Z","updated_at":"2018-10-12T11:30:50Z","author_association":"MEMBER","body":"@nknize @iverase Could one of you take a look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429328366","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-429328366","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":429328366,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTMyODM2Ng==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T13:37:34Z","updated_at":"2018-10-12T13:37:34Z","author_association":"MEMBER","body":"I can take a look.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429333429","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-429333429","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":429333429,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTMzMzQyOQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T13:53:44Z","updated_at":"2018-10-12T13:53:44Z","author_association":"CONTRIBUTOR","body":"Thanks @imotov","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429926956","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-429926956","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":429926956,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTkyNjk1Ng==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-10-15T16:42:22Z","updated_at":"2018-10-15T16:42:22Z","author_association":"MEMBER","body":"The problem is triggered by an [invalid request](https://github.com/schulm/elasticGeoShapeQueryTestCase/blob/e77f0b4baae92e0c5c8d644f1e05054e4f031621/src/test/java/elastictest/geoShapeNewEnvelope.java#L95) that is sent in both cases (transport and http client):\r\n```\r\n    GeoShapeQueryBuilder getQuery() throws IOException {\r\n        return QueryBuilders.geoShapeQuery(\r\n                \"geo\", //\r\n                new EnvelopeBuilder(new Coordinate(-21, 44), new Coordinate(-39, 9))).//\r\n                relation(ShapeRelation.WITHIN);\r\n    }\r\n```\r\nThe envelope is supposed to be defined by top left and bottom right corners. Instead it is defined by top right and bottom left corners:\r\n```\r\n(-39, 44)                     (-21, 44)\r\n\r\n\r\n(-39, 9)                      (-21, 9)\r\n```\r\n\r\nIn case of the HL REST client, we perform an additional check and fix the envelope during json parsing:\r\nhttps://github.com/elastic/elasticsearch/blob/bd1c513422d63d8f7df1fac6743ba7fd7133fa9e/server/src/main/java/org/elasticsearch/common/geo/GeoShapeType.java#L226-L230\r\n\r\nIn case of the transport client, since we don't parse json and already have `EnvelopeBuilder` this check is bypassed. To fix the issue, we can either move the coercion logic into  `EnvelopeBuilder` or just add a check that will throw an exception for invalid coordinates in the `EnvelopeBuilder`. @nknize @iverase  what do you think?\r\n\r\n@schulm thank you very much for a great reproduction. For now the workaround would be to fix the query and/or move from the transport client to HL REST client since this is a better solution anyway.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430138067","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-430138067","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":430138067,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDEzODA2Nw==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T07:54:29Z","updated_at":"2018-10-16T08:05:59Z","author_association":"CONTRIBUTOR","body":"I disagree with your assessment as I think the provided bounding box is legal. It is fine that the left longitude is bigger than the right longitude. That only means that the envelope crosses the date line.\r\n\r\nYou can see the provided envelope as two, divided on the dateline:\r\n\r\n```\r\n(-21, 44)   (180, 44)   |  (-180, 44) (-39, 44)\r\n                    \r\n(-21, 9)    (180, 9)    | (-180, 9)  (-39, 9)\r\n```\r\n\r\nWhat the HLRC is doing seems totally wrong, we should not be correcting the provided points. If they make no sense (e.g top latitude lower than bottom latitude) we should throw an exception.\r\n\r\nIn summary: the transport client is doing the right thing and the provided envelope is disjoint with the provided point. We should remove the coerce code altogether.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430243143","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-430243143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":430243143,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI0MzE0Mw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T13:45:18Z","updated_at":"2018-10-16T13:45:18Z","author_association":"MEMBER","body":"@iverase good catch! I keep forgetting about this dateline. You are absolutely right, it looks like the issue is actually in the REST client. \r\n\r\nThe following test returns documents `1` in REST and documents `2` and `3` in transport. I agree the correct behaviour should be indeed to return `2` and `3` everywhere.\r\n\r\n```\r\nPUT test\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1\r\n  },\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"geo\": {\r\n          \"type\": \"geo_shape\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test/doc/1\r\n{\r\n  \"geo\": {\r\n    \"coordinates\": [-33.918711, 18.847685],\r\n    \"type\": \"Point\"\r\n  }\r\n}\r\n\r\nPUT test/doc/2\r\n{\r\n  \"geo\": {\r\n    \"coordinates\": [-49.918711, 18.847685],\r\n    \"type\": \"Point\"\r\n  }\r\n}\r\n\r\n\r\nPUT test/doc/3\r\n{\r\n  \"geo\": {\r\n    \"coordinates\": [49.918711, 18.847685],\r\n    \"type\": \"Point\"\r\n  }\r\n}\r\n\r\nGET /test/_search\r\n{\r\n  \"query\": {\r\n    \"geo_shape\": {\r\n      \"geo\": {\r\n        \"shape\": {\r\n          \"type\": \"envelope\",\r\n          \"coordinates\": [[-21, 44],[-39, 9]]\r\n        },\r\n        \"relation\": \"within\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nSo, it looks like a bug in REST client, fixing which can potentially break some applications that were relying on this bug. So, maybe we should fix it only in 6.5 and mention in breaking changes.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430262852","html_url":"https://github.com/elastic/elasticsearch/issues/34418#issuecomment-430262852","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34418","id":430262852,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI2Mjg1Mg==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T14:37:33Z","updated_at":"2018-10-16T14:37:33Z","author_association":"CONTRIBUTOR","body":"Sounds like a good plan!","performed_via_github_app":null}]