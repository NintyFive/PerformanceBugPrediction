{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8959","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8959/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8959/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8959/events","html_url":"https://github.com/elastic/elasticsearch/issues/8959","id":52006791,"node_id":"MDU6SXNzdWU1MjAwNjc5MQ==","number":8959,"title":"Transform script and completion suggest payload - malformed JSON output","user":{"login":"jo-m","id":2587503,"node_id":"MDQ6VXNlcjI1ODc1MDM=","avatar_url":"https://avatars0.githubusercontent.com/u/2587503?v=4","gravatar_id":"","url":"https://api.github.com/users/jo-m","html_url":"https://github.com/jo-m","followers_url":"https://api.github.com/users/jo-m/followers","following_url":"https://api.github.com/users/jo-m/following{/other_user}","gists_url":"https://api.github.com/users/jo-m/gists{/gist_id}","starred_url":"https://api.github.com/users/jo-m/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jo-m/subscriptions","organizations_url":"https://api.github.com/users/jo-m/orgs","repos_url":"https://api.github.com/users/jo-m/repos","events_url":"https://api.github.com/users/jo-m/events{/privacy}","received_events_url":"https://api.github.com/users/jo-m/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2014-12-15T16:26:58Z","updated_at":"2014-12-22T09:12:06Z","closed_at":"2014-12-22T09:12:06Z","author_association":"NONE","active_lock_reason":null,"body":"I am using the completion suggester. The payload is being created using a transform script. This somehow breaks JSON output. A detailed shell script for reproducing the bug is included. This was tested with version 1.4.0.\n\n``` bash\n#!/bin/bash\n\nELASTIC_URL='http://elastic:9200'\nINDEX_NAME='test'\nOBJ_ID=some_user_id\n\n# delete index\ncurl -XDELETE \"$ELASTIC_URL/$INDEX_NAME\" &> /dev/null\n\n# create index with mapping\n# defined suggest field and includes transform script\n# for populating the payload\ncurl -XPOST \"$ELASTIC_URL/$INDEX_NAME\" -d @- &> /dev/null <<EOF\n{\n    \"mappings\" : {\n        \"app_user\" : {\n            \"_source\" : {\n                \"includes\" : [\n                    \"_id\",\n                    \"_rev\",\n                    \"type\",\n                    \"profile.callname\",\n                    \"profile.fullname\",\n                    \"email\"\n                ]\n            },\n            \"properties\" : {\n                \"suggest\" : { \"type\" : \"completion\",\n                              \"payloads\" : true\n                }\n            },\n            \"transform\" : [\n                {\"script\": \"ctx._source.suggest = ['input':[ctx._source.email, ctx._source.profile.fullname, ctx._source.profile.callname]]\"},\n                {\"script\": \"ctx._source.suggest.payload = ['display': ctx._source.profile.fullname, 'display_detail': ctx._source.email]\"}\n            ]\n        }\n    }\n}\nEOF\n\n# put the object\ncurl -XPUT \"$ELASTIC_URL/$INDEX_NAME/app_user/$OBJ_ID\" -d @- &> /dev/null <<EOF\n{\n    \"_id\": \"$OBJ_ID\",\n    \"type\": \"app_user\",\n    \"version\": 1,\n    \"profile\": {\n        \"callname\": \"User Name\",\n        \"fullname\": \"Dr. User Name\",\n        \"profile_text\": \"Lorem ipsum dolor sit amet blah blah\"\n    },\n    \"created\": \"2014-08-14T20:07:28Z\",\n    \"last_login\": \"2014-08-14T20:07:28Z\",\n    \"login_counter\": 0,\n    \"email\": \"user@example.org\"\n}\nEOF\n\n# wait for index to be updated\nsleep 4\n\n# interestingly, here the payload is displayed correctly\necho 'TRANSFORMED OBJECT:'\ncurl -XGET \"$ELASTIC_URL/$INDEX_NAME/app_user/$OBJ_ID?pretty&_source_transform\" 2> /dev/null | jsonlint\n\n# but not when we retrieve the document by search.\necho 'RETRIEVED BY SEARCH:'\ncurl -XGET \"$ELASTIC_URL/$INDEX_NAME/_suggest\" -d '{\n    \"all-suggest\": {\n        \"text\": \"User Name\",\n        \"completion\": {\n            \"field\": \"suggest\"\n        }\n    }\n}'\n```\n\nThis produces output like this:\n\n```\nTRANSFORMED OBJECT:\n{\n  \"_index\": \"test\",\n  \"_type\": \"app_user\",\n  \"_id\": \"some_user_id\",\n  \"_version\": 1,\n  \"found\": true,\n  \"_source\": {\n    \"_id\": \"some_user_id\",\n    \"email\": \"user@example.org\",\n    \"suggest\": {\n      \"input\": [\n        \"user@example.org\",\n        \"Dr. User Name\",\n        \"User Name\"\n      ],\n      \"payload\": {\n        \"display\": \"Dr. User Name\",\n        \"display_detail\": \"user@example.org\"\n      }\n    },\n    \"type\": \"app_user\",\n    \"profile\": {\n      \"callname\": \"User Name\",\n      \"fullname\": \"Dr. User Name\"\n    }\n  }\n}\nRETRIEVED BY SEARCH:\n{\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"all-suggest\":[{\"text\":\"User Name\",\"offset\":0,\"length\":9,\"options\":[{\"text\":\"User Name\",\"score\":1.0,\"payload\"::)\n�displayLDr. User Name�display_detailOuser@example.org�}]}]}\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}