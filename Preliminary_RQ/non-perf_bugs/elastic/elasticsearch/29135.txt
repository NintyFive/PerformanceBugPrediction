{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29135","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29135/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29135/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29135/events","html_url":"https://github.com/elastic/elasticsearch/issues/29135","id":306394688,"node_id":"MDU6SXNzdWUzMDYzOTQ2ODg=","number":29135,"title":"Reloadable secure settings for plugins","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"labels":[{"id":146832994,"node_id":"MDU6TGFiZWwxNDY4MzI5OTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Plugins","name":":Core/Infra/Plugins","color":"0e8a16","default":false,"description":"Plugin API and infrastructure"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"assignees":[{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-03-19T09:53:40Z","updated_at":"2019-02-07T10:33:48Z","closed_at":"2018-06-18T06:42:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"EDITED:\r\nThe [reload-secure-store-action](https://github.com/elastic/elasticsearch/tree/reload-secure-store-action) branch tracks the progress of making some of the plugins' secure settings reloadable. \r\n\r\nPasswords and access keys of the clients used internally for remote calls are stored as [secure settings](https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-settings.html) inside the `elasticsearch.keystore` file. The contents of this file are retrievable only after decryption, using a password. Currently, the password is only available during node initialization. This effectively renders these settings immutable, as they are read only once, during initialization.\r\n\r\nIn the new proposed approach, plugins that are using internal clients (AWS, Azure, etc.) should not cache client instances but instead should require a client from a \"Registry Service\". There is one such service for each plugin. The client instance should be requested on each use (call to external system). Generally, it should be inexpensive for the \"Registry Service\" to service such demands. The \"Registry Service\", acting as a client cache, should allow for the clients' credentials to be changed. After the credentials change, subsequent client requests will return a new client constructed with the new credentials. Client instances that have been used before any credentials change **will** continue to be usable. The present implementation is of a best effort type. Currently, there is no way to wait for plugins to ditch the old settings and use only the new ones. In essence, this is because there is no strict rule of what *reload* means or what *reload is complete* means. It might be possible (high hanging fruit) for plugins to signal their completed reload.\r\n\r\nThe credentials change when the node rereads and decrypts the local keystore. For decryption it requires the password which is broadcasted by a `TransportNodesAction` action. The password should not be cached anywhere. When the `TransportNodesAction` action has returned, the keystore is no longer readable.\r\n\r\nToo much noise already.\r\nPlugins wishing to become \"reloadable\" should implement the `ReloadablePlugin` interface. They have to implement `void reload(Settings settings) throws Exception`. The `settings` parameter contains retrievable `SecureSettings`, but only if accessed under the `reload` call stack, i.e. don't pass the `settings` object to an async task and expect for `SecureSettings` to be further retrievable. Once the `reload` method has returned the keystore is sealed again.\r\n\r\nTasks:\r\n- [x] broadcast the password to decrypt settings\r\n- [x] [make repository-s3-plugin client settings updatable](https://github.com/elastic/elasticsearch/pull/28517) (merged)\r\n- [x] [make discovery-ec2-plugin client settings updatable](https://github.com/elastic/elasticsearch/pull/29134) (merged)\r\n- [x] [make repository-azure-plugin client settings updatable](https://github.com/elastic/elasticsearch/pull/29319) (merged)\r\n- [x] [make repository-gcs credentials file setting updatable](https://github.com/elastic/elasticsearch/pull/30688) (merged)\r\n- [x] [factor out common code for the client cache/registry/dictionary](https://github.com/elastic/elasticsearch/pull/31250) (merged)\r\n\r\nSecure settings are also used at these other places:\r\n* SSL Configuration\r\n* watcher notification integrations (hipchat, jira, pagerduty, slack)\r\n* LDAP and AD Realm bind password\r\n\r\nThey might also benefit of this \"reloadable\" capability.\r\n \r\n\r\n","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}