{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21301","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21301/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21301/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21301/events","html_url":"https://github.com/elastic/elasticsearch/issues/21301","id":187023472,"node_id":"MDU6SXNzdWUxODcwMjM0NzI=","number":21301,"title":"Terms lookup filter in filter aggregation complains that the query is not rewritten","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-11-03T10:32:53Z","updated_at":"2016-11-03T15:48:55Z","closed_at":"2016-11-03T15:48:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Reported at https://discuss.elastic.co/t/5-0-cant-have-terms-query-within-a-filter-aggregation/64768\r\n\r\nHere is a recreation:\r\n\r\n```\r\nPUT test\r\n{\r\n  \"mappings\": {\r\n    \"post\": {\r\n      \"properties\": {\r\n        \"mentionIDs\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    },\r\n    \"user\": {\r\n      \"properties\": {\r\n        \"notifications\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test/user/USR|CLIENTID|1234\r\n{\r\n  \"notifications\": [\"abc\"]\r\n}\r\n\r\nPUT test/post/POST|4321\r\n{\r\n  \"mentionIDs\": [\"abc\"]\r\n}\r\n\r\nGET _search\r\n{\r\n  \"aggs\": {\r\n    \"itemsNotify\": {\r\n      \"filter\": {\r\n        \"terms\": {\r\n          \"mentionIDs\": {\r\n            \"index\": \"users\",\r\n            \"type\": \"user\",\r\n            \"id\": \"USR|CLIENTID|1234\",\r\n            \"path\": \"notifications\",\r\n            \"routing\": \"CLIENTID\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nwhich fails with:\r\n\r\n```\r\n[elasticsearch] [2016-11-03T11:28:45,410][WARN ][r.suppressed             ] path: /_search, params: {}\r\n[elasticsearch] org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n[elasticsearch] \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onFirstPhaseResult(AbstractSearchAsyncAction.java:204) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.action.search.AbstractSearchAsyncAction$1.onFailure(AbstractSearchAsyncAction.java:139) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:980) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1081) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1059) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.TransportService$6.onFailure(TransportService.java:585) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:490) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_66-ea]\r\n[elasticsearch] \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_66-ea]\r\n[elasticsearch] \tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_66-ea]\r\n[elasticsearch] Caused by: org.elasticsearch.transport.RemoteTransportException: [EFHp1JN][127.0.0.1:9300][indices:data/read/search[phase/query]]\r\n[elasticsearch] Caused by: java.lang.UnsupportedOperationException: query must be rewritten first\r\n[elasticsearch] \tat org.elasticsearch.index.query.TermsQueryBuilder.doToQuery(TermsQueryBuilder.java:317) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.index.query.AbstractQueryBuilder.toQuery(AbstractQueryBuilder.java:95) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.aggregations.bucket.filter.FilterAggregatorFactory.<init>(FilterAggregatorFactory.java:45) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.aggregations.bucket.filter.FilterAggregationBuilder.doBuild(FilterAggregationBuilder.java:75) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.aggregations.AbstractAggregationBuilder.build(AbstractAggregationBuilder.java:126) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.aggregations.AggregatorFactories$Builder.build(AggregatorFactories.java:208) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.SearchService.parseSource(SearchService.java:730) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.SearchService.createContext(SearchService.java:554) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:530) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:265) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:300) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:297) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:574) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch] \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n```","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}