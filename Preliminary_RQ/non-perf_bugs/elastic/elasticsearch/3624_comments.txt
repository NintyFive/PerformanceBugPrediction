[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23866803","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23866803","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23866803,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODY2ODAz","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-05T13:20:43Z","updated_at":"2013-09-05T13:20:43Z","author_association":"MEMBER","body":"It seems like there is no leak, since 5 BulkRequests \\* 5000 end up being 25k index requests (which hold the source to be index, which is the bytes array). How big is each index request you have, I mean, what is the size of each document end up being? Does it add up to the memory used?\n\nNothing jumps to mind with changes we did around it. What is the behavior in 0.90.2? How much memory is it using?\n\nAs a side note, 25k index requests is probably too much in how much it ends up with size in bytes per request (assuming its correct). You don't want to send a 100mb bulk request, probably make sense to make that smaller so it will be more efficient on the network (probably between 10-20mb).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23874730","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23874730","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23874730,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODc0NzMw","user":{"login":"arey","id":838318,"node_id":"MDQ6VXNlcjgzODMxOA==","avatar_url":"https://avatars2.githubusercontent.com/u/838318?v=4","gravatar_id":"","url":"https://api.github.com/users/arey","html_url":"https://github.com/arey","followers_url":"https://api.github.com/users/arey/followers","following_url":"https://api.github.com/users/arey/following{/other_user}","gists_url":"https://api.github.com/users/arey/gists{/gist_id}","starred_url":"https://api.github.com/users/arey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arey/subscriptions","organizations_url":"https://api.github.com/users/arey/orgs","repos_url":"https://api.github.com/users/arey/repos","events_url":"https://api.github.com/users/arey/events{/privacy}","received_events_url":"https://api.github.com/users/arey/received_events","type":"User","site_admin":false},"created_at":"2013-09-05T15:08:54Z","updated_at":"2013-09-05T15:49:27Z","author_association":"CONTRIBUTOR","body":"Thanks Kimchy for your answer.\nAs you can see, JSON document sources are very small (between 500 bytes and 1Kb in a text editor).\nHere an anonymous example :\n\n``` javascript\n{\n    _index: customers\n    _id: customer\n    _version: 1378062062000\n    _score: 1\n    _source: {\n        identifiantadb: 92492430\n        identifiantclientagent: z1234\n        identifiantintermediaire: 987654\n        codepopulation: AZE\n        statutclient: PP\n        idxnaturepersonne: PART\n        civilite: 01\n        prenom: Jean\n        codepostal: 75001\n        localite: PARIS\n        identifiantrcedisplay: 0124924655\n        identifiantclientagentdisplay: C0156\n        idstatutclient: 2\n        nompersonne: DUPONT\n        adressedisplay: 2 RUE DE PARIS\n        codepostalprincipal: 78380\n        localiteprincipale: BOUGIVAL\n        telephoneprincipal: 0102030405\n        telephones: 0102030405\n    }\n}\n```\n\nSo 25k index requets (5 threads x 1 bulk request of 5000 index requests) of 1Kb bytes max should required 15 Mb of memory. I really don't understand why 800 Mb seems to be used. A BulkRequest contains 5000 index requets thus should have a size of 5Mb.\n\nPreviously, with the ES 0.90.2 client, the memory allocation was much lower. I have done some memory snapshots to reach the same number of IndexRequest\nThe following screenshot has 25k IndexRequest like the upper one. Compared to the 800 Mb of the 0.90.3, only 29 Mb are used wigth the 0.90.2 :\n\n![batch_memory_live_objects_0 19 2](https://f.cloud.github.com/assets/838318/1089009/7ac9753c-163c-11e3-9450-436761420a63.jpg)\n\nHow to explain why 26 as much memory are required?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23909167","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23909167","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23909167,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTA5MTY3","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-05T23:28:23Z","updated_at":"2013-09-05T23:36:03Z","author_association":"MEMBER","body":"Thats very strange then... . Since there are different ways to use the bulk API, si there a chance for a stand alone simple recreation of this (with dummy data for example?). This will make figuring this out on my end much faster (I will try nonetheless). If you can do it quickly, I can try and see if there is a problem, to get it fixed for the 0.90.4 release (slated for early next week...).\n\n[Update]: Also, I assume, but just double checking, that the code on your end is exactly the same, and you just replace the ES jar file.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23909725","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23909725","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23909725,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTA5NzI1","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-05T23:41:49Z","updated_at":"2013-09-05T23:41:49Z","author_association":"MEMBER","body":"Mmm, I think I found where its coming from..., we changed the default value for our output stream (`BytesStreamOutput`) initial array size to `32k`, which makes sense in most cases, but potentially not in your case (this is the output stream we create for each XContentBuilder you create). Might make sense to reduce it when building a document using XContent.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23909799","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23909799","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23909799,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTA5Nzk5","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-05T23:44:20Z","updated_at":"2013-09-05T23:44:20Z","author_association":"MEMBER","body":"Btw, you can work around it by creating your own XContentBuilder while providing the `BytesOutputStream` for it yourself, with a size value.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23911469","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23911469","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23911469,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTExNDY5","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-06T00:26:38Z","updated_at":"2013-09-06T00:26:38Z","author_association":"MEMBER","body":"I fixed it in #3638, should be good now, will be part of next 0.90.4. Feel free to reopen if you still have problems!.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23931190","html_url":"https://github.com/elastic/elasticsearch/issues/3624#issuecomment-23931190","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","id":23931190,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTMxMTkw","user":{"login":"arey","id":838318,"node_id":"MDQ6VXNlcjgzODMxOA==","avatar_url":"https://avatars2.githubusercontent.com/u/838318?v=4","gravatar_id":"","url":"https://api.github.com/users/arey","html_url":"https://github.com/arey","followers_url":"https://api.github.com/users/arey/followers","following_url":"https://api.github.com/users/arey/following{/other_user}","gists_url":"https://api.github.com/users/arey/gists{/gist_id}","starred_url":"https://api.github.com/users/arey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arey/subscriptions","organizations_url":"https://api.github.com/users/arey/orgs","repos_url":"https://api.github.com/users/arey/repos","events_url":"https://api.github.com/users/arey/events{/privacy}","received_events_url":"https://api.github.com/users/arey/received_events","type":"User","site_admin":false},"created_at":"2013-09-06T10:25:34Z","updated_at":"2013-09-06T10:25:34Z","author_association":"CONTRIBUTOR","body":"Thank you  Kimchy for having found the origin of my problem and fix it in the 0.90.4 version.\nAt the moment, I don't know if we could wait the ES release next week. I will check.\nBy waiting, I used your suggestion to instantiate by myself the BytesStreamOutput with a size of 1024.\n\n``` java\nXContentBuilder content = new XContentBuilder(JsonXContent.jsonXContent, new BytesStreamOutput(1024)).startObject();\n```\n\nI relanch the batch with a Xmx of 512 and my OutOfMemoryError goes away.\nSo, if we can't wait the 0.90.4 release, I have a work around.\n","performed_via_github_app":null}]