{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16723","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16723/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16723/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16723/events","html_url":"https://github.com/elastic/elasticsearch/issues/16723","id":134693572,"node_id":"MDU6SXNzdWUxMzQ2OTM1NzI=","number":16723,"title":"NullPointerException in InternalClusterService.add() using TransportClient","user":{"login":"EdHowe","id":8709190,"node_id":"MDQ6VXNlcjg3MDkxOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/8709190?v=4","gravatar_id":"","url":"https://api.github.com/users/EdHowe","html_url":"https://github.com/EdHowe","followers_url":"https://api.github.com/users/EdHowe/followers","following_url":"https://api.github.com/users/EdHowe/following{/other_user}","gists_url":"https://api.github.com/users/EdHowe/gists{/gist_id}","starred_url":"https://api.github.com/users/EdHowe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EdHowe/subscriptions","organizations_url":"https://api.github.com/users/EdHowe/orgs","repos_url":"https://api.github.com/users/EdHowe/repos","events_url":"https://api.github.com/users/EdHowe/events{/privacy}","received_events_url":"https://api.github.com/users/EdHowe/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-18T20:54:37Z","updated_at":"2016-02-24T02:07:36Z","closed_at":"2016-02-24T02:07:36Z","author_association":"NONE","active_lock_reason":null,"body":"We are using a TransportClient to connect to ES 2.2.0, and getting the following NullPointerException:\n\n! java.lang.NullPointerException: null\n! at org.elasticsearch.cluster.service.InternalClusterService.add(InternalClusterService.java:281) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.cluster.ClusterStateObserver.waitForNextChange(ClusterStateObserver.java:154) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.cluster.ClusterStateObserver.waitForNextChange(ClusterStateObserver.java:99) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.retry(TransportMasterNodeAction.java:190) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.doStart(TransportMasterNodeAction.java:164) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.start(TransportMasterNodeAction.java:121) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:93) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:50) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:70) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.HandledTransportAction$TransportHandler.messageReceived(HandledTransportAction.java:45) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.action.support.HandledTransportAction$TransportHandler.messageReceived(HandledTransportAction.java:41) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.transport.netty.MessageChannelHandler.handleRequest(MessageChannelHandler.java:244) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(MessageChannelHandler.java:114) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:443) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:303) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791) ~[netty-3.10.5.Final.jar:na]\n! at org.elasticsearch.common.netty.OpenChannelsHandler.handleUpstream(OpenChannelsHandler.java:75) ~[elasticsearch-2.2.0.jar:2.2.0]\n! at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108) ~[netty-3.10.5.Final.jar:na]\n! at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42) ~[netty-3.10.5.Final.jar:na]\n! at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_65]\n! at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_65]\n! at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_65]\n\nWe can reproduce this fairly often in our system tests, which starts an ES instance right before starting our client application.  The client application will create a TransportClient, then immediately do a health status check and wait for a yellow status.  If we put a sleep() between creating the TransportClient and the health check, the problem doesn't manifest.\n\nInternalClusterService has an updateTasksExecutor that gets populated by the doStart() method.  The InternalClusterService, however, only appears to be started via Node.start(), which is started via Bootstrap.start(), which is only called by Elasticsearch.main().  In other words, the updateTasksExecutor is only populated when the ES server is run, not when an ES client is used.\n\nThe stacktrace above appears to be related to the Transport starting up and not finding a master node.  It then creates a listener to watch for changes to the master node, and tries to add this to the updateTasksExecutor of InternalClusterService, which based on the above paragraph, is null.\n\nI believe we are running into this because we are starting ES immediately before starting our client app, and connecting before a master node has been determined.\n\nRegards,\nEd Howe\nNexidia, Inc.\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}