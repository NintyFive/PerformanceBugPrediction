{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21832","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21832/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21832/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21832/events","html_url":"https://github.com/elastic/elasticsearch/issues/21832","id":192061114,"node_id":"MDU6SXNzdWUxOTIwNjExMTQ=","number":21832,"title":"Java native custom plugin issue with ES 5.0","user":{"login":"rboorugu","id":10870862,"node_id":"MDQ6VXNlcjEwODcwODYy","avatar_url":"https://avatars0.githubusercontent.com/u/10870862?v=4","gravatar_id":"","url":"https://api.github.com/users/rboorugu","html_url":"https://github.com/rboorugu","followers_url":"https://api.github.com/users/rboorugu/followers","following_url":"https://api.github.com/users/rboorugu/following{/other_user}","gists_url":"https://api.github.com/users/rboorugu/gists{/gist_id}","starred_url":"https://api.github.com/users/rboorugu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rboorugu/subscriptions","organizations_url":"https://api.github.com/users/rboorugu/orgs","repos_url":"https://api.github.com/users/rboorugu/repos","events_url":"https://api.github.com/users/rboorugu/events{/privacy}","received_events_url":"https://api.github.com/users/rboorugu/received_events","type":"User","site_admin":false},"labels":[{"id":146832994,"node_id":"MDU6TGFiZWwxNDY4MzI5OTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Plugins","name":":Core/Infra/Plugins","color":"0e8a16","default":false,"description":"Plugin API and infrastructure"},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-11-28T17:05:43Z","updated_at":"2016-12-01T22:49:14Z","closed_at":"2016-12-01T22:48:59Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**:\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\n\r\n**OS version**:\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n 1.\r\n 2.\r\n 3.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\nWe use a java plugin with elastic search which implements Map Reduce, have made necessary changes to load it in ES 5.0, but am not able to find an answer for one of it - detailed description below.\r\n\r\nBelow is code for INIT which used to work fine in ES2.0 which initializes resultIds, citedIds for some reason i am not able to access these variables in MapScript - i get a null pointer exception. \r\n\r\n\r\n public static class ForeciteInitScriptFactory implements NativeScriptFactory {\r\n\r\n        @Override\r\n        @SuppressWarnings(\"unchecked\")\r\n        public ExecutableScript newScript(final Map<String, Object> params) {\r\n            return new AbstractExecutableScript() {\r\n                @Override\r\n                public Object run() {\r\n                    Map<String, Object> agg = new HashMap<String, Object>();\r\n                    agg.put(\"resultIds\", new ArrayList<Integer>());\r\n                    agg.put(\"citedIds\", new ArrayList<Integer>());                    \r\n                    params.put(\"_agg\", agg);\r\n                    return null;\r\n                }\r\n            };\r\n        }\r\n\r\n        @Override\r\n        public boolean needsScores() {\r\n            return false;\r\n        }\r\n    }    \r\n\r\n\r\nI've made some changes  to make it work in 5.0 (changes below) but i am still not sure why above is not working - i basically removed everything from AbstractExecutableScript and put it inside of newScript?\r\n\r\n    public class ForeciteInitScriptFactory implements NativeScriptFactory {\r\n\r\n        @Override\r\n        @SuppressWarnings(\"unchecked\")\r\n        public ExecutableScript newScript(final Map<String, Object> params) {\r\n            Map<String, Object> agg = new HashMap<String, Object>();\r\n                    agg.put(\"resultIds\", new ArrayList<Integer>());\r\n                    agg.put(\"citedIds\", new ArrayList<Integer>());\r\n                    params.put(\"_agg\", agg);\r\n            /*Logger logger = LogManager.getLogger(ForecitePlugin.class.getName());\r\n                    logger.info(\"logging start here IntScript before run: RB\");\r\n                    logger.info(params);*/\r\n                    //return params;\r\n            return new AbstractExecutableScript() {\r\n                 @Override\r\n                public Object run() {                         \r\n                    return null;\r\n                }\r\n            };\r\n        }\r\n\r\n        @Override\r\n        public boolean needsScores() {\r\n            return false;\r\n        }\r\n\r\n\t\t@Override\r\n\t\tpublic String getName() {\r\n\t\t\t// TODO Auto-generated method stub\r\n\t\t\treturn \"forecite_init\";\r\n\t\t}\r\n    }","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}