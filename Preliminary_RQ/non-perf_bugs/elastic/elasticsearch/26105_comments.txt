[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321079355","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321079355","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321079355,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTA3OTM1NQ==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2017-08-08T20:56:12Z","updated_at":"2017-08-08T20:56:12Z","author_association":"MEMBER","body":"For the record, same thread as https://discuss.elastic.co/t/accessing-topdocs-from-a-leafscorefunction/96336","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321212079","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321212079","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321212079,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTIxMjA3OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-09T10:04:17Z","updated_at":"2017-08-09T10:04:17Z","author_association":"MEMBER","body":"The solution described in the forum should suit your needs so I am going to close this issue. Accessing the score of the query directly through `subQueryScore` is much cleaner than `SearchContext.current` so there is no regression here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321326916","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321326916","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321326916,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTMyNjkxNg==","user":{"login":"ethteck","id":2985314,"node_id":"MDQ6VXNlcjI5ODUzMTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/2985314?v=4","gravatar_id":"","url":"https://api.github.com/users/ethteck","html_url":"https://github.com/ethteck","followers_url":"https://api.github.com/users/ethteck/followers","following_url":"https://api.github.com/users/ethteck/following{/other_user}","gists_url":"https://api.github.com/users/ethteck/gists{/gist_id}","starred_url":"https://api.github.com/users/ethteck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethteck/subscriptions","organizations_url":"https://api.github.com/users/ethteck/orgs","repos_url":"https://api.github.com/users/ethteck/repos","events_url":"https://api.github.com/users/ethteck/events{/privacy}","received_events_url":"https://api.github.com/users/ethteck/received_events","type":"User","site_admin":false},"created_at":"2017-08-09T17:36:27Z","updated_at":"2017-08-09T17:36:27Z","author_association":"NONE","body":"I'm requesting that this be re-opened due to @rjernst's reply in the discussion linked earlier. The functionality of `subQueryScore` unfortunately does not satisfy what we are looking for.\r\n\r\nIn essence, we would like some way to get at the `SearchContext` now that the ability to get the \"current\" `SearchContext` is gone. Other things we prefer to be able to see that we used to get from the `SearchContext`: `numberOfShards()`, `rescore()`, `size()`\r\n\r\nI'm not sure if this makes sense from a design standpoint, but would it be possible for the `SearchContext` to be accessible via some other context, such as `QueryShardContext`?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321557678","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321557678","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321557678,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTU1NzY3OA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T13:53:56Z","updated_at":"2017-08-10T13:53:56Z","author_association":"MEMBER","body":"IMO the SearchContext is an internal thing that the function score should not be aware of. The fact that it was accessible before was I think not intentional (at least inside the implementation of a custom query).\r\nIf your function score depends on other factors (size or rescore) maybe you could simply copy them directly in your custom function score definition ? This would require some additional arguments and parsing on your plugin but it would make your function score more robust to internal changes in es ? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321574870","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321574870","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321574870,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTU3NDg3MA==","user":{"login":"ethteck","id":2985314,"node_id":"MDQ6VXNlcjI5ODUzMTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/2985314?v=4","gravatar_id":"","url":"https://api.github.com/users/ethteck","html_url":"https://github.com/ethteck","followers_url":"https://api.github.com/users/ethteck/followers","following_url":"https://api.github.com/users/ethteck/following{/other_user}","gists_url":"https://api.github.com/users/ethteck/gists{/gist_id}","starred_url":"https://api.github.com/users/ethteck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethteck/subscriptions","organizations_url":"https://api.github.com/users/ethteck/orgs","repos_url":"https://api.github.com/users/ethteck/repos","events_url":"https://api.github.com/users/ethteck/events{/privacy}","received_events_url":"https://api.github.com/users/ethteck/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T14:51:04Z","updated_at":"2017-08-10T14:51:04Z","author_association":"NONE","body":">  simply copy them directly in your custom function score definition\r\n\r\nCould you expand upon this? If there's any other way I can get at these things (TopDocs, size, rescore), that's really all we're looking to do.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321578301","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321578301","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321578301,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTU3ODMwMQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T15:02:45Z","updated_at":"2017-08-10T15:02:45Z","author_association":"MEMBER","body":"I am just saying that you could copy the size and the rescore definition in the function score and parse them in your custom function score. Regarding the TopDocs I don't understand how you could access them during the query since they are filled only at the end.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321583506","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321583506","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321583506,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTU4MzUwNg==","user":{"login":"ethteck","id":2985314,"node_id":"MDQ6VXNlcjI5ODUzMTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/2985314?v=4","gravatar_id":"","url":"https://api.github.com/users/ethteck","html_url":"https://github.com/ethteck","followers_url":"https://api.github.com/users/ethteck/followers","following_url":"https://api.github.com/users/ethteck/following{/other_user}","gists_url":"https://api.github.com/users/ethteck/gists{/gist_id}","starred_url":"https://api.github.com/users/ethteck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethteck/subscriptions","organizations_url":"https://api.github.com/users/ethteck/orgs","repos_url":"https://api.github.com/users/ethteck/repos","events_url":"https://api.github.com/users/ethteck/events{/privacy}","received_events_url":"https://api.github.com/users/ethteck/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T15:19:35Z","updated_at":"2017-08-10T15:19:35Z","author_association":"NONE","body":"Wouldn't this require users to enter these values twice, both in the query and again in the rescore function?\r\n\r\n```\r\n{\r\n\"explain\": true,\r\n\"query\": {\r\n    \"match\": {\r\n        \"primary_name\": \"Abdallah Ghmori\"\r\n    }\r\n},\r\n\"rescore\": {\r\n    \"window_size\": 200,\r\n    \"query\": {\r\n        \"rescore_query\": {\r\n            \"function_score\": {\r\n                \"name_score\": {\r\n                    \"window_size\": 200,\r\n                    \"size\": 100,\r\n                    \"field\": \"primary_name\",\r\n                    \"query_name\": \"Abdallah Ghmori\"\r\n                }\r\n            }\r\n        },\r\n        \"query_weight\": 0.0\r\n    }\r\n},\r\n\"size\": 100\r\n}\r\n```\r\n\r\nOr are you saying there's some way to access these already-parsed values from the ScoreFunctionParser?\r\n\r\nThe TopDocs have always been present for us in the past at rescore time, via the SearchContext. Haven't they already all been collected in a prior phase?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321586267","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321586267","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321586267,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTU4NjI2Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T15:28:38Z","updated_at":"2017-08-10T15:28:38Z","author_association":"MEMBER","body":"> Wouldn't this require users to enter these values twice, both in the query and again in the rescore function?\r\n\r\nYes the idea is to copy these values in the function score definition like in your example.\r\n\r\n> The TopDocs have always been present for us in the past at rescore time, via the SearchContext. Haven't they already all been collected in a prior phase?\r\n\r\nI didn't understand that you were on the rescore side. So yep they are available in the context when doing the rescore but it seems weird to allow a rescore query to access them all at once since they will be pass to your function_score one by one for rescoring. What kind of informations are you extracting from the top_docs ? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321601060","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321601060","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321601060,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTYwMTA2MA==","user":{"login":"ethteck","id":2985314,"node_id":"MDQ6VXNlcjI5ODUzMTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/2985314?v=4","gravatar_id":"","url":"https://api.github.com/users/ethteck","html_url":"https://github.com/ethteck","followers_url":"https://api.github.com/users/ethteck/followers","following_url":"https://api.github.com/users/ethteck/following{/other_user}","gists_url":"https://api.github.com/users/ethteck/gists{/gist_id}","starred_url":"https://api.github.com/users/ethteck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethteck/subscriptions","organizations_url":"https://api.github.com/users/ethteck/orgs","repos_url":"https://api.github.com/users/ethteck/repos","events_url":"https://api.github.com/users/ethteck/events{/privacy}","received_events_url":"https://api.github.com/users/ethteck/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T16:19:52Z","updated_at":"2017-08-10T16:19:52Z","author_association":"NONE","body":"Okay. While this is definitely a possibility, I'd say it's pretty inconvenient for the user and relies on them to remember to put the same things in multiple places in the query.\r\n\r\nWe look at the TopDocs.scoreDocs to get the original query scores, and we have a function that compute a minimum score threshold based off of these scores. We use this threshold to decide whether we should perform our expensive rescore on a doc or not. Our function needs to be able to iterate over these scores, which we used to get from `SearchContext.current().queryResult().topDocs().scoreDocs`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321605953","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321605953","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321605953,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTYwNTk1Mw==","user":{"login":"ethteck","id":2985314,"node_id":"MDQ6VXNlcjI5ODUzMTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/2985314?v=4","gravatar_id":"","url":"https://api.github.com/users/ethteck","html_url":"https://github.com/ethteck","followers_url":"https://api.github.com/users/ethteck/followers","following_url":"https://api.github.com/users/ethteck/following{/other_user}","gists_url":"https://api.github.com/users/ethteck/gists{/gist_id}","starred_url":"https://api.github.com/users/ethteck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethteck/subscriptions","organizations_url":"https://api.github.com/users/ethteck/orgs","repos_url":"https://api.github.com/users/ethteck/repos","events_url":"https://api.github.com/users/ethteck/events{/privacy}","received_events_url":"https://api.github.com/users/ethteck/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T16:37:18Z","updated_at":"2017-08-10T16:37:18Z","author_association":"NONE","body":"> seems weird to allow a rescore query to access them all at once since they will be pass to your function_score one by one for rescoring\r\n\r\nAlso, unfortunately, this isn't quite working either. I assume you're talking about the `subQueryScore` field in `LeafScoreFunction.score`. I [discussed this](https://discuss.elastic.co/t/accessing-topdocs-from-a-leafscorefunction/96336/4?u=ethanroseman) with @rjernst and he deemed that it's not giving us the score we actually want.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321625926","html_url":"https://github.com/elastic/elasticsearch/issues/26105#issuecomment-321625926","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26105","id":321625926,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTYyNTkyNg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T17:53:00Z","updated_at":"2017-08-10T17:53:29Z","author_association":"MEMBER","body":"Sorry I missed the discussion in the forum. Yes the `subQueryScore` is the score of the rescore query so in your case a `match_all` query.  I still don't think that accessing the information you want through the SearchContext is the right solution. I am sure we can find something less hacky so let's continue the discussion here https://discuss.elastic.co/t/accessing-topdocs-from-a-leafscorefunction/96336 (thanks for opening this). ","performed_via_github_app":null}]