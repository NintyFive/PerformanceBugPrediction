{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24910","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24910/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24910/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24910/events","html_url":"https://github.com/elastic/elasticsearch/issues/24910","id":231687911,"node_id":"MDU6SXNzdWUyMzE2ODc5MTE=","number":24910,"title":"Function score queries with score_mode sum and a total weight of 0 always return a score of 1","user":{"login":"csben","id":28986189,"node_id":"MDQ6VXNlcjI4OTg2MTg5","avatar_url":"https://avatars3.githubusercontent.com/u/28986189?v=4","gravatar_id":"","url":"https://api.github.com/users/csben","html_url":"https://github.com/csben","followers_url":"https://api.github.com/users/csben/followers","following_url":"https://api.github.com/users/csben/following{/other_user}","gists_url":"https://api.github.com/users/csben/gists{/gist_id}","starred_url":"https://api.github.com/users/csben/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/csben/subscriptions","organizations_url":"https://api.github.com/users/csben/orgs","repos_url":"https://api.github.com/users/csben/repos","events_url":"https://api.github.com/users/csben/events{/privacy}","received_events_url":"https://api.github.com/users/csben/received_events","type":"User","site_admin":false},"labels":[{"id":418189364,"node_id":"MDU6TGFiZWw0MTgxODkzNjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Ranking","name":":Search/Ranking","color":"0e8a16","default":false,"description":"Scoring, rescoring, rank evaluation."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2017-05-26T17:26:34Z","updated_at":"2018-08-27T16:26:02Z","closed_at":"2018-08-27T16:26:02Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.1.2 and 5.3.2\r\n\r\n**JVM version**: 1.8.0_111 and 1.8.0_131\r\n\r\n**OS version**: 4.4.0-75-generic and 2.6.32-642.13.1.el6.x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nConsider the following query:\r\n```\r\ncurl -XPOST http://localhost:9200/test/_search -d '{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": { \"match_all\": {} },\r\n        \"functions\": [\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\": 1 } },\r\n                \"weight\": 1\r\n             },\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\":1 } },\r\n                \"script_score\": {\r\n                  \"script\": \"-1\"\r\n                }, \r\n                \"weight\": -1\r\n             }\r\n        ],\r\n        \"score_mode\": \"sum\",\r\n        \"boost_mode\": \"replace\"\r\n      }\r\n  }\r\n}' | jq \r\n```\r\nIn principle, this should produce a score of 2 (with a contribution of 1 from each filter) for any event with `test_value = 1`.  However, this query will always produce a score of 1.  Any pair of functions with a weight of 1 and weight of -1 will produce a score of 1.  Any set of functions where the sum of the weights is 0 will produce a score of 1.\r\n\r\nI think the bug is in `FiltersFunctionScoreQuery.java` around line 311.\r\n\r\n```\r\n                default: // Avg / Total\r\n                    double totalFactor = 0.0f;\r\n                    double weightSum = 0;\r\n                    for (int i = 0; i < filterFunctions.length; i++) {\r\n                        if (docSets[i].get(docId)) {\r\n                            totalFactor += functions[i].score(docId, subQueryScore);\r\n                            if (filterFunctions[i].function instanceof WeightFactorFunction) {\r\n                                weightSum += ((WeightFactorFunction) filterFunctions[i].function).getWeight();\r\n                            } else {\r\n                                weightSum += 1.0;\r\n                            }\r\n                        }\r\n                    }\r\n                    if (weightSum != 0) {\r\n                        factor = totalFactor;\r\n                        if (scoreMode == ScoreMode.AVG) {\r\n                            factor /= weightSum;\r\n                        }\r\n                    }\r\n                    break;\r\n            }\r\n            return factor;\r\n```\r\n\r\nThere is an if-statement checking if the `weightSum` is zero, presumably to avoid a divide by zero when computing the weighted average.  However, since the same block of code is used to compute a straightforward weighted sum (not just a weighted average), this if-statement results in the method returning the default value for `factor` which is 1.  I believe if we are computing a weighted sum, we should just set `factor = totalFactor` with no dependence on the value of `weightSum`.\r\n\r\n**Steps to reproduce**:\r\n```\r\ncurl -XPUT http://localhost:9200/test -d '{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"test_value\": {\r\n          \"type\": \"integer\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -XPOST http://localhost:9200/test/test -d '{\r\n  \"test_value\": 1\r\n}'\r\n\r\n# Returns a score of 2.1 as expected\r\ncurl -XPOST http://localhost:9200/test/_search -d '{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": { \"match_all\": {} },\r\n        \"functions\": [\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\": 1 } },\r\n                \"weight\": 1\r\n             },\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\":1 } },\r\n                \"script_score\": {\r\n                  \"script\": \"-1\"\r\n                }, \r\n                \"weight\": -1.1\r\n             }\r\n        ],\r\n        \"score_mode\": \"sum\",\r\n        \"boost_mode\": \"replace\"\r\n      }\r\n  }\r\n}' | jq \r\n\r\n# Returns a score of 1 instead of the expected score of 2\r\ncurl -XPOST http://localhost:9200/test/_search -d '{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": { \"match_all\": {} },\r\n        \"functions\": [\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\": 1 } },\r\n                \"weight\": 1\r\n             },\r\n             {\r\n                \"filter\": { \"match\": { \"test_value\":1 } },\r\n                \"script_score\": {\r\n                  \"script\": \"-1\"\r\n                }, \r\n                \"weight\": -1\r\n             }\r\n        ],\r\n        \"score_mode\": \"sum\",\r\n        \"boost_mode\": \"replace\"\r\n      }\r\n  }\r\n}' | jq \r\n```\r\n","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}