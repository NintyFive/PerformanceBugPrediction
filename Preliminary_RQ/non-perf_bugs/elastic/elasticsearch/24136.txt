{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24136","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24136/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24136/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24136/events","html_url":"https://github.com/elastic/elasticsearch/issues/24136","id":222190237,"node_id":"MDU6SXNzdWUyMjIxOTAyMzc=","number":24136,"title":"Unexpected 'MatchNoDocsQuery' in Validate API explanation when using analyzer with common_grams","user":{"login":"eseli","id":27698773,"node_id":"MDQ6VXNlcjI3Njk4Nzcz","avatar_url":"https://avatars3.githubusercontent.com/u/27698773?v=4","gravatar_id":"","url":"https://api.github.com/users/eseli","html_url":"https://github.com/eseli","followers_url":"https://api.github.com/users/eseli/followers","following_url":"https://api.github.com/users/eseli/following{/other_user}","gists_url":"https://api.github.com/users/eseli/gists{/gist_id}","starred_url":"https://api.github.com/users/eseli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eseli/subscriptions","organizations_url":"https://api.github.com/users/eseli/orgs","repos_url":"https://api.github.com/users/eseli/repos","events_url":"https://api.github.com/users/eseli/events{/privacy}","received_events_url":"https://api.github.com/users/eseli/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-04-17T18:12:30Z","updated_at":"2017-04-18T09:09:49Z","closed_at":"2017-04-18T09:09:49Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.3.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_121\r\n\r\n**OS version**: centos 7.3.1611\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThis began with our recent upgrade to version 5.3.0. (from 2.3.3)\r\n\r\nUsing the validate API for this match_query:\r\n\r\n```\r\ncurl -XPOST 'http://es-books06.lo:19200/test_20170414_104653/item/_validate/query?rewrite=true?pretty=true' -d '\r\n{\r\n  \"query\" : {\r\n    \"multi_match\" : {\r\n      \"query\" : \"tools of titans\",\r\n      \"fields\" : [\"name^5.0\", \"short_name^4.0\"],\r\n      \"analyzer\": \"text_stemmer_search_analyzer\",\r\n      \"type\" : \"best_fields\"\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\nProvides this a 'MatchNoDocsQuery ' response as a query explanation:\r\n\r\n```\r\n{\"valid\":true,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"explanations\":[{\"index\":\"test_20170414_104653\",\"valid\":true,\"explanation\":\"+((MatchNoDocsQuery[\\\"Matching no documents because no terms present.\\\"])^5.0 | (MatchNoDocsQuery[\\\"Matching no documents because no terms present.\\\"])^4.0) #(ConstantScore(MatchNoDocsQuery(\\\"empty BooleanQuery\\\")))^0.0\"}]}\r\n```\r\n\r\nI expected an explanation using the fields 'name' & 'short_name' (see index settings).\r\nA simple '_analyze' call using the same analyzer ('text_stemmer_search_analyzer') gives:\r\n\r\n```\r\n$ curl -XPOST 'http://www.lo:8251/categories_production/_analyze?pretty=true' -d ' \r\n{\r\n  \"analyzer\": \"text_stemmer_search_analyzer\",\r\n  \"text\":     \"tools of titans\"\r\n}'\r\n{\r\n  \"tokens\" : [\r\n    {\r\n      \"token\" : \"tool_of\",\r\n      \"start_offset\" : 0,\r\n      \"end_offset\" : 8,\r\n      \"type\" : \"gram\",\r\n      \"position\" : 0,\r\n      \"positionLength\" : 2\r\n    },\r\n    {\r\n      \"token\" : \"of_titan\",\r\n      \"start_offset\" : 6,\r\n      \"end_offset\" : 15,\r\n      \"type\" : \"gram\",\r\n      \"position\" : 1,\r\n      \"positionLength\" : 2\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\nI built an small, empty index with the following settings to reproduce the problem:\r\n\r\n```\r\n$ curl -XGET 'http://www.lo:8251/test_20170414_104653?pretty=true'\r\n{\r\n  \"test_20170414_104653\" : {\r\n    \"aliases\" : { },\r\n    \"mappings\" : {\r\n      \"item\" : {\r\n        \"_all\" : {\r\n          \"enabled\" : false\r\n        },\r\n        \"properties\" : {\r\n          \"id\" : {\r\n            \"type\" : \"long\"\r\n          },\r\n          \"name\" : {\r\n            \"type\" : \"text\",\r\n            \"analyzer\" : \"text_stemmer_analyzer\",\r\n            \"search_analyzer\" : \"text_stemmer_search_analyzer\"\r\n          },\r\n          \"short_name\" : {\r\n            \"type\" : \"text\",\r\n            \"analyzer\" : \"text_stemmer_analyzer\",\r\n            \"search_analyzer\" : \"text_stemmer_search_analyzer\"\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"search\" : {\r\n          \"slowlog\" : {\r\n            \"threshold\" : {\r\n              \"fetch\" : {\r\n                \"warn\" : \"1s\",\r\n                \"trace\" : \"200ms\",\r\n                \"debug\" : \"500ms\",\r\n                \"info\" : \"800ms\"\r\n              },\r\n              \"query\" : {\r\n                \"warn\" : \"10s\",\r\n                \"trace\" : \"500ms\",\r\n                \"debug\" : \"2s\",\r\n                \"info\" : \"5s\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"refresh_interval\" : \"-1\",\r\n        \"indexing\" : {\r\n          \"slowlog\" : {\r\n            \"threshold\" : {\r\n              \"index\" : {\r\n                \"warn\" : \"10s\",\r\n                \"trace\" : \"500ms\",\r\n                \"debug\" : \"2s\",\r\n                \"info\" : \"5s\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"number_of_shards\" : \"1\",\r\n        \"provided_name\" : \"test_20170414_104653\",\r\n        \"mapper\" : {\r\n          \"dynamic\" : \"false\"\r\n        },\r\n        \"creation_date\" : \"1492192013925\",\r\n        \"analysis\" : {\r\n          \"filter\" : {\r\n            \"my_common_grams_query\" : {\r\n              \"common_words_path\" : \"/etc/elasticsearch/common.txt\",\r\n              \"ignore_case\" : \"true\",\r\n              \"type\" : \"common_grams\",\r\n              \"query_mode\" : \"true\"\r\n            },\r\n            \"my_stemmer\" : {\r\n              \"name\" : \"english\",\r\n              \"type\" : \"stemmer\"\r\n            },\r\n            \"my_common_grams\" : {\r\n              \"common_words_path\" : \"/etc/elasticsearch/common.txt\",\r\n              \"ignore_case\" : \"true\",\r\n              \"type\" : \"common_grams\"\r\n            },\r\n            \"my_word_delimiter\" : {\r\n              \"split_on_numerics\" : \"false\",\r\n              \"generate_word_parts\" : \"true\",\r\n              \"preserve_original\" : \"true\",\r\n              \"catenate_words\" : \"true\",\r\n              \"generate_number_parts\" : \"true\",\r\n              \"catenate_all\" : \"true\",\r\n              \"split_on_case_change\" : \"true\",\r\n              \"type\" : \"word_delimiter\",\r\n              \"type_table\" : [\r\n                \"\\\\u0020 => ALPHANUM\"\r\n              ],\r\n              \"catenate_numbers\" : \"true\",\r\n              \"stem_english_possessive\" : \"true\"\r\n            },\r\n            \"my_word_delimiter_query\" : {\r\n              \"split_on_numerics\" : \"false\",\r\n              \"generate_word_parts\" : \"true\",\r\n              \"preserve_original\" : \"true\",\r\n              \"catenate_words\" : \"false\",\r\n              \"generate_number_parts\" : \"true\",\r\n              \"catenate_all\" : \"false\",\r\n              \"split_on_case_change\" : \"true\",\r\n              \"type\" : \"word_delimiter\",\r\n              \"type_table\" : [\r\n                \"\\\\u0020 => ALPHANUM\"\r\n              ],\r\n              \"catenate_numbers\" : \"false\",\r\n              \"stem_english_possessive\" : \"true\"\r\n            }\r\n          },\r\n          \"char_filter\" : {\r\n            \"my_char_filter\" : {\r\n              \"type\" : \"mapping\",\r\n              \"mappings\" : [\r\n                \"\\\\u0026=>and\"\r\n              ]\r\n            }\r\n          },\r\n          \"analyzer\" : {\r\n            \"text_stemmer_search_analyzer\" : {\r\n              \"filter\" : [\r\n                \"asciifolding\",\r\n                \"my_word_delimiter_query\",\r\n                \"lowercase\",\r\n                \"my_stemmer\",\r\n                \"my_common_grams_query\"\r\n              ],\r\n              \"char_filter\" : [\r\n                \"my_char_filter\"\r\n              ],\r\n              \"type\" : \"custom\",\r\n              \"tokenizer\" : \"whitespace\"\r\n            },\r\n            \"text_stemmer_analyzer\" : {\r\n              \"filter\" : [\r\n                \"asciifolding\",\r\n                \"my_word_delimiter\",\r\n                \"lowercase\",\r\n                \"my_stemmer\",\r\n                \"my_common_grams\"\r\n              ],\r\n              \"char_filter\" : [\r\n                \"my_char_filter\"\r\n              ],\r\n              \"type\" : \"custom\",\r\n              \"tokenizer\" : \"whitespace\"\r\n            }\r\n          },\r\n          \"tokenizer\" : {\r\n            \"title_tokenizer_autocompleter\" : {\r\n              \"type\" : \"whitespace\"\r\n            }\r\n          }\r\n        },\r\n        \"number_of_replicas\" : \"0\",\r\n        \"uuid\" : \"Ad7UZEScS5qEwt2OGY2E9w\",\r\n        \"version\" : {\r\n          \"created\" : \"5030099\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n**Steps to reproduce**:\r\n 1. Using index setting above on version 5.3.0\r\n 2. Execute\r\n```\r\ncurl -XPOST 'http://es-books06.lo:19200/test_20170414_104653/item/_validate/query?rewrite=true?pretty=true' -d '\r\n{\r\n  \"query\" : {\r\n    \"multi_match\" : {\r\n      \"query\" : \"tools of titans\",\r\n      \"fields\" : [\"name^5.0\", \"short_name^4.0\"],\r\n      \"analyzer\": \"text_stemmer_search_analyzer\",\r\n      \"type\" : \"best_fields\"\r\n    }\r\n  }\r\n}'\r\n```\r\n 3. Get a MatchNoDocsQuery from the Validate API\r\n\r\n\r\n\r\nThanks.\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}