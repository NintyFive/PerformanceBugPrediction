[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/84032093","html_url":"https://github.com/elastic/elasticsearch/issues/6787#issuecomment-84032093","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6787","id":84032093,"node_id":"MDEyOklzc3VlQ29tbWVudDg0MDMyMDkz","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2015-03-20T14:30:50Z","updated_at":"2015-03-20T14:30:50Z","author_association":"MEMBER","body":"Sorry it took ages to get to this. I spent some time looking at this, we can call it a bug, or just asking too much of highlighting :) \n\nThe meaning of `requireFieldMatch` is different from what is expected here. It is really only about field names, not really matching queries. By default (`require_field_match: false`) the field name gets ignored, for instance with the following document\n\n```\n{\n  \"field1\":\"value\",\n  \"field2\":\"value\"\n}\n```\n\nthe following search request will cause `field2` to be highlighted simply based on the fact that it contains the term `value` that was mentioned in the query, the field name gets ignored. \n\n```\n{\n  \"query\" : {\n    \"match\" : {\n        \"field1\" : \"value\"\n    }\n  },\n  \"highlight\" : {\n    \"fields\" : {\n      \"field2\" : { }\n    }\n  }\n}\n```\n\nBy setting `require_field_match` to `true` the field name will be taken into account and only `field1` will be highlighted for a query executed against `field1`.\n\nI can give you some more explanation of how lucene works internally here, just to explain why `field2` gets highlighted in your original example. It might seem strange but highlighting doesn't always highlight matching queries, but it's more about matching terms extracted from queries, which is close... The internal lucene query generated in your case is a `DisjunctionMaxQuery` that contains two `BooleanQuery`s, each of which holds two `TermQuery`s as clauses.\n\n```\n((+field2:x +field2:y) | (+field1:x +field1:y))\n```\n\nwhile highlighting `field2`, each of the leaf queries (the term queries) are checked against the field content, regardless of the context. When checking `field2:y` for instance, the highlighter doesn't really look at whether the clause was in and with some other clause, as each leaf is highlighted independently. If the `y` term appears in the field, it gets highlighted. By setting `require_field_match` to `true` you are just making sure that the match was really on that same field, which it is, but there is no way to make sure that the query is an actual match overall.\n\nI think there isn't much that we can do to fix this, we just need to live with this limitation, or eventually report this issue (that doesn't have much to do with require field match anyway) upstream to lucene.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/88864722","html_url":"https://github.com/elastic/elasticsearch/issues/6787#issuecomment-88864722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6787","id":88864722,"node_id":"MDEyOklzc3VlQ29tbWVudDg4ODY0NzIy","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2015-04-02T10:54:35Z","updated_at":"2015-04-02T10:54:35Z","author_association":"MEMBER","body":"I think we can close this, nothing we can do here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/359223798","html_url":"https://github.com/elastic/elasticsearch/issues/6787#issuecomment-359223798","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6787","id":359223798,"node_id":"MDEyOklzc3VlQ29tbWVudDM1OTIyMzc5OA==","user":{"login":"shinux","id":7784713,"node_id":"MDQ6VXNlcjc3ODQ3MTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7784713?v=4","gravatar_id":"","url":"https://api.github.com/users/shinux","html_url":"https://github.com/shinux","followers_url":"https://api.github.com/users/shinux/followers","following_url":"https://api.github.com/users/shinux/following{/other_user}","gists_url":"https://api.github.com/users/shinux/gists{/gist_id}","starred_url":"https://api.github.com/users/shinux/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shinux/subscriptions","organizations_url":"https://api.github.com/users/shinux/orgs","repos_url":"https://api.github.com/users/shinux/repos","events_url":"https://api.github.com/users/shinux/events{/privacy}","received_events_url":"https://api.github.com/users/shinux/received_events","type":"User","site_admin":false},"created_at":"2018-01-21T04:47:04Z","updated_at":"2018-01-21T04:47:04Z","author_association":"NONE","body":"so how to avoid highlighting unmatched fields ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/703025517","html_url":"https://github.com/elastic/elasticsearch/issues/6787#issuecomment-703025517","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6787","id":703025517,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMzAyNTUxNw==","user":{"login":"fernandocoronatomf","id":1309374,"node_id":"MDQ6VXNlcjEzMDkzNzQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1309374?v=4","gravatar_id":"","url":"https://api.github.com/users/fernandocoronatomf","html_url":"https://github.com/fernandocoronatomf","followers_url":"https://api.github.com/users/fernandocoronatomf/followers","following_url":"https://api.github.com/users/fernandocoronatomf/following{/other_user}","gists_url":"https://api.github.com/users/fernandocoronatomf/gists{/gist_id}","starred_url":"https://api.github.com/users/fernandocoronatomf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fernandocoronatomf/subscriptions","organizations_url":"https://api.github.com/users/fernandocoronatomf/orgs","repos_url":"https://api.github.com/users/fernandocoronatomf/repos","events_url":"https://api.github.com/users/fernandocoronatomf/events{/privacy}","received_events_url":"https://api.github.com/users/fernandocoronatomf/received_events","type":"User","site_admin":false},"created_at":"2020-10-03T01:41:30Z","updated_at":"2020-10-03T01:41:30Z","author_association":"NONE","body":"I'd like to ask it as well:\r\n\r\n> so how to avoid highlighting unmatched fields ?\r\n\r\n","performed_via_github_app":null}]