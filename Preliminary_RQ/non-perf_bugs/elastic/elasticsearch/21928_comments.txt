[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264699077","html_url":"https://github.com/elastic/elasticsearch/issues/21928#issuecomment-264699077","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21928","id":264699077,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDY5OTA3Nw==","user":{"login":"shaie","id":3469932,"node_id":"MDQ6VXNlcjM0Njk5MzI=","avatar_url":"https://avatars0.githubusercontent.com/u/3469932?v=4","gravatar_id":"","url":"https://api.github.com/users/shaie","html_url":"https://github.com/shaie","followers_url":"https://api.github.com/users/shaie/followers","following_url":"https://api.github.com/users/shaie/following{/other_user}","gists_url":"https://api.github.com/users/shaie/gists{/gist_id}","starred_url":"https://api.github.com/users/shaie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaie/subscriptions","organizations_url":"https://api.github.com/users/shaie/orgs","repos_url":"https://api.github.com/users/shaie/repos","events_url":"https://api.github.com/users/shaie/events{/privacy}","received_events_url":"https://api.github.com/users/shaie/received_events","type":"User","site_admin":false},"created_at":"2016-12-04T11:45:43Z","updated_at":"2016-12-04T11:45:43Z","author_association":"CONTRIBUTOR","body":"I created a PR to fix the problem: https://github.com/elastic/elasticsearch/pull/21959.\r\n\r\nThe problem is that when you use the `_termvectors` API with an artificial document and specify the `preference` parameter, the code used the auto-generated artificial doc's ID and in some cases the shard that was picked for routing per the ID did not match the shardId set in the `preference`, which resulted in the NPE reported above.\r\n\r\nThe fix detects that the TV for an artificial document is requested, and if routing isn't explicitly specified, it ignores the document's ID and uses either one of the shards, or the one specified in the `preference`.\r\n\r\nI also added an IT which verifies the behavior; it fails without the fix.","performed_via_github_app":null}]