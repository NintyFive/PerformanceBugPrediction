{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9714","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9714/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9714/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9714/events","html_url":"https://github.com/elastic/elasticsearch/issues/9714","id":57885759,"node_id":"MDU6SXNzdWU1Nzg4NTc1OQ==","number":9714,"title":"ElasticSearch percolator cannot find local query if doc_value=true","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":21,"created_at":"2015-02-17T05:41:47Z","updated_at":"2015-12-05T15:53:47Z","closed_at":"2015-12-05T15:53:47Z","author_association":"NONE","active_lock_reason":null,"body":"### Summary\n\nWhen we specify doc_value=true on geo property in our \"jobs\" index then percolator stops working properly and is not able to find queries that limit results by geo distance.\nPercolator is still able to find queries that are not limited by distance.\n\nWe were able to reproduce that issue on both ElasticSearch 1.2.2 and ElasticSearch 1.4.3.\nWe did not try any other versions.\n\nWe were able to reproduce that issue in both percolate and mpercolate (batch percolate).\nSee also: https://github.com/elasticsearch/elasticsearch/issues/6806\n### Below I’m going to demonstrate how to:\n\n1) Create index with doc_value. That way percolator is not capable to find my alert.\nThe alert searches for jobs that are within 50 miles, but cannot find job item we created that is ~10 miles away.\n2) Re-create the same index, but without doc_value. This time percolator is capable to find the same alert.\n### 1) Reproducing bug (doc_value = true)\n\nWith \"doc_value\" percolator can NOT find local alert.\nDelete old index (if any)\n\n```\nDELETE http://www.elasticsearchserver.com:9300/jobs HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 21\n\n{\"acknowledged\":true}\n```\n\nCreate new “jobs” index\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 1813\nExpect: 100-continue\n\n{\n\"settings\" : {\n\"index\" : {\n\"number_of_shards\" : 4\n},\n\"analysis\" : {\n\"tokenizer\" : {\n\"pjfpatterntokenizer\" : {\n\"type\" : \"pattern\",\n\"pattern\" : \"[^\\\\p{L}\\\\p{N}#+.]+|(?<![a-z])#|(?<![a-z+])\\\\++|\\\\.(?!net)|(?<=#)|(?<=\\\\+)(?!\\\\+)|(?=\\\\.)|(?<=\\\\d)(?=\\\\D)|(?<=\\\\D)(?=\\\\d)\",\n\"flags\" : \"CASE_INSENSITIVE\"\n}\n},\n\"analyzer\" : {\n\"pjfdocumentanalyzer\" : {\n\"tokenizer\" : \"pjfpatterntokenizer\",\n\"filter\" : [\"lowercase\", \"pjfsynonym\"]\n},\n\"pjfqueryanalyzer\" : {\n\"type\" : \"custom\",\n\"tokenizer\" : \"pjfpatterntokenizer\",\n\"filter\" : [\"lowercase\"]\n}\n},\n\"filter\" : {\n\"pjfsynonym\" : {\n\"type\" : \"synonym\",\n\"ignore_case\" : \"true\",\n\"expand\" : \"true\",\n\"synonyms_path\" : \"postjobfree/pjfsynonyms.txt\"\n}\n}\n}\n},\n\"mappings\" : {\n\"job\" : {\n\"properties\": {\n\"JobId\": {\n\"type\": \"long\"\n},\n\"PostedDate\": {\n\"type\": \"date\"\n},\n\"JobTitle\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"JobDescription\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"CompanyName\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"Salary\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"Country\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"State\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"RecruiterId\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"Location\": {\n\"type\": \"geo_point\",\n\"doc_values\": \"true\"\n},\n\"SystemUpdateDate\": {\n\"type\": \"date\"\n},\n\"PenaltyFactor\": {\n\"type\": \"float\"\n}\n}\n}\n}\n}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 21\n\n{\"acknowledged\":true}\n```\n\nAdd one query (job alert) into jobs percolator.\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs/.percolator/_bulk HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 416\nExpect: 100-continue\nConnection: Keep-Alive\n\n{ index : { _index : \"jobs\", _type : \".percolator\", _id : 59391 }}\n{\"query\" : { \"filtered\" : { \"query\" : { \"query_string\" : { \"fields\" : [\"JobTitle\",\"JobDescription\",\"CompanyName\",\"Salary\"], \"query\" : \"ACCOMMODATION\", \"analyzer\" : \"pjfqueryanalyzer\" } }, \"filter\" : { \"and\" : [{ \"geo_distance\" : { \"distance\" : \"50mi\", \"Location\" : {\"lat\":40.838252,\"lon\":-73.856609} }}] } } } , \"SystemUpdateDate\": 1424147381785}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 125\n\n{\"took\":1,\"errors\":false,\"items\":[{\"index\":{\"_index\":\"jobs\",\"_type\":\".percolator\",\"_id\":\"59391\",\"_version\":1,\"status\":201}}]}\n```\n\nPercolate job that is matching with alert that we inserted above.\nIt cannot find any matching queries because of the bug in how ElasticSearch handles doc_type=true\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs/job/_percolate HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 318\nExpect: 100-continue\nConnection: Keep-Alive\n\n{\"doc\":{\"JobId\":8780558,\"JobTitle\":\"Test\",\"JobDescription\":\"accommodation\",\"CompanyName\":\"Test\",\"Salary\":\"open\",\"RecruiterId\":\"0526278e021e483caaa127534a220f13\",\"PenaltyFactor\":1,\"PostedDate\":\"1289935161080\",\"Country\":\"US\",\"State\":\"\",\"Location\":{\"lat\":40.691492,\"lon\":-73.805689},\"SystemUpdateDate\":\"1424146430141\"}}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 81\n\n{\"took\":0,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"total\":0,\"matches\":[]}\n```\n### 2) Correct behavior (doc_value is not specified)\n\n```\nDELETE http://www.elasticsearchserver.com:9300/jobs HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 21\n\n{\"acknowledged\":true}\n```\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 1785\nExpect: 100-continue\n\n{\n\"settings\" : {\n\"index\" : {\n\"number_of_shards\" : 4\n},\n\"analysis\" : {\n\"tokenizer\" : {\n\"pjfpatterntokenizer\" : {\n\"type\" : \"pattern\",\n\"pattern\" : \"[^\\\\p{L}\\\\p{N}#+.]+|(?<![a-z])#|(?<![a-z+])\\\\++|\\\\.(?!net)|(?<=#)|(?<=\\\\+)(?!\\\\+)|(?=\\\\.)|(?<=\\\\d)(?=\\\\D)|(?<=\\\\D)(?=\\\\d)\",\n\"flags\" : \"CASE_INSENSITIVE\"\n}\n},\n\"analyzer\" : {\n\"pjfdocumentanalyzer\" : {\n\"tokenizer\" : \"pjfpatterntokenizer\",\n\"filter\" : [\"lowercase\", \"pjfsynonym\"]\n},\n\"pjfqueryanalyzer\" : {\n\"type\" : \"custom\",\n\"tokenizer\" : \"pjfpatterntokenizer\",\n\"filter\" : [\"lowercase\"]\n}\n},\n\"filter\" : {\n\"pjfsynonym\" : {\n\"type\" : \"synonym\",\n\"ignore_case\" : \"true\",\n\"expand\" : \"true\",\n\"synonyms_path\" : \"postjobfree/pjfsynonyms.txt\"\n}\n}\n}\n},\n\"mappings\" : {\n\"job\" : {\n\"properties\": {\n\"JobId\": {\n\"type\": \"long\"\n},\n\"PostedDate\": {\n\"type\": \"date\"\n},\n\"JobTitle\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"JobDescription\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"CompanyName\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"Salary\": {\n\"type\": \"string\",\n\"analyzer\" : \"pjfdocumentanalyzer\"\n},\n\"Country\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"State\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"RecruiterId\": {\n\"type\": \"string\",\n\"index\" : \"not_analyzed\"\n},\n\"Location\": {\n\"type\": \"geo_point\"\n},\n\"SystemUpdateDate\": {\n\"type\": \"date\"\n},\n\"PenaltyFactor\": {\n\"type\": \"float\"\n}\n}\n}\n}\n}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 21\n\n{\"acknowledged\":true}\n```\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs/.percolator/_bulk HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 416\nExpect: 100-continue\nConnection: Keep-Alive\n\n{ index : { _index : \"jobs\", _type : \".percolator\", _id : 59391 }}\n{\"query\" : { \"filtered\" : { \"query\" : { \"query_string\" : { \"fields\" : [\"JobTitle\",\"JobDescription\",\"CompanyName\",\"Salary\"], \"query\" : \"ACCOMMODATION\", \"analyzer\" : \"pjfqueryanalyzer\" } }, \"filter\" : { \"and\" : [{ \"geo_distance\" : { \"distance\" : \"50mi\", \"Location\" : {\"lat\":40.838252,\"lon\":-73.856609} }}] } } } , \"SystemUpdateDate\": 1424147381785}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 125\n\n{\"took\":1,\"errors\":false,\"items\":[{\"index\":{\"_index\":\"jobs\",\"_type\":\".percolator\",\"_id\":\"59391\",\"_version\":1,\"status\":201}}]}\n```\n\n```\nPOST http://www.elasticsearchserver.com:9300/jobs/job/_percolate HTTP/1.1\nContent-Type: application/x-www-form-urlencoded\nHost: www.elasticsearchserver.com:9300\nContent-Length: 318\nExpect: 100-continue\nConnection: Keep-Alive\n\n{\"doc\":{\"JobId\":8780558,\"JobTitle\":\"Test\",\"JobDescription\":\"accommodation\",\"CompanyName\":\"Test\",\"Salary\":\"open\",\"RecruiterId\":\"0526278e021e483caaa127534a220f13\",\"PenaltyFactor\":1,\"PostedDate\":\"1289935161080\",\"Country\":\"US\",\"State\":\"\",\"Location\":{\"lat\":40.691492,\"lon\":-73.805689},\"SystemUpdateDate\":\"1424146430141\"}}\n```\n\n```\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=UTF-8\nContent-Length: 112\n\n{\"took\":0,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"total\":1,\"matches\":[{\"_index\":\"jobs\",\"_id\":\"59391\"}]}\n```\n\nAs you can see, if doc_value=false then percolator works correctly.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}