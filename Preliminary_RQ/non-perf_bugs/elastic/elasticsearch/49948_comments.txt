[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562765545","html_url":"https://github.com/elastic/elasticsearch/issues/49948#issuecomment-562765545","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49948","id":562765545,"node_id":"MDEyOklzc3VlQ29tbWVudDU2Mjc2NTU0NQ==","user":{"login":"minfrin","id":1331788,"node_id":"MDQ6VXNlcjEzMzE3ODg=","avatar_url":"https://avatars1.githubusercontent.com/u/1331788?v=4","gravatar_id":"","url":"https://api.github.com/users/minfrin","html_url":"https://github.com/minfrin","followers_url":"https://api.github.com/users/minfrin/followers","following_url":"https://api.github.com/users/minfrin/following{/other_user}","gists_url":"https://api.github.com/users/minfrin/gists{/gist_id}","starred_url":"https://api.github.com/users/minfrin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/minfrin/subscriptions","organizations_url":"https://api.github.com/users/minfrin/orgs","repos_url":"https://api.github.com/users/minfrin/repos","events_url":"https://api.github.com/users/minfrin/events{/privacy}","received_events_url":"https://api.github.com/users/minfrin/received_events","type":"User","site_admin":false},"created_at":"2019-12-06T22:39:29Z","updated_at":"2019-12-06T22:39:29Z","author_association":"NONE","body":"After the installation has failed, this puts the apt packaging system in a state where no further packages can be installed.\r\n\r\nThe box appears to be unrecoverable.\r\n\r\n```\r\nroot@x-jm-unstable-black-els01:~# apt --fix-broken install\r\nReading package lists... Done\r\nBuilding dependency tree       \r\nReading state information... Done\r\nCorrecting dependencies... Done\r\nThe following additional packages will be installed:\r\n  elasticsearch\r\nThe following NEW packages will be installed:\r\n  elasticsearch\r\n0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.\r\n241 not fully installed or removed.\r\nNeed to get 0 B/149 MB of archives.\r\nAfter this operation, 240 MB of additional disk space will be used.\r\nDo you want to continue? [Y/n] y\r\n(Reading database ... 106485 files and directories currently installed.)\r\nPreparing to unpack .../elasticsearch_6.8.5_all.deb ...\r\ncould not find java; set JAVA_HOME\r\ndpkg: error processing archive /var/cache/apt/archives/elasticsearch_6.8.5_all.deb (--unpack):\r\n new elasticsearch package pre-installation script subprocess returned error exit status 1\r\nErrors were encountered while processing:\r\n /var/cache/apt/archives/elasticsearch_6.8.5_all.deb\r\nE: Sub-process /usr/bin/dpkg returned an error code (1)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562783012","html_url":"https://github.com/elastic/elasticsearch/issues/49948#issuecomment-562783012","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49948","id":562783012,"node_id":"MDEyOklzc3VlQ29tbWVudDU2Mjc4MzAxMg==","user":{"login":"minfrin","id":1331788,"node_id":"MDQ6VXNlcjEzMzE3ODg=","avatar_url":"https://avatars1.githubusercontent.com/u/1331788?v=4","gravatar_id":"","url":"https://api.github.com/users/minfrin","html_url":"https://github.com/minfrin","followers_url":"https://api.github.com/users/minfrin/followers","following_url":"https://api.github.com/users/minfrin/following{/other_user}","gists_url":"https://api.github.com/users/minfrin/gists{/gist_id}","starred_url":"https://api.github.com/users/minfrin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/minfrin/subscriptions","organizations_url":"https://api.github.com/users/minfrin/orgs","repos_url":"https://api.github.com/users/minfrin/repos","events_url":"https://api.github.com/users/minfrin/events{/privacy}","received_events_url":"https://api.github.com/users/minfrin/received_events","type":"User","site_admin":false},"created_at":"2019-12-06T23:37:06Z","updated_at":"2019-12-06T23:37:06Z","author_association":"NONE","body":"It looks like the regression was added here: https://github.com/elastic/elasticsearch/pull/31343\r\n\r\nWe were previously using elasticsearch v6.2.2, and this worked.\r\n\r\nWhat seems to be happening is that if you try and install openjdk and elasticsearch together in the same apt-get install, which is how cloud-init works, the preinstall script for elasticsearch appears to run before the postinstall script for openjdk which sets up /etc/alternatives and /usr/bin/java.\r\n\r\nThe installation then fails. The failure in elasticsearch preinst causes the openjdk postinst to be skipped, and as a result the system remains permanently broken.\r\n\r\nThe root cause looks like it's because elasticsearch doesn't declare itself dependent on a jdk of any kind:\r\n\r\nroot@x-jm-unstable-black-els01:~# apt-cache depends elasticsearch\r\nelasticsearch\r\n  Depends: bash\r\n  Depends: libc6\r\n  Depends: adduser\r\n  Depends: coreutils\r\n  Conflicts: <elasticsearch-oss>\r\n\r\nAs a result, apt-get doesn't know that openjdk needs to go before elasticsearch, and chaos ensues.\r\n\r\nIt looks like the fix is for elasticsearch to declare it needs a JDK.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562796560","html_url":"https://github.com/elastic/elasticsearch/issues/49948#issuecomment-562796560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49948","id":562796560,"node_id":"MDEyOklzc3VlQ29tbWVudDU2Mjc5NjU2MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-12-07T01:01:21Z","updated_at":"2019-12-07T01:01:21Z","author_association":"MEMBER","body":"We are not going to modify 6.8 to require a JDK. In 7.x we have solved this by bundling a JDK with Elasticsearch, thatâ€™s our long-term fix for this problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562847345","html_url":"https://github.com/elastic/elasticsearch/issues/49948#issuecomment-562847345","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49948","id":562847345,"node_id":"MDEyOklzc3VlQ29tbWVudDU2Mjg0NzM0NQ==","user":{"login":"minfrin","id":1331788,"node_id":"MDQ6VXNlcjEzMzE3ODg=","avatar_url":"https://avatars1.githubusercontent.com/u/1331788?v=4","gravatar_id":"","url":"https://api.github.com/users/minfrin","html_url":"https://github.com/minfrin","followers_url":"https://api.github.com/users/minfrin/followers","following_url":"https://api.github.com/users/minfrin/following{/other_user}","gists_url":"https://api.github.com/users/minfrin/gists{/gist_id}","starred_url":"https://api.github.com/users/minfrin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/minfrin/subscriptions","organizations_url":"https://api.github.com/users/minfrin/orgs","repos_url":"https://api.github.com/users/minfrin/repos","events_url":"https://api.github.com/users/minfrin/events{/privacy}","received_events_url":"https://api.github.com/users/minfrin/received_events","type":"User","site_admin":false},"created_at":"2019-12-07T12:30:57Z","updated_at":"2019-12-07T12:30:57Z","author_association":"NONE","body":"Unfortunately our vendor does not support elasticsearch 7.x at this time.\r\n\r\nHow do you propose we solve this problem?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/563239497","html_url":"https://github.com/elastic/elasticsearch/issues/49948#issuecomment-563239497","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49948","id":563239497,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MzIzOTQ5Nw==","user":{"login":"minfrin","id":1331788,"node_id":"MDQ6VXNlcjEzMzE3ODg=","avatar_url":"https://avatars1.githubusercontent.com/u/1331788?v=4","gravatar_id":"","url":"https://api.github.com/users/minfrin","html_url":"https://github.com/minfrin","followers_url":"https://api.github.com/users/minfrin/followers","following_url":"https://api.github.com/users/minfrin/following{/other_user}","gists_url":"https://api.github.com/users/minfrin/gists{/gist_id}","starred_url":"https://api.github.com/users/minfrin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/minfrin/subscriptions","organizations_url":"https://api.github.com/users/minfrin/orgs","repos_url":"https://api.github.com/users/minfrin/repos","events_url":"https://api.github.com/users/minfrin/events{/privacy}","received_events_url":"https://api.github.com/users/minfrin/received_events","type":"User","site_admin":false},"created_at":"2019-12-09T13:31:44Z","updated_at":"2019-12-09T13:31:44Z","author_association":"NONE","body":"I've added https://github.com/elastic/elasticsearch/issues/49983 to properly track the problem, with the solution as per debian packaging guidelines.","performed_via_github_app":null}]