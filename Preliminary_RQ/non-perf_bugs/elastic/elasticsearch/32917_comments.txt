[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413802637","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-413802637","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":413802637,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzgwMjYzNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-17T08:57:13Z","updated_at":"2018-08-17T08:57:13Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413816642","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-413816642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":413816642,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzgxNjY0Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-08-17T09:52:18Z","updated_at":"2018-08-17T09:52:18Z","author_association":"CONTRIBUTOR","body":"I tried to reproduce this but could not. I started an cluster of 1 master node and 10 data nodes, and created a 10-copy shard:\r\n\r\n```\r\nGET /_cat/nodes\r\n\r\n# 200 OK\r\n# 127.0.0.1 28 100 21 59.98   di - 9x5PYfG\r\n# 127.0.0.1 27 100 21 59.98   di - igbhpl9\r\n# 127.0.0.1 30 100 21 59.98   di - ieBbrZ5\r\n# 127.0.0.1 29 100 21 59.98   di - vKlnAS-\r\n# 127.0.0.1 28 100 21 59.98   di - vx2FoEE\r\n# 127.0.0.1 29 100 21 59.98   di - qSDXhI1\r\n# 127.0.0.1 29 100 21 59.98   di - Zcue66D\r\n# 127.0.0.1 36 100 21 59.98   mi * Q8pqoPI\r\n# 127.0.0.1 31 100 21 59.98   di - um3rYtc\r\n# 127.0.0.1 30 100 21 59.98   di - 5Y6rRkb\r\n# 127.0.0.1 29 100 21 59.98   di - gLWyu9N\r\n# \r\n\r\nPUT /i\r\n{\r\n  \"settings\": {\r\n    \"index.unassigned.node_left.delayed_timeout\": \"10m\",\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 9\r\n  }\r\n}\r\n\r\n# 200 OK\r\n# {\r\n#   \"shards_acknowledged\": true,\r\n#   \"acknowledged\": true,\r\n#   \"index\": \"i\"\r\n# }\r\n\r\nGET /_cluster/health?wait_for_status=green\r\n\r\n# 200 OK\r\n# {\r\n#   \"number_of_pending_tasks\": 1,\r\n#   \"status\": \"green\",\r\n#   \"relocating_shards\": 0,\r\n#   \"cluster_name\": \"elasticsearch\",\r\n#   \"initializing_shards\": 0,\r\n#   \"task_max_waiting_in_queue_millis\": 0,\r\n#   \"delayed_unassigned_shards\": 0,\r\n#   \"timed_out\": false,\r\n#   \"unassigned_shards\": 0,\r\n#   \"number_of_in_flight_fetch\": 0,\r\n#   \"number_of_nodes\": 11,\r\n#   \"active_shards\": 10,\r\n#   \"active_primary_shards\": 1,\r\n#   \"number_of_data_nodes\": 10,\r\n#   \"active_shards_percent_as_number\": 100.0\r\n# }\r\n\r\nGET /_cat/shards\r\n\r\n# 200 OK\r\n# i 0 p STARTED 0 230b 127.0.0.1 um3rYtc\r\n# i 0 r STARTED 0 230b 127.0.0.1 5Y6rRkb\r\n# i 0 r STARTED 0 230b 127.0.0.1 9x5PYfG\r\n# i 0 r STARTED 0 230b 127.0.0.1 vx2FoEE\r\n# i 0 r STARTED 0 230b 127.0.0.1 ieBbrZ5\r\n# i 0 r STARTED 0 230b 127.0.0.1 vKlnAS-\r\n# i 0 r STARTED 0 230b 127.0.0.1 igbhpl9\r\n# i 0 r STARTED 0 230b 127.0.0.1 Zcue66D\r\n# i 0 r STARTED 0 230b 127.0.0.1 gLWyu9N\r\n# i 0 r STARTED 0 230b 127.0.0.1 qSDXhI1\r\n```\r\n\r\nThen I shut down all 10 data nodes:\r\n\r\n```\r\n$ kill -TERM $(curl 'http://localhost:9200/_cat/nodes?h=p,r' | grep ' di$' | awk '{print $1}')\r\n```\r\n\r\nUpon restarting the nodes, the shards were all allocated straight away. Please could you give more detailed instructions on how to reproduce this? Alternatively, could you try repeating the experiment having enabled `TRACE` logging like this, and provide the logs from the master.\r\n\r\n```\r\nPUT _cluster/settings\r\n{\"transient\":{\"logger.org.elasticsearch.gateway\":\"TRACE\"}}\r\n```\r\n\r\nAfter you have the logs, disable this detailed logging again:\r\n\r\n```\r\nPUT _cluster/settings\r\n{\"transient\":{\"logger.org.elasticsearch.gateway\":null}}\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413929299","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-413929299","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":413929299,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzkyOTI5OQ==","user":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"created_at":"2018-08-17T17:06:44Z","updated_at":"2018-08-17T17:08:08Z","author_association":"NONE","body":"Wonder if this is caused by restarting a master node at the same time. Not sure why the TRACE outputs aren't showing up, but I had it happen again and can even see the nodes rejoining with the same ID: FYI: this is a different node showing the behavior this time so the ID is different then the original post.\r\n\r\n```\r\n[2018-08-17T16:53:01,874][INFO ][o.e.c.s.MasterService    ] [i-0e3dfeb9d2d498fbd] zen-disco-node-join, reason: added {{i-0edf43e43e6dc5558}{oaGQQQFUTPCZI0YGL5C0bg}{7k5H4BhQTV2q7K6\r\n9rtyyDw}{ip-10-10-61-219.ap-southeast-1.compute.internal}{10.10.61.219:9300}{rack_id=ap-southeast-1a, instance_id=i-0edf43e43e6dc5558, xpack.installed=true, instance_type=i3.4xlar\r\nge, instance_ip=10.10.61.219},}\r\n[2018-08-17T16:53:04,661][INFO ][o.e.c.s.ClusterApplierService] [i-0e3dfeb9d2d498fbd] added {{i-0edf43e43e6dc5558}{oaGQQQFUTPCZI0YGL5C0bg}{7k5H4BhQTV2q7K69rtyyDw}{ip-10-10-61-219.ap-southeast-1.compute.internal}{10.10.61.219:9300}{rack_id=ap-southeast-1a, instance_id=i-0edf43e43e6dc5558, xpack.installed=true, instance_type=i3.4xlarge, instance_ip=10.10.61.219},}, reason: apply cluster state (from master [master {i-0e3dfeb9d2d498fbd}{OebwTNC4Tl2J6t_h8o-eaQ}{TnSNxqxDSGqU4m1FjeQXLw}{ip-10-10-65-52.ap-southeast-1.compute.internal}{10.10.65.52:9300}{rack_id=ap-southeast-1b, instance_id=i-0e3dfeb9d2d498fbd, xpack.installed=true, instance_ip=10.10.65.52, instance_type=c5.9xlarge} committed version [10029] source [zen-disco-node-join]])","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413943824","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-413943824","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":413943824,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzk0MzgyNA==","user":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"created_at":"2018-08-17T18:00:17Z","updated_at":"2018-08-17T18:00:17Z","author_association":"NONE","body":"Here are my current settings btw:\r\n```\r\n{\r\n  \"persistent\": {\r\n    \"cluster\": {\r\n      \"routing\": {\r\n        \"use_adaptive_replica_selection\": \"true\",\r\n        \"rebalance\": {\r\n          \"enable\": \"none\"\r\n        },\r\n        \"allocation\": {\r\n          \"disk\": {\r\n            \"watermark\": {\r\n              \"low\": \"200gb\",\r\n              \"flood_stage\": \"50gb\",\r\n              \"high\": \"100gb\"\r\n            }\r\n          },\r\n          \"node_initial_primaries_recoveries\": \"15\",\r\n          \"awareness\": {\r\n            \"attributes\": \"rack_id\"\r\n          },\r\n          \"balance\": {\r\n            \"threshold\": \"1.6f\",\r\n            \"shard\": \"0.40f\"\r\n          },\r\n          \"enable\": \"all\",\r\n          \"allow_rebalance\": \"indices_all_active\",\r\n          \"cluster_concurrent_rebalance\": \"2\",\r\n          \"node_concurrent_recoveries\": \"2\"\r\n        }\r\n      },\r\n      \"info\": {\r\n        \"update\": {\r\n          \"interval\": \"30s\"\r\n        }\r\n      }\r\n    },\r\n    \"indices\": {\r\n      \"breaker\": {\r\n        \"fielddata\": {\r\n          \"limit\": \"60%\"\r\n        },\r\n        \"request\": {\r\n          \"limit\": \"40%\"\r\n        },\r\n        \"total\": {\r\n          \"limit\": \"70%\"\r\n        }\r\n      },\r\n      \"recovery\": {\r\n        \"max_bytes_per_sec\": \"10000Mb\"\r\n      }\r\n    },\r\n    \"search\": {\r\n      \"default_search_timeout\": \"30s\",\r\n      \"low_level_cancellation\": \"true\"\r\n    },\r\n    \"discovery\": {\r\n      \"zen\": {\r\n        \"minimum_master_nodes\": \"2\"\r\n      }\r\n    },\r\n    \"xpack\": {\r\n      \"monitoring\": {\r\n        \"collection\": {\r\n          \"enabled\": \"true\"\r\n        }\r\n      }\r\n    },\r\n    \"network\": {\r\n      \"breaker\": {\r\n        \"inflight_requests\": {\r\n          \"limit\": \"90%\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"transient\": {\r\n    \"logger\": {\r\n      \"org\": {\r\n        \"elasticsearch\": {\r\n          \"gateway\": \"TRACE\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415542481","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-415542481","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":415542481,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTU0MjQ4MQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-08-23T19:29:36Z","updated_at":"2018-08-23T19:29:36Z","author_association":"CONTRIBUTOR","body":"Could you provide all the logs from the master node for the period around `2018-08-17T16:53:01,874`, from before you started shutting nodes down until after the cluster had recovered? If they're too large to include in full, use https://gist.github.com.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415830548","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-415830548","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":415830548,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTgzMDU0OA==","user":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"created_at":"2018-08-24T17:40:45Z","updated_at":"2018-08-24T17:40:45Z","author_association":"NONE","body":"I've lost those logs, but it basically happens every time I do a rolling restart of a handful of nodes at once. Here is the latest one: https://gist.github.com/danielkasen/c9c5ac66236724f71dde0d4ca7a29d57#file-production-elasticsearch-logs-log","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415854592","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-415854592","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":415854592,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTg1NDU5Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-08-24T19:08:42Z","updated_at":"2018-08-24T19:09:06Z","author_association":"CONTRIBUTOR","body":"Thanks. These logs are a slightly weird combination of copious `DEBUG` messages from things we haven't asked for like `o.e.i.m.MapperService` and `o.e.i.c.b.BitsetFilterCache`, and yet no `DEBUG` or `TRACE` messages from the places we need, which is puzzling. I have just confirmed by experiment against a 6.3.2 cluster that\r\n\r\n```\r\nPUT _cluster/settings\r\n{\"transient\":{\"logger.org.elasticsearch.gateway\":\"TRACE\"}}\r\n```\r\n\r\ndoes indeed cause a lot more output when nodes join and leave the cluster than what we're seeing here. Can you look into your logging configuration and see if it's possible to sort this out?\r\n\r\nThat said, there is _some_ information here - I can see a bunch of nodes leave and join the cluster at around `15:52`, and again at around `16:09` and then again at `16:35`, and hopefully these are deliberate restarts? Can you tell me which node(s) were the problematic ones that needed to be restarted a second time in any of those cases?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/419814829","html_url":"https://github.com/elastic/elasticsearch/issues/32917#issuecomment-419814829","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32917","id":419814829,"node_id":"MDEyOklzc3VlQ29tbWVudDQxOTgxNDgyOQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-09-10T07:27:33Z","updated_at":"2018-09-10T07:27:33Z","author_association":"CONTRIBUTOR","body":"No response for a couple of weeks, so I'm closing this. We can reopen it if more information becomes available.","performed_via_github_app":null}]