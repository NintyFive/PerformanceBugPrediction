{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1305","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1305/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1305/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1305/events","html_url":"https://github.com/elastic/elasticsearch/issues/1305","id":1576320,"node_id":"MDU6SXNzdWUxNTc2MzIw","number":1305,"title":"terms facet gives wrong count with n_shards > 1","user":{"login":"jmchambers","id":49592,"node_id":"MDQ6VXNlcjQ5NTky","avatar_url":"https://avatars2.githubusercontent.com/u/49592?v=4","gravatar_id":"","url":"https://api.github.com/users/jmchambers","html_url":"https://github.com/jmchambers","followers_url":"https://api.github.com/users/jmchambers/followers","following_url":"https://api.github.com/users/jmchambers/following{/other_user}","gists_url":"https://api.github.com/users/jmchambers/gists{/gist_id}","starred_url":"https://api.github.com/users/jmchambers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmchambers/subscriptions","organizations_url":"https://api.github.com/users/jmchambers/orgs","repos_url":"https://api.github.com/users/jmchambers/repos","events_url":"https://api.github.com/users/jmchambers/events{/privacy}","received_events_url":"https://api.github.com/users/jmchambers/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":77,"created_at":"2011-09-06T09:32:06Z","updated_at":"2015-07-17T12:18:31Z","closed_at":"2015-07-14T20:29:38Z","author_association":"NONE","active_lock_reason":null,"body":"I'm working with nested documents and have noticed that my faceted search interface is giving the wrong counts when I have more than one shard. To be more specific, I'm working with RDF triples (entity > attribute > value) and I'm nesting the attributes (called predicates in my example):\n\n```\n{\n  \"_id\" : \"512a2c022f0b4e3daa341e6c8bcf6c2f\",\n  \"url\": \"http://dbpedia.org/resource/Alan_Shepard\",\n  \"predicates\": [\n    {\n      \"type\": \"type\",\n      \"string_value\": [\"thing\", \"person\", \"astronaut\"]\n    }, {\n      \"type\": \"label\",\n      \"string_value\": [\"Alan Shepard\"]\n    }, {\n      \"type\": \"time in space\",\n      \"float_value\": [216.950]\n    },\n    ... lots more\n  ]\n}\n```\n\nI've created a shell script (https://gist.github.com/1196986) that recreates the problem with a fresh index. The created data set has these totals:\n- thing (30)\n- creative work (20)\n- video game (10)\n- tv show (10)\n- people (10)\n\nWith only **one shard** the following query gives the correct counts no matter what the size parameter is set to:\n\n```\n{\n  \"size\": 0,\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"facets\": {\n    \"type_counts\": {\n      \"terms\": {\n        \"field\": \"string_value\",\n        \"size\": 5\n      },\n      \"nested\": \"predicates\",\n      \"facet_filter\": {\n        \"term\": {\n          \"type\": \"type\"\n        }\n      }\n    }\n  }\n}\n```\n\nHowever, with **more than one shard** the size parameter affects the accuracy of the counts. If it is equal to or greater than the number of terms returned by the facet query (5 in this case) then it works fine. However, the terms at the bottom of the list start to display low counts as you reduce the size parameter:\n\nWith \"size\" : 4\n- thing (30)\n- creative work (20)\n- video game (10)\n- **tv show (9)**\n\nWith \"size\" : 3\n- thing (30)\n- **creative work (15)**\n- **video game (9)**\n\nWith \"size\" : 2\n- thing (30)\n- **creative work (15)**\n\nSo it looks like the sub-totals from some of the shards aren't being included for some reason. BTW I'm on ubuntu and the problem seems to affect all versions of ES I've tried (17.0, 17.1 and 17.6). Any ideas...?\n\nP.S. absolutely loving ES - it's made my life a lot easier :)\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}