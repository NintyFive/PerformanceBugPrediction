[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/416322445","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-416322445","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":416322445,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNjMyMjQ0NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-27T18:29:36Z","updated_at":"2018-08-27T18:29:36Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/417356267","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-417356267","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":417356267,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNzM1NjI2Nw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-08-30T15:14:20Z","updated_at":"2018-08-30T15:17:24Z","author_association":"MEMBER","body":"Pasting from an old issue (in old xpack repo) with a similar error.  I think it was a concurrency issue for the other one but was never resolved.\r\n\r\n> I tried a few approaches to fix this but wasn't satisfied with any of them. Jotting down notes for now:\r\n>\r\n>The issue is that ExecutionService#clearExecutions() is called on stop or pause, which seals currentExecutions then overwrites it with a new instantiation. But it's possible for a manual execution of a watch to slip in between the sealing and the new object, which throws the exception seen here.\r\n>\r\n>There are a few ways this could be fixed, unsure the best route:\r\n>\r\n>  - Instead of throwing an exception, CurrentExceptions#put() could return Optional<Boolean> to signal if it was able to add to the map, and if not, the calling code could just log a message and abort\r\n>  - Allow manually executed Watches to be added to the currently executing list despite being sealed\r\n>  - Modify CurrentExceptions so that it can be reset internally, rather than externally overwritten after being drained. This would change up the sealing dynamics and allow waiting for the drain to finish, etc.\r\n\r\nIn that issue, @DaveCTurner followed up with:\r\n\r\n> Would it work to do something like the following?\r\n \r\n ```\r\n diff --git a/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/execution/ExecutionService.java b/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/execution/ExecutionService.java\r\n index 407ab9a7e5..c3f73740e8 100644\r\n --- a/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/execution/ExecutionService.java\r\n +++ b/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/execution/ExecutionService.java\r\n @@ -554,8 +554,9 @@ public class ExecutionService extends AbstractComponent {\r\n       * This is needed, because when this method is called, watcher keeps running, so sealing executions would be a bad idea\r\n      */\r\n     public void clearExecutions() {\r\n-        currentExecutions.sealAndAwaitEmpty(maxStopTimeout);\r\n+        final CurrentExecutions previousExecutions = currentExecutions;\r\n         currentExecutions = new CurrentExecutions();\r\n+        previousExecutions.sealAndAwaitEmpty(maxStopTimeout);\r\n     }\r\n \r\n     // the watch execution task takes another runnable as parameter\r\n ```\r\n\r\n> NB I'm not sure this _actually_ works as-is without further synchronisation.\r\n\r\nNot sure if it's the same issue (manual executions racing), but if there are concurrency issues with this code it might be manifesting in the above test too.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/422812652","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-422812652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":422812652,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMjgxMjY1Mg==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2018-09-19T13:53:56Z","updated_at":"2018-09-19T13:53:56Z","author_association":"CONTRIBUTOR","body":"Another instance: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+periodic/27/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466323951","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-466323951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":466323951,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjMyMzk1MQ==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T08:58:31Z","updated_at":"2019-02-22T08:58:31Z","author_association":"CONTRIBUTOR","body":"And another one today: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/2197/consoleText in master intake\r\n\r\nThis fails once in a while: https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-6M,mode:quick,to:now))&_a=(columns:!(_source),index:b646ed00-7efc-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'%22old_cluster%2F60_watcher%2FCRUD%20watch%20APIs%22'),sort:!(process.time-start,desc))","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480835329","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-480835329","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":480835329,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDgzNTMyOQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T13:38:29Z","updated_at":"2019-04-08T13:38:29Z","author_association":"MEMBER","body":"Another instance in 7.0 https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.0+artifactory/133/console\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480898827","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-480898827","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":480898827,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDg5ODgyNw==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T16:14:11Z","updated_at":"2019-04-08T16:14:11Z","author_association":"MEMBER","body":"Another failure in 7.0 https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.0+artifactory/136/testReport/junit/org.elasticsearch.upgrades/UpgradeClusterClientYamlTestSuiteIT/test__p0_old_cluster_60_watcher_CRUD_watch_APIs_/  so I backported the muting to 7.0 1948702f4ab3a7a2bfc243ca0328173cac4a487c\r\n\r\nThere are only 2 watcher tests in the yml suite both are muted leaving only [WatcherRestartIT](https://github.com/elastic/elasticsearch/blob/b5b6e37a60fcd5ee0ecf707c19eac5b919750e6b/x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/WatcherRestartIT.java#L19) for \r\n Watcher upgrade test coverage and that test appears pretty minimal. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496940325","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-496940325","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":496940325,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5Njk0MDMyNQ==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-05-29T13:38:16Z","updated_at":"2019-05-29T13:38:16Z","author_association":"CONTRIBUTOR","body":"Un-muted this test on PR #42377 to obtain additional logs. \r\n\r\nIf (when?) this test fails again please obtain the following information before muting the test:\r\n\r\n* Copy of the relevant failure\r\n* Copy of the reproduce line\r\n* The Jenkins build link \r\n* The Gradle scan link\r\n* The relevant cluster logs from \"Google Cloud Storage Upload Report\" (link found in Jenkins build)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/497213745","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-497213745","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":497213745,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NzIxMzc0NQ==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-05-30T05:58:36Z","updated_at":"2019-05-30T05:58:36Z","author_association":"CONTRIBUTOR","body":"This failed in a PR build: \r\n\r\nJenkins build: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-bwc/6473/\r\nGradle scan: https://gradle.com/s/7smiqhxdoghp2\r\nRepro: \r\n```\r\n./gradlew :x-pack:qa:rolling-upgrade:v7.3.0#oldClusterTestRunner --tests \"org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT.test {p0=old_cluster/60_watcher/CRUD watch APIs}\" -Dtests.seed=8DFA7D80E04774A7 -Dtests.security.manager=true -Dtests.locale=ta-MY -Dtests.timezone=Asia/Krasnoyarsk -Dcompiler.java=12 -Druntime.java=11 -Dtests.rest.suite=old_cluster\r\n```\r\nlogs: \r\nhttps://storage.cloud.google.com/elasticsearch-ci-artifacts/jobs/elastic+elasticsearch+pull-request-bwc/6473/hprof-files.tar.gz\r\nhttps://storage.cloud.google.com/elasticsearch-ci-artifacts/jobs/elastic+elasticsearch+pull-request-bwc/6473/syserr-files.tar.gz\r\nhttps://storage.cloud.google.com/elasticsearch-ci-artifacts/jobs/elastic+elasticsearch+pull-request-bwc/6473/log-files.tar.gz","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503214634","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-503214634","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":503214634,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzIxNDYzNA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-06-18T16:37:19Z","updated_at":"2019-06-18T16:37:19Z","author_association":"CONTRIBUTOR","body":"In today's `master` I found a bunch of tests that are being skipped and which link to this issue:\r\n\r\n```\r\n$ find . -type f -name '*.yml' | xargs grep -e 33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build/resources/test/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/build-idea/classes/test/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n./x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/upgraded_cluster/60_watcher.yml:      reason: https://github.com/elastic/elasticsearch/issues/33185\r\n```\r\n\r\nIt looks like GitHub interpreted the phrase `This initial PR does not attempt to fix #33185.` wrongly 🤦‍♀ . Re-opening.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/580241579","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-580241579","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":580241579,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MDI0MTU3OQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-01-30T13:00:49Z","updated_at":"2020-01-30T13:00:49Z","author_association":"MEMBER","body":"After merging in the pr that enables the watcher rolling upgrade tests, these tests haven't yet failed. I'm  going to also enable these tests in the 7 dot x branch.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/581412292","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-581412292","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":581412292,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTQxMjI5Mg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-02-03T13:25:34Z","updated_at":"2020-02-03T13:25:34Z","author_association":"MEMBER","body":"Today the first real failure occurred: \r\n\r\n```\r\norg.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT > test {p0=old_cluster/60_watcher/CRUD watch APIs} FAILED |  \r\n-- | --\r\n  | java.lang.AssertionError: Failure at [old_cluster/60_watcher:41]: watch_record.state didn't match expected value: |  \r\n  | watch_record.state: expected String [executed] but was String [failed] |  \r\n  | at __randomizedtesting.SeedInfo.seed([885817E4E7A82A5D:C283E495447A5]:0) |  \r\n  | at org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:405) |  \r\n  | at org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.test(ESClientYamlSuiteTestCase.java:382) |  \r\n  | at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n```\r\n\r\nLast response: \r\n\r\n```\r\n[2020-02-03T03:01:13,678][INFO ][o.e.u.UpgradeClusterClientYamlTestSuiteIT] [test] Stash dump on test failure [{ |  \r\n-- | --\r\n  | 1>   \"stash\" : { |  \r\n  | 1>     \"record_id\" : \"my_watch_26c48e21-ab7e-4953-836a-f90d7ec7baea-2020-02-03T01:01:13.478Z\", |  \r\n  | 1>     \"body\" : { |  \r\n  | 1>       \"_id\" : \"my_watch_26c48e21-ab7e-4953-836a-f90d7ec7baea-2020-02-03T01:01:13.478Z\", |  \r\n  | 1>       \"watch_record\" : { |  \r\n  | 1>         \"watch_id\" : \"my_watch\", |  \r\n  | 1>         \"node\" : \"VhrcuRKYSkmoP9P9ilKjTw\", |  \r\n  | 1>         \"state\" : \"failed\", |  \r\n  | 1>         \"user\" : \"test_user\", |  \r\n  | 1>         \"status\" : { |  \r\n  | 1>           \"state\" : { |  \r\n  | 1>             \"active\" : true, |  \r\n  | 1>             \"timestamp\" : \"2020-02-03T01:01:13.171Z\" |  \r\n  | 1>           }, |  \r\n  | 1>           \"actions\" : { |  \r\n  | 1>             \"logging\" : { |  \r\n  | 1>               \"ack\" : { |  \r\n  | 1>                 \"timestamp\" : \"2020-02-03T01:01:13.171Z\", |  \r\n  | 1>                 \"state\" : \"awaits_successful_execution\" |  \r\n  | 1>               } |  \r\n  | 1>             } |  \r\n  | 1>           }, |  \r\n  | 1>           \"execution_state\" : \"failed\", |  \r\n  | 1>           \"version\" : 1 |  \r\n  | 1>         }, |  \r\n  | 1>         \"trigger_event\" : { |  \r\n  | 1>           \"type\" : \"manual\", |  \r\n  | 1>           \"triggered_time\" : \"2020-02-03T01:01:13.475Z\", |  \r\n  | 1>           \"manual\" : { |  \r\n  | 1>             \"schedule\" : { |  \r\n  | 1>               \"scheduled_time\" : \"2020-02-03T01:01:13.475Z\" |  \r\n  | 1>             } |  \r\n  | 1>           } |  \r\n  | 1>         }, |  \r\n  | 1>         \"input\" : { |  \r\n  | 1>           \"simple\" : { } |  \r\n  | 1>         }, |  \r\n  | 1>         \"condition\" : { |  \r\n  | 1>           \"always\" : { } |  \r\n  | 1>         }, |  \r\n  | 1>         \"result\" : { |  \r\n  | 1>           \"execution_time\" : \"2020-02-03T01:01:13.478Z\", |  \r\n  | 1>           \"execution_duration\" : 1580691673483, |  \r\n  | 1>           \"actions\" : [ ] |  \r\n  | 1>         }, |  \r\n  | 1>         \"exception\" : { |  \r\n  | 1>           \"type\" : \"illegal_state_exception\", |  \r\n  | 1>           \"reason\" : \"could not register execution [my_watch]. current executions are sealed and forbid registrations of additional executions.\" |  \r\n  | 1>         } |  \r\n  | 1>       } |  \r\n  | 1>     } |  \r\n  | 1>   } |  \r\n  | 1> }]\r\n```\r\n\r\nRelevant build logs on node executing watch:\r\n\r\n```\r\n[2020-02-03T01:00:58,389][INFO ][o.e.x.w.WatcherService   ] [v6.8.7-1] stopping watch service, reason [watcher manually marked to shutdown by cluster state update]\r\n[2020-02-03T01:01:13,312][INFO ][o.e.x.w.WatcherService   ] [v6.8.7-1] reloading watcher, reason [new local watcher shard allocation ids], cancelled [0] queued tasks\r\n[2020-02-03T01:01:13,342][DEBUG][o.e.x.w.WatcherService   ] [v6.8.7-1] watch service has been reloaded, reason [new local watcher shard allocation ids]\r\n[2020-02-03T01:01:13,371][DEBUG][o.e.x.w.WatcherIndexingListener] [v6.8.7-1] adding watch [my_watch] to trigger service\r\n[2020-02-03T01:01:13,482][INFO ][o.e.x.w.WatcherService   ] [v6.8.7-1] reloading watcher, reason [new local watcher shard allocation ids], cancelled [0] queued tasks\r\n[2020-02-03T01:01:13,487][DEBUG][o.e.x.w.e.ExecutionService] [v6.8.7-1] failed to execute watch [my_watch]\r\njava.lang.IllegalStateException: could not register execution [my_watch]. current executions are sealed and forbid registrations of additional executions.\r\n        at org.elasticsearch.xpack.core.watcher.support.Exceptions.illegalState(Exceptions.java:26) ~[x-pack-core-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.xpack.watcher.execution.CurrentExecutions.put(CurrentExecutions.java:41) ~[x-pack-watcher-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.xpack.watcher.execution.ExecutionService.execute(ExecutionService.java:282) [x-pack-watcher-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.xpack.watcher.transport.actions.execute.TransportExecuteWatchAction$1.doRun(TransportExecuteWatchAction.java:164) [x-pack-watcher-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.xpack.watcher.execution.ExecutionService$WatchExecutionTask.run(ExecutionService.java:617) [x-pack-watcher-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) [elasticsearch-6.8.7-SNAPSHOT.jar:6.8.7-SNAPSHOT]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_242]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_242]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_242]\r\n[2020-02-03T01:01:13,506][DEBUG][o.e.x.w.WatcherService   ] [v6.8.7-1] Loaded [0] watches for execution\r\n[2020-02-03T01:01:13,507][DEBUG][o.e.x.w.WatcherService   ] [v6.8.7-1] watch service has been reloaded, reason [new local watcher shard allocation ids]\r\n[2020-02-03T01:01:13,660][ERROR][o.e.x.w.Watcher          ] [v6.8.7-1] triggered watches could not be deleted [my_watch_26c48e21-ab7e-4953-836a-f90d7ec7baea-2020-02-03T01:01:13.478Z], failure [[.triggered_watches] IndexNotFoundException[no such index]]\r\n[2020-02-03T01:01:13,661][DEBUG][o.e.x.w.e.ExecutionService] [v6.8.7-1] finished [my_watch]/[my_watch_26c48e21-ab7e-4953-836a-f90d7ec7baea-2020-02-03T01:01:13.478Z]\r\n```\r\n\r\nBuild url: https://gradle-enterprise.elastic.co/s/hbiysvknha5wi/","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/581412973","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-581412973","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":581412973,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTQxMjk3Mw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-02-03T13:27:13Z","updated_at":"2020-02-03T13:27:13Z","author_association":"MEMBER","body":"I think that after the watch gets created when running against old cluster then we should wait until .watches index is at least yellow and watcher is started. This way we avoid executing a watch before watcher is ready to execute.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/584082739","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-584082739","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":584082739,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NDA4MjczOQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-02-10T11:40:15Z","updated_at":"2020-02-10T11:40:15Z","author_association":"MEMBER","body":"The latest failure happened a couple of times in the last week. I've opened #52139 to address it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/589518598","html_url":"https://github.com/elastic/elasticsearch/issues/33185#issuecomment-589518598","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33185","id":589518598,"node_id":"MDEyOklzc3VlQ29tbWVudDU4OTUxODU5OA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-02-21T06:31:00Z","updated_at":"2020-02-21T06:31:00Z","author_association":"MEMBER","body":"I'm closing this issue, these commits (^), seem to have stabilised this test.","performed_via_github_app":null}]