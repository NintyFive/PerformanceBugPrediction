{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15951","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15951/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15951/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15951/events","html_url":"https://github.com/elastic/elasticsearch/issues/15951","id":126410546,"node_id":"MDU6SXNzdWUxMjY0MTA1NDY=","number":15951,"title":"Allowing dots in field names","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":28,"created_at":"2016-01-13T12:42:18Z","updated_at":"2016-11-22T10:06:26Z","closed_at":"2016-05-16T08:36:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"As part of the Great Mapping Refactoring (#8870), we had to reject field names containing dots (https://github.com/elastic/elasticsearch/pull/12068), eg:\n\n```\n{ \n  \"foo.bar\": \"val1\",  \n  \"foo\": {\n    \"bar\": \"val2\"\n  }\n}\n```\n\nThe behaviour was undefined and resulted in ambiguities when trying to reference fields with the dot notation used in queries and aggregations.\n\nRemoving support for dots has caused pain for a number of users and especially as Elasticsearch is being used more and more for the metrics use case (where dotted fields are common), we should consider what we can do to improve this situation.  Now that mappings are much stricter (and immutable), it becomes feasible to revisit the question of whether to allow dots to occur in field names.  \n# Replace dots with another character\n\nThe first and simplest solution is to simply replace dots in field names with another character (eg `_`) as is done by the [Logstash de_dot filter](https://www.elastic.co/guide/en/logstash/current/plugins-filters-de_dot.html) and which will be supported natively in Elasticsearch by the [node ingest `de_dot` processor](https://github.com/elastic/elasticsearch/issues/15944).\n# Treat dots as paths\n\nAnother solution would be to treat fields with dots in them as \"paths\" rather than field names.  In other words, these two documents would be equivalent:\n\n```\n{ \"foo.bar\": \"value\" }\n{ \"foo\": { \"bar\": \"value\" }}\n```\n\nTo use an edge case as an example, the following document:\n\n```\n{\n  \"foo.bar\" : {\n    \"baz\": \"val1\"\n  },\n  \"foo\": {\n    \"bar.baz\": \"val2\"\n  }\n```\n\n  }\n\nwould result in the following mapping:\n\n```\n{\n  \"properties\": {\n    \"foo\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"bar\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"baz\": {\n              \"type\": \"string\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe lucene field would be called `foo.bar.baz` and would contain the terms `[\"val1\", \"val2]`.  Stored fields or doc values (for supported datatypes), would both contain `[\"val1\", \"val2\"]`.\n## Issues with this approach\n\nThis solution works well for search and aggregations, but leaves us with two incongruities:\n### `_source=`\n\nThe first occurs when using the `_source=` parameter to do source filtering on the response. The reason for this is that the `_source` field is stored as provided - it is not normalized before being stored  For instance:\n\n```\nGET _search?_source=foo.*\n```\n\nwould return:  \n\n```\n{\n  \"foo.bar\" : {\n    \"baz\": \"val1\"\n  },\n  \"foo\": {\n    \"bar.baz\": \"val2\"\n  }\n```\n\n  }\n\nrather than:\n\n```\n{\n  \"foo\": {\n    \"bar\": {\n      \"baz\": [\n        \"val1\",\n        \"val2\"\n      ]\n    }\n  }\n}\n```\n### Update requests\n\nThe second occurs during update requests, which uses the `_source` as a map-of-maps.  Running an update like:\n\n```\nPOST index/type/id/_update\n{\n  \"doc\": {\n    \"foo\": {\n      \"bar\": {\n        \"baz\": \"val3\"\n      }\n    }\n  }\n}\n```\n\ncould result (depending on how it is implemented) in any of the following:  \n\nVersion 1:\n\n```\n{\n  \"foo\": {\n    \"bar\": {\n      \"baz\": \"val3\"\n    }\n  }\n}\n```\n\nVersion 2: \n\n```\n{\n  \"foo\": {\n    \"bar\": {\n      \"baz\": [\n        \"val1\",\n        \"val2\",\n        \"val3\"\n      ]\n    }\n  }\n}\n```\n\nVersion 3: \n\n```\n{\n  \"foo.bar\": {\n    \"baz\": \"val1\"\n  },\n  \"foo\": {\n    \"bar.baz\": \"val2\",\n    \"bar\": {\n      \"baz\": \"val3\"\n    }\n  }\n}\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}