[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485446396","html_url":"https://github.com/elastic/elasticsearch/issues/41415#issuecomment-485446396","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41415","id":485446396,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTQ0NjM5Ng==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-04-22T15:15:47Z","updated_at":"2019-04-22T15:15:47Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485463730","html_url":"https://github.com/elastic/elasticsearch/issues/41415#issuecomment-485463730","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41415","id":485463730,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTQ2MzczMA==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2019-04-22T16:16:59Z","updated_at":"2019-04-22T16:16:59Z","author_association":"CONTRIBUTOR","body":"This is similar to this: #40586. Probably a case of needing to fulling setup the mock log appender before adding it as an appender.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485579890","html_url":"https://github.com/elastic/elasticsearch/issues/41415#issuecomment-485579890","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41415","id":485579890,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTU3OTg5MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-04-22T22:52:33Z","updated_at":"2019-04-22T22:52:51Z","author_association":"MEMBER","body":"This is caused by messages being sent outside the control of the test while expectations are being set up (which iterates the collection of expectations). Since adding a message causes an iteration of the collection of expectations, this occurring concurrently leads to a concurrent modification exception. There are two approaches here, one is to make the backing list an copy-on-write array list, and the other is to synchronize these methods. While in this specific test we could get around the issue by initializing the appender before the cluster forms (and therefore before such messages start being sent) (here it is messages from followers checker), I don't know that we can always take this approach and I would rather err on the safe side and deal with the concurrency issues. It looks like an approach with copy-on-write array list would be fine since we always set up expectations before we force some situation that we think is going to cause those expectations to be met. That means to me that we don't need to worry about synchronizing (for ordering guarantees), and using a copy-on-write array list is good so as to avoid bottlenecking these tests on logging.\r\n\r\nI opened #41424.","performed_via_github_app":null}]