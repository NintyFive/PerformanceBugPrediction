{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51847","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51847/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51847/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51847/events","html_url":"https://github.com/elastic/elasticsearch/issues/51847","id":559470240,"node_id":"MDU6SXNzdWU1NTk0NzAyNDA=","number":51847,"title":"Percentiles aggregation on histogram-type field of an object fails","user":{"login":"axw","id":843579,"node_id":"MDQ6VXNlcjg0MzU3OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/843579?v=4","gravatar_id":"","url":"https://api.github.com/users/axw","html_url":"https://github.com/axw","followers_url":"https://api.github.com/users/axw/followers","following_url":"https://api.github.com/users/axw/following{/other_user}","gists_url":"https://api.github.com/users/axw/gists{/gist_id}","starred_url":"https://api.github.com/users/axw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/axw/subscriptions","organizations_url":"https://api.github.com/users/axw/orgs","repos_url":"https://api.github.com/users/axw/repos","events_url":"https://api.github.com/users/axw/events{/privacy}","received_events_url":"https://api.github.com/users/axw/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-02-04T03:46:23Z","updated_at":"2020-02-05T10:36:15Z","closed_at":"2020-02-05T10:36:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.6.0 BC3\r\n\r\n    Version: 7.6.0, Build: default/docker/d90e0399161efda5d2386d9a1376ce1a11c070c6/2020-01-29T17:39:50.161706Z, JVM: 13.0.2\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version** (`java -version`):\r\n\r\n    openjdk version \"13.0.2\" 2020-01-14\r\n    OpenJDK Runtime Environment AdoptOpenJDK (build 13.0.2+8)\r\n    OpenJDK 64-Bit Server VM AdoptOpenJDK (build 13.0.2+8, mixed mode, sharing)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): \r\n\r\n    Linux f693bd1687ce 4.15.0-72-generic #81-Ubuntu SMP Tue Nov 26 12:20:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n(Running in Docker, FWIW.)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nUsing the new histogram field type, there seems to be differing behaviour when the field exists at the top level vs. as a field of another object. In particular, a `percentiles` aggregation works as expected on a top-level histogram field, but returns `null` for a histogram field within another object.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index mapping like so:\r\n\r\n```\r\nPUT /example\r\n{\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"foo\": {\r\n              \"properties\": {\r\n                \"bar\": {\r\n                  \"type\": \"histogram\"\r\n                },\r\n                \"baz\": {\r\n                  \"type\": \"double\"\r\n                }\r\n              }\r\n            },\r\n            \"qux\": {\r\n              \"type\": \"histogram\"\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n2. Index some data:\r\n\r\n```\r\nPOST /example/_doc\r\n{\r\n    \"foo\" : {\r\n      \"bar\": {\r\n        \"values\": [1, 2, 3, 4, 5],\r\n        \"counts\": [1, 2, 3, 4, 5]\r\n      },\r\n      \"baz\": [1, 2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5]\r\n    },\r\n    \"qux\": {\r\n      \"values\": [1, 2, 3, 4, 5],\r\n      \"counts\": [1, 2, 3, 4, 5]\r\n    }\r\n}\r\n```\r\n\r\n3. Run percentiles aggregation on each of `foo.bar`, `foo.baz`, and `qux`\r\n\r\n```\r\nGET /example/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"percentiles_object_field_histogram\": {\r\n      \"percentiles\": {\r\n        \"field\": \"foo.bar\",\r\n        \"percents\": [1, 5, 25, 50, 75, 95, 99]\r\n      }\r\n    },\r\n    \"percentiles_individual_data\": {\r\n      \"percentiles\": {\r\n        \"field\": \"foo.baz\",\r\n        \"percents\": [1, 5, 25, 50, 75, 95, 99]\r\n      }\r\n    },\r\n    \"percentiles_top_level_histogram\": {\r\n      \"percentiles\": {\r\n        \"field\": \"qux\",\r\n        \"percents\": [1, 5, 25, 50, 75, 95, 99]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nOutput:\r\n\r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  },\r\n  \"aggregations\" : {\r\n    \"percentiles_individual_data\" : {\r\n      \"values\" : {\r\n        \"1.0\" : 1.0,\r\n        \"5.0\" : 1.25,\r\n        \"25.0\" : 3.0,\r\n        \"50.0\" : 4.0,\r\n        \"75.0\" : 5.0,\r\n        \"95.0\" : 5.0,\r\n        \"99.0\" : 5.0\r\n      }\r\n    },\r\n    \"percentiles_top_level_histogram\" : {\r\n      \"values\" : {\r\n        \"1.0\" : 1.0,\r\n        \"5.0\" : 1.1666666666666667,\r\n        \"25.0\" : 2.7,\r\n        \"50.0\" : 3.857142857142857,\r\n        \"75.0\" : 4.722222222222222,\r\n        \"95.0\" : 5.0,\r\n        \"99.0\" : 5.0\r\n      }\r\n    },\r\n    \"percentiles_object_field_histogram\" : {\r\n      \"values\" : {\r\n        \"1.0\" : null,\r\n        \"5.0\" : null,\r\n        \"25.0\" : null,\r\n        \"50.0\" : null,\r\n        \"75.0\" : null,\r\n        \"95.0\" : null,\r\n        \"99.0\" : null\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI expect them all to succeed.","closed_by":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"performed_via_github_app":null}