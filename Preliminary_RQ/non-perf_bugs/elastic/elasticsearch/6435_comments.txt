[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45372676","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45372676","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45372676,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MzcyNjc2","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-06T19:01:03Z","updated_at":"2014-06-06T19:01:03Z","author_association":"NONE","body":"For completeness this is on:\n**jdk1.7.0_60**\njava version \"1.7.0_60\"\nJava(TM) SE Runtime Environment (build 1.7.0_60-b19)\nJava HotSpot(TM) 64-Bit Server VM (build 24.60-b09, mixed mode)\n\n**Windows 7 Enterprise**\n (Version 6.1 (Build7601: Service Pack 1)\n\n**Processor**\nAMD64\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45396331","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45396331","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45396331,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1Mzk2MzMx","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-06-07T00:31:25Z","updated_at":"2014-06-07T00:31:25Z","author_association":"CONTRIBUTOR","body":"Thanks for this, I haven't dug through what the test does so far but I ran it 10 times and got one failure. I will look into it soon...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45422880","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45422880","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45422880,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDIyODgw","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-07T22:26:52Z","updated_at":"2014-06-07T22:26:52Z","author_association":"NONE","body":"Great. Thanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45471326","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45471326","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45471326,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDcxMzI2","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-09T08:40:21Z","updated_at":"2014-06-09T08:40:21Z","author_association":"NONE","body":"If it helps, when I have seen this issue on live data, the aggregation consistently returned the wrong results.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45534737","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45534737","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45534737,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NTM0NzM3","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-06-09T19:42:55Z","updated_at":"2014-06-09T19:42:55Z","author_association":"CONTRIBUTOR","body":"The failure is 100% reproducible with some seeds, I've spent some time debugging it today and the issue is in the reduce logic. For some reason sometimes two distinct aggs from the tree reduce into the same aggregation, making the counts wrong. I'll be busy on the next two days but will have more time to look into it at the end of the week. I marked this issue as a blocker so that we don't release before this is fixed.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45589617","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45589617","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45589617,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NTg5NjE3","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-10T08:58:57Z","updated_at":"2014-06-10T08:58:57Z","author_association":"NONE","body":"Excellent. Thanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45847841","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45847841","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45847841,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODQ3ODQx","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-06-12T09:30:16Z","updated_at":"2014-06-12T09:30:16Z","author_association":"CONTRIBUTOR","body":"OK, I found the (sneaky) issue, which only occurs when using the local transport and some buckets are empty:\n- RangeAggregator.buildEmptyAggregation uses the same empty aggregation instances for all buckets\n- Then buckets get reduced in-place, which is going to modify these sub aggs, that are shared by all DateRange buckets.\n\nThis is a one-line fix but I'm afraid other aggregations might have a similar bug so I'll see if I can try to fix it in a general way, eg. by making aggregations immutable...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45848172","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45848172","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45848172,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODQ4MTcy","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-12T09:34:05Z","updated_at":"2014-06-12T09:34:05Z","author_association":"NONE","body":"Excellent. Can you let me know the one-line change so I can patch locally? (Will the making aggregations immutable take long?)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45848386","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45848386","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45848386,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODQ4Mzg2","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-06-12T09:37:03Z","updated_at":"2014-06-12T09:37:03Z","author_association":"CONTRIBUTOR","body":"Hopefully it won't take too long but here is the one-line fix I was talking about:\n\n``` patch\ndiff --git a/src/main/java/org/elasticsearch/search/aggregations/bucket/range/RangeAggregator.java b/src/main/java/org/elasticsearch/search/aggregations/bucket/range/RangeAggregator.java\nindex d9c8af6..57bb1c7 100644\n--- a/src/main/java/org/elasticsearch/search/aggregations/bucket/range/RangeAggregator.java\n+++ b/src/main/java/org/elasticsearch/search/aggregations/bucket/range/RangeAggregator.java\n@@ -208,10 +208,10 @@ public class RangeAggregator extends BucketsAggregator {\n\n     @Override\n     public InternalAggregation buildEmptyAggregation() {\n-        InternalAggregations subAggs = buildEmptySubAggregations();\n         List<org.elasticsearch.search.aggregations.bucket.range.Range.Bucket> buckets = Lists.newArrayListWithCapacity(ranges.length);\n         for (int i = 0; i < ranges.length; i++) {\n             Range range = ranges[i];\n+            InternalAggregations subAggs = buildEmptySubAggregations();\n             org.elasticsearch.search.aggregations.bucket.range.Range.Bucket bucket =\n                     rangeFactory.createBucket(range.key, range.from, range.to, 0, subAggs, formatter);\n             buckets.add(bucket);\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/45849554","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-45849554","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":45849554,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODQ5NTU0","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-12T09:51:21Z","updated_at":"2014-06-12T09:51:21Z","author_association":"NONE","body":"Thanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/46284017","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-46284017","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":46284017,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Mjg0MDE3","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-06-17T09:10:08Z","updated_at":"2014-06-17T09:10:08Z","author_association":"NONE","body":"Thanks! What release is this going into? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/46310409","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-46310409","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":46310409,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzEwNDA5","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-06-17T14:02:52Z","updated_at":"2014-06-17T14:02:52Z","author_association":"CONTRIBUTOR","body":"This will be in 1.2.2 and 1.3.0.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48345039","html_url":"https://github.com/elastic/elasticsearch/issues/6435#issuecomment-48345039","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","id":48345039,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MzQ1MDM5","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"created_at":"2014-07-08T14:39:08Z","updated_at":"2014-07-08T14:39:35Z","author_association":"NONE","body":"When is 1.2.2 scheduled for? (roughly)\n","performed_via_github_app":null}]