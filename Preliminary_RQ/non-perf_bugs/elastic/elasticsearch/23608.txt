{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23608","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23608/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23608/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23608/events","html_url":"https://github.com/elastic/elasticsearch/issues/23608","id":214692026,"node_id":"MDU6SXNzdWUyMTQ2OTIwMjY=","number":23608,"title":"Reindex: illegal_argument_exception \"mapper [xxx] of different type\".  int/str coercion not performed and ignore_malformed not respected","user":{"login":"dseeley","id":5869991,"node_id":"MDQ6VXNlcjU4Njk5OTE=","avatar_url":"https://avatars3.githubusercontent.com/u/5869991?v=4","gravatar_id":"","url":"https://api.github.com/users/dseeley","html_url":"https://github.com/dseeley","followers_url":"https://api.github.com/users/dseeley/followers","following_url":"https://api.github.com/users/dseeley/following{/other_user}","gists_url":"https://api.github.com/users/dseeley/gists{/gist_id}","starred_url":"https://api.github.com/users/dseeley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dseeley/subscriptions","organizations_url":"https://api.github.com/users/dseeley/orgs","repos_url":"https://api.github.com/users/dseeley/repos","events_url":"https://api.github.com/users/dseeley/events{/privacy}","received_events_url":"https://api.github.com/users/dseeley/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-03-16T12:43:29Z","updated_at":"2018-02-13T19:42:02Z","closed_at":"2017-06-20T11:47:14Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.2.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_121\r\n\r\n**OS version**: Centos 7.3.1611\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen batch/scroll size is greater than 1, reindexing does not perform type coercion from int to str.  It also does not respect the ignore_malformed directive on the destination index mapping. \r\n1. If a type is mapped as a string type, and a document is sent that has an integer as that type, reindexing fails (where the original indexing process had coerced it into a string).  \r\n1. If a type is mapped as an integer type, and a document is sent that has an string as that type, reindexing fails (where the original indexing process had not indexed the field due to ignore_malformed)\r\n\r\nPresumably this happens when a batch contains conflicting types.  Setting the batch/scroll size to 1 fixes this, but is not viable for reindexing large indexes.\r\n\r\n**Steps to reproduce**:\r\n\r\nThe order that the reindex picks the documents from the source doesn't appear to be deterministic, but one of the issues above is seen by the following:\r\n\r\n```\r\ncurl -XDELETE 'localhost:9200/reindextestsrc'\r\ncurl -XDELETE 'localhost:9200/reindextestdest'\r\n\r\ncurl -XPUT 'localhost:9200/reindextestsrc?pretty' -d'{\r\n  \"settings\": {\r\n    \"index.mapping.ignore_malformed\": true,\r\n    \"index.mapping.coerce\": true\r\n  },\r\n  \"mappings\": {\r\n    \"_default_\": { \"numeric_detection\": true }\r\n  }\r\n}'\r\n\r\ncurl -XPUT 'localhost:9200/reindextestdest?pretty' -d'{\r\n  \"settings\": {\r\n    \"index.mapping.ignore_malformed\": true,\r\n    \"index.mapping.coerce\": true\r\n  },\r\n  \"mappings\": {\r\n    \"_default_\": { \"numeric_detection\": true }\r\n  }\r\n}'\r\n\r\ncurl -XPUT 'localhost:9200/reindextestsrc/person/1' -d '{\r\n    \"name\": \"Fred\",\r\n    \"age\": \"unknown\"\r\n}'\r\n\r\ncurl -XPUT 'localhost:9200/reindextestsrc/person/2' -d '{\r\n    \"name\": \"John\",\r\n    \"age\": 25\r\n}'\r\n\r\ncurl -XPUT 'localhost:9200/reindextestsrc/person/3' -d '{\r\n    \"name\": \"Jim\",\r\n    \"age\": \"unknown\"\r\n}'\r\n```\r\n\r\nThen attempt a reindex:\r\n```\r\ncurl -XPOST 'localhost:9200/_reindex?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"conflicts\": \"proceed\",\r\n  \"source\": {\r\n    \"index\": \"reindextestsrc\",\r\n    \"size\": 1000,\r\n    \"sort\": \"_uid\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"reindextestdest\"\r\n  }\r\n}\r\n'\r\n```\r\n\r\n***Response:***\r\n```\r\n{\r\n  \"took\" : 32,\r\n  \"timed_out\" : false,\r\n  \"total\" : 3,\r\n  \"updated\" : 0,\r\n  \"created\" : 2,\r\n  \"deleted\" : 0,\r\n  \"batches\" : 1,\r\n  \"version_conflicts\" : 0,\r\n  \"noops\" : 0,\r\n  \"retries\" : {\r\n    \"bulk\" : 0,\r\n    \"search\" : 0\r\n  },\r\n  \"throttled_millis\" : 0,\r\n  \"requests_per_second\" : -1.0,\r\n  \"throttled_until_millis\" : 0,\r\n  \"failures\" : [\r\n    {\r\n      \"index\" : \"reindextestdest\",\r\n      \"type\" : \"person\",\r\n      \"id\" : \"3\",\r\n      \"cause\" : {\r\n        \"type\" : \"illegal_argument_exception\",\r\n        \"reason\" : \"mapper [age] of different type, current_type [long], merged_type [text]\"\r\n      },\r\n      \"status\" : 400\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nBy setting _size_ to 1, the reindex succeeds, but this is not viable on sizeable indexes.","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}