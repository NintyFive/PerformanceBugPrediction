{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35985","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35985/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35985/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35985/events","html_url":"https://github.com/elastic/elasticsearch/issues/35985","id":385183594,"node_id":"MDU6SXNzdWUzODUxODM1OTQ=","number":35985,"title":"Child query error when using `_score` script in nested aggregation","user":{"login":"worldsayshi","id":930909,"node_id":"MDQ6VXNlcjkzMDkwOQ==","avatar_url":"https://avatars2.githubusercontent.com/u/930909?v=4","gravatar_id":"","url":"https://api.github.com/users/worldsayshi","html_url":"https://github.com/worldsayshi","followers_url":"https://api.github.com/users/worldsayshi/followers","following_url":"https://api.github.com/users/worldsayshi/following{/other_user}","gists_url":"https://api.github.com/users/worldsayshi/gists{/gist_id}","starred_url":"https://api.github.com/users/worldsayshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/worldsayshi/subscriptions","organizations_url":"https://api.github.com/users/worldsayshi/orgs","repos_url":"https://api.github.com/users/worldsayshi/repos","events_url":"https://api.github.com/users/worldsayshi/events{/privacy}","received_events_url":"https://api.github.com/users/worldsayshi/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-11-28T09:49:11Z","updated_at":"2018-11-29T13:35:26Z","closed_at":"2018-11-29T13:35:26Z","author_association":"NONE","active_lock_reason":null,"body":"[Please see my self contained reproduction repository here](https://github.com/worldsayshi/elastic-nested-issue-repro).\r\n\r\nI get an error when trying to run a query that seems reasonable to me. I'm able to avoid the error by setting size to 1.\r\n\r\n**Elasticsearch version**: `6.4.2`, `6.5.1` and `7.0.0-alpha1`\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version**: I'm running the official elastic docker image\r\n\r\n**OS version**: I'm running the official elastic docker image\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\n[Please see my self contained reproduction repository here](https://github.com/worldsayshi/elastic-nested-issue-repro). It contains all the steps. \r\n\r\nHere's the query used in the reproduction:\r\n\r\n```json\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"nested\": {\r\n      \"query\": {\r\n        \"match\": {\r\n          \"dimension_filter_nested.name\": {\r\n            \"query\": \"Meine produktkategorie wellendurchmesser\"\r\n          }\r\n        }\r\n      },\r\n      \"path\": \"dimension_filter_nested\"\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"my-agg-1\": {\r\n      \"filter\": {\r\n        \"terms\": {\r\n          \"taxonomy.raw\": [\"/Meine produktkategorie\"]\r\n        }\r\n      },\r\n      \"aggregations\": {\r\n        \"my-agg-2\": {\r\n          \"nested\": {\r\n            \"path\": \"dimension_filter_nested\"\r\n          },\r\n          \"aggregations\": {\r\n            \"my-agg-3\": {\r\n              \"terms\": {\r\n                \"field\": \"dimension_filter_nested.name.raw\",\r\n                \"size\": 10,\r\n                \"order\": [{\r\n                  \"max_score\": \"desc\"\r\n                }, {\r\n                  \"_key\": \"asc\"\r\n                }]\r\n              },\r\n              \"aggregations\": {\r\n                \"max_score\": {\r\n                  \"max\": {\r\n                    \"script\": {\r\n                      \"source\": \"_score\",\r\n                      \"lang\": \"painless\"\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe error (`7.0.0-alpha1`):\r\n\r\n```json\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"script_exception\",\r\n        \"reason\" : \"runtime error\",\r\n        \"script_stack\" : [\r\n          \"org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer.setScoreAndFreq(ToParentBlockJoinQuery.java:349)\",\r\n          \"org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer.score(ToParentBlockJoinQuery.java:309)\",\r\n          \"org.apache.lucene.search.ConjunctionScorer.score(ConjunctionScorer.java:59)\",\r\n          \"org.apache.lucene.search.FilterScorable.score(FilterScorable.java:46)\",\r\n          \"org.elasticsearch.script.AggregationScript.get_score(AggregationScript.java:124)\",\r\n          \"<<< unknown portion of script >>>\"\r\n        ],\r\n        \"script\" : \"_score\",\r\n        \"lang\" : \"painless\"\r\n      }\r\n    ],\r\n    \"type\" : \"search_phase_execution_exception\",\r\n    \"reason\" : \"all shards failed\",\r\n    \"phase\" : \"query\",\r\n    \"grouped\" : true,\r\n    \"failed_shards\" : [\r\n      {\r\n        \"shard\" : 0,\r\n        \"index\" : \"integration_test_index_de\",\r\n        \"node\" : \"VmWbmOc3SbSLmb8LNQml0A\",\r\n        \"reason\" : {\r\n          \"type\" : \"script_exception\",\r\n          \"reason\" : \"runtime error\",\r\n          \"script_stack\" : [\r\n            \"org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer.setScoreAndFreq(ToParentBlockJoinQuery.java:349)\",\r\n            \"org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinScorer.score(ToParentBlockJoinQuery.java:309)\",\r\n            \"org.apache.lucene.search.ConjunctionScorer.score(ConjunctionScorer.java:59)\",\r\n            \"org.apache.lucene.search.FilterScorable.score(FilterScorable.java:46)\",\r\n            \"org.elasticsearch.script.AggregationScript.get_score(AggregationScript.java:124)\",\r\n            \"<<< unknown portion of script >>>\"\r\n          ],\r\n          \"script\" : \"_score\",\r\n          \"lang\" : \"painless\",\r\n          \"caused_by\" : {\r\n            \"type\" : \"illegal_state_exception\",\r\n            \"reason\" : \"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.TermScorer\"\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\" : 400\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}