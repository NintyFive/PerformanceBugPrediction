{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009/events","html_url":"https://github.com/elastic/elasticsearch/issues/8009","id":45091629,"node_id":"MDU6SXNzdWU0NTA5MTYyOQ==","number":8009,"title":"Shard initialization fails with DocValues exception","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":21,"created_at":"2014-10-07T10:28:12Z","updated_at":"2014-12-31T16:54:39Z","closed_at":"2014-12-31T16:54:39Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\n  we have been running into strange errors lately. We get a lot of exceptions of the type: \n\n```\n[2014-10-07 06:41:26,235][WARN ][cluster.action.shard     ] [Madcap] [my_index][1] sending failed shard for [my_index][1], node[-QGTVk8RRcuKuBwdqD8l1A], [P], s[INITIALIZING], indexUUID [u68VqfHsRii16gYXtPj1cQ], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[my_index][1] failed recovery]; nested: IllegalArgumentException[cannot change DocValues type from BINARY to SORTED_SET for field \"custom.my_field\"]; ]]\n[2014-10-07 06:41:26,587][WARN ][indices.cluster          ] [Madcap] [my_index][1] failed to start shard\norg.elasticsearch.index.gateway.IndexShardGatewayRecoveryException: [my_index][1] failed recovery\n  at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:185)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n  at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalArgumentException: cannot change DocValues type from BINARY to SORTED_SET for field \"custom.my_field\"\n  at org.apache.lucene.index.FieldInfos$FieldNumbers.addOrGet(FieldInfos.java:198)\n  at org.apache.lucene.index.IndexWriter.getFieldNumberMap(IndexWriter.java:868)\n  at org.apache.lucene.index.IndexWriter.<init>(IndexWriter.java:819)\n  at org.elasticsearch.index.engine.internal.InternalEngine.createWriter(InternalEngine.java:1420)\n  at org.elasticsearch.index.engine.internal.InternalEngine.start(InternalEngine.java:271)\n  at org.elasticsearch.index.shard.service.InternalIndexShard.postRecovery(InternalIndexShard.java:692)\n  at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:217)\n  at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:132)\n  ... 3 more\n```\n\n  We are in a daily index situation so the index is quite new. It contains 10 to 20 millions of documents spread over 10 shards and 5 nodes. At some point (after hours of the index being green), one of the shards becomes INITALIZING and can never start (because of the aforementioned exception). The index is then in red state and we cannot set it back on track... In this case the only solution we have found is to scroll over the whole index and reindex the data into a new index (but we most likely have lost the data from the failing shard). The field that causes the issue has the following definition `{\"type\":\"long\",\"doc_values\":true,\"include_in_all\":false}`. This mapping is inferred from a dynamic template `{\"mapping\":{\"index\":\"not_analyzed\",\"include_in_all\":false,\"doc_values\":true,\"type\":\"{dynamic_type}\"},\"match\":\"*\"}`.\n  One important note is that this part of the data is free-form (ie user input) and it is possible that some documents have conflicting types (one document having the field as string, the other as long); that's why the index has the setting `index.mapping.ignore_malformed` set to `true`.\n  Also, it might not be relevant, but this only happened on days when we had at least one node that was restarted.\n  We have noticed this issue since running ElasticSearch 1.3.4 (but can't be 100% sure that it did not happen before).\n\n  We cannot isolate and reproduce the issue but have faced it several times over the past few days. Feel free to suggest actions we can undertake should it happen again, to get more details to help fix it. Also, if you have suggestions to help bypass the issue when it happens (so that we can avoid reindexing the data), that'd be great.\n\nThanks,\nEmmanuel\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}