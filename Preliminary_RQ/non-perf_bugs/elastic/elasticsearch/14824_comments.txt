[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/157669504","html_url":"https://github.com/elastic/elasticsearch/issues/14824#issuecomment-157669504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14824","id":157669504,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NzY2OTUwNA==","user":{"login":"jaranflaath","id":112975,"node_id":"MDQ6VXNlcjExMjk3NQ==","avatar_url":"https://avatars0.githubusercontent.com/u/112975?v=4","gravatar_id":"","url":"https://api.github.com/users/jaranflaath","html_url":"https://github.com/jaranflaath","followers_url":"https://api.github.com/users/jaranflaath/followers","following_url":"https://api.github.com/users/jaranflaath/following{/other_user}","gists_url":"https://api.github.com/users/jaranflaath/gists{/gist_id}","starred_url":"https://api.github.com/users/jaranflaath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaranflaath/subscriptions","organizations_url":"https://api.github.com/users/jaranflaath/orgs","repos_url":"https://api.github.com/users/jaranflaath/repos","events_url":"https://api.github.com/users/jaranflaath/events{/privacy}","received_events_url":"https://api.github.com/users/jaranflaath/received_events","type":"User","site_admin":false},"created_at":"2015-11-18T10:17:49Z","updated_at":"2015-11-18T10:17:49Z","author_association":"NONE","body":"After some more digging and discussions on Freenode, I have now found a solution and provided an example in the \"solution\" branch in the example repository: https://github.com/jaranflaath/es-plugin-integrationtest/tree/solution\n\nHowever, I would love some feedback on what is the proper way to do this. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/157924599","html_url":"https://github.com/elastic/elasticsearch/issues/14824#issuecomment-157924599","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14824","id":157924599,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NzkyNDU5OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2015-11-19T02:08:33Z","updated_at":"2015-11-19T02:25:30Z","author_association":"MEMBER","body":"> it will receive an error due to the assert in org.elasticsearch.transport.Transports which is checking if the current thread is a transport thread\n\nThis is by design. In your [code](https://github.com/jaranflaath/es-plugin-integrationtest/commit/89b755fcff38b4756dfba0b4d439e9ab8d5bce3c#diff-f70cd741ee6d7246193213cc8db54748R31), you're sending a secondary request on the thread that is handling the initial request to the endpoint `/cluster_status`. The handling of that initial request happens on a network thread, and by sending the secondary request on that thread you'd be blocking a network thread until a response comes back. Blocking network threads is bad and we go to great lengths to prevent it.\n\nYour solution \"works\" because you got the [secondary request off of the network thread](https://github.com/jaranflaath/es-plugin-integrationtest/blob/b85452b121b1e0086abcf26071e3c904a374e8b4/src/main/java/ske/skatt/elasticsearch/PluginRestEndpoint.java#L34), but it has the problem that it is surreptitiously blocking the network thread by [busy waiting for a response](https://github.com/jaranflaath/es-plugin-integrationtest/blob/b85452b121b1e0086abcf26071e3c904a374e8b4/src/main/java/ske/skatt/elasticsearch/PluginRestEndpoint.java#L46-L48).\n\n> However, I would love some feedback on what is the proper way to do this.\n\nThe preferred way to handle situations like this is to attach a listener to the secondary request. You'll want to do something like this:\n\n``` java\n@Override\npublic void handleRequest(final RestRequest request, final RestChannel channel, Client client) {\n  client.admin().cluster().prepareHealth().execute(new RestBuilderListener<ClusterHealthResponse>(channel) {\n    @Override\n    public RestResponse buildResponse(ClusterHealthResponse clusterIndexHealths, XContentBuilder xContentBuilder) throws Exception {\n      return new BytesRestResponse(OK, clusterIndexHealths.getStatus().name());\n    }\n  });\n}\n```\n\nThis gets your secondary request off of the network thread and does not block the network thread waiting for a response to that request.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/157956897","html_url":"https://github.com/elastic/elasticsearch/issues/14824#issuecomment-157956897","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14824","id":157956897,"node_id":"MDEyOklzc3VlQ29tbWVudDE1Nzk1Njg5Nw==","user":{"login":"jaranflaath","id":112975,"node_id":"MDQ6VXNlcjExMjk3NQ==","avatar_url":"https://avatars0.githubusercontent.com/u/112975?v=4","gravatar_id":"","url":"https://api.github.com/users/jaranflaath","html_url":"https://github.com/jaranflaath","followers_url":"https://api.github.com/users/jaranflaath/followers","following_url":"https://api.github.com/users/jaranflaath/following{/other_user}","gists_url":"https://api.github.com/users/jaranflaath/gists{/gist_id}","starred_url":"https://api.github.com/users/jaranflaath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaranflaath/subscriptions","organizations_url":"https://api.github.com/users/jaranflaath/orgs","repos_url":"https://api.github.com/users/jaranflaath/repos","events_url":"https://api.github.com/users/jaranflaath/events{/privacy}","received_events_url":"https://api.github.com/users/jaranflaath/received_events","type":"User","site_admin":false},"created_at":"2015-11-19T05:33:26Z","updated_at":"2015-11-19T05:33:26Z","author_association":"NONE","body":"Thanks a lot for your feedback and suggested solution. Will give it a try :)\n","performed_via_github_app":null}]