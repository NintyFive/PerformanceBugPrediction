{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32130","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32130/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32130/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32130/events","html_url":"https://github.com/elastic/elasticsearch/issues/32130","id":341942185,"node_id":"MDU6SXNzdWUzNDE5NDIxODU=","number":32130,"title":"Broken sort on multiple-level nested documents","user":{"login":"JulienColin","id":2394029,"node_id":"MDQ6VXNlcjIzOTQwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/2394029?v=4","gravatar_id":"","url":"https://api.github.com/users/JulienColin","html_url":"https://github.com/JulienColin","followers_url":"https://api.github.com/users/JulienColin/followers","following_url":"https://api.github.com/users/JulienColin/following{/other_user}","gists_url":"https://api.github.com/users/JulienColin/gists{/gist_id}","starred_url":"https://api.github.com/users/JulienColin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JulienColin/subscriptions","organizations_url":"https://api.github.com/users/JulienColin/orgs","repos_url":"https://api.github.com/users/JulienColin/repos","events_url":"https://api.github.com/users/JulienColin/events{/privacy}","received_events_url":"https://api.github.com/users/JulienColin/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-07-17T14:23:22Z","updated_at":"2018-07-25T09:02:56Z","closed_at":"2018-07-20T14:55:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** : 6.3.1 and below\r\n\r\n**JVM version** : 1.8.0_171\r\n\r\n**OS version** : Ubuntu 16.04 LTS\r\n\r\n**Expected behaviours** : \r\ncorrect sort. The family with id=2 should get a sort value of 30 in the example below.\r\n\r\n**Problem description** : \r\nfaulty sort when querying on a 3-levels nested objects model, and sorting parent objects on a field from the lower level. In the example below, family with id=2 is getting a sort value of 10 while it should be 30 (the value 10 doesn't even appear in the document with id=2).\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index\r\n``\r\nPUT tree \r\n{ \"settings\": {\"number_of_shards\": 1,\"number_of_replicas\": 0 } }\r\n``\r\n\r\n2. Put mapping\r\n``\r\nPUT tree/family/_mapping\r\n{\"properties\":{\"name\":{\"type\":\"keyword\"},\"members\":{\"type\":\"nested\",\"properties\":{\"firstname\":{\"type\":\"keyword\"},\"color\":{\"type\":\"keyword\"},\"levels\":{\"type\":\"nested\",\"properties\":{\"strength\":{\"type\":\"integer\"}}}}}}}\r\n``\r\n\r\n3. Insert data (bulk index API)\r\n``\r\nPOST _bulk\r\n{ \"index\" : { \"_index\" : \"tree\", \"_type\" : \"family\", \"_id\" : \"1\" } }\r\n{\"name\":\"Doe\",\"members\":[{\"firstName\":\"John\",\"color\":\"brown\",\"levels\":{\"strength\":10}},{\"firstName\":\"Serge\",\"color\":\"brown\",\"levels\":{\"strength\":15}},{\"firstName\":\"Marie\",\"color\":\"brown\",\"levels\":{\"strength\":20}}]}\r\n{ \"index\" : { \"_index\" : \"tree\", \"_type\" : \"family\", \"_id\" : \"2\" } }\r\n{\"name\":\"Simpson\",\"members\":[{\"firstName\":\"Homer\",\"color\":\"brown\",\"levels\":{\"strength\":30}},{\"firstName\":\"Lisa\",\"color\":\"brown\",\"levels\":{\"strength\":40}},{\"firstName\":\"Marge\",\"color\":\"brown\",\"levels\":{\"strength\":60}}]}\r\n{ \"index\" : { \"_index\" : \"tree\", \"_type\" : \"family\", \"_id\" : \"3\" } }\r\n{\"name\":\"Simpson\",\"members\":[{\"firstName\":\"Bart\",\"color\":\"yellow\",\"levels\":{\"strength\":70}},{\"firstName\":\"Snowball\",\"color\":\"yellow\",\"levels\":{\"strength\":80}},{\"firstName\":\"Maggie\",\"color\":\"yellow\",\"levels\":{\"strength\":90}},{\"firstName\":\"Gandpa\",\"color\":\"brown\",\"levels\":{\"strength\":95}}]}\r\n``\r\n\r\n4. Query\r\n``\r\nGET tree/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"name\": {\r\n              \"value\": \"Simpson\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"path\" : \"members\",\r\n  \t\t\t\t\t\"query\": {\r\n  \t\t\t\t\t    \"bool\" : {\r\n  \t\t\t\t\t      \"filter\" : [\r\n  \t\t\t\t\t          {\r\n          \t\t\t\t\t\t\t\"term\" : {\r\n          \t\t\t\t\t\t\t\t\"members.color\" :  {\r\n          \t\t\t\t\t\t\t\t  \"value\" : \"brown\"\r\n          \t\t\t\t\t\t\t\t}\r\n          \t\t\t\t\t\t\t}\r\n  \t\t\t\t\t          }\r\n  \t\t\t\t\t       ]\r\n  \t\t\t\t\t    }\r\n  \t\t\t\t\t\t}\r\n  \t\t\t\t}\r\n\t\t\t\t}\r\n       ]\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"members.levels.strength\": {\r\n        \"order\": \"asc\",\r\n  \t\t\t\"nested\": {\r\n  \t\t\t\t\"path\": \"members\",\r\n  \t\t\t\t\"filter\": {\r\n  \t\t\t\t\t\"term\" : {\r\n  \t\t\t\t\t\t\"members.color\" : {\r\n  \t\t\t\t\t\t\t\"value\" : \"brown\"\r\n  \t\t\t\t\t\t}\r\n  \t\t\t\t\t}\r\n  \t\t\t\t},\r\n  \t\t\t\t\"nested\": {\r\n  \t\t\t\t\t\"path\": \"members.levels\"\r\n  \t\t\t\t}\r\n  \t\t\t}\r\n      }\r\n    }\r\n  ]\r\n}\r\n``\r\n\r\n5. Results\r\n``\r\n{\r\n  \"hits\": {\r\n    \"total\": 2,\r\n    \"max_score\": null,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"tree\",\r\n        \"_type\": \"family\",\r\n        \"_id\": \"2\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"name\": \"Simpson\",\r\n          \"members\": [\r\n            {\r\n              \"firstName\": \"Homer\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 30\r\n              }\r\n            },\r\n            {\r\n              \"firstName\": \"Lisa\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 40\r\n              }\r\n            },\r\n            {\r\n              \"firstName\": \"Marge\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 60\r\n              }\r\n            }\r\n          ]\r\n        },\r\n        \"sort\": [\r\n          10\r\n        ]\r\n      },\r\n     ...\r\n    ]\r\n  }\r\n}\r\n``\r\n---\r\n**Note that the result of the query above is correct if the index API was used instead of the bulk API, using the commands below :**\r\n``\r\nPOST tree/family\r\n{\"name\":\"Doe\",\"members\":[{\"firstName\":\"John\",\"color\":\"brown\",\"levels\":{\"strength\":10}},{\"firstName\":\"Serge\",\"color\":\"brown\",\"levels\":{\"strength\":15}},{\"firstName\":\"Marie\",\"color\":\"brown\",\"levels\":{\"strength\":20}}]}\r\nPOST tree/family\r\n{\"name\":\"Simpson\",\"members\":[{\"firstName\":\"Homer\",\"color\":\"brown\",\"levels\":{\"strength\":30}},{\"firstName\":\"Lisa\",\"color\":\"brown\",\"levels\":{\"strength\":40}},{\"firstName\":\"Marge\",\"color\":\"brown\",\"levels\":{\"strength\":60}}]}\r\nPOST tree/family\r\n{\"name\":\"Simpson\",\"members\":[{\"firstName\":\"Bart\",\"color\":\"yellow\",\"levels\":{\"strength\":70}},{\"firstName\":\"Snowball\",\"color\":\"yellow\",\"levels\":{\"strength\":80}},{\"firstName\":\"Maggie\",\"color\":\"yellow\",\"levels\":{\"strength\":90}},{\"firstName\":\"Gandpa\",\"color\":\"brown\",\"levels\":{\"strength\":95}}]} \r\n``\r\n\r\n_See following discussion : https://discuss.elastic.co/t/issue-sorting-nested-documents-indexed-via-bulk/139164_","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}