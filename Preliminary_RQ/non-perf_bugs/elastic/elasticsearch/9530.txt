{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9530","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9530/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9530/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9530/events","html_url":"https://github.com/elastic/elasticsearch/issues/9530","id":56257092,"node_id":"MDU6SXNzdWU1NjI1NzA5Mg==","number":9530,"title":"automatic string splitting in scripted aggregation is wrong","user":{"login":"ltworf","id":1379609,"node_id":"MDQ6VXNlcjEzNzk2MDk=","avatar_url":"https://avatars1.githubusercontent.com/u/1379609?v=4","gravatar_id":"","url":"https://api.github.com/users/ltworf","html_url":"https://github.com/ltworf","followers_url":"https://api.github.com/users/ltworf/followers","following_url":"https://api.github.com/users/ltworf/following{/other_user}","gists_url":"https://api.github.com/users/ltworf/gists{/gist_id}","starred_url":"https://api.github.com/users/ltworf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ltworf/subscriptions","organizations_url":"https://api.github.com/users/ltworf/orgs","repos_url":"https://api.github.com/users/ltworf/repos","events_url":"https://api.github.com/users/ltworf/events{/privacy}","received_events_url":"https://api.github.com/users/ltworf/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-02-02T16:20:53Z","updated_at":"2015-02-02T16:30:50Z","closed_at":"2015-02-02T16:23:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI've been using scripted aggregations with the newer version of elasticsearch and I've encountered a problem.\n\nBasically strings are automatically split before they are passed to the scripting language, and this is causing my aggregation to act a bit weird.\n\n```\ncurl -XPUT localhost:9200/test/test/1 -d '\n { \"title\": \"test document\", \"genre\": \"science fiction/horror\"}\n '\n\n\ncurl -XPOST  localhost:9200/test/_search -d '\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"aggs\": {\n    \"genre\": {\n      \"scripted_metric\": {\n        \"init_script\": \"_agg.genre = [:]\",\n        \"map_script\": \"for (i=0; i<doc[\\\"genre\\\"].size(); i++) _agg.genre.put(doc[\\\"genre\\\"][i],_agg.genre.get (doc[\\\"genre\\\"][i],0)+1)\",\n        \"reduce_script\": \"retval = [:];for (i in 0.._aggs.genre.size()) {for ( e in _aggs.genre[i] ) {retval.put(e.key,retval.get(e.key,0)+e.value)}};return retval;\"\n      }\n    }\n  }\n}\n'\n```\n\nThe aggregation is meant to count how many documents per genre there are, and a document can have multiple genres, all in the same string, separated by a `/` symbol. However the automatic split will also split on ` ` and it will be like there are three genres when there are in fact only two.\n\nI believe it would be best if the string was left untouched and just passed as it is, and the script can split it, if it is necessary, and on the symbols that are supposed to be separators in the specific case.\n\nBest\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}