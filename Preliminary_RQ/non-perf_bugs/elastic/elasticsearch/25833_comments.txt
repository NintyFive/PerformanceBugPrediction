[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317116918","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-317116918","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":317116918,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzExNjkxOA==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2017-07-21T21:29:25Z","updated_at":"2017-07-21T21:29:25Z","author_association":"CONTRIBUTOR","body":"Thanks @gmoskovicz \r\n\r\n> So we are trying to get rid of quadtree, but yet it is still the fastest and should be the default?\r\n\r\nI probably confused you a bit...cause English :)  [Quadtree](https://en.wikipedia.org/wiki/Quadtree) is a general algorithm for rasterizing geoshapes. How those quad raster cells are encoded in lucene's terms dictionary depends on the `\"tree\"` parameter which tells Lucene to encode either as a [geohash](https://en.wikipedia.org/wiki/Geohash) string or packed binary [Morton](https://en.wikipedia.org/wiki/Z-order_curve) code. Packed morton encoding (selected by setting `\"tree\" : \"quadtree\"` is faster (index and query) and consumes less disk space than using `\"geohash\"` so that's why quadtree encoding is recommended. \r\n\r\nNow, index and query speed is directly related to shape size and resolution because under the hood of Lucene each quad raster cell is converted into a bounding box and compared to the vectorized shape using a call to the `JtsGeometry.relate` method you reference in #2157. The higher the resolution the more cells are created (like a high resolution image) so the more calls to `relate`; and that method is slow. This is the general problem with using a raster based quadtree. For this reason we're working toward migrating to a `B-kd` based `geo_shape` indexing approach and (eventually) moving away from quadtrees altogether. \r\n\r\nHopefully that makes more sense.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317306987","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-317306987","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":317306987,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzMwNjk4Nw==","user":{"login":"karesh","id":2954714,"node_id":"MDQ6VXNlcjI5NTQ3MTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2954714?v=4","gravatar_id":"","url":"https://api.github.com/users/karesh","html_url":"https://github.com/karesh","followers_url":"https://api.github.com/users/karesh/followers","following_url":"https://api.github.com/users/karesh/following{/other_user}","gists_url":"https://api.github.com/users/karesh/gists{/gist_id}","starred_url":"https://api.github.com/users/karesh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karesh/subscriptions","organizations_url":"https://api.github.com/users/karesh/orgs","repos_url":"https://api.github.com/users/karesh/repos","events_url":"https://api.github.com/users/karesh/events{/privacy}","received_events_url":"https://api.github.com/users/karesh/received_events","type":"User","site_admin":false},"created_at":"2017-07-24T02:53:43Z","updated_at":"2017-07-24T02:53:43Z","author_association":"NONE","body":"@nknize is this the reason for my issue #25844 ? \r\nfor bigger polygon the index is slow.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317775928","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-317775928","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":317775928,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzc3NTkyOA==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2017-07-25T15:29:41Z","updated_at":"2017-07-25T15:29:41Z","author_association":"CONTRIBUTOR","body":"@karesh That's right. For the issue you describe in #25844 I'd recommend taking a similar mapping approach to what's suggested above (e.g., set `precision` to something like `10m` and `default_error_pct` to something like `0.025` - but play around w/ these parameters) . If the `precision` parameter is set, the `distance_error_pct` parameter is automatically set to 0; rationale being that users expect precision accuracy when they define an explicit precision. However, this can lead to performance issues as these quad cells are created (at both index and query time). The `distance_error_pct` will help alleviate these performance issues at the cost of false positives. At the moment there is no post-filtering of the results returned by lucene so you'd have to post filter the results in your application. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318341432","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-318341432","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":318341432,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODM0MTQzMg==","user":{"login":"davemarsland","id":3041517,"node_id":"MDQ6VXNlcjMwNDE1MTc=","avatar_url":"https://avatars2.githubusercontent.com/u/3041517?v=4","gravatar_id":"","url":"https://api.github.com/users/davemarsland","html_url":"https://github.com/davemarsland","followers_url":"https://api.github.com/users/davemarsland/followers","following_url":"https://api.github.com/users/davemarsland/following{/other_user}","gists_url":"https://api.github.com/users/davemarsland/gists{/gist_id}","starred_url":"https://api.github.com/users/davemarsland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davemarsland/subscriptions","organizations_url":"https://api.github.com/users/davemarsland/orgs","repos_url":"https://api.github.com/users/davemarsland/repos","events_url":"https://api.github.com/users/davemarsland/events{/privacy}","received_events_url":"https://api.github.com/users/davemarsland/received_events","type":"User","site_admin":false},"created_at":"2017-07-27T11:58:42Z","updated_at":"2017-07-27T11:58:42Z","author_association":"NONE","body":"Just to +1 this, after advice from @gmoskovicz we've changed to the quadtree type and have seen a dramatic improvement in all metrics, especially indexing and search latency (in the case of search latency, from ~50ms to sub 1ms). Feels like as long as it's explained well, it should be the default.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353068764","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-353068764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":353068764,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzA2ODc2NA==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2017-12-20T13:53:50Z","updated_at":"2017-12-20T13:53:50Z","author_association":"CONTRIBUTOR","body":"+1 for changing the defaults as indicated. And just noting that for a project I'm assisting, with several simple polygons indexed as `precision: 10m` and `tree: quadtree`, indexing is very slow, consumed disk space is very large, and setting `distance_error_pct: 0.001` doesn't really help with either.\r\n\r\n@nknize any ETA for a bkd-tree based geo-shape indexing?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353072550","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-353072550","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":353072550,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzA3MjU1MA==","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"created_at":"2017-12-20T14:10:00Z","updated_at":"2017-12-20T14:10:00Z","author_association":"CONTRIBUTOR","body":"@synhershko have you seen any improvement testing the defaults vs `quadtree` with some error percentage?\r\n\r\nI wouldn't expect it to fix every single case (because https://github.com/elastic/elasticsearch/issues/25833#issuecomment-317116918) but i would expect it to have a significant change comparing to the defaults.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353075641","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-353075641","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":353075641,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzA3NTY0MQ==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2017-12-20T14:22:33Z","updated_at":"2017-12-20T14:22:42Z","author_association":"CONTRIBUTOR","body":"Using 5.6.0 and I'm assuming the default is `distance_error_pct: 0` - so we compared it to that with no significant improvement (or none at all). Started with quadtree to begin with.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353078074","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-353078074","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":353078074,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzA3ODA3NA==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2017-12-20T14:32:09Z","updated_at":"2017-12-20T14:32:09Z","author_association":"CONTRIBUTOR","body":"fwiw the most significant drop in performance (and increase in disk size) was when we went from `precision: 50m` to `precision: 10m` (both are quadtree and `distance_error_pct: 0.001`). In our tests, 50m gives us bulk of 500 in ~1s and about 50kb/doc on disk while 10m is bulk of 500 in ~5s and about 150kb/doc on disk.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445889486","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-445889486","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":445889486,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTg4OTQ4Ng==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T16:58:04Z","updated_at":"2018-12-10T16:58:04Z","author_association":"MEMBER","body":"Since BKD-backed geo_shapes are soon to be the default (#35320), I'm going to close this issue.  \r\n\r\nI think the `distance_error_pct` default still has merit though, and will be addressing that in a different ticket (which results in OOM).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445911525","html_url":"https://github.com/elastic/elasticsearch/issues/25833#issuecomment-445911525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25833","id":445911525,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTkxMTUyNQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T18:01:15Z","updated_at":"2018-12-10T18:01:15Z","author_association":"CONTRIBUTOR","body":"++ #35320 also sets the default `tree` parameter to `quadtree` for PrefixTrees","performed_via_github_app":null}]