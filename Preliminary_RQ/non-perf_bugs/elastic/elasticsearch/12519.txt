{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12519","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12519/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12519/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12519/events","html_url":"https://github.com/elastic/elasticsearch/issues/12519","id":97789998,"node_id":"MDU6SXNzdWU5Nzc4OTk5OA==","number":12519,"title":"query_string + uax_email_url + mixed unicode and ascii = broken highlighting","user":{"login":"smakolski","id":1503068,"node_id":"MDQ6VXNlcjE1MDMwNjg=","avatar_url":"https://avatars0.githubusercontent.com/u/1503068?v=4","gravatar_id":"","url":"https://api.github.com/users/smakolski","html_url":"https://github.com/smakolski","followers_url":"https://api.github.com/users/smakolski/followers","following_url":"https://api.github.com/users/smakolski/following{/other_user}","gists_url":"https://api.github.com/users/smakolski/gists{/gist_id}","starred_url":"https://api.github.com/users/smakolski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smakolski/subscriptions","organizations_url":"https://api.github.com/users/smakolski/orgs","repos_url":"https://api.github.com/users/smakolski/repos","events_url":"https://api.github.com/users/smakolski/events{/privacy}","received_events_url":"https://api.github.com/users/smakolski/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-07-28T20:03:29Z","updated_at":"2015-08-03T16:38:12Z","closed_at":"2015-07-30T12:20:57Z","author_association":"NONE","active_lock_reason":null,"body":"A mix of both unicode and ASCII documents in the results of a highlight query_string query on uax_email_url analyzed documents causes highlighting to fail entirely.\n\nHere's a set of curl commands that reproduce the issue.\n\nFirst, we create an index and populate it with some test data:\n\n```\ncurl -XPUT 'http://elasticsearch:9200/unicode/' -d '{\n \"settings\" : {\n   \"number_of_shards\" : 1,\n   \"number_of_replicas\" : 0,\n   \"analysis\": {\n     \"analyzer\": {\n       \"uax_url_email_analyzer\": {\n         \"tokenizer\": \"uax_url_email_tokenizer\"\n       }\n     },\n     \"tokenizer\": {\n       \"uax_url_email_tokenizer\": {\n         \"type\": \"uax_url_email\",\n         \"max_token_length\": \"1024\"\n       }\n     }\n   }\n },\n \"mappings\" : {\n   \"doc\" : {\n     \"properties\" : {\n       \"name\" : {\n         \"analyzer\": \"uax_url_email_analyzer\",\n         \"type\": \"string\"\n       }\n     }\n   }\n }\n}'\ncurl -XPUT \"http://elasticsearch:9200/unicode/doc/1\" -d'\n{\"name\": \"Document 1 ascii\"}'\ncurl -XPUT \"http://elasticsearch:9200/unicode/doc/2\" -d'\n{\"name\": \"Document 2 â€™ unicode\"}'\ncurl -XPUT \"http://elasticsearch:9200/unicode/doc/3\" -d'\n{\"name\": \"Document 3 ascii\"}'\ncurl -XPUT \"http://elasticsearch:9200/unicode/doc/4\" -d'\n{\"name\": \"Document 4 â€™ unicode\"}'\n```\n\nOutput:\n\n```\n{\"acknowledged\":true}\n{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"1\",\"_version\":1,\"created\":true}\n{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"2\",\"_version\":1,\"created\":true}\n{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"3\",\"_version\":1,\"created\":true}\n{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"4\",\"_version\":1,\"created\":true}\n```\n\nNow we show that highlighting works for queries that return only ASCII documents:\n\n```\ncurl -XGET \"http://elasticsearch:9200/unicode/_search\" -d'\n{\n \"query\":{\n   \"query_string\":{\n     \"query\":\"ascii\",\n     \"allow_leading_wildcard\":true\n   }\n },\n \"highlight\":{\n   \"fields\":{\n     \"*\":{}\n   }\n }\n}'\n```\n\nOutput:\n\n```\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":2,\"max_score\":0.643841,\"hits\":[{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"1\",\"_score\":0.643841,\"_source\":\n{\"name\": \"Document 1 ascii\"},\"highlight\":{\"name\":[\"Document 1 <em>ascii</em>\"]}},{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"3\",\"_score\":0.643841,\"_source\":\n{\"name\": \"Document 3 ascii\"},\"highlight\":{\"name\":[\"Document 3 <em>ascii</em>\"]}}]}}\n```\n\nNext we shows that highlighting also works for queries that return only unicode documents:\n\n```\ncurl -XGET \"http://elasticsearch:9200/unicode/_search\" -d'\n{\n \"query\":{\n   \"query_string\":{\n     \"query\":\"unicode\",\n     \"allow_leading_wildcard\":true\n   }\n },\n \"highlight\":{\n   \"fields\":{\n     \"*\":{}\n   }\n }\n}'\n```\n\nOutput:\n\n```\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":2,\"max_score\":0.643841,\"hits\":[{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"2\",\"_score\":0.643841,\"_source\":\n{\"name\": \"Document 2 â€™ unicode\"},\"highlight\":{\"name\":[\"Document 2 â€™ <em>unicode</em>\"]}},{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"4\",\"_score\":0.643841,\"_source\":\n{\"name\": \"Document 4 â€™ unicode\"},\"highlight\":{\"name\":[\"Document 4 â€™ <em>unicode</em>\"]}}]}}\n```\n\nAnd finally, we show that highlighting does not work for queries that return both ASCII and unicode documents:\n\n```\ncurl -XGET \"http://elasticsearch:9200/unicode/_search\" -d'\n{\n \"query\":{\n   \"query_string\":{\n     \"query\":\"document\",\n     \"allow_leading_wildcard\":true\n   }\n },\n \"highlight\":{\n   \"fields\":{\n     \"*\":{}\n   }\n }\n}'\n```\n\nOutput:\n\n```\n{\"took\":2,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":4,\"max_score\":0.3884282,\"hits\":[{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"1\",\"_score\":0.3884282,\"_source\":\n{\"name\": \"Document 1 ascii\"}},{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"2\",\"_score\":0.3884282,\"_source\":\n{\"name\": \"Document 2 â€™ unicode\"}},{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"3\",\"_score\":0.3884282,\"_source\":\n{\"name\": \"Document 3 ascii\"}},{\"_index\":\"unicode\",\"_type\":\"doc\",\"_id\":\"4\",\"_score\":0.3884282,\"_source\":\n{\"name\": \"Document 4 â€™ unicode\"}}]}}\n```\n\nNo highlighting, at all.\n\nAdding \"term_vector\": \"with_positions_offsets\" to the mapping doesn't help. Using a match query instead of a query_string query fixes the highlighting. Using the standard tokenizer instead of uax_url_email fixes the highlighting. Apparently, the combination of query_string, uax_url_email, and highlighting does not play nice with a heterogeneous mix of character encodings?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}