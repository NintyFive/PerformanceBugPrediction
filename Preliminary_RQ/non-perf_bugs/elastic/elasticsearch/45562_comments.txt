[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521346113","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-521346113","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":521346113,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTM0NjExMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-14T17:40:59Z","updated_at":"2019-08-14T17:40:59Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521363268","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-521363268","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":521363268,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTM2MzI2OA==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-14T18:28:16Z","updated_at":"2019-08-14T19:15:55Z","author_association":"MEMBER","body":"I will be looking into this from the ML side of things. \r\n\r\nHere are some interesting logs from that latest failure. The test that is failing is one that tests how we handle failed states in transforms (ironic...). \r\n\r\n```\r\n[2019-08-14T17:11:13,081][INFO ][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Updating state for data frame transform [test-force-stop-failed-transform] to [{\"task_state\":\"started\",\"indexer_state\":\"stopped\",\"checkpoint\":0}]\r\n...\r\n[2019-08-14T17:11:14,183][WARN ][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform] encountered an exception: \r\norg.elasticsearch.xpack.dataframe.transforms.DataFrameTransformTask$BulkIndexingException: Bulk index experienced failures. See the logs of the node running the transform for details.\r\n...\r\n[2019-08-14T17:11:14,249][ERROR][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform]:task encountered more than 0 failures; latest failure: Bulk index experienced failures. See the logs of the node running the transform for details.\r\n...\r\n[2019-08-14T17:11:14,642][INFO ][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform] has stopped\r\n[2019-08-14T17:11:14,818][INFO ][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform] has stopped\r\n[2019-08-14T17:11:14,822][WARN ][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform] encountered an exception: \r\norg.elasticsearch.xpack.dataframe.transforms.DataFrameTransformTask$BulkIndexingException: Bulk index experienced failures. See the logs of the node running the transform for details.\r\n...\r\n[2019-08-14T17:11:14,855][ERROR][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Data frame transform [test-force-stop-failed-transform]:task encountered more than 0 failures; latest failure: Bulk index experienced failures. See the logs of the node running the transform for details.\r\n[2019-08-14T17:11:14,913][WARN ][o.e.p.PersistentTasksClusterService] [integTest-0] trying to update state on non-existing task test-force-stop-failed-transform\r\n[2019-08-14T17:11:14,959][ERROR][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Failed to update state for data frame transform [test-force-stop-failed-transform]\r\n...\r\n[2019-08-14T17:11:14,961][ERROR][o.e.x.d.t.DataFrameTransformTask] [integTest-0] Failed to set task state as failed to cluster state\r\norg.elasticsearch.ResourceNotFoundException: the task with id test-force-stop-failed-transform and allocation id 2 doesn't exist\r\n```\r\n\r\nWe definitely have some sort of race condition, you can see by how many times we get the same log message. Many of those \"failure\" log messages referencing the task should realistically only be logged once.\r\n\r\nThe `has stopped` logs are very interesting. We spin wait for the task to be set to failed within the test before attempting to stop them by force. The time between creating the transform and it reaching a failed state is ~2 seconds. Our timeout on the spinwait is 30 seconds...something is racing here. \r\n\r\nWhat it seems like, is that something came in and called `stop` on the data frame transform while it was failing. So, the task got canceled and removed from cluster state before it could be moved over to a failed state. In real practice, this should be OK. For CI, this is an issue :/. I am looking into what could have called `_stop` against it. \r\n\r\nFWIW: there is a PR right now that should help with some mysterious CI failures that I am going to merge (as soon as CI passes). \r\n\r\nEDIT: From what I can tell, this cascaded failure is occurring because the indexer is getting triggered twice. It did not finish the failure path on the first trigger before the second trigger fired. This will cause some strange internal state interactions for user as we assume that only one trigger is firing at a time.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521413314","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-521413314","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":521413314,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTQxMzMxNA==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-14T20:50:05Z","updated_at":"2019-08-14T20:50:05Z","author_association":"MEMBER","body":"One PR merged to help with data frame instability: https://github.com/elastic/elasticsearch/pull/45511\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522056719","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-522056719","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":522056719,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjA1NjcxOQ==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T15:48:07Z","updated_at":"2019-08-16T15:48:07Z","author_association":"MEMBER","body":"Another PR to address the failure state tests #45627","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522058515","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-522058515","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":522058515,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjA1ODUxNQ==","user":{"login":"mark-vieira","id":4106672,"node_id":"MDQ6VXNlcjQxMDY2NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/4106672?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-vieira","html_url":"https://github.com/mark-vieira","followers_url":"https://api.github.com/users/mark-vieira/followers","following_url":"https://api.github.com/users/mark-vieira/following{/other_user}","gists_url":"https://api.github.com/users/mark-vieira/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-vieira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-vieira/subscriptions","organizations_url":"https://api.github.com/users/mark-vieira/orgs","repos_url":"https://api.github.com/users/mark-vieira/repos","events_url":"https://api.github.com/users/mark-vieira/events{/privacy}","received_events_url":"https://api.github.com/users/mark-vieira/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T15:53:21Z","updated_at":"2019-08-16T15:53:21Z","author_association":"CONTRIBUTOR","body":"I was just about to report this one: https://gradle-enterprise.elastic.co/s/cnsrqikafhkm4/tests/failed\r\n\r\nI'll update my branch and try again.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522080552","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-522080552","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":522080552,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjA4MDU1Mg==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T17:03:08Z","updated_at":"2019-08-16T17:03:08Z","author_association":"MEMBER","body":"@mark-vieira that build had my commit. I am re-muting that test. I see the cause, it is different than the ones I fixed. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/544369952","html_url":"https://github.com/elastic/elasticsearch/issues/45562#issuecomment-544369952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45562","id":544369952,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NDM2OTk1Mg==","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"created_at":"2019-10-21T06:34:53Z","updated_at":"2019-10-21T06:34:53Z","author_association":"CONTRIBUTOR","body":"several robustness have been made, no muted tests in this area, so this seems outdated.","performed_via_github_app":null}]