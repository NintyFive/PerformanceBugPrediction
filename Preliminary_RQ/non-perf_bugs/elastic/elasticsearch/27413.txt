{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27413","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27413/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27413/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27413/events","html_url":"https://github.com/elastic/elasticsearch/issues/27413","id":274663364,"node_id":"MDU6SXNzdWUyNzQ2NjMzNjQ=","number":27413,"title":"Failed to get watch, Failed to get monitoring watch on docker","user":{"login":"afreeland","id":3135030,"node_id":"MDQ6VXNlcjMxMzUwMzA=","avatar_url":"https://avatars3.githubusercontent.com/u/3135030?v=4","gravatar_id":"","url":"https://api.github.com/users/afreeland","html_url":"https://github.com/afreeland","followers_url":"https://api.github.com/users/afreeland/followers","following_url":"https://api.github.com/users/afreeland/following{/other_user}","gists_url":"https://api.github.com/users/afreeland/gists{/gist_id}","starred_url":"https://api.github.com/users/afreeland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/afreeland/subscriptions","organizations_url":"https://api.github.com/users/afreeland/orgs","repos_url":"https://api.github.com/users/afreeland/repos","events_url":"https://api.github.com/users/afreeland/events{/privacy}","received_events_url":"https://api.github.com/users/afreeland/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-11-16T21:05:02Z","updated_at":"2017-11-17T00:15:42Z","closed_at":"2017-11-17T00:15:41Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** (`bin/elasticsearch --version`):  5.6.3\r\n\r\n**Plugins installed**: \r\n```\r\nelasticsearch1    | [2017-11-16T20:20:52,340][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [aggs-matrix-stats]\r\nelasticsearch1    | [2017-11-16T20:20:52,340][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [ingest-common]\r\nelasticsearch1    | [2017-11-16T20:20:52,340][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [lang-expression]\r\nelasticsearch1    | [2017-11-16T20:20:52,340][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [lang-groovy]\r\nelasticsearch1    | [2017-11-16T20:20:52,340][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [lang-mustache]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [lang-painless]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [parent-join]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [percolator]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [reindex]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [transport-netty3]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded module [transport-netty4]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded plugin [ingest-geoip]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded plugin [ingest-user-agent]\r\nelasticsearch1    | [2017-11-16T20:20:52,341][INFO ][o.e.p.PluginsService     ] [xfJwVNH] loaded plugin [x-pack]\r\n```\r\n\r\n**Container**\r\nDocker Community Edition (Version 17.10.0-ce-win36 (13788)) on Windows SQL Server 2016\r\nElasticSearch containers from [elastic.co](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html)\r\n**The page is now saying 6.0 but when I used it, literally a few days ago, it was 5.6.3**\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI recently deployed a [Linux SQL Server](https://hub.docker.com/r/microsoft/mssql-server-linux/) container which required 3.25GB of RAM.  I went ahead and allocated more resources to the docker container...so from the docker defaults like CPU = 2 got increased to 28 and Memory got increased to 55,296MB. Decided to bump everything up since this server is primarily just serving up docker containers now.  After I did this I restarted docker and went ahead to utilize my docker-compose script to stand up ES cluster (2 node) and Kibana.  Everything appears to initialize fine and can be hit via REST API directly against ES and Kibana loads showing a green status for both nodes\r\n\r\n![image](https://user-images.githubusercontent.com/3135030/32914690-73aef45a-cae4-11e7-9a73-ecbff96908d8.png)\r\n**Not sure why memory still shows 990mb as the limit...it is much higher in the docker compose script\r\n\r\n\r\nAfter a period of time ES appears to get a java error and brings down the two ES docker containers and leaves Kibana running but failing to connect.\r\n\r\nIt is a massive stack trace but I will try list some of the high level below\r\n```\r\nelasticsearch1    | [2017-11-16T20:08:41,940][ERROR][o.e.x.w.t.a.g.TransportGetWatchAction] [xfJwVNH] failed to get watch [F2hXGdeLRfCjMaae49WP7Q_elasticsearch_cluster_status]\r\nelasticsearch1    | java.lang.IllegalStateException: watch store not started\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.ensureStarted(WatchStore.java:417) ~[?:?]\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.get(WatchStore.java:159) ~[?:?]\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.WatcherService.getWatch(WatcherService.java:157) ~[?:?]\r\n```\r\n\r\n\r\n```\r\nelasticsearch1    | [2017-11-16T20:08:41,991][ERROR][o.e.x.m.e.l.LocalExporter] failed to get monitoring watch [F2hXGdeLRfCjMaae49WP7Q_elasticsearch_cluster_status]\r\nelasticsearch1    | java.lang.IllegalStateException: watch store not started\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.ensureStarted(WatchStore.java:417) ~[?:?]\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.get(WatchStore.java:159) ~[?:?]\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.WatcherService.getWatch(WatcherService.java:157) ~[?:?]\r\n```\r\n\r\n```\r\nelasticsearch1    | [2017-11-16T20:08:43,560][ERROR][o.e.x.w.t.a.g.TransportGetWatchAction] [xfJwVNH] failed to get watch [F2hXGdeLRfCjMaae49WP7Q_elasticsearch_version_mismatch]\r\nelasticsearch1    | java.lang.IllegalStateException: watch store not started\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.ensureStarted(WatchStore.java:417) ~[?:?]\r\n```\r\n\r\n\r\n```\r\nelasticsearch1    | [2017-11-16T20:08:43,623][ERROR][o.e.x.m.e.l.LocalExporter] failed to get monitoring watch [F2hXGdeLRfCjMaae49WP7Q_elasticsearch_version_mismatch]\r\nelasticsearch1    | java.lang.IllegalStateException: watch store not started\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.ensureStarted(WatchStore.java:417) ~[?:?]\r\n```\r\n\r\n```\r\nelasticsearch1    | [2017-11-16T20:08:43,714][ERROR][o.e.x.w.t.a.g.TransportGetWatchAction] [xfJwVNH] failed to get watch [F2hXGdeLRfCjMaae49WP7Q_kibana_version_mismatch]\r\nelasticsearch1    | java.lang.IllegalStateException: watch store not started\r\nelasticsearch1    |     at org.elasticsearch.xpack.watcher.watch.WatchStore.ensureStarted(WatchStore.java:417) ~[?:?]\r\n```\r\n\r\n\r\n\r\nKibana then starts to freak out and gives the following\r\n```\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"error\",\"elasticsearch\",\"admin\"],\"pid\":1,\"message\":\"Request error, retrying\\nPOST http://elasticsearch1:9200/.reporting-*/esqueue/_search?ve\r\nrsion=true => read ECONNRESET\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"warning\",\"elasticsearch\",\"admin\"],\"pid\":1,\"message\":\"Unable to revive connection: http://elasticsearch1:9200/\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"warning\",\"elasticsearch\",\"admin\"],\"pid\":1,\"message\":\"No living connections\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"error\",\"elasticsearch\",\"monitoring-ui\"],\"pid\":1,\"message\":\"Request error, retrying\\nHEAD http://elasticsearch1:9200/ => read ECONNRESET\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"warning\",\"elasticsearch\",\"monitoring-ui\"],\"pid\":1,\"message\":\"Unable to revive connection: http://elasticsearch1:9200/\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"warning\",\"elasticsearch\",\"monitoring-ui\"],\"pid\":1,\"message\":\"No living connections\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:46Z\",\"tags\":[\"status\",\"plugin:monitoring@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - No Living connections\",\"prev\r\nState\":\"green\",\"prevMsg\":\"Ready\"}\r\nelasticsearch1 exited with code 137\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"warning\",\"elasticsearch\",\"admin\"],\"pid\":1,\"message\":\"Unable to revive connection: http://elasticsearch1:9200/\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"warning\",\"elasticsearch\",\"admin\"],\"pid\":1,\"message\":\"No living connections\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:xpack_main@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elastic\r\nsearch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:graph@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticsearc\r\nh at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:reporting@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elastics\r\nearch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:security@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticse\r\narch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:searchprofiler@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Ela\r\nsticsearch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:ml@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticsearch a\r\nt http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:tilemap@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticsea\r\nrch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:watcher@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticsea\r\nrch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:upgrade@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elasticsea\r\nrch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"plugin:elasticsearch@5.6.3\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Unable to connect to Elas\r\nticsearch at http://elasticsearch1:9200.\",\"prevState\":\"green\",\"prevMsg\":\"Kibana index ready\"}\r\nkibana_1          | {\"type\":\"log\",\"@timestamp\":\"2017-11-16T20:08:47Z\",\"tags\":[\"status\",\"ui settings\",\"error\"],\"pid\":1,\"state\":\"red\",\"message\":\"Status changed from green to red - Elasticsearch plugin is red\",\"prevState\"\r\n:\"green\",\"prevMsg\":\"Ready\"}\r\n```\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\nI am unsure what is causing this issue to be able to reproduce.  I went ahead and adjusted docker CPU and Memory which caused docker to restart itself...which caused an unfriendly exiting of the containers but once docker restarted I ran the `docker-compose up` script to get things moving.  It worked find, I felt good, and then it would fail...I restart it works, and then fails =(\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\ndocker-compose script\r\n```\r\nversion: '2'\r\nservices:\r\n  elasticsearch1:\r\n    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.3\r\n    container_name: elasticsearch1\r\n    environment:\r\n      - xpack.security.enabled=false\r\n      - cluster.name=docker-cluster\r\n      - bootstrap.memory_lock=true\r\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\r\n    ulimits:\r\n      memlock:\r\n        soft: -1\r\n        hard: -1\r\n    mem_limit: 25g\r\n    volumes:\r\n      - esdata1:/usr/share/elasticsearch/data\r\n    ports:\r\n      - 9200:9200\r\n    networks:\r\n      - esnet\r\n  elasticsearch2:\r\n    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.3\r\n    environment:\r\n      - xpack.security.enabled=false\r\n      - cluster.name=docker-cluster\r\n      - bootstrap.memory_lock=true\r\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\r\n      - \"discovery.zen.ping.unicast.hosts=elasticsearch1\"\r\n    ulimits:\r\n      memlock:\r\n        soft: -1\r\n        hard: -1\r\n    mem_limit: 25g\r\n    volumes:\r\n      - esdata2:/usr/share/elasticsearch/data\r\n    networks:\r\n      - esnet\r\n  kibana:\r\n    image: docker.elastic.co/kibana/kibana:5.6.3\r\n    environment:\r\n      - xpack.security.enabled=false\r\n      - ELASTICSEARCH_URL=http://elasticsearch1:9200\r\n    ports:\r\n      - \"5601:5601\"\r\n    networks:\r\n      - esnet\r\n    volumes:\r\n      - kdata1:/usr/share/kibana/config\r\n    depends_on:\r\n      - elasticsearch1\r\n\r\nvolumes:\r\n  esdata1:\r\n    driver: local\r\n  esdata2:\r\n    driver: local\r\n  kdata1:\r\n    driver: local\r\n\r\nnetworks:\r\n  esnet:\r\n```\r\n\r\nI am fairly new to ElasticSearch so perhaps this is something obvious in my configs...however, my development containers were always very solid and never experienced this issue.  This is actually getting used by a few of our applications so would love to get this things running smoothly again =)\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}