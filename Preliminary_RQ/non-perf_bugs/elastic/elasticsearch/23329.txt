{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23329","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23329/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23329/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23329/events","html_url":"https://github.com/elastic/elasticsearch/issues/23329","id":209793852,"node_id":"MDU6SXNzdWUyMDk3OTM4NTI=","number":23329,"title":"Nested documents _score is overwritten by the root document _score","user":{"login":"volodymyrpavlenko","id":8375248,"node_id":"MDQ6VXNlcjgzNzUyNDg=","avatar_url":"https://avatars2.githubusercontent.com/u/8375248?v=4","gravatar_id":"","url":"https://api.github.com/users/volodymyrpavlenko","html_url":"https://github.com/volodymyrpavlenko","followers_url":"https://api.github.com/users/volodymyrpavlenko/followers","following_url":"https://api.github.com/users/volodymyrpavlenko/following{/other_user}","gists_url":"https://api.github.com/users/volodymyrpavlenko/gists{/gist_id}","starred_url":"https://api.github.com/users/volodymyrpavlenko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/volodymyrpavlenko/subscriptions","organizations_url":"https://api.github.com/users/volodymyrpavlenko/orgs","repos_url":"https://api.github.com/users/volodymyrpavlenko/repos","events_url":"https://api.github.com/users/volodymyrpavlenko/events{/privacy}","received_events_url":"https://api.github.com/users/volodymyrpavlenko/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-02-23T15:27:12Z","updated_at":"2018-08-20T05:46:17Z","closed_at":"2018-08-20T05:46:17Z","author_association":"NONE","active_lock_reason":null,"body":"I'm currently trying to implement a query to make a scored search on a nested document and then perform an aggregation on the hits. I also need to sort the aggregations according to the score of the nested document.\r\n\r\nA very simplified mapping can be described:\r\n```json\r\n{\r\n    \"mappings\": {\r\n      \"parent\": {\r\n        \"properties\": {\r\n          \"children\": {\r\n            \"dynamic\": false,\r\n            \"type\": \"nested\",\r\n            \"properties\": {\r\n              \"name\": {\r\n                \"type\": \"string\",\r\n                \"index\": \"analyzed\",\r\n                \"analyzer\": \"standard\"\r\n              },\r\n              \"id\": {\r\n                \"index\": \"not_analyzed\",\r\n                \"omit_norms\": \"true\",\r\n                \"type\": \"string\",\r\n                \"index_options\": \"docs\",\r\n                \"doc_values\": \"true\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\nTo achieve the initial requirement, I used technique that is called \"field collapse\". The query looks like this:\r\n```json\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"filtered\": {\r\n      \"query\": {\r\n        \"nested\": {\r\n          \"query\": {\r\n            \"match\": {\r\n              \"children.name\": {\r\n                \"query\": \"<free-text-search>\",\r\n                \"type\": \"boolean\",\r\n                \"operator\": \"AND\",\r\n                \"analyzer\": \"standard\",\r\n                \"boost\": 1.0\r\n              }\r\n            }\r\n          },\r\n          \"path\": \"children\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"iEzOD7MlzNsjvHxsDcAkVAVtDicmIkg9\": {\r\n      \"nested\": {\r\n        \"path\": \"children\"\r\n      },\r\n      \"aggregations\": {\r\n        \"childId\": {\r\n          \"terms\": {\r\n            \"field\": \"children.id\",\r\n            \"size\": 10,\r\n            \"order\": [{\r\n              \"top_score\": \"desc\"\r\n            }, {\r\n              \"_count\": \"desc\"\r\n            }, {\r\n              \"_term\": \"asc\"\r\n            }]\r\n          },\r\n          \"aggregations\": {\r\n            \"top_score\": {\r\n              \"max\": {\r\n                \"script\": \"_score\"\r\n              }\r\n            },\r\n            \"top_hit\": {\r\n              \"top_hits\": {\r\n                \"size\": 1,\r\n                \"_source\": {\r\n                  \"includes\": [\"id\", \"name\"],\r\n                  \"excludes\": []\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIt works fine as long as we have one child per parent. But this stops working when we get multiple children per parent.\r\n\r\nInvestigating the reasons, I found that the problem is that nested document _score is actually taken from the root document, even though it is displayed correctly in inner_docs if I output them.\r\n\r\nI tested this in 1.7.1 and 2.4.3 and the problem persists.\r\n","closed_by":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"performed_via_github_app":null}