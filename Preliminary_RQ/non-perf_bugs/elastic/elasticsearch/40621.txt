{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40621","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40621/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40621/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40621/events","html_url":"https://github.com/elastic/elasticsearch/issues/40621","id":426728445,"node_id":"MDU6SXNzdWU0MjY3Mjg0NDU=","number":40621,"title":"Elasticsearch aggregation query ignores parent filter when setting min_doc_count to 0 in child terms aggregation","user":{"login":"m5tt","id":12707929,"node_id":"MDQ6VXNlcjEyNzA3OTI5","avatar_url":"https://avatars3.githubusercontent.com/u/12707929?v=4","gravatar_id":"","url":"https://api.github.com/users/m5tt","html_url":"https://github.com/m5tt","followers_url":"https://api.github.com/users/m5tt/followers","following_url":"https://api.github.com/users/m5tt/following{/other_user}","gists_url":"https://api.github.com/users/m5tt/gists{/gist_id}","starred_url":"https://api.github.com/users/m5tt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/m5tt/subscriptions","organizations_url":"https://api.github.com/users/m5tt/orgs","repos_url":"https://api.github.com/users/m5tt/repos","events_url":"https://api.github.com/users/m5tt/events{/privacy}","received_events_url":"https://api.github.com/users/m5tt/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-03-28T22:06:58Z","updated_at":"2019-04-01T07:09:09Z","closed_at":"2019-04-01T07:09:09Z","author_association":"NONE","active_lock_reason":null,"body":"\r\nIf i run this query in Elasticsearch, it returns a bucket set aggregating on field `name`. Not returning any document that has a `type` field of **1** This is correct.\r\n\r\n```\r\n{:size=>0,\r\n :aggs=>\r\n  {:agg=>\r\n    {:filter=>{:term=>{\"type\"=>1}},\r\n     :aggs=>{:agg=>{:terms=>{:field=>\"name\", :min_doc_count=>1}}}}}}\r\n```\r\n\r\nNow if i run this exact same query, changing _only_ `min_doc_count` to **0**. Then it _ignores_ the parent filter aggregation and returns _all_ documents, regardless of type. \r\n\r\n\r\n```\r\n{:size=>0,\r\n :aggs=>\r\n  {:agg=>\r\n    {:filter=>{:term=>{\"type\"=>1}},\r\n     :aggs=>{:agg=>{:terms=>{:field=>\"name\", :min_doc_count=>0}}}}}}\r\n```\r\n\r\nIf i reverse the query, ie the filter aggregation nested inside the terms, then it doesnt work regardless of the `min_doc_count` setting. \r\n\r\nI understand this is documented [Here:](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html)\r\n\r\n> Setting  `min_doc_count` = `0`  will also return buckets for terms that didnâ€™t match any hit. However, some of the returned terms which have a document count of zero might only belong to deleted documents or documents from other types, so there is no warranty that a  `match_all`  query would find a positive document count for those terms.\r\n\r\n**However there _must_ be a way to build a aggregation query that returns documents with a doc_count 0 which are _also_ filtered by a filter aggregation.**\r\n\r\nI am using Elasticsearch 6.x, and using it through the Elasticsearch Rails gem.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}