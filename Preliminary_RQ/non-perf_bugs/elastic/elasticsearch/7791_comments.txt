[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/56076885","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-56076885","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":56076885,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MDc2ODg1","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-09-18T17:52:59Z","updated_at":"2014-09-18T17:52:59Z","author_association":"MEMBER","body":"@synhershko Thanks for opening this. This is a bug also the `has_child` query suffers from the same problem. If the document type has already been set in the url then fields of other types can't be resolved via a script in any (sub) query.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/61036329","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-61036329","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":61036329,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMDM2MzI5","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2014-10-30T02:15:49Z","updated_at":"2014-10-30T02:15:49Z","author_association":"CONTRIBUTOR","body":"@martijnvg any ETA on a fix for this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/61858664","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-61858664","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":61858664,"node_id":"MDEyOklzc3VlQ29tbWVudDYxODU4NjY0","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2014-11-05T18:40:42Z","updated_at":"2014-11-05T18:40:42Z","author_association":"CONTRIBUTOR","body":"I've got a possibly similar issue, where the function is improperly run against some results/documents, causing an 'unknown field' error.\n\n```\n# This query is run against two indices, 'users' and 'speakers'.\n# But I think the situation would be the same if it was a single index, \n# with two different types in it.\n# \n# I get the following error:\n# `QueryParsingException[[users] Unknown field [mentioned_at]];`\n#\n# It seems like it's trying to run the query against all results, \n# instead of being scoped to the query.\n# All speakers has the `mentioned_at` field, and no user has it.\n\nquery_body = {\n  :query => {\n    :bool => {\n      :should => [\n        {\n          :function_score => {\n            :query => {\n              :multi_match => {\n                :query => \"MY QUERY HERE\",\n                :type => :phrase_prefix,\n                :fields => ['name']\n              }\n            },\n            :filter => { :type => { :value => 'speaker' } },\n            :functions => [\n              {\n                :gauss => {\n                  'mentioned_at' => {\n                    :scale => '180d', # '6M' syntax couldn't be used, probably due to ES-bug\n                    :offset => '5d',\n                    :decay => 0.5,\n                  }\n                }\n              }\n            ]\n          }\n        },\n        {\n          :filtered => {\n            :query => {\n              :multi_match => {\n                :query => \"MY QUERY HERE\",\n                :type => :phrase_prefix,\n                :fields => ['name']\n              }\n            },\n            :filter => { :type => { :value => 'user' } },\n          }\n        }\n      ]\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64176104","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-64176104","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":64176104,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MTc2MTA0","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T10:39:42Z","updated_at":"2014-11-24T10:39:42Z","author_association":"MEMBER","body":"@synhershko Sorry, I missed your comment... This issue should be resolved by #4081, internally this issue will change the fact that there are multiple mappings per type, so there will be one mapping per index.\n\nRight now because in the url your scope has been reduced to the parent type and no other query can therefor in scripting access fields outside of this scope. This restriction should be removed when #4081 is added.\n\nThe best work around right now is to not define type in the url and do this in the query dsl instead.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64176382","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-64176382","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":64176382,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MTc2Mzgy","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T10:42:31Z","updated_at":"2014-11-24T10:42:31Z","author_association":"MEMBER","body":"@sandstrom This is because your query runs on an index that simply doesn't have that field and the function_score quest is strict about that.\n\nI think the best way to get around this issue is to wrap the function_score query in the `indices` query and restrict on what indices the sub query is actually ran on:\nhttp://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-indices-query.html#query-dsl-indices-query\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64213279","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-64213279","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":64213279,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MjEzMjc5","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T15:49:30Z","updated_at":"2014-11-24T15:49:30Z","author_association":"CONTRIBUTOR","body":"@martijnvg Doesn't `filter` run before the `query`?\n\nMy guess was that `function_score` can take either a `query` or a `filter`, but not both. There is a `|` in the documentation, which I'm guessing signifies a bitwise OR.\n\nhttp://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#_using_function_score\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64223697","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-64223697","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":64223697,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MjIzNjk3","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T16:48:32Z","updated_at":"2014-11-24T16:48:32Z","author_association":"MEMBER","body":"@sandstrom This depends on what place the filter is defined. If the filter is defined in the query dsl via a `filtered` query it depends, but if it is defined in `post_filter` then the filter is always checked last.\n\nYes, the `function_score` query can either accept a filter or a query. If both are defined then the last one parsed will actually be used.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64242127","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-64242127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":64242127,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MjQyMTI3","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T18:44:22Z","updated_at":"2014-11-24T18:45:15Z","author_association":"CONTRIBUTOR","body":"@martijnvg Thanks for confirming my guess, much appreciated! :boat: \n\nI've opened a separate issue to track that: https://github.com/elasticsearch/elasticsearch/issues/8638\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/158672745","html_url":"https://github.com/elastic/elasticsearch/issues/7791#issuecomment-158672745","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7791","id":158672745,"node_id":"MDEyOklzc3VlQ29tbWVudDE1ODY3Mjc0NQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-21T19:04:47Z","updated_at":"2015-11-21T19:04:47Z","author_association":"CONTRIBUTOR","body":"As of 2.0 this now works correctly, eg:\n\n```\nPOST /test/pages/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"score_mode\": \"max\",\n      \"type\": \"tagged-page\",\n      \"query\": {\n        \"function_score\": {\n          \"boost_mode\": \"replace\",\n          \"query\": {\n            \"term\": {\n              \"name\": \"foo\"\n            }\n          },\n          \"script_score\": {\n            \"lang\": \"groovy\",\n            \"script\": \"doc[\\\"score\\\"].value\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null}]