{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34403","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34403/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34403/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34403/events","html_url":"https://github.com/elastic/elasticsearch/issues/34403","id":369173650,"node_id":"MDU6SXNzdWUzNjkxNzM2NTA=","number":34403,"title":"SQL query failed with in nested array.","user":{"login":"spinwang","id":5768133,"node_id":"MDQ6VXNlcjU3NjgxMzM=","avatar_url":"https://avatars1.githubusercontent.com/u/5768133?v=4","gravatar_id":"","url":"https://api.github.com/users/spinwang","html_url":"https://github.com/spinwang","followers_url":"https://api.github.com/users/spinwang/followers","following_url":"https://api.github.com/users/spinwang/following{/other_user}","gists_url":"https://api.github.com/users/spinwang/gists{/gist_id}","starred_url":"https://api.github.com/users/spinwang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinwang/subscriptions","organizations_url":"https://api.github.com/users/spinwang/orgs","repos_url":"https://api.github.com/users/spinwang/repos","events_url":"https://api.github.com/users/spinwang/events{/privacy}","received_events_url":"https://api.github.com/users/spinwang/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-10-11T15:19:42Z","updated_at":"2018-10-29T14:32:08Z","closed_at":"2018-10-29T14:31:48Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`6.4.0 docker image`)\r\n\r\n\r\n**Steps to reproduce**:\r\n```\r\nPUT test\r\nPUT test/_mapping/_doc\r\n{\r\n  \"properties\": {\r\n      \"data\": {\r\n        \"properties\": {\r\n          \"results\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"barcode\": {\r\n              \"type\": \"keyword\",\r\n              \"fields\": {\r\n                \"text\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              }\r\n            },\r\n            \"metric\": {\r\n              \"type\": \"keyword\",\r\n              \"fields\": {\r\n                \"text\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              }\r\n            },\r\n            \"modifier\": {\r\n              \"type\": \"keyword\",\r\n              \"fields\": {\r\n                \"text\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              }\r\n            },\r\n            \"unit\": {\r\n              \"type\": \"keyword\",\r\n              \"fields\": {\r\n                \"text\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              }\r\n            },\r\n            \"value\": {\r\n              \"type\": \"double\",\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"text\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              },\r\n              \"ignore_malformed\": true\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\nPUT test/_doc/1\r\n{\r\n  \"fileId\":\"1\",\r\n  \"data\":{\r\n    \"study\":{\"name\":\"M\",\"number\":\"4\",\"start_date\":\"2018-04-28\",\"end_date\":\"2018-05-02\",\"source\":\"A\"},\r\n    \"assay\":{\"sub_type\":\"M\"},\r\n    \"results\":[{\r\n      \"barcode\": \"01\",\r\n      \"metric\":\"m\",\r\n      \"value\":0.9235,\r\n      \"modifier\":\">\",\r\n      \"unit\":\"n\"\r\n    },{\r\n      \"barcode\":\"01\",\r\n      \"metric\":\"n\",\r\n      \"value\":75.591,\r\n      \"modifier\":\">\",\r\n      \"unit\":\"min\"\r\n    }]\r\n  }\r\n}\r\n```\r\n```\r\nPOST /_xpack/sql?format=csv\r\n{\r\n  \"query\": \"SELECT data.results.* FROM test\"\r\n}\r\n```\r\n**Provide logs (if relevant)**:\r\nError message\r\n```JSON\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"Partial shards failure\",\r\n    \"phase\": \"fetch\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 3,\r\n        \"index\": \"test\",\r\n        \"node\": \"RxLQEIJNTSiz2Wfua1z8Mw\",\r\n        \"reason\": {\r\n          \"type\": \"null_pointer_exception\",\r\n          \"reason\": null\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\nElasticsearch log\r\n```\r\nelasticsearch_1  | [2018-10-11T15:48:24,117][WARN ][r.suppressed             ] path: /_xpack/sql, params: {format=csv}\r\nelasticsearch_1  | org.elasticsearch.action.search.SearchPhaseExecutionException: Partial shards failure\r\nelasticsearch_1  |      at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:293) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:145) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.FetchSearchPhase.moveToNextPhase(FetchSearchPhase.java:205) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.FetchSearchPhase.lambda$innerRun$2(FetchSearchPhase.java:104) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.CountedCollector.countDown(CountedCollector.java:53) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.CountedCollector.onFailure(CountedCollector.java:76) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.FetchSearchPhase$2.onFailure(FetchSearchPhase.java:172) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:526) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1068) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1165) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1149) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.onFailure(SecurityServerTransportInterceptor.java:242) [x-pack-security-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:309) [x-pack-security-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:665) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135) [?:?]\r\nelasticsearch_1  |      at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) [?:?]\r\nelasticsearch_1  |      at java.lang.Thread.run(Thread.java:844) [?:?]\r\nelasticsearch_1  | Caused by: org.elasticsearch.ElasticsearchException$1\r\nelasticsearch_1  |      at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:657) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:170) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:111) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:139) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:122) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.impl.MutableLogEvent.getThrownProxy(MutableLogEvent.java:351) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.pattern.ExtendedThrowablePatternConverter.format(ExtendedThrowablePatternConverter.java:64) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.pattern.PatternFormatter.format(PatternFormatter.java:38) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.layout.PatternLayout$PatternSerializer.toSerializable(PatternLayout.java:334) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.layout.PatternLayout.toText(PatternLayout.java:233) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:218) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:58) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.directEncodeEvent(AbstractOutputStreamAppender.java:177) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.tryAppend(AbstractOutputStreamAppender.java:170) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:161) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:156) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:129) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:464) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:448) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:431) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:406) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146) [log4j-core-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.ExtendedLoggerWrapper.logMessage(ExtendedLoggerWrapper.java:217) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.elasticsearch.common.logging.PrefixLogger.logMessage(PrefixLogger.java:103) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.tryLogMessage(AbstractLogger.java:2170) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.logMessageTrackRecursion(AbstractLogger.java:2125) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2108) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:1997) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1859) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.apache.logging.log4j.spi.AbstractLogger.warn(AbstractLogger.java:2644) [log4j-api-2.11.1.jar:2.11.1]\r\nelasticsearch_1  |      at org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:133) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:91) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.rest.action.RestActionListener.onFailure(RestActionListener.java:58) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:91) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.ActionListener$1.onFailure(ActionListener.java:68) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.xpack.sql.execution.search.Querier$BaseActionListener.onFailure(Querier.java:441) [x-pack-sql-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:91) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.AbstractSearchAsyncAction.raisePhaseFailure(AbstractSearchAsyncAction.java:233) [elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      ... 25 more\r\nelasticsearch_1  | Caused by: java.lang.NullPointerException\r\nelasticsearch_1  |      at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:282) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:147) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitsExecute(InnerHitsFetchSubPhase.java:69) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:165) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:516) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:439) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:436) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:251) ~[?:?]\r\nelasticsearch_1  |      at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.4.0.jar:6.4.0]\r\nelasticsearch_1  |      ... 10 more\r\n```\r\n","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}