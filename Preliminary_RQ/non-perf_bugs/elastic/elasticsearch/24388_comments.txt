[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298077078","html_url":"https://github.com/elastic/elasticsearch/issues/24388#issuecomment-298077078","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24388","id":298077078,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODA3NzA3OA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-04-28T18:46:16Z","updated_at":"2017-04-28T18:46:16Z","author_association":"CONTRIBUTOR","body":"The test complains that there is still a cluster state in the pending queue after successful return of ensureGreen. The reason is the following:\r\n\r\n- the test calls ensureGreen to wait for all events to be processed.\r\n- They technically are all finished, but with the change in #24236, the master now uses the pending queue when publishing to itself. This means that a cluster state update is put into the pending queue, then sent to the ClusterApplierService to be applied. After it has been applied, it is marked as processed and removed from the pending queue (1).\r\n- ensureGreen is implemented as a cluster health action that waits on certain conditions, which will lead to a cluster state update task to be submitted on the master. When this task gets to run and the conditions are not satisfied yet, it register a cluster state observer. This observer is registered on the ClusterApplierService and waits on cluster state change events (2).\r\n- ClusterApplierService first notifies the observer (2) and then the discovery layer (1):\r\n```\r\ncallClusterStateListeners(clusterChangedEvent);\r\ntask.listener.clusterStateProcessed(task.source, previousClusterState, newClusterState);\r\n```\r\nThis means that there is a small time frame where ensureGreen can complete and call the node stats to find the pending queue still containing the last cluster state update.\r\n\r\nI've pushed 86aab98fde","performed_via_github_app":null}]