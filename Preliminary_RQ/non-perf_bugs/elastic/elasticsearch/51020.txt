{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51020","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51020/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51020/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51020/events","html_url":"https://github.com/elastic/elasticsearch/issues/51020","id":549982403,"node_id":"MDU6SXNzdWU1NDk5ODI0MDM=","number":51020,"title":"Filter aggregation fails with `index_out_of_bounds_exception` when nested within `rare_terms`","user":{"login":"fkelbert","id":714592,"node_id":"MDQ6VXNlcjcxNDU5Mg==","avatar_url":"https://avatars0.githubusercontent.com/u/714592?v=4","gravatar_id":"","url":"https://api.github.com/users/fkelbert","html_url":"https://github.com/fkelbert","followers_url":"https://api.github.com/users/fkelbert/followers","following_url":"https://api.github.com/users/fkelbert/following{/other_user}","gists_url":"https://api.github.com/users/fkelbert/gists{/gist_id}","starred_url":"https://api.github.com/users/fkelbert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkelbert/subscriptions","organizations_url":"https://api.github.com/users/fkelbert/orgs","repos_url":"https://api.github.com/users/fkelbert/repos","events_url":"https://api.github.com/users/fkelbert/events{/privacy}","received_events_url":"https://api.github.com/users/fkelbert/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-01-15T05:56:22Z","updated_at":"2020-02-05T18:38:48Z","closed_at":"2020-02-05T18:38:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.5 on Elastic Cloud\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI am nesting a `filter` aggregation within a `rare_terms` aggregation:\r\n\r\n```\r\nGET metricbeat-7.5.1-2019.12.26-000001/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"rare\": {\r\n      \"rare_terms\": {\r\n        \"field\": \"process.name\",\r\n        \"max_doc_count\": 3\r\n      },\r\n      \"aggs\": {\r\n        \"filter\": {\r\n          \"filter\": {\r\n            \"range\": {\r\n              \"@timestamp\": {\r\n                \"gte\": \"now-15m\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n Some (or all) shards fail, returning an `index_out_of_bounds_exception`.\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"index_out_of_bounds_exception\",\r\n        \"reason\": \"index_out_of_bounds_exception: -1429505 is out of bounds: [0-1452587[\"\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"metricbeat-7.5.1-2019.12.26-000001\",\r\n        \"node\": \"NKmctNiHRTmKb2eNEhREIg\",\r\n        \"reason\": {\r\n          \"type\": \"index_out_of_bounds_exception\",\r\n          \"reason\": \"index_out_of_bounds_exception: -1429505 is out of bounds: [0-1452587[\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\nPlaying with the `range` query, it turns our that this works for some values of `gte`, and not for others. \r\nIn my case, the query above (currently) works for, e.g., `\"gte\": \"2020-01-14T00:00:00\"`.\r\n\r\nI am on Elastic Cloud and was unable to find additional logs. Please let me know which other information you need and how I can obtain it.","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}