{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609/events","html_url":"https://github.com/elastic/elasticsearch/issues/33609","id":359149873,"node_id":"MDU6SXNzdWUzNTkxNDk4NzM=","number":33609,"title":"`keyword_repeat` and `multiplexer` don't play well with subsequent synonym filters","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":962378555,"node_id":"MDU6TGFiZWw5NjIzNzg1NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.5.0","name":"v6.5.0","color":"Dddddd","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2018-09-11T17:40:27Z","updated_at":"2020-10-12T08:43:05Z","closed_at":"2018-09-19T14:52:15Z","author_association":"MEMBER","active_lock_reason":null,"body":"I recently saw an issue where an anlyzer chain was set up to perform some stemming on the input and then apply a synonym filter afterwards.\r\nIn order to also keep the unstemmed tokens in the output (and apply synonyms as well there if possible), a `keyword_repeat` filter was used, but\r\nthis already leads to errors on index creating because the synonyms in the filter are validated by running through the analysis chain:\r\n\r\n```\r\nPUT /index\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"my_synonyms\": {\r\n          \"type\": \"synonym\",\r\n          \"synonyms\": [\r\n            \"optimised => optimized\"\r\n          ]\r\n        },\r\n        \"english_stop\": {\r\n          \"type\": \"stop\",\r\n          \"stopwords\": \"_english_\"\r\n        },\r\n        \"light_english_stemmer\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"light_english\"\r\n        },\r\n        \"english_possessive_stemmer\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"possessive_english\"\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"blogs_synonyms_analyzer\": {\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"lowercase\",\r\n            \"keyword_repeat\",\r\n            \"light_english_stemmer\",\r\n            \"my_synonyms\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nGives: \r\n\r\n```\r\n    \"type\": \"illegal_argument_exception\",\r\n    \"reason\": \"failed to build synonyms\",\r\n    \"caused_by\": {\r\n      \"type\": \"parse_exception\",\r\n      \"reason\": \"Invalid synonym rule at line 1\",\r\n      \"caused_by\": {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"term: optimised analyzed to a token (optimise) with position increment != 1 (got: 0)\"\r\n      }\r\n    }\r\n```\r\n\r\nI also tried using a `multipexer` like so, but that is running into similar issues:\r\n\r\n```\r\nPUT /index\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"my_synonyms\": {\r\n          \"type\": \"synonym\",\r\n          \"synonyms\": [\r\n            \"optimised => optimized\"\r\n          ]\r\n        },\r\n        \"my_multiplexer\": {\r\n          \"type\": \"multiplexer\",\r\n          \"filters\": [\"light_english_stemmer\"]\r\n        },\r\n        \"english_stop\": {\r\n          \"type\": \"stop\",\r\n          \"stopwords\": \"_english_\"\r\n        },\r\n        \"light_english_stemmer\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"light_english\"\r\n        },\r\n        \"english_possessive_stemmer\": {\r\n          \"type\": \"stemmer\",\r\n          \"language\": \"possessive_english\"\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"blogs_synonyms_analyzer\": {\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"lowercase\",\r\n            \"my_multiplexer\",\r\n            \"my_synonyms\"\r\n            \r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI'm wondering if I'm using this the wrong way or if there are other ways to achieve similar effect.\r\nAlso I'm trying to understand what the position checks that are causing this rejection in `SynonymMap#analyze` are supposed to prevent \r\nand if those checks could possibly be omitted for the case of the tokens generated by `keyword_repeat` or `multiplexer`.","closed_by":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}