{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37005","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37005/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37005/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37005/events","html_url":"https://github.com/elastic/elasticsearch/issues/37005","id":394426672,"node_id":"MDU6SXNzdWUzOTQ0MjY2NzI=","number":37005,"title":"SharedClusterSnapshotRestoreIT#testSnapshotCanceledOnRemovedShard failing on Master","user":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2018-12-27T15:46:01Z","updated_at":"2019-01-30T19:53:35Z","closed_at":"2019-01-07T14:24:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Test failed on master:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=fedora/144/\r\n\r\nDoes NOT reproduce for me on master with:\r\n```\r\nREPRODUCE WITH: ./gradlew :server:integTest \\\r\n  -Dtests.seed=BA465B36283F19D1 \\\r\n  -Dtests.class=org.elasticsearch.snapshots.SharedClusterSnapshotRestoreIT \\\r\n  -Dtests.method=\"testSnapshotCanceledOnRemovedShard\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=hu \\\r\n  -Dtests.timezone=America/Merida \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nRelevant log snippet:\r\n```09:15:00   2> REPRODUCE WITH: ./gradlew :server:integTest -Dtests.seed=BA465B36283F19D1 -Dtests.class=org.elasticsearch.snapshots.SharedClusterSnapshotRestoreIT -Dtests.method=\"testSnapshotCanceledOnRemovedShard\" -Dtests.security.manager=true -Dtests.locale=hu -Dtests.timezone=America/Merida -Dcompiler.java=11 -Druntime.java=8\r\n09:15:00   1> [2018-12-27T08:14:13,064][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_sm2] removing template [random_index_template]\r\n09:15:00   1> [2018-12-27T08:14:13,092][INFO ][o.e.r.RepositoriesService] [node_sm2] delete repository [test-repo]\r\n09:15:00   1> [2018-12-27T08:14:13,132][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testDataFileFailureDuringRestore] [SharedClusterSnapshotRestoreIT#testDataFileFailureDuringRestore]: cleaned up after test\r\n09:15:00   1> [2018-12-27T08:14:13,132][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testDataFileFailureDuringRestore] after test\r\n09:15:00   1> [2018-12-27T08:14:13,287][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] before test\r\n09:15:00   1> [2018-12-27T08:14:13,287][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] [SharedClusterSnapshotRestoreIT#testSnapshotName]: setting up test\r\n09:15:00   1> [2018-12-27T08:14:13,294][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_sm2] adding template [random_index_template] for index patterns [*]\r\n09:15:00   1> [2018-12-27T08:14:13,331][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] [SharedClusterSnapshotRestoreIT#testSnapshotName]: all set up test\r\n09:15:00   1> [2018-12-27T08:14:13,331][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] -->  creating repository\r\n09:15:00   1> [2018-12-27T08:14:13,332][INFO ][o.e.r.RepositoriesService] [node_sm2] put repository [test-repo]\r\n09:15:00   1> [2018-12-27T08:14:13,386][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] [SharedClusterSnapshotRestoreIT#testSnapshotName]: cleaning up after test\r\n09:15:00   1> [2018-12-27T08:14:13,408][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_sm2] removing template [random_index_template]\r\n09:15:00   1> [2018-12-27T08:14:13,434][INFO ][o.e.r.RepositoriesService] [node_sm2] delete repository [test-repo]\r\n09:15:00   1> [2018-12-27T08:14:13,468][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] [SharedClusterSnapshotRestoreIT#testSnapshotName]: cleaned up after test\r\n09:15:00   1> [2018-12-27T08:14:13,469][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotName] after test\r\n09:15:00   1> [2018-12-27T08:14:13,607][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] before test\r\n09:15:00   1> [2018-12-27T08:14:13,607][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] [SharedClusterSnapshotRestoreIT#testSnapshotCanceledOnRemovedShard]: setting up test\r\n09:15:00   1> [2018-12-27T08:14:13,612][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_sm2] adding template [random_index_template] for index patterns [*]\r\n09:15:00   1> [2018-12-27T08:14:13,651][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] [SharedClusterSnapshotRestoreIT#testSnapshotCanceledOnRemovedShard]: all set up test\r\n09:15:00   1> [2018-12-27T08:14:13,653][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_sm2] [test-idx] creating index, cause [api], templates [random_index_template], shards [1]/[1], mappings []\r\n09:15:00   1> [2018-12-27T08:14:13,843][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> indexing some data\r\n09:15:00   1> [2018-12-27T08:14:13,846][INFO ][o.e.c.m.MetaDataMappingService] [node_sm2] [test-idx/lDUHpreESTWKTn3etC85pA] create_mapping [_doc]\r\n09:15:00   1> [2018-12-27T08:14:14,083][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> creating repository\r\n09:15:00   1> [2018-12-27T08:14:14,084][INFO ][o.e.s.m.MockRepository   ] [node_sm2] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,084][INFO ][o.e.r.RepositoriesService] [node_sm2] put repository [test-repo]\r\n09:15:00   1> [2018-12-27T08:14:14,095][INFO ][o.e.s.m.MockRepository   ] [node_sm0] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,095][INFO ][o.e.s.m.MockRepository   ] [node_sd4] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,096][INFO ][o.e.s.m.MockRepository   ] [node_sd5] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,096][INFO ][o.e.s.m.MockRepository   ] [node_sd3] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,096][INFO ][o.e.s.m.MockRepository   ] [node_sm1] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,112][INFO ][o.e.s.m.MockRepository   ] [node_sm2] starting mock repository with random prefix SWTuuSLFKZ\r\n09:15:00   1> [2018-12-27T08:14:14,120][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> snapshot\r\n09:15:00   1> [2018-12-27T08:14:14,120][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> waiting for block to kick in on node [node_sd4]\r\n09:15:00   1> [2018-12-27T08:14:14,144][INFO ][o.e.s.SnapshotsService   ] [node_sm2] snapshot [test-repo:test-snap/WLdcwqMYRHGiS_RxVVjbuQ] started\r\n09:15:00   1> [2018-12-27T08:14:14,192][INFO ][o.e.s.m.MockRepository   ] [node_sd4] [test-repo] blocking I/O operation for file [__0] at path [[indices][c-oqPeO2SSyVFv3iTpzMZw][0]]\r\n09:15:00   1> [2018-12-27T08:14:14,220][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> removing primary shard that is being snapshotted\r\n09:15:00   1> [2018-12-27T08:14:14,229][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> unblocking blocked node [node_sd4]\r\n09:15:00   1> [2018-12-27T08:14:14,229][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] --> ensuring snapshot is aborted and the aborted shard was marked as failed\r\n09:15:00   1> [2018-12-27T08:14:14,431][WARN ][o.e.s.SnapshotShardsService] [node_sd4] [[test-idx][0]][test-repo:test-snap/WLdcwqMYRHGiS_RxVVjbuQ] failed to snapshot shard\r\n09:15:00   1> org.elasticsearch.index.snapshots.IndexShardSnapshotFailedException: Aborted\r\n09:15:00   1> \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext$AbortableInputStream.checkAborted(BlobStoreRepository.java:1403) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext$AbortableInputStream.read(BlobStoreRepository.java:1396) ~[main/:?]\r\n09:15:00   1> \tat java.io.FilterInputStream.read(FilterInputStream.java:107) ~[?:1.8.0_192]\r\n09:15:00   1> \tat org.elasticsearch.core.internal.io.Streams.copy(Streams.java:54) ~[elasticsearch-core-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n09:15:00   1> \tat org.elasticsearch.common.blobstore.fs.FsBlobContainer.writeBlob(FsBlobContainer.java:133) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.snapshots.mockstore.BlobContainerWrapper.writeBlob(BlobContainerWrapper.java:53) ~[test/:?]\r\n09:15:00   1> \tat org.elasticsearch.snapshots.mockstore.MockRepository$MockBlobStore$MockBlobContainer.writeBlob(MockRepository.java:352) ~[test/:?]\r\n09:15:00   1> \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshotFile(BlobStoreRepository.java:1330) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1269) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:852) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:393) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.snapshots.SnapshotShardsService.access$100(SnapshotShardsService.java:94) ~[main/:?]\r\n09:15:00   1> \tat org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:336) [main/:?]\r\n09:15:00   1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:759) [main/:?]\r\n09:15:00   1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [main/:?]\r\n09:15:00   1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_192]\r\n09:15:00   1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_192]\r\n09:15:00   1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_192]\r\n09:15:00   1> [2018-12-27T08:14:14,435][WARN ][o.e.r.b.BlobStoreRepository] [node_sm2] [index-0] index blob is not valid x-content [0 bytes]\r\n09:15:00   1> [2018-12-27T08:14:14,436][INFO ][o.e.s.SnapshotsService   ] [node_sm2] snapshot [test-repo:test-snap/WLdcwqMYRHGiS_RxVVjbuQ] completed with state [PARTIAL]\r\n09:15:00   1> [2018-12-27T08:14:14,437][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] [SharedClusterSnapshotRestoreIT#testSnapshotCanceledOnRemovedShard]: cleaning up after test\r\n09:15:00   1> [2018-12-27T08:14:14,444][WARN ][o.e.i.c.IndicesClusterStateService] [node_sd4] [[test-idx][0]] marking and sending shard failed due to [master marked shard as active, but shard has not been created, mark shard as failed]\r\n09:15:00   1> [2018-12-27T08:14:14,453][WARN ][o.e.c.r.a.AllocationService] [node_sm2] failing shard [failed shard, shard [test-idx][0], node[NmI-D7OpTF6LOv51WTCDyw], [P], s[STARTED], a[id=jqVYMdb5SQmT9qtKYKXh6Q], message [master marked shard as active, but shard has not been created, mark shard as failed], failure [Unknown], markAsStale [true]]\r\n09:15:00   1> [2018-12-27T08:14:14,454][INFO ][o.e.c.r.a.AllocationService] [node_sm2] Cluster health status changed from [YELLOW] to [RED] (reason: [shards failed [[test-idx][0]] ...]).\r\n09:15:00   1> [2018-12-27T08:14:14,476][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_sm2] [test-idx/lDUHpreESTWKTn3etC85pA] deleting index\r\n09:15:00   1> [2018-12-27T08:14:14,531][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_sm2] removing template [random_index_template]\r\n09:15:00   1> [2018-12-27T08:14:14,554][INFO ][o.e.r.RepositoriesService] [node_sm2] delete repository [test-repo]\r\n09:15:00   1> [2018-12-27T08:14:14,577][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] [SharedClusterSnapshotRestoreIT#testSnapshotCanceledOnRemovedShard]: cleaned up after test\r\n09:15:00   1> [2018-12-27T08:14:14,577][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testSnapshotCanceledOnRemovedShard] after test\r\n09:15:00 ERROR   1.14s J7 | SharedClusterSnapshotRestoreIT.testSnapshotCanceledOnRemovedShard <<< FAILURES!\r\n09:15:00    > Throwable #1: NotSerializableExceptionWrapper[not_x_content_exception: Compressor detection can only be called on some xcontent bytes or compressed xcontent bytes]\r\n09:15:00    > \tat __randomizedtesting.SeedInfo.seed([BA465B36283F19D1:2BF74722441573D]:0)\r\n09:15:00    > \tat org.elasticsearch.common.compress.CompressorFactory.compressor(CompressorFactory.java:56)\r\n09:15:00    > \tat org.elasticsearch.common.xcontent.XContentHelper.createParser(XContentHelper.java:70)\r\n09:15:00    > \tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.getRepositoryData(BlobStoreRepository.java:670)\r\n09:15:00    > \tat org.elasticsearch.snapshots.SnapshotsService.getRepositoryData(SnapshotsService.java:148)\r\n09:15:00    > \tat org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:96)\r\n09:15:00    > \tat org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:54)\r\n09:15:00    > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:127)\r\n09:15:00    > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:208)\r\n09:15:00    > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:759)\r\n09:15:00    > \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n09:15:00    > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n09:15:00    > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n09:15:00    > \tat java.lang.Thread.run(Thread.java:748)\r\n09:15:00   1> [2018-12-27T08:14:14,796][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testGetSnapshotsRequest] before test\r\n09:15:00   1> [2018-12-27T08:14:14,797][INFO ][o.e.s.SharedClusterSnapshotRestoreIT] [testGetSnapshotsRequest]```","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}