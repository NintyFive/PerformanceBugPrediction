{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34707","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34707/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34707/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34707/events","html_url":"https://github.com/elastic/elasticsearch/issues/34707","id":372513436,"node_id":"MDU6SXNzdWUzNzI1MTM0MzY=","number":34707,"title":"Bug: cluster routing allocation exclude setting after node restart","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-10-22T13:06:54Z","updated_at":"2018-10-23T13:41:42Z","closed_at":"2018-10-22T18:01:48Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nWe're experiencing a weird behavior on our cluster after one of the nodes restarted (OOM exception): a new cluster setting appears which excludes this node from the allocation of shards, i.e. `\"cluster.routing.allocation.exclude._name\": \"elasticsearch-cold-2\"`.\r\n\r\n**Elasticsearch version**:\r\n6.3.2\r\n\r\n**Plugins installed**:\r\ningest-geoip\r\ningest-user-agent\r\nmapper-murmur3\r\nmapper-size\r\nrepository-azure\r\nrepository-gcs\r\nrepository-s3\r\n\r\n**JVM version**:\r\nopenjdk 10.0.2 2018-07-17\r\nOpenJDK Runtime Environment 18.3 (build 10.0.2+13)\r\nOpenJDK 64-Bit Server VM 18.3 (build 10.0.2+13, mixed mode)\r\n\r\n**OS version**:\r\nLinux 4.9.0-6-amd64 #1 SMP Debian 4.9.82-1+deb9u3 (2018-03-02) x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAfter one of the cluster nodes restarted (encountered an OOM exception), re-joined the cluster and all delayed unassigned shards have recovered, we've noticed that the cluster still moves shards away from that node. Following some investigation, we noticed a new setting showed up under `_cluster/settings`:\r\n```\r\n{\r\n  \"transient\": {\r\n    \"cluster\": {\r\n      \"routing\": {\r\n        \"allocation\": {\r\n          \"exclude\": {\r\n            \"_name\": \"elasticsearch-cold-2\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Steps to reproduce**:\r\n 1. Ramp up a cluster with several data nodes.\r\n 2. Wait for a node to crash (...)\r\n 3. Enjoy your new setting under `_cluster/settings`\r\n\r\nWe have no idea why this setting showed up, and have definitely not PUT it ourselves. The fact this setting continues to exist even after the cluster has gone green (under `_cluster/health`) is even more disturbing and demands manual inspection.\r\n\r\nWhy does this happen?\r\nHow do we prevent it from happening again?\r\n\r\nThanks\r\n","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}