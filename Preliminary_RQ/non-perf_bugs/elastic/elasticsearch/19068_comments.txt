[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/228405707","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-228405707","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":228405707,"node_id":"MDEyOklzc3VlQ29tbWVudDIyODQwNTcwNw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-24T17:17:13Z","updated_at":"2016-06-24T17:17:13Z","author_association":"MEMBER","body":"Well, I see the problem, but I don't know enough to understand why it's being done this way.  Perhaps not for a real reason and it's just incorrect?\n\nWhen a `WeightFactorFunction` is scored, it multiplies the score (`1` in this case, since it's a filter) [by it's own weight](https://github.com/elastic/elasticsearch/blob/2.x/core/src/main/java/org/elasticsearch/common/lucene/search/function/WeightFactorFunction.java#L61).  But when averaging the function scores, we [explicitly check if the weight is a `WeightFactorFunction`](https://github.com/elastic/elasticsearch/blob/2.x/core/src/main/java/org/elasticsearch/common/lucene/search/function/FiltersFunctionScoreQuery.java#L312-L316), and if it is, divide by the weight.  So net result is that each function with a weight divides out to a score of 1, which is why it isn't averaging the weights correctly.\n\nI'm not sure why the `WeightFactorFunction` is special cased, but I think we can just remove the special case and increment the counter as normal?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/228740730","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-228740730","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":228740730,"node_id":"MDEyOklzc3VlQ29tbWVudDIyODc0MDczMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-06-27T13:10:25Z","updated_at":"2016-06-27T13:10:25Z","author_association":"CONTRIBUTOR","body":"@brwe What do you think?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229034078","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229034078","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229034078,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTAzNDA3OA==","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2016-06-28T12:27:06Z","updated_at":"2016-06-28T12:27:06Z","author_association":"CONTRIBUTOR","body":"`avg` computes the weighted average of the functions, see https://github.com/elastic/elasticsearch/issues/8992 and https://github.com/elastic/elasticsearch/issues/13732 for more explanation. You should be able to accomplish the averages of the values by having them returned by a script instead of using them as a weight. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229054199","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229054199","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229054199,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTA1NDE5OQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-28T13:49:05Z","updated_at":"2016-06-28T13:49:05Z","author_association":"MEMBER","body":"Ah, I see.  Perhaps we should re-add a basic, unweighted average as `avg`, and rename the existing `avg` to `weighted_avg`?  Or vice versa: add an `unweighted_avg` and leave the current one as `avg`?\n\n>  You should be able to accomplish the averages of the values by having them returned by a script instead of using them as a weight.\n\nI'm not sure this would work when you want to use more complex queries/filters?  E.g. if docA matches `(xyz AND abc) OR 123` , return a non-weighted score of 25.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229096528","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229096528","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229096528,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTA5NjUyOA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-06-28T16:02:31Z","updated_at":"2016-06-28T16:02:31Z","author_association":"CONTRIBUTOR","body":"I think Britta meant using a `script_score` function when she talked about using a script, rather than a script query. So something like this (not tested):\n\n```\nGET foo/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"functions\": [\n        {\n          \"filter\": {\n            \"term\": {\n              \"name\": \"a\"\n            }\n          },\n          \"script_score\": {\n            \"script\": \"20\"\n          }\n        },\n        {\n          \"filter\": {\n            \"term\": {\n              \"name\": \"b\"\n            }\n          },\n          \"script_score\": {\n            \"script\": \"10\"\n          }\n        }\n      ],\n      \"score_mode\": \"avg\",\n      \"boost_mode\": \"replace\"\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229101034","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229101034","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229101034,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTEwMTAzNA==","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2016-06-28T16:17:50Z","updated_at":"2016-06-28T16:17:50Z","author_association":"CONTRIBUTOR","body":"> I think Britta meant using a script_score\n\nyes\n\n>   Perhaps we should re-add a basic, unweighted average as avg, and rename the existing avg to weighted_avg? Or vice versa: add an unweighted_avg and leave the current one as `avg`\n\nIf we find we need an unweighted average then I'd prefer the latter option.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229102621","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229102621","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229102621,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTEwMjYyMQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-28T16:23:01Z","updated_at":"2016-06-28T16:23:01Z","author_association":"MEMBER","body":"Ah, I see.  Thanks for the explanation :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229337652","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229337652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229337652,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTMzNzY1Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-06-29T12:10:52Z","updated_at":"2016-06-29T12:10:52Z","author_association":"CONTRIBUTOR","body":"This isn't the first time this has come up, perhaps it should be better explained in the docs? https://www.elastic.co/guide/en/elasticsearch/reference/2.3/query-dsl-function-score-query.html\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/229370902","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-229370902","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":229370902,"node_id":"MDEyOklzc3VlQ29tbWVudDIyOTM3MDkwMg==","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2016-06-29T14:21:03Z","updated_at":"2016-06-29T14:21:03Z","author_association":"CONTRIBUTOR","body":"yes, I opened https://github.com/elastic/elasticsearch/pull/19154\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290666688","html_url":"https://github.com/elastic/elasticsearch/issues/19068#issuecomment-290666688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19068","id":290666688,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDY2NjY4OA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T09:36:41Z","updated_at":"2017-03-31T09:36:41Z","author_association":"MEMBER","body":"It seems like this was addressed in documentation in #19154 so I'll close this issue. If there is more to be done please reopen","performed_via_github_app":null}]