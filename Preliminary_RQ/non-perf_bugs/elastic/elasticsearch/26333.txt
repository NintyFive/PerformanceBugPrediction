{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26333","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26333/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26333/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26333/events","html_url":"https://github.com/elastic/elasticsearch/issues/26333","id":252148256,"node_id":"MDU6SXNzdWUyNTIxNDgyNTY=","number":26333,"title":"[Cleaner of Elasticsearch]Suggest using resource limit to clean log data  rather than number of days.","user":{"login":"mengjieli0726","id":2181539,"node_id":"MDQ6VXNlcjIxODE1Mzk=","avatar_url":"https://avatars2.githubusercontent.com/u/2181539?v=4","gravatar_id":"","url":"https://api.github.com/users/mengjieli0726","html_url":"https://github.com/mengjieli0726","followers_url":"https://api.github.com/users/mengjieli0726/followers","following_url":"https://api.github.com/users/mengjieli0726/following{/other_user}","gists_url":"https://api.github.com/users/mengjieli0726/gists{/gist_id}","starred_url":"https://api.github.com/users/mengjieli0726/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mengjieli0726/subscriptions","organizations_url":"https://api.github.com/users/mengjieli0726/orgs","repos_url":"https://api.github.com/users/mengjieli0726/repos","events_url":"https://api.github.com/users/mengjieli0726/events{/privacy}","received_events_url":"https://api.github.com/users/mengjieli0726/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-08-23T03:19:48Z","updated_at":"2017-08-23T03:58:16Z","closed_at":"2017-08-23T03:58:16Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\nElasticsearch Cleaner\r\n\r\n**Describe the feature**:\r\nSuggest using resource limit to clean log data  rather than number of days.\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nroot@ib17b08:/usr/share/elasticsearch# elasticsearch --version\r\nVersion: 2.4.1, Build: c67dc32/2016-09-27T18:57:55Z, JVM: 1.8.0\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n java -version\r\nopenjdk version \"1.8.0_65\"\r\nOpenJDK Runtime Environment (build 1.8.0_65-b17)\r\nOpenJDK 64-Bit Server VM (build 25.65-b01, mixed mode)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\nIn my performance cluster,  there are 517G resource need to be delete.  After trigger the clean log tools \"curator\", it can keep 5 days logstash  log data and 1 days heapster log data.\r\n\r\n\"/usr/local/bin/curator --config /etc/curator.yml /action.yml\"\r\n\r\n\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. simulated to increase log data to 100+ G \r\nHowever, in my env,  the log data is huge number, it still have 136G log data.\r\n[root@host1 indices]# du -sh\r\n517G\t.\r\n[root@host1 indices]# ll\r\ntotal 96\r\ndrwxr-xr-x 5 105 106 4096 Aug 11 05:25 heapster-2017.08.11\r\ndrwxr-xr-x 5 105 106 4096 Aug 11 20:01 heapster-2017.08.12\r\ndrwxr-xr-x 5 105 106 4096 Aug 12 20:01 heapster-2017.08.13\r\ndrwxr-xr-x 5 105 106 4096 Aug 13 20:00 heapster-2017.08.14\r\ndrwxr-xr-x 5 105 106 4096 Aug 14 20:01 heapster-2017.08.15\r\ndrwxr-xr-x 5 105 106 4096 Aug 15 20:02 heapster-2017.08.16\r\ndrwxr-xr-x 5 105 106 4096 Aug 16 20:02 heapster-2017.08.17\r\ndrwxr-xr-x 5 105 106 4096 Aug 17 20:03 heapster-2017.08.18\r\ndrwxr-xr-x 5 105 106 4096 Aug 18 20:01 heapster-2017.08.19\r\ndrwxr-xr-x 5 105 106 4096 Aug 19 20:00 heapster-2017.08.20\r\ndrwxr-xr-x 5 105 106 4096 Aug 20 20:00 heapster-2017.08.21\r\ndrwxr-xr-x 5 105 106 4096 Aug 21 20:09 heapster-2017.08.22\r\ndrwxr-xr-x 5 105 106 4096 Aug 22 20:03 heapster-2017.08.23\r\ndrwxr-xr-x 5 105 106 4096 Aug 11 05:24 logstash-2017.08.11\r\ndrwxr-xr-x 5 105 106 4096 Aug 11 19:54 logstash-2017.08.12\r\ndrwxr-xr-x 5 105 106 4096 Aug 12 19:54 logstash-2017.08.13\r\ndrwxr-xr-x 5 105 106 4096 Aug 14 19:54 logstash-2017.08.15\r\ndrwxr-xr-x 5 105 106 4096 Aug 16 19:54 logstash-2017.08.17\r\ndrwxr-xr-x 5 105 106 4096 Aug 17 19:54 logstash-2017.08.18\r\ndrwxr-xr-x 5 105 106 4096 Aug 18 19:54 logstash-2017.08.19\r\ndrwxr-xr-x 5 105 106 4096 Aug 19 19:54 logstash-2017.08.20\r\ndrwxr-xr-x 5 105 106 4096 Aug 20 19:54 logstash-2017.08.21\r\ndrwxr-xr-x 5 105 106 4096 Aug 21 19:54 logstash-2017.08.22\r\ndrwxr-xr-x 5 105 106 4096 Aug 22 19:54 logstash-2017.08.23\r\n\r\n\r\n 2. run clean tool to clean log data\r\n/usr/local/bin/curator --config /etc/curator.yml /action.yml\r\n\r\nroot@host1:/# cat /etc/curator.yml\r\n---\r\n\r\nclient:\r\n  hosts:\r\n    - 127.0.0.1\r\n  port: 9200\r\n  url_prefix:\r\n  use_ssl: False\r\n  certificate:\r\n  client_cert:\r\n  client_key:\r\n  ssl_no_validate: False\r\n  http_auth:\r\n  timeout: 30\r\n  master_only: False\r\n\r\nlogging:\r\n  loglevel: INFO\r\n  logformat: default\r\n  blacklist: ['elasticsearch', 'urllib3']\r\n\r\n\r\nroot@host1:/# cat /usr/local/bin/curator\r\n#!/usr/bin/python\r\n\r\n# -*- coding: utf-8 -*-\r\nimport re\r\nimport sys\r\n\r\nfrom curator.cli import cli\r\n\r\nif __name__ == '__main__':\r\n    sys.argv[0] = re.sub(r'(-script\\.pyw|\\.exe)?$', '', sys.argv[0])\r\n    sys.exit(cli())\r\n\r\n\r\nroot@host1:/# cat /action.yml\r\n---\r\n# Remember, leave a key empty if there is no value.  None will be a string,\r\n# not a Python \"NoneType\"\r\n#\r\n# Also remember that all examples have 'disable_action' set to True.  If you\r\n# want to use this action as a template, be sure to set this to False after\r\n# copying it.\r\nactions:\r\n  1:\r\n    action: delete_indices\r\n    description: >-\r\n      Delete logstash- prefixed indices. Ignore the error if the filter does\r\n      not result in an actionable list of indices (ignore_empty_list) and exit cleanly.\r\n    options:\r\n      ignore_empty_list: True\r\n      timeout_override:\r\n      continue_if_exception: False\r\n      disable_action: False\r\n    filters:\r\n    - filtertype: pattern\r\n      kind: prefix\r\n      value: logstash-\r\n      exclude:\r\n    - filtertype: age\r\n      source: name\r\n      direction: older\r\n      timestring: '%Y.%m.%d'\r\n      unit: days\r\n      unit_count: 5\r\n      exclude:\r\n 2:\r\n    action: delete_indices\r\n    description: >-\r\n      Delete heapster prefixed indices. Ignore the error if the filter does not result in an\r\n      actionable list of indices (ignore_empty_list) and exit cleanly.\r\n    options:\r\n      ignore_empty_list: True\r\n      timeout_override:\r\n      continue_if_exception: False\r\n      disable_action: False\r\n    filters:\r\n    - filtertype: pattern\r\n      kind: prefix\r\n      value: heapster-\r\n      exclude:\r\n    - filtertype: age\r\n      source: name\r\n      direction: older\r\n      timestring: '%Y.%m.%d'\r\n      unit: days\r\n      unit_count: 1\r\n      exclude:\r\n \r\n\r\n3. After clean the log data, there still is 136G log data.\r\n\r\n[root@ib17b08 indices]# du -sh\r\n139G\t.\r\n[root@ib17b08 indices]# ll\r\ntotal 24\r\ndrwxr-xr-x 5 105 106 4096 Aug 22 20:03 heapster-2017.08.23\r\ndrwxr-xr-x 5 105 106 4096 Aug 18 19:54 logstash-2017.08.19\r\ndrwxr-xr-x 5 105 106 4096 Aug 19 19:54 logstash-2017.08.20\r\ndrwxr-xr-x 5 105 106 4096 Aug 20 19:54 logstash-2017.08.21\r\ndrwxr-xr-x 5 105 106 4096 Aug 21 19:54 logstash-2017.08.22\r\ndrwxr-xr-x 5 105 106 4096 Aug 22 19:54 logstash-2017.08.23\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nroot@ib17b08:/# cat /var/log/curator-cron.log\r\n2017-08-22 22:29:43,214 INFO      Preparing Action ID: 1, \"delete_indices\"\r\n2017-08-22 22:29:43,245 INFO      Trying Action ID: 1, \"delete_indices\": Delete logstash- prefixed indices. Ignore the error if the filter does not result in an actionable list of indices (ignore_empty_list) and exit cleanly.\r\n2017-08-22 22:29:43,659 INFO      Deleting selected indices: [u'logstash-2017.08.14', u'logstash-2017.08.15', u'logstash-2017.08.16', u'logstash-2017.08.17', u'logstash-2017.08.11', u'logstash-2017.08.12', u'logstash-2017.08.13', u'logstash-2017.08.18']\r\n2017-08-22 22:29:43,659 INFO      ---deleting index logstash-2017.08.14\r\n2017-08-22 22:29:43,659 INFO      ---deleting index logstash-2017.08.15\r\n2017-08-22 22:29:43,659 INFO      ---deleting index logstash-2017.08.16\r\n2017-08-22 22:29:43,659 INFO      ---deleting index logstash-2017.08.17\r\n2017-08-22 22:29:43,660 INFO      ---deleting index logstash-2017.08.11\r\n2017-08-22 22:29:43,660 INFO      ---deleting index logstash-2017.08.12\r\n2017-08-22 22:29:43,660 INFO      ---deleting index logstash-2017.08.13\r\n2017-08-22 22:29:43,660 INFO      ---deleting index logstash-2017.08.18\r\n2017-08-22 22:30:13,668 ERROR     Failed to complete action: delete_indices.  <class 'curator.exceptions.FailedExecution'>: Exception encountered.  Rerun with loglevel DEBUG and/or check Elasticsearch logs for more information. Exception: ConnectionTimeout caused by - ReadTimeoutError(HTTPConnectionPool(host=u'127.0.0.1', port=9200): Read timed out. (read timeout=30))\r\n2017-08-22 22:37:37,449 INFO      Preparing Action ID: 1, \"delete_indices\"\r\n2017-08-22 22:37:37,453 INFO      Trying Action ID: 1, \"delete_indices\": Delete logstash- prefixed indices. Ignore the error if the filter does not result in an actionable list of indices (ignore_empty_list) and exit cleanly.\r\n2017-08-22 22:37:37,503 INFO      Skipping action \"delete_indices\" due to empty list: <class 'curator.exceptions.NoIndices'>\r\n2017-08-22 22:37:37,503 INFO      Action ID: 1, \"delete_indices\" completed.\r\n2017-08-22 22:37:37,503 INFO      Preparing Action ID: 2, \"delete_indices\"\r\n2017-08-22 22:37:37,505 INFO      Trying Action ID: 2, \"delete_indices\": Delete heapster prefixed indices. Ignore the error if the filter does not result in an actionable list of indices (ignore_empty_list) and exit cleanly.\r\n2017-08-22 22:37:37,543 INFO      Deleting selected indices: [u'heapster-2017.08.19', u'heapster-2017.08.18', u'heapster-2017.08.20', u'heapster-2017.08.21', u'heapster-2017.08.22', u'heapster-2017.08.11', u'heapster-2017.08.13', u'heapster-2017.08.12', u'heapster-2017.08.15', u'heapster-2017.08.14', u'heapster-2017.08.17', u'heapster-2017.08.16']\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.19\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.18\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.20\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.21\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.22\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.11\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.13\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.12\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.15\r\n2017-08-22 22:37:37,543 INFO      ---deleting index heapster-2017.08.14\r\n2017-08-22 22:37:37,544 INFO      ---deleting index heapster-2017.08.17\r\n2017-08-22 22:37:37,544 INFO      ---deleting index heapster-2017.08.16\r\n2017-08-22 22:37:46,522 INFO      Action ID: 2, \"delete_indices\" completed.\r\n2017-08-22 22:37:46,522 INFO      Job completed.","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}