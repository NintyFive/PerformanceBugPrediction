{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55407","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55407/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55407/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55407/events","html_url":"https://github.com/elastic/elasticsearch/issues/55407","id":602073073,"node_id":"MDU6SXNzdWU2MDIwNzMwNzM=","number":55407,"title":"S3 Repo plugin \"path_style_access\" option insufficient alone","user":{"login":"danielharada","id":9708990,"node_id":"MDQ6VXNlcjk3MDg5OTA=","avatar_url":"https://avatars1.githubusercontent.com/u/9708990?v=4","gravatar_id":"","url":"https://api.github.com/users/danielharada","html_url":"https://github.com/danielharada","followers_url":"https://api.github.com/users/danielharada/followers","following_url":"https://api.github.com/users/danielharada/following{/other_user}","gists_url":"https://api.github.com/users/danielharada/gists{/gist_id}","starred_url":"https://api.github.com/users/danielharada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielharada/subscriptions","organizations_url":"https://api.github.com/users/danielharada/orgs","repos_url":"https://api.github.com/users/danielharada/repos","events_url":"https://api.github.com/users/danielharada/events{/privacy}","received_events_url":"https://api.github.com/users/danielharada/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-04-17T15:53:07Z","updated_at":"2020-04-20T08:56:14Z","closed_at":"2020-04-20T08:56:14Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 7.6.0, Build: default/tar/7f634e9f44834fbc12724506cc1da681b0c3b1e3/2020-02-06T00:09:00.449973Z, JVM: 13.0.2\r\n\r\n**Plugins installed**: [S3 repository plugin]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_231\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_231-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.231-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nMac OS 10.14.6\r\n18.7.0 Darwin Kernel Version 18.7.0: Thu Jan 23 06:52:12 PST 2020; root:xnu-4903.278.25~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen creating an S3 repository by `PUT _snapshot/my_s3_repository` using the \"path_style_access\" option, both this option and the \"endpoint\" option must be specified in the same location, or this option does not take effect and we use the default bucket.endpoint DNS scheme instead of the expected endpoint/bucket path style access scheme.\r\n\r\nThese settings can be specified in either elasticsearch.yml file or in the API call.  Any options in the API call _should_ override what's in the yml.  If I specify one of \"endpoint\" or \"path_style_access\" in the yml and the other in the API call, we do not correctly use the path style access.  If both are specified in the yml or both in the API call, we successfully change the access style.\r\n\r\nThe documentation at https://www.elastic.co/guide/en/elasticsearch/plugins/master/repository-s3-client.html does not mention this requirement.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Set up ES with S3 Repository Plugin\r\n 2. Add `s3.client.CLIENT_NAME.endpoint: your_endpoint` to elasticsearch.yml\r\n 3. Run the following API call to add an S3 repository:\r\n```\r\nPUT /_snapshot/your_repository\r\n{\r\n  \"type\": \"s3\",\r\n  \"settings\": {\r\n    \"bucket\": \"your_bucket\",\r\n    \"path_style_access\": \"true\",\r\n    \"client\": \"CLIENT_NAME\"\r\n  }\r\n}\r\n```\r\n**Expected Results**\r\nES attempts to connect to bucket your_endpoint/your_bucket\r\n**Actual results**\r\nES attempts to connect to your_bucket.your_endpoint, throws error because this URL does not exist.\r\nError message:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"repository_verification_exception\",\r\n        \"reason\": \"[your_bucket] path is not accessible on master node\"\r\n      }\r\n    ],\r\n    \"type\": \"repository_verification_exception\",\r\n    \"reason\": \"[your_bucket] path is not accessible on master node\",\r\n    \"caused_by\": {\r\n      \"type\": \"i_o_exception\",\r\n      \"reason\": \"Unable to upload object [tests-ngfk4rH8TWeQSysVW4oSbA/master.dat] using a single upload\",\r\n      \"caused_by\": {\r\n        \"type\": \"sdk_client_exception\",\r\n        \"reason\": \"Unable to execute HTTP request: your_bucket.your_endpoint\",\r\n        \"caused_by\": {\r\n          \"type\": \"unknown_host_exception\",\r\n          \"reason\": \"your_bucket.your_endpoint\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n 4. Run the following API call:\r\n```\r\nPUT /_snapshot/your_repository\r\n{\r\n  \"type\": \"s3\",\r\n  \"settings\": {\r\n    \"bucket\": \"your_bucket\",\r\n    \"path_style_access\": \"true\",\r\n    \"endpoint\": \"your_endpoint\"\r\n    \"client\": \"CLIENT_NAME\"\r\n  }\r\n}\r\n```\r\n**Results**\r\nES correctly attempts to connect to your_endpoint/your_bucket\r\n\r\nNote that when testing, your_endpoint and your_bucket don't have to actually exist.  The error messaging will tell you what URL ES attempted to connect to, so you can see which form it is hitting.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}