[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553881140","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553881140","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553881140,"node_id":"MDEyOklzc3VlQ29tbWVudDU1Mzg4MTE0MA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T13:11:03Z","updated_at":"2019-11-14T13:11:03Z","author_association":"MEMBER","body":"Hi @akhileshbhatia, thanks for raising this. To get a better understanding if this is a bug or something else I'd like to ask if you can get us the stack trace leading to the ArrayIndexOutOfBoundsException from the elasticsearch logs. Also if you can share your index mapping and settings, that might help. I see you are searching across all indices, is that intended? Should all indices share the same schema?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553881239","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553881239","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553881239,"node_id":"MDEyOklzc3VlQ29tbWVudDU1Mzg4MTIzOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T13:11:26Z","updated_at":"2019-11-14T13:11:26Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553882202","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553882202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553882202,"node_id":"MDEyOklzc3VlQ29tbWVudDU1Mzg4MjIwMg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T13:14:15Z","updated_at":"2019-11-14T13:15:20Z","author_association":"MEMBER","body":"Actually, looks like the `_search` is only targeting one index here (\"companiestable\"), so please ignore that part of the question. Here's the query in nicer format for future reference again:\r\n```\r\n{\r\n  \"aggs\": {\r\n    \"topicFilters\": {\r\n      \"filters\": {\r\n        \"filters\": [{\r\n          \"span_near\": {\r\n            \"clauses\": [{\r\n              \"span_term\": {\r\n                \"description\": \"compani\"\r\n              }\r\n            }, {\r\n              \"span_term\": {\r\n                \"description\": \"technolog\"\r\n              }\r\n            }],\r\n            \"slop\": 2,\r\n            \"in_order\": false\r\n          }\r\n        }, {\r\n          \"span_near\": {\r\n            \"clauses\": [{\r\n              \"span_term\": {\r\n                \"description\": \"market\"\r\n              }\r\n            }, {\r\n              \"span_term\": {\r\n                \"description\": \"technolog\"\r\n              }\r\n            }],\r\n            \"slop\": 2,\r\n            \"in_order\": false\r\n          }\r\n        }]\r\n      },\r\n      \"aggs\": {\r\n        \"sampler\": {\r\n          \"sampler\": {\r\n            \"shard_size\": 1000\r\n          },\r\n          \"aggs\": {\r\n            \"subtopics\": {\r\n              \"terms\": {\r\n                \"field\": \"description\",\r\n                \"size\": 48,\r\n                \"include\": [\"market\", \"technolog\", \"compani\"]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [{\r\n        \"match_phrase\": {\r\n          \"description\": \"Real Estate\"\r\n        }\r\n      }, {\r\n        \"wildcard\": {\r\n          \"description\": \"*\"\r\n        }\r\n      }]\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553909892","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553909892","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553909892,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MzkwOTg5Mg==","user":{"login":"akhileshbhatia","id":10994002,"node_id":"MDQ6VXNlcjEwOTk0MDAy","avatar_url":"https://avatars0.githubusercontent.com/u/10994002?v=4","gravatar_id":"","url":"https://api.github.com/users/akhileshbhatia","html_url":"https://github.com/akhileshbhatia","followers_url":"https://api.github.com/users/akhileshbhatia/followers","following_url":"https://api.github.com/users/akhileshbhatia/following{/other_user}","gists_url":"https://api.github.com/users/akhileshbhatia/gists{/gist_id}","starred_url":"https://api.github.com/users/akhileshbhatia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhileshbhatia/subscriptions","organizations_url":"https://api.github.com/users/akhileshbhatia/orgs","repos_url":"https://api.github.com/users/akhileshbhatia/repos","events_url":"https://api.github.com/users/akhileshbhatia/events{/privacy}","received_events_url":"https://api.github.com/users/akhileshbhatia/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T14:23:53Z","updated_at":"2019-11-14T14:23:53Z","author_association":"NONE","body":"Here are the mappings:\r\n```\r\n$ curl 'http://localhost:9200/companiestable/_mappings?pretty'\r\n{\r\n  \"companiestable\" : {\r\n    \"mappings\" : {\r\n      \"doc\" : {\r\n        \"properties\" : {\r\n          \"@timestamp\" : {\r\n            \"type\" : \"date\"\r\n          },\r\n          \"blog_feed_url\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"blog_url\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"category_code\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"city\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"company\" : {\r\n            \"properties\" : {\r\n              \"category_code\" : {\r\n                \"type\" : \"keyword\"\r\n              },\r\n              \"name\" : {\r\n                \"properties\" : {\r\n                  \"label\" : {\r\n                    \"type\" : \"keyword\"\r\n                  }\r\n                }\r\n              },\r\n              \"number_of_employees\" : {\r\n                \"type\" : \"float\"\r\n              }\r\n            }\r\n          },\r\n          \"countrycode\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"deadpooled_date\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"description\" : {\r\n            \"type\" : \"text\",\r\n            \"analyzer\" : \"english\",\r\n            \"fielddata\" : true\r\n          },\r\n          \"email_address\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"founded_date\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"founded_month\" : {\r\n            \"type\" : \"float\"\r\n          },\r\n          \"founded_year\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"freebaseid\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"hasstatus\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"homepage_url\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"id\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"label\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"label-not-analyzed\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"location\" : {\r\n            \"properties\" : {\r\n              \"lat\" : {\r\n                \"type\" : \"float\"\r\n              },\r\n              \"lon\" : {\r\n                \"type\" : \"float\"\r\n              }\r\n            }\r\n          },\r\n          \"number_of_employees\" : {\r\n            \"type\" : \"float\"\r\n          },\r\n          \"one_competitor\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"overview\" : {\r\n            \"type\" : \"text\",\r\n            \"analyzer\" : \"english\",\r\n            \"fielddata\" : true\r\n          },\r\n          \"permalink\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"phone_number\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"revenue\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"revenuecurrency\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"revenuedate\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"statecode\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"url\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"webpage\" : {\r\n            \"type\" : \"keyword\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553910305","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553910305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553910305,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MzkxMDMwNQ==","user":{"login":"akhileshbhatia","id":10994002,"node_id":"MDQ6VXNlcjEwOTk0MDAy","avatar_url":"https://avatars0.githubusercontent.com/u/10994002?v=4","gravatar_id":"","url":"https://api.github.com/users/akhileshbhatia","html_url":"https://github.com/akhileshbhatia","followers_url":"https://api.github.com/users/akhileshbhatia/followers","following_url":"https://api.github.com/users/akhileshbhatia/following{/other_user}","gists_url":"https://api.github.com/users/akhileshbhatia/gists{/gist_id}","starred_url":"https://api.github.com/users/akhileshbhatia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhileshbhatia/subscriptions","organizations_url":"https://api.github.com/users/akhileshbhatia/orgs","repos_url":"https://api.github.com/users/akhileshbhatia/repos","events_url":"https://api.github.com/users/akhileshbhatia/events{/privacy}","received_events_url":"https://api.github.com/users/akhileshbhatia/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T14:24:51Z","updated_at":"2019-11-14T14:24:51Z","author_association":"NONE","body":"Here are the settings\r\n\r\n```\r\n{\r\n  \"web-service-webhose-news-results-webhose-news\" : {\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"creation_date\" : \"1573043557213\",\r\n        \"number_of_shards\" : \"5\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"qw-bFL8WT2-ocRYsTY8o0Q\",\r\n        \"version\" : {\r\n          \"created\" : \"6080299\"\r\n        },\r\n        \"provided_name\" : \"web-service-webhose-news-results-webhose-news\"\r\n      }\r\n    }\r\n  },\r\n  \"companiestable\" : {\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"creation_date\" : \"1573043721306\",\r\n        \"number_of_shards\" : \"5\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"EUCotdczTnmPAQ6mIIMD7Q\",\r\n        \"version\" : {\r\n          \"created\" : \"6080299\"\r\n        },\r\n        \"provided_name\" : \"companiestable\"\r\n      }\r\n    }\r\n  },\r\n  \".siren\" : {\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"creation_date\" : \"1573043555169\",\r\n        \"number_of_shards\" : \"5\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"BpbsPKDETMeu7zkLV8wiNg\",\r\n        \"version\" : {\r\n          \"created\" : \"6080299\"\r\n        },\r\n        \"provided_name\" : \".siren\"\r\n      }\r\n    }\r\n  },\r\n  \"watcher_alarms-2019.11.06\" : {\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"creation_date\" : \"1573043556797\",\r\n        \"number_of_shards\" : \"5\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"DiWcjcg6SCmcjhk6-THSsA\",\r\n        \"version\" : {\r\n          \"created\" : \"6080299\"\r\n        },\r\n        \"provided_name\" : \"watcher_alarms-2019.11.06\"\r\n      }\r\n    }\r\n  },\r\n  \"web-service-webhose-news-invocations\" : {\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"creation_date\" : \"1573043556625\",\r\n        \"number_of_shards\" : \"5\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"jYRQdliyStCOIUgyiccJoQ\",\r\n        \"version\" : {\r\n          \"created\" : \"6080299\"\r\n        },\r\n        \"provided_name\" : \"web-service-webhose-news-invocations\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553910504","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553910504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553910504,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MzkxMDUwNA==","user":{"login":"akhileshbhatia","id":10994002,"node_id":"MDQ6VXNlcjEwOTk0MDAy","avatar_url":"https://avatars0.githubusercontent.com/u/10994002?v=4","gravatar_id":"","url":"https://api.github.com/users/akhileshbhatia","html_url":"https://github.com/akhileshbhatia","followers_url":"https://api.github.com/users/akhileshbhatia/followers","following_url":"https://api.github.com/users/akhileshbhatia/following{/other_user}","gists_url":"https://api.github.com/users/akhileshbhatia/gists{/gist_id}","starred_url":"https://api.github.com/users/akhileshbhatia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhileshbhatia/subscriptions","organizations_url":"https://api.github.com/users/akhileshbhatia/orgs","repos_url":"https://api.github.com/users/akhileshbhatia/repos","events_url":"https://api.github.com/users/akhileshbhatia/events{/privacy}","received_events_url":"https://api.github.com/users/akhileshbhatia/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T14:25:24Z","updated_at":"2019-11-14T14:32:52Z","author_association":"NONE","body":"And here is the log file [elasticsearch.log](https://github.com/elastic/elasticsearch/files/3846942/elasticsearch.log)\r\n\r\nand just to reiterate, the complete data folder is uploaded [here](https://drive.google.com/drive/folders/1R_IFv-c0SqMYpZDUNHY22zQ34J2cBbbj?usp=sharing).\r\n\r\nAn additional point => we have tested this on multiple hardware as well but have got the same results","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553932096","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553932096","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553932096,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MzkzMjA5Ng==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T15:14:51Z","updated_at":"2019-11-14T15:14:51Z","author_association":"MEMBER","body":"Thanks, from the logs, the exception seems to come from a call the SamplerAggregator makes:\r\n```\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\r\n        at org.elasticsearch.common.util.BigArrays$ObjectArrayWrapper.get(BigArrays.java:345) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.aggregations.bucket.sampler.BestDocsDeferringCollector.getDocCount(BestDocsDeferringCollector.java:286) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.aggregations.bucket.sampler.SamplerAggregator.buildAggregation(SamplerAggregator.java:170) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.aggregations.bucket.BucketsAggregator.bucketAggregations(BucketsAggregator.java:141) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.aggregations.bucket.filter.FiltersAggregator.buildAggregation(FiltersAggregator.java:174) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:130) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:120) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesService.lambda$loadIntoContext$17(IndicesService.java:1253) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesService.lambda$cacheShardLevelResult$18(IndicesService.java:1309) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:164) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:147) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:433) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesRequestCache.getOrCompute(IndicesRequestCache.java:119) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesService.cacheShardLevelResult(IndicesService.java:1315) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.indices.IndicesService.loadIntoContext(IndicesService.java:1251) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:348) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:394) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService.access$100(SearchService.java:126) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:359) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:355) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.search.SearchService$4.doRun(SearchService.java:1107) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_151]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_151]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n```\r\nLets see if this gives us a better idea about whats wrong.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/553932174","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-553932174","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":553932174,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MzkzMjE3NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T15:15:03Z","updated_at":"2019-11-14T15:15:03Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo (:Analytics/Aggregations)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/554040967","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-554040967","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":554040967,"node_id":"MDEyOklzc3VlQ29tbWVudDU1NDA0MDk2Nw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-11-14T19:25:50Z","updated_at":"2019-11-14T19:25:50Z","author_association":"MEMBER","body":"Thanks for grabbing that exception @cbuescher, and thanks @akhileshbhatia for the detailed debug info! On quick skim, it seems that sampler might not be playing nice with deferred execution.  \r\n\r\nOn the road at the moment so haven't looked closely, but definitely think this is a bug somewhere.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/580322440","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-580322440","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":580322440,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MDMyMjQ0MA==","user":{"login":"akhileshbhatia","id":10994002,"node_id":"MDQ6VXNlcjEwOTk0MDAy","avatar_url":"https://avatars0.githubusercontent.com/u/10994002?v=4","gravatar_id":"","url":"https://api.github.com/users/akhileshbhatia","html_url":"https://github.com/akhileshbhatia","followers_url":"https://api.github.com/users/akhileshbhatia/followers","following_url":"https://api.github.com/users/akhileshbhatia/following{/other_user}","gists_url":"https://api.github.com/users/akhileshbhatia/gists{/gist_id}","starred_url":"https://api.github.com/users/akhileshbhatia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akhileshbhatia/subscriptions","organizations_url":"https://api.github.com/users/akhileshbhatia/orgs","repos_url":"https://api.github.com/users/akhileshbhatia/repos","events_url":"https://api.github.com/users/akhileshbhatia/events{/privacy}","received_events_url":"https://api.github.com/users/akhileshbhatia/received_events","type":"User","site_admin":false},"created_at":"2020-01-30T16:01:12Z","updated_at":"2020-01-30T16:01:12Z","author_association":"NONE","body":"Hey guys, is there any update about this issue? Is anything going on related to it?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/581362789","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-581362789","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":581362789,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTM2Mjc4OQ==","user":{"login":"JackRyanson","id":21208059,"node_id":"MDQ6VXNlcjIxMjA4MDU5","avatar_url":"https://avatars1.githubusercontent.com/u/21208059?v=4","gravatar_id":"","url":"https://api.github.com/users/JackRyanson","html_url":"https://github.com/JackRyanson","followers_url":"https://api.github.com/users/JackRyanson/followers","following_url":"https://api.github.com/users/JackRyanson/following{/other_user}","gists_url":"https://api.github.com/users/JackRyanson/gists{/gist_id}","starred_url":"https://api.github.com/users/JackRyanson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JackRyanson/subscriptions","organizations_url":"https://api.github.com/users/JackRyanson/orgs","repos_url":"https://api.github.com/users/JackRyanson/repos","events_url":"https://api.github.com/users/JackRyanson/events{/privacy}","received_events_url":"https://api.github.com/users/JackRyanson/received_events","type":"User","site_admin":false},"created_at":"2020-02-03T11:15:50Z","updated_at":"2020-02-03T11:15:50Z","author_association":"NONE","body":"@polyfractal @cbuescher glad i found this, we're experiencing exactly the same issue i believe. Is this any ETA to have this addressed? thanks all.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/581463250","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-581463250","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":581463250,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTQ2MzI1MA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-02-03T15:17:01Z","updated_at":"2020-02-03T15:17:01Z","author_association":"MEMBER","body":"@akhileshbhatia @JackRyanson I don't believe anyone has looked into this particular bug yet, so a fix timeline is still unknown.  This ticket will be updated when there is progress.\r\n\r\n@JackRyanson would you be able to paste the query/aggregation that you're using which is triggering the bug?  It might be helpful if we can see a commonality with @akhileshbhatia's query (e.g. does yours also have a filter agg? Span queries?  Terms agg? etc).  Also, may I ask what version you're on?\r\n\r\nDoes this reproduce if you use a simpler query in the `filter` agg?  The span queries are particularly complicated, so I'm wondering if it's a general problem with `sampler + filter`, or `sampler + filter + span`.  \r\n\r\nMight be hard to disentangle since this looks like the bug is triggering due to deferred execution, which means the docs being collected will probably affect the bug triggering.\r\n\r\nLastly, would you mind re-running with the sampler agg's `execution_mode` set to each of these and see if one of them works or breaks?\r\n\r\n- `\"execution_hint\": \"map\"`\r\n- `\"execution_hint\": \"bytes_hash\"`\r\n- `\"execution_hint\": \"global_ordinals\"`\r\n\r\nNote: map/bytes_hash will be more expensive than the default (global ords), so make sure your cluster is healthy / has some memory before testing :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/581898339","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-581898339","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":581898339,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTg5ODMzOQ==","user":{"login":"daniele-pini","id":16387428,"node_id":"MDQ6VXNlcjE2Mzg3NDI4","avatar_url":"https://avatars3.githubusercontent.com/u/16387428?v=4","gravatar_id":"","url":"https://api.github.com/users/daniele-pini","html_url":"https://github.com/daniele-pini","followers_url":"https://api.github.com/users/daniele-pini/followers","following_url":"https://api.github.com/users/daniele-pini/following{/other_user}","gists_url":"https://api.github.com/users/daniele-pini/gists{/gist_id}","starred_url":"https://api.github.com/users/daniele-pini/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daniele-pini/subscriptions","organizations_url":"https://api.github.com/users/daniele-pini/orgs","repos_url":"https://api.github.com/users/daniele-pini/repos","events_url":"https://api.github.com/users/daniele-pini/events{/privacy}","received_events_url":"https://api.github.com/users/daniele-pini/received_events","type":"User","site_admin":false},"created_at":"2020-02-04T12:59:16Z","updated_at":"2020-02-04T12:59:16Z","author_association":"NONE","body":"Hi all, I've been investigating the issue with @akhileshbhatia, looking for temporary workarounds.\r\n\r\nThe `execution_hint` just doesn't apply here, since the reported query uses a `sampler` aggregation, while the `execution_hint` seems to apply only for `diversified_sampler` aggregations.\r\n\r\nApart from that, I have noticed that the problem _seems_ to disappear (in all cases I tested) if I happen to add a dummy 1-bucket `terms` aggregation right before the `sampler` one, like this:\r\n```\r\n\"aggs\": {\r\n  \"dummy_terms_wrapper\": {\r\n    \"terms\": {\r\n      \"field\": \"__not_present__\",\r\n      \"missing\": \"\"\r\n    },\r\n    \"aggs\": {\r\n      \"sampler\": {\r\n        \"sampler\" ...\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nthere's a small performance hit in adding this layer, but it seems to solve the problem in our cases.\r\n\r\nNo real idea if this actually works in ALL cases, or why though - so take this 'workaround' with a grain of salt.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/582122711","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-582122711","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":582122711,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MjEyMjcxMQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-02-04T21:25:59Z","updated_at":"2020-02-04T21:25:59Z","author_association":"MEMBER","body":"Ah apologies, you're right regarding `execution_hint`.  The settings are defined in the sampler aggregator code, but only used in the diversified-sampler parser which I didn't notice.\r\n\r\nUnsure why that workaround currently works.  If it's related to deferred execution it might make sense, as multi-bucket aggs like terms aggs do some things internally (wrapping other aggs to reset ordinals) and only having a single term means only one bucket ordinal...which might fix the bug inadvertently.  A single filter agg might have a similar effect.\r\n\r\nI see from the first post's log that this is a 6.8.2 cluster?  Could you try testing 6.8.3+ with the same data?  There was a [bugfix in 6.8.3+ that affects `sampler`](https://github.com/elastic/elasticsearch/pull/44963) (among other aggs).  Early termination was not handled correctly, and could lead to incorrect results.  The symptoms in the original bugfix ticket are different, but I could see it potentially causing array OOB issues too.  Or maybe not :)\r\n\r\nI'm downloading the data from the OP and will see if I can recreate the issue locally.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/582303263","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-582303263","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":582303263,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MjMwMzI2Mw==","user":{"login":"daniele-pini","id":16387428,"node_id":"MDQ6VXNlcjE2Mzg3NDI4","avatar_url":"https://avatars3.githubusercontent.com/u/16387428?v=4","gravatar_id":"","url":"https://api.github.com/users/daniele-pini","html_url":"https://github.com/daniele-pini","followers_url":"https://api.github.com/users/daniele-pini/followers","following_url":"https://api.github.com/users/daniele-pini/following{/other_user}","gists_url":"https://api.github.com/users/daniele-pini/gists{/gist_id}","starred_url":"https://api.github.com/users/daniele-pini/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daniele-pini/subscriptions","organizations_url":"https://api.github.com/users/daniele-pini/orgs","repos_url":"https://api.github.com/users/daniele-pini/repos","events_url":"https://api.github.com/users/daniele-pini/events{/privacy}","received_events_url":"https://api.github.com/users/daniele-pini/received_events","type":"User","site_admin":false},"created_at":"2020-02-05T08:50:44Z","updated_at":"2020-02-05T08:50:44Z","author_association":"NONE","body":"Thanks for the explanation, @polyfractal.\r\n\r\n> Could you try testing 6.8.3+ with the same data?\r\n\r\nI just tried with a fresh 6.8.5, but unfortunately I can still reproduce the problem the OP reported.\r\nThe upgrade didn't help.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/582437297","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-582437297","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":582437297,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MjQzNzI5Nw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-02-05T14:36:32Z","updated_at":"2020-02-05T14:36:32Z","author_association":"MEMBER","body":"Good to know, thanks for checking @daniele-pini \r\n\r\nI'll see if I can reproduce locally and drop some debug breakpoints to figure out what's going on :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/583887808","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-583887808","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":583887808,"node_id":"MDEyOklzc3VlQ29tbWVudDU4Mzg4NzgwOA==","user":{"login":"fabiocorneti","id":32792,"node_id":"MDQ6VXNlcjMyNzky","avatar_url":"https://avatars0.githubusercontent.com/u/32792?v=4","gravatar_id":"","url":"https://api.github.com/users/fabiocorneti","html_url":"https://github.com/fabiocorneti","followers_url":"https://api.github.com/users/fabiocorneti/followers","following_url":"https://api.github.com/users/fabiocorneti/following{/other_user}","gists_url":"https://api.github.com/users/fabiocorneti/gists{/gist_id}","starred_url":"https://api.github.com/users/fabiocorneti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabiocorneti/subscriptions","organizations_url":"https://api.github.com/users/fabiocorneti/orgs","repos_url":"https://api.github.com/users/fabiocorneti/repos","events_url":"https://api.github.com/users/fabiocorneti/events{/privacy}","received_events_url":"https://api.github.com/users/fabiocorneti/received_events","type":"User","site_admin":false},"created_at":"2020-02-09T20:12:34Z","updated_at":"2020-02-09T20:12:34Z","author_association":"CONTRIBUTOR","body":"@polyfractal could the issue be that, if there are no documents to collect from the first bucket, `perBucketSamples` will not be grown at https://github.com/elastic/elasticsearch/blob/e82818a3613766c5221d9e7c3bb88f1d536083da/server/src/main/java/org/elasticsearch/search/aggregations/bucket/sampler/BestDocsDeferringCollector.java#L295-L297 , causing the out of bounds at https://github.com/elastic/elasticsearch/blob/e82818a3613766c5221d9e7c3bb88f1d536083da/server/src/main/java/org/elasticsearch/search/aggregations/bucket/sampler/BestDocsDeferringCollector.java#L308-L314 ?\r\n\r\n---\r\n\r\nCan be reproduced more easily with the following script on Elasticsearch 6.8.6:\r\n\r\n```bash\r\ncurl -H \"Content-Type: application/json\" -XDELETE http://localhost:9200/foo\r\ncurl -H \"Content-Type: application/json\" -XDELETE http://localhost:9200/bar\r\n\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/foo -d '{\r\n  \"settings\" : {\r\n    \"index\" : {\r\n      \"number_of_shards\" : 1,\r\n      \"number_of_replicas\" : 0\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"description\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/bar -d '{\r\n  \"settings\" : {\r\n    \"index\" : {\r\n      \"number_of_shards\" : 1,\r\n      \"number_of_replicas\" : 0\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"description\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\ncurl -H \"Content-Type: application/x-ndjson\" -XPOST http://localhost:9200/_bulk -d '\r\n{ \"index\" : { \"_index\" : \"foo\", \"_type\": \"_doc\", \"_id\" : \"1\" } }\r\n{ \"description\" : \"table\" }\r\n{ \"index\" : { \"_index\" : \"bar\", \"_type\": \"_doc\", \"_id\" : \"1\" } }\r\n{ \"description\" : \"table\" }\r\n{ \"index\" : { \"_index\" : \"foo\", \"_type\": \"_doc\", \"_id\" : \"2\" } }\r\n{ \"description\" : \"sofa\" }\r\n{ \"index\" : { \"_index\" : \"bar\", \"_type\": \"_doc\", \"_id\" : \"2\" } }\r\n{ \"description\" : \"rock\" }\r\n'\r\n\r\ncurl -XPOST 'http://localhost:9200/foo,bar/_refresh'\r\n\r\necho\r\necho\r\necho \"====== SEARCH =======\"\r\necho\r\necho\r\n\r\ncurl -H'content-type:application/json' 'http://localhost:9200/foo,bar/_search?error_trace=true&pretty' -d '\r\n{\r\n  \"aggs\": {\r\n    \"topicFilters\": {\r\n      \"filters\": {\r\n        \"filters\": [{\r\n          \"term\": {\r\n            \"description\": \"table\"\r\n          }\r\n        }, {\r\n          \"term\": {\r\n            \"description\": \"cat\"\r\n          }\r\n        }]\r\n      },\r\n      \"aggs\": {\r\n        \"sampler\": {\r\n          \"sampler\": {\r\n            \"shard_size\": 1000\r\n          },\r\n          \"aggs\": {\r\n            \"subtopics\": {\r\n              \"terms\": {\r\n                \"field\": \"description\",\r\n                \"size\": 48,\r\n                \"include\": [\"sofa\", \"table\", \"rock\"]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"size\": 1\r\n}'\r\n```\r\n\r\n---\r\n\r\nThis appears to be the same bug: https://github.com/elastic/elasticsearch/issues/19891 .","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/587531617","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-587531617","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":587531617,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NzUzMTYxNw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-02-18T15:54:46Z","updated_at":"2020-02-18T15:54:46Z","author_association":"MEMBER","body":"@fabiocorneti I think that might be it, good work!  I still haven't had a chance to look closely (keep getting pulled away into other things), but that certainly looks like it could blow up if no buckets are collected, or if the tail end of the buckets are not collected by the sampler agg.\r\n\r\nA simple\r\n```\r\nif (perBucketSamples.size() <= parentBucket) {\r\n    return 0;\r\n}\r\n```\r\n\r\nI think would safeguard against that?  Or something similar anyhow.  Want to open a PR to fix?  If not I'll see if someone on the analytics team has time to work up a fix and a test.\r\n\r\nCheers!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/594784954","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-594784954","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":594784954,"node_id":"MDEyOklzc3VlQ29tbWVudDU5NDc4NDk1NA==","user":{"login":"fabiocorneti","id":32792,"node_id":"MDQ6VXNlcjMyNzky","avatar_url":"https://avatars0.githubusercontent.com/u/32792?v=4","gravatar_id":"","url":"https://api.github.com/users/fabiocorneti","html_url":"https://github.com/fabiocorneti","followers_url":"https://api.github.com/users/fabiocorneti/followers","following_url":"https://api.github.com/users/fabiocorneti/following{/other_user}","gists_url":"https://api.github.com/users/fabiocorneti/gists{/gist_id}","starred_url":"https://api.github.com/users/fabiocorneti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabiocorneti/subscriptions","organizations_url":"https://api.github.com/users/fabiocorneti/orgs","repos_url":"https://api.github.com/users/fabiocorneti/repos","events_url":"https://api.github.com/users/fabiocorneti/events{/privacy}","received_events_url":"https://api.github.com/users/fabiocorneti/received_events","type":"User","site_admin":false},"created_at":"2020-03-04T19:39:19Z","updated_at":"2020-03-04T19:39:19Z","author_association":"CONTRIBUTOR","body":"@polyfractal apologies, missed the notification, I'll open a PR tomorrow.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/656583767","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-656583767","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":656583767,"node_id":"MDEyOklzc3VlQ29tbWVudDY1NjU4Mzc2Nw==","user":{"login":"immavalls","id":4788634,"node_id":"MDQ6VXNlcjQ3ODg2MzQ=","avatar_url":"https://avatars1.githubusercontent.com/u/4788634?v=4","gravatar_id":"","url":"https://api.github.com/users/immavalls","html_url":"https://github.com/immavalls","followers_url":"https://api.github.com/users/immavalls/followers","following_url":"https://api.github.com/users/immavalls/following{/other_user}","gists_url":"https://api.github.com/users/immavalls/gists{/gist_id}","starred_url":"https://api.github.com/users/immavalls/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/immavalls/subscriptions","organizations_url":"https://api.github.com/users/immavalls/orgs","repos_url":"https://api.github.com/users/immavalls/repos","events_url":"https://api.github.com/users/immavalls/events{/privacy}","received_events_url":"https://api.github.com/users/immavalls/received_events","type":"User","site_admin":false},"created_at":"2020-07-10T09:34:11Z","updated_at":"2020-07-10T09:34:11Z","author_association":"NONE","body":"@polyfractal @DaveCTurner Can we resume work on this on our side? @fabiocorneti was not able to open the PR. Thanks!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/656740387","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-656740387","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":656740387,"node_id":"MDEyOklzc3VlQ29tbWVudDY1Njc0MDM4Nw==","user":{"login":"fabiocorneti","id":32792,"node_id":"MDQ6VXNlcjMyNzky","avatar_url":"https://avatars0.githubusercontent.com/u/32792?v=4","gravatar_id":"","url":"https://api.github.com/users/fabiocorneti","html_url":"https://github.com/fabiocorneti","followers_url":"https://api.github.com/users/fabiocorneti/followers","following_url":"https://api.github.com/users/fabiocorneti/following{/other_user}","gists_url":"https://api.github.com/users/fabiocorneti/gists{/gist_id}","starred_url":"https://api.github.com/users/fabiocorneti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabiocorneti/subscriptions","organizations_url":"https://api.github.com/users/fabiocorneti/orgs","repos_url":"https://api.github.com/users/fabiocorneti/repos","events_url":"https://api.github.com/users/fabiocorneti/events{/privacy}","received_events_url":"https://api.github.com/users/fabiocorneti/received_events","type":"User","site_admin":false},"created_at":"2020-07-10T15:38:10Z","updated_at":"2020-07-10T15:38:10Z","author_association":"CONTRIBUTOR","body":"Hi there, sorry for the delay, I opened PR #59360  with a test case for this issue and the check.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/694524156","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-694524156","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":694524156,"node_id":"MDEyOklzc3VlQ29tbWVudDY5NDUyNDE1Ng==","user":{"login":"yogevyuval","id":962869,"node_id":"MDQ6VXNlcjk2Mjg2OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/962869?v=4","gravatar_id":"","url":"https://api.github.com/users/yogevyuval","html_url":"https://github.com/yogevyuval","followers_url":"https://api.github.com/users/yogevyuval/followers","following_url":"https://api.github.com/users/yogevyuval/following{/other_user}","gists_url":"https://api.github.com/users/yogevyuval/gists{/gist_id}","starred_url":"https://api.github.com/users/yogevyuval/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yogevyuval/subscriptions","organizations_url":"https://api.github.com/users/yogevyuval/orgs","repos_url":"https://api.github.com/users/yogevyuval/repos","events_url":"https://api.github.com/users/yogevyuval/events{/privacy}","received_events_url":"https://api.github.com/users/yogevyuval/received_events","type":"User","site_admin":false},"created_at":"2020-09-17T22:05:58Z","updated_at":"2020-09-17T22:05:58Z","author_association":"NONE","body":"Hi @fabiocorneti @immavalls @polyfractal  , I know this is already closed but I just encountered something very similar while testing ES 7.9.1\r\nCan you please take a look and tell me if this is related?\r\nThis happens on the following query when min_doc_count is 0.\r\nThe error is: Index -1 out of bounds for length 1\r\n\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match_all\": {}\r\n        }\r\n      ],\r\n      \"filter\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"2016-08-22T15:39:52+00:00\",\r\n              \"lte\": \"2016-08-24T14:37:05+00:00\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"1d93e6\": {\r\n      \"terms\": {\r\n        \"field\": \"srccountry.keyword_lower\",\r\n        \"size\": 10,\r\n        \"min_doc_count\": 0,\r\n        \"missing\": \"N/A\",\r\n        \"show_term_doc_count_error\": true\r\n      },\r\n      \"meta\": {\r\n        \"as_\": \"terms(srccountry)\",\r\n        \"field_name\": \"srccountry\",\r\n        \"func_name\": \"terms\",\r\n        \"type\": \"text\"\r\n      },\r\n      \"aggs\": {\r\n        \"f28e02\": {\r\n          \"sum\": {\r\n            \"script\": {\r\n              \"source\": \"1\",\r\n              \"lang\": \"expression\"\r\n            }\r\n          },\r\n          \"meta\": {\r\n            \"as_\": \"count() by srccountry\",\r\n            \"field_name\": \"\",\r\n            \"func_name\": \"count\",\r\n            \"type\": \"long\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"sort\": [\r\n    {\r\n      \"@timestamp\": {\r\n        \"order\": \"desc\",\r\n        \"unmapped_type\": \"date\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nStack trace\r\n\r\n\r\n```\r\n\r\nat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:551) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:309) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:582) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onShardFailure(AbstractSearchAsyncAction.java:393) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.access$100(AbstractSearchAsyncAction.java:68) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction$1.onFailure(AbstractSearchAsyncAction.java:245) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:59) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:403) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TransportService$6.handleException(TransportService.java:638) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1172) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1281) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1255) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:61) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.transport.TransportChannel.sendErrorResponse(TransportChannel.java:56) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.support.ChannelActionListener.onFailure(ChannelActionListener.java:51) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService.lambda$runAsync$0(SearchService.java:414) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:710) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.9.1.jar:7.9.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:832) [?:?]\r\nCaused by: org.elasticsearch.ElasticsearchException$1: Index -1 out of bounds for length 1\r\n\tat org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:644) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:307) [elasticsearch-7.9.1.jar:7.9.1]\r\n\t... 21 more\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: Index -1 out of bounds for length 1\r\n\tat org.elasticsearch.common.util.BigArrays$DoubleArrayWrapper.get(BigArrays.java:257) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.metrics.SumAggregator.buildAggregation(SumAggregator.java:117) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.metrics.MetricsAggregator.buildAggregations(MetricsAggregator.java:51) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.buildSubAggsForBuckets(BucketsAggregator.java:173) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.buildSubAggsForAllBuckets(BucketsAggregator.java:236) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.access$700(GlobalOrdinalsStringTermsAggregator.java:65) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$StandardTermsResults.buildSubAggs(GlobalOrdinalsStringTermsAggregator.java:720) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$StandardTermsResults.buildSubAggs(GlobalOrdinalsStringTermsAggregator.java:670) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$ResultStrategy.buildAggregations(GlobalOrdinalsStringTermsAggregator.java:586) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator$ResultStrategy.access$200(GlobalOrdinalsStringTermsAggregator.java:535) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.buildAggregations(GlobalOrdinalsStringTermsAggregator.java:193) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.Aggregator.buildTopLevel(Aggregator.java:160) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:128) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:156) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:362) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:435) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService.access$200(SearchService.java:136) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService$2.lambda$onResponse$0(SearchService.java:396) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n\tat org.elasticsearch.search.SearchService.lambda$runAsync$0(SearchService.java:412) ~[elasticsearch-7.9.1.jar:7.9.1]\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/694545755","html_url":"https://github.com/elastic/elasticsearch/issues/49072#issuecomment-694545755","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49072","id":694545755,"node_id":"MDEyOklzc3VlQ29tbWVudDY5NDU0NTc1NQ==","user":{"login":"fabiocorneti","id":32792,"node_id":"MDQ6VXNlcjMyNzky","avatar_url":"https://avatars0.githubusercontent.com/u/32792?v=4","gravatar_id":"","url":"https://api.github.com/users/fabiocorneti","html_url":"https://github.com/fabiocorneti","followers_url":"https://api.github.com/users/fabiocorneti/followers","following_url":"https://api.github.com/users/fabiocorneti/following{/other_user}","gists_url":"https://api.github.com/users/fabiocorneti/gists{/gist_id}","starred_url":"https://api.github.com/users/fabiocorneti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabiocorneti/subscriptions","organizations_url":"https://api.github.com/users/fabiocorneti/orgs","repos_url":"https://api.github.com/users/fabiocorneti/repos","events_url":"https://api.github.com/users/fabiocorneti/events{/privacy}","received_events_url":"https://api.github.com/users/fabiocorneti/received_events","type":"User","site_admin":false},"created_at":"2020-09-17T23:04:27Z","updated_at":"2020-09-17T23:04:27Z","author_association":"CONTRIBUTOR","body":"@yogevyuval I think the problem you hit is https://github.com/elastic/elasticsearch/issues/62084 , fixed in https://github.com/elastic/elasticsearch/pull/62130 .","performed_via_github_app":null}]