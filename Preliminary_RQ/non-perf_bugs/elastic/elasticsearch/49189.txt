{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49189","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49189/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49189/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49189/events","html_url":"https://github.com/elastic/elasticsearch/issues/49189","id":523598225,"node_id":"MDU6SXNzdWU1MjM1OTgyMjU=","number":49189,"title":"[Docs] Problems with using geocentroid for multi-valued geo_points","user":{"login":"EmilBode","id":22800383,"node_id":"MDQ6VXNlcjIyODAwMzgz","avatar_url":"https://avatars2.githubusercontent.com/u/22800383?v=4","gravatar_id":"","url":"https://api.github.com/users/EmilBode","html_url":"https://github.com/EmilBode","followers_url":"https://api.github.com/users/EmilBode/followers","following_url":"https://api.github.com/users/EmilBode/following{/other_user}","gists_url":"https://api.github.com/users/EmilBode/gists{/gist_id}","starred_url":"https://api.github.com/users/EmilBode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EmilBode/subscriptions","organizations_url":"https://api.github.com/users/EmilBode/orgs","repos_url":"https://api.github.com/users/EmilBode/repos","events_url":"https://api.github.com/users/EmilBode/events{/privacy}","received_events_url":"https://api.github.com/users/EmilBode/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"assignees":[{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-11-15T17:31:51Z","updated_at":"2020-01-06T13:45:50Z","closed_at":"2020-01-06T13:45:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the feature**:\r\nSome elastic behaviour bit me, I think a warning in the documentation would be fair:\r\n\r\nWhen making a geohash, elastic aggregates different *documents* into buckets, not the individual `geo_points`\r\nThis means that a bucket can contain a document with points both inside and outside this bucket. Now when calculating the gecentroid, all points are considered, also those outside of the bucket boundary.\r\n\r\nConsider this example:\r\n```\r\nPUT temp\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"places\": {\r\n        \"type\": \"geo_point\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT temp/_doc/1\r\n{\r\n  \"places\": [\r\n    [0,0],\r\n    [90,0]\r\n    ]\r\n}\r\n\r\nGET temp/_search\r\n{\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"geohash_grid\": {\r\n        \"field\": \"places\",\r\n        \"precision\": 2\r\n      },\r\n      \"aggs\": {\r\n        \"3\": {\r\n          \"geo_centroid\": {\r\n            \"field\": \"places\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nThe result gives us 2 buckets, both with the same geo_centroid at longitude 45.\r\n\r\nThe same happens when making a coordinate map in Kibana, although luckily Kibana is smart enough to not allow the point to be drawn outside of the box. However, it's clearly visible that our (0,0) point is drawn eastwards and our (0, 90) points dragged westwards.\r\n\r\nA workaround could be to make the geo_points nested documents, and use a nested aggregation, but that doesn't work with Kibana.\r\n\r\nThe very best solution would obviously be to have the geo_centroid only consider those point that are actually inside the bucket, but I don't think that's feasible.\r\n\r\nBut for now, I think the documentation about this could be clearer.\r\nMy suggestion: We could add a warning on https://www.elastic.co/guide/en/elasticsearch/reference/7.4/search-aggregations-metrics-geocentroid-aggregation.html (and the pages for other version), like this:\r\n\r\nWarning: When you have multi-valued geo_point-fields, geo_centroid calculates the centroid of all those fields in selected documents. This means that using a geo_centroid in a geohash-aggregation can cause the centroid to be (far) out of the boundaries of your bucket\r\n\r\n**Elasticsearch version**: 7.3.1\r\n\r\n**JVM version**: 1.8.0_231\r\n\r\n**OS version**: Windows 10\r\n\r\nI've also filed an issue at Kibana, https://github.com/elastic/kibana/issues/50799","closed_by":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"performed_via_github_app":null}