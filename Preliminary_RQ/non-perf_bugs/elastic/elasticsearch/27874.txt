{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27874","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27874/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27874/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27874/events","html_url":"https://github.com/elastic/elasticsearch/issues/27874","id":282996381,"node_id":"MDU6SXNzdWUyODI5OTYzODE=","number":27874,"title":"bug: logging via log4j2 JsonLayout fails with log4j security error","user":{"login":"cdaringe","id":1003261,"node_id":"MDQ6VXNlcjEwMDMyNjE=","avatar_url":"https://avatars0.githubusercontent.com/u/1003261?v=4","gravatar_id":"","url":"https://api.github.com/users/cdaringe","html_url":"https://github.com/cdaringe","followers_url":"https://api.github.com/users/cdaringe/followers","following_url":"https://api.github.com/users/cdaringe/following{/other_user}","gists_url":"https://api.github.com/users/cdaringe/gists{/gist_id}","starred_url":"https://api.github.com/users/cdaringe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdaringe/subscriptions","organizations_url":"https://api.github.com/users/cdaringe/orgs","repos_url":"https://api.github.com/users/cdaringe/repos","events_url":"https://api.github.com/users/cdaringe/events{/privacy}","received_events_url":"https://api.github.com/users/cdaringe/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2017-12-18T19:38:32Z","updated_at":"2017-12-19T20:32:32Z","closed_at":"2017-12-18T19:46:31Z","author_association":"NONE","active_lock_reason":null,"body":"# problem statement\r\n\r\n- configuring ES to log via JSON fails with security exception\r\n\r\n# context\r\n\r\n- i want my ES docker image to log JSON lines to stdout\r\n- i have configured the image with a config file, and associated log4j2 jars\r\n- on run, log4j2 complains about a security exception\r\n  - i have also set ownership of the config file and jars to match those existing in the image.  more below\r\n\r\n----\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n6.1.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nwhatever ships in docker 6.1.0, 1.8.0_151\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\ncentos, see docker image\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nconfiguring the ES image for JSON logging results in log4j2 complaining about a security expeption and exiting.  #20304 & #20805 addressed what i thought was the same issue, yet the issue persists.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. setup a log4j2 config file (example provided below)\r\n1. grab the associated jackson jars that log4j2 needs for json logging (i won't provide these, they are fetchable from jcenter.  they are used clearly in the cmd below)\r\n1. run the image\r\n\r\n```sh\r\ndocker run -it \\\r\n  -v `pwd`/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties \\\r\n  -v `pwd`/jackson-databind-2.8.10.jar:/usr/share/elasticsearch/lib/jackson-databind-2.8.10.jar \\\r\n  -v `pwd`/jackson-annotations-2.8.10.jar:/usr/share/elasticsearch/lib/jackson-annotations-2.8.10.jar \\\r\n  docker.elastic.co/elasticsearch/elasticsearch-oss:6.1.0\r\n```\r\n\r\n```properties\r\n# log4j2.properties\r\nstatus = error\r\ndest = err\r\nname = PropertiesConfig\r\n\r\nappender.console.type = Console\r\nappender.console.name = STDOUT\r\nappender.console.layout.type = JsonLayout\r\nappender.console.layout.compact= true\r\nappender.console.layout.eventEol= true\r\nappender.console.layout.locationInfo= true\r\nappender.console.layout.stacktraceAsString= true\r\n\r\nrootLogger.level = info\r\nrootLogger.appenderRef.stdout.ref = STDOUT\r\n````\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\nðŸ›°  $ docker run -it \\\r\n  -v `pwd`/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties \\\r\n  -v `pwd`/jackson-databind-2.8.10.jar:/usr/share/elasticsearch/lib/jackson-databind-2.8.10.jar \\\r\n  -v `pwd`/jackson-annotations-2.8.10.jar:/usr/share/elasticsearch/lib/jackson-annotations-2.8.10.jar \\\r\n  docker.elastic.co/elasticsearch/elasticsearch-oss:6.1.0\r\n\r\n2017-12-18 19:23:20,723 main ERROR An exception occurred processing Appender STDOUT java.security.AccessControlException: access denied (\"java.lang.RuntimeP\r\nermission\" \"accessDeclaredMembers\")\r\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)        at java.security.AccessController.checkPermission(AccessController.java:884)\r\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\r\n        at java.lang.Class.checkMemberAccess(Class.java:2348)\r\n        at java.lang.Class.getDeclaredMethods(Class.java:1974)\r\n        at com.fasterxml.jackson.databind.util.ClassUtil.getDeclaredMethods(ClassUtil.java:944)\r\n        at com.fasterxml.jackson.databind.introspect.AnnotatedClass._findClassMethods(AnnotatedClass.java:1196)\r\n        at com.fasterxml.jackson.databind.introspect.AnnotatedClass._addMemberMethods(AnnotatedClass.java:741)\r\n        at com.fasterxml.jackson.databind.introspect.AnnotatedClass._resolveMemberMethods(AnnotatedClass.java:554)\r\n        at com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveMemberMethods(AnnotatedClass.java:541)\r\n        at com.fasterxml.jackson.databind.introspect.AnnotatedClass.memberMethods(AnnotatedClass.java:340)\r\n        at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector._addMethods(POJOPropertiesCollector.java:512)\r\n        at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector.collectAll(POJOPropertiesCollector.java:303)\r\n        at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector.getJsonValueMethod(POJOPropertiesCollector.java:173)\r\n        at com.fasterxml.jackson.databind.introspect.BasicBeanDescription.findJsonValueMethod(BasicBeanDescription.java:224)\r\n        at com.fasterxml.jackson.databind.ser.BasicSerializerFactory.findSerializerByAnnotations(BasicSerializerFactory.java:350)\r\n        at com.fasterxml.jackson.databind.ser.BeanSerializerFactory._createSerializer2(BeanSerializerFactory.java:219)\r\n        at com.fasterxml.jackson.databind.ser.BeanSerializerFactory.createSerializer(BeanSerializerFactory.java:168)\r\n        at com.fasterxml.jackson.databind.SerializerProvider._createUntypedSerializer(SerializerProvider.java:1308)\r\n        at com.fasterxml.jackson.databind.SerializerProvider._createAndCacheUntypedSerializer(SerializerProvider.java:1258)\r\n        at com.fasterxml.jackson.databind.SerializerProvider.findValueSerializer(SerializerProvider.java:500)\r\n        at com.fasterxml.jackson.databind.SerializerProvider.findTypedValueSerializer(SerializerProvider.java:698)\r\n        at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.java:270)\r\n        at com.fasterxml.jackson.databind.ObjectWriter$Prefetch.serialize(ObjectWriter.java:1429)\r\n        at com.fasterxml.jackson.databind.ObjectWriter._configAndWriteValue(ObjectWriter.java:1158)\r\n        at com.fasterxml.jackson.databind.ObjectWriter.writeValue(ObjectWriter.java:1004)\r\n        at org.apache.logging.log4j.core.layout.AbstractJacksonLayout.toSerializable(AbstractJacksonLayout.java:213)\r\n        at org.apache.logging.log4j.core.layout.JsonLayout.toSerializable(JsonLayout.java:254)\r\n        at org.apache.logging.log4j.core.layout.AbstractJacksonLayout.toSerializable(AbstractJacksonLayout.java:193)\r\n        at org.apache.logging.log4j.core.layout.JsonLayout.toSerializable(JsonLayout.java:60)\r\n        at org.apache.logging.log4j.core.layout.AbstractJacksonLayout.toSerializable(AbstractJacksonLayout.java:34)\r\n        at org.apache.logging.log4j.core.layout.AbstractStringLayout.toByteArray(AbstractStringLayout.java:299)\r\n        at org.apache.logging.log4j.core.layout.AbstractLayout.encode(AbstractLayout.java:210)\r\n        at org.apache.logging.log4j.core.layout.AbstractLayout.encode(AbstractLayout.java:37)\r\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.directEncodeEvent(AbstractOutputStreamAppender.java:177)\r\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.tryAppend(AbstractOutputStreamAppender.java:170)\r\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:161)\r\n        at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:156)\r\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:129)\r\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120)\r\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)\r\n        at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:448)\r\n        at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:433)\r\n        at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:417)\r\n        at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:403)\r\n        at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63)\r\n        at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146)\r\n        at org.apache.logging.log4j.spi.ExtendedLoggerWrapper.logMessage(ExtendedLoggerWrapper.java:217)\r\n        at org.elasticsearch.common.logging.PrefixLogger.logMessage(PrefixLogger.java:102)\r\n        at org.apache.logging.log4j.spi.AbstractLogger.tryLogMessage(AbstractLogger.java:2116)\r\n        at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2100)\r\n        at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:1994)\r\n        at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1966)\r\n        at org.apache.logging.log4j.spi.AbstractLogger.info(AbstractLogger.java:1303)\r\n        at org.elasticsearch.node.Node.<init>(Node.java:254)\r\n        at org.elasticsearch.node.Node.<init>(Node.java:245)\r\n        at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:212)\r\n        at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:212)\r\n        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:322)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:121)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:112)\r\n        at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)\r\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)\r\n        at org.elasticsearch.cli.Command.main(Command.java:90)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:85)\r\n```\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}