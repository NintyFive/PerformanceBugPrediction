{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19249","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19249/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19249/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19249/events","html_url":"https://github.com/elastic/elasticsearch/issues/19249","id":163658960,"node_id":"MDU6SXNzdWUxNjM2NTg5NjA=","number":19249,"title":"Scroll should limit size= value, as the search API already does.","user":{"login":"jakommo","id":6436143,"node_id":"MDQ6VXNlcjY0MzYxNDM=","avatar_url":"https://avatars2.githubusercontent.com/u/6436143?v=4","gravatar_id":"","url":"https://api.github.com/users/jakommo","html_url":"https://github.com/jakommo","followers_url":"https://api.github.com/users/jakommo/followers","following_url":"https://api.github.com/users/jakommo/following{/other_user}","gists_url":"https://api.github.com/users/jakommo/gists{/gist_id}","starred_url":"https://api.github.com/users/jakommo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakommo/subscriptions","organizations_url":"https://api.github.com/users/jakommo/orgs","repos_url":"https://api.github.com/users/jakommo/repos","events_url":"https://api.github.com/users/jakommo/events{/privacy}","received_events_url":"https://api.github.com/users/jakommo/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":396750536,"node_id":"MDU6TGFiZWwzOTY3NTA1MzY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha5","name":"v5.0.0-alpha5","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-07-04T11:37:49Z","updated_at":"2018-02-14T13:31:18Z","closed_at":"2016-07-11T20:10:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.1.2 / 2.3.3\n\n**JVM version**: Java 8u91\n\n**OS version**: Ubuntu 16.04\n\n**Description of the problem including expected versus actual behavior**:\nSpecifying a high value for `size=` when using scroll causes OOM.\n\nE.g: running `curl -XGET 'localhost:9200/*/_search?size=99999999'` results in:\n\n```\n{\"error\":{\"root_cause\":[{\"type\":\"query_phase_execution_exception\",\"reason\":\"Result window is too large, from + size must be less than or equal to: [10000] but was [99999999]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level parameter.\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\".triggered_watches\",\"node\":\"qmVwvx_9RDqdn6QG8n8SKQ\",\"reason\":{\"type\":\"query_phase_execution_exception\",\"reason\":\"Result window is too large, from + size must be less than or equal to: [10000] but was [99999999]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level parameter.\"}}]},\"status\":500}\n```\n\nBut when running `curl -XGET 'localhost:9200/*/_search?scroll=8m&size=99999999`, the high value for `size=` is accepted, causing the node running OOM.\n\n**Steps to reproduce**:\n1. Start ES\n2. Run `curl -XGET 'localhost:9200/*/_search?scroll=8m&size=99999999`\n3. Node runs OOM\n\n**Provide logs (if relevant)**:\n\nLogs when calling `_search?scroll=8m&size=99999999`\n\n```\n[2016-07-04 13:34:08,734][INFO ][monitor.jvm              ] [Doctor Glitternight] [gc][young][1107][34] duration [781ms], collections [1]/[1.4s], total [781ms]/[7.7s], memory [440.3mb]->[394.6mb]/[990.7mb], all_pools {[young] [172.7mb]->[1mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [234.3mb]->[360.3mb]/[691.2mb]}\n[2016-07-04 13:36:00,540][WARN ][rest.suppressed          ] /*/_search Params: {pretty=, size=99999999, scroll=8m, index=*}\njava.lang.OutOfMemoryError: Java heap space\n    at org.elasticsearch.cache.recycler.PageCacheRecycler$1.newInstance(PageCacheRecycler.java:102)\n    at org.elasticsearch.cache.recycler.PageCacheRecycler$1.newInstance(PageCacheRecycler.java:99)\n    at org.elasticsearch.common.recycler.DequeRecycler.obtain(DequeRecycler.java:53)\n    at org.elasticsearch.common.recycler.AbstractRecycler.obtain(AbstractRecycler.java:33)\n    at org.elasticsearch.common.recycler.DequeRecycler.obtain(DequeRecycler.java:28)\n    at org.elasticsearch.common.recycler.FilterRecycler.obtain(FilterRecycler.java:39)\n    at org.elasticsearch.common.recycler.Recyclers$3.obtain(Recyclers.java:119)\n    at org.elasticsearch.common.recycler.FilterRecycler.obtain(FilterRecycler.java:39)\n    at org.elasticsearch.cache.recycler.PageCacheRecycler.bytePage(PageCacheRecycler.java:150)\n    at org.elasticsearch.common.util.AbstractBigArray.newBytePage(AbstractBigArray.java:108)\n    at org.elasticsearch.common.util.BigByteArray.resize(BigByteArray.java:140)\n    at org.elasticsearch.common.util.BigArrays.resizeInPlace(BigArrays.java:425)\n    at org.elasticsearch.common.util.BigArrays.resize(BigArrays.java:472)\n    at org.elasticsearch.common.util.BigArrays.grow(BigArrays.java:489)\n    at org.elasticsearch.common.io.stream.BytesStreamOutput.ensureCapacity(BytesStreamOutput.java:160)\n    at org.elasticsearch.common.io.stream.BytesStreamOutput.writeBytes(BytesStreamOutput.java:90)\n    at org.elasticsearch.common.io.stream.StreamOutput.write(StreamOutput.java:299)\n    at com.fasterxml.jackson.core.json.UTF8JsonGenerator._flushBuffer(UTF8JsonGenerator.java:2003)\n    at com.fasterxml.jackson.core.json.UTF8JsonGenerator.writeRaw(UTF8JsonGenerator.java:597)\n    at com.fasterxml.jackson.core.util.DefaultIndenter.writeIndentation(DefaultIndenter.java:94)\n    at com.fasterxml.jackson.core.util.DefaultPrettyPrinter.writeObjectEntrySeparator(DefaultPrettyPrinter.java:307)\n    at com.fasterxml.jackson.core.json.UTF8JsonGenerator._writePPFieldName(UTF8JsonGenerator.java:354)\n    at com.fasterxml.jackson.core.json.UTF8JsonGenerator.writeFieldName(UTF8JsonGenerator.java:181)\n    at com.fasterxml.jackson.core.JsonGenerator.copyCurrentStructure(JsonGenerator.java:1557)\n    at com.fasterxml.jackson.core.JsonGenerator.copyCurrentStructure(JsonGenerator.java:1566)\n    at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.copyCurrentStructure(JsonXContentGenerator.java:425)\n    at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.copyRawValue(JsonXContentGenerator.java:410)\n    at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.writeRawField(JsonXContentGenerator.java:363)\n    at org.elasticsearch.common.xcontent.XContentBuilder.rawField(XContentBuilder.java:914)\n    at org.elasticsearch.common.xcontent.XContentHelper.writeRawField(XContentHelper.java:378)\n    at org.elasticsearch.search.internal.InternalSearchHit.toXContent(InternalSearchHit.java:476)\n    at org.elasticsearch.search.internal.InternalSearchHits.toXContent(InternalSearchHits.java:184)\n```\n\n**Describe the feature**:\n","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}