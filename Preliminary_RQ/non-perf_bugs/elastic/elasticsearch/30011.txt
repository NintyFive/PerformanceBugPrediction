{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30011","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30011/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30011/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30011/events","html_url":"https://github.com/elastic/elasticsearch/issues/30011","id":317453848,"node_id":"MDU6SXNzdWUzMTc0NTM4NDg=","number":30011,"title":"Watcher start/stop fails in CI","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"assignees":[{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-04-19T21:03:56Z","updated_at":"2018-05-04T10:22:17Z","closed_at":"2018-05-04T10:22:17Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @jaymode:*\n\nWatcher stopping/starting is still failing in CI after LINK REDACTED. See LINK REDACTED as an example failure.\r\n\r\n<details>\r\n\r\n```\r\nFAILURE 20.5s J1 | ActionThrottleTests.testSingleActionAckThrottle <<< FAILURES!\r\n   > Throwable LINK REDACTED: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:731)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:705)\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.startWatcher(AbstractWatcherIntegrationTestCase.java:469)\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase._setup(AbstractWatcherIntegrationTestCase.java:204)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n   > \tSuppressed: java.lang.AssertionError: all nodes are stopped, restarting\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:492)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$startWatcher$9(AbstractWatcherIntegrationTestCase.java:500)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 38 moreThrowable LINK REDACTED: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:731)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:705)\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.stopWatcher(AbstractWatcherIntegrationTestCase.java:514)\r\n   > \tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase._cleanup(AbstractWatcherIntegrationTestCase.java:212)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n   > \tSuppressed: java.lang.AssertionError: unexpected state, retrying with next run\r\n   > \t\tat org.elasticsearch.xpack.watcher.test.AbstractWatcherIntegrationTestCase.lambda$stopWatcher$16(AbstractWatcherIntegrationTestCase.java:545)\r\n   > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:719)\r\n   > \t\t... 37 more\r\n```\r\n\r\n</details>\r\n\r\n\r\nThe failure does not reproduce but seems to have popped up a few times today from me looking around. I was looking over the start/stop logic for watcher and the only thing I can see is that some nodes are started and some are stopped but none are starting/stopping. I didn't see a cause for this at all but maybe we need to trigger a cluster state update so that the watcher service start possibly gets triggered again?\r\n\r\nThere is a potential concurrency issue that may be able to trigger this. In the cluster changed method there are logic evaluations based upon multiple `watcherService.state()` calls. This value can change between these calls as the state is not constant and we perform operations on the watcher service using an executor. Even if this is not the cause of these failures it should still be fixed as the behavior is unpredictable when executing comparisons against a possibly changing value; we should do what the `start()` method does and uses a local copy of the point in time value.","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}