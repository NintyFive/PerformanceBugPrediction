[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/132916311","html_url":"https://github.com/elastic/elasticsearch/issues/12620#issuecomment-132916311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12620","id":132916311,"node_id":"MDEyOklzc3VlQ29tbWVudDEzMjkxNjMxMQ==","user":{"login":"xuzha","id":1799964,"node_id":"MDQ6VXNlcjE3OTk5NjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1799964?v=4","gravatar_id":"","url":"https://api.github.com/users/xuzha","html_url":"https://github.com/xuzha","followers_url":"https://api.github.com/users/xuzha/followers","following_url":"https://api.github.com/users/xuzha/following{/other_user}","gists_url":"https://api.github.com/users/xuzha/gists{/gist_id}","starred_url":"https://api.github.com/users/xuzha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xuzha/subscriptions","organizations_url":"https://api.github.com/users/xuzha/orgs","repos_url":"https://api.github.com/users/xuzha/repos","events_url":"https://api.github.com/users/xuzha/events{/privacy}","received_events_url":"https://api.github.com/users/xuzha/received_events","type":"User","site_admin":false},"created_at":"2015-08-20T07:21:40Z","updated_at":"2015-08-20T07:21:40Z","author_association":"CONTRIBUTOR","body":"I think we could remove this test. \n\n> ```\n> hhoffstaette added a note on Mar 4, 2014\n> @kimchy explicitly wanted close() a no-op because many callers still call close() prematurely and then something else.\n> ```\n\nIf close () is a no-op, then why we need this test. If the requirement changed now, we should change close() method.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136238304","html_url":"https://github.com/elastic/elasticsearch/issues/12620#issuecomment-136238304","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12620","id":136238304,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjIzODMwNA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T02:43:14Z","updated_at":"2015-08-31T02:43:14Z","author_association":"MEMBER","body":"We should fix any code that is calling `bytes()` after `close()`. This sounds very broken and error prone!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324872675","html_url":"https://github.com/elastic/elasticsearch/issues/12620#issuecomment-324872675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12620","id":324872675,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDg3MjY3NQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T09:46:17Z","updated_at":"2017-08-25T09:46:17Z","author_association":"CONTRIBUTOR","body":"While I agree with Ryan, I looked into making this change in order to remove the AwaitsFix and this was problematic when the stream is wrapped with a `DeflaterOutputStream`. The `DEFLATE` format has an end marker that `DeflaterOutputStream` writes either when you cann `finish()` or `close()`. Since `finish()` is specific to this `OutputStream` implementation, it is not practical. So now imagine you want to generate compressed bytes (which is something we often do in Elasticsearch):\r\n\r\n```java\r\ntry (BytesStreamOutput out = new BytesStreamOutput();\r\n        OutputStream compressedOutput = CompressorFactory.COMPRESSOR.streamOutput(out)) {\r\n    data.writeTo(compressedOutput);\r\n    compressedOutput.flush();\r\n    BytesReference compressedBytes = out.bytes();\r\n}\r\n```\r\n\r\nThis does not work because the end marker has not been written yet when we call `out.bytes()`. And if we move the last line outside of the `try`block, then `out.bytes()` is called after `out` is closed which is what we want to prevent.\r\n\r\nAs a consequence I'd like to close this bug as a won't fix. Please suggest if you have ideas to work around that problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324998415","html_url":"https://github.com/elastic/elasticsearch/issues/12620#issuecomment-324998415","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12620","id":324998415,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDk5ODQxNQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T18:14:02Z","updated_at":"2017-08-25T18:14:02Z","author_association":"MEMBER","body":"Thanks for the analysis @jpountz. I agree with you after further thought. This is similar to ByteArrayOutputStream, in that you can get access to the byte array after the stream after or before the stream as been closed. Closing only means you can no longer write to the stream.  I opened #26392 to remove the test.","performed_via_github_app":null}]