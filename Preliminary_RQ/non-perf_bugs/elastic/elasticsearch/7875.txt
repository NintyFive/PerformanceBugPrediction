{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7875","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7875/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7875/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7875/events","html_url":"https://github.com/elastic/elasticsearch/issues/7875","id":43938082,"node_id":"MDU6SXNzdWU0MzkzODA4Mg==","number":7875,"title":"simple_query_string parser may fail with NumberFormatException while parsing flags","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2014-09-25T16:21:20Z","updated_at":"2014-09-26T07:53:45Z","closed_at":"2014-09-26T07:53:45Z","author_association":"MEMBER","active_lock_reason":null,"body":"To reproduce:\n\n```\ncurl -XDELETE 'http://localhost:9200/test/?pretty'\n\ncurl -XPUT 'http://localhost:9200/test/?pretty' -d '{\n  \"settings\": {\n    \"index.number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"document\": {\n      \"_routing\" : {\n        \"required\": true\n      },\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\"\n    }\n      }\n    },\n    \"entity\": {\n      \"_parent\": {\n        \"type\": \"document\"\n      },\n      \"_routing\" : {\n        \"required\": true\n      },\n      \"properties\": {\n        \"body\": {\n          \"type\": \"string\"\n        }\n      }\n    }\n  }\n}'\n\n\ncurl -XPOST 'http://localhost:9200/_bulk?pretty' --data-binary '\n{\"index\": {\"_index\": \"test\", \"_type\": \"document\", \"_id\" : \"1\", \"_routing\": \"1\"}}\n{\"title\": \"New document\"}\n{\"index\": {\"_index\": \"test\", \"_type\": \"entity\", \"_id\" : \"1\", \"_routing\": \"1\", \"_parent\": \"1\"}}\n{\"body\": \"document body\"}\n'\ncurl -XPOST 'http://localhost:9200/test/_refresh?pretty'\ncurl -XGET 'http://localhost:9200/test/document/_search?pretty' -d '\n{\n  \"query\" : {\n    \"bool\": {\n      \"minimum_should_match\": 1,\n      \"disable_coord\": true,\n      \"should\": [\n        {\n          \"simple_query_string\": {\n            \"query\": \"old document\",\n            \"default_operator\": \"and\",\n            \"fields\": [\"title^10\"],\n            \"flags\": \"NONE\"\n          }\n        },\n        {\n          \"has_child\": {\n            \"query\": {\n              \"bool\": {\n                \"minimum_should_match\": 1,\n                \"disable_coord\": true,\n                \"should\": [\n                  {\n                    \"simple_query_string\" : {\n                      \"query\" : \"\\\"document body\\\"~2\",\n                      \"default_operator\" : \"and\",\n                      \"flags\": \"PHRASE|SLOP\",\n                      \"fields\": [\"body^5\"]\n                    }\n                  },\n                  {\n                    \"simple_query_string\" : {\n                      \"query\" : \"document body\",\n                      \"default_operator\" : \"and\",\n                      \"fields\": [\"body\"],\n                      \"flags\": \"NONE\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"type\": \"entity\",\n            \"score_mode\": \"sum\"\n          }\n        }\n      ]\n    }\n  }\n}\n'\n```\n\nThe search fails with `NumberFormatException[For input string: \\\"PHRASE|SLOP\\\"];` exception.\n\nThe problem occurs because `simple_query_string` parser is using `XContentParser.hasTextCharacters()` method to check for the presence of text in the token, while this method should be only used to detect internal presentation of the string. \n\nThe issue was originally reported on the mailing list https://groups.google.com/forum/#!topic/elasticsearch-ru/SeiifNQW-qo\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}