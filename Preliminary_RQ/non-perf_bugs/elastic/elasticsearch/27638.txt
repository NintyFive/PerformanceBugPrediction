{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27638","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27638/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27638/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27638/events","html_url":"https://github.com/elastic/elasticsearch/issues/27638","id":278922981,"node_id":"MDU6SXNzdWUyNzg5MjI5ODE=","number":27638,"title":"ICU: cjk language analyzer not working as expected ","user":{"login":"louisong","id":26863726,"node_id":"MDQ6VXNlcjI2ODYzNzI2","avatar_url":"https://avatars0.githubusercontent.com/u/26863726?v=4","gravatar_id":"","url":"https://api.github.com/users/louisong","html_url":"https://github.com/louisong","followers_url":"https://api.github.com/users/louisong/followers","following_url":"https://api.github.com/users/louisong/following{/other_user}","gists_url":"https://api.github.com/users/louisong/gists{/gist_id}","starred_url":"https://api.github.com/users/louisong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/louisong/subscriptions","organizations_url":"https://api.github.com/users/louisong/orgs","repos_url":"https://api.github.com/users/louisong/repos","events_url":"https://api.github.com/users/louisong/events{/privacy}","received_events_url":"https://api.github.com/users/louisong/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-12-04T09:17:46Z","updated_at":"2018-03-22T16:56:01Z","closed_at":"2018-03-22T16:56:01Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** : 5.4, 5.6.3\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSource text : 香港貿發局香港國際春季燈飾展 2016\r\nQuery by `match` for the text `香港`\r\n\r\nExpected highlighted result: \r\n`<em>香港</em>貿發局<em>香港</em>國際春季燈飾展 2016`\r\n\r\nActual highlighted result: \r\n`<em>香港貿發局香港</em>國際春季燈飾展 2016`\r\n\r\n\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index template using the cjk language analyzer:\r\n\r\n> PUT _template/template_test\r\n{\r\n  \"template\": \"test*\",\r\n  \"mappings\": {\r\n    \"_default_\": {\r\n      \"_all\": {\r\n        \"enabled\": false\r\n      },\r\n      \"dynamic\": false\r\n    }\r\n  },\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"mapper\": {\r\n        \"dynamic\": \"false\"\r\n      },\r\n      \"number_of_shards\": \"1\",\r\n      \"number_of_replicas\": \"1\",\r\n      \"analysis\": {\r\n        \"analyzer\": {\r\n          \"cjk_main\": {\r\n            \"tokenizer\": \"standard\",\r\n            \"filter\": [\r\n              \"cjk_width\",\r\n              \"lowercase\",\r\n              \"cjk_bigram\", \r\n              \"english_stop\"\r\n            ]\r\n          }\r\n        },\r\n        \"filter\": {\r\n          \"english_stop\": {\r\n            \"type\": \"stop\",\r\n            \"stopwords\": \"_english_\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n} \r\n\r\n> \r\n\r\n\r\n2. Create index with cjk analyzer.\r\n\r\n>PUT test_20171201 \r\n{ \r\n\"mappings\": { \r\n\"content\": { \r\n\"properties\": { \r\n\"@timestamp\": { \r\n\"type\": \"date\" \r\n}, \r\n\"@version\": { \r\n\"type\": \"text\" \r\n}, \r\n\"title\": { \r\n\"type\": \"text\", \r\n\"analyzer\": \"cjk_main\" \r\n} \r\n} \r\n} \r\n} \r\n} \r\n>\r\n\r\n3. Analyze the search string to check tokens with cjk analyzer.\r\n\r\n>GET test_20171201/_analyze\r\n{\r\n  \"text\": [\"香港貿發局香港國際春季燈飾展 2016 \"],\"analyzer\": \"cjk_main\"\r\n}\r\n>\r\n\r\n4. Index sample data.\r\n\r\n>POST test_20171201/content/1\r\n{\r\n  \"title\":\"香港貿發局香港國際春季燈飾展 2016 \"\r\n}\r\n>\r\n\r\n5. Highlight search query with the title `香港` which translates to country name `Hong Kong`.\r\n\r\n>GET test_20171201/_search\r\n{\r\n  \"query\": {\"match\": {\r\n    \"title\": \"香港\"\r\n  }}, \r\n  \"highlight\": {\r\n    \"fields\": {\r\n      \"title\": {\r\n     }\r\n    }\r\n  }\r\n}\r\n>\r\n\r\n\r\n**Results from ES version 5.4 and 5.6.3**(Bug):\r\n\r\n{\r\n  \"took\": 3,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 0.3802836,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"test_20171201\",\r\n        \"_type\": \"content\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 0.3802836,\r\n        \"_source\": {\r\n          \"title\": \"香港貿發局香港國際春季燈飾展 2016 \"\r\n        },\r\n        \"highlight\": {\r\n          \"title\": [\r\n            `<em>香港貿發局香港</em>國際春季燈飾展 2016 `\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n\r\n**Results from ES version 6.0** (Expected Results) :\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 0.39556286,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"test_20171201\",\r\n        \"_type\": \"content\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 0.39556286,\r\n        \"_source\": {\r\n          \"title\": \"香港貿發局香港國際春季燈飾展 2016 \"\r\n        },\r\n        \"highlight\": {\r\n          \"title\": [\r\n            `<em>香港</em>貿發局<em>香港</em>國際春季燈飾展 2016`\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}