{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18450","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18450/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18450/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18450/events","html_url":"https://github.com/elastic/elasticsearch/issues/18450","id":155531301,"node_id":"MDU6SXNzdWUxNTU1MzEzMDE=","number":18450,"title":"Elasticsearch 2.3.1 accept a field both as a string and as an object on the same index","user":{"login":"segalziv","id":9026326,"node_id":"MDQ6VXNlcjkwMjYzMjY=","avatar_url":"https://avatars1.githubusercontent.com/u/9026326?v=4","gravatar_id":"","url":"https://api.github.com/users/segalziv","html_url":"https://github.com/segalziv","followers_url":"https://api.github.com/users/segalziv/followers","following_url":"https://api.github.com/users/segalziv/following{/other_user}","gists_url":"https://api.github.com/users/segalziv/gists{/gist_id}","starred_url":"https://api.github.com/users/segalziv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/segalziv/subscriptions","organizations_url":"https://api.github.com/users/segalziv/orgs","repos_url":"https://api.github.com/users/segalziv/repos","events_url":"https://api.github.com/users/segalziv/events{/privacy}","received_events_url":"https://api.github.com/users/segalziv/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-05-18T15:26:49Z","updated_at":"2016-05-18T16:08:55Z","closed_at":"2016-05-18T15:52:18Z","author_association":"NONE","active_lock_reason":null,"body":"As I understand, it should be impossible to use the same field name with more then one field type on the same index, regardless of the document type. \n\nBut, on 2.3.1 we sometimes see that the index accepts a field with both string and object types (easy to reproduce - see bellow).\n\nAfter this point the behaviour is not that predictive as some docs gets in and other don't with IllegalArgumentException (see log samples bellow).\n\nCan you please confirm this is a bug or make it clear when a field can be used with more then one field-type?\n\nThanks!\n\n**Elasticsearch version**: 2.3.1\n\n**JVM version**: 1.7.0_95\n\n**OS version**: Linux AMD64 3.13.0-48-generic\n\n**Description of the problem including expected versus actual behavior**:\n\n**Steps to reproduce**:\n1. POST es-host:9200/index-name/type1  { \"field-name\" : \"a string value\" }\n2. POST es-host:9200/index-name/type2  \n   { \"field-name\" : { \"inner-field\" : \"now an object\"} }\n3. GET es-host:9200/index-name/_mappings \n\n```\n{\n    \"index-name\": {\n        \"mappings\": {\n            \"type1\": {\n                \"properties\": {\n                    \"field-name\": {\n                        \"type\": \"string\"\n                    }\n                }\n            },\n            \"type2\": {\n                \"properties\": {\n                    \"field-name\": {\n                        \"properties\": {\n                            \"inner-field\": {\n                                \"type\": \"string\"\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n1. On this point indexing to the index fails on some cases - either when trying to use the same field ('field-name') on new types and on the existing types and even (hard to reproduce) on docs without this specific field.\n\n*_Provide logs *_:\n\nFrom the master node:\n\n```\n[2016-05-11 08:39:18,659][DEBUG][action.admin.indices.mapping.put] [master-xxx] failed to put mappings on indices [[index1]], type [client]\njava.lang.IllegalArgumentException: Field [os] is defined as a field in mapping [elb] but this name is already used for an object in other types\n        at org.elasticsearch.index.mapper.MapperService.checkObjectsCompatibility(MapperService.java:473)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:336)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:289)\n        at org.elasticsearch.cluster.metadata.MetaDataMappingService$PutMappingExecutor.execute(MetaDataMappingService.java:223)\n        at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:468)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n\nFrom the data node:\n\n[2016-05-11 08:42:58,381][DEBUG][action.bulk              ] [PROD-data-elasticsearch2-4-i-9cbda518] [index1][0] failed to execute bulk item (index) index {[index1][iis][AVSe-7uvn-xxxxxxxxx], source[{\"cs-method\":\"GET\",\"cs-uri-stem\":\"/deploy/General/CheckHealth\",\"cs-uri-query\":\"-\",\"sc-substatus\":0,\"type\":\"iis\",\"cs-username\":\"-\",\"os_iis\":\"Other\",\"host\":\"IP-xxxx\",\"timestamp\":\"2016-05-11 08:41:56\",\"app\":\"player\",\"s-sitename\":\"0.0.0.0\",\"message\":\"2016-05-11 08:41:56 0.0.0.0 GET /deploy/General/CheckHealth - 80 - 1.1.1.1 ELB-HealthChecker/1.0 - 200 0 0 0\",\"env\":\"dev\",\"time-taken\":0,\"cs\":[\"ELB-HealthChecker/1.0\",\"-\"],\"@timestamp\":\"2016-05-11T08:41:56.000Z\",\"response\":200,\"s-port\":\"80\",\"name\":\"Other\",\"os_name\":\"Other\",\"c-ip\":\"1.1.1.1\",\"device\":\"Other\"}]}\njava.lang.IllegalArgumentException: Field [os] is defined as a field in mapping [elb] but this name is already used for an object in other types\n        at org.elasticsearch.index.mapper.MapperService.checkObjectsCompatibility(MapperService.java:473)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:336)\n        at org.elasticsearch.index.mapper.MapperService.merge(MapperService.java:289)\n        at org.elasticsearch.cluster.metadata.MetaDataMappingService$PutMappingExecutor.execute(MetaDataMappingService.java:223)\n        at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:468)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}