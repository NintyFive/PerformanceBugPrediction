{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48551","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48551/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48551/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48551/events","html_url":"https://github.com/elastic/elasticsearch/issues/48551","id":512819623,"node_id":"MDU6SXNzdWU1MTI4MTk2MjM=","number":48551,"title":"shards rebalance should take into account that shards distribution of a index among the multi path.data in on node may be unbalancedly","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-10-26T10:29:56Z","updated_at":"2019-11-09T16:17:20Z","closed_at":"2019-11-09T16:17:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES_VERSION: 7.3.1\r\n**Description of the problem including expected versus actual behavior:**\r\nwhen shards distribution decides how the shards of one index  distribute among the multi path.data  in on node, it may be unbalancedly, for example, the  shards distribution of index1  in a node  is as follow:\r\n+ path1:  shard1\r\n+ path2: shards2, shard3, shard4\r\n+ path3: None\r\n\r\nnow shards distribution need to move one shard of index1 from the node to another node, it only consider the factors:\r\n1. the shard is started.\r\n2. the shard can `canAllocate` and `canRebalance` to the another node.\r\n3. delta score is  lower or shardId is lower.\r\nRelated code is here:\r\nhttps://github.com/elastic/elasticsearch/blob/94fe4806ce9449ec152a89e869064603fe13b296/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java#L992\r\n\r\nAccord to the rules, it will pick out the shard1 because of equal weights for shards1/shard2/shard3, then move shard1 to another node, we can see that it may be unbalancedly for index1 in the node, the path1 will be free and path2 will be busy when index1 occurs a lot of writes or searches, so it should pick out the shard of path2, not the shard1.\r\n\r\nIf we could select the shard which is more unbalanced among the multi path in one node for a index. we just need to add the fourth factor here: https://github.com/elastic/elasticsearch/blob/94fe4806ce9449ec152a89e869064603fe13b296/server/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java#L1014\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}