{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8704","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8704/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8704/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8704/events","html_url":"https://github.com/elastic/elasticsearch/issues/8704","id":50391270,"node_id":"MDU6SXNzdWU1MDM5MTI3MA==","number":8704,"title":"Explanation behaves inconsistently for multi_match query","user":{"login":"osykora","id":4713269,"node_id":"MDQ6VXNlcjQ3MTMyNjk=","avatar_url":"https://avatars1.githubusercontent.com/u/4713269?v=4","gravatar_id":"","url":"https://api.github.com/users/osykora","html_url":"https://github.com/osykora","followers_url":"https://api.github.com/users/osykora/followers","following_url":"https://api.github.com/users/osykora/following{/other_user}","gists_url":"https://api.github.com/users/osykora/gists{/gist_id}","starred_url":"https://api.github.com/users/osykora/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/osykora/subscriptions","organizations_url":"https://api.github.com/users/osykora/orgs","repos_url":"https://api.github.com/users/osykora/repos","events_url":"https://api.github.com/users/osykora/events{/privacy}","received_events_url":"https://api.github.com/users/osykora/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-11-28T17:01:58Z","updated_at":"2014-11-28T17:27:18Z","closed_at":"2014-11-28T17:27:18Z","author_association":"NONE","active_lock_reason":null,"body":"Explanation output shows different information than it should, if I understand it correctly.\n\nCreate an index:\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/testsearch/'  -d '\n{\n  \"settings\":{\n    \"analysis\":{\n      \"analyzer\":{\n        \"autocomplete_index\":{\n          \"type\":\"custom\",\n          \"tokenizer\":\"standard\",\n          \"filter\":[\"lowercase\", \"my_ngram\"] \n        },\n         \"autocomplete_search\":{\n          \"type\":\"custom\",\n          \"tokenizer\":\"standard\",\n          \"filter\":[ \"lowercase\" ] \n        }\n      },\n      \"filter\":{\n        \"my_ngram\":{\n          \"type\":\"edgeNGram\",\n          \"min_gram\":1,\n          \"max_gram\":255,\n          \"token_chars\": [ \"letter\", \"digit\"]\n        }\n      }\n    }\n  }\n}'\n```\n\nAdd mapping:\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/testsearch/_mapping/airport'  -d '\n{\n    \"airport\":\n    {\n        \"properties\":\n        {\n            \"name\":\n            {\n                \"type\":\"multi_field\",\n                \"fields\": \n                {\n                    \"autocomplete_ngram\":\n                    {\n                        \"type\":\"string\", \n                        \"index_analyzer\":\"autocomplete_index\",\n                        \"search_analyzer\": \"autocomplete_search\"\n                    },\n                    \"autocomplete_words\":\n                    {\n                        \"type\":\"string\",\n                        \"search_analyzer\": \"autocomplete_search\",\n                        \"index_analyzer\": \"autocomplete_search\"\n                    }\n                }\n            }\n        }\n    }\n}'\n```\n\nInsert some data:\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/testsearch/airport/_bulk'  -d '\n{\"index\": {\"_index\": \"testsearch\", \"_type\": \"airport\"}}\n{\"name\": \"John F Kennedy\"}\n{\"index\": {\"_index\": \"testsearch\", \"_type\": \"airport\"}}\n{\"name\": \"Key Field\"}'\n```\n\nNow, when I search for \"f kenned\", there should be a match for \"f\" token on both autocomplete_ngram and autocomplete_words fields, and \"kenned\" token should match on autocomplete_ngram field. \n\n```\ncurl -XPOST 'http://127.0.0.1:9200/testsearch/_search?explain=&format=yaml'  -d '\n{\n    \"query\":\n    {\n        \"multi_match\":\n        {\n            \"query\": \"f kenned\",\n            \"fields\": [\"autocomplete_ngram\", \"autocomplete_words\"],\n            \"operator\":\"and\",\n            \"type\": \"most_fields\"\n        }\n    }\n}'\n```\n\nThe query above produces the following result: \n\n```\ntook: 1\ntimed_out: false\n_shards:\n  total: 1\n  successful: 1\n  failed: 0\nhits:\n  total: 1\n  max_score: 0.14809652\n  hits:\n  - _shard: 0\n    _node: \"o4MHMH-cQp6aRFx5KmhMUg\"\n    _index: \"testsearch\"\n    _type: \"airport\"\n    _id: \"AUn3Mv-sH6B0vXIpm567\"\n    _score: 0.14809652\n    _source:\n      name: \"John F Kennedy\"\n    _explanation:\n      value: 0.14809652\n      description: \"product of:\"\n      details:\n      - value: 0.29619303\n        description: \"sum of:\"\n        details:\n        - value: 0.29619303\n          description: \"sum of:\"\n          details:\n          - value: 0.07735357\n            description: \"weight(name.autocomplete_ngram:f in 0) [PerFieldSimilarity],\\\n              \\ result of:\"\n            details:\n            - value: 0.07735357\n              description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n              details:\n              - value: 0.2602154\n                description: \"queryWeight, product of:\"\n                details:\n                - value: 0.5945349\n                  description: \"idf(docFreq=2, maxDocs=2)\"\n                - value: 0.43767893\n                  description: \"queryNorm\"\n              - value: 0.29726744\n                description: \"fieldWeight in 0, product of:\"\n                details:\n                - value: 1.0\n                  description: \"tf(freq=1.0), with freq of:\"\n                  details:\n                  - value: 1.0\n                    description: \"termFreq=1.0\"\n                - value: 0.5945349\n                  description: \"idf(docFreq=2, maxDocs=2)\"\n                - value: 0.5\n                  description: \"fieldNorm(doc=0)\"\n          - value: 0.21883947\n            description: \"weight(name.autocomplete_ngram:kenned in 0) [PerFieldSimilarity],\\\n              \\ result of:\"\n            details:\n            - value: 0.21883947\n              description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n              details:\n              - value: 0.43767893\n                description: \"queryWeight, product of:\"\n                details:\n                - value: 1.0\n                  description: \"idf(docFreq=1, maxDocs=2)\"\n                - value: 0.43767893\n                  description: \"queryNorm\"\n              - value: 0.5\n                description: \"fieldWeight in 0, product of:\"\n                details:\n                - value: 1.0\n                  description: \"tf(freq=1.0), with freq of:\"\n                  details:\n                  - value: 1.0\n                    description: \"termFreq=1.0\"\n                - value: 1.0\n                  description: \"idf(docFreq=1, maxDocs=2)\"\n                - value: 0.5\n                  description: \"fieldNorm(doc=0)\"\n      - value: 0.5\n        description: \"coord(1/2)\"\n```\n\nSo, if I understand the explanation correctly, it claims that there was no match for \"f\" token on autocomplete_words field, which is probably wrong. But when I change the search query to \"f kennedy\", it shows what I expect:\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/testsearch/_search?explain=&format=yaml'  -d '\n{\n    \"query\":\n    {\n        \"multi_match\":\n        {\n            \"query\": \"f kennedy\",\n            \"fields\": [\"autocomplete_ngram\", \"autocomplete_words\"],\n            \"operator\":\"and\",\n            \"type\": \"most_fields\"\n        }\n    }\n}'\n```\n\n```\ntook: 47\ntimed_out: false\n_shards:\n  total: 1\n  successful: 1\n  failed: 0\nhits:\n  total: 1\n  max_score: 0.9156243\n  hits:\n  - _shard: 0\n    _node: \"o4MHMH-cQp6aRFx5KmhMUg\"\n    _index: \"testsearch\"\n    _type: \"airport\"\n    _id: \"AUn3Mv-sH6B0vXIpm567\"\n    _score: 0.9156243\n    _source:\n      name: \"John F Kennedy\"\n    _explanation:\n      value: 0.9156243\n      description: \"sum of:\"\n      details:\n      - value: 0.36954886\n        description: \"sum of:\"\n        details:\n        - value: 0.09651111\n          description: \"weight(name.autocomplete_ngram:f in 0) [PerFieldSimilarity],\\\n            \\ result of:\"\n          details:\n          - value: 0.09651111\n            description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n            details:\n            - value: 0.3246609\n              description: \"queryWeight, product of:\"\n              details:\n              - value: 0.5945349\n                description: \"idf(docFreq=2, maxDocs=2)\"\n              - value: 0.54607546\n                description: \"queryNorm\"\n            - value: 0.29726744\n              description: \"fieldWeight in 0, product of:\"\n              details:\n              - value: 1.0\n                description: \"tf(freq=1.0), with freq of:\"\n                details:\n                - value: 1.0\n                  description: \"termFreq=1.0\"\n              - value: 0.5945349\n                description: \"idf(docFreq=2, maxDocs=2)\"\n              - value: 0.5\n                description: \"fieldNorm(doc=0)\"\n        - value: 0.27303773\n          description: \"weight(name.autocomplete_ngram:kennedy in 0) [PerFieldSimilarity],\\\n            \\ result of:\"\n          details:\n          - value: 0.27303773\n            description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n            details:\n            - value: 0.54607546\n              description: \"queryWeight, product of:\"\n              details:\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.54607546\n                description: \"queryNorm\"\n            - value: 0.5\n              description: \"fieldWeight in 0, product of:\"\n              details:\n              - value: 1.0\n                description: \"tf(freq=1.0), with freq of:\"\n                details:\n                - value: 1.0\n                  description: \"termFreq=1.0\"\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.5\n                description: \"fieldNorm(doc=0)\"\n      - value: 0.54607546\n        description: \"sum of:\"\n        details:\n        - value: 0.27303773\n          description: \"weight(name.autocomplete_words:f in 0) [PerFieldSimilarity],\\\n            \\ result of:\"\n          details:\n          - value: 0.27303773\n            description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n            details:\n            - value: 0.54607546\n              description: \"queryWeight, product of:\"\n              details:\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.54607546\n                description: \"queryNorm\"\n            - value: 0.5\n              description: \"fieldWeight in 0, product of:\"\n              details:\n              - value: 1.0\n                description: \"tf(freq=1.0), with freq of:\"\n                details:\n                - value: 1.0\n                  description: \"termFreq=1.0\"\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.5\n                description: \"fieldNorm(doc=0)\"\n        - value: 0.27303773\n          description: \"weight(name.autocomplete_words:kennedy in 0) [PerFieldSimilarity],\\\n            \\ result of:\"\n          details:\n          - value: 0.27303773\n            description: \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\"\n            details:\n            - value: 0.54607546\n              description: \"queryWeight, product of:\"\n              details:\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.54607546\n                description: \"queryNorm\"\n            - value: 0.5\n              description: \"fieldWeight in 0, product of:\"\n              details:\n              - value: 1.0\n                description: \"tf(freq=1.0), with freq of:\"\n                details:\n                - value: 1.0\n                  description: \"termFreq=1.0\"\n              - value: 1.0\n                description: \"idf(docFreq=1, maxDocs=2)\"\n              - value: 0.5\n                description: \"fieldNorm(doc=0)\"\n```\n\nThis behavior doesn't affect the search results themselves, but their scoring. I ran into this issue when I wanted to boost autocomplete_words field, but it was ignored for some searches.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}