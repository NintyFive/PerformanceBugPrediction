{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308/events","html_url":"https://github.com/elastic/elasticsearch/issues/43308","id":457207983,"node_id":"MDU6SXNzdWU0NTcyMDc5ODM=","number":43308,"title":"Synonym graph causes strange score on match_phrase query","user":{"login":"bbfsdev","id":1877419,"node_id":"MDQ6VXNlcjE4Nzc0MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/1877419?v=4","gravatar_id":"","url":"https://api.github.com/users/bbfsdev","html_url":"https://github.com/bbfsdev","followers_url":"https://api.github.com/users/bbfsdev/followers","following_url":"https://api.github.com/users/bbfsdev/following{/other_user}","gists_url":"https://api.github.com/users/bbfsdev/gists{/gist_id}","starred_url":"https://api.github.com/users/bbfsdev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbfsdev/subscriptions","organizations_url":"https://api.github.com/users/bbfsdev/orgs","repos_url":"https://api.github.com/users/bbfsdev/repos","events_url":"https://api.github.com/users/bbfsdev/events{/privacy}","received_events_url":"https://api.github.com/users/bbfsdev/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-06-18T00:43:59Z","updated_at":"2019-07-12T14:12:46Z","closed_at":"2019-07-04T07:38:57Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n7.1.1 (also at 6.7.2).\r\nFYI, the bug **don't exist at 6.5.4**.\r\n\r\n**Plugins installed**: No plugins.\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_212\"\r\nOpenJDK Runtime Environment (build 1.8.0_212-b04)\r\nOpenJDK 64-Bit Server VM (build 25.212-b04, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux bbdev6.local 3.10.0-957.12.1.el7.x86_64 #1 SMP Mon Apr 29 14:59:59 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\ncentos-release-7-6.1810.2.el7.centos.x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen synonym graph together with hunspell for Hebrew is used and applied to specific query that uses match_phrase, the score of the query is from some reason much larger due to tokens from non-related documents.\r\n\r\n**Steps to reproduce**:\r\nJust copy/paste those curl commands:\r\n\r\n```\r\nDELETE test\r\n{}\r\n\r\nPUT test\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0,\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"synonym_graph\": {\r\n          \"type\": \"synonym_graph\",\r\n          \"synonyms\": [\r\n\r\n          ],\r\n          \"tokenizer\": \"keyword\"\r\n        },\r\n        \"he_IL\": {\r\n          \"locale\": \"he_IL\",\r\n          \"type\": \"hunspell\",\r\n          \"dedup\": \"true\"\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"hebrew_synonym\": {\r\n          \"filter\": [\r\n            \"synonym_graph\",\r\n            \"he_IL\"\r\n          ],\r\n          \"tokenizer\": \"standard\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"content\": {\r\n        \"fields\": {\r\n          \"language\": {\r\n            \"type\": \"text\",\r\n            \"analyzer\": \"hebrew_synonym\"\r\n          }\r\n        },\r\n        \"type\": \"text\",\r\n        \"analyzer\": \"standard\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test/_doc/1\r\n{\r\n  \"content\": \"מבואנוס\"\r\n}\r\n\r\nPOST test/_doc/2\r\n{\r\n  \"content\": \"מבואו\"\r\n}\r\n\r\nPOST test/_doc/3\r\n{\r\n  \"content\": \"מבוא לספר הזוהר\"\r\n}\r\n\r\nPOST test/_doc/4\r\n{\r\n  \"content\": \"מבוארות\"\r\n}\r\n\r\nPOST test/_doc/5\r\n{\r\n  \"content\": \"מבואה\"\r\n}\r\n\r\nPOST test/_doc/6\r\n{\r\n  \"content\": \"מבוארים\"\r\n}\r\n\r\nPOST test/_doc/7\r\n{\r\n  \"content\": \"בואקום\"\r\n}\r\n\r\nPOST test/_doc/8\r\n{\r\n  \"content\": \"בואינג\"\r\n}\r\n\r\nPOST test/_doc/9\r\n{\r\n  \"content\": \"בואהבת\"\r\n}\r\n\r\nPOST test/_doc/10\r\n{\r\n  \"content\": \"בואנו\"\r\n}\r\n\r\nPOST test/_doc/11\r\n{\r\n  \"content\": \"מבואסים\"\r\n}\r\nPOST test/_doc/12\r\n{\r\n  \"content\": \"בואם\"\r\n}\r\n\r\nPOST test/_doc/13\r\n{\r\n  \"content\": \"בואהבת\"\r\n}\r\n\r\nGET test/_search\r\n{\r\n  \"explain\": true,\r\n  \"query\": {\r\n    \"match_phrase\": {\r\n      \"content.language\": {\r\n        \"query\": \"מבוא לספר הזוהר\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test/_close\r\nPUT test/_settings\r\n{\r\n  \"analysis\": {\r\n    \"filter\": {\r\n      \"synonym_graph\": {\r\n        \"type\": \"synonym_graph\",\r\n        \"synonyms\": [\r\n            \"זוהר לעם,זוהר,ספר הזוהר,הזוהר\"\r\n        ],\r\n        \"tokenizer\": \"keyword\"\r\n      }\r\n    }\r\n  }\r\n}\r\nPOST test/_open\r\n\r\nGET test/_search\r\n{\r\n  \"explain\": true,\r\n  \"query\": {\r\n    \"match_phrase\": {\r\n      \"content.language\": {\r\n        \"query\": \"מבוא לספר הזוהר\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n# DELETE test\r\n{\r\n  \"acknowledged\" : true\r\n}\r\n\r\n\r\n# PUT test\r\n{\r\n  \"acknowledged\" : true,\r\n  \"shards_acknowledged\" : true,\r\n  \"index\" : \"test\"\r\n}\r\n\r\n\r\n# POST test/_doc/1\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 0,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/2\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"2\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 1,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/3\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"3\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 2,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/4\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"4\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 3,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/5\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"5\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 4,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/6\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"6\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 5,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/7\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"7\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 6,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/8\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"8\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 7,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/9\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"9\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 8,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/10\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"10\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 9,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/11\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"11\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 10,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/12\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"12\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 11,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# POST test/_doc/13\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"13\",\r\n  \"_version\" : 1,\r\n  \"result\" : \"created\",\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"failed\" : 0\r\n  },\r\n  \"_seq_no\" : 12,\r\n  \"_primary_term\" : 1\r\n}\r\n\r\n\r\n# GET test/_search\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 8.552871,\r\n    \"hits\" : [\r\n      {\r\n        \"_shard\" : \"[test][0]\",\r\n        \"_node\" : \"76xQgsOsSz6OqfkSZmsVQw\",\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 8.552871,\r\n        \"_source\" : {\r\n          \"content\" : \"מבוא לספר הזוהר\"\r\n        },\r\n        \"_explanation\" : {\r\n          \"value\" : 8.552871,\r\n          \"description\" : \"\"\"weight(content.language:\"(מבוא בוא) ספר זוהר\" in 2) [PerFieldSimilarity], result of:\"\"\",\r\n          \"details\" : [\r\n            .......\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n\r\n# POST test/_close\r\n{\r\n  \"acknowledged\" : true\r\n}\r\n\r\n\r\n# PUT test/_settings\r\n{\r\n  \"acknowledged\" : true\r\n}\r\n\r\n\r\n# POST test/_open\r\n{\r\n  \"acknowledged\" : true,\r\n  \"shards_acknowledged\" : true\r\n}\r\n\r\n\r\n# GET test/_search\r\n{\r\n  \"took\" : 2,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 38.78237,\r\n    \"hits\" : [\r\n      {\r\n        \"_shard\" : \"[test][0]\",\r\n        \"_node\" : \"76xQgsOsSz6OqfkSZmsVQw\",\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 38.78237,\r\n        \"_source\" : {\r\n          \"content\" : \"מבוא לספר הזוהר\"\r\n        },\r\n        \"_explanation\" : {\r\n          \"value\" : 38.78237,\r\n          \"description\" : \"weight(spanNear([spanOr([spanOr([content.language:מבואנוס, content.language:מבואו, content.language:מבוארות, content.language:מבואה, content.language:מבואסים, content.language:מבוארים, content.language:מבוא]), spanOr([content.language:בוא, content.language:בואנו, content.language:בואה, content.language:בואם, content.language:בואינג, content.language:בואו, content.language:בואקום, content.language:בואהבת])]), content.language:ספר, spanOr([spanNear([content.language:זוהר, content.language:עם], 0, true), content.language:זוהר, spanNear([content.language:ספר, content.language:זוהר], 0, true), content.language:זוהר])], 0, true) in 2) [PerFieldSimilarity], result of:\",\r\n          \"details\" : [\r\n            {\r\n   ..........\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n\r\nIn the logs above you can see 2 queries.\r\nFirst query done when synonyms list is empty. The score is small, i.e., 8.5 and the result is reasonable.\r\nSecond query done when synonym list is \"זוהר לעם,זוהר,ספר הזוהר,הזוהר\" which might add some value to the score but the score is unproportionally large and what is more interesting **depends on other non-related to query nor to synonyms documents** (this can be seen the in the explanation of the second query):\r\n...\r\n\"description\" : \"weight(spanNear([spanOr([spanOr([content.language:מבואנוס, content.language:מבואו, content.language:מבוארות, content.language:מבואה, content.language:מבואסים, content.language:מבוארים, content.language:מבוא]), spanOr([content.language:בוא, content.language:בואנו, content.language:בואה, content.language:בואם, content.language:בואינג, content.language:בואו, content.language:בואקום, content.language:בואהבת])]), content.language:ספר, spanOr([spanNear([content.language:זוהר, content.language:עם], 0, true), content.language:זוהר, spanNear([content.language:ספר, content.language:זוהר], 0, true), content.language:זוהר])], 0, true) in 2) [PerFieldSimilarity], result of:\"\r\n...\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}