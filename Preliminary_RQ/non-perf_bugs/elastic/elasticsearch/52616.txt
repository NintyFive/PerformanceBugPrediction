{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616/events","html_url":"https://github.com/elastic/elasticsearch/issues/52616","id":568752413,"node_id":"MDU6SXNzdWU1Njg3NTI0MTM=","number":52616,"title":"Support for timeout in stats API","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"labels":[{"id":146836529,"node_id":"MDU6TGFiZWwxNDY4MzY1Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Stats","name":":Core/Features/Stats","color":"0e8a16","default":false,"description":"Statistics tracking and retrieval APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2020-02-21T05:55:59Z","updated_at":"2020-07-07T11:46:40Z","closed_at":"2020-02-28T13:57:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The `GET _stats` API broadcasts requests to all nodes in order to collect shard level stats from across the nodes. Now if there is a single node that is problematic(degraded hardware or the kernel unable to schedule tasks during some scenarios, cpu lock-ups etc), this can cause heap to build up on a node handling the `REST` request as it would not be able to free up memory allocated from the responses of remaining nodes while waiting on the problematic node to respond. Now if there are clients doing a periodic monitoring this might increase GC pressure on the nodes.\r\n\r\nHistogram dum from one of the nodes\r\n```\r\n num     #instances         #bytes  class name\r\n----------------------------------------------\r\n   1:     230117683    14813806384  [C\r\n   2:     230114240     5522741760  java.lang.String\r\n   3:      77239917     2471677344  java.util.HashMap$Node\r\n   4:      11036035      889480064  [Ljava.util.HashMap$Node;\r\n   5:      10886249      870899920  org.elasticsearch.action.admin.indices.stats.CommonStats\r\n   6:      10944341      700437824  org.elasticsearch.cluster.routing.ShardRouting\r\n   7:      21838600      698835200  java.util.Collections$UnmodifiableMap\r\n   8:      10888927      609779912  java.util.LinkedHashMap\r\n   9:      11072686      531488928  java.util.HashMap\r\n  10:      10885985      522527280  org.elasticsearch.action.admin.indices.stats.ShardStats\r\n  11:      10885985      435439400  org.elasticsearch.index.seqno.SeqNoStats\r\n  12:         30990      392283384  [B\r\n  13:      10885986      348351552  org.elasticsearch.index.seqno.RetentionLeases\r\n  14:      10885985      348351520  org.elasticsearch.index.engine.CommitStats\r\n  15:      11002724      264065376  java.util.Collections$SingletonList\r\n  16:      11002472      264059328  org.elasticsearch.index.Index\r\n  17:      10972905      263349720  org.elasticsearch.index.shard.ShardId\r\n  18:      10944339      262664136  org.elasticsearch.cluster.routing.AllocationId\r\n  19:       5474469      218978760  org.elasticsearch.index.shard.DocsStats\r\n  20:      10885985      174175760  org.elasticsearch.index.seqno.RetentionLeaseStats\r\n  21:       5469798      131275152  org.elasticsearch.index.store.StoreStats\r\n\r\n```\r\n\r\nThis can be easily reproduced by placing some sleep on `TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler#messageReceived` and invoking the `REST _stats` API periodically","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}