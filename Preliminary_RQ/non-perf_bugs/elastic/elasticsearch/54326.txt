{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54326","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54326/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54326/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54326/events","html_url":"https://github.com/elastic/elasticsearch/issues/54326","id":589071997,"node_id":"MDU6SXNzdWU1ODkwNzE5OTc=","number":54326,"title":"[ML] Integrate data frame analytics with ML upgrade mode","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"}],"state":"closed","locked":false,"assignee":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"assignees":[{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-03-27T11:35:34Z","updated_at":"2020-07-03T17:54:12Z","closed_at":"2020-07-03T17:54:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In 6.7 we added an \"upgrade mode\" to ML.  When ML upgrade mode is enabled, ML persistent tasks and endpoints are prevented from modifying ML internal indices.  The intention is that ML upgrade mode be enabled while ML internal indices are undergoing reindexing or other maintenance operations.  It can also optionally be enabled to reduce churn of ML persistent tasks during rolling upgrades.\r\n\r\nThe work to add this functionality to anomaly detection was done in #37837, #37942 and #38040.\r\n\r\nAs data frame analytics and inference become more mature and widely used we need to ensure ML upgrade mode has sensible effects on these features.\r\n\r\nAdditionally, there may be areas where we may have accidentally introduced loopholes into the way ML upgrade mode works with anomaly detection.\r\n\r\nThe following work items are required:\r\n\r\n1. Have we introduced more anomaly detection functionality into 7.x that could result in a write to an ML index when ML upgrade mode is enabled?  (Maybe auto-generated notifications or annotations?  Maybe retrying results writes?  But this needs some research.)  If so, add guards so that we don't write to ML internal indices that might be undergoing maintenance.\r\n2. Make sure that data frame analytics persistent tasks are unassigned when ML upgrade mode is set, and given an assignment reason that will mean they will not be considered to have failed and will get reassigned when ML upgrade mode is disabled again.\r\n3. Consider what we should do about inference when ML upgrade mode is enabled.  The key requirement is that we don't read or write any ML internal indices while upgrade mode is enabled.  Existing inference ingest processors with models loaded locally should be fine to continue.  Guards need to be put around accesses to the `.ml-inference` index.  (Inference and upgrade mode could get far more complicated when we start to use native processes on other nodes to do inference.)","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}