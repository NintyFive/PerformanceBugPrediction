{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10951","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10951/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10951/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10951/events","html_url":"https://github.com/elastic/elasticsearch/issues/10951","id":72992164,"node_id":"MDU6SXNzdWU3Mjk5MjE2NA==","number":10951,"title":"Allocation of replicas failed since 1.4.4 -> 1.4.5 upgrade (works again after upgrading more nodes)","user":{"login":"rtoma","id":2914051,"node_id":"MDQ6VXNlcjI5MTQwNTE=","avatar_url":"https://avatars2.githubusercontent.com/u/2914051?v=4","gravatar_id":"","url":"https://api.github.com/users/rtoma","html_url":"https://github.com/rtoma","followers_url":"https://api.github.com/users/rtoma/followers","following_url":"https://api.github.com/users/rtoma/following{/other_user}","gists_url":"https://api.github.com/users/rtoma/gists{/gist_id}","starred_url":"https://api.github.com/users/rtoma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtoma/subscriptions","organizations_url":"https://api.github.com/users/rtoma/orgs","repos_url":"https://api.github.com/users/rtoma/repos","events_url":"https://api.github.com/users/rtoma/events{/privacy}","received_events_url":"https://api.github.com/users/rtoma/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-05-04T11:06:19Z","updated_at":"2015-07-13T19:32:13Z","closed_at":"2015-05-04T14:53:06Z","author_association":"NONE","active_lock_reason":null,"body":"Since upgrading a single node in a 10 node cluster from 1.4.4 to 1.4.5 we get unassigned replicas for all new indices created after the \"010\" node got upgraded.\n\nExample _cat/shards/xxx below:\n\n```\nindex                          shard prirep state        docs  store ip            node\nlogstash-tst-endeca-2015.05.03 0     p      STARTED    214976 71.5mb 10.98.252.118 shd-logsearch-db-010.esaccdata10\nlogstash-tst-endeca-2015.05.03 0     r      UNASSIGNED\nlogstash-tst-endeca-2015.05.03 1     p      STARTED    214879 72.7mb 10.98.252.118 shd-logsearch-db-010.esaccdata10\nlogstash-tst-endeca-2015.05.03 1     r      UNASSIGNED\nlogstash-tst-endeca-2015.05.03 2     p      STARTED    214957 70.9mb 10.98.252.118 shd-logsearch-db-010.esaccdata10\nlogstash-tst-endeca-2015.05.03 2     r      UNASSIGNED\n```\n\nChanging number of replicas to any other number (even 0 and back to 1) does not fix this.\n\nRerouting shards is not allowed because of `NO(target node version [1.4.4] is older than source node version [1.4.5])`\n\nI have never seen this behaviour. Many times we upgraded rolling over the span of multiple days, with new indices created at every day rollover.\n\nI already checked the changelog of 1.4.5 but could not find anything related. Still I believe this is a bug.\n\nFull output of reroute command:\n\n```\n{\"error\":\"RemoteTransportException[[shd-logsearch-db-007.esaccmaster07\ninet[/10.98.252.198:9300]\ncluster:admin/reroute]]; nested: ElasticsearchIllegalArgumentException[[move_allocation] can't move [logstash-tst-endeca-2015.05.03\n0], from [shd-logsearch-db-010.esaccdata10\nNP3t4GAkRl2emR07pZw97A\nshd-logsearch-db-010.bolcom.net\ninet[/10.98.252.118:9300]]{datacenter=ams5, zone=shd-logsearch-db-010, master=false}, to [shd-logsearch-db-007.esaccdata07\nIHd_NcH4TVCcD7uibZzX6w\nshd-logsearch-db-007.bolcom.net\ninet[/10.98.252.115:9300]]{datacenter=ams4, zone=shd-logsearch-db-007, master=false}, since its not allowed, reason: [\nYES(shard is not allocated to same node or host)\nYES(node passes include/exclude/require filters)\nYES(shard is primary)\nYES(below shard recovery limit of [2])\nYES(allocation disabling is ignored)\nYES(allocation disabling is ignored)\nYES(node meets awareness requirements)\nYES(total shard limit disabled: [-1] <= 0)\nNO(target node version [1.4.4] is older than source node version [1.4.5])\nYES(enough disk for shard on node, free: [3.5tb])\nYES(no snapshots are currently running)]]; \",\"status\":400}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}