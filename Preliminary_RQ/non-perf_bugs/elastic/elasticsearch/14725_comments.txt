[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156364664","html_url":"https://github.com/elastic/elasticsearch/issues/14725#issuecomment-156364664","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14725","id":156364664,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NjM2NDY2NA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2015-11-13T08:51:14Z","updated_at":"2015-11-13T08:51:14Z","author_association":"MEMBER","body":"Thank for reporting.\n\n>  causes replica shard allocation failure\n\nCan you clarify some more about actually fails?\n\nAny chance you can share a heap dump of the tribe node? you can reach me privately on first name at elastic.co \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156638638","html_url":"https://github.com/elastic/elasticsearch/issues/14725#issuecomment-156638638","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14725","id":156638638,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NjYzODYzOA==","user":{"login":"yanjunh","id":1834562,"node_id":"MDQ6VXNlcjE4MzQ1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/1834562?v=4","gravatar_id":"","url":"https://api.github.com/users/yanjunh","html_url":"https://github.com/yanjunh","followers_url":"https://api.github.com/users/yanjunh/followers","following_url":"https://api.github.com/users/yanjunh/following{/other_user}","gists_url":"https://api.github.com/users/yanjunh/gists{/gist_id}","starred_url":"https://api.github.com/users/yanjunh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yanjunh/subscriptions","organizations_url":"https://api.github.com/users/yanjunh/orgs","repos_url":"https://api.github.com/users/yanjunh/repos","events_url":"https://api.github.com/users/yanjunh/events{/privacy}","received_events_url":"https://api.github.com/users/yanjunh/received_events","type":"User","site_admin":false},"created_at":"2015-11-14T05:48:21Z","updated_at":"2015-11-14T05:48:21Z","author_association":"CONTRIBUTOR","body":"The failure is [cluster.action.shard     ]. Here is part of the log message \n\nat[2015-11-12T17:03:45.861Z], details[Failed to perform [indices:data/write/bulk[s]] on replica, message [RemoteTransportException[[elk][inet[/10.29.22.33:9300]][indices:data/write/bulk[s][r]]]; nested: IllegalArgumentException[cannot change DocValues type from SORTED_NUMERIC to SORTED_SET for field \"msg_.log_events.sql_query_args\"]; ]]]\nThe cluster keeps trying to assign the shard, fail and then try to assign it again.\n\nI took a heap histogram. there are large number of org.elasticsearch.cluster.routing.MutableShardRouting and it's super class ImmutableShardRouting. I suspect that large number of MutableShardRouting objects were created due to shard allocation thrashing. After we fixed the shard allocation thrashing, the tribe node heap usage eventually dropped. Seems there is a cleanup thread somewhere to remove reference to these object so GC can reclaim the space eventually. But when the heap is completely full, the cleanup thread can't run and the process hangs. Interestingly, this only affects tribe nodes. This is just a guess, I havent got time to trace deep into the code.\n\n## num     #instances         #bytes  class name\n\n   1:        301316     2863097560  [B\n   2:      58282801     2373602544  [Ljava.lang.Object;\n   3:      30699477     2210362344  org.elasticsearch.cluster.routing.MutableShardRouting\n   4:      84192914     2020629936  org.elasticsearch.common.collect.SingletonImmutableList\n   5:      29040738     1847249696  [C\n   6:      26343947     1686012608  org.elasticsearch.cluster.routing.ImmutableShardRouting\n   7:      40972736     1311127552  org.elasticsearch.common.collect.RegularImmutableList\n   8:      44864300     1076743200  org.elasticsearch.index.shard.ShardId\n   9:      13255026      848321664  org.elasticsearch.cluster.routing.IndexShardRoutingTable\n  10:      44864300      717828800  org.elasticsearch.index.Index\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156678348","html_url":"https://github.com/elastic/elasticsearch/issues/14725#issuecomment-156678348","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14725","id":156678348,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NjY3ODM0OA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2015-11-14T09:46:30Z","updated_at":"2015-11-14T09:46:30Z","author_association":"MEMBER","body":"I see thanks. The shard issues caused many clusters state to be published (with each failure and allocation). The tribe node at the moment doesn't have batching support when processing the changes and it seems the cluster state just piled up waiting to be processed. We are working to add batch (see #13627). Normal nodes have this already. \n\nI'm going to close this as it seems to be already covered by the PR I referenced.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156859225","html_url":"https://github.com/elastic/elasticsearch/issues/14725#issuecomment-156859225","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14725","id":156859225,"node_id":"MDEyOklzc3VlQ29tbWVudDE1Njg1OTIyNQ==","user":{"login":"yanjunh","id":1834562,"node_id":"MDQ6VXNlcjE4MzQ1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/1834562?v=4","gravatar_id":"","url":"https://api.github.com/users/yanjunh","html_url":"https://github.com/yanjunh","followers_url":"https://api.github.com/users/yanjunh/followers","following_url":"https://api.github.com/users/yanjunh/following{/other_user}","gists_url":"https://api.github.com/users/yanjunh/gists{/gist_id}","starred_url":"https://api.github.com/users/yanjunh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yanjunh/subscriptions","organizations_url":"https://api.github.com/users/yanjunh/orgs","repos_url":"https://api.github.com/users/yanjunh/repos","events_url":"https://api.github.com/users/yanjunh/events{/privacy}","received_events_url":"https://api.github.com/users/yanjunh/received_events","type":"User","site_admin":false},"created_at":"2015-11-15T21:58:15Z","updated_at":"2015-11-15T21:58:15Z","author_association":"CONTRIBUTOR","body":"Cool. Thanks! I will take a look at the diff, just for my education. \n","performed_via_github_app":null}]