[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92328084","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-92328084","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":92328084,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzI4MDg0","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T12:03:19Z","updated_at":"2015-04-13T12:03:19Z","author_association":"CONTRIBUTOR","body":"@imotov any ideas here?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92329909","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-92329909","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":92329909,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzI5OTA5","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T12:07:34Z","updated_at":"2015-04-13T12:07:34Z","author_association":"MEMBER","body":"@clintongormley not sure I tried to reproduce the issue with cleanup script that @vanga described in https://github.com/imotov/elasticsearch-snapshot-cleanup/issues/2 but I cannot. The issue itself seems to be a duplicate of #9924 and should be fixed in 1.4.5. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92330222","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-92330222","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":92330222,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzMwMjIy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T12:08:30Z","updated_at":"2015-04-13T12:08:30Z","author_association":"CONTRIBUTOR","body":"thanks @imotov \n\n@vanga sounds like you will need to upgrade.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92330762","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-92330762","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":92330762,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzMwNzYy","user":{"login":"vanga","id":5126396,"node_id":"MDQ6VXNlcjUxMjYzOTY=","avatar_url":"https://avatars3.githubusercontent.com/u/5126396?v=4","gravatar_id":"","url":"https://api.github.com/users/vanga","html_url":"https://github.com/vanga","followers_url":"https://api.github.com/users/vanga/followers","following_url":"https://api.github.com/users/vanga/following{/other_user}","gists_url":"https://api.github.com/users/vanga/gists{/gist_id}","starred_url":"https://api.github.com/users/vanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vanga/subscriptions","organizations_url":"https://api.github.com/users/vanga/orgs","repos_url":"https://api.github.com/users/vanga/repos","events_url":"https://api.github.com/users/vanga/events{/privacy}","received_events_url":"https://api.github.com/users/vanga/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T12:10:50Z","updated_at":"2015-04-13T12:10:50Z","author_association":"NONE","body":"@clintongormley .. If I update to version > 1.4.5 , this issue will go away and i can start taking snapshots?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92332249","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-92332249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":92332249,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMzMyMjQ5","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-13T12:17:53Z","updated_at":"2015-04-13T12:17:53Z","author_association":"CONTRIBUTOR","body":"@vanga sounds like that is the case (but you'll need to upgrade to 1.5.1, as 1.4.5 has not been released yet)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/95890118","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-95890118","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":95890118,"node_id":"MDEyOklzc3VlQ29tbWVudDk1ODkwMTE4","user":{"login":"vanga","id":5126396,"node_id":"MDQ6VXNlcjUxMjYzOTY=","avatar_url":"https://avatars3.githubusercontent.com/u/5126396?v=4","gravatar_id":"","url":"https://api.github.com/users/vanga","html_url":"https://github.com/vanga","followers_url":"https://api.github.com/users/vanga/followers","following_url":"https://api.github.com/users/vanga/following{/other_user}","gists_url":"https://api.github.com/users/vanga/gists{/gist_id}","starred_url":"https://api.github.com/users/vanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vanga/subscriptions","organizations_url":"https://api.github.com/users/vanga/orgs","repos_url":"https://api.github.com/users/vanga/repos","events_url":"https://api.github.com/users/vanga/events{/privacy}","received_events_url":"https://api.github.com/users/vanga/received_events","type":"User","site_admin":false},"created_at":"2015-04-24T10:47:50Z","updated_at":"2015-04-24T10:47:50Z","author_association":"NONE","body":"We have joined new nodes to the clsuter with 1.5.1 version and removed old nodes. New cluster doesn't have the problem . \nThanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169493579","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169493579","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169493579,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTQ5MzU3OQ==","user":{"login":"allthedrones","id":2430029,"node_id":"MDQ6VXNlcjI0MzAwMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/2430029?v=4","gravatar_id":"","url":"https://api.github.com/users/allthedrones","html_url":"https://github.com/allthedrones","followers_url":"https://api.github.com/users/allthedrones/followers","following_url":"https://api.github.com/users/allthedrones/following{/other_user}","gists_url":"https://api.github.com/users/allthedrones/gists{/gist_id}","starred_url":"https://api.github.com/users/allthedrones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allthedrones/subscriptions","organizations_url":"https://api.github.com/users/allthedrones/orgs","repos_url":"https://api.github.com/users/allthedrones/repos","events_url":"https://api.github.com/users/allthedrones/events{/privacy}","received_events_url":"https://api.github.com/users/allthedrones/received_events","type":"User","site_admin":false},"created_at":"2016-01-06T23:19:53Z","updated_at":"2016-01-06T23:19:53Z","author_association":"NONE","body":"I'm experiencing this issue in 1.6.1 ... or at least a _very_ similar issue; in my case, the snapshot state (as reported by ~/_snapshot/repo/_status) is ABORTED, but the hung shard still reports a stage of \"STARTED\". Curiously, the output from ~/_snapshot/repo/_all does not agree with the output from .../_status -- it shows the hung snapshot as \"IN_PROGRESS\". Issuing a REST call to DELETE the target snapshot hangs indefinitely -- never returns, and never times out (I also couldn't find any relevant activity in pending_tasks, hot_threads, nor the log files).\n\nFor clarity, the master node did not restart, suffer a network partition, etc ... there was no interruption of any kind during the time the snapshot was running and nothing in the logs on the master node or the node with the 'stuck' shard. The repo _is_ using the Azure plugin. The indices (1 per snapshot) being snapshot'd are large so the operation is long running ... typically between 30 and 90 minutes. This cluster has never run any version other than 1.6.1, and there are no other clusters pointing to this Azure container, etc.\n\nNothing but a full restart seems to fix this problem. I expected, based on https://github.com/elastic/elasticsearch/pull/11450, that I would be able to clean this up by simply restarting the current master and allowing one of the other two [dedicated] master nodes to be elected, but that wasn't enough to fix the problem (I tried twice for good measure). I wasn't able to get @imotov 's snapshot cleanup tool to build against 1.6.1 (maybe due to #15427?). As long as the snapshot is stuck in this state, I cannot initiate other snapshots, the `reroute` API refuses to move the affected shard, and `_close`ing the index goes badly, because all shards report as unallocated (index=red), but the index will not fully close (nor re-open) because the shard is more or less 'locked' by the stuck snapshot.\n\nThe downtime from a full restart is unacceptable in production so this is currently preventing me from being able to use snapshots there, but I have a non-production cluster currently exhibiting the problem and I'll leave it in this 'stuck' state for a bit so I can answer any questions or produce API outputs, etc.\n\nI uploaded some relevant output (/_shapshot/repo/_all, /_snapshot/repo/_status, /index/_stats?level=shards) here: https://gist.github.com/allthedrones/898f282be33a33dfec67\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169512227","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169512227","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169512227,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTUxMjIyNw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T00:54:49Z","updated_at":"2016-01-07T00:54:49Z","author_association":"MEMBER","body":"@allthedrones could you post the snapshot section of `_cluster/state`?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169560497","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169560497","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169560497,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTU2MDQ5Nw==","user":{"login":"allthedrones","id":2430029,"node_id":"MDQ6VXNlcjI0MzAwMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/2430029?v=4","gravatar_id":"","url":"https://api.github.com/users/allthedrones","html_url":"https://github.com/allthedrones","followers_url":"https://api.github.com/users/allthedrones/followers","following_url":"https://api.github.com/users/allthedrones/following{/other_user}","gists_url":"https://api.github.com/users/allthedrones/gists{/gist_id}","starred_url":"https://api.github.com/users/allthedrones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allthedrones/subscriptions","organizations_url":"https://api.github.com/users/allthedrones/orgs","repos_url":"https://api.github.com/users/allthedrones/repos","events_url":"https://api.github.com/users/allthedrones/events{/privacy}","received_events_url":"https://api.github.com/users/allthedrones/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T05:46:07Z","updated_at":"2016-01-07T05:46:07Z","author_association":"NONE","body":"Here's the snapshot section of `_cluster/state`. I verified that the other two url endpoints under `_snapshot` still return the same results as posted earlier, and that attempting DELETE on the snapshot still hangs. Strange that all 3 places report slightly different statuses for the snapshot!\n\n```\n\"snapshots\" : [{\n    \"repository\" : \"my_stuff\",\n    \"snapshot\" : \"idx-15923\",\n    \"include_global_state\" : false,\n    \"state\" : \"ABORTED\",\n    \"indices\" : [ \"idx-15923\" ],\n    \"shards\" : [ {\n      \"index\" : \"idx-15923\",\n      \"shard\" : 3,\n      \"state\" : \"SUCCESS\",\n      \"node\" : \"cvnYD0WlQEi9-AmEiHTC4g\"\n    }, {\n      \"index\" : \"idx-15923\",\n      \"shard\" : 4,\n      \"state\" : \"SUCCESS\",\n      \"node\" : \"rloJ197jS9eSWiDqy29QHA\"\n    }, {\n      \"index\" : \"idx-15923\",\n      \"shard\" : 1,\n      \"state\" : \"ABORTED\",\n      \"node\" : \"q-F03vzxTBqdbUojCWeY9g\"\n    }, {\n      \"index\" : \"idx-15923\",\n      \"shard\" : 2,\n      \"state\" : \"SUCCESS\",\n      \"node\" : \"KFVhLk0eRDmuGxLzZ1HEww\"\n    }, {\n      \"index\" : \"idx-15923\",\n      \"shard\" : 0,\n      \"state\" : \"SUCCESS\",\n      \"node\" : \"FZ8pwJqsTgiz2rvDCBVrgw\"\n    } ]\n}]\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169564327","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169564327","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169564327,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTU2NDMyNw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T06:06:45Z","updated_at":"2016-01-07T06:06:45Z","author_association":"MEMBER","body":"@allthedrones is the node `q-F03vzxTBqdbUojCWeY9g` still part of the cluster? If it is, could you run the following command and post here the result \n\n`curl localhost:9200/_nodes/q-F03vzxTBqdbUojCWeY9g/hot_threads?threads=1000`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169669086","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169669086","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169669086,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTY2OTA4Ng==","user":{"login":"allthedrones","id":2430029,"node_id":"MDQ6VXNlcjI0MzAwMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/2430029?v=4","gravatar_id":"","url":"https://api.github.com/users/allthedrones","html_url":"https://github.com/allthedrones","followers_url":"https://api.github.com/users/allthedrones/followers","following_url":"https://api.github.com/users/allthedrones/following{/other_user}","gists_url":"https://api.github.com/users/allthedrones/gists{/gist_id}","starred_url":"https://api.github.com/users/allthedrones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allthedrones/subscriptions","organizations_url":"https://api.github.com/users/allthedrones/orgs","repos_url":"https://api.github.com/users/allthedrones/repos","events_url":"https://api.github.com/users/allthedrones/events{/privacy}","received_events_url":"https://api.github.com/users/allthedrones/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T13:51:08Z","updated_at":"2016-01-07T13:51:08Z","author_association":"NONE","body":"@imotov Here's the `hot_threads` result. The last block looks relevant ... like maybe a stream read operation from the Azure repo connector is waiting indefinitely?\n\n```\n::: [mc2-ed6][q-F03vzxTBqdbUojCWeY9g][mc2-ed6][inet[/10.31.0.11:9300]]{master=false}\n   Hot threads at 2016-01-07T13:40:47.042Z, interval=500ms, busiestThreads=1000, ignoreIdleThreads=true:\n\n    3.9% (19.5ms out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][bulk][T#2]'\n     2/10 snapshots sharing following 2 elements\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n\n    2.5% (12.3ms out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][bulk][T#3]'\n     3/10 snapshots sharing following 2 elements\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.6% (2.8ms out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][bulk][T#4]'\n     2/10 snapshots sharing following 10 elements\n       org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:371)\n       org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:511)\n       org.elasticsearch.action.bulk.TransportShardBulkAction.shardIndexOperation(TransportShardBulkAction.java:413)\n       org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:148)\n       org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$PrimaryPhase.performOnPrimary(TransportShardReplicationOperationAction.java:574)\n       org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$PrimaryPhase$1.doRun(TransportShardReplicationOperationAction.java:440)\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n     unique snapshot\n       sun.misc.Unsafe.park(Native Method)\n       java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n       java.util.concurrent.LinkedTransferQueue.awaitMatch(LinkedTransferQueue.java:737)\n       java.util.concurrent.LinkedTransferQueue.xfer(LinkedTransferQueue.java:647)\n       java.util.concurrent.LinkedTransferQueue.take(LinkedTransferQueue.java:1269)\n       org.elasticsearch.common.util.concurrent.SizeBlockingQueue.take(SizeBlockingQueue.java:162)\n       java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.5% (2.6ms out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][bulk][T#1]'\n     3/10 snapshots sharing following 2 elements\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.0% (205.7micros out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][transport_client_timer][T#1]{Hashed wheel timer #1}'\n     10/10 snapshots sharing following 5 elements\n       java.lang.Thread.sleep(Native Method)\n       org.elasticsearch.common.netty.util.HashedWheelTimer$Worker.waitForNextTick(HashedWheelTimer.java:445)\n       org.elasticsearch.common.netty.util.HashedWheelTimer$Worker.run(HashedWheelTimer.java:364)\n       org.elasticsearch.common.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.0% (0s out of 500ms) cpu usage by thread 'elasticsearch[mc2-ed6][snapshot][T#1]'\n     10/10 snapshots sharing following 21 elements\n       sun.misc.Unsafe.park(Native Method)\n       java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n       java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)\n       java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)\n       java.util.concurrent.ExecutorCompletionService.take(ExecutorCompletionService.java:193)\n       com.microsoft.azure.storage.blob.BlobOutputStream.waitForTaskToComplete(BlobOutputStream.java:456)\n       com.microsoft.azure.storage.blob.BlobOutputStream.dispatchWrite(BlobOutputStream.java:348)\n       com.microsoft.azure.storage.blob.BlobOutputStream.writeInternal(BlobOutputStream.java:578)\n       com.microsoft.azure.storage.blob.BlobOutputStream.write(BlobOutputStream.java:506)\n       com.microsoft.azure.storage.blob.BlobOutputStream.write(BlobOutputStream.java:482)\n       com.microsoft.azure.storage.blob.BlobOutputStream.write(BlobOutputStream.java:541)\n       org.elasticsearch.cloud.azure.blobstore.AzureOutputStream.write(AzureOutputStream.java:35)\n       java.io.OutputStream.write(OutputStream.java:116)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$SnapshotContext.snapshotFile(BlobStoreIndexShardRepository.java:564)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$SnapshotContext.snapshot(BlobStoreIndexShardRepository.java:507)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.snapshot(BlobStoreIndexShardRepository.java:140)\n       org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.snapshot(IndexShardSnapshotAndRestoreService.java:85)\n       org.elasticsearch.snapshots.SnapshotsService$5.run(SnapshotsService.java:871)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.0% (0s out of 500ms) cpu usage by thread 'DestroyJavaVM'\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n     unique snapshot\n\n    0.0% (0s out of 500ms) cpu usage by thread 'elasticsearch[keepAlive/1.6.1]'\n     10/10 snapshots sharing following 8 elements\n       sun.misc.Unsafe.park(Native Method)\n       java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n       java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)\n       java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)\n       java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)\n       java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)\n       org.elasticsearch.bootstrap.Bootstrap$4.run(Bootstrap.java:267)\n       java.lang.Thread.run(Thread.java:745)\n\n    0.0% (0s out of 500ms) cpu usage by thread 'pool-3853-thread-1'\n     10/10 snapshots sharing following 23 elements\n       java.net.SocketInputStream.socketRead0(Native Method)\n       java.net.SocketInputStream.socketRead(SocketInputStream.java:116)\n       java.net.SocketInputStream.read(SocketInputStream.java:170)\n       java.net.SocketInputStream.read(SocketInputStream.java:141)\n       java.io.BufferedInputStream.fill(BufferedInputStream.java:246)\n       java.io.BufferedInputStream.read1(BufferedInputStream.java:286)\n       java.io.BufferedInputStream.read(BufferedInputStream.java:345)\n       sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:704)\n       sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:647)\n       sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1536)\n       sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1441)\n       java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)\n       com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:124)\n       com.microsoft.azure.storage.blob.CloudBlockBlob.uploadBlockInternal(CloudBlockBlob.java:714)\n       com.microsoft.azure.storage.blob.CloudBlockBlob.uploadBlock(CloudBlockBlob.java:686)\n       com.microsoft.azure.storage.blob.BlobOutputStream$1.call(BlobOutputStream.java:362)\n       com.microsoft.azure.storage.blob.BlobOutputStream$1.call(BlobOutputStream.java:358)\n       java.util.concurrent.FutureTask.run(FutureTask.java:266)\n       java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n       java.util.concurrent.FutureTask.run(FutureTask.java:266)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169674409","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169674409","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169674409,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTY3NDQwOQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T14:09:14Z","updated_at":"2016-01-07T14:48:17Z","author_association":"MEMBER","body":"@allthedrones indeed the 6th block and the last block show stuck azure operations. It looks like azure never came back with responses for these requests. I think this problem has been [fixed](https://github.com/elastic/elasticsearch/issues/14277) for the next major release, but the only solution for 1.6.1 that I can think of is to restart the node where azure is stuck. \n\n@dadoonet, @tlrx what do you think?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169684925","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169684925","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169684925,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTY4NDkyNQ==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T14:51:30Z","updated_at":"2016-01-07T14:51:30Z","author_association":"MEMBER","body":"I agree with your analysis @imotov. The azure client until #15080 wait indefinitely. There is no way to unblock it without restarting the node.\n\nI wonder then if we should backport the change #15080 in 2.x branch.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169690968","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169690968","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169690968,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTY5MDk2OA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T15:16:21Z","updated_at":"2016-01-07T15:16:21Z","author_association":"MEMBER","body":"@dadoonet I think it would be reasonable to backport it to 2.x branch considering the impact on the users. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/169697774","html_url":"https://github.com/elastic/elasticsearch/issues/10564#issuecomment-169697774","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10564","id":169697774,"node_id":"MDEyOklzc3VlQ29tbWVudDE2OTY5Nzc3NA==","user":{"login":"allthedrones","id":2430029,"node_id":"MDQ6VXNlcjI0MzAwMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/2430029?v=4","gravatar_id":"","url":"https://api.github.com/users/allthedrones","html_url":"https://github.com/allthedrones","followers_url":"https://api.github.com/users/allthedrones/followers","following_url":"https://api.github.com/users/allthedrones/following{/other_user}","gists_url":"https://api.github.com/users/allthedrones/gists{/gist_id}","starred_url":"https://api.github.com/users/allthedrones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/allthedrones/subscriptions","organizations_url":"https://api.github.com/users/allthedrones/orgs","repos_url":"https://api.github.com/users/allthedrones/repos","events_url":"https://api.github.com/users/allthedrones/events{/privacy}","received_events_url":"https://api.github.com/users/allthedrones/received_events","type":"User","site_admin":false},"created_at":"2016-01-07T15:36:43Z","updated_at":"2016-01-07T15:36:43Z","author_association":"NONE","body":"Thanks guys, I can confirm that restarting the node with the stalled shard corrects the problem. After restarting that data node, the snapshot in question was fully deleted and all of the snapshot URLs mentioned previously report a correct & consistent status. Restarting a single data node is a _much_ more acceptable impact than downtime for the whole cluster, so thank you again for your help arriving at a resolution & root cause.\n","performed_via_github_app":null}]