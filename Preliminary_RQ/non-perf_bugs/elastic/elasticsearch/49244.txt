{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49244","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49244/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49244/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49244/events","html_url":"https://github.com/elastic/elasticsearch/issues/49244","id":524357861,"node_id":"MDU6SXNzdWU1MjQzNTc4NjE=","number":49244,"title":"Master doesn't  delete the connection from `ConnectionManager.connectedNodes` with the node failing to join the cluster because of ValidateJoinRequest failure","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-11-18T13:10:09Z","updated_at":"2019-11-18T13:46:03Z","closed_at":"2019-11-18T13:45:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES_VERSION: 7.3.1\r\n**Description of the problem including expected versus actual behavior:**\r\nWhen the node want to join the cluster, the process is as below:\r\n1. The node will send join request to master.\r\n2. The master will connect to the node, including establishing five types of connections, and putting the five types of connections into `ConnectionManager.connectedNodes`.\r\n3. The master calls function `sendValidateJoinRequest` to send `internal:cluster/coordination/join/validate` to the node.\r\n4. The node receives the request and checks `clusterUUID` and `clusterUUIDCommitted`. check code: https://github.com/elastic/elasticsearch/blob/6681cc0df5029daf21584bc4406fa1616943b3b0/server/src/main/java/org/elasticsearch/cluster/coordination/JoinHelper.java#L135\r\n\r\n\r\nIf the node check that `clusterUUID` and `clusterUUIDCommitted` are not equal, it will throw exception and fail to join the cluster, but the master has established the connections with the node, if we don't release the connections, it will always exists in `ConnectionManager.connectedNodes` of master. In fact, we do not initiative release those connections in master.\r\n\r\nThe node  will establish five connections with other master-attribute nodes  in cluster before joining the cluster successfully, if the node fails to join the cluster, those connections will always exists, It may also be a problem.\r\n\r\nIf we should initiative release connections from `ConnectionManager.connectedNodes` in master when the node fails to join the cluster?  If the node should not  establish connections with other master-attribute nodes in cluster before the node joins to cluster successfully?","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}