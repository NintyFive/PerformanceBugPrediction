{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25555","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25555/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25555/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25555/events","html_url":"https://github.com/elastic/elasticsearch/issues/25555","id":240684510,"node_id":"MDU6SXNzdWUyNDA2ODQ1MTA=","number":25555,"title":"Shingles not working as expected","user":{"login":"fhelje","id":1276941,"node_id":"MDQ6VXNlcjEyNzY5NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/1276941?v=4","gravatar_id":"","url":"https://api.github.com/users/fhelje","html_url":"https://github.com/fhelje","followers_url":"https://api.github.com/users/fhelje/followers","following_url":"https://api.github.com/users/fhelje/following{/other_user}","gists_url":"https://api.github.com/users/fhelje/gists{/gist_id}","starred_url":"https://api.github.com/users/fhelje/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fhelje/subscriptions","organizations_url":"https://api.github.com/users/fhelje/orgs","repos_url":"https://api.github.com/users/fhelje/repos","events_url":"https://api.github.com/users/fhelje/events{/privacy}","received_events_url":"https://api.github.com/users/fhelje/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-07-05T15:13:36Z","updated_at":"2017-07-24T16:42:16Z","closed_at":"2017-07-24T16:42:16Z","author_association":"NONE","active_lock_reason":null,"body":"Im trying to use elastic to extract brands from a texts. For this I created a index containing brands a synonyms where the synonyms are analysed as keywords. I then search for brand with shingles (scripts to reproduce is below). This works great in elastic version 2.4.4. When I try this in elastic 5.4.3 it doesn't work at all, I looked at the data with the analyze endpoint and it looks like it should work.\r\n\r\nHad a disussion about how shingles work here: https://discuss.elastic.co/t/extracting-brands-in-documents-using-keyword-and-shingles/91873.\r\n\r\nWe agreed that this is a regression for elastic 5.4.3.\r\n\r\nScripts to reproduce:\r\n\r\n```\r\nPUT brand\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"my_analyzer_keyword\": {\r\n          \"type\": \"custom\",\r\n          \"tokenizer\": \"keyword\",\r\n          \"filter\": [\r\n            \"asciifolding\",\r\n            \"lowercase\"\r\n          ]\r\n        },\r\n        \"my_analyzer_shingle\": {\r\n          \"type\": \"custom\",\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"asciifolding\",\r\n            \"lowercase\",\r\n            \"shingle\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"brand\": {\r\n      \"properties\": {\r\n        \"keyword\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"my_analyzer_keyword\",\r\n          \"search_analyzer\": \"my_analyzer_shingle\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nSome documents:\r\n\r\n```\r\nPOST /brand/brand/1\r\n{\r\n  \"id\": 1,\r\n  \"keyword\": \"nike\"\r\n}\r\nPOST /brand/brand/2\r\n{\r\n  \"id\": 2,\r\n  \"keyword\": \"adidas originals\"\r\n}\r\n```\r\nI then search like this:\r\n```\r\nPOST /brand/brand/_search\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"keyword\": \"I like nike shoes and adidas originals\"\r\n    }\r\n  }\r\n}\r\n```\r\nI expect to get **nike** and **adidas originals** as the result but I don't get anything back.\r\n\r\nLooking at how this is analysed we see: \r\nQuery:\r\n```\r\nGET _analyze\r\n{\r\n   \"tokenizer\": \"standard\",\r\n   \"filter\": [\r\n      \"asciifolding\",\r\n      \"lowercase\",\r\n      \"shingle\"\r\n   ],\r\n   \"char_filter\": [\r\n      \"html_strip\"\r\n   ],\r\n   \"text\": [\r\n      \"I like nike shoes and adidas originals\"\r\n   ]\r\n}\r\n```\r\nResult (shortened for brevity):\r\n```\r\n{\r\n   \"tokens\": [\r\n      ...\r\n      {\r\n         \"token\": \"nike\",\r\n         \"start_offset\": 7,\r\n         \"end_offset\": 11,\r\n         \"type\": \"<ALPHANUM>\",\r\n         \"position\": 2\r\n      },\r\n      {\r\n         \"token\": \"nike shoes\",\r\n         \"start_offset\": 7,\r\n         \"end_offset\": 17,\r\n         \"type\": \"shingle\",\r\n         \"position\": 2,\r\n         \"positionLength\": 2\r\n      },\r\n      ...\r\n      {\r\n         \"token\": \"adidas\",\r\n         \"start_offset\": 22,\r\n         \"end_offset\": 28,\r\n         \"type\": \"<ALPHANUM>\",\r\n         \"position\": 5\r\n      },\r\n      {\r\n         \"token\": \"adidas originals\",\r\n         \"start_offset\": 22,\r\n         \"end_offset\": 38,\r\n         \"type\": \"shingle\",\r\n         \"position\": 5,\r\n         \"positionLength\": 2\r\n      },\r\n      {\r\n         \"token\": \"originals\",\r\n         \"start_offset\": 29,\r\n         \"end_offset\": 38,\r\n         \"type\": \"<ALPHANUM>\",\r\n         \"position\": 6\r\n      }\r\n   ]\r\n}\r\n```\r\nIndex:\r\n```\r\nGET _analyze\r\n{\r\n   \"tokenizer\": \"keyword\",\r\n   \"filter\": [\r\n      \"asciifolding\",\r\n      \"lowercase\"\r\n   ],\r\n   \"char_filter\": [\r\n      \"html_strip\"\r\n   ],\r\n   \"text\": [\r\n      \"adidas originals\"\r\n   ]\r\n}\r\n\r\n```\r\nResult:\r\n```\r\n{\r\n   \"tokens\": [\r\n      {\r\n         \"token\": \"adidas originals\",\r\n         \"start_offset\": 0,\r\n         \"end_offset\": 16,\r\n         \"type\": \"word\",\r\n         \"position\": 0\r\n      }\r\n   ]\r\n}\r\n```\r\nTried it on elastic version 2.4.4 and there it worked just fine.\r\n\r\nI got the expected result \r\n```\r\n{\r\n   \"took\": 73,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 2,\r\n      \"max_score\": 0.003867892,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"brand\",\r\n            \"_type\": \"brand\",\r\n            \"_id\": \"2\",\r\n            \"_score\": 0.003867892,\r\n            \"_source\": {\r\n               \"id\": 2,\r\n               \"keyword\": \"adidas originals\"\r\n            }\r\n         },\r\n         {\r\n            \"_index\": \"brand\",\r\n            \"_type\": \"brand\",\r\n            \"_id\": \"1\",\r\n            \"_score\": 0.003867892,\r\n            \"_source\": {\r\n               \"id\": 1,\r\n               \"keyword\": \"nike\"\r\n            }\r\n         }\r\n      ]\r\n   }\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}