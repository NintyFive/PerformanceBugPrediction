{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14832","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14832/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14832/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14832/events","html_url":"https://github.com/elastic/elasticsearch/issues/14832","id":117598610,"node_id":"MDU6SXNzdWUxMTc1OTg2MTA=","number":14832,"title":"Can we replace the field stats API with search/aggs?","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2015-11-18T14:31:11Z","updated_at":"2017-04-11T07:05:54Z","closed_at":"2017-04-11T07:05:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Most information that the field stats API returns can also be computed with our search API:\n- min value (min aggregation)\n- max value (max aggregation)\n- density (total hits of an exists query divided by the total hits of a match_all)\n\nSo for instance, you could get the min/max values of a field called `@timestamp` on all indices with the following aggregation:\n\n``` javascript\n{\n  \"aggs\": {\n    \"by_index\": {\n      \"terms\": {\n        \"field\": \"_index\"\n      },\n      \"aggs\": {\n        \"min_ts\": {\n          \"min\": {\n            \"field\": \"@timestamp\"\n          }\n        },\n        \"max_ts\": {\n          \"min\": {\n            \"field\": \"@timestamp\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe field stats also has field constraints, which could be implemented on top of the previous aggregations by adding a `bucket_selector` pipeline on the `by_index` aggregation:\n\n``` javascript\n{\n  \"aggs\": {\n    \"by_index\": {\n      \"terms\": {\n        \"field\": \"_index\"\n      },\n      \"aggs\": {\n        \"min_ts\": {\n          \"min\": {\n            \"field\": \"@timestamp\"\n          }\n        },\n        \"max_ts\": {\n          \"min\": {\n            \"field\": \"@timestamp\"\n          }\n        },\n        \"range_filter\": {\n          \"bucket_selector\": {\n            \"buckets_path\": {\n              \"min_ts\": \"min_ts\",\n              \"max_ts\": \"max_ts\"\n            },\n            \"script\": \"max_ts >= 1447718400000 && min_ts <= 1447804800000\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nAs-is this would perform more slowly than the field stats API because it would collect all documents. But I think not having the support this new field stats API is compelling. Moreover in case there are no deletions, we could have similar optimizations as the one we have when couting matches on a match_all when we can just leverage index stats.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}