[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137729","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-384137729","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":384137729,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzcyOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-01T23:40:22Z","updated_at":"2018-04-25T02:03:21Z","author_association":"COLLABORATOR","body":"*Original comment by @davidkyle:*\n\nI believe the reason is that the custom index may be used by another job i.e. multiple jobs can use the same dedicated index. The index can be deleted only if it is empty and no other jobs reference it","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137730","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-384137730","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":384137730,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzczMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-01T23:42:11Z","updated_at":"2018-05-04T11:53:11Z","author_association":"COLLABORATOR","body":"*Original comment by @droberts195:*\r\n\r\nThe reason this is tricky is that there's a mismatch between the backend functionality and the way it's presented in the UI.\r\n\r\nIn the backend there is no such thing as a dedicated index.  You _can_ specify a custom index for a job.  But many jobs can share the same custom index, so it does not follow that when a job with a custom index is deleted the index can also be deleted.\r\n\r\nThe UI presents the custom index functionality as dedicated index, and because of the way the UI creates custom index names, if the UI is the _only_ way you're utilising custom results indices then it's true that the custom indices can be deleted when their corresponding jobs are deleted.\r\n\r\nMaybe this problem can be covered by #29935","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137732","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-384137732","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":384137732,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzczMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-08T14:13:52Z","updated_at":"2018-05-04T11:53:24Z","author_association":"COLLABORATOR","body":"*Original comment by @dimitris-athanasiou:*\r\n\r\nWhile I agree #29935 is needed, we could deal with this particular case quite easily I think. When the job is deleted we can check if the index is empty and if no other job uses that index. If those 2 conditions are true, we can delete the index as well. Not sure about the priority here though.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386631445","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-386631445","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":386631445,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NjYzMTQ0NQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-05-04T15:09:11Z","updated_at":"2018-09-14T12:38:36Z","author_association":"CONTRIBUTOR","body":"We had a support case where a customer had a huge number of results in a custom results index that was only being used by one job.  They got frustrated with the job deletion process as it was going to take around 15 hours.  However, because it was a dedicated results index the deletion could have avoided delete-by-query altogether and just deleting the index.  So when we fix this issue we should implement this optimisation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412805130","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-412805130","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":412805130,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgwNTEzMA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T09:04:23Z","updated_at":"2018-09-14T12:19:10Z","author_association":"CONTRIBUTOR","body":"For part of the \"Optimize job deletion\" project for 6.5 we should fix this problem by dropping dedicated results indices _instead_ of deleting the results documents within them.\r\n\r\nIn other words, the check for dropping a results index should not be that it is empty once all results have been deleted, but whether the only `job_id` in the documents in the results index are for the job that's being deleted.\r\n\r\nWe should be able to do this by searching the index for documents where the `job_id` field exists but with a `must_not` filter of `job_id` equalling the ID of the job to be deleted.  The `size` of the query can be set to 1, as we only care if there is one result or many, just whether there are zero results or more.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412813221","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-412813221","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":412813221,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgxMzIyMQ==","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T09:34:12Z","updated_at":"2018-08-14T09:34:12Z","author_association":"CONTRIBUTOR","body":"The bit that is not clear to me about this is whether we can know for sure we can drop the index. In other words, is it possible that between us checking and dropping the index, another job has started indexing in that index?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412814707","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-412814707","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":412814707,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgxNDcwNw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T09:39:40Z","updated_at":"2018-08-14T09:39:40Z","author_association":"CONTRIBUTOR","body":"> is it possible that between us checking and dropping the index, another job has started indexing in that index?\r\n\r\nYes, but our indices are auto-created from templates, so in the unlikely event that this happens we'll only lose a tiny number of results.  I think it's a lesser evil than spending hours deleting results from an index that will end up empty.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/421341446","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-421341446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":421341446,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMTM0MTQ0Ng==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-09-14T12:20:12Z","updated_at":"2018-09-14T12:20:12Z","author_association":"CONTRIBUTOR","body":"We should probably also have a hard-coded rule that we never delete the default `.ml-anomalies-shared` index as part of a job deletion request.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/423117630","html_url":"https://github.com/elastic/elasticsearch/issues/30075#issuecomment-423117630","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30075","id":423117630,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMzExNzYzMA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-09-20T09:47:44Z","updated_at":"2018-09-20T09:47:44Z","author_association":"CONTRIBUTOR","body":"Closed by #33788.","performed_via_github_app":null}]