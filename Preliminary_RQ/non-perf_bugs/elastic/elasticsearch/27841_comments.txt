[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352104560","html_url":"https://github.com/elastic/elasticsearch/issues/27841#issuecomment-352104560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","id":352104560,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MjEwNDU2MA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-12-15T20:31:15Z","updated_at":"2017-12-15T20:31:15Z","author_association":"MEMBER","body":"> The content of the bool query doesn't seem to matter, as longs as there's at least one bool query in the array of filters, the result is wrong. I used an empty bool as an example for the sake of shortness\r\n\r\n@TrustNoOne thanks for opening this issue, I can reproduce the reported behaviour for empty bool query, however if I add a clause (e.g. a \"must\" clause) the response is as expected (without numeric key). Just adding this as a datapoint, the behaviour for an empty bool query is still stange and needs investigation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352105895","html_url":"https://github.com/elastic/elasticsearch/issues/27841#issuecomment-352105895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","id":352105895,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MjEwNTg5NQ==","user":{"login":"TrustNoOne","id":1575319,"node_id":"MDQ6VXNlcjE1NzUzMTk=","avatar_url":"https://avatars3.githubusercontent.com/u/1575319?v=4","gravatar_id":"","url":"https://api.github.com/users/TrustNoOne","html_url":"https://github.com/TrustNoOne","followers_url":"https://api.github.com/users/TrustNoOne/followers","following_url":"https://api.github.com/users/TrustNoOne/following{/other_user}","gists_url":"https://api.github.com/users/TrustNoOne/gists{/gist_id}","starred_url":"https://api.github.com/users/TrustNoOne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrustNoOne/subscriptions","organizations_url":"https://api.github.com/users/TrustNoOne/orgs","repos_url":"https://api.github.com/users/TrustNoOne/repos","events_url":"https://api.github.com/users/TrustNoOne/events{/privacy}","received_events_url":"https://api.github.com/users/TrustNoOne/received_events","type":"User","site_admin":false},"created_at":"2017-12-15T20:37:35Z","updated_at":"2017-12-15T20:46:08Z","author_association":"NONE","body":"@cbuescher  You are actually right. I thought this happened all the time, but it's only in some cases.\r\nIn my case I had a range query in the filter context, this reproduces the issue as well:\r\n\r\nedit: it's not the filter context, with must it's the same. It's apparently the range query (at least in my case). A term query doesn't do it. \r\n\r\n```json\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test\": {\r\n      \"filters\": {\r\n        \"filters\": [\r\n          {\r\n            \"bool\": {\r\n              \"filter\": {\r\n                \"range\": {\r\n                  \"somefield\": {\r\n                    \"gte\": 170071352479318000\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352755692","html_url":"https://github.com/elastic/elasticsearch/issues/27841#issuecomment-352755692","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","id":352755692,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mjc1NTY5Mg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T13:48:37Z","updated_at":"2017-12-19T13:48:37Z","author_association":"MEMBER","body":"So this is what I think happens here: the empty bool query gets rewritten internally to a MatchAllQueryBuilder, and as a follow up FiltersAggregationBuilder#doRewrite creates a new FiltersAggregationBuilder which doesn't correctly copy the original \"keyed\" field. I think that's the root cause of this and I will start working on a fix.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352865965","html_url":"https://github.com/elastic/elasticsearch/issues/27841#issuecomment-352865965","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","id":352865965,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mjg2NTk2NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T19:44:46Z","updated_at":"2017-12-19T19:44:46Z","author_association":"MEMBER","body":"@TrustNoOne thanks for reporting this, good catch. And thanks for the detailed description, it was easy to reproduce that way. Fix will be in next 6.1 release and onwards.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352866535","html_url":"https://github.com/elastic/elasticsearch/issues/27841#issuecomment-352866535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","id":352866535,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mjg2NjUzNQ==","user":{"login":"TrustNoOne","id":1575319,"node_id":"MDQ6VXNlcjE1NzUzMTk=","avatar_url":"https://avatars3.githubusercontent.com/u/1575319?v=4","gravatar_id":"","url":"https://api.github.com/users/TrustNoOne","html_url":"https://github.com/TrustNoOne","followers_url":"https://api.github.com/users/TrustNoOne/followers","following_url":"https://api.github.com/users/TrustNoOne/following{/other_user}","gists_url":"https://api.github.com/users/TrustNoOne/gists{/gist_id}","starred_url":"https://api.github.com/users/TrustNoOne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrustNoOne/subscriptions","organizations_url":"https://api.github.com/users/TrustNoOne/orgs","repos_url":"https://api.github.com/users/TrustNoOne/repos","events_url":"https://api.github.com/users/TrustNoOne/events{/privacy}","received_events_url":"https://api.github.com/users/TrustNoOne/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T19:47:00Z","updated_at":"2017-12-19T19:47:00Z","author_association":"NONE","body":"sure thing! thanks for fixing it that fast","performed_via_github_app":null}]