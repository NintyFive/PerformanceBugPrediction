[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/456310872","html_url":"https://github.com/elastic/elasticsearch/issues/37685#issuecomment-456310872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37685","id":456310872,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NjMxMDg3Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-22T08:25:10Z","updated_at":"2019-01-22T08:25:10Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461341915","html_url":"https://github.com/elastic/elasticsearch/issues/37685#issuecomment-461341915","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37685","id":461341915,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTM0MTkxNQ==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T09:17:35Z","updated_at":"2019-02-07T09:17:35Z","author_association":"CONTRIBUTOR","body":"```\r\n 1> [2019-01-21T06:28:10,583][INFO ][o.e.d.DiscoveryDisruptionIT] [testClusterJoinDespiteOfPublishingIssues] blocking requests from non master [node_td1] to master [node_tm0]\r\n  1> [2019-01-21T06:28:10,861][DEBUG][o.e.c.c.ElectionSchedulerFactory] [node_tm0] scheduleNextElection{gracePeriod=500ms, thisAttempt=1, maxDelayMillis=200, delayMillis=543, ElectionScheduler{attempt=2, ElectionSchedulerFactory{initialTimeout=100ms, backoffTime=100ms, maxTimeout=10s}}} not starting election\r\n  1> [2019-01-21T06:28:11,556][DEBUG][o.e.c.c.LeaderChecker    ] [node_td1] closed check scheduler received a response, doing nothing\r\n  1> [2019-01-21T06:28:11,556][DEBUG][o.e.c.c.Coordinator      ] [node_td1] onLeaderFailure: coordinator becoming CANDIDATE in term 1 (was FOLLOWER, lastKnownLeader was [Optional[{node_tm0}{udr7-Lv4R2iFJUccsZ5O-w}{3ZEQc9CqRDWpnGqv-il6mg}{127.0.0.1}{127.0.0.1:33362}]])\r\n  1> [2019-01-21T06:28:11,557][DEBUG][o.e.c.s.ClusterApplierService] [node_td1] processing [becoming candidate: onLeaderFailure]: execute\r\n  1> [2019-01-21T06:28:11,556][DEBUG][o.e.t.TransportService   ] [node_td1] Exception while sending request, handler likely already notified due to timeout\r\n  1> [2019-01-21T06:28:11,557][TRACE][o.e.c.s.ClusterApplierService] [node_td1] cluster state updated, source [becoming candidate: onLeaderFailure]\r\n  1> cluster uuid: i_pigrp8QLC0MfshvlT2Zw\r\n  1> version: 3\r\n  1> state uuid: zHVMsMDgTfe9OBvpIAkWPQ\r\n  1> from_diff: false\r\n  1> meta data version: 1\r\n  1>    coordination_metadata:\r\n  1>       term: 1\r\n  1>       last_committed_config: VotingConfiguration{udr7-Lv4R2iFJUccsZ5O-w}\r\n  1>       last_accepted_config: VotingConfiguration{udr7-Lv4R2iFJUccsZ5O-w}\r\n  1>       voting tombstones: []\r\n  1> metadata customs:\r\n  1>    index-graveyard: IndexGraveyard[[]]\r\n  1> blocks: \r\n  1>    _global_:\r\n  1>       2,no master, blocks WRITE,METADATA_WRITE\r\n  1> nodes: \r\n  1>    {node_td1}{6BVujxeOTfSjASRNIJkAMg}{B51tSRN0QMuIil3rVFpgtQ}{127.0.0.1}{127.0.0.1:39664}, local\r\n  1>    {node_tm0}{udr7-Lv4R2iFJUccsZ5O-w}{3ZEQc9CqRDWpnGqv-il6mg}{127.0.0.1}{127.0.0.1:33362}\r\n  1> routing_table (version 1):\r\n  1> routing_nodes:\r\n  1> -----node_id[6BVujxeOTfSjASRNIJkAMg][V]\r\n  1> ---- unassigned\r\n```\r\n\r\nAfter that constantly repeating exceptions from `CoordinatorPeerFinder`:\r\n```\r\n 1> [2019-01-21T06:28:11,557][DEBUG][o.e.c.c.C.CoordinatorPeerFinder] [node_td1] Peer{transportAddress=127.0.0.1:33362, discoveryNode=null, peersRequestInFlight=false} connection failed\r\n  1> org.elasticsearch.transport.ConnectTransportException: [][127.0.0.1:33362] DISCONNECT: simulated\r\n  1> \tat org.elasticsearch.test.transport.MockTransportService.lambda$addFailToSendNoConnectRule$3(MockTransportService.java:222) ~[framework-7.0.0.jar:7.0.0]\r\n```\r\n\r\nAnd just in 16 seconds, `ClusterApplierService` is actually applying the state:\r\n```\r\n1> [2019-01-21T06:28:27,634][DEBUG][o.e.c.s.ClusterApplierService] [node_td1] applying cluster state version 3\r\n  1> [2019-01-21T06:28:27,634][DEBUG][o.e.c.s.ClusterApplierService] [node_td1] apply cluster state with version 3\r\n  1> [2019-01-21T06:28:27,634][TRACE][o.e.c.s.ClusterApplierService] [node_td1] calling [org.elasticsearch.indices.cluster.IndicesClusterStateService@74982d6b] with change to version [3]\r\n```\r\n\r\nIf we look at the code, the only thing happening between `cluster state updated` and `applying cluster state` is checking node availability from the cluster state.\r\nIn this case, the check should return immediately with an error, because connection error is simulated.\r\nHowever, it takes 17 seconds and it could not be GC, because we see logs from `CoordinatorPeerFinder`.\r\nIt could be the management thread pool overflow and that's why task for checking node connections got queed.\r\nHowever, this test was failing during infrastructure outage period, so I want to enable the test and closely monitor for failure occurences now when infrastructure is restored.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/472066763","html_url":"https://github.com/elastic/elasticsearch/issues/37685#issuecomment-472066763","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37685","id":472066763,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MjA2Njc2Mw==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2019-03-12T16:09:36Z","updated_at":"2019-03-12T16:09:36Z","author_association":"CONTRIBUTOR","body":"There are no tests failures after unmute, I'm closing the issue.","performed_via_github_app":null}]