{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34269","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34269/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34269/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34269/events","html_url":"https://github.com/elastic/elasticsearch/issues/34269","id":366333453,"node_id":"MDU6SXNzdWUzNjYzMzM0NTM=","number":34269,"title":"Unbounded Sampler Aggregation will crash ES","user":{"login":"cdekker","id":1729963,"node_id":"MDQ6VXNlcjE3Mjk5NjM=","avatar_url":"https://avatars1.githubusercontent.com/u/1729963?v=4","gravatar_id":"","url":"https://api.github.com/users/cdekker","html_url":"https://github.com/cdekker","followers_url":"https://api.github.com/users/cdekker/followers","following_url":"https://api.github.com/users/cdekker/following{/other_user}","gists_url":"https://api.github.com/users/cdekker/gists{/gist_id}","starred_url":"https://api.github.com/users/cdekker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdekker/subscriptions","organizations_url":"https://api.github.com/users/cdekker/orgs","repos_url":"https://api.github.com/users/cdekker/repos","events_url":"https://api.github.com/users/cdekker/events{/privacy}","received_events_url":"https://api.github.com/users/cdekker/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-10-03T13:15:16Z","updated_at":"2019-03-15T15:46:01Z","closed_at":"2019-03-15T15:46:01Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen running a [Sampler Aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-sampler-aggregation.html) with an extremely high value for `shard_size` it will cause an OOM exception on all nodes handling queries for their shards.\r\n\r\nThis problem occurs even when the index is nearly empty.\r\n\r\nI would expect a Circuit-breaker exception to be triggered in this case, as it should be pretty clear that I don't have the heap memory available for loading that many aggregation samples. Alternatively, the sampler aggregation should be capped at the total number of documents, never (trying to) allocate more memory then there are documents for aggregations. \r\n\r\nIn that spirit, I would expect a sampler aggregation to always perform faster or equal to not having a sampler and aggregating over the entire result set.\r\n\r\n**Steps to reproduce**:\r\n\r\nI was able to reproduce the issue using the following query:\r\n\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"sample\": {\r\n      \"sampler\": {\r\n        \"shard_size\": 2000000000\r\n      },\r\n      \"aggs\": {\r\n        \"documentdate\": {\r\n          \"date_range\": {\r\n            \"field\": \"documentdate\",\r\n            \"format\": \"yyyy-MM-dd\",\r\n            \"ranges\": [\r\n              {\r\n                \"from\": \"now-360001d\"\r\n              },\r\n              {\r\n                \"from\": \"now-366d\"\r\n              },\r\n              {\r\n                \"from\": \"now-181d\"\r\n              },\r\n              {\r\n                \"from\": \"now-91d\"\r\n              },\r\n              {\r\n                \"from\": \"now-31d\"\r\n              },\r\n              {\r\n                \"from\": \"now-8d\"\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}