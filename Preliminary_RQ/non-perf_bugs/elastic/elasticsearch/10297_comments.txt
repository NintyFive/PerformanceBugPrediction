[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/87162493","html_url":"https://github.com/elastic/elasticsearch/issues/10297#issuecomment-87162493","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10297","id":87162493,"node_id":"MDEyOklzc3VlQ29tbWVudDg3MTYyNDkz","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-03-28T05:18:43Z","updated_at":"2015-03-28T05:18:43Z","author_association":"MEMBER","body":"Here is what happens:\n1. The randomized default template is setup with `_timestamp` having `doc_values: false` explicitly.  However, this is serialized _without_ any `doc_values` setting because `false` is the default value for `_timestamp`.\n2. The first mapping is added on index creation. It contains `fielddata.format: doc_values`. Since the default template was serialized without any doc values settings, this takes precedence and doc values is enabled, and part of the mappings serialization.\n3. The mappings update is made. This has `fieldata.format: array`.  This causes `_timestamp` to use the default for doc values, which is `false`. Again, since this is the default, it is skipped during serialization.\n4. The test fails when comparing the serialized mappings from (2) and (3), the first having `doc_values: true` and the second having no doc values setting.\n\nThe fix is to change how the doc values setting is stored in `AbstractFieldMapper`.  Instead of using a `boolean`, we instead need `Boolean`, so that a `null` values means the default was used, and a non-null value indicates we should _always_ write out the `doc_values` setting (it was explicitly set).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/87162633","html_url":"https://github.com/elastic/elasticsearch/issues/10297#issuecomment-87162633","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10297","id":87162633,"node_id":"MDEyOklzc3VlQ29tbWVudDg3MTYyNjMz","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-03-28T05:22:46Z","updated_at":"2015-03-28T05:22:46Z","author_association":"MEMBER","body":"Note that this is an edge case because there are 2 ways to specify doc values.  If there were just one, skipping serialization of the default value would be fine (there would be nothing else to potentially supersede it).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/87479506","html_url":"https://github.com/elastic/elasticsearch/issues/10297#issuecomment-87479506","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10297","id":87479506,"node_id":"MDEyOklzc3VlQ29tbWVudDg3NDc5NTA2","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2015-03-29T21:10:32Z","updated_at":"2015-03-29T21:10:32Z","author_association":"CONTRIBUTOR","body":"Actually, it seems to me this is some sort of race condition. If I add a sleep of 1s here: https://github.com/elastic/elasticsearch/blob/master/src/test/java/org/elasticsearch/index/mapper/update/UpdateMappingOnClusterTests.java#L230 before the first mapping is requested, then the test passes. \n\nIn addition, the mapping that changes the fielddata format to `fieldata.format: array` is never applied (point 3. in the description) because there is a mapping conflict for this update and so all mappings should be untouched by the update. `doc_values: true` should remain too. If something changed then I would assume this is a bug. Also, is it even possible to switch from `doc_values` from `true` to `false`? I thought not?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/87778332","html_url":"https://github.com/elastic/elasticsearch/issues/10297#issuecomment-87778332","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10297","id":87778332,"node_id":"MDEyOklzc3VlQ29tbWVudDg3Nzc4MzMy","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2015-03-30T18:16:07Z","updated_at":"2015-03-30T18:16:07Z","author_association":"MEMBER","body":"I agree it looks like there is a race condition.  However, I think the race condition is only there because with the bug I fix in #10302, the mappings are serialized differently than when they are read.  So any refresh-mapping action would cause the parsed mappings to change.\n\nWhile I don't know what triggers refresh-mapping actions, when I add your 1 second sleep with a printout, I notice this:\n\n```\n2015-03-30 11:00:58,899][DEBUG][org.elasticsearch.cluster.service] [node_s0] processing [refresh-mapping [index][[type]]]: execute\n[2015-03-30 11:00:58,899][INFO ][org.elasticsearch.index.mapper.update] --> Sleeping for 1 sec\n...\n[2015-03-30 11:00:58,923][DEBUG][org.elasticsearch.cluster.service] [node_s0] cluster state updated, version [10], source [refresh-mapping [index][[type]]]\n```\n\nSo, a refresh-mapping is kicked off just before the sleep, and the sleep gives it about enough time to finish (so that by the time the get mapping is executed, it has the refreshed view, which now has `doc_values: true`.  Also, the log message from the failure is actually reversed.  The \"got\" is what we got before, and the \"expected\" is the second retrieval at the end of the test.  The `assertThat` call has the arguments in the wrong order, which I think has led to part of the confusion. At first when the index template is applied, the in memory version has `doc_values: false`.  Once the refresh-mapping action is complete, we have `doc_values: true` because the explicit doc values setting has been lost.\n","performed_via_github_app":null}]