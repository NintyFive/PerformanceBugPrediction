{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999/events","html_url":"https://github.com/elastic/elasticsearch/issues/32999","id":352281894,"node_id":"MDU6SXNzdWUzNTIyODE4OTQ=","number":32999,"title":"Geohash_grid aggregation doesn't respect sub-aggregations result","user":{"login":"szkumorowski","id":18058722,"node_id":"MDQ6VXNlcjE4MDU4NzIy","avatar_url":"https://avatars1.githubusercontent.com/u/18058722?v=4","gravatar_id":"","url":"https://api.github.com/users/szkumorowski","html_url":"https://github.com/szkumorowski","followers_url":"https://api.github.com/users/szkumorowski/followers","following_url":"https://api.github.com/users/szkumorowski/following{/other_user}","gists_url":"https://api.github.com/users/szkumorowski/gists{/gist_id}","starred_url":"https://api.github.com/users/szkumorowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szkumorowski/subscriptions","organizations_url":"https://api.github.com/users/szkumorowski/orgs","repos_url":"https://api.github.com/users/szkumorowski/repos","events_url":"https://api.github.com/users/szkumorowski/events{/privacy}","received_events_url":"https://api.github.com/users/szkumorowski/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2018-08-20T20:21:17Z","updated_at":"2019-01-10T15:29:17Z","closed_at":"2019-01-10T15:29:16Z","author_association":"NONE","active_lock_reason":null,"body":"ES version 6.4.2\r\n\r\nAggregation geohash_grid  should take into account results from sub-aggregations, instead of it it uses the whole dataset from index\r\n\r\nExample:\r\ngeohash_grid should return geohashes for last positions for distinct devices:\r\n\r\nMapping:\r\n\r\n     deviceId: {type: 'keyword'},\r\n     geoPoint: {\r\n        type: 'geo_point'\r\n     },\r\n     timestamp: {type: 'date', format: DateUtil.ES_FORMAT},\r\n\r\nDataset:\r\n\r\n    [\r\n    {\r\n        deviceId: 1,\r\n        geoPoint: {\r\n            lat: 1, lon: 2\r\n        },\r\n        timestamp: '2018-01-01 12:00:00'\r\n    },\r\n    {\r\n        deviceId: 1,\r\n        geoPoint: {\r\n            lat: 3, lon: 4\r\n        },\r\n        timestamp: '2018-01-01 12:01:00'\r\n    },\r\n    {\r\n        deviceId: 1,\r\n        geoPoint: {\r\n            lat: 5, lon: 6\r\n        },\r\n        timestamp: '2018-01-01 12:02:00'\r\n    },\r\n    {\r\n        deviceId: 2,\r\n        geoPoint: {\r\n            lat: 1, lon: 2\r\n        },\r\n        timestamp: '2018-01-01 12:01:00'\r\n    },\r\n    {\r\n        deviceId: 2,\r\n        geoPoint: {\r\n            lat: 3, lon: 4\r\n        },\r\n        timestamp: '2018-01-01 12:02:00'\r\n    },\r\n    {\r\n        deviceId: 2,\r\n        geoPoint: {\r\n            lat: 5, lon: 6\r\n        },\r\n        timestamp: '2018-01-01 12:03:00'\r\n    }\r\n    ];\r\n\r\nQuery:\r\n\r\n    {\r\n           size: 0,\r\n            aggs: {\r\n            clustering: {\r\n                geohash_grid: {\r\n                    field: 'geoPoint',\r\n                    precision: 2\r\n                },\r\n                aggs: {\r\n                    last_device_position: {\r\n                        terms: {\r\n                            field: 'deviceId',\r\n                            size: 1,\r\n                            order: {\r\n                                last_one: 'desc'\r\n                            }\r\n                        },\r\n                        aggs: {\r\n                            last_one: {\r\n                                max: {\r\n                                    field: 'timestamp'\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n      };\r\n\r\nResults:\r\n\r\n     {\r\n     \"took\": 3,\r\n     \"timed_out\": false,\r\n     \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"skipped\": 0,\r\n      \"failed\": 0\r\n     },\r\n     \"hits\": {\r\n      \"total\": 6,\r\n      \"max_score\": 0,\r\n      \"hits\": []\r\n     },\r\n     \"aggregations\": {\r\n      \"clustering\": {\r\n        \"buckets\": [\r\n    {\r\n      \"key\": \"u2\",\r\n      \"doc_count\": 4,\r\n      \"last_device_position\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 2,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": \"1\",\r\n            \"doc_count\": 2,\r\n            \"last_one\": {\r\n              \"value\": 1514764860000,\r\n              \"value_as_string\": \"2018-01-01 00:01:00\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      \"key\": \"t5\",\r\n      \"doc_count\": 2,\r\n      \"last_device_position\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 1,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": \"1\",\r\n            \"doc_count\": 1,\r\n            \"last_one\": {\r\n              \"value\": 1514764920000,\r\n              \"value_as_string\": \"2018-01-01 00:02:00\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n      }\r\n      ]\r\n     }\r\n       }\r\n     }\r\n\r\nThere are 2 keys for deviceId: 1 with last one values 2018-01-01 00:02:00 and 2018-01-01 00:01:00 which is incorrect. geohash_grid aggregation doesn't take into account values from sub-aggregations.\r\n\r\nAccessing them in a way:\r\n\r\n    geohash_grid: {\r\n                    field: 'last_device_position > geoPoint',\r\n                    precision: 2\r\n                },\r\n\r\nor\r\n\r\n    geohash_grid: {\r\n                    field: 'last_one > geoPoint',\r\n                    precision: 2\r\n                }\r\n\r\nDoesn't give any results","closed_by":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}