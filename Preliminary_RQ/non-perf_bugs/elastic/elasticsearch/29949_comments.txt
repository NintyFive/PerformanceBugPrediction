[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132672","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132672","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132672,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-06-02T15:39:12Z","updated_at":"2018-04-25T01:32:33Z","author_association":"COLLABORATOR","body":"*Original comment by @nik9000:*\n\nI pushed LINK REDACTED to get more information.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132673","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132673,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-07-04T17:02:39Z","updated_at":"2018-04-25T01:32:33Z","author_association":"COLLABORATOR","body":"*Original comment by @javanna:*\n\nI think this is another instance of this failure: LINK REDACTED .","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132674","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132674","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132674,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-07-11T09:48:48Z","updated_at":"2018-04-25T01:32:33Z","author_association":"COLLABORATOR","body":"*Original comment by @ywelsch:*\n\nWith increased logging (thanks @nik9000), the last failure nicely shows what's going on:\r\n\r\n```\r\n 1> [2017-07-04T13:29:12,723][ERROR][o.e.x.s.a.f.SecurityActionFilter] [node_s1] blocking [indices:monitor/stats] operation due to expired license. Cluster health, cluster stats and indices stats \r\n  1> operations are blocked on license expiration. All data operations (read and write) continue to work. \r\n  1> If you have a new license, please update it. Otherwise, please reach out to your support contact.\r\n...\r\n1> [2017-07-04T13:29:12,734][TRACE][o.e.c.s.ClusterService   ] [node_s0] cluster state updated, source [shard-started shard id [[test][2]], allocation id [c6n7UvhpSNCohQOcNMXCiw], primary term [0], message [after peer recovery][shard id [[test][2]], allocation id [c6n7UvhpSNCohQOcNMXCiw], primary term [0], message [after peer recovery]]]\r\n  1> cluster uuid: U-6hAGKAQfa0CqSEMnidNQ\r\n  1> version: 48\r\n....\r\n1> [2017-07-04T13:29:12,770][DEBUG][o.e.d.z.PublishClusterStateAction] [node_s0] failed to commit cluster state (uuid [I8F3HH9vQh-pN3_0dMLTCg], version [48]) to {node_s1}{ZVfXslsXSTauO1kKtah6RQ}{Ajq6i6wMRnW7e1I3ZtbLZg}{127.0.0.1}{127.0.0.1:30252}\r\n\r\n  1> org.elasticsearch.transport.RemoteTransportException: [node_s1][127.0.0.1:30252][internal:discovery/zen/publish/commit]\r\n  1> Caused by: org.elasticsearch.ElasticsearchSecurityException: missing authentication token for action [internal:discovery/zen/publish/commit]\r\n  1> \tat org.elasticsearch.xpack.security.support.Exceptions.authenticationError(Exceptions.java:39) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.DefaultAuthenticationFailureHandler.missingToken(DefaultAuthenticationFailureHandler.java:74) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$AuditableTransportRequest.anonymousAccessDenied(AuthenticationService.java:553) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$handleNullToken$16(AuthenticationService.java:363) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.handleNullToken(AuthenticationService.java:368) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.consumeToken(AuthenticationService.java:295) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$extractToken$7(AuthenticationService.java:267) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.extractToken(AuthenticationService.java:284) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$null$0(AuthenticationService.java:218) ~[main/:?]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:59) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.xpack.security.authc.TokenService.getAndValidateToken(TokenService.java:217) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$authenticateAsync$2(AuthenticationService.java:214) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$lookForExistingAuthentication$4(AuthenticationService.java:246) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lookForExistingAuthentication(AuthenticationService.java:257) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.authenticateAsync(AuthenticationService.java:210) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.access$000(AuthenticationService.java:159) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.authc.AuthenticationService.authenticate(AuthenticationService.java:122) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.inbound(ServerTransportFilter.java:145) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:314) ~[main/:?]\r\n  1> \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport$RequestHandler.doRun(TcpTransport.java:1528) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.EsExecutors$1.execute(EsExecutors.java:110) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport.handleRequest(TcpTransport.java:1485) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TcpTransport.messageReceived(TcpTransport.java:1369) ~[elasticsearch-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java:74) ~[transport-netty4-5.6.0-SNAPSHOT.jar:5.6.0-SNAPSHOT]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:310) ~[netty-codec-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:297) ~[netty-codec-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:413) ~[netty-codec-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:265) ~[netty-codec-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.ChannelInboundHandlerAdapter.channelRead(ChannelInboundHandlerAdapter.java:86) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1334) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:926) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:134) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:644) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458) ~[netty-transport-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) ~[netty-common-4.1.11.Final.jar:4.1.11.Final]\r\n  1> \tat java.lang.Thread.run(Thread.java:745) ~[?:1.8.0_121]\r\n```\r\n\r\nwhich results in:\r\n\r\n```\r\n> Throwable LINK REDACTED: java.lang.AssertionError: node_s1 still having pending states:\r\n   > cluster uuid: U-6hAGKAQfa0CqSEMnidNQ\r\n   > version: 48\r\n   > state uuid: I8F3HH9vQh-pN3_0dMLTCg\r\n   > from_diff: true\r\n   > meta data version: 45\r\n   >    [test/-Iv2JazrS5SKhZ649baPiw]: v[9]\r\n   >       0: p_term [1], isa_ids [JnP0xd8_T1amVSBTiQV0LQ, FGncB572SoyqQoUcaAThOA]\r\n   >       1: p_term [1], isa_ids [6e-RK3J8RkyJrG0CFko7fA, VuX_OEMzQXi0jDiys56QBw]\r\n   >       2: p_term [1], isa_ids [kaLWcQb2R6-ujcxqPc4kJA, c6n7UvhpSNCohQOcNMXCiw]\r\n   >       3: p_term [1], isa_ids [nwW5uq-kTuKH86UOZXBr2g, Hphdz_BsSpmkq7KiwRTG6Q]\r\n   >       4: p_term [1], isa_ids [hbyvcFnsRk21_o-hYGKBuw, tYe5fV18QKS-pyHZmCqnjw]\r\n   >       5: p_term [1], isa_ids [veHVA-jDTI6hrMLfDmfTOA, 9HGNdayFSCmJ2XqipALH6Q]\r\n   >       6: p_term [1], isa_ids [1h0ObFxfRACt4IYiCNpnzQ, aYEPHWxPScmKv1Oy7pIDPQ]\r\n   >    [test1/N2lRHvsdTHaIqf9csXl2ew]: v[10]\r\n   >       0: p_term [1], isa_ids [ODxUnZbtTD-3_GlnP2-EQQ, anigj0bzSqeZ2D4dWxFXBQ]\r\n   >       1: p_term [1], isa_ids [HRNZmAw2RkOSnwsKzXlHPg, 4E8KSkerTXO2-7zxytu56g]\r\n   >       2: p_term [1], isa_ids [yog7uC44QOKSzCR3MSe52g, Vxpoo4hlRLqE4uzTGmRM4w]\r\n   >       3: p_term [1], isa_ids [TqLXAz12SGuQjKTkzT9ZPA, M4gmkMfRT_6nFTH8yGvKsQ]\r\n   >       4: p_term [1], isa_ids [Q7l7vaCCQHSMLzeRvYPwGw, 79S5Rhm6Sv6qu89AaAd_vQ]\r\n   >       5: p_term [1], isa_ids [NCklIfn-Sq2A-S3hpxno9w, Afit8mduR72z0c2k5nkF_g]\r\n   >       6: p_term [1], isa_ids [fZ794aokSZiGs9NrowD6rA, lnIXIB6sSAKGCrRrV8Gyxg]\r\n   > nodes: \r\n   >    {node_s2}{tRyZijVKSTGChXvT90pOeQ}{VWhO9vPeTWyZnVm1EY33Ww}{127.0.0.1}{127.0.0.1:30253}\r\n   >    {node_s0}{AOC1DMPoQYmkWBXYGCkdiA}{IFpYZEs1TRSpxIk6bou9BQ}{127.0.0.1}{127.0.0.1:30251}, master\r\n   >    {node_s1}{ZVfXslsXSTauO1kKtah6RQ}{Ajq6i6wMRnW7e1I3ZtbLZg}{127.0.0.1}{127.0.0.1:30252}, local\r\n   > routing_table (version 21):\r\n   > -- index [[test/-Iv2JazrS5SKhZ649baPiw]]\r\n   > ----shard_id [test][0]\r\n   > --------[test][0], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=JnP0xd8_T1amVSBTiQV0LQ]\r\n   > --------[test][0], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=FGncB572SoyqQoUcaAThOA]\r\n   > ----shard_id [test][1]\r\n   > --------[test][1], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=6e-RK3J8RkyJrG0CFko7fA]\r\n   > --------[test][1], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=VuX_OEMzQXi0jDiys56QBw]\r\n   > ----shard_id [test][2]\r\n   > --------[test][2], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=kaLWcQb2R6-ujcxqPc4kJA]\r\n   > --------[test][2], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=c6n7UvhpSNCohQOcNMXCiw]\r\n   > ----shard_id [test][3]\r\n   > --------[test][3], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=Hphdz_BsSpmkq7KiwRTG6Q]\r\n   > --------[test][3], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=nwW5uq-kTuKH86UOZXBr2g]\r\n   > ----shard_id [test][4]\r\n   > --------[test][4], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=tYe5fV18QKS-pyHZmCqnjw]\r\n   > --------[test][4], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=hbyvcFnsRk21_o-hYGKBuw]\r\n   > ----shard_id [test][5]\r\n   > --------[test][5], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=9HGNdayFSCmJ2XqipALH6Q]\r\n   > --------[test][5], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=veHVA-jDTI6hrMLfDmfTOA]\r\n   > ----shard_id [test][6]\r\n   > --------[test][6], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=1h0ObFxfRACt4IYiCNpnzQ]\r\n   > --------[test][6], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=aYEPHWxPScmKv1Oy7pIDPQ]\r\n   > -- index [[test1/N2lRHvsdTHaIqf9csXl2ew]]\r\n   > ----shard_id [test1][0]\r\n   > --------[test1][0], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=anigj0bzSqeZ2D4dWxFXBQ]\r\n   > --------[test1][0], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=ODxUnZbtTD-3_GlnP2-EQQ]\r\n   > ----shard_id [test1][1]\r\n   > --------[test1][1], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=4E8KSkerTXO2-7zxytu56g]\r\n   > --------[test1][1], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=HRNZmAw2RkOSnwsKzXlHPg]\r\n   > ----shard_id [test1][2]\r\n   > --------[test1][2], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=yog7uC44QOKSzCR3MSe52g]\r\n   > --------[test1][2], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=Vxpoo4hlRLqE4uzTGmRM4w]\r\n   > ----shard_id [test1][3]\r\n   > --------[test1][3], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=M4gmkMfRT_6nFTH8yGvKsQ]\r\n   > --------[test1][3], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=TqLXAz12SGuQjKTkzT9ZPA]\r\n   > ----shard_id [test1][4]\r\n   > --------[test1][4], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=79S5Rhm6Sv6qu89AaAd_vQ]\r\n   > --------[test1][4], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=Q7l7vaCCQHSMLzeRvYPwGw]\r\n   > ----shard_id [test1][5]\r\n   > --------[test1][5], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=Afit8mduR72z0c2k5nkF_g]\r\n   > --------[test1][5], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=NCklIfn-Sq2A-S3hpxno9w]\r\n   > ----shard_id [test1][6]\r\n   > --------[test1][6], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=fZ794aokSZiGs9NrowD6rA]\r\n   > --------[test1][6], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=lnIXIB6sSAKGCrRrV8Gyxg]\r\n   > routing_nodes:\r\n   > -----node_id[tRyZijVKSTGChXvT90pOeQ][V]\r\n   > --------[test][6], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=1h0ObFxfRACt4IYiCNpnzQ]\r\n   > --------[test][2], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=kaLWcQb2R6-ujcxqPc4kJA]\r\n   > --------[test][3], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=Hphdz_BsSpmkq7KiwRTG6Q]\r\n   > --------[test][4], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=tYe5fV18QKS-pyHZmCqnjw]\r\n   > --------[test][0], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=JnP0xd8_T1amVSBTiQV0LQ]\r\n   > --------[test1][2], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=yog7uC44QOKSzCR3MSe52g]\r\n   > --------[test1][3], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=M4gmkMfRT_6nFTH8yGvKsQ]\r\n   > --------[test1][5], node[tRyZijVKSTGChXvT90pOeQ], [R], s[STARTED], a[id=Afit8mduR72z0c2k5nkF_g]\r\n   > --------[test1][1], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=4E8KSkerTXO2-7zxytu56g]\r\n   > --------[test1][4], node[tRyZijVKSTGChXvT90pOeQ], [P], s[STARTED], a[id=79S5Rhm6Sv6qu89AaAd_vQ]\r\n   > -----node_id[AOC1DMPoQYmkWBXYGCkdiA][V]\r\n   > --------[test][2], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=c6n7UvhpSNCohQOcNMXCiw]\r\n   > --------[test][5], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=9HGNdayFSCmJ2XqipALH6Q]\r\n   > --------[test][1], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=6e-RK3J8RkyJrG0CFko7fA]\r\n   > --------[test][4], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=hbyvcFnsRk21_o-hYGKBuw]\r\n   > --------[test][0], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=FGncB572SoyqQoUcaAThOA]\r\n   > --------[test1][6], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=fZ794aokSZiGs9NrowD6rA]\r\n   > --------[test1][3], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=TqLXAz12SGuQjKTkzT9ZPA]\r\n   > --------[test1][4], node[AOC1DMPoQYmkWBXYGCkdiA], [R], s[STARTED], a[id=Q7l7vaCCQHSMLzeRvYPwGw]\r\n   > --------[test1][0], node[AOC1DMPoQYmkWBXYGCkdiA], [P], s[STARTED], a[id=anigj0bzSqeZ2D4dWxFXBQ]\r\n   > -----node_id[ZVfXslsXSTauO1kKtah6RQ][V]\r\n   > --------[test][6], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=aYEPHWxPScmKv1Oy7pIDPQ]\r\n   > --------[test][3], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=nwW5uq-kTuKH86UOZXBr2g]\r\n   > --------[test][5], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=veHVA-jDTI6hrMLfDmfTOA]\r\n   > --------[test][1], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=VuX_OEMzQXi0jDiys56QBw]\r\n   > --------[test1][6], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=lnIXIB6sSAKGCrRrV8Gyxg]\r\n   > --------[test1][2], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=Vxpoo4hlRLqE4uzTGmRM4w]\r\n   > --------[test1][5], node[ZVfXslsXSTauO1kKtah6RQ], [P], s[STARTED], a[id=NCklIfn-Sq2A-S3hpxno9w]\r\n   > --------[test1][1], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=HRNZmAw2RkOSnwsKzXlHPg]\r\n   > --------[test1][0], node[ZVfXslsXSTauO1kKtah6RQ], [R], s[STARTED], a[id=ODxUnZbtTD-3_GlnP2-EQQ]\r\n   > ---- unassigned\r\n   > Expected: an empty array\r\n   >      but: array size was <1>\r\n   > \tat __randomizedtesting.SeedInfo.seed([5E80E517E1E60772:3E2FB2E2C7BF6458]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.lambda$afterInternal$0(ESIntegTestCase.java:568)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:705)\r\n   > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:679)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.afterInternal(ESIntegTestCase.java:566)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.cleanUpCluster(ESIntegTestCase.java:2052)\r\n   > \tat java.lang.Thread.run(Thread.java:745)\r\n   > \tSuppressed: java.lang.AssertionError: node_s1 still having pending states:\r\n```\r\n\r\nThe issue is that the test starts meddling with the licenses of the nodes while replica shards are still being initialized / started, which means that cluster state updates don't go through, possibly leaving pending cluster states on some nodes.\r\n\r\nI've pushed e11863fd0 which should fix this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132675","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132675,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-08-08T14:21:48Z","updated_at":"2018-04-25T01:32:34Z","author_association":"COLLABORATOR","body":"*Original comment by @spinscale:*\n\nthis seems to have resurfaced in 5.6, which contains yannicks code, but yields the same error message\r\n\r\nLINK REDACTED","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132676","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132676","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132676,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3Ng==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-08-14T10:45:22Z","updated_at":"2018-04-25T01:32:34Z","author_association":"COLLABORATOR","body":"*Original comment by @ywelsch:*\n\nThe issue is that the assertBusy that I added is not sufficient (it waits for all shards to be started). What I want it to wait for is everything that could possibly update the cluster state. Before we disable licensing, we need to make sure that there will be no more cluster state updates. Unfortunately, template upgrading is triggered asynchronously, and we are not waiting for `.watch-history-6` and `security-index-template` to be created. This whole business of running background tasks when the cluster is started makes our tests super brittle.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384132678","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384132678","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384132678,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzMjY3OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T18:14:39Z","updated_at":"2018-04-25T01:32:34Z","author_association":"COLLABORATOR","body":"*Original comment by @nik9000:*\n\nThis is similar: LINK REDACTED","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384185311","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-384185311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":384185311,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDE4NTMxMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-25T07:20:10Z","updated_at":"2018-04-25T07:20:10Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395722580","html_url":"https://github.com/elastic/elasticsearch/issues/29949#issuecomment-395722580","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29949","id":395722580,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTcyMjU4MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T10:39:10Z","updated_at":"2018-06-08T10:39:10Z","author_association":"MEMBER","body":"The initial report is over a year old with no subsequent reports in the last nine months. If this recurs again, we can open a new issue. Too much has changed since the initial report for this to be actionable, closing.","performed_via_github_app":null}]