{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35317","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35317/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35317/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35317/events","html_url":"https://github.com/elastic/elasticsearch/issues/35317","id":378041215,"node_id":"MDU6SXNzdWUzNzgwNDEyMTU=","number":35317,"title":"[Rollup] An empty index (or one entirely missing the timestamp) causes search exception","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":912843355,"node_id":"MDU6TGFiZWw5MTI4NDMzNTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Rollup","name":":Analytics/Rollup","color":"0e8a16","default":false,"description":"Turn fine-grained time-based data into coarser-grained data"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-11-06T21:30:13Z","updated_at":"2018-11-08T08:30:52Z","closed_at":"2018-11-08T08:30:52Z","author_association":"MEMBER","active_lock_reason":null,"body":"If an index is either empty, or is entirely filled with documents that lack the timestamp field, the indexer throws search exceptions:\r\n\r\n>reason [RemoteTransportException[[qfVIsK3][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: QueryShardException[failed to find field [utc_time] and [missing_bucket] is not set]; ], cause [[logstash-2015.05.21/ciS2eEMfRW-IAfeVA8Xd8g] QueryShardException[failed to find field [utc_time] and [missing_bucket] is not set]\r\n>\tat org.elasticsearch.search.aggregations.bucket.composite.CompositeValuesSourceBuilder.build(CompositeValuesSourceBuilder.java:336)\r\n\r\nWe set `missing_bucket` for the other grouping fields so that we can record missing/null buckets.  But because the timestamp is mandatory we don't set `missing_bucket`, because we don't actually want to collect docs that are missing the timestamp.\r\n\r\nThis, however, breaks when the index is entirely empty (even if the mapping has the timestamp field), or if all the documents in the index are lacking the timestamp.\r\n\r\nWe could fix this by setting `missing_bucket: true` on the date_histogram, and then adding an `exists(timestamp)` filter to the composite's query. \r\n\r\n/cc @jen-huang ","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}