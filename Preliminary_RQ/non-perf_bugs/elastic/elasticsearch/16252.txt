{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16252","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16252/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16252/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16252/events","html_url":"https://github.com/elastic/elasticsearch/issues/16252","id":129018214,"node_id":"MDU6SXNzdWUxMjkwMTgyMTQ=","number":16252,"title":"Documents lost on replica shard after replicating","user":{"login":"yfujita","id":2568905,"node_id":"MDQ6VXNlcjI1Njg5MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/2568905?v=4","gravatar_id":"","url":"https://api.github.com/users/yfujita","html_url":"https://github.com/yfujita","followers_url":"https://api.github.com/users/yfujita/followers","following_url":"https://api.github.com/users/yfujita/following{/other_user}","gists_url":"https://api.github.com/users/yfujita/gists{/gist_id}","starred_url":"https://api.github.com/users/yfujita/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yfujita/subscriptions","organizations_url":"https://api.github.com/users/yfujita/orgs","repos_url":"https://api.github.com/users/yfujita/repos","events_url":"https://api.github.com/users/yfujita/events{/privacy}","received_events_url":"https://api.github.com/users/yfujita/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null},{"id":111053151,"node_id":"MDU6TGFiZWwxMTEwNTMxNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/resiliency","name":"resiliency","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-01-27T03:28:43Z","updated_at":"2016-02-01T18:06:54Z","closed_at":"2016-02-01T18:05:57Z","author_association":"NONE","active_lock_reason":null,"body":"#### Overview:\n\nAfter relocating shards as soon as updating index, the documents are not replicated partially on replica shard \n#### Settings:\n\nElasticsearch 2.1.1\nRHEL 6.2\n#### Cluster:\n\nNodes 4\nShards 4\nReplica 1\n#### Procedure:\n1. Make empty index as cluster settings above.\n   \n   ```\n   node 1 : test 0(r), test 3(r)\n   node 2 : test 1(r), test 2(r)\n   node 3 : test 0(p), test 1(p)\n   node 4 : test 2(p), test 3(p)\n   *test x = shard number\n   ```\n2. Update documents by Bulk api. (Update it to \"primary node\", node 3)\n   \n   ```\n   { \"index\" : { \"_index\" : \"test\", \"_type\" : \"test\", \"_id\" : \"1\" } }\n   {\"dummy\" : true}\n   { \"index\" : { \"_index\" : \"test\", \"_type\" : \"test\", \"_id\" : \"2\" } }\n   {\"dummy\" : true}\n   { \"index\" : { \"_index\" : \"test\", \"_type\" : \"test\", \"_id\" : \"3\" } }\n   {\"dummy\" : true}\n   .....\n   ```\n3. On finishing updating documents, restart node with replica shard.\n   \n   -> restart node 1.\n4. Wait relocating replica shards.\n5. See the number of docs with cat shards api.\n   \n   ```\n   test   3 r STARTED  0  131b {IP} node1  (*)\n   test   3 p STARTED 11 6.7kb {IP} node4 \n   test   2 p STARTED 10 6.6kb {IP} node4 \n   test   2 r STARTED 10 6.6kb {IP} node2 \n   test   1 r STARTED  4 6.3kb {IP} node2 \n   test   1 p STARTED  4 6.3kb {IP} node3 \n   test   0 r STARTED  0 3.2kb {IP} node1  (*)\n   test   0 p STARTED  5 6.3kb {IP} node3 \n   ```\n\nSee the number of docs of test 1 and test 3 shard on node 1 (*) are 0 after relocation.\nThe docs of primary shards are properly updated.\n\nIn addition, with not empty index, after restarting the node while updating docs by bulk api continuously,\nthe number of primary shard and replica shard are not identical.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}