{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4663","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4663/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4663/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4663/events","html_url":"https://github.com/elastic/elasticsearch/issues/4663","id":25306706,"node_id":"MDU6SXNzdWUyNTMwNjcwNg==","number":4663,"title":"Future may never complete for concurrent update and delete requests","user":{"login":"peschlowp","id":1713347,"node_id":"MDQ6VXNlcjE3MTMzNDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1713347?v=4","gravatar_id":"","url":"https://api.github.com/users/peschlowp","html_url":"https://github.com/peschlowp","followers_url":"https://api.github.com/users/peschlowp/followers","following_url":"https://api.github.com/users/peschlowp/following{/other_user}","gists_url":"https://api.github.com/users/peschlowp/gists{/gist_id}","starred_url":"https://api.github.com/users/peschlowp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peschlowp/subscriptions","organizations_url":"https://api.github.com/users/peschlowp/orgs","repos_url":"https://api.github.com/users/peschlowp/repos","events_url":"https://api.github.com/users/peschlowp/events{/privacy}","received_events_url":"https://api.github.com/users/peschlowp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-01-09T10:00:06Z","updated_at":"2014-05-31T11:12:17Z","closed_at":"2014-05-31T11:12:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Suppose that two client threads make a concurrent attempt to update and delete the same document. Then, depending on the timing, the thread attempting the update may block forever, waiting on a future that never completes. This seems to be a bug, either on the server or in the client.\n\nI have created a test program which you can find here to reproduce the problem: https://gist.github.com/peschlowp/8331596\n\nThe test program inserts 100 documents into an index, then starts two threads which concurrently try to update or delete these 100 documents. The updating thread regularly blocks on the future that completes the update request. Instead I would expect the future to complete with success or failure.\n\nThe behavior seems to be connected to the retryOnConflict parameter of the update request (the test program provides a constant to quickly toggle it):\n- When retryOnConflict is set to a value larger than zero, the problem may occur.\n- When retryOnConflict is set to zero, the respective call fails with a VersionConflictEngineException instead and does not block.\n\nI'm using ElasticSearch 0.90.9 and haven't checked the behavior with previous versions.\n\nLet me know if more explanation or input is needed.\n","closed_by":{"login":"peschlowp","id":1713347,"node_id":"MDQ6VXNlcjE3MTMzNDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1713347?v=4","gravatar_id":"","url":"https://api.github.com/users/peschlowp","html_url":"https://github.com/peschlowp","followers_url":"https://api.github.com/users/peschlowp/followers","following_url":"https://api.github.com/users/peschlowp/following{/other_user}","gists_url":"https://api.github.com/users/peschlowp/gists{/gist_id}","starred_url":"https://api.github.com/users/peschlowp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peschlowp/subscriptions","organizations_url":"https://api.github.com/users/peschlowp/orgs","repos_url":"https://api.github.com/users/peschlowp/repos","events_url":"https://api.github.com/users/peschlowp/events{/privacy}","received_events_url":"https://api.github.com/users/peschlowp/received_events","type":"User","site_admin":false},"performed_via_github_app":null}