{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7038","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7038/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7038/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7038/events","html_url":"https://github.com/elastic/elasticsearch/issues/7038","id":38738092,"node_id":"MDU6SXNzdWUzODczODA5Mg==","number":7038,"title":"unable to re-nest on same field after reverse nesting ","user":{"login":"Kallin","id":158169,"node_id":"MDQ6VXNlcjE1ODE2OQ==","avatar_url":"https://avatars3.githubusercontent.com/u/158169?v=4","gravatar_id":"","url":"https://api.github.com/users/Kallin","html_url":"https://github.com/Kallin","followers_url":"https://api.github.com/users/Kallin/followers","following_url":"https://api.github.com/users/Kallin/following{/other_user}","gists_url":"https://api.github.com/users/Kallin/gists{/gist_id}","starred_url":"https://api.github.com/users/Kallin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kallin/subscriptions","organizations_url":"https://api.github.com/users/Kallin/orgs","repos_url":"https://api.github.com/users/Kallin/repos","events_url":"https://api.github.com/users/Kallin/events{/privacy}","received_events_url":"https://api.github.com/users/Kallin/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2014-07-25T14:47:45Z","updated_at":"2015-01-06T21:06:40Z","closed_at":"2015-01-06T21:06:40Z","author_association":"NONE","active_lock_reason":null,"body":"I'm having trouble performing a certain aggregation on a nested field.\n\nI have a field of nested type, that holds an array of object. What I want to do is this:\n\nAggregate on the field to find all the nested documents that contain a certain value, then reverse-nest back to the root, giving me the entire set of root documents which have the nested field object I'm looking for.\n\nThen, further aggregate on that set of documents, against the same nested field, this time against a different value. \n\nThe purpose is to build something like a funnel, where I keep narrowing down the aggregation with more and more criteria, based on that nested field.\n\nWhat appears to happen though is that when perform my second nested agg, itself with a nested->reverse_nested agg, it looks as though it can't see any of nested fields anymore. If you run this simple CURL, looks at the value of 'into_nested_again'. It's 0, but it should be 3, just like the value of the original 'into_nested' agg. \n\n```\ncurl -XDELETE \"http://localhost:9200/nested-test\"\n\ncurl -XPUT \"http://localhost:9200/nested-test\" -d'\n{\n  \"mappings\": {\n    \"my_type\": {\n      \"properties\": {\n        \"my_nested_field\": {\n          \"type\": \"nested\"\n       }\n      } \n\n    }\n  }\n}'\n\ncurl -XPOST \"http://localhost:9200/nested-test/my_type\" -d'\n{\n  \"my_nested_field\" : [\n    {\n      \"my_key\": \"value1\"\n    }\n  ]\n}'\n\ncurl -XPOST \"http://localhost:9200/nested-test/my_type\" -d'\n{\n  \"my_nested_field\" : [\n    {\n      \"my_key\": \"value1\"\n    },\n    {\n      \"my_key\": \"value2\"\n    }\n  ]\n}'\n\ncurl -XGET \"http://localhost:9200/nested-test/_search\" -d'\n{\n  \"aggs\": {\n    \"into_nested\": {\n      \"nested\": {\n        \"path\": \"my_nested_field\"\n      },\n      \"aggs\": {\n        \"by_value1\": {\n          \"filter\": {\n            \"term\": {\n              \"my_nested_field.my_key\": \"value1\"\n            }\n          },\n          \"aggs\": {\n            \"by_parent\": {\n              \"reverse_nested\": {}\n              , \"aggs\": {\n                \"into_nested_again\": {\n                  \"nested\": {\n                    \"path\": \"my_nested_field\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}