[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247317775","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247317775","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247317775,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzMxNzc3NQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T12:45:02Z","updated_at":"2016-09-15T12:45:02Z","author_association":"CONTRIBUTOR","body":"first of all you can't set this anymore on a node level in 5.0 - that's a good thing. That said, I am really surprised that not running refresh prevents rejections? Why did documents get rejected in the first place, why would refresh help here?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247338479","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247338479","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247338479,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzMzODQ3OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T14:08:09Z","updated_at":"2016-09-15T14:08:09Z","author_association":"CONTRIBUTOR","body":"If I'm not mistake, I've heard recently about disabling refresh completely resulting in heavier GC than just using a refresh interval of (eg) 30s.  @mikemccand am I remembering correctly?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247346020","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247346020","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247346020,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzM0NjAyMA==","user":{"login":"GlenRSmith","id":1327920,"node_id":"MDQ6VXNlcjEzMjc5MjA=","avatar_url":"https://avatars3.githubusercontent.com/u/1327920?v=4","gravatar_id":"","url":"https://api.github.com/users/GlenRSmith","html_url":"https://github.com/GlenRSmith","followers_url":"https://api.github.com/users/GlenRSmith/followers","following_url":"https://api.github.com/users/GlenRSmith/following{/other_user}","gists_url":"https://api.github.com/users/GlenRSmith/gists{/gist_id}","starred_url":"https://api.github.com/users/GlenRSmith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GlenRSmith/subscriptions","organizations_url":"https://api.github.com/users/GlenRSmith/orgs","repos_url":"https://api.github.com/users/GlenRSmith/repos","events_url":"https://api.github.com/users/GlenRSmith/events{/privacy}","received_events_url":"https://api.github.com/users/GlenRSmith/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T14:34:07Z","updated_at":"2016-09-15T14:34:07Z","author_association":"CONTRIBUTOR","body":"@s1monw I think that what was happening was that on the node in question, fully consuming the indexing buffer before refreshing led to high GCs, and the GC activity led to high bulk rejections.\n\nJust to give you an idea of the magnitude of the impact, the largest daily index in the cluster had something like 32 primary shards (warranted by the size of the index 500 - 800GB).  Any shard which had a copy on the affected node was approximately 20% the size of every other shard in the index.\n\nOnce that particular configuration was removed, the problem went away.\n\nI thought that it was a fascinating opportunity, an experiment that I probably would never have actually set up myself, to demonstrate the contrast between the behavior of bulk indexing with that single difference in configuration.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247376701","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247376701","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247376701,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzM3NjcwMQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T16:19:28Z","updated_at":"2016-09-15T16:19:28Z","author_association":"CONTRIBUTOR","body":"I really wonder if the live-version map is involved in this @mikemccand ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247376821","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247376821","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247376821,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzM3NjgyMQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T16:19:54Z","updated_at":"2016-09-15T16:19:54Z","author_association":"CONTRIBUTOR","body":"I also wonder if 5.0 still has this problem?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/247397934","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-247397934","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":247397934,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NzM5NzkzNA==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-09-15T17:39:31Z","updated_at":"2016-09-15T17:39:31Z","author_association":"CONTRIBUTOR","body":"Disabling refresh should not hurt anything, and I don't think I've seen that in the past.  @clintongormley do you remember the context before?\n\nIt should rather be the opposite: refresh itself is a costly op, forcing a full write of all buffered docs to files, opening readers, etc.\n\n@s1monw we fixed ES a while back to force a refresh if version map was too large, so I don't think it should be due to version map usage.\n\nIf RAM usage tracking is working correctly, when you tell ES how much RAM it can use for the indexing buffer, it will write things to disk once they exceed that much RAM.  Is is possible the customer here has too large an indexing buffer set?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/249152126","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-249152126","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":249152126,"node_id":"MDEyOklzc3VlQ29tbWVudDI0OTE1MjEyNg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-09-23T10:01:05Z","updated_at":"2016-09-23T10:01:05Z","author_association":"CONTRIBUTOR","body":"@mikemccand I had a conversation with @GlenRSmith but we didn't really find anything in particular. What wasn't clear to me here was that in that cluster that it happened it was only a single node that behaved odd. That node hat the refresh interval set to -1 in the `elasticsearch.yaml` all other had it set to `30s` or so. So I think it has something todo with this. One idea that came up was that it wasn't the GCs causing the rejections but rather an unlucky situation where we have a reader open to look up versions that has a very very large number of segments and we don't refresh it for a long time. I wonder if it's worth it to enhance IMC to also cause a refresh if there are merged segments ready. I can see that this can cause slow lookups and slowing indexing down dramatically if we have a reader that is so out of date. does this make sense?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/249161746","html_url":"https://github.com/elastic/elasticsearch/issues/20498#issuecomment-249161746","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20498","id":249161746,"node_id":"MDEyOklzc3VlQ29tbWVudDI0OTE2MTc0Ng==","user":{"login":"GlenRSmith","id":1327920,"node_id":"MDQ6VXNlcjEzMjc5MjA=","avatar_url":"https://avatars3.githubusercontent.com/u/1327920?v=4","gravatar_id":"","url":"https://api.github.com/users/GlenRSmith","html_url":"https://github.com/GlenRSmith","followers_url":"https://api.github.com/users/GlenRSmith/followers","following_url":"https://api.github.com/users/GlenRSmith/following{/other_user}","gists_url":"https://api.github.com/users/GlenRSmith/gists{/gist_id}","starred_url":"https://api.github.com/users/GlenRSmith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GlenRSmith/subscriptions","organizations_url":"https://api.github.com/users/GlenRSmith/orgs","repos_url":"https://api.github.com/users/GlenRSmith/repos","events_url":"https://api.github.com/users/GlenRSmith/events{/privacy}","received_events_url":"https://api.github.com/users/GlenRSmith/received_events","type":"User","site_admin":false},"created_at":"2016-09-23T10:55:39Z","updated_at":"2016-09-23T10:55:39Z","author_association":"CONTRIBUTOR","body":"@s1monw @clintongormley @mikemccand from Simon's mention of version maps, I took a look and found that the node in question had a 268 MB version map. Other data-only nodes had version maps ranging from 5.5 - 8.6 MB.\n","performed_via_github_app":null}]