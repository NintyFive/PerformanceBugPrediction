{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6540","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6540/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6540/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6540/events","html_url":"https://github.com/elastic/elasticsearch/issues/6540","id":35939935,"node_id":"MDU6SXNzdWUzNTkzOTkzNQ==","number":6540,"title":"Percolator: Fix handling of nested documents","user":{"login":"bly2k","id":3187614,"node_id":"MDQ6VXNlcjMxODc2MTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/3187614?v=4","gravatar_id":"","url":"https://api.github.com/users/bly2k","html_url":"https://github.com/bly2k","followers_url":"https://api.github.com/users/bly2k/followers","following_url":"https://api.github.com/users/bly2k/following{/other_user}","gists_url":"https://api.github.com/users/bly2k/gists{/gist_id}","starred_url":"https://api.github.com/users/bly2k/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bly2k/subscriptions","organizations_url":"https://api.github.com/users/bly2k/orgs","repos_url":"https://api.github.com/users/bly2k/repos","events_url":"https://api.github.com/users/bly2k/events{/privacy}","received_events_url":"https://api.github.com/users/bly2k/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":104188881,"node_id":"MDU6TGFiZWwxMDQxODg4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.2.2","name":"v1.2.2","color":"DDDDDD","default":false,"description":null},{"id":95090930,"node_id":"MDU6TGFiZWw5NTA5MDkzMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.3.0","name":"v1.3.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2014-06-17T22:54:20Z","updated_at":"2014-09-02T15:00:09Z","closed_at":"2014-06-18T10:26:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The percolator appears to have some strange matching behavior with nested objects defined in the document mapping. Steps to reproduce:\n\ncurl -XDELETE localhost:9200/test\n\ncurl -XPUT localhost:9200/test -d '{\n  \"settings\": {\n    \"index.number_of_shards\": 1,\n    \"index.number_of_replicas\": 0\n  },\n  \"mappings\": {\n    \"doc\": {\n      \"properties\": {\n        \"persons\": {\n          \"type\": \"nested\"\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/1 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\": {\n          \"name\": \"obama\"\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/2 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must_not\": {\n        \"match\": {\n          \"name\": \"obama\"\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/3 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\": {\n          \"persons.foo\": \"bar\"\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/4 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must_not\": {\n        \"match\": {\n          \"persons.foo\": \"bar\"\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/5 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"nested\": {\n          \"path\": \"persons\",\n          \"query\": {\n            \"match\": {\n              \"persons.foo\": \"bar\"\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPUT localhost:9200/test/.percolator/6 -d '{\n  \"query\": {\n    \"bool\": {\n      \"must_not\": {\n        \"nested\": {\n          \"path\": \"persons\",\n          \"query\": {\n            \"match\": {\n              \"persons.foo\": \"bar\"\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n\ncurl -XPOST localhost:9200/_refresh\n\nThi should only match 1 and 5, but instead it matches 1,2,3,4,5,6\n\ncurl -XPOST localhost:9200/test/doc/_percolate?pretty -d '{\n  \"doc\": {\n    \"name\": \"obama\",\n    \"persons\": [\n      {\n        \"foo\": \"bar\"\n      }\n    ]\n  }\n}'\n","closed_by":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"performed_via_github_app":null}