{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41323","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41323/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41323/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41323/events","html_url":"https://github.com/elastic/elasticsearch/issues/41323","id":434561627,"node_id":"MDU6SXNzdWU0MzQ1NjE2Mjc=","number":41323,"title":"Script fields on missing values do not work even with the suggsted size() workaround","user":{"login":"spansh","id":103208,"node_id":"MDQ6VXNlcjEwMzIwOA==","avatar_url":"https://avatars2.githubusercontent.com/u/103208?v=4","gravatar_id":"","url":"https://api.github.com/users/spansh","html_url":"https://github.com/spansh","followers_url":"https://api.github.com/users/spansh/followers","following_url":"https://api.github.com/users/spansh/following{/other_user}","gists_url":"https://api.github.com/users/spansh/gists{/gist_id}","starred_url":"https://api.github.com/users/spansh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spansh/subscriptions","organizations_url":"https://api.github.com/users/spansh/orgs","repos_url":"https://api.github.com/users/spansh/repos","events_url":"https://api.github.com/users/spansh/events{/privacy}","received_events_url":"https://api.github.com/users/spansh/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-04-18T02:23:15Z","updated_at":"2019-04-18T10:00:26Z","closed_at":"2019-04-18T08:24:32Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n7.0.0\r\n\r\n**Plugins installed**: []\r\nNone\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_191\"\r\nOpenJDK Runtime Environment (build 1.8.0_191-8u191-b12-2ubuntu0.16.04.1-b12)\r\nOpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux Ubuntu-1604-xenial-64-minimal-no-hwe 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThe recent changes to painless scripting say that fields without values now produce an error for me, which would be fine if the suggested solution worked.  \r\n\r\nNow I'm fairly certain that the index for this query does not have any documents without values for this specific field.\r\n\r\n```\r\ncurl -X GET \"localhost:9200/systems/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must_not\": {\r\n                \"exists\": {\r\n                    \"field\": \"x\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n```\r\n\r\nproduces no values (changing the fieldname to something random does).  Lets assume for now that there are some empty fields somewhere (possibly in nested documents?).\r\n\r\nHowever I get the following error using my painless script:\r\n\r\n```\r\n# {\r\n#    \"error\" : {\r\n#       \"failed_shards\" : [\r\n#          {\r\n#             \"node\" : \"aLP3EUguSqiaEs1O1Nu9_Q\",\r\n#             \"reason\" : {\r\n#                \"lang\" : \"painless\",\r\n#                \"script_stack\" : [\r\n#                   \"org.elasticsearch.index.fielddata.ScriptDocValues$Doubles.get(ScriptDocValues.java:249)\",\r\n#                   \"org.elasticsearch.index.fielddata.ScriptDocValues$Doubles.getValue(ScriptDocValues.java:243)\",\r\n#                   \"x = 0 - doc['x'].value;\\n                    double \",\r\n#                   \"                ^---- HERE\"\r\n#                ],\r\n#                \"caused_by\" : {\r\n#                   \"type\" : \"illegal_state_exception\",\r\n#                   \"reason\" : \"A document doesn't have a value for a field! Use doc[<field>].size()==0 to check if a document is missing a field!\"\r\n#                },\r\n#                \"type\" : \"script_exception\",\r\n#                \"script\" : \"\\n                    double x = 0 - doc['x'].value;\\n                    double y = 0 - doc['y'].value;\\n                    double z = 0 - doc['z']\r\n.value;\\n                    double distance = x*x + y*y + z*z;\\n                    return (distance <= 250000d);\\n                \",\r\n#                \"reason\" : \"runtime error\"\r\n#             },\r\n#             \"shard\" : 0,\r\n#             \"index\" : \"systems_1555494707\"\r\n#          }\r\n#       ],\r\n#       \"reason\" : \"all shards failed\",\r\n#       \"root_cause\" : [\r\n#          {\r\n#             \"reason\" : \"runtime error\",\r\n#             \"script\" : \"\\n                    double x = 0 - doc['x'].value;\\n                    double y = 0 - doc['y'].value;\\n                    double z = 0 - do[23/1817]\r\nlue;\\n                    double distance = x*x + y*y + z*z;\\n                    return (distance <= 250000d);\\n                \",\r\n#             \"lang\" : \"painless\",\r\n#             \"type\" : \"script_exception\",\r\n#             \"script_stack\" : [\r\n#                \"org.elasticsearch.index.fielddata.ScriptDocValues$Doubles.get(ScriptDocValues.java:249)\",\r\n#                \"org.elasticsearch.index.fielddata.ScriptDocValues$Doubles.getValue(ScriptDocValues.java:243)\",\r\n#                \"x = 0 - doc['x'].value;\\n                    double \",\r\n#                \"                ^---- HERE\"\r\n#             ]\r\n#          }\r\n#       ],\r\n#       \"phase\" : \"query\",\r\n#       \"grouped\" : true,\r\n#       \"type\" : \"search_phase_execution_exception\"\r\n#    },\r\n#    \"status\" : 400\r\n# }\r\n```\r\n\r\nIf I put the suggested fix in place, I get the following error:\r\n```\r\n# {\r\n#    \"status\" : 400,\r\n#    \"error\" : {\r\n#       \"type\" : \"search_phase_execution_exception\",\r\n#       \"phase\" : \"query\",\r\n#       \"root_cause\" : [\r\n#          {\r\n#             \"script\" : \"\\n                    if (doc['x'].value.size() == 0 || doc['y'].value.size() == 0 || doc['z'].value.size() == 0) {\\n                        return fals\r\ne;\\n                    }\\n                    double x = 0 - doc['x'].value;\\n                    double y = 0 - doc['y'].value;\\n                    double z = 0 - doc['z'].val\r\nue;\\n                    double distance = x*x + y*y + z*z;\\n                    return (distance <= 250000d);\\n                \",\r\n#             \"reason\" : \"runtime error\",\r\n#             \"type\" : \"script_exception\",\r\n#             \"script_stack\" : [\r\n#                \"if (doc['x'].value.size() == 0 || doc['y'].value.size() == 0 || doc['z'].value.size() == 0) {\\n                        \",\r\n#                \"                  ^---- HERE\"\r\n#             ],\r\n#             \"lang\" : \"painless\"\r\n#          }\r\n#       ],\r\n#       \"grouped\" : true,\r\n#       \"reason\" : \"all shards failed\",\r\n#       \"failed_shards\" : [\r\n#          {\r\n#             \"index\" : \"systems_1555494707\",\r\n#             \"shard\" : 0,\r\n#             \"reason\" : {\r\n#                \"type\" : \"script_exception\",\r\n#                \"lang\" : \"painless\",\r\n#                \"script_stack\" : [\r\n#                   \"if (doc['x'].value.size() == 0 || doc['y'].value.size() == 0 || doc['z'].value.size() == 0) {\\n                        \",\r\n#                   \"                  ^---- HERE\"\r\n#                ],\r\n#                \"caused_by\" : {\r\n#                   \"type\" : \"illegal_argument_exception\",\r\n#                   \"reason\" : \"dynamic method [java.lang.Double, size/0] not found\"\r\n#                },\r\n#                \"script\" : \"\\n                    if (doc['x'].value.size() == 0 || doc['y'].value.size() == 0 || doc['z'].value.size() == 0) {\\n                        return f\r\nalse;\\n                    }\\n                    double x = 0 - doc['x'].value;\\n                    double y = 0 - doc['y'].value;\\n                    double z = 0 - doc['z'].\r\nvalue;\\n                    double distance = x*x + y*y + z*z;\\n                    return (distance <= 250000d);\\n                \",\r\n#                \"reason\" : \"runtime error\"\r\n#             },\r\n#             \"node\" : \"aLP3EUguSqiaEs1O1Nu9_Q\"\r\n#          }\r\n#       ]\r\n#    }\r\n# }\r\n```\r\n\r\nThe field is just declared as a double field and none of the records have multiple values, and every record should have that field).\r\n\r\n**Steps to reproduce**:\r\n\r\nI don't really have time to produce this now but I suspect it should be relatively easy (I;m hurriedly degrading elasticsearch as I don't think I can script around this).\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}