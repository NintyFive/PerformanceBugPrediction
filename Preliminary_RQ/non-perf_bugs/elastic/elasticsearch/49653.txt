{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49653","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49653/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49653/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49653/events","html_url":"https://github.com/elastic/elasticsearch/issues/49653","id":529456108,"node_id":"MDU6SXNzdWU1Mjk0NTYxMDg=","number":49653,"title":"_FILE variable permission check does not follow symlinks","user":{"login":"pebrc","id":697790,"node_id":"MDQ6VXNlcjY5Nzc5MA==","avatar_url":"https://avatars0.githubusercontent.com/u/697790?v=4","gravatar_id":"","url":"https://api.github.com/users/pebrc","html_url":"https://github.com/pebrc","followers_url":"https://api.github.com/users/pebrc/followers","following_url":"https://api.github.com/users/pebrc/following{/other_user}","gists_url":"https://api.github.com/users/pebrc/gists{/gist_id}","starred_url":"https://api.github.com/users/pebrc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pebrc/subscriptions","organizations_url":"https://api.github.com/users/pebrc/orgs","repos_url":"https://api.github.com/users/pebrc/repos","events_url":"https://api.github.com/users/pebrc/events{/privacy}","received_events_url":"https://api.github.com/users/pebrc/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":1789304462,"node_id":"MDU6TGFiZWwxNzg5MzA0NDYy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.7.0","name":"v7.7.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"assignees":[{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-11-27T16:32:26Z","updated_at":"2020-11-11T21:54:58Z","closed_at":"2020-01-16T14:23:16Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.6.0-SNAPSHOT / 8.0.0-SNAPSHOT\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): official Docker image\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): official Docker image\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n#49182 introduces support for environment variables ending in `_FILE` to point to a file that will be read to create the value of an environment variable of the name minus the `_FILE` suffix. The startup script imposes strict permission checks on these files and requires them to have either `0400` or `0600` permissions. \r\n\r\nOn Kubernetes these sensitive files are typically mounted as so called `Secrets` into the docker container. That introduces an additional level of indirection with a symlink that has `0777` file permissions and therefore fails the checks in the Elasticsearch startup script. \r\n\r\nThe expected behaviour would be to check the permissions on the effective file after following symlinks instead. \r\n\r\nExample shell session on an ECK managed Elasticsearch container to illustrate the problem:\r\n```\r\n[root@cluster1-es-default-0 elasticsearch]# ls -l /mnt/elastic-internal/probe-user/\r\ntotal 0\r\nlrwxrwxrwx 1 root root 29 Nov 27 15:55 elastic-internal-probe -> ..data/elastic-internal-probe\r\n[root@cluster1-es-default-0 elasticsearch]# ls -l /mnt/elastic-internal/probe-user/..data/elastic-internal-probe \r\n-rw------- 1 root root 24 Nov 27 15:55 /mnt/elastic-internal/probe-user/..data/elastic-internal-probe\r\n```\r\n\r\nwhere `/mnt/elastic-internal/proble-user` is a volume mount of a k8s volume with the following definition: \r\n```yaml\r\n  - name: elastic-internal-probe-user\r\n    secret:\r\n      defaultMode: 384\r\n      items:\r\n      - key: elastic-internal-probe\r\n        path: elastic-internal-probe\r\n      optional: false\r\n      secretName: cluster1-es-internal-users\r\n```\r\nNote: `defaultMode` are the file permissions base 10 ie. 384 == 0600\r\n\r\n\r\n\r\n\r\n**Steps to reproduce**:\r\nRun Elasticsearch 7.6.0-SNAPSHOT on k8s with an environment variable ending in `_FILE` and a corresponding file mounted into the pod. Probably the easiest way to achieve that is to \r\nrun Elasticsearch on ECK 1.0.0-beta1 with this manifest:\r\n```yaml\r\napiVersion: elasticsearch.k8s.elastic.co/v1beta1                                                                                                                                                                      \r\nkind: Elasticsearch                                                                                                                                                                                                   \r\nmetadata:                                                                                                                                                                                                             \r\n  name: cluster1                                                                                                                                                                                                      \r\nspec:                                                                                                                                                                                                                 \r\n  image: my.private.docker/registry/elasticsearch:7.6.0-SNAPSHOT                                                                                                                                                              \r\n  version: 7.6.0                                                                                                                                                                                                      \r\n  nodeSets:                                                                                                                                                                                                           \r\n  - count: 1                                                                                                                                                                                                          \r\n    name: default                                                                                                                                                                                                     \r\n    config:                                                                                                                                                                                                           \r\n      node.store.allow_mmap: false \r\n```\r\n\r\n\r\n","closed_by":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"performed_via_github_app":null}