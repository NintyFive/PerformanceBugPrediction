[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726575298","html_url":"https://github.com/elastic/elasticsearch/issues/65029#issuecomment-726575298","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65029","id":726575298,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjU3NTI5OA==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-11-13T07:33:05Z","updated_at":"2020-11-13T07:33:05Z","author_association":"MEMBER","body":"If I understand correctly the ticket, your expectation is to have a result for all fields specified. If that is the case, this is incorrect.\r\n\r\nThe translate API returns the query DSL to retrieve results back. Which it does.\r\nSince ES is a *document* store, meaning each entry can vary in content - as such it will return only the fields that match and *contain* values, there is no notion of a schema across all entries. That is a document might or not, have the field requested - and that is perfectly fine.\r\nSince in SQL there is a notion of a schema across all results, Elasticsearch SQL handles that by inferring it across the results and maps the returned results into in.\r\n\r\nSee the documentation chapter on mapping, n particular the sections on missing value and exists query.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726881012","html_url":"https://github.com/elastic/elasticsearch/issues/65029#issuecomment-726881012","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65029","id":726881012,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjg4MTAxMg==","user":{"login":"jmwilkinson","id":17836030,"node_id":"MDQ6VXNlcjE3ODM2MDMw","avatar_url":"https://avatars0.githubusercontent.com/u/17836030?v=4","gravatar_id":"","url":"https://api.github.com/users/jmwilkinson","html_url":"https://github.com/jmwilkinson","followers_url":"https://api.github.com/users/jmwilkinson/followers","following_url":"https://api.github.com/users/jmwilkinson/following{/other_user}","gists_url":"https://api.github.com/users/jmwilkinson/gists{/gist_id}","starred_url":"https://api.github.com/users/jmwilkinson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmwilkinson/subscriptions","organizations_url":"https://api.github.com/users/jmwilkinson/orgs","repos_url":"https://api.github.com/users/jmwilkinson/repos","events_url":"https://api.github.com/users/jmwilkinson/events{/privacy}","received_events_url":"https://api.github.com/users/jmwilkinson/received_events","type":"User","site_admin":false},"created_at":"2020-11-13T17:07:20Z","updated_at":"2020-11-13T17:09:20Z","author_association":"NONE","body":"@costin I don't think your understanding is correct.\r\n\r\nThe fields do exist in the underlying documents. Not only that, but when _executing_ the sql query everything is returned as expected. It's only when _translating_ it that fields are missing- though not for all index mappings.\r\n\r\nThe broad expectation is:\r\n\r\nIf _execute_ a sql query, I get back a set of results.\r\n\r\nIf I _translate_ that same sql query, and then execute the  resulting dsl translation, I get back _the same_ set of results containing the same fields. Which is not the case.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/728568323","html_url":"https://github.com/elastic/elasticsearch/issues/65029#issuecomment-728568323","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65029","id":728568323,"node_id":"MDEyOklzc3VlQ29tbWVudDcyODU2ODMyMw==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2020-11-17T00:54:45Z","updated_at":"2020-11-17T00:54:45Z","author_association":"CONTRIBUTOR","body":"@jmwilkinson \r\n\r\nThere seems to be some confusion here about what translate does, and what `_source` and `docvalue_fields` do.\r\n\r\nCurrent versions of Elasticsearch lack a general purpose way of retrieving fields. There a new [`fields` section of the Search API](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-fields.html#search-fields-param) in ES 7.10 but it's still beta.\r\n\r\nThat means that (for now) in order to get selected fields from a document, the caller needs to decide [how to retrieve the field](https://www.elastic.co/guide/en/elasticsearch/reference/7.9/search-fields.html#search-fields).\r\n\r\nThat can be from `_source`, `docvalue_fields` or `stored_fields` (or `script_field`, but that's a bit different).\r\n\r\nThe SQL translate API does that for you.  \r\nBased on a field's mapping type it determines whether the field supports doc_values, and if it does it will list that field name in `docvalue_fields`.\r\nFor other fields it will rely on the `_source`.\r\nBut each field will be listed in only 1 place. There is no value in returning `Run.Name` from both _source and doc values. It just increases the size of the response and forces the caller to decide which field to use. The SQL engine has decided that the doc values field is the best one to use, so it is returned there.\r\n\r\nYour bug report amounts to _I expect SQL translate to build a search query that will return all selected fields as part of the `_source` section of the response_ . That is an incorrect assumption. SQL translate will return each field in the best manner it can, which may be `_source`, but may be `doc_values`.\r\n\r\nTo take a shorter example using your index:\r\n\r\n```\r\nPOST /_sql/translate\r\n{\r\n  \"query\": \"SELECT Run.ID, Run.Name FROM \\\"bug-index\\\" WHERE Run.ID = 1212\"\r\n}\r\n\r\n===\r\n{\r\n  \"size\": 1000,\r\n  \"query\": {\r\n    \"term\": {\r\n      \"Run.ID\": {\r\n        \"value\": 1212,\r\n        \"boost\": 1.0\r\n      }\r\n    }\r\n  },\r\n  \"_source\": {\r\n    \"includes\": [\r\n      \"Run.ID\"\r\n    ],\r\n    \"excludes\": []\r\n  },\r\n  \"docvalue_fields\": [\r\n    {\r\n      \"field\": \"Run.Name\"\r\n    }\r\n  ],\r\n  \"sort\": [\r\n    {\r\n      \"_doc\": {\r\n        \"order\": \"asc\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n \r\n`Run.ID` is retrieved from _source, but `Run.Name` is retrieved from `doc_values`.\r\n\r\nIf we ingest a document, and then run that search:\r\n\r\n```\r\nPUT bug-index-1/_doc/1\r\n{\r\n     \"Run\": { \"ID\": 1212 , \"Name\": \"foo\"}\r\n}\r\n```\r\n\r\n```\r\nGET /bug-index/_search\r\n{\r\n  \"size\": 1000,\r\n  \"query\": {\r\n    \"term\": {\r\n      \"Run.ID\": {\r\n        \"value\": 1212,\r\n        \"boost\": 1.0\r\n      }\r\n    }\r\n  },\r\n  \"_source\": {\r\n    \"includes\": [\r\n      \"Run.ID\"\r\n    ],\r\n    \"excludes\": []\r\n  },\r\n  \"docvalue_fields\": [\r\n    {\r\n      \"field\": \"Run.Name\"\r\n    }\r\n  ],\r\n  \"sort\": [\r\n    {\r\n      \"_doc\": {\r\n        \"order\": \"asc\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\n===\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": {\r\n      \"value\": 1,\r\n      \"relation\": \"eq\"\r\n    },\r\n    \"max_score\": null,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"bug-index-1\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"1\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"Run\": {\r\n            \"ID\": 1212\r\n          }\r\n        },\r\n        \"fields\": {\r\n          \"Run.Name\": [\r\n            \"foo\"\r\n          ]\r\n        },\r\n        \"sort\": [\r\n          0\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nEvery field that was selected is included in the response. `Run.ID` is in the `_source`, and `Run.Name` is in the `fields` because the SQL engine has determined the best way to retrieve each field.\r\n\r\nI don't see any bug here. Everything is working as designed - though perhaps not what you expect or want. \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/728691142","html_url":"https://github.com/elastic/elasticsearch/issues/65029#issuecomment-728691142","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65029","id":728691142,"node_id":"MDEyOklzc3VlQ29tbWVudDcyODY5MTE0Mg==","user":{"login":"jmwilkinson","id":17836030,"node_id":"MDQ6VXNlcjE3ODM2MDMw","avatar_url":"https://avatars0.githubusercontent.com/u/17836030?v=4","gravatar_id":"","url":"https://api.github.com/users/jmwilkinson","html_url":"https://github.com/jmwilkinson","followers_url":"https://api.github.com/users/jmwilkinson/followers","following_url":"https://api.github.com/users/jmwilkinson/following{/other_user}","gists_url":"https://api.github.com/users/jmwilkinson/gists{/gist_id}","starred_url":"https://api.github.com/users/jmwilkinson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmwilkinson/subscriptions","organizations_url":"https://api.github.com/users/jmwilkinson/orgs","repos_url":"https://api.github.com/users/jmwilkinson/repos","events_url":"https://api.github.com/users/jmwilkinson/events{/privacy}","received_events_url":"https://api.github.com/users/jmwilkinson/received_events","type":"User","site_admin":false},"created_at":"2020-11-17T05:14:59Z","updated_at":"2020-11-17T05:14:59Z","author_association":"NONE","body":"@tvernum Thank you so much for the detailed explanation! That clarifies things immensely.\r\n\r\nA huge missing piece for me was the code I have to experiment with this was printing the `_source` value from the hit expecting it to contain the entire document, and so I wasn't even seeing the rest of it. Also, I should have looked more closely at `docvalue_fields` in the returned query, and read the docs on what that meant. Sorry.\r\n\r\nTo cement my understanding, when you say\r\n\r\n> Every field that was selected is included in the response. Run.ID is in the _source, and Run.Name is in the fields because the SQL engine has determined the best way to retrieve each field.\r\n\r\nBy \"best\" you mean most performant? Is that correct?\r\n\r\nI'm very glad this wasn't a bug, and hope I haven't wasted too much of your time. I also hope this is useful for anyone else who runs across this while switching from Open Distro to elastic.\r\n","performed_via_github_app":null}]