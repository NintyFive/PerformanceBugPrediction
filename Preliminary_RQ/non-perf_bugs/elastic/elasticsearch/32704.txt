{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32704","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32704/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32704/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32704/events","html_url":"https://github.com/elastic/elasticsearch/issues/32704","id":348603535,"node_id":"MDU6SXNzdWUzNDg2MDM1MzU=","number":32704,"title":"Identify incoming TLS connections to a non-TLS transport port","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-08T07:16:08Z","updated_at":"2018-08-08T09:34:31Z","closed_at":"2018-08-08T09:34:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Today if something attempts to make a TLS connection to a non-TLS-enabled transport port, the resulting message is somewhat cryptic:\r\n\r\n```\r\n[2018-08-08T08:03:30,639][WARN ][o.e.x.s.t.n.SecurityNetty4ServerTransport] [9lL0_Bb] exception caught on transport layer [NettyTcpChannel{localAddress=/127.0.0.1:9300, remoteAddress=/127.0.0.1:57059}], closing connection\r\nio.netty.handler.codec.DecoderException: java.io.StreamCorruptedException: invalid internal transport message format, got (16,3,1,2)\r\n```\r\n\r\nThe first three bytes `16 03 01` identify this as a TLS 1.0 handshake, and the 6th byte (available but not shown here) is `01` since this is a `Client Hello` message). `16 03 02` and `16 03 03` respectively mean TLS 1.1 and TLS 1.2.\r\n\r\nWe currently identify traffic that looks like HTTP arriving at a transport port and respond accordingly, helping users to debug some networking issues, and I think it'd be useful to enhance the message logged here similarly.\r\n\r\nI think it would be enough to match `16 03 ?? ?? ?? 01` but maybe there should be tighter bounds on the third byte?\r\n\r\nRelates https://discuss.elastic.co/t/getting-invalid-internal-transport-message-format-when-using-java-transportclient-shield/79951","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}