{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48262","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48262/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48262/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48262/events","html_url":"https://github.com/elastic/elasticsearch/issues/48262","id":509321616,"node_id":"MDU6SXNzdWU1MDkzMjE2MTY=","number":48262,"title":"Geo-aggregation failure","user":{"login":"boba-bugs","id":56740927,"node_id":"MDQ6VXNlcjU2NzQwOTI3","avatar_url":"https://avatars2.githubusercontent.com/u/56740927?v=4","gravatar_id":"","url":"https://api.github.com/users/boba-bugs","html_url":"https://github.com/boba-bugs","followers_url":"https://api.github.com/users/boba-bugs/followers","following_url":"https://api.github.com/users/boba-bugs/following{/other_user}","gists_url":"https://api.github.com/users/boba-bugs/gists{/gist_id}","starred_url":"https://api.github.com/users/boba-bugs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boba-bugs/subscriptions","organizations_url":"https://api.github.com/users/boba-bugs/orgs","repos_url":"https://api.github.com/users/boba-bugs/repos","events_url":"https://api.github.com/users/boba-bugs/events{/privacy}","received_events_url":"https://api.github.com/users/boba-bugs/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-10-18T21:36:47Z","updated_at":"2019-10-21T11:25:46Z","closed_at":"2019-10-21T11:25:45Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nVersion: 7.4.0, Build: default/tar/22e1767283e61a198cb4db791ea66e3f11ab9910/2019-09-27T08:36:48.569419Z, JVM: 13\r\n**Plugins installed**: [None]\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk 11.0.4 2019-07-16\r\nOpenJDK Runtime Environment (build 11.0.4+11-post-Ubuntu-1ubuntu218.04.3)\r\nOpenJDK 64-Bit Server VM (build 11.0.4+11-post-Ubuntu-1ubuntu218.04.3, mixed mode, sharing)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux VA-1207 4.4.0-17763-Microsoft #379-Microsoft Wed Mar 06 19:16:00 PST 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n**Description of the problem including expected versus actual behavior**:\r\nFrom Section 4.1.11 of the Elasticsearch Engineer 1 course\r\nValidate that the coordinates field is mapped correctly.\r\n\r\nGeo-Aggregations are not working with Geoip  location fields and require a re-index using Geo_point fields in order for aggregations to become operational.  This is a potential hazard for us in the MSSP world if we have content that hinges on the success of these aggregations.  Additionally, as in the example, some Geo aggregations are failing silently with no indication that they misfired.   I have updated the example from the lab guide as below to produce a result:\r\n\r\n**Steps to reproduce**:\r\n```python\r\nfrom elasticsearch import Elasticsearch\r\nimport json\r\n\r\nes = Elasticsearch(hosts=[\"127.0.0.1:9200\"], http_compress=True)\r\nidxs = es.indices\r\nidxs.create('my_logs')\r\n\r\nmapping = {\r\n  \"properties\": {\r\n    \"coordinates\": {\r\n          \"type\": \"geo_point\"\r\n        },\r\n    \"ip\": {\"type\":\"ip\"}  \r\n      }\r\n    }\r\nidxs.put_mapping(index=\"my_logs\", body=mapping)\r\n\r\ndocument = {\r\n    \"properties\":{\r\n        \"@timestamp\": \"2019-07-08T03:00:00.000Z\",\r\n        \"ip\" : \"105.32.126.44\",\r\n        \"bytes\" : 8261,\r\n        \"coordinates\" : {\r\n            \"lat\" : 30.42769722,\r\n            \"lon\" : -87.70082}\r\n    }\r\n}\r\nes.create(index=\"my_logs\", id=1, body=document)\r\n\r\nbody ={\r\n    \"query\": {\r\n        \"bool\" : {\r\n            \"must\" : {\r\n                \"match_all\" : {}\r\n            },\r\n            \"filter\" : {\r\n                \"geo_distance\" : {\r\n                    \"distance\": \"12756km\",\r\n                    \"coordinates\" : {\r\n                        \"lat\" : 30,\r\n                        \"lon\" : -87\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\nes.search(index=\"my_logs\", body=body)\r\n```\r\nThis should aggregate.\r\n\r\nAdditionally it would be nice if the location field in the geoip object was a possible source in aggregations.  \r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"performed_via_github_app":null}