[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371836819","html_url":"https://github.com/elastic/elasticsearch/issues/28857#issuecomment-371836819","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28857","id":371836819,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTgzNjgxOQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2018-03-09T15:00:41Z","updated_at":"2018-03-09T15:00:41Z","author_association":"MEMBER","body":"Nested queries need a bitset to work well. If these bitsets are loaded on the fly then this will slow down searches significantly (load time is linear to the number of parent documents). Further more it can cause cache churn (bit sets constantly being built / cached and then removed). So adding a limit to the bitset filter can cause more harm than good.\r\n\r\nIf you have many nested fields you need to increase the heap space. On the long term the way how nested queries are implemented can be changed to use doc values instead of bit sets [1]. Doc values are stored on disk and are cached in the file system cache, and this combination allows for better LRU cache eviction.\r\n\r\n1: https://issues.apache.org/jira/browse/LUCENE-7304","performed_via_github_app":null}]