[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/350854095","html_url":"https://github.com/elastic/elasticsearch/issues/27762#issuecomment-350854095","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27762","id":350854095,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MDg1NDA5NQ==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2017-12-11T20:50:59Z","updated_at":"2017-12-11T20:50:59Z","author_association":"MEMBER","body":"/cc @tbrooks8","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/350898127","html_url":"https://github.com/elastic/elasticsearch/issues/27762#issuecomment-350898127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27762","id":350898127,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MDg5ODEyNw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2017-12-11T23:55:53Z","updated_at":"2017-12-11T23:55:53Z","author_association":"MEMBER","body":"Another instance https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+periodic/1037/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/351387089","html_url":"https://github.com/elastic/elasticsearch/issues/27762#issuecomment-351387089","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27762","id":351387089,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MTM4NzA4OQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-12-13T13:12:48Z","updated_at":"2017-12-13T13:12:48Z","author_association":"CONTRIBUTOR","body":"I've looked at one of the test failures: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.0+periodic/1038/console\r\n\r\nThe reason the test fails is that the target ports used for pinging do not match the ports of the nodes that are bound.\r\n\r\nThe logs show that node_t0, node_t1 and node_t2 bind to ports 9586, 9587 and 9588, respectively:\r\n\r\n```\r\n  1> [2017-12-12T07:19:02,123][DEBUG][o.e.t.MockTcpTransport   ] [node_t0] binding server bootstrap to: [::1, 127.0.0.1]\r\n  1> [2017-12-12T07:19:02,143][DEBUG][o.e.t.MockTcpTransport   ] [node_t0] Bound profile [default] to address {[::1]:9586}\r\n  1> [2017-12-12T07:19:02,150][DEBUG][o.e.t.MockTcpTransport   ] [node_t0] Bound profile [default] to address {127.0.0.1:9586}\r\n  1> [2017-12-12T07:19:02,151][INFO ][o.e.t.t.MockTransportService] [node_t0] publish_address {127.0.0.1:9586}, bound_addresses {[::1]:9586}, {127.0.0.1:9586}\r\n\r\n  1> [2017-12-12T07:19:02,135][DEBUG][o.e.t.MockTcpTransport   ] [node_t1] binding server bootstrap to: [::1, 127.0.0.1]\r\n  1> [2017-12-12T07:19:02,150][DEBUG][o.e.t.MockTcpTransport   ] [node_t1] Bound profile [default] to address {[::1]:9587}\r\n  1> [2017-12-12T07:19:02,176][DEBUG][o.e.t.MockTcpTransport   ] [node_t1] Bound profile [default] to address {127.0.0.1:9587}\r\n  1> [2017-12-12T07:19:02,176][INFO ][o.e.t.t.MockTransportService] [node_t1] publish_address {127.0.0.1:9587}, bound_addresses {[::1]:9587}, {127.0.0.1:9587}\r\n\r\n  1> [2017-12-12T07:19:02,143][DEBUG][o.e.t.MockTcpTransport   ] [node_t2] binding server bootstrap to: [::1, 127.0.0.1]\r\n  1> [2017-12-12T07:19:02,175][DEBUG][o.e.t.MockTcpTransport   ] [node_t2] Bound profile [default] to address {[::1]:9588}\r\n  1> [2017-12-12T07:19:02,179][DEBUG][o.e.t.MockTcpTransport   ] [node_t2] Bound profile [default] to address {127.0.0.1:9588}\r\n  1> [2017-12-12T07:19:02,179][INFO ][o.e.t.t.MockTransportService] [node_t2] publish_address {127.0.0.1:9588}, bound_addresses {[::1]:9588}, {127.0.0.1:9588}\r\n```\r\n\r\nFor pinging, they use the ports 9580 - 9584, however:\r\n\r\n```\r\n  1> [2017-12-12T07:19:02,227][TRACE][o.e.d.z.UnicastZenPing   ] [node_t0] resolved host [127.0.0.1] to [127.0.0.1:9580, 127.0.0.1:9581, 127.0.0.1:9582, 127.0.0.1:9583, 127.0.0.1:9584]\r\n  1> [2017-12-12T07:19:02,227][TRACE][o.e.d.z.UnicastZenPing   ] [node_t0] resolved host [[::1]] to [[::1]:9580, [::1]:9581, [::1]:9582, [::1]:9583, [::1]:9584]\r\n  \r\n  1> [2017-12-12T07:19:02,215][TRACE][o.e.d.z.UnicastZenPing   ] [node_t1] resolved host [127.0.0.1] to [127.0.0.1:9580, 127.0.0.1:9581, 127.0.0.1:9582, 127.0.0.1:9583, 127.0.0.1:9584]\r\n  1> [2017-12-12T07:19:02,215][TRACE][o.e.d.z.UnicastZenPing   ] [node_t1] resolved host [[::1]] to [[::1]:9580, [::1]:9581, [::1]:9582, [::1]:9583, [::1]:9584]\r\n  \r\n  1> [2017-12-12T07:19:02,239][TRACE][o.e.d.z.UnicastZenPing   ] [node_t2] resolved host [127.0.0.1] to [127.0.0.1:9580, 127.0.0.1:9581, 127.0.0.1:9582, 127.0.0.1:9583, 127.0.0.1:9584]\r\n  1> [2017-12-12T07:19:02,239][TRACE][o.e.d.z.UnicastZenPing   ] [node_t2] resolved host [[::1]] to [[::1]:9580, [::1]:9581, [::1]:9582, [::1]:9583, [::1]:9584]\r\n```\r\n\r\nWhat happens is that `InternalTestCluster` configures the three nodes to bind in the range `9580-9600`. I'm not sure why the nodes cannot bind to the sub-range `9580-9585`, something else seems to occupy those. For pinging, we then use the range `9580-9584` (by default the first 5 ports from beginning of the range on).\r\n\r\nI don't see which recent PR could be causing this issue. I wonder if it could be caused by just having more integration tests run in a single JVM? The sixth integration test that runs within the same JVM reuses the same port range from the first integration test (i.e. every test increments the port range by 20, modulo 100). It's possibly that one of the earlier integration tests did not properly clean up / free the ports?\r\n\r\nNote that we have been running quite a few integration tests in this same JVM:\r\n\r\n```\r\n2> NOTE: All tests run in this JVM: [IngestProcessorNotInstalledOnAllNodesIT, IndicesStatsBlocksIT, UpdateIT, ConcurrentDocumentOperationIT, SimpleIndexStateIT, MasterDisruptionIT, RecoveryFromGatewayIT, ShardInfoIT, SnapshotBlocksIT, MatchedQueriesIT, TypesExistsIT, DateHistogramOffsetIT, SearchWhileCreatingIndexIT, SimilarityIT, CustomQueryParserIT, HDRPercentilesIT, LongTermsIT, IndexTemplateBlocksIT, FiltersAggsRewriteIT, IndexActionIT, ParentFieldLoadingIT, BulkProcessorIT, IndexSortIT, GeoDistanceSortBuilderIT, ClusterHealthIT, PreBuiltAnalyzerIntegrationIT, RangeIT, MinBucketIT, SearchSliceIT, DestructiveOperationsIT, DedicatedMasterGetFieldMappingIT, ClusterSearchShardsIT, QueryProfilerIT, IndexAliasesIT, AdjacencyMatrixIT, SearchWithRandomIOExceptionsIT, HistogramIT, ClusterServiceIT, ShardStateIT, GetSettingsBlocksIT, SimpleRoutingIT, SearchScrollWithFailingNodesIT, RandomExceptionCircuitBreakerIT, NodeDisconnectIT, StringTermsIT, GeoBoundsIT, SimpleDataNodesIT, SourceFetchingIT, GeoShapeIntegrationIT, TemplateUpgradeServiceIT, ClusterRerouteIT, DeleteIndexBlocksIT, ValueCountIT, FunctionScoreFieldValueIT, ContextCompletionSuggestSearchIT, IndexShardIT, AckClusterUpdateSettingsIT, RecoveryWithUnsupportedIndicesIT, ForceMergeBlocksIT, ZenDiscoveryIT, ClearIndicesCacheBlocksIT, ScriptedMetricIT, InternalEngineMergeIT, DerivativeIT, SearchFieldsIT, NaNSortingIT, ClusterAllocationExplainIT, MinimumMasterNodesIT]\r\n```\r\n","performed_via_github_app":null}]