{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2669","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2669/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2669/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2669/events","html_url":"https://github.com/elastic/elasticsearch/issues/2669","id":11204245,"node_id":"MDU6SXNzdWUxMTIwNDI0NQ==","number":2669,"title":"Shard Reroute API temporarily breaks Cluster/nodes/stats API","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2013-02-20T16:31:04Z","updated_at":"2013-02-20T21:05:33Z","closed_at":"2013-02-20T17:23:31Z","author_association":"MEMBER","active_lock_reason":null,"body":"If you manually move a shard using the Reroute API, it appears that the Cluster node stats API breaks for the duration of the shard reassignment (500 Internal Server error, message at bottom of the gist).  It begins working again once the shard has been fully relocated and intialized.\n\nHere is a recreation.  The index in question is \"test\".  The cluster has three data nodes (S1, S2, S3) and one non-data client node (C1)\n\nEdit:  this is with ES Version 0.20.2\n\n``` bash\ncurl -XPOST 'localhost:9200/_cluster/reroute' -d '{\n  \"commands\":[\n    {\n      \"move\":{\n        \"index\":\"test\",\n        \"shard\":2,\n        \"from_node\":\"kH152vsLTL-y20mcLFs9GQ\",\n        \"to_node\":\"J47gdOIwQMq2GTmzzmzJBA\"\n      }\n    }\n  ]\n}' \n\n{\n  \"ok\":true,\n  \"state\":{\n    \"master_node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n    \"blocks\":{\n\n    },\n    \"nodes\":{\n      \"ez-rzcnfSESrVYP6zTWksA\":{\n        \"name\":\"S1\",\n        \"transport_address\":\"inet[/144.76.3.102:9300]\",\n        \"attributes\":{\n\n        }\n      },\n      \"-VNWEiiaSG2IRlwM6kzcxg\":{\n        \"name\":\"C1\",\n        \"transport_address\":\"inet[/144.76.8.228:9300]\",\n        \"attributes\":{\n          \"data\":\"false\"\n        }\n      },\n      \"kH152vsLTL-y20mcLFs9GQ\":{\n        \"name\":\"S3\",\n        \"transport_address\":\"inet[/144.76.2.205:9300]\",\n        \"attributes\":{\n\n        }\n      },\n      \"J47gdOIwQMq2GTmzzmzJBA\":{\n        \"name\":\"S2\",\n        \"transport_address\":\"inet[/144.76.3.103:9300]\",\n        \"attributes\":{\n\n        }\n      }\n    },\n    \"routing_table\":{\n      \"indices\":{\n        \"test\":{\n          \"shards\":{\n            \"0\":[\n              {\n                \"state\":\"STARTED\",\n                \"primary\":true,\n                \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n                \"relocating_node\":null,\n                \"shard\":0,\n                \"index\":\"test\"\n              },\n              {\n                \"state\":\"STARTED\",\n                \"primary\":false,\n                \"node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n                \"relocating_node\":null,\n                \"shard\":0,\n                \"index\":\"test\"\n              }\n            ],\n            \"1\":[\n              {\n                \"state\":\"STARTED\",\n                \"primary\":true,\n                \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n                \"relocating_node\":null,\n                \"shard\":1,\n                \"index\":\"test\"\n              },\n              {\n                \"state\":\"STARTED\",\n                \"primary\":false,\n                \"node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n                \"relocating_node\":null,\n                \"shard\":1,\n                \"index\":\"test\"\n              }\n            ],\n            \"2\":[\n              {\n                \"state\":\"STARTED\",\n                \"primary\":false,\n                \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n                \"relocating_node\":null,\n                \"shard\":2,\n                \"index\":\"test\"\n              },\n              {\n                \"state\":\"RELOCATING\",\n                \"primary\":true,\n                \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n                \"relocating_node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n                \"shard\":2,\n                \"index\":\"test\"\n              }\n            ]\n          }\n        },\n        \"test123\":{\n          \"shards\":{\n            \"0\":[\n              {\n                \"state\":\"STARTED\",\n                \"primary\":false,\n                \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n                \"relocating_node\":null,\n                \"shard\":0,\n                \"index\":\"test123\"\n              },\n              {\n                \"state\":\"STARTED\",\n                \"primary\":true,\n                \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n                \"relocating_node\":null,\n                \"shard\":0,\n                \"index\":\"test123\"\n              }\n            ]\n          }\n        }\n      }\n    },\n    \"routing_nodes\":{\n      \"unassigned\":[\n\n      ],\n      \"nodes\":{\n        \"ez-rzcnfSESrVYP6zTWksA\":[\n          {\n            \"state\":\"STARTED\",\n            \"primary\":true,\n            \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n            \"relocating_node\":null,\n            \"shard\":1,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"STARTED\",\n            \"primary\":false,\n            \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n            \"relocating_node\":null,\n            \"shard\":2,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"STARTED\",\n            \"primary\":false,\n            \"node\":\"ez-rzcnfSESrVYP6zTWksA\",\n            \"relocating_node\":null,\n            \"shard\":0,\n            \"index\":\"test123\"\n          }\n        ],\n        \"kH152vsLTL-y20mcLFs9GQ\":[\n          {\n            \"state\":\"STARTED\",\n            \"primary\":true,\n            \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n            \"relocating_node\":null,\n            \"shard\":0,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"RELOCATING\",\n            \"primary\":true,\n            \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n            \"relocating_node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n            \"shard\":2,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"STARTED\",\n            \"primary\":true,\n            \"node\":\"kH152vsLTL-y20mcLFs9GQ\",\n            \"relocating_node\":null,\n            \"shard\":0,\n            \"index\":\"test123\"\n          }\n        ],\n        \"J47gdOIwQMq2GTmzzmzJBA\":[\n          {\n            \"state\":\"STARTED\",\n            \"primary\":false,\n            \"node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n            \"relocating_node\":null,\n            \"shard\":0,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"STARTED\",\n            \"primary\":false,\n            \"node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n            \"relocating_node\":null,\n            \"shard\":1,\n            \"index\":\"test\"\n          },\n          {\n            \"state\":\"INITIALIZING\",\n            \"primary\":true,\n            \"node\":\"J47gdOIwQMq2GTmzzmzJBA\",\n            \"relocating_node\":\"kH152vsLTL-y20mcLFs9GQ\",\n            \"shard\":2,\n            \"index\":\"test\"\n          }\n        ]\n      }\n    },\n    \"allocations\":[\n\n    ]\n  }\n}\n\n##For the duration of the move, this API returns a 500 error\n$ curl -XGET localhost:9200/_cluster/nodes/stats?all=true\n{\n    \"error\": \"ArithmeticException[Value cannot fit in an int: -2562047788015]\",\n    \"status\": 500\n}\n```\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}