{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1441","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1441/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1441/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1441/events","html_url":"https://github.com/elastic/elasticsearch/issues/1441","id":2149228,"node_id":"MDU6SXNzdWUyMTQ5MjI4","number":1441,"title":"deleting CouchDB river can leave some docs behind","user":{"login":"erickt","id":84711,"node_id":"MDQ6VXNlcjg0NzEx","avatar_url":"https://avatars3.githubusercontent.com/u/84711?v=4","gravatar_id":"","url":"https://api.github.com/users/erickt","html_url":"https://github.com/erickt","followers_url":"https://api.github.com/users/erickt/followers","following_url":"https://api.github.com/users/erickt/following{/other_user}","gists_url":"https://api.github.com/users/erickt/gists{/gist_id}","starred_url":"https://api.github.com/users/erickt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erickt/subscriptions","organizations_url":"https://api.github.com/users/erickt/orgs","repos_url":"https://api.github.com/users/erickt/repos","events_url":"https://api.github.com/users/erickt/events{/privacy}","received_events_url":"https://api.github.com/users/erickt/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2011-11-04T22:32:18Z","updated_at":"2013-10-07T09:24:26Z","closed_at":"2013-10-07T09:24:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I'm running into a problem trying to atomically reindex a couchdb river. It seems that deleting the couchdb river can occasionally leave behind the `_seq` document. I believe this is happening because the river shutdown process isn't waiting for the couchdb's river indexer thread to exit before deleting all the couchdb river docs.\n\nHere's the code to close the river:\n\n```\n@Override public void close() {\n    if (closed) {\n        return;\n    }\n    logger.info(\"closing couchdb stream river\");\n    slurperThread.interrupt();\n    indexerThread.interrupt();\n    closed = true;\n}\n```\n\nAfter this function exits, ES goes off to delete all the river documents. However, because the plugin isn't joining on the subthreads, it's possible for the indexer thread to miss the interrupt until after it's updated the `_seq` doc;\n\n```\n           ....\n           } catch (InterruptedException e) {\n                if (closed) {\n                    return;\n                }\n            }\n\n            // thread halts here.\n\n            if (lastSeq != null) {\n                try {\n                    if (logger.isTraceEnabled()) {\n                        logger.trace(\"processing [_seq  ]: [{}]/[{}]/[{}], last_seq [{}]\", riverIndexName, riverName.name(), \"_seq\", lastSeq);re\n                    }\n                    bulk.add(indexRequest(riverIndexName).type(riverName.name()).id(\"_seq\")\n                            .source(jsonBuilder().startObject().startObject(\"couchdb\").field(\"last_seq\", lastSeq).endObject().endObject()));\n                } catch (IOException e) {\n                    logger.warn(\"failed to add last_seq entry to bulk indexing\");\n                }\n            }\n            ...\n```\n\nIf everything happens just right, ES will delete the plugin subdocuments, and this thread will recreate the `_seq` file.\n\nIt looks like the other river plugins use threads, but I haven't checked if they're also susceptible to this bug.\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}