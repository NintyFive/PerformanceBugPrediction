{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/64441","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64441/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64441/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64441/events","html_url":"https://github.com/elastic/elasticsearch/issues/64441","id":733467238,"node_id":"MDU6SXNzdWU3MzM0NjcyMzg=","number":64441,"title":"elasticsearch-plugin.bat script returns exit code 0 during errors in ES 5.6","user":{"login":"vamuzumd","id":48073424,"node_id":"MDQ6VXNlcjQ4MDczNDI0","avatar_url":"https://avatars0.githubusercontent.com/u/48073424?v=4","gravatar_id":"","url":"https://api.github.com/users/vamuzumd","html_url":"https://github.com/vamuzumd","followers_url":"https://api.github.com/users/vamuzumd/followers","following_url":"https://api.github.com/users/vamuzumd/following{/other_user}","gists_url":"https://api.github.com/users/vamuzumd/gists{/gist_id}","starred_url":"https://api.github.com/users/vamuzumd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vamuzumd/subscriptions","organizations_url":"https://api.github.com/users/vamuzumd/orgs","repos_url":"https://api.github.com/users/vamuzumd/repos","events_url":"https://api.github.com/users/vamuzumd/events{/privacy}","received_events_url":"https://api.github.com/users/vamuzumd/received_events","type":"User","site_admin":false},"labels":[{"id":146832994,"node_id":"MDU6TGFiZWwxNDY4MzI5OTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Plugins","name":":Core/Infra/Plugins","color":"0e8a16","default":false,"description":"Plugin API and infrastructure"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967495446,"node_id":"MDU6TGFiZWwxOTY3NDk1NDQ2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Infra","name":"Team:Core/Infra","color":"fef2c0","default":false,"description":"Meta label for core/infra team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-10-30T19:39:13Z","updated_at":"2020-10-30T23:29:46Z","closed_at":"2020-10-30T23:29:46Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.6.10\r\n\r\n**Plugins installed**: custom/user-defined plugins\r\n\r\n**JVM version** (`java -version`): 1.8.0_265\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows Server 2019\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI am installing a custom plugin for ES 5.6.10 by wrapping elasticsearch-plugin.bat command in a .NET [Process](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process?view=netcore-3.1) object with and plugin name as arguments.\r\nThis process returns exit code 0 before the plugin installation completes which creates problems when the plugin installation fails. This could be due to the below line in elasticsearch-plugin.bat not returning %%ERRORLEVEL%% during exit.\r\n\r\n%JAVA% %ES_JAVA_OPTS% !path_props! -cp \"%ES_HOME%/lib/*;\" \"org.elasticsearch.plugins.PluginCli\" !args!\r\n\r\nIdeally, the plugin batch script should return a non-zero exit-code if a plugin fails installation.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem,\r\nincluding (e.g.) index creation, mappings, settings, query etc.  The easier\r\nyou make for us to reproduce it, the more likely that somebody will take the\r\ntime to look at it.\r\n\r\n 1. Create a .NET ProcessInfo with following params:\r\na. local plugin file name and command as argument. Sample argument string -> --install file:///c:/customplugins/mycustom-plugin1.zip\r\nb. fileName should be path to elasticsearch-plugin.bat Sample ->c:\\elasticsearch\\bin\\elasticsearch-plugin.bat \r\nc. UseShellExecute = false\r\nd. RedirectStandardError = true\r\ne. RedirectStandardOutput = true\r\nf. Verb = \"runas\"\r\n2. Add event handlers for logging standard log output and error output. \r\n3. Invoke Process.Start with the above ProcessInfo as argument -> process.start(processInfo). Sample usage can be found [here](https://www.codeproject.com/Questions/182599/How-to-Run-a-Process-As-Admin)\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n2020-10-16 00:59:40.7401417\t| Executing program: c:\\elasticsearch\\bin\\elasticsearch-plugin.bat, working directory: , args: install file:///c:/elasticsearch/customplugins/custom-allocation-plugin.zip , maximum execution time of 00:02:00\r\n2020-10-16 00:59:40.7450299\t| START: c:\\elasticsearch\\bin\\elasticsearch-plugin.bat ID:cfdb87cc-7870-4eab-9027-9712e09804e5\r\n2020-10-16 00:59:42.1989771\t| -> Downloading file:///c:/elasticsearch/customplugins/custom-allocation-plugin.zip\r\n[=================>                               ] 37%áá \r\n[====================================>            ] 75%áá \r\n[================================================>] 99%áá \r\n[=================================================] 100%áá \r\n2020-10-16 00:59:42.2236910\t| STOP: c:\\elasticsearch\\bin\\elasticsearch-plugin.bat ID:cfdb87cc-7870-4eab-9027-9712e09804e5. Duration: 00:00:01.4786386. ExitCode: 0\r\n2020-10-16 00:59:42.4582086\t| Exception in thread \"main\" java.nio.file.AccessDeniedException: c:\\elasticsearch\\plugins\\.installing-4958296876653745062 -> c:\\elasticsearch\\plugins\\custom-allocation-plugin\r\n\tat sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:83)\r\n\tat sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:97)\r\n\tat sun.nio.fs.WindowsFileCopy.move(WindowsFileCopy.java:301)\r\n\tat sun.nio.fs.WindowsFileSystemProvider.move(WindowsFileSystemProvider.java:287)\r\n\tat java.nio.file.Files.move(Files.java:1395)\r\n\tat org.elasticsearch.plugins.InstallPluginCommand.install(InstallPluginCommand.java:587)\r\n\tat org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:218)\r\n\tat org.elasticsearch.plugins.InstallPluginCommand.execute(InstallPluginCommand.java:202)\r\n\tat org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:70)\r\n\tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:134)\r\n\tat org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:69)\r\n\tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:134)\r\n\tat org.elasticsearch.cli.Command.main(Command.java:90)\r\n\tat org.elasticsearch.plugins.PluginCli.main(PluginCli.java:47)\r\n\tSuppressed: java.io.IOException: Could not remove the following files (in the order of attempts):\r\n   c:\\elasticsearch\\plugins\\.installing-4958296876653745062: java.nio.file.DirectoryNotEmptyException: c:\\elasticsearch\\plugins\\.installing-4958296876653745062\r\n\t\tat org.apache.lucene.util.IOUtils.rm(IOUtils.java:329)\r\n\t\tat org.elasticsearch.plugins.InstallPluginCommand.install(InstallPluginCommand.java:610)\r\n\t\t... 8 more\r\n```\r\n**NOTE**: The exception is thrown after the \"STOP' log and the exitCode returned in \"0\" even though an exception occurred.\r\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}