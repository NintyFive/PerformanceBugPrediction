{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13113","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13113/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13113/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13113/events","html_url":"https://github.com/elastic/elasticsearch/issues/13113","id":103144319,"node_id":"MDU6SXNzdWUxMDMxNDQzMTk=","number":13113,"title":"How should I optimize children aggregation usage?","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2015-08-26T00:30:41Z","updated_at":"2016-07-24T07:13:21Z","closed_at":"2015-08-26T07:13:48Z","author_association":"NONE","active_lock_reason":null,"body":"It appears that the children aggregation is not cached (correct term?) using v1.6, as it is consistently taking the same amount of time for my query.\n\nHere's an example of my aggs:\n\n```\n{\n    \"aggs\": {\n        \"by_user\": {\n            \"terms\": {\n                \"field\": \"user_id\",\n                \"size\": 2000,\n                \"min_doc_count\": 1\n            },\n            \"aggs\": {\n                \"by_date\": {\n                    \"date_histogram\": {\n                        \"field\": \"timestamp\",\n                        \"interval\": \"day\",\n                        \"format\": \"yyyy-MM-dd-HH-mm\"\n                    },\n                    \"aggs\": {\n                        \"unique_browsers\": {\n                            \"terms\": {\n                                \"field\": \"browser\",\n                                \"size\": 20,\n                                \"min_doc_count\": 1\n                            },\n                            \"aggs\": {\n                                \"move_to_children\": {\n                                    \"nested\": {\n                                        \"type\": \"event\"\n                                    },\n                                    \"aggs\": {\n                                        \"count_up\": {\n                                            \"sum\": \"event.my-counter\"\n                                        }\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nNow, if I remove the child piece and run it (with no cache), and then rerun - there is an instant speedup. If I add the child piece back, and run it multiple times, it always takes the same amount of time. Is it possible that is missing some form of cache layer? And if so, what are the reasons why/recommendations?\n\nI ask because this aggregation is extremely slow (is this improved in 2.0?), it's taking ~60s with it as above, and if I remove it, the aggregations above take 500ms. I was hoping it'd be a first-hit-slow-second-hit-fast type deal like the other aggregations in use.\n\nBasically, what are the best ways to make children aggregations faster? I've searched docs for about a week with no results on what I've tried, so I was wondering if I'm missing something, or if I should hold on for 2.0, if that does indeed help things.\n\nThanks in advance, let me know if more info is needed - not sure what is relevant. Hope I was clear :).\n\nIt should be noted we're talking about a lot of parents here (in the millions).\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}