{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7386","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7386/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7386/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7386/events","html_url":"https://github.com/elastic/elasticsearch/issues/7386","id":40834362,"node_id":"MDU6SXNzdWU0MDgzNDM2Mg==","number":7386,"title":"Internal: Upgrade caused shard data to stay on nodes","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":121618939,"node_id":"MDU6TGFiZWwxMjE2MTg5Mzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.3.3","name":"v1.3.3","color":"dddddd","default":false,"description":null},{"id":111540092,"node_id":"MDU6TGFiZWwxMTE1NDAwOTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.0.Beta1","name":"v1.4.0.Beta1","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":38,"created_at":"2014-08-21T18:34:53Z","updated_at":"2019-12-18T16:40:25Z","closed_at":"2014-08-27T19:42:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Upgrade caused shard data to stay on nodes even after it isn't useful any more.\n\nThis comes from https://groups.google.com/forum/#!topic/elasticsearch/Mn1N0xmjsL8\n\nWhat I did:\nStarted upgrading from Elasticsearch 1.2.1 to Elasticsearch 1.3.2.  For each of the 6 nodes I updated:\n- Set allocation to primaries only\n- Sync new plugins into place\n- Update deb package\n- Restart Elasticsearch\n- Wait for Elasticsearch to respond on the local host\n- Set allocation to all\n- Wait for Elasticsearch to report GREEN\n- Sleep for half an hour so the cluster can rebalance itself a bit\n\nWhat happened:\nThe new version of Elasticsearch came up but didn't remove all the shard data it can't use.  This picture from Whatson shows the problem pretty well:\nhttps://wikitech.wikimedia.org/wiki/File:Whatson_out_of_disk.png\nThe nodes on the left were upgraded and blue means disk usage by Elasticsearch and brown is \"other\" disk usage.\n\nWhen I dig around on the filesystem all the space usage is in the shard storage directory (/var/lib/elasticsearch/production-search-eqiad/nodes/0/indices) but when I compare the list of open files to the list of files on the file system [with this](https://gist.github.com/nik9000/d2dba49c156a5259a7d6) I see that whole directories are just sitting around, unused.  Hitting the `/_cat/shards/<directory_name>` corroborates that the shard in the directory isn't on the node.  Oddly, if we keep poking around we find open files in directories representing shards that we don't expect to be on the node either....\n\nWhat we're doing now:\nWe're going to try restarting the upgrade and blasting the data directory on the node as we upgrade it.\n\nReproduction steps:\nNo idea.  And I'm a bit afraid to keep pushing things on our cluster with it in the state that it is in.\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}