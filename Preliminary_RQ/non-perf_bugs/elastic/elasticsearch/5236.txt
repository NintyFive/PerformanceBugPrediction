{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5236","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5236/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5236/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5236/events","html_url":"https://github.com/elastic/elasticsearch/issues/5236","id":28159922,"node_id":"MDU6SXNzdWUyODE1OTkyMg==","number":5236,"title":"Terms aggregations order wrong when sorting NaN's","user":{"login":"thanodnl","id":273145,"node_id":"MDQ6VXNlcjI3MzE0NQ==","avatar_url":"https://avatars2.githubusercontent.com/u/273145?v=4","gravatar_id":"","url":"https://api.github.com/users/thanodnl","html_url":"https://github.com/thanodnl","followers_url":"https://api.github.com/users/thanodnl/followers","following_url":"https://api.github.com/users/thanodnl/following{/other_user}","gists_url":"https://api.github.com/users/thanodnl/gists{/gist_id}","starred_url":"https://api.github.com/users/thanodnl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thanodnl/subscriptions","organizations_url":"https://api.github.com/users/thanodnl/orgs","repos_url":"https://api.github.com/users/thanodnl/repos","events_url":"https://api.github.com/users/thanodnl/events{/privacy}","received_events_url":"https://api.github.com/users/thanodnl/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":82340516,"node_id":"MDU6TGFiZWw4MjM0MDUxNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.2","name":"v1.0.2","color":"dddddd","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2014-02-24T13:09:53Z","updated_at":"2014-03-21T10:04:28Z","closed_at":"2014-03-04T08:53:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I have a strong believe there is an issue in the sorting of term aggregations.\n\nHave a look [here](https://github.com/elasticsearch/elasticsearch/blob/ad8a482d19/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/InternalOrder.java#L215). If we look at the comment above it indicates that it would like to push NaN's to the bottom of the list (which would be the correct behaviour according to me). But when I test this out it does not work\n\nLoading the following test data:\n\n```\n$ curl -XDELETE 'localhost:9200/sorting?pretty=true'\n$ curl -XPOST 'localhost:9200/_bulk?pretty=true' -d '\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"a\", a:1, b:1 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"a\", a:2, b:4 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"a\", a:3, b:9 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"b\", a:4, b:16 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"b\", a:5, b:25, c: 42 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"b\", a:6, b:36, c: 50 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"c\", a:7, b:49 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"c\", a:8, b:64 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"c\", a:9, b:81 }\n{ index: { _index: \"sorting\", _type: \"object\" }}\n{ t: \"c\", a:10, c:100 }\n'\n```\n\nYou can start running some aggregations:\n\n```\n$ curl 'localhost:9200/sorting/_search?pretty=true' -d '\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"t\": {\n      \"terms\": {\n        \"field\": \"t\",\n        \"order\": {\n          \"aStats.min\": \"desc\"\n        }\n      },\n      \"aggs\": {\n        \"aStats\": {\n          \"stats\": {\n            \"field\": \"c\"\n          }\n        }\n      }\n    }\n  }\n}\n'\n```\n\nWhen we run this aggregations if turns out that a term without value's in the `c` field ends in the top.\n\n```\n{\n  \"aggregations\": {\n    \"t\": {\n      \"buckets\": [\n        {\n          \"key\": \"a\",\n          \"doc_count\": 3,\n          \"aStats\": {\n            \"count\": 0,\n            \"min\": null,\n            \"max\": null,\n            \"avg\": null,\n            \"sum\": null\n          }\n        },\n        {\n          \"key\": \"c\",\n          \"doc_count\": 4,\n          \"aStats\": {\n            \"count\": 1,\n            \"min\": 100,\n            \"max\": 100,\n            \"avg\": 100,\n            \"sum\": 100\n          }\n        },\n        {\n          \"key\": \"b\",\n          \"doc_count\": 3,\n          \"aStats\": {\n            \"count\": 2,\n            \"min\": 42,\n            \"max\": 50,\n            \"avg\": 46,\n            \"sum\": 92\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nWhen running the same analysis with facetting you would see that the term without the values in `c` are pushed to the bottom of the list\n\n```\n$ curl 'localhost:9200/sorting/_search?pretty=true' -d '\n{\n  \"size\": 0,\n  \"facets\": {\n    \"t\": {\n      \"terms_stats\": {\n        \"key_field\": \"t\",\n        \"value_field\": \"c\",\n        \"order\": \"min\"\n      }\n    }\n  }\n}\n'\n```\n\nThis looks to me as correct behaviour.\n\nI have done some research on why this is happening, and in fact the if statement referenced above is comparing the aggregated metric to `Double.NaN`. In java [it turns out](http://stackoverflow.com/questions/8819738/why-does-double-nan-double-nan-return-false) that NaN is not equal to NaN :), luckily the guys working at java thought of this and added a function to check for NaN values `Double.isNaN`. Changing the line accordingly makes the return statement next work since it is skipped always at the moment. But...\n\nOn line [216](https://github.com/elasticsearch/elasticsearch/blob/ad8a482d19/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/InternalOrder.java#L216) it returns 1 or -1 depending on the ordering provided. This would result in NaN floating to the top of the list when ordering descending. Which has the strange effect that NaN's would be at the top of the list. My believe is that is should always `return 1` if `v1` is `NaN`.\n\nLast part of the bug is that only `v1` is being checked to be `NaN`. You would also need to check `v2` for being `NaN` and `return -1`(!) if so. This would, as the comment suggest always push 'NaN' values to the bottom of the sorted list. This resembles the most to how facets sort at the moment.\n\nConcrete effects of this bug is that we are not able to use aggregations for a table like view (which is the main benefit of using aggs, since you can get multiple columns at once) to show terms sorted descending on the avg of a sparse field we have in our collection of documents which was able when using facets.\n\nPlease have a look, and note that this error is made on two spots in the same file. ([second spot is on line 230](https://github.com/elasticsearch/elasticsearch/blob/ad8a482d19/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/InternalOrder.java#L230)).\n\nI tested (not via the test suite, but by hand) out a fix locally and that seems works for us. If you would like to share my patch by opening a pull request I could, although I need to check my code against your guidelines, and add some automated tests :)\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}