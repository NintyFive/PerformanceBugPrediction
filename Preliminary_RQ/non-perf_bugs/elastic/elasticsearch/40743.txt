{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40743","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40743/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40743/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40743/events","html_url":"https://github.com/elastic/elasticsearch/issues/40743","id":428294647,"node_id":"MDU6SXNzdWU0MjgyOTQ2NDc=","number":40743,"title":"Queries using allowPartialSearchResults=false involving only successful retries fail with status 503","user":{"login":"amirhadadi","id":2148876,"node_id":"MDQ6VXNlcjIxNDg4NzY=","avatar_url":"https://avatars2.githubusercontent.com/u/2148876?v=4","gravatar_id":"","url":"https://api.github.com/users/amirhadadi","html_url":"https://github.com/amirhadadi","followers_url":"https://api.github.com/users/amirhadadi/followers","following_url":"https://api.github.com/users/amirhadadi/following{/other_user}","gists_url":"https://api.github.com/users/amirhadadi/gists{/gist_id}","starred_url":"https://api.github.com/users/amirhadadi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amirhadadi/subscriptions","organizations_url":"https://api.github.com/users/amirhadadi/orgs","repos_url":"https://api.github.com/users/amirhadadi/repos","events_url":"https://api.github.com/users/amirhadadi/events{/privacy}","received_events_url":"https://api.github.com/users/amirhadadi/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-04-02T15:26:44Z","updated_at":"2019-06-12T13:37:06Z","closed_at":"2019-06-12T13:37:06Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** 6.3.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.144\r\n\r\n**OS version**: Linux 3.13.0-88-generic #135-Ubuntu SMP x86_64 x86_64 x86_64 GNU/Linux\r\n\r\nIn `AbstractSearchAsyncAction::executeNextPhase` there's the following code:\r\n`if (allowPartialResults == false && shardFailures.get() != null )`\r\n\r\nThis code assumes that `shardFailures.get() != null` indicates shard failures.\r\nHowever, since shard failures can be retried and then nulled out in `AbstractSearchAsyncAction::onShardSuccess`, it's possible that shardFailures.get() consists of only null `ShardSearchFailure`s. When that happens, `executeNextPhase` fails with \"Partial shards failure\".\r\nIn addition, the status code in this case is 503.\r\n\r\nThis is our query configuration:\r\n\r\n`SearchRequest{searchType=QUERY_THEN_FETCH, indices=[index], indicesOptions=IndicesOptions[id=38, ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false], types=[], routing='null', preference='_local', requestCache=null, scroll=null, maxConcurrentShardRequests=30, batchedReduceSize=512, preFilterShardSize=128, allowPartialSearchResults=false`\r\n\r\n**Steps to reproduce**:\r\n\r\n**Provide logs (if relevant)**:\r\nAfter a query fails (due to NPE in a custom java search script we use) with\r\n`org.elasticsearch.search.query.QueryPhaseExecutionException: Query Failed [Failed to execute main query]`\r\nand the query is retried on a different node and succeeds, the following appears in the log:\r\n\r\n\r\n`[2019-04-02T09:30:24,986][TRACE][o.e.a.s.TransportSearchAction] [esrec11d-10001-prod-nydc1.nydc1] got first-phase result from [t7GpBRj0TUCXKaYYwiMJVA][index][1]`\r\n\r\n`[2019-04-02T09:30:24,990][TRACE][o.e.a.s.TransportSearchAction] [esrec11d-10001-prod-nydc1.nydc1] got first-phase result from [QBZwuD5MSLyDMD56SoZpWg][index][0]`\r\n\r\n`[2019-04-02T09:30:24,990][DEBUG][o.e.a.s.TransportSearchAction] [esrec11d-10001-prod-nydc1.nydc1] 0 shards failed for phase: [query]`","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}