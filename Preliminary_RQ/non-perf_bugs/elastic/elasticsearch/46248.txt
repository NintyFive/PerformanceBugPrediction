{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46248","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46248/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46248/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46248/events","html_url":"https://github.com/elastic/elasticsearch/issues/46248","id":488375769,"node_id":"MDU6SXNzdWU0ODgzNzU3Njk=","number":46248,"title":"Elasticsearch 7.3.0  memory leak ,Node OOM!!!","user":{"login":"JayTange","id":25770504,"node_id":"MDQ6VXNlcjI1NzcwNTA0","avatar_url":"https://avatars2.githubusercontent.com/u/25770504?v=4","gravatar_id":"","url":"https://api.github.com/users/JayTange","html_url":"https://github.com/JayTange","followers_url":"https://api.github.com/users/JayTange/followers","following_url":"https://api.github.com/users/JayTange/following{/other_user}","gists_url":"https://api.github.com/users/JayTange/gists{/gist_id}","starred_url":"https://api.github.com/users/JayTange/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JayTange/subscriptions","organizations_url":"https://api.github.com/users/JayTange/orgs","repos_url":"https://api.github.com/users/JayTange/repos","events_url":"https://api.github.com/users/JayTange/events{/privacy}","received_events_url":"https://api.github.com/users/JayTange/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-09-03T03:34:10Z","updated_at":"2019-09-03T05:26:19Z","closed_at":"2019-09-03T04:45:33Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):elasticsearch 7.3.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):1.8.0_45\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):centos 6.5\r\n**Description of the problem including expected versus actual behavior**:\r\nes cluster has verh high memory, and always oom.\r\nall node crash (total 8 nodes)\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\nThis situation always occurs in batch index. about index 5 hours, oom exception.\r\njvm.options:\r\n-Xms31g\r\n-Xmx31g\r\n\r\ntotal memory is 64G\r\n\r\n**Provide logs (if relevant)**:\r\nnode log:\r\n\r\n```\r\n[gc][old][507][62] duration [14.5s], collections [2]/[15.2s], total [14.5s]/[18.7s], memory [29.6gb]->[29.5gb]/[30.9gb], all_pools {[young] [118.3mb]->[14.3mb]/[665.6mb]}{[survivor] [4.6mb]->[0b]/[83.1mb]}{[old] [29.4gb]->[29.4gb]/[30.1gb]}\r\n\r\n overhead, spent [14.5s] collecting in the last [15.2s]\r\n\r\njava.lang.OutOfMemoryError: Java heap space\r\n        at org.apache.lucene.util.fst.OnHeapFSTStore.init(OnHeapFSTStore.java:59) ~[lucene-core-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:34:03]\r\n        at org.apache.lucene.util.fst.FST.<init>(FST.java:302) ~[lucene-core-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:34:03]\r\n        at org.apache.lucene.util.fst.FST.<init>(FST.java:253) ~[lucene-core-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:34:03]\r\n        at org.apache.lucene.search.suggest.document.NRTSuggester.load(NRTSuggester.java:306) ~[lucene-suggest-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:35:51]\r\n        at org.apache.lucene.search.suggest.document.CompletionsTermsReader.suggester(CompletionsTermsReader.java:66) ~[lucene-suggest-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:35:51]\r\n        at org.apache.lucene.search.suggest.document.CompletionTerms.suggester(CompletionTerms.java:71) ~[lucene-suggest-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:35:51]\r\n        at org.elasticsearch.index.engine.Engine.completionStats(Engine.java:209) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.index.shard.IndexShard.completionStats(IndexShard.java:1044) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.admin.indices.stats.CommonStats.<init>(CommonStats.java:207) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.admin.cluster.stats.TransportClusterStatsAction.nodeOperation(TransportClusterStatsAction.java:120) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.admin.cluster.stats.TransportClusterStatsAction.nodeOperation(TransportClusterStatsAction.java:52) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.support.nodes.TransportNodesAction.nodeOperation(TransportNodesAction.java:129) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:246) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:242) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:257) ~[?:?]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.3.0.jar:7.3.0]\r\n        at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:315) ~[?:?]\r\n```\r\n\r\n## heap info\r\nLet'us look at jmap info:\r\n\r\n**command: jmap -heap**\r\n\r\n![image](https://user-images.githubusercontent.com/25770504/64142285-f4638300-ce3d-11e9-9409-f53d2af33b28.png)\r\n\r\n** comman:jmap -histo\r\n```\r\n num     #instances         #bytes  class name\r\n----------------------------------------------\r\n   1:         85559    21304489680  [B\r\n   2:         57759      158574080  [J\r\n   3:        418115       47722488  [C\r\n   4:        563194       27033312  java.util.HashMap$Node\r\n   5:         44478       19722744  [Ljava.lang.Object;\r\n   6:        411134       13156288  java.lang.String\r\n   7:         60879       13119416  [Ljava.util.HashMap$Node;\r\n   8:        150158        9610112  java.util.HashMap\r\n   9:          7857        9102296  [S\r\n  10:         22023        5602256  [I\r\n```\r\n21304489680 byte[], why? \r\n","closed_by":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"performed_via_github_app":null}