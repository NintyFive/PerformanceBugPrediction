[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68710250","html_url":"https://github.com/elastic/elasticsearch/issues/9136#issuecomment-68710250","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9136","id":68710250,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NzEwMjUw","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-05T13:55:32Z","updated_at":"2015-01-05T13:55:32Z","author_association":"CONTRIBUTOR","body":"Nice catch!  thanks @gokl \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68710606","html_url":"https://github.com/elastic/elasticsearch/issues/9136#issuecomment-68710606","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9136","id":68710606,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NzEwNjA2","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-05T13:58:32Z","updated_at":"2015-01-05T13:58:32Z","author_association":"CONTRIBUTOR","body":"@martijnvg could you have a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68842642","html_url":"https://github.com/elastic/elasticsearch/issues/9136#issuecomment-68842642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9136","id":68842642,"node_id":"MDEyOklzc3VlQ29tbWVudDY4ODQyNjQy","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-01-06T09:19:21Z","updated_at":"2015-01-06T09:19:21Z","author_association":"CONTRIBUTOR","body":"This is related to #9155. When sorting missing values last on a string field, we artificially replace `null` with an hypothetic maximum term so that the coordinating node knows how to compare this document to documents coming from other shards. But we forgot to do the opposite operation in `setTopValue` which is used for paging. So the comparator is feeded with this maximum term, which compares lower than a document without a value given that this maximum term IS a value (we should provide the comparator with `null`). Here is an untested patch that should fix the issue:\n\n``` diff\ndiff --git a/src/main/java/org/elasticsearch/index/fielddata/fieldcomparator/BytesRefFieldComparatorSource.java b/src/main/java/org/elasticsearch/index/fielddata/fieldcomparator/BytesRefFieldComparatorSource.java\nindex 7e64720..66fa306 100644\n--- a/src/main/java/org/elasticsearch/index/fielddata/fieldcomparator/BytesRefFieldComparatorSource.java\n+++ b/src/main/java/org/elasticsearch/index/fielddata/fieldcomparator/BytesRefFieldComparatorSource.java\n@@ -97,11 +97,21 @@ public class BytesRefFieldComparatorSource extends IndexFieldData.XFieldComparat\n                     // TopDocs.merge deal with it (it knows how to)\n                     BytesRef value = super.value(slot);\n                     if (value == null) {\n+                        assert sortMissingFirst(missingValue) || sortMissingLast(missingValue);\n                         value = missingBytes;\n                     }\n                     return value;\n                 }\n\n+                public void setTopValue(BytesRef topValue) {\n+                    // symetric of value(int): if we need to feed the comparator with <tt>null</tt>\n+                    // if we overrode the value with MAX_TERM in value(int)\n+                    if (topValue == missingBytes && (sortMissingFirst(missingValue) || sortMissingLast(missingValue))) {\n+                        topValue = null;\n+                    }\n+                    super.setTopValue(topValue);\n+                }\n+                \n             };\n         }\n```\n\nBut I hope we can come with a cleaner solution on 2.x by doing #9155 \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68848767","html_url":"https://github.com/elastic/elasticsearch/issues/9136#issuecomment-68848767","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9136","id":68848767,"node_id":"MDEyOklzc3VlQ29tbWVudDY4ODQ4NzY3","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-01-06T10:21:27Z","updated_at":"2015-01-06T10:21:27Z","author_association":"MEMBER","body":"@jpountz This proposed fix fixes the reported bug, so +1 for adding this initially to master, 1.x and 1.4 branches and then work on a better fix in master.\n","performed_via_github_app":null}]