{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49703","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49703/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49703/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49703/events","html_url":"https://github.com/elastic/elasticsearch/issues/49703","id":530215329,"node_id":"MDU6SXNzdWU1MzAyMTUzMjk=","number":49703,"title":"[CI] Failure in org.elasticsearch.search.query.QueryPhaseTests.testIndexHasDuplicateData","user":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"assignees":[{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-11-29T08:25:07Z","updated_at":"2020-03-19T17:09:51Z","closed_at":"2020-03-19T17:09:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"`#testIndexHasDuplicateData` and specifically [this assertion](https://github.com/elastic/elasticsearch/commit/fa8b48deefbec1eb58161252552628a1a0866e5f#diff-5fac69dcf1790a41ec05793b9c025862R728) has been failing since https://github.com/elastic/elasticsearch/commit/fa8b48deefbec1eb58161252552628a1a0866e5f, as seen for example in this scan: https://gradle-enterprise.elastic.co/s/k3vldmv6cz4ac \r\n\r\n``` java\r\n    public void testIndexHasDuplicateData() throws IOException {\r\n        int docsCount = 7000;\r\n        int duplIndex = docsCount * 7 / 10;\r\n        int duplIndex2 = docsCount * 3 / 10;\r\n        long duplicateValue = randomLongBetween(-10000000L, 10000000L);\r\n        Directory dir = newDirectory();\r\n        IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig(null));\r\n        for (int docId = 0; docId < docsCount; docId++) {\r\n            Document doc = new Document();\r\n            long rndValue = randomLongBetween(-10000000L, 10000000L);\r\n            long value = (docId < duplIndex) ? duplicateValue : rndValue;\r\n            long value2 = (docId < duplIndex2) ? duplicateValue : rndValue;\r\n            doc.add(new LongPoint(\"duplicateField\", value));\r\n            doc.add(new LongPoint(\"notDuplicateField\", value2));\r\n            writer.addDocument(doc);\r\n        }\r\n        writer.close();\r\n        final IndexReader reader = DirectoryReader.open(dir);\r\n        boolean hasDuplicateData = indexFieldHasDuplicateData(reader, \"duplicateField\");\r\n        boolean hasDuplicateData2 = indexFieldHasDuplicateData(reader, \"notDuplicateField\");\r\n        reader.close();\r\n        dir.close();\r\n        assertTrue(hasDuplicateData); <---- this trips\r\n        assertFalse(hasDuplicateData2);\r\n    }\r\n```\r\n\r\nI am able to reproduce this locally using `./gradlew ':server:test' --tests \"org.elasticsearch.search.query.QueryPhaseTests.testIndexHasDuplicateData\" -Dtests.seed=EA6BD7DFEF354E5A -Dtests.security.manager=true -Dtests.locale=en-ZA -Dtests.timezone=Etc/GMT+0 -Dcompiler.java=12`.\r\n\r\n","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}