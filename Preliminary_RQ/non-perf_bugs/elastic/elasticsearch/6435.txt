{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6435/events","html_url":"https://github.com/elastic/elasticsearch/issues/6435","id":35172360,"node_id":"MDU6SXNzdWUzNTE3MjM2MA==","number":6435,"title":"Intermittent DateRange aggregation bug.","user":{"login":"nickminutello","id":298274,"node_id":"MDQ6VXNlcjI5ODI3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/298274?v=4","gravatar_id":"","url":"https://api.github.com/users/nickminutello","html_url":"https://github.com/nickminutello","followers_url":"https://api.github.com/users/nickminutello/followers","following_url":"https://api.github.com/users/nickminutello/following{/other_user}","gists_url":"https://api.github.com/users/nickminutello/gists{/gist_id}","starred_url":"https://api.github.com/users/nickminutello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickminutello/subscriptions","organizations_url":"https://api.github.com/users/nickminutello/orgs","repos_url":"https://api.github.com/users/nickminutello/repos","events_url":"https://api.github.com/users/nickminutello/events{/privacy}","received_events_url":"https://api.github.com/users/nickminutello/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":13,"created_at":"2014-06-06T18:53:10Z","updated_at":"2014-07-08T14:39:35Z","closed_at":"2014-06-13T21:18:44Z","author_association":"NONE","active_lock_reason":null,"body":"Am seeing a intermittent bug whereby we see incorrect and internally inconsistent aggregation results (ie where the subaggregations have more items that the parent aggregation).\n\n``` javascript\n{\n    \"sales_quotas\": {\n        \"doc_count\": 5,\n        \"shipmentDate\": {\n            \"buckets\": [\n                {\n                    \"key\": \"Overdue\",\n                    \"to\": 1.3989024E12,\n                    \"to_as_string\": \"2014-05-01\",\n                    \"doc_count\": 0,\n                    \"commodity\": {\n                        \"buckets\": [\n                            {\n                                \"key\": \"类ベ񾥗蕏ɛ\",\n                                \"doc_count\": 5,\n                                \"quantityNormalised\": {\n                                    \"value\": 5000.0\n                                },\n                                \"unallocatedQuantityNormalised\": {\n                                    \"value\": 5000.0\n                                }\n                            }\n                        ]\n                    },\n                    \"nothingAllocated\": {\n                        \"doc_count\": 5,\n                        \"ME\": {\n                            \"doc_count\": 3\n                        },\n                        \"NOT_ME\": {\n                            \"doc_count\": 2\n                        }\n                    },\n                    \"notFullyAllocated\": {\n                        \"doc_count\": 0,\n                        \"ME\": {\n                            \"doc_count\": 0\n                        },\n                        \"NOT_ME\": {\n                            \"doc_count\": 0\n                        }\n                    }\n                }\n            ]\n        }\n    }\n}\n```\n\nI have written a test-case which (if you run it enough times) will reproduce it.\n\nHere is the test class:\n\n_AggregationBugs.java_\n\n``` java\npackage elastic.bugs;\n\nimport java.io.IOException;\nimport java.util.Collection;\nimport java.util.Map;\n\nimport org.elasticsearch.action.search.SearchRequestBuilder;\nimport org.elasticsearch.action.search.SearchResponse;\nimport org.elasticsearch.common.settings.Settings;\nimport org.elasticsearch.search.aggregations.Aggregations;\nimport org.elasticsearch.search.aggregations.bucket.SingleBucketAggregation;\nimport org.elasticsearch.search.aggregations.bucket.filter.InternalFilter;\nimport org.elasticsearch.search.aggregations.bucket.range.date.InternalDateRange;\nimport org.elasticsearch.search.aggregations.bucket.terms.StringTerms;\nimport org.elasticsearch.search.aggregations.bucket.terms.Terms;\nimport org.elasticsearch.search.aggregations.metrics.sum.InternalSum;\nimport org.elasticsearch.test.ElasticsearchIntegrationTest;\nimport org.junit.Test;\n\nimport com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.databind.DeserializationFeature;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.SerializationFeature;\nimport com.fasterxml.jackson.datatype.joda.JodaModule;\n\nimport static org.elasticsearch.common.settings.ImmutableSettings.settingsBuilder;\nimport static org.elasticsearch.test.ElasticsearchIntegrationTest.Scope.SUITE;\n\n@ElasticsearchIntegrationTest.ClusterScope(scope = SUITE, numNodes = 1)\npublic class AggregationBugs extends ElasticsearchIntegrationTest\n{\n    private static final String INDEX = \"bugindex\";\n    private final ObjectMapper json = new ObjectMapper();\n\n    public AggregationBugs()\n    {\n        json.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);\n        json.configure(SerializationFeature.WRITE_BIGDECIMAL_AS_PLAIN, true);\n        json.configure(DeserializationFeature.USE_BIG_DECIMAL_FOR_FLOATS, true);\n        json.configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, true);\n        json.registerModule(new JodaModule());\n    }\n\n    @Override\n    protected Settings nodeSettings(int nodeOrdinal)\n    {\n        return settingsBuilder()\n            .put(\"path.data\", \"target/elastic-test-data\")\n            .build();\n    }\n\n    private void index(String id, String type, String content) throws IOException\n    {\n        index(INDEX, type, id, json.readValue(content, Map.class));\n    }\n\n    @Test\n    public void subAggregationBug() throws IOException\n    {\n        admin()\n            .indices()\n            .prepareCreate(INDEX)\n            .execute()\n            .actionGet();\n\n        String propertiesSource = \"{\\\"properties\\\":{\\\"contractualLocationCity\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quantityUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"contractualLocationCountry\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"isAllocationNotInvoiced\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"isFullyAllocated\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"allocatedQuantity\\\":{\\\"type\\\":\\\"double\\\"},\\\"contractualLocation\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quantityNormalisedUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"isInvoicedFinal\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"isZeroAllocated\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"quotaId\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"long\\\"},\\\"counterParty\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"allocationStatus\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quantity\\\":{\\\"type\\\":\\\"double\\\"},\\\"allocatedQuantityUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"tradeRef\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"unallocatedQuantity\\\":{\\\"type\\\":\\\"double\\\"},\\\"contract\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"contractualLocationCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"shape\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quotaStatus\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"invoiceStatus\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"isActive\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"shipmentDate\\\":{\\\"format\\\":\\\"date\\\",\\\"type\\\":\\\"date\\\"},\\\"completedDate\\\":{\\\"format\\\":\\\"date\\\",\\\"type\\\":\\\"date\\\"},\\\"groupCompany\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"invoiceQuantity\\\":{\\\"type\\\":\\\"double\\\"},\\\"resolvedIds\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"expectedSalesMonth\\\":{\\\"format\\\":\\\"date\\\",\\\"type\\\":\\\"date\\\"},\\\"expectedSalesLocationCity\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"isCancelled\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"neptuneQuotaId\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"uninvoicedQuantityNormalised\\\":{\\\"type\\\":\\\"double\\\"},\\\"contractDutyPaid\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"unallocatedQuantityNormalised\\\":{\\\"type\\\":\\\"double\\\"},\\\"contractIncotermsCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"groupCompanyCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"grade\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"invoiceQuantityUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"unallocatedQuantityUnitOfMeasure\\\":{\\\"index\\\":\\\"no\\\",\\\"type\\\":\\\"string\\\"},\\\"counterPartyCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"isPurchase\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"isCompleted\\\":{\\\"type\\\":\\\"boolean\\\"},\\\"trafficOperatorFullName\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"groupCompanyId\\\":{\\\"include_in_all\\\":false,\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"expectedSalesLocation\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"intentIncotermsCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"trafficOperatorSid\\\":{\\\"include_in_all\\\":false,\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quantityNormalised\\\":{\\\"type\\\":\\\"double\\\"},\\\"commodity\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"contractIncoterms\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"expectedSalesLocationCode\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"brand\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quotaType\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"expectedSalesLocationCountry\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"},\\\"quotaRef\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"boost\\\":2.0,\\\"type\\\":\\\"string\\\"},\\\"comments\\\":{\\\"type\\\":\\\"string\\\"},\\\"intentIncoterms\\\":{\\\"index\\\":\\\"not_analyzed\\\",\\\"type\\\":\\\"string\\\"}}}\";\n        admin()\n            .indices()\n            .preparePutMapping(INDEX)\n            .setType(\"quota\")\n            .setSource(propertiesSource)\n            .execute()\n            .actionGet();\n\n        index(\"1581354603\", \"quota\", \"{\\\"allocatedQuantity\\\":0.0000,\\\"allocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"allocationStatus\\\":\\\"UNALLOCATED\\\",\\\"brand\\\":null,\\\"comments\\\":\\\"comments...\\\",\\\"commodity\\\":\\\"\\\\uFAAE\\\\u30D9\\\\uD9BA\\\\uDD57\\\\u854F\\\\u025B\\\",\\\"completedDate\\\":null,\\\"contract\\\":\\\"contract\\\",\\\"contractDutyPaid\\\":null,\\\"expectedSalesMonth\\\":\\\"2014-06-06\\\",\\\"grade\\\":null,\\\"groupCompany\\\":\\\"GROUP-COMPANY-NAME-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyCode\\\":\\\"GROUP-COMPANY-CODE-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyId\\\":\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"invoiceQuantity\\\":0.0000,\\\"invoiceQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"invoiceStatus\\\":\\\"NOTFINALINVOICED\\\",\\\"isActive\\\":true,\\\"isAllocationNotInvoiced\\\":false,\\\"isCancelled\\\":false,\\\"isCompleted\\\":false,\\\"isFullyAllocated\\\":false,\\\"isInvoicedFinal\\\":false,\\\"isPurchase\\\":false,\\\"isZeroAllocated\\\":true,\\\"neptuneQuotaId\\\":\\\"neptune-quota-id\\\",\\\"quantity\\\":1000.0000,\\\"quantityNormalised\\\":1000.0000,\\\"quantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quotaId\\\":\\\"1581354603\\\",\\\"quotaRef\\\":\\\"2723.4\\\",\\\"quotaStatus\\\":\\\"OPEN\\\",\\\"quotaType\\\":\\\"SALES\\\",\\\"resolvedIds\\\":[\\\"5D2E1DF59DB54303819A7A1320DF6053\\\",\\\"D9B2681C5CEB4FC1AB34280B32FB1C0E\\\",\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"18F42D923B444C3FB074D1A05548BE2B\\\"],\\\"shape\\\":null,\\\"shipmentDate\\\":\\\"2014-05-30\\\",\\\"tradeRef\\\":\\\"edm-trade-id\\\",\\\"trafficOperatorFullName\\\":\\\"James Brown\\\",\\\"trafficOperatorSid\\\":\\\"SID2\\\",\\\"unallocatedQuantity\\\":1000.0000,\\\"unallocatedQuantityNormalised\\\":1000.0000,\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"unallocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"uninvoicedQuantityNormalised\\\":0.0000,\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\"}\");\n        index(\"839452955\", \"quota\", \"{\\\"allocatedQuantity\\\":0.0000,\\\"allocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"allocationStatus\\\":\\\"UNALLOCATED\\\",\\\"brand\\\":null,\\\"comments\\\":\\\"comments...\\\",\\\"commodity\\\":\\\"\\\\uFAAE\\\\u30D9\\\\uD9BA\\\\uDD57\\\\u854F\\\\u025B\\\",\\\"completedDate\\\":null,\\\"contract\\\":\\\"contract\\\",\\\"contractDutyPaid\\\":null,\\\"expectedSalesMonth\\\":\\\"2014-06-06\\\",\\\"grade\\\":null,\\\"groupCompany\\\":\\\"GROUP-COMPANY-NAME-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyCode\\\":\\\"GROUP-COMPANY-CODE-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyId\\\":\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"invoiceQuantity\\\":0.0000,\\\"invoiceQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"invoiceStatus\\\":\\\"NOTFINALINVOICED\\\",\\\"isActive\\\":true,\\\"isAllocationNotInvoiced\\\":false,\\\"isCancelled\\\":false,\\\"isCompleted\\\":false,\\\"isFullyAllocated\\\":false,\\\"isInvoicedFinal\\\":false,\\\"isPurchase\\\":false,\\\"isZeroAllocated\\\":true,\\\"neptuneQuotaId\\\":\\\"neptune-quota-id\\\",\\\"quantity\\\":1000.0000,\\\"quantityNormalised\\\":1000.0000,\\\"quantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quotaId\\\":\\\"839452955\\\",\\\"quotaRef\\\":\\\"2723.1\\\",\\\"quotaStatus\\\":\\\"OPEN\\\",\\\"quotaType\\\":\\\"SALES\\\",\\\"resolvedIds\\\":[\\\"CE280D70F7CD4E16B871983420E7A136\\\",\\\"D9B2681C5CEB4FC1AB34280B32FB1C0E\\\",\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"18F42D923B444C3FB074D1A05548BE2B\\\"],\\\"shape\\\":null,\\\"shipmentDate\\\":\\\"2014-05-30\\\",\\\"tradeRef\\\":\\\"edm-trade-id\\\",\\\"trafficOperatorFullName\\\":\\\"Current User \\\\u054C\\\\u0561\\\\u0581\\\\u058B\\\\u0545\\\\u0576\\\\u0565\\\\u054C\\\\u0550\\\\u0582\\\",\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\",\\\"unallocatedQuantity\\\":1000.0000,\\\"unallocatedQuantityNormalised\\\":1000.0000,\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"unallocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"uninvoicedQuantityNormalised\\\":0.0000,\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\"}\");\n        index(\"679144004\", \"quota\", \"{\\\"allocatedQuantity\\\":0.0000,\\\"allocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"allocationStatus\\\":\\\"UNALLOCATED\\\",\\\"brand\\\":null,\\\"comments\\\":\\\"comments...\\\",\\\"commodity\\\":\\\"\\\\uFAAE\\\\u30D9\\\\uD9BA\\\\uDD57\\\\u854F\\\\u025B\\\",\\\"completedDate\\\":null,\\\"contract\\\":\\\"contract\\\",\\\"contractDutyPaid\\\":null,\\\"expectedSalesMonth\\\":\\\"2014-06-06\\\",\\\"grade\\\":null,\\\"groupCompany\\\":\\\"GROUP-COMPANY-NAME-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyCode\\\":\\\"GROUP-COMPANY-CODE-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyId\\\":\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"invoiceQuantity\\\":0.0000,\\\"invoiceQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"invoiceStatus\\\":\\\"NOTFINALINVOICED\\\",\\\"isActive\\\":true,\\\"isAllocationNotInvoiced\\\":false,\\\"isCancelled\\\":false,\\\"isCompleted\\\":false,\\\"isFullyAllocated\\\":false,\\\"isInvoicedFinal\\\":false,\\\"isPurchase\\\":false,\\\"isZeroAllocated\\\":true,\\\"neptuneQuotaId\\\":\\\"neptune-quota-id\\\",\\\"quantity\\\":1000.0000,\\\"quantityNormalised\\\":1000.0000,\\\"quantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quotaId\\\":\\\"679144004\\\",\\\"quotaRef\\\":\\\"2723.5\\\",\\\"quotaStatus\\\":\\\"OPEN\\\",\\\"quotaType\\\":\\\"SALES\\\",\\\"resolvedIds\\\":[\\\"CE280D70F7CD4E16B871983420E7A136\\\",\\\"D9B2681C5CEB4FC1AB34280B32FB1C0E\\\",\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"18F42D923B444C3FB074D1A05548BE2B\\\"],\\\"shape\\\":null,\\\"shipmentDate\\\":\\\"2014-05-30\\\",\\\"tradeRef\\\":\\\"edm-trade-id\\\",\\\"trafficOperatorFullName\\\":\\\"Current User \\\\u054C\\\\u0561\\\\u0581\\\\u058B\\\\u0545\\\\u0576\\\\u0565\\\\u054C\\\\u0550\\\\u0582\\\",\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\",\\\"unallocatedQuantity\\\":1000.0000,\\\"unallocatedQuantityNormalised\\\":1000.0000,\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"unallocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"uninvoicedQuantityNormalised\\\":0.0000,\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\"}\");\n        index(\"516594663\", \"quota\", \"{\\\"allocatedQuantity\\\":0.0000,\\\"allocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"allocationStatus\\\":\\\"UNALLOCATED\\\",\\\"brand\\\":null,\\\"comments\\\":\\\"comments...\\\",\\\"commodity\\\":\\\"\\\\uFAAE\\\\u30D9\\\\uD9BA\\\\uDD57\\\\u854F\\\\u025B\\\",\\\"completedDate\\\":null,\\\"contract\\\":\\\"contract\\\",\\\"contractDutyPaid\\\":null,\\\"expectedSalesMonth\\\":\\\"2014-06-06\\\",\\\"grade\\\":null,\\\"groupCompany\\\":\\\"GROUP-COMPANY-NAME-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyCode\\\":\\\"GROUP-COMPANY-CODE-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyId\\\":\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"invoiceQuantity\\\":0.0000,\\\"invoiceQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"invoiceStatus\\\":\\\"NOTFINALINVOICED\\\",\\\"isActive\\\":true,\\\"isAllocationNotInvoiced\\\":false,\\\"isCancelled\\\":false,\\\"isCompleted\\\":false,\\\"isFullyAllocated\\\":false,\\\"isInvoicedFinal\\\":false,\\\"isPurchase\\\":false,\\\"isZeroAllocated\\\":true,\\\"neptuneQuotaId\\\":\\\"neptune-quota-id\\\",\\\"quantity\\\":1000.0000,\\\"quantityNormalised\\\":1000.0000,\\\"quantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quotaId\\\":\\\"516594663\\\",\\\"quotaRef\\\":\\\"2723.3\\\",\\\"quotaStatus\\\":\\\"OPEN\\\",\\\"quotaType\\\":\\\"SALES\\\",\\\"resolvedIds\\\":[\\\"CE280D70F7CD4E16B871983420E7A136\\\",\\\"D9B2681C5CEB4FC1AB34280B32FB1C0E\\\",\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"18F42D923B444C3FB074D1A05548BE2B\\\"],\\\"shape\\\":null,\\\"shipmentDate\\\":\\\"2014-05-30\\\",\\\"tradeRef\\\":\\\"edm-trade-id\\\",\\\"trafficOperatorFullName\\\":\\\"Current User \\\\u054C\\\\u0561\\\\u0581\\\\u058B\\\\u0545\\\\u0576\\\\u0565\\\\u054C\\\\u0550\\\\u0582\\\",\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\",\\\"unallocatedQuantity\\\":1000.0000,\\\"unallocatedQuantityNormalised\\\":1000.0000,\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"unallocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"uninvoicedQuantityNormalised\\\":0.0000,\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\"}\");\n        index(\"1677219499\", \"quota\", \"{\\\"allocatedQuantity\\\":0.0000,\\\"allocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"allocationStatus\\\":\\\"UNALLOCATED\\\",\\\"brand\\\":null,\\\"comments\\\":\\\"comments...\\\",\\\"commodity\\\":\\\"\\\\uFAAE\\\\u30D9\\\\uD9BA\\\\uDD57\\\\u854F\\\\u025B\\\",\\\"completedDate\\\":null,\\\"contract\\\":\\\"contract\\\",\\\"contractDutyPaid\\\":null,\\\"expectedSalesMonth\\\":\\\"2014-06-06\\\",\\\"grade\\\":null,\\\"groupCompany\\\":\\\"GROUP-COMPANY-NAME-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyCode\\\":\\\"GROUP-COMPANY-CODE-\\\\uE815\\\\uD866\\\\uDD82d\\\\u549D\\\\uD8D3\\\\uDEF4\\\\uE9C3\\\\uD9A8\\\\uDDA5\\\\u716Fqd\\\\uB1B7\\\",\\\"groupCompanyId\\\":\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"invoiceQuantity\\\":0.0000,\\\"invoiceQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"invoiceStatus\\\":\\\"NOTFINALINVOICED\\\",\\\"isActive\\\":true,\\\"isAllocationNotInvoiced\\\":false,\\\"isCancelled\\\":false,\\\"isCompleted\\\":false,\\\"isFullyAllocated\\\":false,\\\"isInvoicedFinal\\\":false,\\\"isPurchase\\\":false,\\\"isZeroAllocated\\\":true,\\\"neptuneQuotaId\\\":\\\"neptune-quota-id\\\",\\\"quantity\\\":1000.0000,\\\"quantityNormalised\\\":1000.0000,\\\"quantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"quotaId\\\":\\\"1677219499\\\",\\\"quotaRef\\\":\\\"2723.2\\\",\\\"quotaStatus\\\":\\\"OPEN\\\",\\\"quotaType\\\":\\\"SALES\\\",\\\"resolvedIds\\\":[\\\"D9B2681C5CEB4FC1AB34280B32FB1C0E\\\",\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\",\\\"18F42D923B444C3FB074D1A05548BE2B\\\",\\\"D41031D6EF9E4F829913E856FE2B8E89\\\"],\\\"shape\\\":null,\\\"shipmentDate\\\":\\\"2014-05-30\\\",\\\"tradeRef\\\":\\\"edm-trade-id\\\",\\\"trafficOperatorFullName\\\":\\\"Mary\\\",\\\"trafficOperatorSid\\\":\\\"SID1\\\",\\\"unallocatedQuantity\\\":1000.0000,\\\"unallocatedQuantityNormalised\\\":1000.0000,\\\"unallocatedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"unallocatedQuantityUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\",\\\"uninvoicedQuantityNormalised\\\":0.0000,\\\"uninvoicedQuantityNormalisedUnitOfMeasure\\\":\\\"\\\\uF5FC\\\\u03FE\\\\u0105r\\\\u0440Z\\\"}\");\n        refresh();\n\n        String aggregationSource = \"{\\\"size\\\":0,\\\"aggregations\\\":{\\\"sales_quotas\\\":{\\\"filter\\\":{\\\"and\\\":{\\\"filters\\\":[{\\\"range\\\":{\\\"shipmentDate\\\":{\\\"from\\\":null,\\\"to\\\":\\\"2014-06-30\\\",\\\"include_lower\\\":true,\\\"include_upper\\\":true}}},{\\\"terms\\\":{\\\"groupCompanyId\\\":[\\\"DBF8E7284EC7423BBE1FCE8C0FDE9039\\\"]}},{\\\"type\\\":{\\\"value\\\":\\\"quota\\\"}},{\\\"term\\\":{\\\"isPurchase\\\":false}},{\\\"terms\\\":{\\\"quotaStatus\\\":[\\\"OPEN\\\"]}}]}},\\\"aggregations\\\":{\\\"shipmentDate\\\":{\\\"date_range\\\":{\\\"field\\\":\\\"shipmentDate\\\",\\\"ranges\\\":[{\\\"key\\\":\\\"Overdue\\\",\\\"to\\\":\\\"2014-05-01\\\"},{\\\"key\\\":\\\"May\\\",\\\"from\\\":\\\"2014-05-01\\\",\\\"to\\\":\\\"2014-06-01\\\"},{\\\"key\\\":\\\"June\\\",\\\"from\\\":\\\"2014-06-01\\\",\\\"to\\\":\\\"2014-07-01\\\"}]},\\\"aggregations\\\":{\\\"nothingAllocated\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"isZeroAllocated\\\":true}},\\\"aggregations\\\":{\\\"ME\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}},\\\"NOT_ME\\\":{\\\"filter\\\":{\\\"not\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}}}}}},\\\"notFullyAllocated\\\":{\\\"filter\\\":{\\\"and\\\":{\\\"filters\\\":[{\\\"term\\\":{\\\"isZeroAllocated\\\":false}},{\\\"term\\\":{\\\"isFullyAllocated\\\":false}}]}},\\\"aggregations\\\":{\\\"ME\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}},\\\"NOT_ME\\\":{\\\"filter\\\":{\\\"not\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}}}}}},\\\"allocationNotFullyInvoiced\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"isAllocationNotInvoiced\\\":true}},\\\"aggregations\\\":{\\\"ME\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}},\\\"NOT_ME\\\":{\\\"filter\\\":{\\\"not\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}}}}}},\\\"allocationNotFinalInvoiced\\\":{\\\"filter\\\":{\\\"and\\\":{\\\"filters\\\":[{\\\"term\\\":{\\\"isZeroAllocated\\\":false}},{\\\"term\\\":{\\\"isInvoicedFinal\\\":false}}]}},\\\"aggregations\\\":{\\\"ME\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}},\\\"NOT_ME\\\":{\\\"filter\\\":{\\\"not\\\":{\\\"filter\\\":{\\\"term\\\":{\\\"trafficOperatorSid\\\":\\\"SID-IhNqzHDayeRxFVJHzoRy\\\"}}}}}}},\\\"commodity\\\":{\\\"terms\\\":{\\\"field\\\":\\\"commodity\\\"},\\\"aggregations\\\":{\\\"quantityNormalised\\\":{\\\"sum\\\":{\\\"field\\\":\\\"quantityNormalised\\\"}},\\\"unallocatedQuantityNormalised\\\":{\\\"sum\\\":{\\\"field\\\":\\\"unallocatedQuantityNormalised\\\"}}}}}}}}}}\";\n        SearchRequestBuilder request = client()\n            .prepareSearch(INDEX)\n            .setSource(aggregationSource);\n\n        System.out.println(\"request = \" + prettyPrint(aggregationSource));\n\n        SearchResponse response = request\n            .execute()\n            .actionGet();\n\n        System.out.println(\"response = \" + response);\n\n        SingleBucketAggregation salesQuotas = response.getAggregations().get(\"sales_quotas\");\n        InternalDateRange dateRangeAggregation = salesQuotas.getAggregations().get(\"shipmentDate\");\n\n        assertAllZero(dateRangeAggregation, \"Overdue\");\n        assertExpectedValues(dateRangeAggregation, \"May\");\n        assertAllZero(dateRangeAggregation, \"June\");\n    }\n\n    private void assertExpectedValues(InternalDateRange dateRangeAggregation, String name)\n    {\n        InternalDateRange.Bucket bucket = dateRangeAggregation.getBucketByKey(name);\n        assertFilter(bucket, name, \"nothingAllocated\", 5, 3, 2);\n        assertFilter(bucket, name, \"notFullyAllocated\", 0, 0, 0);\n        assertFilter(bucket, name, \"allocationNotFullyInvoiced\", 0, 0, 0);\n        assertFilter(bucket, name, \"allocationNotFinalInvoiced\", 0, 0, 0);\n\n        StringTerms commodity = bucket.getAggregations().get(\"commodity\");\n        Collection<Terms.Bucket> buckets = commodity.getBuckets();\n        assertEquals(\"commodity buckets\", 1, buckets.size());\n        assertSum(buckets, \"quantityNormalised\", 5000.0);\n        assertSum(buckets, \"unallocatedQuantityNormalised\", 5000.0);\n    }\n\n    private void assertSum(Collection<Terms.Bucket> buckets, String name, double expectedValue)\n    {\n        InternalSum quantityNormalised = buckets.iterator().next().getAggregations().get(name);\n        assertEquals(name, expectedValue, quantityNormalised.getValue(), 0.1);\n    }\n\n    private void assertAllZero(InternalDateRange dateRangeAggregation, String name)\n    {\n        InternalDateRange.Bucket bucket = dateRangeAggregation.getBucketByKey(name);\n        assertFilter(bucket, name, \"nothingAllocated\", 0, 0, 0);\n        assertFilter(bucket, name, \"notFullyAllocated\", 0, 0, 0);\n        assertFilter(bucket, name, \"allocationNotFullyInvoiced\", 0, 0, 0);\n        assertFilter(bucket, name, \"allocationNotFinalInvoiced\", 0, 0, 0);\n\n        Aggregations aggregations = bucket.getAggregations();\n        StringTerms commodity = aggregations.get(\"commodity\");\n        assertEquals(name + \" commodity buckets should be zero\", 0, commodity.getBuckets().size());\n    }\n\n    private void assertFilter(InternalDateRange.Bucket bucket, String bucketName, String filterName, int expectedFilterCount, int expectedMeCount, int expectedNotMeCount)\n    {\n        String message = bucketName + \":\" + filterName;\n\n        Aggregations aggregations = bucket.getAggregations();\n\n        InternalFilter filter = aggregations.get(filterName);\n        assertEquals(message, expectedFilterCount, filter.getDocCount());\n\n        assertBreakdowns(message, filter.getAggregations(), expectedMeCount, expectedNotMeCount);\n    }\n\n    private void assertBreakdowns(String message, Aggregations aggregations, int expectedMeCount, int expectedNotMeCount)\n    {\n        assertBreakdown(aggregations, message, \"ME\", expectedMeCount);\n        assertBreakdown(aggregations, message, \"NOT_ME\", expectedNotMeCount);\n    }\n\n    private void assertBreakdown(Aggregations aggregations, String message, String subFilterName, int expectedCount)\n    {\n        InternalFilter filter = aggregations.get(subFilterName);\n        assertEquals(message + \":\" + subFilterName, expectedCount, filter.getDocCount());\n    }\n\n    private String prettyPrint(String aggregationSource) throws IOException\n    {\n        return json.writerWithDefaultPrettyPrinter().writeValueAsString(json.readValue(aggregationSource, Map.class));\n    }\n}\n\n```\n\nI hope this helps.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}