{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31834","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31834/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31834/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31834/events","html_url":"https://github.com/elastic/elasticsearch/issues/31834","id":338654285,"node_id":"MDU6SXNzdWUzMzg2NTQyODU=","number":31834,"title":"Assertion failures cause yaml REST tests to timeout instead of displaying error","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"assignees":[{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2018-07-05T16:58:46Z","updated_at":"2020-11-11T21:50:42Z","closed_at":"2019-10-04T12:48:13Z","author_association":"MEMBER","active_lock_reason":null,"body":"It appears that the yaml REST tests run with assertions enabled, but if an assertion is tripped it isn't reported to the user.  This causes the REST test to stall for 30s before failing with a generic timeout, and errors about lingering tasks.\r\n\r\nI'm afraid I don't know enough about the test infra to know how to fix this, or if it's fixable.  But it was very time-consuming to hunt down the cause.  Timeouts make you think faulty async logic or something, not an assertion being tripped.  If someone points me in the right direction I can take a crack at fixing this, if it is indeed fixable.\r\n\r\n**Longer version**\r\nThe timeout error looks like this.  You receive a null body back, the test framework complains about the request task still running and the listener times out after 30s:\r\n\r\n```\r\nHEARTBEAT J0 PID(10689@desktop): 2018-07-03T17:44:26, stalled for 31.7s at: XPackRestIT.test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index}\r\n  1> [2018-07-04T05:44:27,179][INFO ][o.e.x.t.r.XPackRestIT    ] Stash dump on test failure [{\r\n  1>   \"stash\" : {\r\n  1>     \"body\" : null\r\n  1>   }\r\n  1> }]\r\nHEARTBEAT J0 PID(10689@desktop): 2018-07-03T17:44:36, stalled for 41.7s at: XPackRestIT.test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index}\r\n  1> [2018-07-04T05:44:37,858][INFO ][o.e.x.t.r.XPackRestIT    ] There are still tasks running after this test that might break subsequent tests [indices:data/read/xpack/rollup/get/index/caps].\r\n  1> [2018-07-04T05:44:37,893][INFO ][o.e.x.t.r.XPackRestIT    ] [test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index}]: after test\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:plugin:integTestRunner -Dtests.seed=90C0204471BA5F00 -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT -Dtests.method=\"test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index}\" -Dtests.security.manager=true -Dtests.locale=de-CH -Dtests.timezone=Asia/Irkutsk -Dtests.rest.blacklist=getting_started/10_monitor_cluster_health/*\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:plugin:integTestRunner -Dtests.seed=90C0204471BA5F00 -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT -Dtests.method=\"test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index}\" -Dtests.security.manager=true -Dtests.locale=de-CH -Dtests.timezone=Asia/Irkutsk -Dtests.rest.blacklist=getting_started/10_monitor_cluster_health/*\r\nERROR   43.3s | XPackRestIT.test {p0=rollup/get_rollup_index_caps/Verify one job caps by rollup index} <<< FAILURES!\r\n   > Throwable #1: java.lang.RuntimeException: Failure at [rollup/get_rollup_index_caps:65]: listener timeout after waiting for [30000] ms\r\n   >    at org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:396)\r\n   >    at org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.test(ESClientYamlSuiteTestCase.java:371)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n   > Caused by: java.io.IOException: listener timeout after waiting for [30000] ms\r\n   >    at org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:899)\r\n   >    at org.elasticsearch.client.RestClient.performRequest(RestClient.java:227)\r\n   >    at org.elasticsearch.test.rest.yaml.ClientYamlTestClient.callApi(ClientYamlTestClient.java:192)\r\n   >    at org.elasticsearch.test.rest.yaml.ClientYamlTestExecutionContext.callApiInternal(ClientYamlTestExecutionContext.java:168)\r\n   >    at org.elasticsearch.test.rest.yaml.ClientYamlTestExecutionContext.callApi(ClientYamlTestExecutionContext.java:100)\r\n   >    at org.elasticsearch.test.rest.yaml.section.DoSection.execute(DoSection.java:243)\r\n   >    at org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:387)\r\n   >    ... 38 moreThrowable #2: java.lang.AssertionError: 1 active tasks found:\r\n   > indices:data/read/xpack/rollup/get/index/caps GvLOpehATvWmUC_M7s1A0A:46 -                         transport 1530654237179 17:43:57 40.2s       127.0.0.1 node-0 \r\n   >  expected:<0> but was:<1>\r\n   >    at org.elasticsearch.xpack.test.rest.XPackRestTestHelper.lambda$waitForPendingTasks$2(XPackRestTestHelper.java:110)\r\n   >    at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:767)\r\n   >    at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:741)\r\n   >    at org.elasticsearch.xpack.test.rest.XPackRestTestHelper.waitForPendingTasks(XPackRestTestHelper.java:90)\r\n   >    at org.elasticsearch.xpack.test.rest.XPackRestIT.cleanup(XPackRestIT.java:246)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n   >    Suppressed: java.lang.AssertionError: 1 active tasks found:\r\n   > indices:data/read/xpack/rollup/get/index/caps GvLOpehATvWmUC_M7s1A0A:46 -                         transport 1530654237179 17:43:57 30s         127.0.0.1 node-0 \r\n   >  expected:<0> but was:<1>\r\n   >            at org.elasticsearch.xpack.test.rest.XPackRestTestHelper.lambda$waitForPendingTasks$2(XPackRestTestHelper.java:110)\r\n   >            at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:755)\r\n   >            ... 38 more\r\n\r\n```\r\n\r\nAfter some debugging, I realized I was [tripping this assertion](https://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java#L258-L259).  If I comment out that assertion and rerun the test, I get the auth denial exception thrown by Security:\r\n\r\n```\r\n 1> [2018-07-04T06:25:22,987][INFO ][o.e.x.t.r.XPackRestIT    ] Stash dump on test failure [{\r\n  1>   \"stash\" : {\r\n  1>     \"body\" : {\r\n  1>       \"error\" : {\r\n  1>         \"root_cause\" : [\r\n  1>           {\r\n  1>             \"type\" : \"security_exception\",\r\n  1>             \"reason\" : \"action [indices:data/read/xpack/rollup/get/index/caps] is unauthorized for user [x_pack_rest_user]\",\r\n  1>             \"stack_trace\" : \"ElasticsearchSecurityException[action [indices:data/read/xpack/rollup/get/index/caps] is unauthorized for user [x_pack_rest_user]]\r\n  1>    at org.elasticsearch.xpack.core.security.support.Exceptions.authorizationError(Exceptions.java:30)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationService.denialException(AuthorizationService.java:574)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationService.denial(AuthorizationService.java:552)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationService.authorize(AuthorizationService.java:260)\r\n  1>    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.lambda$authorizeRequest$4(SecurityActionFilter.java:171)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.maybeRun(AuthorizationUtils.java:173)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.setRunAsRoles(AuthorizationUtils.java:167)\r\n  1>    at org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.authorize(AuthorizationUtils.java:155)\r\n  1>    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.authorizeRequest(SecurityActionFilter.java:183)\r\n  1>    at org.elasticsearch.xpack.security.action.filter.SecurityActionFilter.lambda$applyInternal$3(SecurityActionFilter.java:161)\r\n  1>    at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60)\r\n...\r\n...\r\n```\r\n\r\nSo it's definitely the assertion that's causing the timeout problem (aside from the _actual_ issue that caused the assertion to be tripped). ","closed_by":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"performed_via_github_app":null}