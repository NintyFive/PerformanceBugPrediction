{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33480","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33480/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33480/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33480/events","html_url":"https://github.com/elastic/elasticsearch/issues/33480","id":357794853,"node_id":"MDU6SXNzdWUzNTc3OTQ4NTM=","number":33480,"title":"Sort Parent Documents based on Inner_Hits result object field","user":{"login":"arunjp","id":989847,"node_id":"MDQ6VXNlcjk4OTg0Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/989847?v=4","gravatar_id":"","url":"https://api.github.com/users/arunjp","html_url":"https://github.com/arunjp","followers_url":"https://api.github.com/users/arunjp/followers","following_url":"https://api.github.com/users/arunjp/following{/other_user}","gists_url":"https://api.github.com/users/arunjp/gists{/gist_id}","starred_url":"https://api.github.com/users/arunjp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arunjp/subscriptions","organizations_url":"https://api.github.com/users/arunjp/orgs","repos_url":"https://api.github.com/users/arunjp/repos","events_url":"https://api.github.com/users/arunjp/events{/privacy}","received_events_url":"https://api.github.com/users/arunjp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-09-06T19:32:40Z","updated_at":"2018-09-07T06:30:27Z","closed_at":"2018-09-07T06:30:26Z","author_association":"NONE","active_lock_reason":null,"body":"I use ElasticSearch 6.3.2. I have Parent/Child relationship with my document model. I am trying to sort the Parent documents by child document's field determined by inner_hits.\r\n\r\nThis is the mapping:\r\n{\r\n\"offer_index\" : {\r\n\"aliases\" : { },\r\n\"mappings\" : {\r\n\"doc\" : {\r\n\"_routing\" : {\r\n\"required\" : true\r\n},\r\n\"properties\" : {\r\n\"couponType\" : {\r\n\"type\" : \"integer\"\r\n},\r\n\"cusip\" : {\r\n\"type\" : \"text\",\r\n\"fielddata\" : true\r\n},\r\n\"id\" : {\r\n\"type\" : \"text\",\r\n\"fields\" : {\r\n\"keyword\" : {\r\n\"type\" : \"keyword\",\r\n\"ignore_above\" : 256\r\n}\r\n}\r\n},\r\n\"isDeleted\" : {\r\n\"type\" : \"boolean\"\r\n},\r\n\"maxQuantity\" : {\r\n\"type\" : \"integer\"\r\n},\r\n\"minQuantity\" : {\r\n\"type\" : \"integer\"\r\n},\r\n\"myJoinField\" : {\r\n\"type\" : \"join\",\r\n\"eager_global_ordinals\" : true,\r\n\"relations\" : {\r\n\"parent\" : [\r\n\"offer\",\r\n\"bidwanted\"\r\n]\r\n}\r\n},\r\n\"price\" : {\r\n\"type\" : \"double\"\r\n}\r\n}\r\n}\r\n},\r\n\"settings\" : {\r\n\"index\" : {\r\n\"number_of_shards\" : \"5\",\r\n\"provided_name\" : \"280cap\",\r\n\"max_result_window\" : \"5000000\",\r\n\"creation_date\" : \"1536100881435\",\r\n\"number_of_replicas\" : \"1\",\r\n\"uuid\" : \"dzoTEMPxSdiC_BNswjlW2w\",\r\n\"version\" : {\r\n\"created\" : \"6030299\"\r\n}\r\n}\r\n}\r\n}\r\n}\r\n\r\nSecurity (Parent) Document looks like this (Simplified):\r\n{\r\n\"cusip\": \"914072TD5\",\r\n\"myJoinField\": \"parent\"\r\n}\r\n\r\nMultiple Offer (Child) Documents (Simplified):\r\n[\r\n{\r\n\"price\": 101.532,\r\n\"cusip\": \"914072TD5\",\r\n\"minQuantity\": 5,\r\n\"maxQuantity\": 5,\r\n\"isDeleted\": false,\r\n\"id\": \"TITUSOFR-O_04-sep-2018_31_75389-20180904\",\r\n\"myJoinField\": {\r\n\"name\": \"offer\",\r\n\"parent\": \"914072TD5\"\r\n}\r\n},\r\n{\r\n\"price\": 103.957,\r\n\"cusip\": \"914072TD5\",\r\n\"minQuantity\": 20,\r\n\"maxQuantity\": 20,\r\n\"isDeleted\": false,\r\n\"id\": \"TITUSOFR-O_04-sep-2018_31_237004-20180904\",\r\n\"myJoinField\": {\r\n\"name\": \"offer\",\r\n\"parent\": \"914072TD5\"\r\n}\r\n},\r\n{\r\n\"price\": 117.005,\r\n\"cusip\": \"914072TD5\",\r\n\"minQuantity\": 10,\r\n\"maxQuantity\": 10,\r\n\"isDeleted\": false,\r\n\"id\": \"TITUSOFR-O_06-aug-2018_0_55656-20180904\",\r\n\"myJoinField\": {\r\n\"name\": \"offer\",\r\n\"parent\": \"914072TD5\"\r\n}\r\n}\r\n]\r\nQuery looks like this:\r\n{\r\n\"from\": 0,\r\n\"size\": 12,\r\n\"query\": {\r\n\"bool\": {\r\n\"filter\": [\r\n{\r\n\"exists\": {\r\n\"field\": \"couponType\"\r\n}\r\n}],\r\n\"must\": [\r\n{\r\n\"has_child\" : {\r\n\"type\" : \"offer\",\r\n\"score_mode\" : \"min\",\r\n\"query\" : {\r\n\"function_score\": {\r\n\"query\": {\r\n\"bool\": {\r\n    \"filter\": [\r\n      {\r\n                \r\n                \r\n                \"term\" : {\r\n                \"isDeleted\" : false\r\n            }\r\n                \r\n      }],\r\n      \"must\": [\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"maxQuantity\"\r\n          }\r\n        }\r\n      ]          \r\n                }\r\n                \r\n              },\r\n        \"field_value_factor\": {\r\n            \"field\": \"maxQuantity\",\r\n            \"factor\": 1,\r\n            \"missing\": 1\r\n        },\r\n              \"boost_mode\": \"replace\"\r\n    }\r\n        },\r\n          \"inner_hits\": {\r\n              \"sort\": [\r\n      {\r\n        \"price\": {\r\n          \"order\": \"asc\"\r\n        }\r\n      }\r\n\t  ],\r\n    \"size\": 1\r\n          }\r\n    }\r\n  }]\r\n}\r\n},\r\n\"sort\": [\r\n    {\r\n        \"_score\": {\r\n            \"order\": \"asc\"\r\n        }\r\n    }\r\n]\r\n}\r\n\r\nBasically, this is the approach:\r\n\r\nGet the lowest price Offer (child) document for each Security (Parent). For this, in the search query, I use \"has_child\" and \"inner_hits\" with sort (on inner_hits) by price having size:1. This returns one Offer document that has the lowest price.\r\nThen, I want to sort Security (Parent) documents based on the returned Offer (returned by the above inner_hits) document's maxQuantity value.\r\nThe above query does not sort the Security (Parent) documents by the maxQuantity (of the resulted Offer child document). This is because the function_score is applied on all the three Offer documents and picks the minimum score from all three (coz of score_mode being minimum). Ideally, the function_score should be applied only on the single Offer returned by the inner_hits.\r\n\r\nWhat's the recommendation on achieving this?\r\n\r\nThanks a lot.\r\nArun","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}