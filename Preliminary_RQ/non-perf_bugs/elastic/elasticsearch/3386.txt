{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3386","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3386/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3386/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3386/events","html_url":"https://github.com/elastic/elasticsearch/issues/3386","id":17185001,"node_id":"MDU6SXNzdWUxNzE4NTAwMQ==","number":3386,"title":"Possible Threadlocal leak in Tomcat","user":{"login":"MattFriedman","id":2347312,"node_id":"MDQ6VXNlcjIzNDczMTI=","avatar_url":"https://avatars0.githubusercontent.com/u/2347312?v=4","gravatar_id":"","url":"https://api.github.com/users/MattFriedman","html_url":"https://github.com/MattFriedman","followers_url":"https://api.github.com/users/MattFriedman/followers","following_url":"https://api.github.com/users/MattFriedman/following{/other_user}","gists_url":"https://api.github.com/users/MattFriedman/gists{/gist_id}","starred_url":"https://api.github.com/users/MattFriedman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MattFriedman/subscriptions","organizations_url":"https://api.github.com/users/MattFriedman/orgs","repos_url":"https://api.github.com/users/MattFriedman/repos","events_url":"https://api.github.com/users/MattFriedman/events{/privacy}","received_events_url":"https://api.github.com/users/MattFriedman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-07-24T22:38:38Z","updated_at":"2014-08-08T13:40:26Z","closed_at":"2014-08-08T13:40:26Z","author_association":"NONE","active_lock_reason":null,"body":"Here is my Java initialization code for use with Spring:\n\n```\npublic class IndexerClientFactory {\n\nprivate Client client;\nprivate Node node;\n\n@Autowired\nString elasticsearchHostname;\n\n@Autowired\nString elasticsearchNode1Name;\n\npublic Client searchClient() {\n\n    Settings settings = ImmutableSettings.settingsBuilder()\n            .put(\"node.name\", elasticsearchNode1Name)\n            .put(\"network.host\", elasticsearchHostname)\n            .build();\n\n    node = NodeBuilder.nodeBuilder()\n            .settings(settings)\n            .data(false)\n            .client(true)\n            .node();\n\n    client = node.client();\n\n    return client;\n}\n\npublic void cleanShutdown() {\n\n    if (client != null) {\n        client.close();\n    }\n\n    if (node != null) {\n        node.close();\n    }\n\n}\n}\n```\n\nAnd the associated Spring xml:\n\n```\n<bean destroy-method=\"cleanShutdown\" name=\"searchClientFactoryBean\"\n      class=\"info.afilias.intdir.indexer.context.IndexerClientFactory\"/>\n\n<bean name=\"searchClient\" factory-bean=\"searchClientFactoryBean\" factory-method=\"searchClient\"/>\n```\n\nI can see cleanShutdown() being called in the logs.\n\nYet I still see the following also in the logs:\n\nSEVERE: The web application [/indexer] created a ThreadLocal with key of type [org.elasticsearch.common.inject.InjectorImpl$1](value [org.elasticsearch.common.inject.InjectorImpl$1@556f7ce3]) and a value of type [java.lang.Object[]](value [[Ljava.lang.Object;@a7046e7]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}