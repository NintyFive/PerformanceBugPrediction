[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/601623673","html_url":"https://github.com/elastic/elasticsearch/issues/53835#issuecomment-601623673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835","id":601623673,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMTYyMzY3Mw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-03-20T10:14:55Z","updated_at":"2020-03-20T10:14:55Z","author_association":"MEMBER","body":"@mattweber \r\n\r\nThat reproducing code looks buggy to me and without seeing the full stack trace/reproducing-code it is very hard to tell what is going on here. Regardless, you will need to close the `XContentBuilder` after you wrote the value to it.\r\n\r\n```\r\ntry (XContentBuilder builder = XContentFactory.jsonBuilder(respOut)) {\r\n            builder.startObject();\r\n            searchResponse.toXContent(builder, ToXContent.EMPTY_PARAMS);\r\n            builder.endObject();\r\n}\r\n```\r\n\r\nThis will require to wrap `respOut` though because your builder will close the stream it wraps.\r\n\r\nI don't see how there is a possible bug here at this point so I'm closing this. If you want to discuss the details of the above I'd ask you to open an issue on our [discuss forums](https://discuss.elastic.co/c/elasticsearch) since we reserve Github for feature requests and confirmed bug reports.\r\nThanks!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/601700617","html_url":"https://github.com/elastic/elasticsearch/issues/53835#issuecomment-601700617","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835","id":601700617,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMTcwMDYxNw==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2020-03-20T13:28:26Z","updated_at":"2020-03-20T13:28:26Z","author_association":"CONTRIBUTOR","body":"@original-brownbear thanks, the snippet was intentionally short to try and show where the exception is being thrown from.  In the real one code the builder is closed, exception happens before that though.  Also, using `value` on the builder calls `toXContent` just like your snippet.  \r\n\r\nAnyways, pretty sure there is a bug in the page recycling code somewhere as using the non-recycling big arrays won't reproduce.  Will move to the mailing list if I can't track this down myself.","performed_via_github_app":null}]