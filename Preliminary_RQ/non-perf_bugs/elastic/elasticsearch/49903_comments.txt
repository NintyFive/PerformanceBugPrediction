[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562511749","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-562511749","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":562511749,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MjUxMTc0OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-12-06T10:05:29Z","updated_at":"2019-12-06T10:05:29Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/Network)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562652659","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-562652659","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":562652659,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MjY1MjY1OQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-12-06T16:56:22Z","updated_at":"2019-12-06T16:56:22Z","author_association":"CONTRIBUTOR","body":"The same problem just occurred in a master branch build: https://gradle-enterprise.elastic.co/s/ndvcwkkioy3au\r\n\r\nI will mute the test.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/562658952","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-562658952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":562658952,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MjY1ODk1Mg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-12-06T17:12:51Z","updated_at":"2019-12-06T17:24:52Z","author_association":"CONTRIBUTOR","body":"Muting commits:\r\n\r\n* master: d68bf19ea32da99c1bfcc1c16f851185e8d9b0e0\r\n* 7.x: 17fa9d584485ad1db627a0494ca781a44a435964\r\n* 7.5: b89ff63eb08794ef50658569672d1d7c2d150fe1\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/568171420","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-568171420","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":568171420,"node_id":"MDEyOklzc3VlQ29tbWVudDU2ODE3MTQyMA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-12-21T10:47:57Z","updated_at":"2019-12-21T10:48:39Z","author_association":"CONTRIBUTOR","body":"I had a go at reproducing this on 7.5 (1aa983a07c546c344c3c1c6f98684d782ac4dca8 plus a revert of b89ff63eb08794ef50658569672d1d7c2d150fe1) by running this in on a loop on my CI machine:\r\n\r\n```\r\n./gradlew ':server:test' --tests \"org.elasticsearch.transport.ConnectionManagerTests.testConcurrentConnectsAndDisconnects\" -Dtests.failfast=true -Dtests.iters=100\r\n```\r\n\r\nI also had `stress -c 24` running in the background in the hope that the extra CPU pressure would help to shake it out. 2Â½ days later it failed on the 4151th iteration:\r\n\r\n```\r\n> Task :server:test\r\n\r\norg.elasticsearch.transport.ConnectionManagerTests > testConcurrentConnectsAndDisconnects {seed=[956E8C99B5983973:416EDA3121A00F7]} FAILED\r\n    java.lang.Exception: Test abandoned because suite timeout was reached.\r\n\r\norg.elasticsearch.transport.ConnectionManagerTests > classMethod FAILED\r\n    java.lang.Exception: Suite timeout exceeded (>= 1200000 msec).\r\n\r\norg.elasticsearch.transport.ConnectionManagerTests > classMethod FAILED\r\n    com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=644, name=elasticsearch[ConnectionManagerTests][generic][T#2], state=RUNNABLE, group=TGRP-ConnectionManagerTests]\r\n\r\n        Caused by:\r\n        java.lang.AssertionError: Expected node to be connected\r\n            at __randomizedtesting.SeedInfo.seed([956E8C99B5983973]:0)\r\n            at org.elasticsearch.transport.ConnectionManagerTests.lambda$testConcurrentConnectsAndDisconnects$10(ConnectionManagerTests.java:171)\r\n            at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\r\n            at org.elasticsearch.common.util.concurrent.ListenableFuture$1.doRun(ListenableFuture.java:112)\r\n            at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n            at org.elasticsearch.common.util.concurrent.EsExecutors$DirectExecutorService.execute(EsExecutors.java:225)\r\n            at org.elasticsearch.common.util.concurrent.ListenableFuture.notifyListener(ListenableFuture.java:106)\r\n            at org.elasticsearch.common.util.concurrent.ListenableFuture.lambda$done$0(ListenableFuture.java:98)\r\n            at java.base/java.util.ArrayList.forEach(ArrayList.java:1540)\r\n            at org.elasticsearch.common.util.concurrent.ListenableFuture.done(ListenableFuture.java:98)\r\n            at org.elasticsearch.common.util.concurrent.BaseFuture.set(BaseFuture.java:144)\r\n            at org.elasticsearch.common.util.concurrent.ListenableFuture.onResponse(ListenableFuture.java:127)\r\n            at org.elasticsearch.transport.ConnectionManager.lambda$connectToNode$1(ConnectionManager.java:165)\r\n            at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\r\n            at org.elasticsearch.transport.ConnectionManagerTests.lambda$testConcurrentConnectsAndDisconnects$7(ConnectionManagerTests.java:148)\r\n```\r\n\r\nSo it _does_ reproduce, but not easily.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/568247956","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-568247956","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":568247956,"node_id":"MDEyOklzc3VlQ29tbWVudDU2ODI0Nzk1Ng==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-12-22T10:00:51Z","updated_at":"2019-12-22T10:00:51Z","author_association":"CONTRIBUTOR","body":"Reproduces more reliably with this:\r\n\r\n```diff\r\ndiff --git a/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java b/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java\r\nindex 110053bcee7..260fc03a48e 100644\r\n--- a/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java\r\n+++ b/server/src/main/java/org/elasticsearch/transport/ConnectionManager.java\r\n@@ -124,6 +124,12 @@ public class ConnectionManager implements Closeable {\r\n             return;\r\n         }\r\n\r\n+        try {\r\n+            Thread.sleep(Randomness.get().nextInt(500));\r\n+        } catch (InterruptedException e) {\r\n+            throw new AssertionError(e);\r\n+        }\r\n+\r\n         final ListenableFuture<Void> currentListener = new ListenableFuture<>();\r\n         final ListenableFuture<Void> existingListener = pendingConnections.putIfAbsent(node, currentListener);\r\n         if (existingListener != null) {\r\n```\r\n\r\nIn the test we return the same `Transport.Connection` instance from each call to `openConnection()`, so these lines close the connection we were expecting to reuse:\r\n\r\n```\r\n                        if (connectedNodes.putIfAbsent(node, conn) != null) {\r\n                            logger.debug(\"existing connection to node [{}], closing new redundant connection\", node);\r\n                            IOUtils.closeWhileHandlingException(conn);\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/570648190","html_url":"https://github.com/elastic/elasticsearch/issues/49903#issuecomment-570648190","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49903","id":570648190,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MDY0ODE5MA==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2020-01-03T17:57:08Z","updated_at":"2020-01-03T17:57:08Z","author_association":"CONTRIBUTOR","body":"Thanks @DaveCTurner. That insight makes this test easy to fix.","performed_via_github_app":null}]