{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/56273","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56273/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56273/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56273/events","html_url":"https://github.com/elastic/elasticsearch/issues/56273","id":613238034,"node_id":"MDU6SXNzdWU2MTMyMzgwMzQ=","number":56273,"title":"Duplicate documents when using ILM rollover","user":{"login":"CSharpBender","id":42767528,"node_id":"MDQ6VXNlcjQyNzY3NTI4","avatar_url":"https://avatars1.githubusercontent.com/u/42767528?v=4","gravatar_id":"","url":"https://api.github.com/users/CSharpBender","html_url":"https://github.com/CSharpBender","followers_url":"https://api.github.com/users/CSharpBender/followers","following_url":"https://api.github.com/users/CSharpBender/following{/other_user}","gists_url":"https://api.github.com/users/CSharpBender/gists{/gist_id}","starred_url":"https://api.github.com/users/CSharpBender/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CSharpBender/subscriptions","organizations_url":"https://api.github.com/users/CSharpBender/orgs","repos_url":"https://api.github.com/users/CSharpBender/repos","events_url":"https://api.github.com/users/CSharpBender/events{/privacy}","received_events_url":"https://api.github.com/users/CSharpBender/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-05-06T11:11:38Z","updated_at":"2020-05-06T16:36:30Z","closed_at":"2020-05-06T16:36:30Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nElasticsearch 7.6.1\r\n**Plugins installed**: []\r\nNest 7.6.1\r\n**JVM version** (`java -version`):\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13.0.2+8, mixed mode, sharing)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux c87e626860d1 4.19.76-linuxkit #1 SMP Thu Oct 17 19:31:58 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI have a big index that keeps historical data and only the documents within the last month are being updated so using index rollover seems perfect for this use case.\r\nThe problem is that I need to be able to update/delete last month records but when the rollover happens I end up with duplicate documents with the same ID.\r\nIt seems that rollover works only with data that never gets updated, like application logs.\r\n\r\n**Steps to reproduce**:\r\nAlthough my scenario is to edit last month entries this reproduces whenever the rollover happens and one document gets updated. So it doesn't matter if it's one month or one day.\r\nSetup ILM policy with max 2 documents\r\n```\r\nPUT _ilm/policy/mytest_rollover_policy\r\n{\r\n  \"policy\": {\r\n    \"phases\": {\r\n      \"hot\": {\r\n        \"actions\": {\r\n          \"rollover\": {           \r\n            \"max_docs\": 2\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT _template/mytest_template\r\n{\r\n  \"index_patterns\": [\"mytest-*\"],                 \r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0,\r\n    \"index.lifecycle.name\": \"mytest_rollover_policy\",      \r\n    \"index.lifecycle.rollover_alias\": \"mytest\"    \r\n  }\r\n}\r\n\r\nPUT mytest-000001\r\n{\r\n  \"aliases\": {\r\n    \"mytest\": {\r\n      \"is_write_index\": true\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"name\":   { \"type\": \"text\"  }     \r\n    }\r\n  }\r\n}\r\n```\r\nInsert documents and wait for rollover to happen\r\n```\r\nPUT /mytest/_doc/1\r\n{\r\n \"name\" : \"Name1\"\r\n}\r\n\r\nPUT /mytest/_doc/2\r\n{\r\n \"name\" : \"Name2\"\r\n}\r\n\r\nPUT /mytest/_doc/3\r\n{\r\n \"name\" : \"Name3\"\r\n}\r\n```\r\nMake a document update\r\n```\r\nPUT /mytest/_doc/1\r\n{\r\n \"name\" : \"Name1111\"\r\n}\r\n```\r\n\r\nQuery for the documents and notice that the document with ID=1 is duplicated\r\n```\r\nGET /mytest/_search\r\n```\r\n\r\nI understand that only one index is writable and the original document cannot be updated but because I'm using the alias I was expecting to get only the latest document which is stored in the active writable index.","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}