{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15179","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15179/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15179/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15179/events","html_url":"https://github.com/elastic/elasticsearch/issues/15179","id":119925607,"node_id":"MDU6SXNzdWUxMTk5MjU2MDc=","number":15179,"title":"Geohash query not working after migrating to Elasticsearch 2.0/2.1","user":{"login":"jmatraszek","id":367639,"node_id":"MDQ6VXNlcjM2NzYzOQ==","avatar_url":"https://avatars2.githubusercontent.com/u/367639?v=4","gravatar_id":"","url":"https://api.github.com/users/jmatraszek","html_url":"https://github.com/jmatraszek","followers_url":"https://api.github.com/users/jmatraszek/followers","following_url":"https://api.github.com/users/jmatraszek/following{/other_user}","gists_url":"https://api.github.com/users/jmatraszek/gists{/gist_id}","starred_url":"https://api.github.com/users/jmatraszek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmatraszek/subscriptions","organizations_url":"https://api.github.com/users/jmatraszek/orgs","repos_url":"https://api.github.com/users/jmatraszek/repos","events_url":"https://api.github.com/users/jmatraszek/events{/privacy}","received_events_url":"https://api.github.com/users/jmatraszek/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-12-02T11:51:48Z","updated_at":"2016-03-09T15:36:33Z","closed_at":"2016-03-09T15:36:33Z","author_association":"NONE","active_lock_reason":null,"body":"I am having trouble with my query after migrating to Elasticsearch 2.0/2.1. Previously used version 1.4. I am trying to do a GeoDistance query using geohash. That's the excerpt from ES response:\n\n```\n\"root_cause\": [\n  {\n    \"type\": \"query_parsing_exception\",\n    \"reason\": \"failed to find geo_point field [geohash]\",\n    \"index\": \"campaigns\",\n    \"line\": 1,\n    \"col\": 234\n  }\n]\n```\n\nThe minimal index usable to reproduce this problem is as follows:\n\n```\ncurl -s -X PUT \"http://localhost:9200/campaigns\" -d'{\n    \"settings\": {\n            \"analysis\": {\n                \"filter\": {\n                    \"name_ngram\": {\n                        \"type\": \"nGram\",\n                        \"min_gram\": \"2\",\n                        \"max_gram\": \"50\"\n                    }\n                },\n                \"analyzer\": {\n                    \"search_analyzer\": {\n                        \"filter\": [\n                            \"standard\",\n                            \"asciifolding\",\n                            \"lowercase\",\n                            \"trim\"\n                        ],\n                        \"tokenizer\": \"standard\"\n                    },\n                    \"name_analyzer\": {\n                        \"filter\": [\n                            \"name_ngram\",\n                            \"standard\",\n                            \"asciifolding\",\n                            \"lowercase\",\n                            \"trim\"\n                        ],\n                        \"tokenizer\": \"standard\"\n                    }\n                }                                                                                                                                                                                                                                                                \n            }                                                                                                                                                                                                                                                                    \n    },                                                                                                                                                                                                                                                                           \n    \"mappings\": {                                                                                                                                                                                                                                                                \n        \"campaign\": {                                                                                                                                                                                                                                                            \n            \"properties\": {                                                                                                                                                                                                                                                      \n                \"locations\": {                                                                                                                                                                                                                                                   \n                    \"properties\": {                                                                                                                                                                                                                                              \n                        \"id\": {                                                                                                                                                                                                                                                  \n                            \"include_in_all\": false,                                                                                                                                                                                                                             \n                            \"type\": \"integer\"                                                                                                                                                                                                                                    \n                        },                                                                                                                                                                                                                                                       \n                        \"geohash\": {                                                                                                                                                                                                                                             \n                            \"type\": \"geo_point\"                                                                                                                                                                                                                                  \n                        }                                                                                                                                                                                                                                                        \n                    },                                                                                                                                                                                                                                                           \n                    \"type\": \"nested\"                                                                                                                                                                                                                                             \n                },                                                                                                                                                                                                                                                               \n                \"id\": {                                                                                                                                                                                                                                                          \n                    \"type\": \"integer\"                                                                                                                                                                                                                                            \n                }                                                                                                                                                                                                                                                                \n            },                                                                                                                                                                                                                                                                   \n            \"_all\": {                                                                                                                                                                                                                                                            \n                \"search_analyzer\": \"search_analyzer\",                                                                                                                                                                                                                            \n                \"analyzer\": \"name_analyzer\"                                                                                                                                                                                                                                      \n            }                                                                                                                                                                                                                                                                    \n        }                                                                                                                                                                                                                                                                        \n    }                                                                                                                                                                                                                                                                            \n}'\n```\n\nI am using two analyzers here (as this is what I am using in my project, tried also with one analyzer and the result is the same).\n\nThe minimal data indexed in ES is as follows:\n\n```\ncurl -s -X POST \"http://localhost:9200/campaigns/campaign\" -d'{\n    \"id\": 12,\n    \"locations\": [\n        {\n            \"id\": 13,\n            \"geohash\": {\n                \"geohash\": \"s7ws01wyd7ws\"\n            }\n        }\n    ]\n}'\n```\n\nThe mapping in ES:\n\n```\ncurl -s -X GET \"http://localhost:9200/campaigns/_mapping?pretty\"\n{\n  \"campaigns\" : {\n    \"mappings\" : {\n      \"campaign\" : {\n        \"_all\" : {\n          \"analyzer\" : \"name_analyzer\",\n          \"search_analyzer\" : \"search_analyzer\"\n        },\n        \"properties\" : {\n          \"id\" : {\n            \"type\" : \"integer\"\n          },\n          \"locations\" : {\n            \"type\" : \"nested\",\n            \"properties\" : {\n              \"geohash\" : {\n                \"type\" : \"geo_point\"\n              },\n              \"id\" : {\n                \"type\" : \"integer\",\n                \"include_in_all\" : false\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nWorking query to search by \"locations.id\":\n\n```\ncurl -s -X POST \"http://localhost:9200/campaigns/_search\" -d@'{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"locations\",\n          \"filter\": {\n            \"term\": {\n              \"locations.id\": \"13\"\n            }\n          }\n        }\n      }\n    }\n  }\n}' | jq ''\n{\n  \"took\": 5,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 1,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"campaigns\",\n        \"_type\": \"campaign\",\n        \"_id\": \"AVFYQn4uic5h_a2BXp1k\",\n        \"_score\": 1,\n        \"_source\": {\n          \"id\": 12,\n          \"locations\": [\n            {\n              \"id\": 13,\n              \"geohash\": {\n                \"geohash\": \"s7ws01wyd7ws\"\n              }\n            }\n          ]\n        }\n      }\n    ]\n  }\n}\n```\n\nNot working query to search by \"geohash\" (only when the data is posted from file, but the same response is returned in my application):\n\n```\ncat query_geohash.json \n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"locations\",\n          \"filter\": {\n            \"geo_distance\": {\n              \"distance\": \"100.0km\",\n              \"geohash\": \"s7ws01wyd7ws\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\ncurl -s -X POST \"http://localhost:9200/campaigns/_search\" -d@query_geohash.json | jq ''\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"query_parsing_exception\",\n        \"reason\": \"failed to find geo_point field [geohash]\",\n        \"index\": \"campaigns\",\n        \"line\": 1,\n        \"col\": 234\n      }\n    ],\n    \"type\": \"search_phase_execution_exception\",\n    \"reason\": \"all shards failed\",\n    \"phase\": \"query\",\n    \"grouped\": true,\n    \"failed_shards\": [\n      {\n        \"shard\": 0,\n        \"index\": \"campaigns\",\n        \"node\": \"cqrNlEmRSPGcGewKuUvlnA\",\n        \"reason\": {\n          \"type\": \"query_parsing_exception\",\n          \"reason\": \"failed to find geo_point field [geohash]\",\n          \"index\": \"campaigns\",\n          \"line\": 1,\n          \"col\": 234\n        }\n      }\n    ]\n  },\n  \"status\": 400\n}\n```\n\nStrangely, the same query works OK when the query is not read from file, but posted \"inline\":\n\n```\ncurl -s -X POST \"http://localhost:9200/campaigns/_search\" -d@'{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"locations\",\n          \"filter\": {\n            \"geo_distance\": {\n              \"distance\": \"100.0km\",\n              \"geohash\": \"s7ws01wyd7ws\"\n            }\n          }\n        }\n      }\n    }\n  }\n}' | jq ''\n{\n  \"took\": 11,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 1,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"campaigns\",\n        \"_type\": \"campaign\",\n        \"_id\": \"AVFYQn4uic5h_a2BXp1k\",\n        \"_score\": 1,\n        \"_source\": {\n          \"id\": 12,\n          \"locations\": [\n            {\n              \"id\": 13,\n              \"geohash\": {\n                \"geohash\": \"s7ws01wyd7ws\"\n              }\n            }\n          ]\n        }\n      }\n    ]\n  }\n}\n```\n\nWhat am I missing here? The geohash query itself looks OK (response is the same when I use \"locations.geohash\" instead of \"geohash\"). The only difference is the way the query is fed to curl. Also, both versions work correctly in ES 1.4.\n\nI am not sure if this is a bug in Elasticsearch or if I made some mistake in my query. Anyway, I'll be really grateful for any help!\n","closed_by":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"performed_via_github_app":null}