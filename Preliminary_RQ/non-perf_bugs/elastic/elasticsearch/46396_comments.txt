[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/528420912","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-528420912","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":528420912,"node_id":"MDEyOklzc3VlQ29tbWVudDUyODQyMDkxMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-09-05T15:20:02Z","updated_at":"2019-09-05T15:20:02Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534442918","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-534442918","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":534442918,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDQ0MjkxOA==","user":{"login":"verkhovin","id":15959667,"node_id":"MDQ6VXNlcjE1OTU5NjY3","avatar_url":"https://avatars0.githubusercontent.com/u/15959667?v=4","gravatar_id":"","url":"https://api.github.com/users/verkhovin","html_url":"https://github.com/verkhovin","followers_url":"https://api.github.com/users/verkhovin/followers","following_url":"https://api.github.com/users/verkhovin/following{/other_user}","gists_url":"https://api.github.com/users/verkhovin/gists{/gist_id}","starred_url":"https://api.github.com/users/verkhovin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/verkhovin/subscriptions","organizations_url":"https://api.github.com/users/verkhovin/orgs","repos_url":"https://api.github.com/users/verkhovin/repos","events_url":"https://api.github.com/users/verkhovin/events{/privacy}","received_events_url":"https://api.github.com/users/verkhovin/received_events","type":"User","site_admin":false},"created_at":"2019-09-24T08:05:18Z","updated_at":"2019-09-24T08:05:18Z","author_association":"CONTRIBUTOR","body":"@astefan can i take a look at this issue?\r\nIt seems that the query isn't correct. So what is expected behavior for the case? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/535438688","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-535438688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":535438688,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTQzODY4OA==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T10:17:10Z","updated_at":"2019-09-26T10:17:10Z","author_association":"CONTRIBUTOR","body":"@verkhovin Please feel free to take a look.\r\nThe expected behavior would be to throw an Exception ideally from the `Verifier` with an error message like this:\r\n```\r\n1:61 GROUP BY \"g\" is ambiguous\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/535459595","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-535459595","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":535459595,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTQ1OTU5NQ==","user":{"login":"verkhovin","id":15959667,"node_id":"MDQ6VXNlcjE1OTU5NjY3","avatar_url":"https://avatars0.githubusercontent.com/u/15959667?v=4","gravatar_id":"","url":"https://api.github.com/users/verkhovin","html_url":"https://github.com/verkhovin","followers_url":"https://api.github.com/users/verkhovin/followers","following_url":"https://api.github.com/users/verkhovin/following{/other_user}","gists_url":"https://api.github.com/users/verkhovin/gists{/gist_id}","starred_url":"https://api.github.com/users/verkhovin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/verkhovin/subscriptions","organizations_url":"https://api.github.com/users/verkhovin/orgs","repos_url":"https://api.github.com/users/verkhovin/repos","events_url":"https://api.github.com/users/verkhovin/events{/privacy}","received_events_url":"https://api.github.com/users/verkhovin/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T11:23:18Z","updated_at":"2019-09-26T11:23:18Z","author_association":"CONTRIBUTOR","body":"@matriv I'll write here if I find something interesting. Thank you. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/535725860","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-535725860","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":535725860,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTcyNTg2MA==","user":{"login":"verkhovin","id":15959667,"node_id":"MDQ6VXNlcjE1OTU5NjY3","avatar_url":"https://avatars0.githubusercontent.com/u/15959667?v=4","gravatar_id":"","url":"https://api.github.com/users/verkhovin","html_url":"https://github.com/verkhovin","followers_url":"https://api.github.com/users/verkhovin/followers","following_url":"https://api.github.com/users/verkhovin/following{/other_user}","gists_url":"https://api.github.com/users/verkhovin/gists{/gist_id}","starred_url":"https://api.github.com/users/verkhovin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/verkhovin/subscriptions","organizations_url":"https://api.github.com/users/verkhovin/orgs","repos_url":"https://api.github.com/users/verkhovin/repos","events_url":"https://api.github.com/users/verkhovin/events{/privacy}","received_events_url":"https://api.github.com/users/verkhovin/received_events","type":"User","site_admin":false},"created_at":"2019-09-26T23:46:50Z","updated_at":"2019-09-27T08:03:34Z","author_association":"CONTRIBUTOR","body":"Here what I've found.\r\nThe error is caused by `org.elasticsearch.xpack.sql.analysis.analyzer.Analyzer.ResolveRefs` resolver. It calls `resolveAgainstList(...)` method (refer to `Analyzer.java` line `340`), which tries to resolve alias from group by statement against aggregates resolved before. In the given case it obviously fails (as there is 2 matches between aggregates and alias) and returns `UnresolvedAttribute` (refer to `Analyzer.java` line `198`) instance.\r\nThen this instance is used to get corresponding aggregate from `resolved` map  (refer to `Analyzer.java` line `344`), here `null` is returned from the map. And in lines `347-350` this `null` value is passed to newly constructed `aggregate`.\r\n\r\nThe NPE is thrown on the next resolver (`ResolveOrdinalInOrderByAndGroupBy`), as Aggregate returned from `ResolveRefs` contains `null` value in groupings.\r\n\r\n@matriv @astefan Can you please suggest how should I fix it in a proper way.\r\nIt seems that `Verifier` works after `Analyzer`, so we should handle described situation in `Analyzer` somehow without throwing exception and then fail when will `Verifier` start work.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/606062320","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-606062320","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":606062320,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNjA2MjMyMA==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2020-03-30T15:16:33Z","updated_at":"2020-03-30T15:16:33Z","author_association":"CONTRIBUTOR","body":"@elastic/es-ql","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/609838517","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-609838517","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":609838517,"node_id":"MDEyOklzc3VlQ29tbWVudDYwOTgzODUxNw==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2020-04-06T14:44:31Z","updated_at":"2020-04-06T14:44:31Z","author_association":"CONTRIBUTOR","body":"Hi @verkhovin,\r\n\r\nApologies for stalling this issue, there has been some important refactoring meanwhile in #49693\r\nthat could change the approach of catching the duplicate aliases. Would you have time to work again on this? We would be happy to provide guidance if so.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624019739","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-624019739","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":624019739,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDAxOTczOQ==","user":{"login":"verkhovin","id":15959667,"node_id":"MDQ6VXNlcjE1OTU5NjY3","avatar_url":"https://avatars0.githubusercontent.com/u/15959667?v=4","gravatar_id":"","url":"https://api.github.com/users/verkhovin","html_url":"https://github.com/verkhovin","followers_url":"https://api.github.com/users/verkhovin/followers","following_url":"https://api.github.com/users/verkhovin/following{/other_user}","gists_url":"https://api.github.com/users/verkhovin/gists{/gist_id}","starred_url":"https://api.github.com/users/verkhovin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/verkhovin/subscriptions","organizations_url":"https://api.github.com/users/verkhovin/orgs","repos_url":"https://api.github.com/users/verkhovin/repos","events_url":"https://api.github.com/users/verkhovin/events{/privacy}","received_events_url":"https://api.github.com/users/verkhovin/received_events","type":"User","site_admin":false},"created_at":"2020-05-05T12:15:28Z","updated_at":"2020-05-06T06:08:57Z","author_association":"CONTRIBUTOR","body":"@matriv Hi\r\nsorry, i missed the notification. If it is still relevant, i can get it in the nearest future","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/625759193","html_url":"https://github.com/elastic/elasticsearch/issues/46396#issuecomment-625759193","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46396","id":625759193,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNTc1OTE5Mw==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2020-05-08T10:53:47Z","updated_at":"2020-05-08T10:53:47Z","author_association":"CONTRIBUTOR","body":"@verkhovin Yes, it's still relevant.","performed_via_github_app":null}]