{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19444","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19444/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19444/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19444/events","html_url":"https://github.com/elastic/elasticsearch/issues/19444","id":165741876,"node_id":"MDU6SXNzdWUxNjU3NDE4NzY=","number":19444,"title":"Need to validate index.merge.scheduler.max_thread_count input?","user":{"login":"joshuar","id":7401,"node_id":"MDQ6VXNlcjc0MDE=","avatar_url":"https://avatars3.githubusercontent.com/u/7401?v=4","gravatar_id":"","url":"https://api.github.com/users/joshuar","html_url":"https://github.com/joshuar","followers_url":"https://api.github.com/users/joshuar/followers","following_url":"https://api.github.com/users/joshuar/following{/other_user}","gists_url":"https://api.github.com/users/joshuar/gists{/gist_id}","starred_url":"https://api.github.com/users/joshuar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshuar/subscriptions","organizations_url":"https://api.github.com/users/joshuar/orgs","repos_url":"https://api.github.com/users/joshuar/repos","events_url":"https://api.github.com/users/joshuar/events{/privacy}","received_events_url":"https://api.github.com/users/joshuar/received_events","type":"User","site_admin":false},"labels":[{"id":144457604,"node_id":"MDU6TGFiZWwxNDQ0NTc2MDQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Settings","name":":Core/Infra/Settings","color":"0e8a16","default":false,"description":"Settings infrastructure and APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-07-15T09:03:28Z","updated_at":"2016-09-08T10:25:04Z","closed_at":"2016-09-08T10:25:04Z","author_association":"MEMBER","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**:\n2.x - 5.x\n\n**JVM version**:\n\n**OS version**:\n\n**Description of the problem including expected versus actual behavior**:\n\nIt looks like if one is to set \"bad\" values for `index.merge.scheduler.max_thread_count` it can cause exceptions to be thrown continually in the logs \n\n**Steps to reproduce**:\n\nSet the value to something crazy:\n\nRequest:\n\n```\nPUT /test/_settings\n{\n    \"index.merge.scheduler.max_thread_count\": \"500\"\n\n}\n```\n\nResponse:\n\n```\n{\n  \"acknowledged\": true\n}\n```\n\nBut  in the logs:\n\n```\nes_1 | [2016-07-15 08:56:13,804][INFO ][index.shard              ] [escluster1_es_1] [test][0] updating [index.merge.scheduler.max_thread_count] from [7] to [500]\nes_1 | [2016-07-15 08:56:13,805][WARN ][index.settings           ] [escluster1_es_1] [test] failed to refresh settings for [org.elasticsearch.index.shard.IndexShard$ApplyRefreshSettings@5903b92]\nes_1 | java.lang.IllegalArgumentException: maxThreadCount should be <= maxMergeCount (= 7)\nes_1 |  at org.apache.lucene.index.ConcurrentMergeScheduler.setMaxMergesAndThreads(ConcurrentMergeScheduler.java:154)\nes_1 |  at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.refreshConfig(ElasticsearchConcurrentMergeScheduler.java:176)\nes_1 |  at org.elasticsearch.index.engine.InternalEngine.onSettingsChanged(InternalEngine.java:1272)\nes_1 |  at org.elasticsearch.index.shard.IndexShard$ApplyRefreshSettings.onRefreshSettings(IndexShard.java:1325)\nes_1 |  at org.elasticsearch.index.settings.IndexSettingsService.refreshSettings(IndexSettingsService.java:54)\nes_1 |  at org.elasticsearch.indices.cluster.IndicesClusterStateService.applySettings(IndicesClusterStateService.java:322)\nes_1 |  at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:169)\nes_1 |  at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:610)\nes_1 |  at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\nes_1 |  at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\nes_1 |  at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\nes_1 |  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nes_1 |  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nes_1 |  at java.lang.Thread.run(Thread.java:745)\n```\n\nIndexing appears to work:\n\nRequest:\n\n```\nPUT test/t/1\n{\n  \"foo\": \"bar\"\n}\n```\n\nResponse:\n\n```\n{\n  \"_index\": \"test\",\n  \"_type\": \"t\",\n  \"_id\": \"1\",\n  \"_version\": 1,\n  \"_shards\": {\n    \"total\": 1,\n    \"successful\": 1,\n    \"failed\": 0\n  },\n  \"created\": false\n}\n```\n\nBut in the logs:\n\n```\nes_1 | [2016-07-15 08:56:23,897][INFO ][cluster.metadata         ] [escluster1_es_1] [test] create_mapping [t]\nes_1 | [2016-07-15 08:56:30,799][WARN ][index.shard              ] [escluster1_es_1] [test][0] Failed to perform scheduled engine refresh\nes_1 | java.lang.IllegalArgumentException: maxThreadCount should be <= maxMergeCount (= 7)\nes_1 |  at org.apache.lucene.index.ConcurrentMergeScheduler.setMaxMergesAndThreads(ConcurrentMergeScheduler.java:154)\nes_1 |  at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.refreshConfig(ElasticsearchConcurrentMergeScheduler.java:176)\nes_1 |  at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:688)\nes_1 |  at org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:661)\nes_1 |  at org.elasticsearch.index.shard.IndexShard$EngineRefresher$1.run(IndexShard.java:1343)\nes_1 |  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nes_1 |  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nes_1 |  at java.lang.Thread.run(Thread.java:745)\n```\n\nThis looks to be harmless, but do need to test more when under indexing and search load.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}