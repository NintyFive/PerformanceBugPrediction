{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8879","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8879/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8879/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8879/events","html_url":"https://github.com/elastic/elasticsearch/issues/8879","id":51564086,"node_id":"MDU6SXNzdWU1MTU2NDA4Ng==","number":8879,"title":"Percolator with groovy script filter fails on concurrent use","user":{"login":"mvdz","id":9332217,"node_id":"MDQ6VXNlcjkzMzIyMTc=","avatar_url":"https://avatars1.githubusercontent.com/u/9332217?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdz","html_url":"https://github.com/mvdz","followers_url":"https://api.github.com/users/mvdz/followers","following_url":"https://api.github.com/users/mvdz/following{/other_user}","gists_url":"https://api.github.com/users/mvdz/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdz/subscriptions","organizations_url":"https://api.github.com/users/mvdz/orgs","repos_url":"https://api.github.com/users/mvdz/repos","events_url":"https://api.github.com/users/mvdz/events{/privacy}","received_events_url":"https://api.github.com/users/mvdz/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":17,"created_at":"2014-12-10T14:30:15Z","updated_at":"2017-06-28T14:10:01Z","closed_at":"2017-06-28T14:10:01Z","author_association":"NONE","active_lock_reason":null,"body":"Tested on Elasticsearch 1.4.1.\n\nPrepare the mapping and percolator:\n\n```\ncurl -XPUT localhost:9200/test -d '{\n  \"mappings\" : {\n    \"test\" : {\n      \"properties\" : {\n        \"name\" : {\n          \"type\" : \"string\"\n        }\n      }\n    }\n  }\n}'\ncurl -XPUT localhost:9200/test/.percolator/1 -d '{\n  \"type\": \"test\",\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"script\": {\n          \"script\": \"doc[\\\"name\\\"].value == \\\"a\\\"\",\n          \"lang\": \"groovy\"\n        }\n      }\n    }\n  }\n}'\n```\n\nThis script tests for a match, it keeps looping silently as long as the expected result arrives. When an unexpected result arrives it's printed and the loop terminates:\n\n```\nwhile ! curl -s localhost:9200/test/test/_percolate -d '{ \"doc\": { \"name\": \"a\" } }' | grep -v '\"failed\":0},\"total\":1'; do :; done\n```\n\nThis one tests a document that does not match, also keeps looping as long as the expected result arrives:\n\n```\nwhile ! curl -s localhost:9200/test/test/_percolate -d '{ \"doc\": { \"name\": \"b\" } }' | grep -v '\"failed\":0},\"total\":0'; do :; done\n```\n\nWhen running only one of them, it keeps running as expected.\n\nWhen I run both at the same time, one of them terminates quickly with the wrong result.\n\nRunning the same one twice at the same time it takes a few seconds, but one of them terminates with a failed shard operation and this stack trace appears in the log:\n\n```\n[2014-12-10 15:14:34,652][DEBUG][action.percolate         ] [Crown] [test][2], node[3k5o4J4zTyeBQ1eAN2-Smw], [P], s[STARTED]: failed to execute [org.elasticsearch.action.percolate.PercolateRequest@290522d3]\norg.elasticsearch.percolator.PercolateException: failed to percolate\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:195)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:56)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction$1.run(TransportBroadcastOperationAction.java:171)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:744)\nCaused by: org.elasticsearch.percolator.PercolateException: failed to execute\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:561)\n    at org.elasticsearch.percolator.PercolatorService.percolate(PercolatorService.java:239)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:192)\n    ... 5 more\nCaused by: org.elasticsearch.script.groovy.GroovyScriptExecutionException: ArrayIndexOutOfBoundsException[null]\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:253)\n    at org.elasticsearch.index.query.ScriptFilterParser$ScriptFilter$ScriptDocSet.matchDoc(ScriptFilterParser.java:190)\n    at org.elasticsearch.common.lucene.docset.MatchDocIdSet$NoAcceptDocsIterator.nextDoc(MatchDocIdSet.java:96)\n    at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.nextDoc(ConstantScoreQuery.java:257)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:192)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:309)\n    at org.elasticsearch.common.lucene.Lucene.countWithEarlyTermination(Lucene.java:201)\n    at org.elasticsearch.common.lucene.Lucene.countWithEarlyTermination(Lucene.java:189)\n    at org.elasticsearch.common.lucene.Lucene.exists(Lucene.java:180)\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:557)\n    ... 7 more\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}