{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40602","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40602/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40602/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40602/events","html_url":"https://github.com/elastic/elasticsearch/issues/40602","id":426629018,"node_id":"MDU6SXNzdWU0MjY2MjkwMTg=","number":40602,"title":"Ingest-attachment does not handle compressed files","user":{"login":"sronsiek","id":1255835,"node_id":"MDQ6VXNlcjEyNTU4MzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1255835?v=4","gravatar_id":"","url":"https://api.github.com/users/sronsiek","html_url":"https://github.com/sronsiek","followers_url":"https://api.github.com/users/sronsiek/followers","following_url":"https://api.github.com/users/sronsiek/following{/other_user}","gists_url":"https://api.github.com/users/sronsiek/gists{/gist_id}","starred_url":"https://api.github.com/users/sronsiek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sronsiek/subscriptions","organizations_url":"https://api.github.com/users/sronsiek/orgs","repos_url":"https://api.github.com/users/sronsiek/repos","events_url":"https://api.github.com/users/sronsiek/events{/privacy}","received_events_url":"https://api.github.com/users/sronsiek/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-03-28T17:50:10Z","updated_at":"2019-10-18T11:36:07Z","closed_at":"2019-10-18T11:36:07Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** 6.6.0\r\n\r\n**Plugins installed**: [ingest attachment]\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"11.0.1\" 2018-10-16\r\nOpenJDK Runtime Environment 18.9 (build 11.0.1+13)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.1+13, mixed mode)\r\n\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nopensuse 42.3\r\nLinux elastic 4.4.76-1-default #1 SMP Fri Jul 14 08:48:13 UTC 2017 (9a2885c) x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI'm upgrading an existing app using elasticsearch v2.1.2 (+ attachment mapper plugin) to v6.6.0 (+ ingest attachment plugin). **String searches in the 2.1.2 version return hits which are within compressed attachment files (eg .tar .tar.gz),** as well as the usual .pdf .doc .xls etc.\r\n\r\nUsing the new ingest-attachment plugin, I see that compressed files do not appear to be processed:  content-type is correctly deduced as \"application/gzip\", content-length is zero and no other fields are present in the attachment structure returned by elastic. For uncompressed files elastic also returns date, author, language and content fields! \r\n\r\nI saw no compression related options in the docs at https://www.elastic.co/guide/en/elasticsearch/plugins/current/using-ingest-attachment.html\r\n\r\nI do not know how to get the plugin versions - they're not in the log. elastic is running in a docker container produced with this Dockerfile content:\r\n\r\n```\r\nFROM docker.elastic.co/elasticsearch/elasticsearch:6.6.0\r\n\r\nRUN bin/elasticsearch-plugin install --batch ingest-attachment\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nIndex template:\r\n```\r\n{\r\n  \"index_patterns\": \"ars*\",\r\n  \"mappings\": {\r\n    \"ar\": {\r\n      \"properties\": {\r\n        \"actionee\": {\r\n          \"properties\": {\r\n            \"fullname\": {\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"ignore_above\": 256,\r\n                  \"type\": \"keyword\"\r\n                }\r\n              },\r\n              \"type\": \"text\"\r\n            },\r\n            \"name\": {\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"ignore_above\": 256,\r\n                  \"type\": \"keyword\"\r\n                }\r\n              },\r\n              \"type\": \"text\"\r\n            }\r\n          }\r\n        },\r\n        \"attachments\": {\r\n          \"properties\": {\r\n            \"description\": {\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"ignore_above\": 256,\r\n                  \"type\": \"keyword\"\r\n                }\r\n              },\r\n              \"type\": \"text\"\r\n            },\r\n            \"filename\": {\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"ignore_above\": 256,\r\n                  \"type\": \"keyword\"\r\n                }\r\n              },\r\n              \"type\": \"text\"\r\n            },\r\n            \"filesize\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"id\": {\r\n              \"index\": false,\r\n              \"type\": \"long\"\r\n            },\r\n            \"updated_at\": {\r\n              \"type\": \"date\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"order\": 0,\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"default\": {\r\n          \"filter\": [\r\n            \"lowercase\"\r\n          ],\r\n          \"tokenizer\": \"whitespace\"\r\n        }\r\n      }\r\n    },\r\n    \"number_of_replicas\": 0,\r\n    \"number_of_shards\": 1,\r\n    \"refresh_interval\": \"1s\"\r\n  }\r\n}\r\n```\r\n\r\nIngest-pipeline template:\r\n```\r\npipeline.json \r\n{\r\n  \"description\" : \"Extract attachment information from arrays\",\r\n  \"processors\" : [\r\n    {\r\n      \"foreach\": {\r\n        \"field\": \"attachments\",\r\n        \"processor\": {\r\n          \"attachment\": {\r\n            \"target_field\": \"_ingest._value.attachment\",\r\n            \"field\": \"_ingest._value.data\",\r\n            \"indexed_chars\": -1\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\nI don't see anything relevant - but here it is for completeness:\r\n```\r\nMar 28, 2019 5:25:21 PM org.apache.tika.config.InitializableProblemHandler$3 handleInitializableProblem\r\nWARNING: org.xerial's sqlite-jdbc is not loaded.\r\nPlease provide the jar on your classpath to parse sqlite files.\r\nSee tika-parsers/pom.xml for the correct version.\r\n[2019-03-28T17:25:21,630][INFO ][o.e.c.m.MetaDataMappingService] [oBnurzh] [ars/sEx9Jo9VQPGK-XOFs6r8Fg] update_mapping [ar]\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nOpenJDK 64-Bit Server VM warning: UseAVX=2 is not supported on this CPU, setting it to UseAVX=1\r\n[2019-03-28T17:32:28,969][INFO ][o.e.e.NodeEnvironment    ] [864g5mA] using [1] data paths, mounts [[/usr/share/elasticsearch/data (/dev/vdb1)]], net usable_space [46.7gb], net total_space [59.9gb], types [xfs]\r\n[2019-03-28T17:32:28,973][INFO ][o.e.e.NodeEnvironment    ] [864g5mA] heap size [3.9gb], compressed ordinary object pointers [true]\r\n[2019-03-28T17:32:28,977][INFO ][o.e.n.Node               ] [864g5mA] node name derived from node ID [864g5mAqS_WIS-BMu8DH-Q]; set [node.name] to override\r\n[2019-03-28T17:32:28,977][INFO ][o.e.n.Node               ] [864g5mA] version[6.6.0], pid[1], build[default/tar/a9861f4/2019-01-24T11:27:09.439740Z], OS[Linux/4.4.76-1-default/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/11.0.1/11.0.1+13]\r\n[2019-03-28T17:32:28,978][INFO ][o.e.n.Node               ] [864g5mA] JVM arguments [-Xms1g, -Xmx1g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.io.tmpdir=/tmp/elasticsearch-12949752479696623950, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=data, -XX:ErrorFile=logs/hs_err_pid%p.log, -Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m, -Djava.locale.providers=COMPAT, -XX:UseAVX=2, -Des.cgroups.hierarchy.override=/, -Xms4g, -Xmx4g, -Des.path.home=/usr/share/elasticsearch, -Des.path.conf=/usr/share/elasticsearch/config, -Des.distribution.flavor=default, -Des.distribution.type=tar]\r\n[2019-03-28T17:32:31,824][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [aggs-matrix-stats]\r\n[2019-03-28T17:32:31,824][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [analysis-common]\r\n[2019-03-28T17:32:31,825][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [ingest-common]\r\n[2019-03-28T17:32:31,825][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [lang-expression]\r\n[2019-03-28T17:32:31,825][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [lang-mustache]\r\n[2019-03-28T17:32:31,826][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [lang-painless]\r\n[2019-03-28T17:32:31,826][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [mapper-extras]\r\n[2019-03-28T17:32:31,826][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [parent-join]\r\n[2019-03-28T17:32:31,827][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [percolator]\r\n[2019-03-28T17:32:31,827][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [rank-eval]\r\n[2019-03-28T17:32:31,827][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [reindex]\r\n[2019-03-28T17:32:31,827][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [repository-url]\r\n[2019-03-28T17:32:31,828][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [transport-netty4]\r\n[2019-03-28T17:32:31,828][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [tribe]\r\n[2019-03-28T17:32:31,828][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-ccr]\r\n[2019-03-28T17:32:31,829][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-core]\r\n[2019-03-28T17:32:31,829][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-deprecation]\r\n[2019-03-28T17:32:31,829][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-graph]\r\n[2019-03-28T17:32:31,830][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-ilm]\r\n[2019-03-28T17:32:31,830][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-logstash]\r\n[2019-03-28T17:32:31,830][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-ml]\r\n[2019-03-28T17:32:31,831][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-monitoring]\r\n[2019-03-28T17:32:31,831][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-rollup]\r\n[2019-03-28T17:32:31,831][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-security]\r\n[2019-03-28T17:32:31,831][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-sql]\r\n[2019-03-28T17:32:31,832][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-upgrade]\r\n[2019-03-28T17:32:31,832][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded module [x-pack-watcher]\r\n[2019-03-28T17:32:31,833][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded plugin [ingest-attachment]\r\n[2019-03-28T17:32:31,833][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded plugin [ingest-geoip]\r\n[2019-03-28T17:32:31,834][INFO ][o.e.p.PluginsService     ] [864g5mA] loaded plugin [ingest-user-agent]\r\n[2019-03-28T17:32:38,546][INFO ][o.e.x.s.a.s.FileRolesStore] [864g5mA] parsed [0] roles from file [/usr/share/elasticsearch/config/roles.yml]\r\n[2019-03-28T17:32:39,429][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [864g5mA] [controller/89] [Main.cc@109] controller (64 bit): Version 6.6.0 (Build bbb4919f4d17a5) Copyright (c) 2019 Elasticsearch BV\r\n[2019-03-28T17:32:40,702][INFO ][o.e.d.DiscoveryModule    ] [864g5mA] using discovery type [zen] and host providers [settings]\r\n[2019-03-28T17:32:42,024][INFO ][o.e.n.Node               ] [864g5mA] initialized\r\n[2019-03-28T17:32:42,025][INFO ][o.e.n.Node               ] [864g5mA] starting ...\r\n[2019-03-28T17:32:42,256][INFO ][o.e.t.TransportService   ] [864g5mA] publish_address {172.17.0.2:9300}, bound_addresses {0.0.0.0:9300}\r\n[2019-03-28T17:32:42,278][INFO ][o.e.b.BootstrapChecks    ] [864g5mA] bound or publishing to a non-loopback address, enforcing bootstrap checks\r\n[2019-03-28T17:32:45,360][INFO ][o.e.c.s.MasterService    ] [864g5mA] zen-disco-elected-as-master ([0] nodes joined), reason: new_master {864g5mA}{864g5mAqS_WIS-BMu8DH-Q}{cLx7yl7cQFSK4voEG18jqg}{172.17.0.2}{172.17.0.2:9300}{ml.machine_memory=12598550528, xpack.installed=true, ml.max_open_jobs=20, ml.enabled=true}\r\n[2019-03-28T17:32:45,368][INFO ][o.e.c.s.ClusterApplierService] [864g5mA] new_master {864g5mA}{864g5mAqS_WIS-BMu8DH-Q}{cLx7yl7cQFSK4voEG18jqg}{172.17.0.2}{172.17.0.2:9300}{ml.machine_memory=12598550528, xpack.installed=true, ml.max_open_jobs=20, ml.enabled=true}, reason: apply cluster state (from master [master {864g5mA}{864g5mAqS_WIS-BMu8DH-Q}{cLx7yl7cQFSK4voEG18jqg}{172.17.0.2}{172.17.0.2:9300}{ml.machine_memory=12598550528, xpack.installed=true, ml.max_open_jobs=20, ml.enabled=true} committed version [1] source [zen-disco-elected-as-master ([0] nodes joined)]])\r\n[2019-03-28T17:32:45,451][INFO ][o.e.h.n.Netty4HttpServerTransport] [864g5mA] publish_address {172.17.0.2:9200}, bound_addresses {0.0.0.0:9200}\r\n[2019-03-28T17:32:45,452][INFO ][o.e.n.Node               ] [864g5mA] started\r\n[2019-03-28T17:32:45,472][WARN ][o.e.x.s.a.s.m.NativeRoleMappingStore] [864g5mA] Failed to clear cache for realms [[]]\r\n[2019-03-28T17:32:45,543][INFO ][o.e.g.GatewayService     ] [864g5mA] recovered [0] indices into cluster_state\r\n[2019-03-28T17:32:45,828][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.watch-history-9] for index patterns [.watcher-history-9*]\r\n[2019-03-28T17:32:45,879][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.triggered_watches] for index patterns [.triggered_watches*]\r\n[2019-03-28T17:32:45,922][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.watches] for index patterns [.watches*]\r\n[2019-03-28T17:32:45,966][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.monitoring-logstash] for index patterns [.monitoring-logstash-6-*]\r\n[2019-03-28T17:32:46,035][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.monitoring-es] for index patterns [.monitoring-es-6-*]\r\n[2019-03-28T17:32:46,077][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.monitoring-alerts] for index patterns [.monitoring-alerts-6]\r\n[2019-03-28T17:32:46,131][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.monitoring-beats] for index patterns [.monitoring-beats-6-*]\r\n[2019-03-28T17:32:46,184][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [.monitoring-kibana] for index patterns [.monitoring-kibana-6-*]\r\n[2019-03-28T17:32:46,347][INFO ][o.e.l.LicenseService     ] [864g5mA] license [58339812-447d-4735-b976-96d42134833b] mode [basic] - valid\r\n[2019-03-28T17:34:58,789][WARN ][o.e.d.c.m.MetaDataCreateIndexService] [864g5mA] the default number of shards will change from [5] to [1] in 7.0.0; if you wish to continue using the default of [5] shards, you must manage this on the create index request or with an index template\r\n[2019-03-28T17:34:58,806][INFO ][o.e.c.m.MetaDataCreateIndexService] [864g5mA] [ars] creating index, cause [auto(bulk api)], templates [], shards [5]/[1], mappings []\r\n[2019-03-28T17:34:59,406][INFO ][o.e.c.m.MetaDataMappingService] [864g5mA] [ars/ZLpXMDNaRFaSczn8QX_58A] create_mapping [ar]\r\n[2019-03-28T17:34:59,637][INFO ][o.e.c.m.MetaDataDeleteIndexService] [864g5mA] [ars/ZLpXMDNaRFaSczn8QX_58A] deleting index\r\n[2019-03-28T17:34:59,798][INFO ][o.e.c.m.MetaDataIndexTemplateService] [864g5mA] adding template [template-ars] for index patterns [ars*]\r\n[2019-03-28T17:35:00,255][INFO ][o.e.c.m.MetaDataCreateIndexService] [864g5mA] [ars] creating index, cause [auto(bulk api)], templates [template-ars], shards [1]/[0], mappings [ar]\r\n[2019-03-28T17:35:00,322][INFO ][o.e.c.r.a.AllocationService] [864g5mA] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[ars][0]] ...]).\r\nSLF4J: Failed to load class \"org.slf4j.impl.StaticLoggerBinder\".\r\nSLF4J: Defaulting to no-operation (NOP) logger implementation\r\nSLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.\r\nMar 28, 2019 5:35:00 PM org.apache.tika.config.InitializableProblemHandler$3 handleInitializableProblem\r\nWARNING: TIFFImageWriter not loaded. tiff files will not be processed\r\nSee https://pdfbox.apache.org/2.0/dependencies.html#jai-image-io\r\nfor optional dependencies.\r\nJ2KImageReader not loaded. JPEG2000 files will not be processed.\r\nSee https://pdfbox.apache.org/2.0/dependencies.html#jai-image-io\r\nfor optional dependencies.\r\n\r\nMar 28, 2019 5:35:01 PM org.apache.tika.config.InitializableProblemHandler$3 handleInitializableProblem\r\nWARNING: org.xerial's sqlite-jdbc is not loaded.\r\nPlease provide the jar on your classpath to parse sqlite files.\r\nSee tika-parsers/pom.xml for the correct version.\r\n[2019-03-28T17:35:01,599][INFO ][o.e.c.m.MetaDataMappingService] [864g5mA] [ars/3_efZOn0RwGA7_NkEEplQQ] update_mapping [ar]\r\n```","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}