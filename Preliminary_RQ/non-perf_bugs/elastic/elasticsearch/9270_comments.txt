[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70060431","html_url":"https://github.com/elastic/elasticsearch/issues/9270#issuecomment-70060431","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9270","id":70060431,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMDYwNDMx","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-01-15T09:33:44Z","updated_at":"2015-01-15T09:33:44Z","author_association":"CONTRIBUTOR","body":"Another FieldData cache-clearing issue - related?\nhttp://build-us-00.elasticsearch.org/job/es_core_master_metal/6983\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70060714","html_url":"https://github.com/elastic/elasticsearch/issues/9270#issuecomment-70060714","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9270","id":70060714,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMDYwNzE0","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2015-01-15T09:36:43Z","updated_at":"2015-01-15T09:36:56Z","author_association":"MEMBER","body":"This is related also:\nhttp://build-us-00.elasticsearch.org/job/es_core_master_centos/2301/\n\nI dug into this a little bit the other day, while it looks like a breaker failure, it's actually something where clearing the field data cache does not actually remove everything from the cache. The size remained higher than 0 despite running `.invalidateAll()` followed by `.cleanUp()` on the `Cache<>` object\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70082504","html_url":"https://github.com/elastic/elasticsearch/issues/9270#issuecomment-70082504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9270","id":70082504,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMDgyNTA0","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-01-15T13:04:03Z","updated_at":"2015-01-15T13:04:03Z","author_association":"CONTRIBUTOR","body":"I think there's a concurrency issue - 6983 fails with -Des.node.mode=local but passes when this isn't set.\nI started logging the steps these two modes take and got these outputs (Tx means thread x):\n\nFailing test (-Des.node.mode=local)\n\n```\nT2,shard0 TransportClearIndicesCacheAction start clearing caches on index test\nT3,shard1 TransportClearIndicesCacheAction start clearing caches on index test\nT1,shard0 TransportClearIndicesCacheAction start clearing caches on index test\nT2,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field \nT4,shard1 TransportClearIndicesCacheAction start clearing caches on index test\nT1,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field \nT2,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field)\nT1,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field)\nT1,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field2 \nT1,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field2)\nT2,shard0       IndexFieldCache.clear(field) - checking seg 203933760 on index cache [test] for field field node=node_s0\nT2,shard0           IndexFieldCache.clear(field) - found field, clearing\nT2,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field2 \nT2,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field2)\n```\n\nPassing test (non-local mode)\n\n```\nT1,shard0 TransportClearIndicesCacheAction start clearing caches on index test\nT4,shard1 TransportClearIndicesCacheAction start clearing caches on index test\nT2,shard0 TransportClearIndicesCacheAction start clearing caches on index test\nT3,shard1 TransportClearIndicesCacheAction start clearing caches on index test\nT4,shard1   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field \nT1,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field \nT4,shard1       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field)\nT1,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field)\nT4,shard1       IndexFieldCache.clear(field) - checking seg 546713328 on index cache [test] for field field node=node_s0\nT1,shard0       IndexFieldCache.clear(field) - checking seg 1675861830 on index cache [test] for field field node=node_s1\nT4,shard1   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field2 \nT1,shard0           IndexFieldCache.clear(field) - found field, clearing\nT4,shard1       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field2)\nT4,shard1       IndexFieldCache.clear(field2) - checking seg 546713328 on index cache [test] for field field2 node=node_s0\nT4,shard1           IndexFieldCache.clear(field2) - found field, clearing\nT1,shard0   IndexFieldDataServiceclear() calling fieldData.clear() for index test names=field2 \nT1,shard0       PagedBytesIndexFieldData.clear() calling cache IndexFieldCache.clear(field2)\n```\n\nNote that in the failing test, shard 1 is not cleared. I started debugging to dig deeper but this changed the sequencing of behaviours and the test passed which indicates some kind of concurrency issue here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70274834","html_url":"https://github.com/elastic/elasticsearch/issues/9270#issuecomment-70274834","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9270","id":70274834,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMjc0ODM0","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2015-01-16T16:00:59Z","updated_at":"2015-01-16T16:00:59Z","author_association":"CONTRIBUTOR","body":"Spent a while looking into this dumping the IDs of the various instances of keys and caches being created and by which threads. It looks like in the scenarios where it fails there is a spurious \"onRemoval\" event being triggered almost as soon as a new entry is added to the cache:\n\n```\n[2015-01-16 15:52:03,298][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] creating index, cause [api], templates [random_index_template], shards [2]/[1], mappings []\n[2015-01-16 15:52:03,608][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] update_mapping [type] (dynamic)\nelasticsearch[node_s1][search][T#2]  starting load of resource for key [k=83759445 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s1][search][T#2]   ShardFieldData increasing ram used  by 284 src=1853463147 for field field\nelasticsearch[node_s1][search][T#2]     finished loading leafReader for key=[k=83759445 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s1][search][T#5] guava cache  removalListener.onRemoval  key [k=83759445 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s1][search][T#5] listener decrementing the ram used by 284 bytes\nelasticsearch[node_s1][search][T#5]  starting load of resource for key [k=335974664 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s1][search][T#5]   ShardFieldData increasing ram used  by 284 src=991669885 for field field\nelasticsearch[node_s1][search][T#5]     finished loading leafReader for key=[k=335974664 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s0][search][T#6]  starting load of resource for key [k=1473214828 f=field2 r=1685032431 ifc=1041451583ifc.cache=1982647933]\nelasticsearch[node_s0][search][T#6]   ShardFieldData increasing ram used  by 284 src=2007543079 for field field2\nelasticsearch[node_s0][search][T#6]     finished loading leafReader for key=[k=1473214828 f=field2 r=1685032431 ifc=1041451583ifc.cache=1982647933]\nelasticsearch[node_s0][search][T#8]     finished loading leafReader for key=[k=1746987438 f=field2 r=1685032431 ifc=1041451583ifc.cache=1982647933]\nelasticsearch[node_s1][management][T#1] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s0][management][T#2] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s0][management][T#4] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s1][management][T#2] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s1][management][T#1]     663461528 IndexFieldCache.clear(field) - being called on keys  in indexService 862694802 cache=1143203330\nelasticsearch[node_s1][management][T#1]     1649436317 IndexFieldCache.clear(field2) - being called on keys  in indexService 862694802 cache=1143203330\nelasticsearch[node_s0][management][T#2]     209780696 IndexFieldCache.clear(field) - being called on keys test/field2  in indexService 1763492945 cache=1982647933\nelasticsearch[node_s1][management][T#1]     IndexFieldCache663461528 clear() starting...\nelasticsearch[node_s0][management][T#2]     1041451583 IndexFieldCache.clear(field2) - being called on keys test/field2  in indexService 1763492945 cache=1982647933\nelasticsearch[node_s1][management][T#1]     IndexFieldCache1649436317 clear() starting...\nelasticsearch[node_s0][management][T#2]     IndexFieldCache.clear([k=1473214828 f=field2 r=1685032431 ifc=1041451583ifc.cache=1982647933])  invalidating key...\nelasticsearch[node_s0][management][T#2] guava cache  removalListener.onRemoval  key [k=1473214828 f=field2 r=1685032431 ifc=1041451583ifc.cache=1982647933]\nelasticsearch[node_s0][management][T#2] listener decrementing the ram used by 284 bytes\nelasticsearch[node_s0][management][T#2]     IndexFieldCache209780696 clear() starting...\nelasticsearch[node_s0][management][T#2]     IndexFieldCache1041451583 clear() starting...\n[2015-01-16 15:52:03,962][INFO ][org.elasticsearch.indices.stats] [IndexStatsTests#testFieldDataStats]: cleaning up after test\n[2015-01-16 15:52:03,967][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] deleting index\n[2015-01-16 15:52:03,968][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] Shard state before potentially flushing is STARTED\n[2015-01-16 15:52:03,970][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] flush finished in beforeIndexShardClosed\n[2015-01-16 15:52:03,971][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] start check index\n[2015-01-16 15:52:03,977][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] end check index\nelasticsearch[node_s1][clusterService#updateTask][T#1]IndexFieldCache.close() is invalidating reader 1062805872 cache=1143203330 field=field\nelasticsearch[node_s1][clusterService#updateTask][T#1] guava cache  removalListener.onRemoval  key [k=335974664 f=field r=1062805872 ifc=663461528ifc.cache=1143203330]\nelasticsearch[node_s1][clusterService#updateTask][T#1] listener decrementing the ram used by 284 bytes\n```\n\nA healthy run (with local mode turned off) only has onRemoval being triggered as part of normal clear() operations:\n\n```\n[2015-01-16 15:49:28,346][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] creating index, cause [api], templates [random_index_template], shards [2]/[1], mappings []\nelasticsearch[node_s0][clusterService#updateTask][T#1]  IndexFieldDataService mapping update!!!!!! \n[2015-01-16 15:49:28,877][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] update_mapping [type] (dynamic)\nelasticsearch[node_s0][search][T#2]  starting load of resource for key [k=1395989926 f=field r=809938711 ifc=541039787ifc.cache=1143842807]\nelasticsearch[node_s0][search][T#2]   ShardFieldData increasing ram used  by 284 src=697242378 for field field\nelasticsearch[node_s0][search][T#2]     finished loading leafReader for key=[k=1395989926 f=field r=809938711 ifc=541039787ifc.cache=1143842807]\nelasticsearch[node_s1][search][T#4]  starting load of resource for key [k=1054474989 f=field r=770618889 ifc=57543777ifc.cache=1526085079]\nelasticsearch[node_s1][search][T#4]   ShardFieldData increasing ram used  by 284 src=1514726632 for field field\nelasticsearch[node_s1][search][T#4]     finished loading leafReader for key=[k=1054474989 f=field r=770618889 ifc=57543777ifc.cache=1526085079]\nelasticsearch[node_s1][search][T#7]  starting load of resource for key [k=1825474479 f=field2 r=770618889 ifc=96321810ifc.cache=1526085079]\nelasticsearch[node_s1][search][T#7]   ShardFieldData increasing ram used  by 284 src=1798187511 for field field2\nelasticsearch[node_s1][search][T#7]     finished loading leafReader for key=[k=1825474479 f=field2 r=770618889 ifc=96321810ifc.cache=1526085079]\nelasticsearch[node_s1][search][T#10]        finished loading leafReader for key=[k=2007543079 f=field2 r=770618889 ifc=96321810ifc.cache=1526085079]\nelasticsearch[node_s1][management][T#2] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s0][management][T#1] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s0][management][T#2] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s1][management][T#1] TransportClearIndicesCacheAction start clearing caches on index test\nelasticsearch[node_s0][management][T#1]     541039787 IndexFieldCache.clear(field) - being called on keys test/field  in indexService 6571565 cache=1143842807\nelasticsearch[node_s1][management][T#2]     57543777 IndexFieldCache.clear(field) - being called on keys test/field2 test/field  in indexService 760250745 cache=1526085079\nelasticsearch[node_s0][management][T#1]     IndexFieldCache.clear([k=1395989926 f=field r=809938711 ifc=541039787ifc.cache=1143842807])  invalidating key...\nelasticsearch[node_s1][management][T#2]     IndexFieldCache.clear([k=1054474989 f=field r=770618889 ifc=57543777ifc.cache=1526085079])  invalidating key...\nelasticsearch[node_s0][management][T#1] guava cache  removalListener.onRemoval  key [k=1395989926 f=field r=809938711 ifc=541039787ifc.cache=1143842807]\nelasticsearch[node_s1][management][T#2] guava cache  removalListener.onRemoval  key [k=1054474989 f=field r=770618889 ifc=57543777ifc.cache=1526085079]\nelasticsearch[node_s0][management][T#1] listener decrementing the ram used by 284 bytes\nelasticsearch[node_s1][management][T#2] listener decrementing the ram used by 284 bytes\nelasticsearch[node_s0][management][T#1]     1746987438 IndexFieldCache.clear(field2) - being called on keys  in indexService 6571565 cache=1143842807\nelasticsearch[node_s1][management][T#2]     96321810 IndexFieldCache.clear(field2) - being called on keys test/field2  in indexService 760250745 cache=1526085079\nelasticsearch[node_s0][management][T#1]     IndexFieldCache541039787 clear() starting...\nelasticsearch[node_s1][management][T#2]     IndexFieldCache.clear([k=1825474479 f=field2 r=770618889 ifc=96321810ifc.cache=1526085079])  invalidating key...\nelasticsearch[node_s0][management][T#1]     IndexFieldCache1746987438 clear() starting...\nelasticsearch[node_s1][management][T#2] guava cache  removalListener.onRemoval  key [k=1825474479 f=field2 r=770618889 ifc=96321810ifc.cache=1526085079]\nelasticsearch[node_s1][management][T#2] listener decrementing the ram used by 284 bytes\nelasticsearch[node_s1][management][T#2]     IndexFieldCache57543777 clear() starting...\nelasticsearch[node_s1][management][T#2]     IndexFieldCache96321810 clear() starting...\n[2015-01-16 15:49:29,057][INFO ][org.elasticsearch.indices.stats] [IndexStatsTests#testFieldDataStats]: cleaning up after test\n[2015-01-16 15:49:29,064][INFO ][org.elasticsearch.cluster.metadata] [node_s0] [test] deleting index\n[2015-01-16 15:49:29,066][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] Shard state before potentially flushing is STARTED\n[2015-01-16 15:49:29,068][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] flush finished in beforeIndexShardClosed\n[2015-01-16 15:49:29,070][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] start check index\n[2015-01-16 15:49:29,077][INFO ][org.elasticsearch.test.store] [node_s1] [test][0] end check index\nelasticsearch[node_s1][clusterService#updateTask][T#1]IndexFieldCache.close() is invalidating reader 770618889 cache=1526085079 field=field\nelasticsearch[node_s1][clusterService#updateTask][T#1]IndexFieldCache.close() is invalidating reader 770618889 cache=1526085079 field=field2\n[2015-01-16 15:49:29,085][INFO ][org.elasticsearch.test.store] [node_s0] [test][0] Shard state before potentially flushing is STARTED\n[2015-01-16 15:49:29,086][INFO ][org.elasticsearch.test.store] [node_s0] [test][0] flush finished in beforeIndexShardClosed\n[2015-01-16 15:49:29,087][INFO ][org.elasticsearch.test.store] [node_s0] [test][0] start check index\n[2015-01-16 15:49:29,088][INFO ][org.elasticsearch.test.store] [node_s0] [test][0] end check index\nelasticsearch[node_s0][clusterService#updateTask][T#1]IndexFieldCache.close() is invalidating reader 809938711 cache=1143842807 field=field\n```\n","performed_via_github_app":null}]