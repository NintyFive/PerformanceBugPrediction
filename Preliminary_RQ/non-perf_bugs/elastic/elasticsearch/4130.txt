{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4130","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4130/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4130/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4130/events","html_url":"https://github.com/elastic/elasticsearch/issues/4130","id":22345840,"node_id":"MDU6SXNzdWUyMjM0NTg0MA==","number":4130,"title":"Query DSL: Wrong result on bool filter with 'must_not' and 'geo_distance'","user":{"login":"Akii","id":1204017,"node_id":"MDQ6VXNlcjEyMDQwMTc=","avatar_url":"https://avatars1.githubusercontent.com/u/1204017?v=4","gravatar_id":"","url":"https://api.github.com/users/Akii","html_url":"https://github.com/Akii","followers_url":"https://api.github.com/users/Akii/followers","following_url":"https://api.github.com/users/Akii/following{/other_user}","gists_url":"https://api.github.com/users/Akii/gists{/gist_id}","starred_url":"https://api.github.com/users/Akii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Akii/subscriptions","organizations_url":"https://api.github.com/users/Akii/orgs","repos_url":"https://api.github.com/users/Akii/repos","events_url":"https://api.github.com/users/Akii/events{/privacy}","received_events_url":"https://api.github.com/users/Akii/received_events","type":"User","site_admin":false},"labels":[{"id":64134382,"node_id":"MDU6TGFiZWw2NDEzNDM4Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.7","name":"v0.90.7","color":"dddddd","default":false,"description":null},{"id":64607794,"node_id":"MDU6TGFiZWw2NDYwNzc5NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta2","name":"v1.0.0.Beta2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2013-11-08T16:07:00Z","updated_at":"2013-11-13T11:00:54Z","closed_at":"2013-11-13T11:00:54Z","author_association":"NONE","active_lock_reason":null,"body":"The Bool Filter returns the wrong result when combining the 'must_not' (or 'must') part with a 'should' containing a 'geo_distance' filter.\n\nConsider following example:\n\n```\ncurl -XDELETE localhost:9200/test\ncurl -XPUT localhost:9200/test\ncurl -XPUT 'localhost:9200/test/test/_mapping' -d '{\"test\" : {\"properties\" : { \"prop1\" : {\"type\":\"string\"}, \"location\": {\"type\":\"geo_point\"}}}}'\n\ncurl -XPUT 'localhost:9200/test/test/1' -d '{\"prop1\": \"5\", \"location\":{\"lon\":\"0\", \"lat\":\"0\"}}'\ncurl -XPUT 'localhost:9200/test/test/2' -d '{\"prop1\": \"5\", \"location\":{\"lon\":\"0\", \"lat\":\"0\"}}'\ncurl -XPUT 'localhost:9200/test/test/3' -d '{\"prop1\": \"4\", \"location\":{\"lon\":\"12\", \"lat\":\"12\"}}'\n```\n\nExample query 1:\n\n```\n{\n\"filter\" : {\n    \"bool\": {\n        \"must_not\": [\n            {\n                \"terms\": {\n                    \"_id\": [\n                        \"1\"\n                    ]\n                }\n            }\n        ],\n        \"should\": [\n            {\n                \"term\": {\n                    \"_name\": \"filter_requirements\",\n                    \"prop1\": \"5\"\n                }\n            },\n            {\n                \"geo_distance\": {\n                    \"_name\": \"filter_location\",\n                    \"distance\": \"6km\",\n                    \"location\": {\n                        \"lat\": \"12\", \n                        \"lon\": \"12\"\n                    }\n                }\n            }\n        ]\n    }\n}}}\n```\n\nThis returns only the document with the id 3. It should return both, 2 and 3 because 2 also matches the 'should' part. Document with id 1 is excluded as expected.\n\nExample query 2:\n\n```\n{\"filter\" : {\n    \"bool\": {\n        \"should\": [\n            {\n                \"term\": {\n                    \"_name\": \"filter_requirements\",\n                    \"prop1\": \"5\"\n                }\n            },\n            {\n                \"geo_distance\": {\n                    \"_name\": \"filter_location\",\n                    \"distance\": \"6km\",\n                    \"location\": {\n                        \"lat\": \"12\",\n                        \"lon\": \"12\"\n                    }\n                }\n            }\n        ]\n    }\n}}}\n```\n\nThis returns all 3 documents as expected. Note that the 'must_not' part has been removed. Bool filter works as expected.\n\nExample query 3:\n\n```\n{\"filter\" : {\n    \"bool\": {\n        \"must_not\": [\n            {\n                \"terms\": {\n                    \"_id\": [                       \n                        \"1\"     \n                    ]\n                }\n            }\n        ],                       \n        \"should\": [                            \n            {                         \n                \"term\": {        \n                    \"_name\": \"filter_requirements\",\n                    \"prop1\": \"5\"   \n                }    \n            }    \n        ]\n    }\n}}}\n```\n\nThis will correctly return only the document with id 2. The example above does not show this.. and it's kinda late now. You can remove either the 'should not' or the 'geo_distance' and the query will execute correctly.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}