{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52453","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52453/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52453/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52453/events","html_url":"https://github.com/elastic/elasticsearch/issues/52453","id":566732958,"node_id":"MDU6SXNzdWU1NjY3MzI5NTg=","number":52453,"title":"[CI] Incorrect watch count in watcher stats api in tests","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2020-02-18T08:43:07Z","updated_at":"2020-06-02T20:15:08Z","closed_at":"2020-06-02T20:15:08Z","author_association":"MEMBER","active_lock_reason":null,"body":"**SmokeTestWatcherTestSuiteIT Failure:**\r\n\r\n```\r\njava.lang.AssertionError: Watch count (from _watcher/stats) |  \r\n-- | --\r\n  | Expected: is <0> |  \r\n  | but: was <1> |  \r\n  | at __randomizedtesting.SeedInfo.seed([F316E92770C6654C:CE704783A70AC6]:0) |  \r\n  | at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18) |  \r\n  | at org.junit.Assert.assertThat(Assert.java:956) |  \r\n  | at org.elasticsearch.smoketest.SmokeTestWatcherTestSuiteIT.assertWatchCount(SmokeTestWatcherTestSuiteIT.java:270) |  \r\n  | at org.elasticsearch.smoketest.SmokeTestWatcherTestSuiteIT.lambda$testMonitorClusterHealth$3(SmokeTestWatcherTestSuiteIT.java:170) |  \r\n  | at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:880) |  \r\n  | at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:853) |  \r\n  | at org.elasticsearch.smoketest.SmokeTestWatcherTestSuiteIT.testMonitorClusterHealth(SmokeTestWatcherTestSuiteIT.java:170)\r\n```\r\n\r\nThe failure matches with recent failures reported in #32299. The #51466 fix didn't make this test stop from failing.\r\n\r\nThe failure has failed [a few times now](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'class:*SmokeTestWatcherWithSecurityIT+OR+class:*SmokeTestWatcherTestSuiteIT'),sort:!(time,desc))) and needs to be re-investigated.\r\n\r\nBuild failures:\r\n* https://gradle-enterprise.elastic.co/s/2r45iwxk4l2he (master)\r\n* https://gradle-enterprise.elastic.co/s/eqvqj2os5lpuo (7.x)\r\n\r\n**WatchAckTests.testAckAllActions failure:**\r\n\r\nBuild log: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+multijob+fast+part2/3568/console\r\n\r\nBuild scan: https://gradle-enterprise.elastic.co/s/ua3yon2njbyja\r\n\r\nFailure:\r\n\r\n```\r\njava.lang.AssertionError: \r\n12:01:55     Expected: is <1L>\r\n12:01:55          but: was <0L>\r\n12:01:55         at __randomizedtesting.SeedInfo.seed([6DEA8487F6CD3068:BAC8F0266D2192C2]:0)\r\n12:01:55         at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n12:01:55         at org.junit.Assert.assertThat(Assert.java:956)\r\n12:01:55         at org.junit.Assert.assertThat(Assert.java:923)\r\n12:01:55         at org.elasticsearch.xpack.watcher.test.integration.WatchAckTests.testAckAllActions(WatchAckTests.java:136)\r\n12:01:55 REPRODUCE WITH: ./gradlew ':x-pack:plugin:watcher:test' --tests \"org.elasticsearch.xpack.watcher.test.integration.WatchAckTests.testAckAllActions\" -Dtests.seed=6DEA8487F6CD3068 -Dtests.security.manager=true -Dtests.locale=th-TH-u-nu-thai-x-lvariant-TH -Dtests.timezone=Africa/Bamako -Dcompiler.java=13\r\n12:01:55 \r\n12:01:55 Suite: Test class org.elasticsearch.xpack.watcher.test.integration.WatchAckTests\r\n```\r\n\r\nReproduce with:\r\n\r\n```\r\n./gradlew ':x-pack:plugin:watcher:test' --tests \"org.elasticsearch.xpack.watcher.test.integration.WatchAckTests.testAckAllActions\" -Dtests.seed=6DEA8487F6CD3068 -Dtests.security.manager=true -Dtests.locale=th-TH-u-nu-thai-x-lvariant-TH -Dtests.timezone=Africa/Bamako -Dcompiler.java=13\r\n```\r\n\r\nCan't reproduce locally.","closed_by":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}