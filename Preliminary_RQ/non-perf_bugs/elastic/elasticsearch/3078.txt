{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3078","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3078/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3078/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3078/events","html_url":"https://github.com/elastic/elasticsearch/issues/3078","id":14665837,"node_id":"MDU6SXNzdWUxNDY2NTgzNw==","number":3078,"title":"String sorting incorrect after reindex","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":37906074,"node_id":"MDU6TGFiZWwzNzkwNjA3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.1","name":"v0.90.1","color":"DDDDDD","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":13,"created_at":"2013-05-23T09:43:59Z","updated_at":"2013-07-17T20:11:14Z","closed_at":"2013-05-24T06:38:09Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"After reindexing a doc, it is not being returned in the correct sort order (when sorting on a string field)\n\nFirst, index docs 1..100 with a string field `user`:\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/test/test/_bulk?pretty=1'  -d '\n{\"index\" : {\"_id\" : \"1\"}}\n{\"user\" : \"1\"}\n{\"index\" : {\"_id\" : \"2\"}}\n{\"user\" : \"2\"}\n{\"index\" : {\"_id\" : \"3\"}}\n{\"user\" : \"3\"}\n{\"index\" : {\"_id\" : \"4\"}}\n{\"user\" : \"4\"}\n{\"index\" : {\"_id\" : \"5\"}}\n{\"user\" : \"5\"}\n{\"index\" : {\"_id\" : \"6\"}}\n{\"user\" : \"6\"}\n{\"index\" : {\"_id\" : \"7\"}}\n{\"user\" : \"7\"}\n{\"index\" : {\"_id\" : \"8\"}}\n{\"user\" : \"8\"}\n{\"index\" : {\"_id\" : \"9\"}}\n{\"user\" : \"9\"}\n{\"index\" : {\"_id\" : \"10\"}}\n{\"user\" : \"10\"}\n{\"index\" : {\"_id\" : \"11\"}}\n{\"user\" : \"11\"}\n{\"index\" : {\"_id\" : \"12\"}}\n{\"user\" : \"12\"}\n{\"index\" : {\"_id\" : \"13\"}}\n{\"user\" : \"13\"}\n{\"index\" : {\"_id\" : \"14\"}}\n{\"user\" : \"14\"}\n{\"index\" : {\"_id\" : \"15\"}}\n{\"user\" : \"15\"}\n{\"index\" : {\"_id\" : \"16\"}}\n{\"user\" : \"16\"}\n{\"index\" : {\"_id\" : \"17\"}}\n{\"user\" : \"17\"}\n{\"index\" : {\"_id\" : \"18\"}}\n{\"user\" : \"18\"}\n{\"index\" : {\"_id\" : \"19\"}}\n{\"user\" : \"19\"}\n{\"index\" : {\"_id\" : \"20\"}}\n{\"user\" : \"20\"}\n{\"index\" : {\"_id\" : \"21\"}}\n{\"user\" : \"21\"}\n{\"index\" : {\"_id\" : \"22\"}}\n{\"user\" : \"22\"}\n{\"index\" : {\"_id\" : \"23\"}}\n{\"user\" : \"23\"}\n{\"index\" : {\"_id\" : \"24\"}}\n{\"user\" : \"24\"}\n{\"index\" : {\"_id\" : \"25\"}}\n{\"user\" : \"25\"}\n{\"index\" : {\"_id\" : \"26\"}}\n{\"user\" : \"26\"}\n{\"index\" : {\"_id\" : \"27\"}}\n{\"user\" : \"27\"}\n{\"index\" : {\"_id\" : \"28\"}}\n{\"user\" : \"28\"}\n{\"index\" : {\"_id\" : \"29\"}}\n{\"user\" : \"29\"}\n{\"index\" : {\"_id\" : \"30\"}}\n{\"user\" : \"30\"}\n{\"index\" : {\"_id\" : \"31\"}}\n{\"user\" : \"31\"}\n{\"index\" : {\"_id\" : \"32\"}}\n{\"user\" : \"32\"}\n{\"index\" : {\"_id\" : \"33\"}}\n{\"user\" : \"33\"}\n{\"index\" : {\"_id\" : \"34\"}}\n{\"user\" : \"34\"}\n{\"index\" : {\"_id\" : \"35\"}}\n{\"user\" : \"35\"}\n{\"index\" : {\"_id\" : \"36\"}}\n{\"user\" : \"36\"}\n{\"index\" : {\"_id\" : \"37\"}}\n{\"user\" : \"37\"}\n{\"index\" : {\"_id\" : \"38\"}}\n{\"user\" : \"38\"}\n{\"index\" : {\"_id\" : \"39\"}}\n{\"user\" : \"39\"}\n{\"index\" : {\"_id\" : \"40\"}}\n{\"user\" : \"40\"}\n{\"index\" : {\"_id\" : \"41\"}}\n{\"user\" : \"41\"}\n{\"index\" : {\"_id\" : \"42\"}}\n{\"user\" : \"42\"}\n{\"index\" : {\"_id\" : \"43\"}}\n{\"user\" : \"43\"}\n{\"index\" : {\"_id\" : \"44\"}}\n{\"user\" : \"44\"}\n{\"index\" : {\"_id\" : \"45\"}}\n{\"user\" : \"45\"}\n{\"index\" : {\"_id\" : \"46\"}}\n{\"user\" : \"46\"}\n{\"index\" : {\"_id\" : \"47\"}}\n{\"user\" : \"47\"}\n{\"index\" : {\"_id\" : \"48\"}}\n{\"user\" : \"48\"}\n{\"index\" : {\"_id\" : \"49\"}}\n{\"user\" : \"49\"}\n{\"index\" : {\"_id\" : \"50\"}}\n{\"user\" : \"50\"}\n{\"index\" : {\"_id\" : \"51\"}}\n{\"user\" : \"51\"}\n{\"index\" : {\"_id\" : \"52\"}}\n{\"user\" : \"52\"}\n{\"index\" : {\"_id\" : \"53\"}}\n{\"user\" : \"53\"}\n{\"index\" : {\"_id\" : \"54\"}}\n{\"user\" : \"54\"}\n{\"index\" : {\"_id\" : \"55\"}}\n{\"user\" : \"55\"}\n{\"index\" : {\"_id\" : \"56\"}}\n{\"user\" : \"56\"}\n{\"index\" : {\"_id\" : \"57\"}}\n{\"user\" : \"57\"}\n{\"index\" : {\"_id\" : \"58\"}}\n{\"user\" : \"58\"}\n{\"index\" : {\"_id\" : \"59\"}}\n{\"user\" : \"59\"}\n{\"index\" : {\"_id\" : \"60\"}}\n{\"user\" : \"60\"}\n{\"index\" : {\"_id\" : \"61\"}}\n{\"user\" : \"61\"}\n{\"index\" : {\"_id\" : \"62\"}}\n{\"user\" : \"62\"}\n{\"index\" : {\"_id\" : \"63\"}}\n{\"user\" : \"63\"}\n{\"index\" : {\"_id\" : \"64\"}}\n{\"user\" : \"64\"}\n{\"index\" : {\"_id\" : \"65\"}}\n{\"user\" : \"65\"}\n{\"index\" : {\"_id\" : \"66\"}}\n{\"user\" : \"66\"}\n{\"index\" : {\"_id\" : \"67\"}}\n{\"user\" : \"67\"}\n{\"index\" : {\"_id\" : \"68\"}}\n{\"user\" : \"68\"}\n{\"index\" : {\"_id\" : \"69\"}}\n{\"user\" : \"69\"}\n{\"index\" : {\"_id\" : \"70\"}}\n{\"user\" : \"70\"}\n{\"index\" : {\"_id\" : \"71\"}}\n{\"user\" : \"71\"}\n{\"index\" : {\"_id\" : \"72\"}}\n{\"user\" : \"72\"}\n{\"index\" : {\"_id\" : \"73\"}}\n{\"user\" : \"73\"}\n{\"index\" : {\"_id\" : \"74\"}}\n{\"user\" : \"74\"}\n{\"index\" : {\"_id\" : \"75\"}}\n{\"user\" : \"75\"}\n{\"index\" : {\"_id\" : \"76\"}}\n{\"user\" : \"76\"}\n{\"index\" : {\"_id\" : \"77\"}}\n{\"user\" : \"77\"}\n{\"index\" : {\"_id\" : \"78\"}}\n{\"user\" : \"78\"}\n{\"index\" : {\"_id\" : \"79\"}}\n{\"user\" : \"79\"}\n{\"index\" : {\"_id\" : \"80\"}}\n{\"user\" : \"80\"}\n{\"index\" : {\"_id\" : \"81\"}}\n{\"user\" : \"81\"}\n{\"index\" : {\"_id\" : \"82\"}}\n{\"user\" : \"82\"}\n{\"index\" : {\"_id\" : \"83\"}}\n{\"user\" : \"83\"}\n{\"index\" : {\"_id\" : \"84\"}}\n{\"user\" : \"84\"}\n{\"index\" : {\"_id\" : \"85\"}}\n{\"user\" : \"85\"}\n{\"index\" : {\"_id\" : \"86\"}}\n{\"user\" : \"86\"}\n{\"index\" : {\"_id\" : \"87\"}}\n{\"user\" : \"87\"}\n{\"index\" : {\"_id\" : \"88\"}}\n{\"user\" : \"88\"}\n{\"index\" : {\"_id\" : \"89\"}}\n{\"user\" : \"89\"}\n{\"index\" : {\"_id\" : \"90\"}}\n{\"user\" : \"90\"}\n{\"index\" : {\"_id\" : \"91\"}}\n{\"user\" : \"91\"}\n{\"index\" : {\"_id\" : \"92\"}}\n{\"user\" : \"92\"}\n{\"index\" : {\"_id\" : \"93\"}}\n{\"user\" : \"93\"}\n{\"index\" : {\"_id\" : \"94\"}}\n{\"user\" : \"94\"}\n{\"index\" : {\"_id\" : \"95\"}}\n{\"user\" : \"95\"}\n{\"index\" : {\"_id\" : \"96\"}}\n{\"user\" : \"96\"}\n{\"index\" : {\"_id\" : \"97\"}}\n{\"user\" : \"97\"}\n{\"index\" : {\"_id\" : \"98\"}}\n{\"user\" : \"98\"}\n{\"index\" : {\"_id\" : \"99\"}}\n{\"user\" : \"99\"}\n{\"index\" : {\"_id\" : \"100\"}}\n{\"user\" : \"100\"}\n'\n```\n\nSearch, sorting on `user`:\n\n```\ncurl -XGET 'http://127.0.0.1:9200/test/_search?pretty=1'  -d '\n{\n   \"sort\" : {\n      \"user\" : \"asc\"\n   },\n   \"fields\" : [],\n   \"size\" : 10\n}\n'\n```\n\nResults show that `user:1` is in first position:\n\n```\n# {\n#    \"hits\" : {\n#       \"hits\" : [\n#          {\n#             \"sort\" : [\n#                \"1\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"1\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"10\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"10\",\n#             \"_type\" : \"test\"\n#          },\n# ....\n```\n\nNow reindex the first doc, with the same values:\n\n```\ncurl -XPUT 'http://127.0.0.1:9200/test/test/1?pretty=1'  -d '\n{\n   \"user\" : \"1\"\n}\n'\n```\n\nAnd search again:\n\n```\ncurl -XGET 'http://127.0.0.1:9200/test/_search?pretty=1'  -d '\n{\n   \"sort\" : {\n      \"user\" : \"asc\"\n   },\n   \"fields\" : [],\n   \"size\" : 10\n}\n'\n```\n\nDoc with `user:1` no longer appears in the correct position, in fact it doesn't appear anywhere in the first 10 results:\n\n```\n# {\n#    \"hits\" : {\n#       \"hits\" : [\n#          {\n#             \"sort\" : [\n#                \"10\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"10\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"100\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"100\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"11\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"11\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"12\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"12\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"13\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"13\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"14\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"14\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"15\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"15\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"16\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"16\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"17\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"17\",\n#             \"_type\" : \"test\"\n#          },\n#          {\n#             \"sort\" : [\n#                \"18\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"18\",\n#             \"_type\" : \"test\"\n#          }\n#       ],\n#       \"max_score\" : null,\n#       \"total\" : 100\n#    },\n#    \"timed_out\" : false,\n#    \"_shards\" : {\n#       \"failed\" : 0,\n#       \"successful\" : 5,\n#       \"total\" : 5\n#    },\n#    \"took\" : 3\n# }\n```\n\nHowever, if you return all 100 docs, then it appears in the first position again (correctly):\n\n```\ncurl -XGET 'http://127.0.0.1:9200/test/_search?pretty=1'  -d '\n{\n   \"sort\" : {\n      \"user\" : \"asc\"\n   },\n   \"fields\" : [],\n   \"size\" : 100\n}\n'\n\n# {\n#    \"hits\" : {\n#       \"hits\" : [\n#          {\n#             \"sort\" : [\n#                \"1\"\n#             ],\n#             \"_score\" : null,\n#             \"_index\" : \"test\",\n#             \"_id\" : \"1\",\n#             \"_type\" : \"test\"\n#          },\n```\n\nwhich leads me to think that it is the shard level sorting which is incorrect.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}