{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55764","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55764/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55764/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55764/events","html_url":"https://github.com/elastic/elasticsearch/issues/55764","id":606718355,"node_id":"MDU6SXNzdWU2MDY3MTgzNTU=","number":55764,"title":"FilterAllocationDecider routing exclude setting behavior","user":{"login":"sohami","id":22159459,"node_id":"MDQ6VXNlcjIyMTU5NDU5","avatar_url":"https://avatars1.githubusercontent.com/u/22159459?v=4","gravatar_id":"","url":"https://api.github.com/users/sohami","html_url":"https://github.com/sohami","followers_url":"https://api.github.com/users/sohami/followers","following_url":"https://api.github.com/users/sohami/following{/other_user}","gists_url":"https://api.github.com/users/sohami/gists{/gist_id}","starred_url":"https://api.github.com/users/sohami/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sohami/subscriptions","organizations_url":"https://api.github.com/users/sohami/orgs","repos_url":"https://api.github.com/users/sohami/repos","events_url":"https://api.github.com/users/sohami/events{/privacy}","received_events_url":"https://api.github.com/users/sohami/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-04-25T08:19:50Z","updated_at":"2020-04-26T04:08:49Z","closed_at":"2020-04-25T10:50:25Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (Verified on 6.8 and 7.4.2):\r\n\r\n**Plugins installed**: [none]\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI was exploring the FilterAllocationDecider behavior with **cluster.routing.allocation.exclude** setting, specially how the updates of these setting group works. I found that the behavior is not as per my expectation and think it is a bug in ES.\r\n\r\nLet's say there are 2 attributes \"attr_1\" and \"attr_2\" for which we want to put the exclusion filter for FilterAllocationDecider to consider. FilterAllocationDecider has a consumer registered for the settings in **cluster.routing.allocation.exclude** group. The expectation is with each update setting request for this group, the clusterExcludeFilters in FilterAllocationDecider will be updated such that keeps all the exclusion applied so far. However, it looks like it only keeps the difference in previous and current settings for this group.\r\n\r\n**Steps to reproduce**:\r\nCase 1:\r\n- Request 1: set the value of only \"attr_1\" to be \"1\"\r\n   - Verified `clusterExcludeFilter` in `FilterAllocationDecider` has key: \"attr_1\" with value: \"1\"\r\n- Request 2: set the value of only \"attr_2\" to be \"abc\"\r\n   - Expectation is `clusterExcludeFilter` in `FilterAllocationDecider` will have 2 keys \"attr_1\" and \"attr_2\" with value \"1\" and \"abc\" respectively. However, the second request removes the first key \"attr_1\" and only keep the second key \"attr_2\" in the `clusterExcludeFilter`\r\n\r\nCase 2:\r\n- Request 1: set the value of \"attr_1\" to be \"1\" and \"attr_2\" to be \"abc\"\r\n   - Verified `clusterExcludeFilter` in `FilterAllocationDecider` has key: \"attr_1\" with value: \"1\" and key \"attr_2\" with value: \"abc\"\r\n- Request 2: set the value of \"attr_1\" to be \"1\" and \"attr_2\" to be \"def\"\r\n   - Expectation is `clusterExcludeFilter` in `FilterAllocationDecider` will have 2 keys \"attr_1\" and \"attr_2\" with value \"1\" and \"def\" respectively. However, the second request removes the first key \"attr_1\" and only keep the second key \"attr_2\" with value \"def\" in the `clusterExcludeFilter`\r\n\r\nI have created a test here for various scenarios showing the behavior: \r\nhttps://github.com/sohami/elasticsearch/commits/7.4.2-test\r\n\r\n**Details:**\r\nFor **cluster.routing.allocation.exclude** setting the FilterAllocationDecider registers a setting updater created using [newAffixMapUpdater](https://github.com/sohami/elasticsearch/blob/7.4.2-test/server/src/main/java/org/elasticsearch/common/settings/Setting.java#L736). This updater checks for the difference in settings for this group between current and previous settings and calls the consumer with the diff of the setting. There is a local [result](https://github.com/sohami/elasticsearch/blob/7.4.2-test/server/src/main/java/org/elasticsearch/common/settings/Setting.java#L748) map which is populated with the changed setting and passed to the [consumer here](https://github.com/sohami/elasticsearch/blob/7.4.2-test/server/src/main/java/org/elasticsearch/common/settings/Setting.java#L766). \r\n\r\n**Proposal:**\r\n- The result map in the `newAffixMapUpdater` should be a member variable rather than local variable, so that it keeps all the changed settings so far and always return that to the consumer.\r\n- `FilterAllocationDecider` keeps adding/updating the settings as and when updated instead of reinitializing the new [DiscoveryNodeFilters](https://github.com/sohami/elasticsearch/blob/7.4.2-test/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/FilterAllocationDecider.java#L196) for each setting update ","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}