{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58643","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58643/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58643/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58643/events","html_url":"https://github.com/elastic/elasticsearch/issues/58643","id":647079749,"node_id":"MDU6SXNzdWU2NDcwNzk3NDk=","number":58643,"title":"component template cannot update after ES7.8 reboot","user":{"login":"shotecorps","id":31640309,"node_id":"MDQ6VXNlcjMxNjQwMzA5","avatar_url":"https://avatars3.githubusercontent.com/u/31640309?v=4","gravatar_id":"","url":"https://api.github.com/users/shotecorps","html_url":"https://github.com/shotecorps","followers_url":"https://api.github.com/users/shotecorps/followers","following_url":"https://api.github.com/users/shotecorps/following{/other_user}","gists_url":"https://api.github.com/users/shotecorps/gists{/gist_id}","starred_url":"https://api.github.com/users/shotecorps/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shotecorps/subscriptions","organizations_url":"https://api.github.com/users/shotecorps/orgs","repos_url":"https://api.github.com/users/shotecorps/repos","events_url":"https://api.github.com/users/shotecorps/events{/privacy}","received_events_url":"https://api.github.com/users/shotecorps/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-06-29T03:13:51Z","updated_at":"2020-07-06T16:21:23Z","closed_at":"2020-07-06T16:21:22Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.8.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk 14.0.1 2020-04-14\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 14.0.1+7)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 14.0.1+7, mixed mode, sharing)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux ubuntu 4.15.0-106-generic #107-Ubuntu SMP Thu Jun 4 11:27:52 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning 7.8.0 official docker image. Put an index template that using one component template. Restart the container.\r\nUse the same configuration to update the existed component template. You will get \"updating component template [x] results in invalid composable template [x] after templates are merged\"\r\n\r\n**Steps to reproduce**:\r\n1.Start a es7.8.0 nodel with docker-compose.\r\ncompose file:\r\nversion: '3'\r\nservices:\r\n  es_master:\r\n    image: elasticsearch:7.8.0\r\n    container_name: es_master\r\n    restart: always\r\n    environment:\r\n      - cluster.name=shotecorps\r\n      - network.host=192.168.55.3\r\n      - http.port=9200\r\n      - transport.port=9300\r\n      - node.name=master\r\n      - node.remote_cluster_client=false\r\n      - node.ml=false\r\n      - discovery.seed_hosts=192.168.55.3:9300\r\n      - cluster.initial_master_nodes=master1\r\n      - \"ES_JAVA_OPTS=-Xms2g -Xmx2g\"\r\n      - \"action.auto_create_index=-write-*,-act-*,-read-*,*\"\r\n      - \"node.attr.hot=true\"\r\n      - \"node.attr.warm=true\"\r\n      - path.repo=/usr/share/elasticsearch/data/backup\r\n      - bootstrap.memory_lock=true\r\n    ports:\r\n      - \"9300:9300\"\r\n    volumes:\r\n      - /opt/elasticsearch/config/:/usr/share/elasticsearch/config/\r\n      - /opt/elasticsearch/data/:/usr/share/elasticsearch/data/\r\n      - /opt/elasticsearch/log/:/usr/share/elasticsearch/logs/\r\n    logging:\r\n      driver: \"json-file\"\r\n      options:\r\n        max-size: \"100m\"\r\n    network_mode: \"host\"\r\n  kibana:\r\n    image: kibana:7.8.0\r\n    container_name: kibana\r\n    restart: always\r\n    container_name: kibana\r\n    restart: always\r\n    environment:\r\n      - ELASTICSEARCH_URL=http://192.168.55.3:9200\r\n      - ELASTICSEARCH_HOSTS=http://192.168.55.3:9200\r\n    ports:\r\n      - \"5601:5601\"\r\n\r\n2. put component template\r\nPUT _component_template/a\r\n{\r\n  \"template\": {\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"codec\": \"default\",\r\n        \"routing\": {\r\n          \"allocation\": {\r\n            \"require\": {\r\n              \"hot\": \"true\"\r\n            }\r\n          }\r\n        },\r\n        \"refresh_interval\": \"60s\",\r\n        \"number_of_shards\": \"1\",\r\n        \"number_of_replicas\": \"0\"\r\n      }\r\n    },\r\n    \"mappings\": {\r\n      \"dynamic\": \"false\"\r\n    }\r\n  }\r\n}\r\n\r\n3. put index template\r\nPUT _index_template/template_2\r\n{\r\n  \"index_patterns\": [\"test*\"],\r\n  \"template\": {\r\n    \"mappings\": {\r\n      \"properties\": {\r\n        \"host_name\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"priority\": 10,\r\n  \"composed_of\": [\"a\"]\r\n}\r\n\r\n(Now you can update the component/index template, or create new index template that uses the existed component template successfully)\r\n\r\n\r\n4. kill es container and restart it\r\n_shotecorps@ubuntu:~/tmp$ docker ps\r\nCONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES\r\n1743ca1ce44b        kibana:7.8.0          \"/usr/local/bin/dumb…\"   5 minutes ago       Up 5 minutes        0.0.0.0:5601->5601/tcp   kibana\r\n56a923fdf7c2        elasticsearch:7.8.0   \"/tini -- /usr/local…\"   5 minutes ago       Up 5 minutes                                 es_master\r\nshotecorps@ubuntu:~/tmp$ docker rm 56a923fdf7c2 -f\r\n56a923fdf7c2\r\nshotecorps@ubuntu:~/tmp$ docker ps\r\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES\r\n1743ca1ce44b        kibana:7.8.0        \"/usr/local/bin/dumb…\"   5 minutes ago       Up 5 minutes        0.0.0.0:5601->5601/tcp   kibana\r\nshotecorps@ubuntu:~/tmp$ docker-compose -f docker-compose.yml up -d\r\nkibana is up-to-date\r\nCreating es_master ... done_\r\n\r\n5. After es started, update old component template will get error response.\r\nAnd you cannot put new index template that uses the old component template either.\r\n\r\nPUT _component_template/a\r\n{\r\n  \"template\": {\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"codec\": \"default\",\r\n        \"routing\": {\r\n          \"allocation\": {\r\n            \"require\": {\r\n              \"hot\": \"true\"\r\n            }\r\n          }\r\n        },\r\n        \"refresh_interval\": \"60s\",\r\n        \"number_of_shards\": \"1\",\r\n        \"number_of_replicas\": \"0\"\r\n      }\r\n    },\r\n    \"mappings\": {\r\n      \"dynamic\": \"false\"\r\n    }\r\n  }\r\n}\r\n\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"illegal_argument_exception\",\r\n        \"reason\" : \"updating component template [a] results in invalid composable template [template_2] after templates are merged\"\r\n      }\r\n    ],\r\n    \"type\" : \"illegal_argument_exception\",\r\n    \"reason\" : \"updating component template [a] results in invalid composable template [template_2] after templates are merged\",\r\n    \"caused_by\" : {\r\n      \"type\" : \"illegal_argument_exception\",\r\n      \"reason\" : \"invalid composite mappings for [template_2]\",\r\n      \"caused_by\" : {\r\n        \"type\" : \"illegal_state_exception\",\r\n        \"reason\" : \"invalid mapping definition, expected a single map underneath [_doc] but it was: [{properties={host_name={type=keyword}}}]\"\r\n      }\r\n    }\r\n  },\r\n  \"status\" : 400\r\n}\r\n\r\nPUT _index_template/template_3\r\n{\r\n  \"index_patterns\": [\"new*\"],\r\n  \"template\": {\r\n    \"mappings\": {\r\n      \"properties\": {\r\n        \"host_name\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"priority\": 10,\r\n  \"composed_of\": [\"a\"]\r\n}\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"illegal_argument_exception\",\r\n        \"reason\" : \"composable template [template_3] template after composition with component templates [a] is invalid\"\r\n      }\r\n    ],\r\n    \"type\" : \"illegal_argument_exception\",\r\n    \"reason\" : \"composable template [template_3] template after composition with component templates [a] is invalid\",\r\n    \"caused_by\" : {\r\n      \"type\" : \"illegal_argument_exception\",\r\n      \"reason\" : \"invalid composite mappings for [template_3]\",\r\n      \"caused_by\" : {\r\n        \"type\" : \"illegal_state_exception\",\r\n        \"reason\" : \"invalid mapping definition, expected a single map underneath [_doc] but it was: [{dynamic=false}]\"\r\n      }\r\n    }\r\n  },\r\n  \"status\" : 400\r\n}\r\n\r\n\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}