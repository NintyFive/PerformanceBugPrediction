{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34708","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34708/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34708/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34708/events","html_url":"https://github.com/elastic/elasticsearch/issues/34708","id":372515194,"node_id":"MDU6SXNzdWUzNzI1MTUxOTQ=","number":34708,"title":"MatchNoDocsQuery in simple_query_string query with unmapped field and AND operator returning no results","user":{"login":"robinroestenburg","id":693266,"node_id":"MDQ6VXNlcjY5MzI2Ng==","avatar_url":"https://avatars0.githubusercontent.com/u/693266?v=4","gravatar_id":"","url":"https://api.github.com/users/robinroestenburg","html_url":"https://github.com/robinroestenburg","followers_url":"https://api.github.com/users/robinroestenburg/followers","following_url":"https://api.github.com/users/robinroestenburg/following{/other_user}","gists_url":"https://api.github.com/users/robinroestenburg/gists{/gist_id}","starred_url":"https://api.github.com/users/robinroestenburg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robinroestenburg/subscriptions","organizations_url":"https://api.github.com/users/robinroestenburg/orgs","repos_url":"https://api.github.com/users/robinroestenburg/repos","events_url":"https://api.github.com/users/robinroestenburg/events{/privacy}","received_events_url":"https://api.github.com/users/robinroestenburg/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1056536047,"node_id":"MDU6TGFiZWwxMDU2NTM2MDQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.2","name":"v6.4.2","color":"Dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-10-22T13:11:47Z","updated_at":"2018-11-21T02:49:49Z","closed_at":"2018-11-21T02:49:49Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n```\r\nVersion: 6.4.2, Build: oss/tar/04711c2/2018-09-26T13:34:09.098244Z, JVM: 1.8.0_171\r\n```\r\n\r\n**Plugins installed**: \r\n```\r\n[analysis-icu]\r\n```\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_171\"\r\nOpenJDK Runtime Environment (IcedTea 3.8.0) (Alpine 8.171.11-r0)\r\nOpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux 387e0b185f37 4.4.0-135-generic #161-Ubuntu SMP Mon Aug 27 10:45:01 UTC 2018 x86_64 Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRelated to the issue described in #28856 and #33427, when I execute a `simple_query_string` with the following conditions:\r\n\r\n- the query string is analyzed with a standard analyzer\r\n- the query contains a token (e.g. `&`) that is ignored by the standard analyzer\r\n- the query has multiple fields configured\r\n- not all fields exist in the mapping and document\r\n- the `default_operator` is AND\r\n\r\nThe token is not found in any of the fields but for fields that do not exist in the mapping a `MatchNoDocsQuery` is returned instead of omitting the token. The combination with the AND operator ensures that no result will match, regardless of what is queried.\r\n\r\nThe expected behavior is for the token to be removed from the token stream, not to be replaced by `MatchNoDocsQuery`.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create an index with multiple fields:\r\n\r\n```\r\n$ curl -X PUT -H \"Content-Type: application/json\" \"http://localhost:9200/unmapped-field-test\" -d '{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"title\": { \"type\": \"text\" },\r\n        \"body\": { \"type\": \"text\" }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n 2. Validate the query:\r\n\r\n```\r\n$ curl -X POST -H \"Content-Type: application/json\" \"http://localhost:9200/unmapped-field-test/doc/_validate/query?explain\" -d '{\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"risk & impact analysis\",\r\n      \"fields\": [\"title\", \"title_en_us\", \"body\"],\r\n      \"default_operator\": \"AND\"\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\nThis results in the following error:\r\n\r\n```\r\n{\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"valid\": true,\r\n  \"explanations\": [\r\n    {\r\n      \"index\": \"unmapped-field-test\",\r\n      \"valid\": true,\r\n      \"explanation\": \"+(+(title:risk | body:risk | MatchNoDocsQuery(\\\"unmapped field [title_en_us]\\\"))~1.0 +MatchNoDocsQuery(\\\"unmapped field [title_en_us]\\\") +(title:impact | body:impact | MatchNoDocsQuery(\\\"unmapped field [title_en_us]\\\"))~1.0 +(title:analysis | body:analysis | MatchNoDocsQuery(\\\"unmapped field [title_en_us]\\\"))~1.0) #*:*\"\r\n    }\r\n  ]\r\n}\r\n```\r\n \r\n3. After creating a document containing the field:\r\n\r\n```\r\n$ curl -X POST -H \"Content-Type: application/json\" \"http://localhost:9200/unmapped-field-test/doc\" -d '{\r\n  \"title\": \"foo\",\r\n  \"title_en_us\": \"foo_en_us\",\r\n  \"body\": \"bar\"\r\n}'\r\n```\r\n\r\n4. The above query no longer returns an error (as it is now present in the mapping):\r\n```\r\n$ curl -X POST -H \"Content-Type: application/json\" \"http://localhost:9200/unmapped-field-test/doc/_validate/query?explain\" -d '{\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"risk & impact analysis\",\r\n      \"fields\": [\"title\", \"title_en_us\", \"body\"],\r\n      \"default_operator\": \"AND\"\r\n    }\r\n  }\r\n}'\r\n```\r\n```\r\n{\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"valid\": true,\r\n  \"explanations\": [\r\n    {\r\n      \"index\": \"unmapped-field-test\",\r\n      \"valid\": true,\r\n      \"explanation\": \"+(+(title:risk | body:risk | title_en_us:risk)~1.0 +(title:impact | body:impact | title_en_us:impact)~1.0 +(title:analysis | body:analysis | title_en_us:analysis)~1.0) #*:*\"\r\n    }\r\n  ]\r\n}\r\n```","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}