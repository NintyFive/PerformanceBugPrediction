{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14290","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14290/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14290/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14290/events","html_url":"https://github.com/elastic/elasticsearch/issues/14290","id":113442084,"node_id":"MDU6SXNzdWUxMTM0NDIwODQ=","number":14290,"title":"simple lang-groovy test fails presumably due to classloader issues","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2015-10-26T20:16:31Z","updated_at":"2016-02-01T08:39:08Z","closed_at":"2016-02-01T08:39:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"this is a 2.2 upwards issue which is likely due to classloader problems. The issue occurs upon cherry-picking a test like this `git cherry-pick d752d69ad1a5d1c5eaec1c3291b97b17360bb1e3`  which basically adds a simple test using a closure:\n\n``` diff\n--- a/plugins/lang-groovy/src/test/java/org/elasticsearch/script/groovy/GroovySecurityTests.java\n+++ b/plugins/lang-groovy/src/test/java/org/elasticsearch/script/groovy/GroovySecurityTests.java\n@@ -83,6 +83,8 @@ public class GroovySecurityTests extends ESIntegTestCase {\n         assertSuccess(\"def v = doc['foo'].value; def m = [:]; m.put(\\\"value\\\", v)\");\n         // Times\n         assertSuccess(\"def t = Instant.now().getMillis()\");\n+        // groovy time\n+        assertSuccess(\"use(groovy.time.TimeCategory) { new Date(123456789).format('HH') }\");\n         // GroovyCollections\n         assertSuccess(\"def n = [1,2,3]; GroovyCollections.max(n)\");\n```\n\nit causes this exception:\n\n```\nStarted J0 PID(42388@panthor.local).\nSuite: org.elasticsearch.script.groovy.GroovySecurityTests\n  2> REPRODUCE WITH: mvn test -Pdev -pl org.elasticsearch.plugin:lang-groovy -Dtests.seed=3257189F4994B662 -Dtests.class=org.elasticsearch.script.groovy.GroovySecurityTests -Dtests.method=\"testEvilGroovyScripts\" -Des.logger.level=ERROR -Dtests.assertion.disabled=false -Dtests.security.manager=true -Dtests.heap.size=512m -Dtests.locale=it_CH -Dtests.timezone=America/Belize\nFAILURE 6.47s | GroovySecurityTests.testEvilGroovyScripts <<<\n   > Throwable #1: java.lang.AssertionError: Unexpected ShardFailures: [shard [[wbu9YNtHQoenb6TcMBSRoA][test][3]], reason [RemoteTransportException[[node_t0][local[1]][indices:data/read/search[phase/query/id]]]; nested: QueryPhaseExecutionException[Query Failed [Failed to execute main query]]; nested: ScriptException[failed to run inline script [use(groovy.time.TimeCategory) { new Date(123456789).format('HH') }; doc['foo'].value + 2] using lang [groovy]]; nested: IllegalAccessException[Class org.codehaus.groovy.reflection.CachedMethod can not access a member of class edb3a80dafbe8a36227baf55e0419d03a36948bc$_run_closure1 with modifiers \"public\"]; ], cause [ScriptException[failed to run inline script [use(groovy.time.TimeCategory) { new Date(123456789).format('HH') }; doc['foo'].value + 2] using lang [groovy]]; nested: IllegalAccessException[Class org.codehaus.groovy.reflection.CachedMethod can not access a member of class edb3a80dafbe8a36227baf55e0419d03a36948bc$_run_closure1 with modifiers \"public\"];\n   >    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:301)\n   >    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.runAsDouble(GroovyScriptEngineService.java:317)\n   >    at org.elasticsearch.search.sort.ScriptSortParser$2$1.get(ScriptSortParser.java:195)\n   >    at org.elasticsearch.index.fielddata.NumericDoubleValues$1.get(NumericDoubleValues.java:47)\n   >    at org.apache.lucene.search.FieldComparator$DoubleComparator.copy(FieldComparator.java:211)\n   >    at org.apache.lucene.search.TopFieldCollector$SimpleFieldCollector$1.collect(TopFieldCollector.java:206)\n   >    at org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:53)\n   >    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:218)\n   >    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:169)\n   >    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)\n   >    at org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:70)\n   >    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:800)\n   >    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:514)\n   >    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:334)\n   >    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:125)\n   >    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:340)\n   >    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:354)\n   >    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:351)\n   >    at org.elasticsearch.transport.local.LocalTransport$2.doRun(LocalTransport.java:296)\n   >    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n   >    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   >    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   >    at java.lang.Thread.run(Thread.java:745)\n   > Caused by: java.lang.IllegalAccessException: Class org.codehaus.groovy.reflection.CachedMethod can not access a member of class edb3a80dafbe8a36227baf55e0419d03a36948bc$_run_closure1 with modifiers \"public\"\n   >    at java.lang.reflect.AccessibleObject.slowCheckMemberAccess(AccessibleObject.java:296)\n   >    at java.lang.reflect.AccessibleObject.checkAccess(AccessibleObject.java:288)\n   >    at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:93)\n   >    at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:325)\n   >    at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:294)\n   >    at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1019)\n   >    at groovy.lang.Closure.call(Closure.java:426)\n   >    at groovy.lang.Closure.call(Closure.java:420)\n   >    at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.use(GroovyCategorySupport.java:112)\n   >    at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.access$400(GroovyCategorySupport.java:68)\n   >    at org.codehaus.groovy.runtime.GroovyCategorySupport.use(GroovyCategorySupport.java:252)\n   >    at org.codehaus.groovy.runtime.DefaultGroovyMethods.use(DefaultGroovyMethods.java:406)\n   >    at org.codehaus.groovy.runtime.dgm$755.doMethodInvoke(Unknown Source)\n   >    at org.codehaus.groovy.vmplugin.v7.IndyInterface.selectMethod(IndyInterface.java:218)\n   >    at edb3a80dafbe8a36227baf55e0419d03a36948bc.run(edb3a80dafbe8a36227baf55e0419d03a36948bc:1)\n   >    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:296)\n   >    ... 22 more\n   > ]]\n   > Expected: <0>\n   >      but: was <1>\n   >    at __randomizedtesting.SeedInfo.seed([3257189F4994B662:26BC7BE015A09D8A]:0)\n   >    at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\n   >    at org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailures(ElasticsearchAssertions.java:294)\n   >    at org.elasticsearch.script.groovy.GroovySecurityTests.assertSuccess(GroovySecurityTests.java:129)\n   >    at org.elasticsearch.script.groovy.GroovySecurityTests.testEvilGroovyScripts(GroovySecurityTests.java:87)\n   >    at java.lang.Thread.run(Thread.java:745)\n  2> NOTE: leaving temporary files on disk at: /Users/simon/projects/elasticsearch/plugins/lang-groovy/target/J0/temp/org.elasticsearch.script.groovy.GroovySecurityTests_3257189F4994B662-002\n  2> NOTE: test params are: codec=Lucene53, sim=RandomSimilarityProvider(queryNorm=false,coord=no): {}, locale=it_CH, timezone=America/Belize\n  2> NOTE: Mac OS X 10.11 x86_64/Oracle Corporation 1.8.0_40 (64-bit)/cpus=4,threads=1,free=435997328,total=514850816\n  2> NOTE: All tests run in this JVM: [GroovySecurityTests]\nCompleted [1/1] in 7.51s, 1 test, 1 failure <<< FAILURES!\n```\n\nfor better readability also apply this:\n\n``` diff\ndiff --git a/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java\nindex 93da5ac..8655052 100644\n--- a/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java\n+++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java\n@@ -588,6 +588,10 @@ public abstract class StreamInput extends InputStream {\n                     return (T) readStackTrace(new LockObtainFailedException(readOptionalString(), readThrowable()), this);\n                 case 18:\n                     return (T) readStackTrace(new InterruptedException(readOptionalString()), this);\n+                case 19:\n+                    return (T) readStackTrace(new IllegalAccessException(readOptionalString()), this);\n+                case 20:\n+                    return (T) readStackTrace(new IllegalAccessError(readOptionalString()), this);\n                 default:\n                     assert false : \"no such exception for id: \" + key;\n             }\ndiff --git a/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java b/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java\nindex 71558ff..7d83ce1 100644\n--- a/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java\n+++ b/core/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java\n@@ -562,6 +562,12 @@ public abstract class StreamOutput extends OutputStream {\n             } else if (throwable instanceof InterruptedException) {\n                 writeVInt(18);\n                 writeCause = false;\n+            } else if (throwable instanceof IllegalAccessException) {\n+                writeVInt(19);\n+                writeCause = false;\n+            } else if (throwable instanceof IllegalAccessError) {\n+                writeVInt(20);\n+                writeCause = false;\n             } else {\n                 ElasticsearchException ex;\n                 if (throwable instanceof ElasticsearchException && ElasticsearchException.isRegistered(throwable.getClass())) {\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}