{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50935","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50935/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50935/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50935/events","html_url":"https://github.com/elastic/elasticsearch/issues/50935","id":549141210,"node_id":"MDU6SXNzdWU1NDkxNDEyMTA=","number":50935,"title":"search_as_you_type result score always 1","user":{"login":"dpkirchner","id":165134,"node_id":"MDQ6VXNlcjE2NTEzNA==","avatar_url":"https://avatars1.githubusercontent.com/u/165134?v=4","gravatar_id":"","url":"https://api.github.com/users/dpkirchner","html_url":"https://github.com/dpkirchner","followers_url":"https://api.github.com/users/dpkirchner/followers","following_url":"https://api.github.com/users/dpkirchner/following{/other_user}","gists_url":"https://api.github.com/users/dpkirchner/gists{/gist_id}","starred_url":"https://api.github.com/users/dpkirchner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dpkirchner/subscriptions","organizations_url":"https://api.github.com/users/dpkirchner/orgs","repos_url":"https://api.github.com/users/dpkirchner/repos","events_url":"https://api.github.com/users/dpkirchner/events{/privacy}","received_events_url":"https://api.github.com/users/dpkirchner/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-01-13T19:43:41Z","updated_at":"2020-01-17T23:42:03Z","closed_at":"2020-01-17T21:40:43Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**\r\n\r\n`Version: 7.5.0, Build: default/docker/e9ccaed468e2fac2275a3761849cbee64b39519f/2019-11-26T01:06:52.518245Z, JVM: 13.0.1`\r\n\r\n**Plugins installed**: None (/_cat/plugins returns nothing)\r\n\r\n**JVM version** (`java -version`): \r\n```\r\nopenjdk version \"13.0.1\" 2019-10-15\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13.0.1+9)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13.0.1+9, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n`Linux bce72a9add6b 4.19.76-linuxkit #1 SMP Thu Oct 17 19:31:58 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen you search on a search_as_you_type field, every result has exactly the same score (1.0). I expected the scores to vary based on the quality of the match. The results are not sorted in a useful order, instead they're sorted by the document creation time.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Start Elasticsearch\r\n2. Create an index and mapping with a search_as_you_type field\r\n3. Add documents\r\n4. Search and witness the identical scores\r\n\r\n```\r\n# Start Elasticsearch\r\nrm -rf /tmp/es\r\nmkdir /tmp/es\r\ndocker run --rm -p 9200:9200 -v /tmp/es:/usr/share/elasticsearch/data -e discovery.type=single-node docker.elastic.co/elasticsearch/elasticsearch:7.5.0\r\n\r\n# Open another window, then run this until you get a successful result:\r\ncurl localhost:9200\r\n```\r\n```\r\n# Create the index and mapping\r\ncurl -X PUT -H 'content-type: application/json' -d '{\"mappings\":{\"properties\":{\"title\":{\"type\":\"search_as_you_type\"}}}}' localhost:9200/testo\r\n```\r\n```\r\n# Add documents\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"abc\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"def abc\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"abcdef\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"xyz\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"zzz\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"abc2\"}' 'localhost:9200/testo/_doc?refresh'\r\ncurl -X POST -H 'content-type: application/json' -d '{\"title\":\"ghi jkl abc\"}' 'localhost:9200/testo/_doc?refresh'\r\n```\r\n```\r\n# Run searches\r\ncurl -s -X POST -H 'content-type: application/json' -d '{\"query\":{\"multi_match\":{\"query\":\"ab\", \"type\": \"bool_prefix\", \"fields\": [\"title\",\"title._2gram\",\"title._3gram\"]}}}' localhost:9200/testo/_search | jq -r '.hits.hits[] | \"\\(._score) \\(._source.title)\"'\r\n# Output (note: jq is converting 1.0 to 1, but the score returned by ES is 1.0):\r\n1 abc\r\n1 def abc\r\n1 abcdef\r\n1 abc2\r\n1 ghi jkl abc\r\n```\r\n\r\nYou'll get exactly the same results if you drop the `title._2gram` and `title._3gram` fields from the query. If you drop `title` and just leave the n-gram fields, you get no results. I'm not sure if that's relevant, however, as I'm a newbie when it comes to the n-gram functionality.\r\n\r\nAs a user running a search-as-you-type query, I'd expect to see \"abcdef\" and \"abc2\" before \"def abc\" and \"ghi jkl abc\". It looks like the query is just returning documents in the order they were added. When I add a document with title \"abc def\" I see it at the end of the search results, when I'd expect it to be in the second position, before \"def abc\".\r\n\r\nThis may be an issue on my end, but I haven't found it (yet).","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}