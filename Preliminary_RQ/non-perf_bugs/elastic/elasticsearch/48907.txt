{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48907","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48907/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48907/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48907/events","html_url":"https://github.com/elastic/elasticsearch/issues/48907","id":519507294,"node_id":"MDU6SXNzdWU1MTk1MDcyOTQ=","number":48907,"title":"Unexpected behavior of flattened field with changed ignore_above","user":{"login":"kemics","id":14817537,"node_id":"MDQ6VXNlcjE0ODE3NTM3","avatar_url":"https://avatars2.githubusercontent.com/u/14817537?v=4","gravatar_id":"","url":"https://api.github.com/users/kemics","html_url":"https://github.com/kemics","followers_url":"https://api.github.com/users/kemics/followers","following_url":"https://api.github.com/users/kemics/following{/other_user}","gists_url":"https://api.github.com/users/kemics/gists{/gist_id}","starred_url":"https://api.github.com/users/kemics/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kemics/subscriptions","organizations_url":"https://api.github.com/users/kemics/orgs","repos_url":"https://api.github.com/users/kemics/repos","events_url":"https://api.github.com/users/kemics/events{/privacy}","received_events_url":"https://api.github.com/users/kemics/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"assignees":[{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-11-07T20:55:30Z","updated_at":"2019-11-14T03:57:28Z","closed_at":"2019-11-14T03:57:28Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\ndocker.elastic.co/elasticsearch/elasticsearch:7.4.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\ndocker.elastic.co/elasticsearch/elasticsearch:7.4.2\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\ndocker.elastic.co/elasticsearch/elasticsearch:7.4.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index with flattened field. \r\n\r\n```\r\nPUT /test_index2\r\n{\r\n    \"aliases\": {},\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"f\": {\r\n                \"type\": \"flattened\"\r\n                \r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n2. Change the default value of `ignore_above`\r\n\r\n```\r\nPUT /test_index2/_mapping/\r\n{\r\n        \"properties\": {\r\n            \"f\": {\r\n                        \"type\": \"flattened\",\r\n                        \"ignore_above\": 100\r\n                    }\r\n            }\r\n}\r\n```\r\n\r\n3. Try to add a document that's length is bigger than 32766. I expect that `ignore_above` settings will stop this doc's field to be indexed.\r\n\r\nThis request is attached (because it is too long): [step_3.txt](https://github.com/elastic/elasticsearch/files/3821583/step_3.txt)\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"Document contains at least one immense term in field=\\\"f\\\" (whose UTF8 encoding is longer than the max length 32766), all of which were skipped.  Please correct the analyzer to not produce such terms.  The prefix of the first immense term is: '[49, 50, 51, 52, 53, 54, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 49, 50, 51, 52]...', original message: bytes can be at most 32766 in length; got 63648\"\r\n      }\r\n    ],\r\n    \"type\": \"illegal_argument_exception\",\r\n    \"reason\": \"Document contains at least one immense term in field=\\\"f\\\" (whose UTF8 encoding is longer than the max length 32766), all of which were skipped.  Please correct the analyzer to not produce such terms.  The prefix of the first immense term is: '[49, 50, 51, 52, 53, 54, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 49, 50, 51, 52]...', original message: bytes can be at most 32766 in length; got 63648\",\r\n    \"caused_by\": {\r\n      \"type\": \"max_bytes_length_exceeded_exception\",\r\n      \"reason\": \"bytes can be at most 32766 in length; got 63648\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nSo, I expect that changed `ignore_above` value will make error not happen, but happens. Also, these examples work as expected: \r\n[example_with_keyword.txt](https://github.com/elastic/elasticsearch/files/3821625/example_with_keyword.txt)\r\n[example_with_set_ignore_above.txt](https://github.com/elastic/elasticsearch/files/3821626/example_with_set_ignore_above.txt)\r\n[example_with_smaller_len.txt](https://github.com/elastic/elasticsearch/files/3821634/example_with_smaller_len.txt)\r\n\r\n","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}