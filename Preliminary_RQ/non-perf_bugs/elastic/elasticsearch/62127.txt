{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62127","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62127/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62127/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62127/events","html_url":"https://github.com/elastic/elasticsearch/issues/62127","id":696095506,"node_id":"MDU6SXNzdWU2OTYwOTU1MDY=","number":62127,"title":"Intermittent errors connecting to ES cluster when using High Level Rest client","user":{"login":"jdevilla20","id":45016974,"node_id":"MDQ6VXNlcjQ1MDE2OTc0","avatar_url":"https://avatars2.githubusercontent.com/u/45016974?v=4","gravatar_id":"","url":"https://api.github.com/users/jdevilla20","html_url":"https://github.com/jdevilla20","followers_url":"https://api.github.com/users/jdevilla20/followers","following_url":"https://api.github.com/users/jdevilla20/following{/other_user}","gists_url":"https://api.github.com/users/jdevilla20/gists{/gist_id}","starred_url":"https://api.github.com/users/jdevilla20/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdevilla20/subscriptions","organizations_url":"https://api.github.com/users/jdevilla20/orgs","repos_url":"https://api.github.com/users/jdevilla20/repos","events_url":"https://api.github.com/users/jdevilla20/events{/privacy}","received_events_url":"https://api.github.com/users/jdevilla20/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-09-08T18:42:59Z","updated_at":"2020-09-08T22:09:40Z","closed_at":"2020-09-08T22:09:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n7.6.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nsh-4.2# /usr/share/elasticsearch/jdk/bin/java -version\r\nopenjdk version \"13.0.2\" 2020-01-14\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13.0.2+8)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13.0.2+8, mixed mode, sharing)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux x86_64 x86_64 x86_64 GNU/Linux\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\nI am running a 3 node ES cluster on Kubernetes and performing about 80 upserts per minute.  When connecting via the High Level Rest client, I see intermittent errors (see below).  Other times, the updates work fine.\r\n\r\nWhen I look at my CPU usage, the hot cpu is running at 15% usage.\r\n\r\nI am not sure if the errors are with the cluster or with the Rest client.\r\n\r\n\r\n**Rest Client initialization**:\r\n```\r\n\r\n  private RestHighLevelClient initClient(ElasticSearchStoreConfig config) throws IOException {\r\n      String password = \"foobar\";\r\n\r\n      final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\r\n      credentialsProvider.setCredentials(AuthScope.ANY,\r\n          new UsernamePasswordCredentials(config.getUserName(), password));\r\n\r\n      RestClientBuilder builder = RestClient.builder(new HttpHost(config.getHostname(),\r\n          config.getPort(), config.getElasticSearchScheme()))\r\n          .setHttpClientConfigCallback(httpClientBuilder ->\r\n              httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider));\r\n\r\n      return new RestHighLevelClient(builder);\r\n    \r\n  }\r\n\r\n```\r\n\r\nI am running the update as follows (there is a retry policy): \r\n```\r\n      UpdateRequest updateRequest = mapper.update(key, data);\r\n      UpdateResponse response = esClient.update(updateRequest, RequestOptions.DEFAULT);\r\n```\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[DEBUG] 2020-09-02 17:57:49.351 [pool-7-thread-1] PoolingNHttpClientConnectionManager: - Connection request failed\r\njava.net.ConnectException: Connection refused\r\n\tat sun.nio.ch.Net.pollConnect(Native Method) ~[?:?]\r\n\tat sun.nio.ch.Net.pollConnectNow(Net.java:579) ~[?:?]\r\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:820) ~[?:?]\r\n\tat org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvent(DefaultConnectingIOReactor.java:174) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvents(DefaultConnectingIOReactor.java:148) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor.execute(AbstractMultiworkerIOReactor.java:351) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager.execute(PoolingNHttpClientConnectionManager.java:221) ~[httpasyncclient-4.1.4.jar!/:4.1.4]\r\n\tat org.apache.http.impl.nio.client.CloseableHttpAsyncClientBase$1.run(CloseableHttpAsyncClientBase.java:64) ~[httpasyncclient-4.1.4.jar!/:4.1.4]\r\n\tat java.lang.Thread.run(Thread.java:830) [?:?]\r\n[DEBUG] 2020-09-02 17:57:49.351 [pool-7-thread-1] InternalHttpAsyncClient: - [exchange: 801] connection request failed\r\n[DEBUG] 2020-09-02 17:57:49.351 [BeaconProcessor] RestClient: - request [POST http://ingestion-es-http:9200/recordmetadata-fei/_update/1599066000000-1599069600000:testapp:ingestiontenant3:firewall.traffic?retry_on_conflict=5&timeout=1m] failed\r\njava.util.concurrent.ExecutionException: java.net.ConnectException: Connection refused\r\n\tat org.apache.http.concurrent.BasicFuture.getResult(BasicFuture.java:71) ~[httpcore-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.concurrent.BasicFuture.get(BasicFuture.java:84) ~[httpcore-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.client.FutureWrapper.get(FutureWrapper.java:70) ~[httpasyncclient-4.1.4.jar!/:4.1.4]\r\n\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:244) ~[elasticsearch-rest-client-7.7.0.jar!/:7.7.0]\r\n\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:235) ~[elasticsearch-rest-client-7.7.0.jar!/:7.7.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1609) ~[elasticsearch-rest-high-level-client-7.7.0.jar!/:7.7.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1579) ~[elasticsearch-rest-high-level-client-7.7.0.jar!/:7.7.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1549) ~[elasticsearch-rest-high-level-client-7.7.0.jar!/:7.7.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.update(RestHighLevelClient.java:1016) ~[elasticsearch-rest-high-level-client-7.7.0.jar!/:7.7.0]\r\n\tat com.paloaltonetworks.cortex.ingestion.beacon.store.es.ElasticSearchStore.update(ElasticSearchStore.java:182) ~[ingest-common-2.0.0.jar!/:?]\r\n\tat com.paloaltonetworks.cortex.ingestion.beacon.store.es.ElasticSearchStore.update(ElasticSearchStore.java:36) ~[ingest-common-2.0.0.jar!/:?]\r\n\tat com.paloaltonetworks.cortex.ingestion.frontend.beacon.ElasticSearchRecordBeaconWriter.write(ElasticSearchRecordBeaconWriter.java:58) ~[classes!/:?]\r\n\tat com.paloaltonetworks.cortex.ingestion.frontend.beacon.ElasticSearchRecordBeaconWriter.write(ElasticSearchRecordBeaconWriter.java:19) ~[classes!/:?]\r\n\tat com.paloaltonetworks.cortex.ingestion.beacon.BeaconWriter.run(BeaconWriter.java:65) ~[ingest-common-2.0.0.jar!/:?]\r\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) ~[?:?]\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:830) [?:?]\r\nCaused by: java.net.ConnectException: Connection refused\r\n\tat sun.nio.ch.Net.pollConnect(Native Method) ~[?:?]\r\n\tat sun.nio.ch.Net.pollConnectNow(Net.java:579) ~[?:?]\r\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:820) ~[?:?]\r\n\tat org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvent(DefaultConnectingIOReactor.java:174) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.reactor.DefaultConnectingIOReactor.processEvents(DefaultConnectingIOReactor.java:148) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor.execute(AbstractMultiworkerIOReactor.java:351) ~[httpcore-nio-4.4.12.jar!/:4.4.12]\r\n\tat org.apache.http.impl.nio.conn.PoolingNHttpClientConnectionManager.execute(PoolingNHttpClientConnectionManager.java:221) ~[httpasyncclient-4.1.4.jar!/:4.1.4]\r\n\tat org.apache.http.impl.nio.client.CloseableHttpAsyncClientBase$1.run(CloseableHttpAsyncClientBase.java:64) ~[httpasyncclient-4.1.4.jar!/:4.1.4]\r\n\t... 1 more\r\n[DEBUG] 2020-09-02 17:57:49.351 [BeaconProcessor] RestClient: - updated [[host=http://ingestion-es-http:9200]] already in blacklist\r\n```\r\n\r\n","closed_by":{"login":"cjcenizal","id":1238659,"node_id":"MDQ6VXNlcjEyMzg2NTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1238659?v=4","gravatar_id":"","url":"https://api.github.com/users/cjcenizal","html_url":"https://github.com/cjcenizal","followers_url":"https://api.github.com/users/cjcenizal/followers","following_url":"https://api.github.com/users/cjcenizal/following{/other_user}","gists_url":"https://api.github.com/users/cjcenizal/gists{/gist_id}","starred_url":"https://api.github.com/users/cjcenizal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cjcenizal/subscriptions","organizations_url":"https://api.github.com/users/cjcenizal/orgs","repos_url":"https://api.github.com/users/cjcenizal/repos","events_url":"https://api.github.com/users/cjcenizal/events{/privacy}","received_events_url":"https://api.github.com/users/cjcenizal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}