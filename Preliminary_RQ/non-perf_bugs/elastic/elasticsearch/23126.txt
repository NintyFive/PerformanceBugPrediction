{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23126","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23126/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23126/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23126/events","html_url":"https://github.com/elastic/elasticsearch/issues/23126","id":206948214,"node_id":"MDU6SXNzdWUyMDY5NDgyMTQ=","number":23126,"title":"2.3 --> 5.1 Migration : ip type field doesn't work for 2.3 migrated indexes and ipv6 data","user":{"login":"r39132","id":581734,"node_id":"MDQ6VXNlcjU4MTczNA==","avatar_url":"https://avatars1.githubusercontent.com/u/581734?v=4","gravatar_id":"","url":"https://api.github.com/users/r39132","html_url":"https://github.com/r39132","followers_url":"https://api.github.com/users/r39132/followers","following_url":"https://api.github.com/users/r39132/following{/other_user}","gists_url":"https://api.github.com/users/r39132/gists{/gist_id}","starred_url":"https://api.github.com/users/r39132/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/r39132/subscriptions","organizations_url":"https://api.github.com/users/r39132/orgs","repos_url":"https://api.github.com/users/r39132/repos","events_url":"https://api.github.com/users/r39132/events{/privacy}","received_events_url":"https://api.github.com/users/r39132/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-02-11T01:51:56Z","updated_at":"2017-02-13T19:17:35Z","closed_at":"2017-02-12T12:11:58Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.1 (AWS hosted ES)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.7\r\n\r\n**OS version**: N/A\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI migrated from 2.3 to 5.1 following the steps listed [here](http://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-version-migration.html). \r\n\r\nEssentially, I did this by snapshotting the 2.3 indexes to S3 and then restoring them to the 5.1 cluster. All seemed fine until I added an `ip` type field to my indexes, which consisted of some indexes ported from 2.3 and some created anew on the 5.1 cluster. FYI, my indexes are day-wise (e.g. message_20170101, message_20170102, message_20170103 ). \r\n\r\nWhen I tried to insert an ipv6 value in to the fields in the new indexes, all worked fine. However, when I tried to insert the same value in the 2.3-migrated indexes, I got an exception `failed to parse ip [2607:f8b0:400e:c00::22b], not a valid ipv4 address (4 dots)`.\r\n\r\nHere's an example mapping for one of the 2.3-migrated indexes that did not work. The 2.3 index contained 4 fields : `color, make, sold, and price`. After restoring the index on 5.1 and after adding the `my_ip` field, the mapping looks as shown below:\r\n\r\n```\r\ndeploy@es-proxy-00:~$ curl -XGET 'localhost:80/cars/transactions/_mapping'\r\n{\r\n  \"cars\": {\r\n    \"mappings\": {\r\n      \"transactions\": {\r\n        \"properties\": {\r\n          \"color\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"make\": {\r\n            \"type\": \"string\"\r\n          },\r\n          \"my_ip\": {\r\n            \"type\": \"ip\"\r\n          },\r\n          \"price\": {\r\n            \"type\": \"long\"\r\n          },\r\n          \"sold\": {\r\n            \"type\": \"date\",\r\n            \"format\": \"strict_date_optional_time||epoch_millis\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nHere's what happened when I tried to insert an ipv6 value into that field into one of the docs.\r\n\r\n```\r\ndeploy@es-proxy-00:~$ cat test_ip_a.sh \r\ncurl -XPOST \"localhost:80/cars/transactions/AVlxOqfz-i1bJQCCyerj\" -d'\r\n{\r\n      \"my_ip\": \"2607:f8b0:400e:c00::22b\"\r\n}'\r\n\r\ndeploy@es-proxy-00:~$ ./test_ip_a.sh \r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse [my_ip]\"\r\n      }\r\n    ],\r\n    \"type\": \"mapper_parsing_exception\",\r\n    \"reason\": \"failed to parse [my_ip]\",\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_argument_exception\",\r\n      \"reason\": \"failed to parse ip [2607:f8b0:400e:c00::22b], not a valid ipv4 address (4 dots)\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n**Steps to reproduce**:\r\n 1. Migrate from 2.3 to 5.1 : snapshot 2.3 to S3 and restore from S3 to the 5.1 cluster\r\n 2. Create a new index on 5.1 -- call it new-foo\r\n 3. Add an ip field to new-foo and the 2.3 migrated indexes\r\n 4. Insert an ipv6 field value (`e.g. 2607:f8b0:400e:c00::22b`) into all of these indexes\r\n 5. It will fail for the 2.3-migrated indexes and work for the new-foo index\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nN/A\r\n\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\n**Describe the feature**:\r\n\r\nN/A","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}