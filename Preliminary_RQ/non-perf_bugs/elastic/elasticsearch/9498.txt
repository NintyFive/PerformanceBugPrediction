{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9498","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9498/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9498/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9498/events","html_url":"https://github.com/elastic/elasticsearch/issues/9498","id":56015947,"node_id":"MDU6SXNzdWU1NjAxNTk0Nw==","number":9498,"title":"[STORE] Move to one datapath per shard","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null},{"id":108108556,"node_id":"MDU6TGFiZWwxMDgxMDg1NTY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/release%20highlight","name":"release highlight","color":"fbca04","default":false,"description":null},{"id":111053151,"node_id":"MDU6TGFiZWwxMTEwNTMxNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/resiliency","name":"resiliency","color":"009800","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-01-30T10:16:17Z","updated_at":"2018-02-13T20:36:03Z","closed_at":"2015-04-20T15:26:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Today Elasticsearch has the ability to utilize multiple datapaths\nwhich is useful to spread load across several disks throughput and space wise.\nYet, the way it is utilized is problematic since it's similar to a stripe raid where\neach shard gets a dedicated directory on each of the data paths / disks. This method has several\nproblems:\n- if one data_path is lost all shards on the node are lost since files are spread across disk\n- segment files that are logically belong together are spread across disks where performance implications are unknown.\n- some files historically where not write once such that updates to these files needed to always go to the same directory\n- corruptions due to a lost disk might be detected very late if those files are already loaded into memory\n- listing contents of a shard is not trivial since multiple FS directries are involved\n- code is more complicated since we need to wrap lucenes directory abstraction to make this work.\n- if a user misconfigures a node all shard data is lost ie. due to reordering of the paths\n\nThis issues aims to move away from this shard striping towards a datapath per shard such that all\nfiles for a Elasticsearch Shard (lucene index) are on the same directory and no special code is needed.\n\nThis requires some changes how we balance disk utilization, today we pick the directories when a file\nneeds to be written, now we need to select the directory ahead of time. While this seems to be trivial\nsince we can just pick the least utilized disk we need to take the expected size of the shard into account\nand see if we can allocate this shard on a certain node at all. This can have implication on how we do this\nsince data-paths space is accumulated for this decision.\n\nRather less trivial is the migration path for this, we need to move from multiple directories to a single directory\nlikely in the background such that the upgrade process for users is smooth. There are several options:\n- upgrade on shard allocation, copy all the data into the new dedicated directory when the shard is allocated. This makes the selection of the dedicated directory simpler since we do one shard a time but might be a pretty slow process for the upgrade.\n- upgrade over time, select a dedicated directory on shard allocation and redirect all writes to this directory. Merges or recoveries will then automatically use the dedicated directory and an upgrade can be triggered via a merge or the upgrade API. The biggest issue is that we need to keep the distributor directory around which is way simpler now but it would be nice to drop it. Also picking the dedicated shard dir might be harder since we don't really know how disks will fill up over time.\n- don't upgrade and only move new indices to the per-shard path\n- use and upgrade tool that must run pre-node startup\n\nHowever, I think the code changes can we done in two steps:\n- remove the old strip raid behavior for new indices\n- upgrade old indices\n\nsince the latter is much harder.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}