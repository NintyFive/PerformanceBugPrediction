{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38105","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38105/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38105/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38105/events","html_url":"https://github.com/elastic/elasticsearch/issues/38105","id":405310431,"node_id":"MDU6SXNzdWU0MDUzMTA0MzE=","number":38105,"title":"Painless TZ conversion is adding a year.","user":{"login":"ThisUsedToBeAnEmail","id":16151791,"node_id":"MDQ6VXNlcjE2MTUxNzkx","avatar_url":"https://avatars1.githubusercontent.com/u/16151791?v=4","gravatar_id":"","url":"https://api.github.com/users/ThisUsedToBeAnEmail","html_url":"https://github.com/ThisUsedToBeAnEmail","followers_url":"https://api.github.com/users/ThisUsedToBeAnEmail/followers","following_url":"https://api.github.com/users/ThisUsedToBeAnEmail/following{/other_user}","gists_url":"https://api.github.com/users/ThisUsedToBeAnEmail/gists{/gist_id}","starred_url":"https://api.github.com/users/ThisUsedToBeAnEmail/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ThisUsedToBeAnEmail/subscriptions","organizations_url":"https://api.github.com/users/ThisUsedToBeAnEmail/orgs","repos_url":"https://api.github.com/users/ThisUsedToBeAnEmail/repos","events_url":"https://api.github.com/users/ThisUsedToBeAnEmail/events{/privacy}","received_events_url":"https://api.github.com/users/ThisUsedToBeAnEmail/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-01-31T15:51:57Z","updated_at":"2019-05-03T14:53:26Z","closed_at":"2019-05-03T14:53:26Z","author_association":"NONE","active_lock_reason":null,"body":"The following painless \"script_field\" will convert the existing date stored in UTC into the passed TZ in this case for Sydney '+11:00'. \r\n\r\n```\r\n\"script_fields\": {\r\n\t\"date\": {\r\n\t\t\"script\": {\r\n\t\t\t\"params\": {\r\n\t\t\t\t\"tz\": \"+11:00\"\r\n\t\t\t},\r\n\t\t\t\"source\": \"Instant.ofEpochMilli(doc.date.date.millis).atZone(ZoneId.of(params.tz)).format(DateTimeFormatter.ofPattern(\\'YYYY-MM-dd HH:mm:ss\\'))\",\r\n\t\t\t\"lang\":\"painless\"\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nIt seems to work and I have not had a problem until recently. The bug  exists for dates that are between 2018-12-30->2018-12-31 where it is \"adding\" a year during TZ conversion. For example converting \"2018-12-31T04:20:24Z\" into \"2019-12-31 15:20:24\".\r\n\r\nThe following is a full example extending the synopsis of Search::Elasticsearch.pm.\r\n\r\n```\r\nuse Data::Dumper;\r\nuse Search::Elasticsearch;\r\n\r\nmy $e = Search::Elasticsearch->new(\r\n\tnodes => $env->find('es')\r\n);\r\n\r\n$e->index(\r\n\tindex   => 'my_app',\r\n\ttype    => 'blog_post',\r\n\tid      => 1,\r\n\tbody    => {\r\n\t\ttitle   => 'Elasticsearch clients',\r\n\t\tcontent => 'Interesting content...',\r\n\t\tdate    => '2018-12-31T04:20:24Z',\r\n\t}\r\n);\r\n\r\nmy $results = $e->search(\r\n\tindex => 'my_app',\r\n\tbody  => {\r\n\t\t_source => \\1,\r\n\t\tquery => {\r\n\t\t\tmatch => { title => 'elasticsearch' }\r\n\t\t},\r\n\t\t'script_fields' => {\r\n\t\t\t'epoch' => {\r\n\t\t\t\t'script' => {\r\n\t\t\t\t\t'source' => 'Instant.ofEpochMilli(doc.date.date.millis).toEpochMilli()',\r\n\t\t\t\t\t'lang' => 'painless'\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t'date' => {\r\n\t\t\t\t'script' => {\r\n\t\t\t\t\t'params' => {\r\n\t\t\t\t\t\t'tz' => '+11:00'\r\n\t\t\t\t\t},\r\n\t\t\t\t\t'source' => 'Instant.ofEpochMilli(doc.date.date.millis).atZone(ZoneId.of(params.tz)).format(DateTimeFormatter.ofPattern(\\'YYYY-MM-dd HH:mm:ss\\'))',\r\n\t\t\t\t\t'lang' => 'painless'\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t}\r\n);\r\n\r\nwarn Dumper $results;\r\n=pod\r\n      {\r\n          'hits' => {\r\n                      'hits' => [\r\n                                  {\r\n                                    '_source' => {\r\n                                                   'date' => '2018-12-31T04:20:24Z',\r\n                                                   'content' => 'Interesting content...',\r\n                                                   'title' => 'Elasticsearch clients'\r\n                                                 },\r\n                                    '_score' => '0.2876821',\r\n                                    'fields' => {\r\n                                                  'epoch' => [\r\n                                                               '1546230024000'\r\n                                                             ],\r\n                                                  'date' => [\r\n                                                              '2019-12-31 15:20:24'\r\n                                                            ]\r\n                                                },\r\n                                    '_index' => 'my_app',\r\n                                    '_id' => '1',\r\n                                    '_type' => 'blog_post'\r\n                                  }\r\n                                ],\r\n                      'max_score' => '0.2876821',\r\n                      'total' => 1\r\n                    },\r\n          'timed_out' => bless( do{\\(my $o = 0)}, 'JSON::PP::Boolean' ),\r\n          '_shards' => {\r\n                         'failed' => 0,\r\n                         'successful' => 5,\r\n                         'total' => 5,\r\n                         'skipped' => 0\r\n                       },\r\n          'took' => 3\r\n        };\r\n=cut\r\n\r\n```","closed_by":{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false},"performed_via_github_app":null}