{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18566","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18566/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18566/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18566/events","html_url":"https://github.com/elastic/elasticsearch/issues/18566","id":156683411,"node_id":"MDU6SXNzdWUxNTY2ODM0MTE=","number":18566,"title":"Groovy script throws java.lang.NoClassDefFoundError: org/codehaus/groovy/runtime/wrappers/Wrapper","user":{"login":"consulthys","id":1280019,"node_id":"MDQ6VXNlcjEyODAwMTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1280019?v=4","gravatar_id":"","url":"https://api.github.com/users/consulthys","html_url":"https://github.com/consulthys","followers_url":"https://api.github.com/users/consulthys/followers","following_url":"https://api.github.com/users/consulthys/following{/other_user}","gists_url":"https://api.github.com/users/consulthys/gists{/gist_id}","starred_url":"https://api.github.com/users/consulthys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/consulthys/subscriptions","organizations_url":"https://api.github.com/users/consulthys/orgs","repos_url":"https://api.github.com/users/consulthys/repos","events_url":"https://api.github.com/users/consulthys/events{/privacy}","received_events_url":"https://api.github.com/users/consulthys/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-05-25T07:43:15Z","updated_at":"2016-08-11T13:07:36Z","closed_at":"2016-05-25T11:48:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"On my ES cluster running the latest 2.3.3 release (with groovy scripting enabled), I get the following error...\n\n```\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"script_exception\",\n        \"reason\": \"failed to run inline script [def rparts = ctx._source.myDate.split('T'); def rtime = rparts[1].split(':'); ctx._source.myMinute = ((rtime[0] as int) * 60) + (rtime[1] as int)] using lang [groovy]\"\n      }\n    ],\n    \"type\": \"script_exception\",\n    \"reason\": \"failed to run inline script [def rparts = ctx._source.myDate.split('T'); def rtime = rparts[1].split(':'); ctx._source.myMinute = ((rtime[0] as int) * 60) + (rtime[1] as int)] using lang [groovy]\",\n    \"caused_by\": {\n      \"type\": \"bootstrap_method_error\",\n      \"reason\": \"java.lang.NoClassDefFoundError: org/codehaus/groovy/runtime/wrappers/Wrapper\",\n      \"caused_by\": {\n        \"type\": \"no_class_def_found_error\",\n        \"reason\": \"org/codehaus/groovy/runtime/wrappers/Wrapper\",\n        \"caused_by\": {\n          \"type\": \"class_not_found_exception\",\n          \"reason\": \"org.codehaus.groovy.runtime.wrappers.Wrapper\"\n        }\n      }\n    }\n  },\n  \"status\": 500\n}\n```\n\n...when I execute the following update-by-query\n\n```\nPOST my-index/_update_by_query\n{\n  \"script\": {\n    \"inline\": \"def rparts = ctx._source.myDate.split('T'); def rtime = rparts[1].split(':'); ctx._source.myMinute = ((rtime[0] as int) * 60) + (rtime[1] as int)\"\n  },\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"missing\": {\n          \"field\": \"myMinute\"\n        }\n      }\n    }\n  }\n}\n```\n\nIt is worth noting that if I add the following class permission to the grants of the `/modules/lang-groovy/plugin-security.policy` file and restart my cluster, the script executes fine.\n\n`permission org.elasticsearch.script.ClassPermission \"org.codehaus.groovy.runtime.wrappers.Wrapper\";`\n\nIt is very similar to what's been reported [here](https://github.com/docker-library/elasticsearch/issues/90) and to some extent [this issue](https://github.com/elastic/elasticsearch/issues/16657).\n","closed_by":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"performed_via_github_app":null}