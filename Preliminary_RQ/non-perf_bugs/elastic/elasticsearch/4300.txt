{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4300","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4300/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4300/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4300/events","html_url":"https://github.com/elastic/elasticsearch/issues/4300","id":23487649,"node_id":"MDU6SXNzdWUyMzQ4NzY0OQ==","number":4300,"title":"External versioning does not persist versions of deletes","user":{"login":"tstibbs","id":4869014,"node_id":"MDQ6VXNlcjQ4NjkwMTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/4869014?v=4","gravatar_id":"","url":"https://api.github.com/users/tstibbs","html_url":"https://github.com/tstibbs","followers_url":"https://api.github.com/users/tstibbs/followers","following_url":"https://api.github.com/users/tstibbs/following{/other_user}","gists_url":"https://api.github.com/users/tstibbs/gists{/gist_id}","starred_url":"https://api.github.com/users/tstibbs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tstibbs/subscriptions","organizations_url":"https://api.github.com/users/tstibbs/orgs","repos_url":"https://api.github.com/users/tstibbs/repos","events_url":"https://api.github.com/users/tstibbs/events{/privacy}","received_events_url":"https://api.github.com/users/tstibbs/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2013-11-29T11:32:26Z","updated_at":"2014-08-08T18:53:42Z","closed_at":"2014-08-08T18:53:42Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Elasticsearch only keeps a record of the version of deletes for a short time (the 'index.gc_deletes' setting, default 60s). I think this can cause issues if you restart a cluster, as the record of deletes will have been lost during the restart. I'm using external versioning.\n\nIt’s easy to try out:\n1. Create an index with the default of 1 replica per primary shard, spread across two nodes, then shutdown both nodes.\n2. Start node 1.\n3. Send a document with external version 1.\n4. Shutdown node 1.\n5. Startup node 2.\n6. Startup node 1.\n\nIn step 5 node 2 becomes the master, so when node 1 starts in step 6, node 1 removes the document you’ve just sent to it, because the master didn’t have it. If elasticsearch kept records of deletes, it would have known that the reason it didn’t exist on node 2 was because it hasn’t received it yet (it wouldn't have an entry in its 'deletes cache', so would know that it hadn't deleted it).\n\nAnd there’s a variation on the above which enables a delete to be ‘undone’, despite the fact that the version of the delete is greater than the version of the insert.\n\nSo, because it doesn't keep a persistent record of the deletes, when resolving differences between nodes it doesn’t know if a node simply hasn’t received an update yet, or if it has actually deleted it since the most recent update.\nMy feeling is that this is wrong. If two nodes disagree about whether a document should exist or not, then I feel like the versioning system should be used, rather than using the master as the version of truth. \n\nOne the face of it it seems like a fairly simple change - persist the contents of RobinEngine.versionMap to disk (another lucene index?), and read the contents of this into memory on startup. There's clearly performance issues though if we write/delete a record to some kind of disk store every time a document is index.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}