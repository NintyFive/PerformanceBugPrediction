{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23615","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23615/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23615/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23615/events","html_url":"https://github.com/elastic/elasticsearch/issues/23615","id":214785064,"node_id":"MDU6SXNzdWUyMTQ3ODUwNjQ=","number":23615,"title":"Killing the elected master causes all other nodes in cluster to immediately exit","user":{"login":"loren","id":42840,"node_id":"MDQ6VXNlcjQyODQw","avatar_url":"https://avatars2.githubusercontent.com/u/42840?v=4","gravatar_id":"","url":"https://api.github.com/users/loren","html_url":"https://github.com/loren","followers_url":"https://api.github.com/users/loren/followers","following_url":"https://api.github.com/users/loren/following{/other_user}","gists_url":"https://api.github.com/users/loren/gists{/gist_id}","starred_url":"https://api.github.com/users/loren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/loren/subscriptions","organizations_url":"https://api.github.com/users/loren/orgs","repos_url":"https://api.github.com/users/loren/repos","events_url":"https://api.github.com/users/loren/events{/privacy}","received_events_url":"https://api.github.com/users/loren/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-16T17:42:38Z","updated_at":"2017-03-16T20:07:59Z","closed_at":"2017-03-16T20:07:59Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.2.2\r\n\r\n**Plugins installed**: [x-pack]\r\n\r\n**JVM version**: 8u121\r\n\r\n**OS version**: CentOS Linux release 7.3.1611 (Core)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nFrom https://discuss.elastic.co/t/problem-with-master-re-election-under-zendiscovery-5-2-2/78617:\r\nKilling the elected master elasticsearch process causes all other nodes to throw an exception and immediately exit. I expected a master re-election to take place instead.\r\n\r\nI do **not** see this behavior in 5.2.0, so it seems to be a regression.\r\n\r\n**Steps to reproduce**:\r\nI have 7 elasticsearch nodes distributed around 5 EC2 instances running CentOS. The 7 nodes are composed of 3 master-only nodes, 2 data-only, 1 ingest-only, and 1 coordinator-only. X-pack is installed.\r\n\r\nThe general `elasticsearch.yml` template looks like this:\r\n```yml\r\ndiscovery.zen.ping.unicast.hosts:\r\n  - \"master-0-node.{{FRAMEWORK_NAME}}.mesos:{{MASTER_NODE_TRANSPORT_PORT}}\"\r\n  - \"master-1-node.{{FRAMEWORK_NAME}}.mesos:{{MASTER_NODE_TRANSPORT_PORT}}\"\r\n  - \"master-2-node.{{FRAMEWORK_NAME}}.mesos:{{MASTER_NODE_TRANSPORT_PORT}}\"\r\ndiscovery.zen.minimum_master_nodes: 2\r\nnetwork.host:\r\n  - \"_site_\"\r\n  - \"_local_\"\r\ncluster.name: {{FRAMEWORK_NAME}}\r\nnode.name: {{TASK_NAME}}\r\npath.data: \"container-path/data\"\r\npath.logs: \"container-path/logs\"\r\nhttp.port: {{PORT_HTTP}}\r\ntransport.tcp.port: {{PORT_TRANSPORT}}\r\nbootstrap.memory_lock: false\r\nnode.master: {{MASTER_ENABLED}}\r\nnode.data: {{DATA_ENABLED}}\r\nnode.ingest: {{INGEST_ENABLED}}\r\nmetrics.statsd.host: {{STATSD_UDP_HOST}}\r\nmetrics.statsd.port: {{STATSD_UDP_PORT}}\r\n```\r\nIt then gets interpolated for each node based on those env vars.\r\n\r\n1. `kill -9` elasticsearch process of elected master\r\n2. watch entire cluster shut down\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2017-03-14T22:45:10,208][INFO ][o.e.d.z.ZenDiscovery ] [master-1-node] master_left [{master-0-node}{SzqZbCT_SfGjukio5cYrBg}{v58Bm3MKR4-Ucf1cEmBkmw}{10.0.1.79}{10.0.1.79:9300}], reason [transport disconnected]\r\n[2017-03-14T22:45:10,210][WARN ][o.e.d.z.ZenDiscovery ] [master-1-node] master left (reason = transport disconnected), current nodes: nodes: \r\n{master-1-node}{DL_sqiHoRg2bLCiD9tWh-w}{Ty-AlN5cRTWEBObmCJ9Z3g}{10.0.1.87}{10.0.1.87:9300}, local\r\n{ingest-0-node}{tsGRRLHWSG6DOZ-b9A-wRg}{XXhtyKeLS9W4x6HmpNxitw}{10.0.2.99}{10.0.2.99:1028}\r\n{data-0-node}{szxoWgObSaS8gE4BaSn5nw}{vC1s4MiXQPa9d2CEsyrLCg}{10.0.1.227}{10.0.1.227:1026}\r\n{coordinator-0-node}{OxleJ2AcRlib9I18Vm1mOw}{DmUC-IUCTDW8GULDHYxbfQ}{10.0.1.227}{10.0.1.227:1028}\r\n{master-0-node}{SzqZbCT_SfGjukio5cYrBg}{v58Bm3MKR4-Ucf1cEmBkmw}{10.0.1.79}{10.0.1.79:9300}, master\r\n{master-2-node}{wr9bqzZ4SeeJflwtE88hSA}{7rCvWpSLSuOdIk6nohbGuw}{10.0.1.190}{10.0.1.190:9300}\r\n{data-1-node}{WVL4cVOlTFesySvUv2gR0g}{jG105Vj9Rl6J5C-qFE19dw}{10.0.2.99}{10.0.2.99:1026}\r\n\r\n[2017-03-14T22:45:10,226][WARN ][o.e.c.NodeConnectionsService] [master-1-node] failed to connect to node {master-0-node}{SzqZbCT_SfGjukio5cYrBg}{v58Bm3MKR4-Ucf1cEmBkmw}{10.0.1.79}{10.0.1.79:9300} (tried [1] times)\r\norg.elasticsearch.transport.ConnectTransportException: [master-0-node][10.0.1.79:9300] connect_timeout[30s]\r\nat org.elasticsearch.transport.netty4.Netty4Transport.connectToChannels(Netty4Transport.java:370) ~[?:?]\r\nat org.elasticsearch.transport.TcpTransport.openConnection(TcpTransport.java:495) ~[elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.transport.TcpTransport.connectToNode(TcpTransport.java:460) ~[elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:318) ~[elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:305) ~[elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.cluster.NodeConnectionsService.validateNodeConnected(NodeConnectionsService.java:121) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.cluster.NodeConnectionsService.connectToNodes(NodeConnectionsService.java:87) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:775) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:628) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:1112) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:527) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:238) [elasticsearch-5.2.2.jar:5.2.2]\r\nat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:201) [elasticsearch-5.2.2.jar:5.2.2]\r\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_112]\r\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_112]\r\nat java.lang.Thread.run(Thread.java:745) [?:1.8.0_112]\r\nCaused by: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: 10.0.1.79/10.0.1.79:9300\r\nat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[?:?]\r\nat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717) ~[?:?]\r\nat io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:346) ~[?:?]\r\nat io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:340) ~[?:?]\r\nat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:630) ~[?:?]\r\nat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:527) ~[?:?]\r\nat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:481) ~[?:?]\r\nat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:441) ~[?:?]\r\nat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) ~[?:?]\r\n... 1 more\r\n[2017-03-14T22:45:10,349][INFO ][o.e.n.Node ] [master-1-node] stopping ...\r\n```\r\n\r\nSeems like when Netty complains about \"Connection refused\", it's fatal. ","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}