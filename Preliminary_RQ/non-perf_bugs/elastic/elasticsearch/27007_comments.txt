[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/336465555","html_url":"https://github.com/elastic/elasticsearch/issues/27007#issuecomment-336465555","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27007","id":336465555,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjQ2NTU1NQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-10-13T14:16:48Z","updated_at":"2017-10-13T14:16:48Z","author_association":"MEMBER","body":"These state files are written atomically. That is, when we are going to write a new state file out to disk, we first write the new state file to temporary file, then we fsync the file to disk, then we atomically move the temporary file into its permanent location (the underlying filesystem must support atomic move, there is no fallback here), then we fsync the directory to disk. Seeing a zero-length state file means the file was modified by external force. Failing startup is the right behavior here, we should not leniently allow external forces to modify files on disk, this needs to be forcefully brought to your attention so that you can address the root problem, it requires manual intervention to recover from.\r\n\r\n> I think ES must just ignore/drop that files and reread indexes\r\n\r\nWe simply abhor leniency of this form. If these files are modified by external force, corrupted on disk, etc. it needs to be brought to your attention. Lines in a log file are not enough.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/336469047","html_url":"https://github.com/elastic/elasticsearch/issues/27007#issuecomment-336469047","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27007","id":336469047,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjQ2OTA0Nw==","user":{"login":"Nefelim4ag","id":3943460,"node_id":"MDQ6VXNlcjM5NDM0NjA=","avatar_url":"https://avatars1.githubusercontent.com/u/3943460?v=4","gravatar_id":"","url":"https://api.github.com/users/Nefelim4ag","html_url":"https://github.com/Nefelim4ag","followers_url":"https://api.github.com/users/Nefelim4ag/followers","following_url":"https://api.github.com/users/Nefelim4ag/following{/other_user}","gists_url":"https://api.github.com/users/Nefelim4ag/gists{/gist_id}","starred_url":"https://api.github.com/users/Nefelim4ag/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nefelim4ag/subscriptions","organizations_url":"https://api.github.com/users/Nefelim4ag/orgs","repos_url":"https://api.github.com/users/Nefelim4ag/repos","events_url":"https://api.github.com/users/Nefelim4ag/events{/privacy}","received_events_url":"https://api.github.com/users/Nefelim4ag/received_events","type":"User","site_admin":false},"created_at":"2017-10-13T14:28:20Z","updated_at":"2017-10-13T14:28:20Z","author_association":"NONE","body":"@jasontedor , thanks for explain! :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/336470356","html_url":"https://github.com/elastic/elasticsearch/issues/27007#issuecomment-336470356","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27007","id":336470356,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjQ3MDM1Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-10-13T14:32:59Z","updated_at":"2017-10-13T14:32:59Z","author_association":"MEMBER","body":"@Nefelim4ag You're most welcome.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/337422137","html_url":"https://github.com/elastic/elasticsearch/issues/27007#issuecomment-337422137","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27007","id":337422137,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNzQyMjEzNw==","user":{"login":"grantholly","id":8484353,"node_id":"MDQ6VXNlcjg0ODQzNTM=","avatar_url":"https://avatars0.githubusercontent.com/u/8484353?v=4","gravatar_id":"","url":"https://api.github.com/users/grantholly","html_url":"https://github.com/grantholly","followers_url":"https://api.github.com/users/grantholly/followers","following_url":"https://api.github.com/users/grantholly/following{/other_user}","gists_url":"https://api.github.com/users/grantholly/gists{/gist_id}","starred_url":"https://api.github.com/users/grantholly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/grantholly/subscriptions","organizations_url":"https://api.github.com/users/grantholly/orgs","repos_url":"https://api.github.com/users/grantholly/repos","events_url":"https://api.github.com/users/grantholly/events{/privacy}","received_events_url":"https://api.github.com/users/grantholly/received_events","type":"User","site_admin":false},"created_at":"2017-10-18T00:34:55Z","updated_at":"2017-10-18T00:34:55Z","author_association":"NONE","body":"I'm having a similar issue:\r\n\r\n`\r\nES 5.6.0\r\njava version \"1.8.0_131\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_131-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)\r\nCentOS Release 7.3\r\n`\r\n\r\nI had a node die with an OutOfMemoryError.  When I tried to restart the nodes, they could not start back up and were complaining about being unable to read an index state file.\r\n\r\n`\r\n[2017-10-17T13:50:16,501][ERROR][o.e.g.GatewayMetaState   ] [REDACTED] failed to read local state, exiting...\r\norg.elasticsearch.ElasticsearchException: java.io.IOException: failed to read [id:9, legacy:false, file:/data/2/logstash-1/REDACTED/nodes/0/indices/5FxmYg9DQziflptxDNdW0A/_state/state-9.st]\r\n`\r\n\r\nI checked the file, and unlike other index state files, the file in the log has no content\r\n\r\n`\r\n$ stat /data/1/logstash-1/REDACTED/nodes/0/indices/5FxmYg9DQziflptxDNdW0A/_state/state-9.st\r\n  File: ‘/data/1/logstash-1/REDACTED/nodes/0/indices/5FxmYg9DQziflptxDNdW0A/_state/state-9.st’\r\n  Size: 0         \tBlocks: 0          IO Block: 4096   regular empty file\r\nDevice: 831h/2097d\tInode: 4298048169  Links: 1\r\nAccess: (0644/-rw-r--r--)  Uid: (  496/elasticsearch)   Gid: (  390/elasticsearch)\r\nAccess: 2017-10-17 13:42:55.163173624 -0700\r\nModify: 2017-10-16 16:34:24.419638685 -0700\r\nChange: 2017-10-16 16:34:24.419638685 -0700\r\n Birth: -\r\n`\r\n\r\nElasticsearch will NOT startup in this state.  My cluster is in a perpetual red state as I cannot allocate the unallocated primary and replica shard that has damaged state files.  Here's a bit from where I tried to allocate the unassigned shards:\r\n\r\n`\r\n_cluster/reroute?dry_run -d '{\"commands\": [{\"allocate_stale_primary\": {\"index\": \"logstash-2017.10.07\", \"shard\": 5, \"node\": \"REDACTED\", \"accept_data_loss\": true}}]}'\r\n`\r\n\r\n...\r\n      \"unassigned\": [\r\n        {\r\n          \"unassigned_info\": {\r\n            \"allocation_status\": \"no_attempt\",\r\n            \"details\": \"node_left[BYwe091yTUG_0aPwOcpirQ]\",\r\n            \"delayed\": false,\r\n            \"at\": \"2017-10-16T23:36:05.480Z\",\r\n            \"reason\": \"NODE_LEFT\"\r\n          },\r\n          \"recovery_source\": {\r\n            \"type\": \"PEER\"\r\n          },\r\n          \"index\": \"logstash-2017.10.07\",\r\n          \"shard\": 5,\r\n          \"relocating_node\": null,\r\n          \"node\": null,\r\n          \"primary\": false,\r\n          \"state\": \"UNASSIGNED\"\r\n        },\r\n        {\r\n          \"unassigned_info\": {\r\n            \"allocation_status\": \"no_valid_shard_copy\",\r\n            \"details\": \"node_left[65jx7VyYRty3DZ1SPbMKUg]\",\r\n            \"delayed\": false,\r\n            \"at\": \"2017-10-16T23:40:06.448Z\",\r\n            \"reason\": \"NODE_LEFT\"\r\n          },\r\n          \"recovery_source\": {\r\n            \"type\": \"EXISTING_STORE\"\r\n          },\r\n          \"index\": \"logstash-2017.10.10\",\r\n          \"shard\": 1,\r\n          \"relocating_node\": null,\r\n          \"node\": null,\r\n          \"primary\": true,\r\n          \"state\": \"UNASSIGNED\"\r\n        },\r\n        {\r\n          \"unassigned_info\": {\r\n            \"allocation_status\": \"no_attempt\",\r\n            \"details\": \"primary failed while replica initializing\",\r\n            \"delayed\": false,\r\n            \"at\": \"2017-10-16T23:40:06.448Z\",\r\n            \"reason\": \"PRIMARY_FAILED\"\r\n          },\r\n          \"recovery_source\": {\r\n            \"type\": \"PEER\"\r\n          },\r\n          \"index\": \"logstash-2017.10.10\",\r\n          \"shard\": 1,\r\n          \"relocating_node\": null,\r\n          \"node\": null,\r\n          \"primary\": false,\r\n          \"state\": \"UNASSIGNED\"\r\n        },\r\n        {\r\n          \"unassigned_info\": {\r\n            \"allocation_status\": \"no_valid_shard_copy\",\r\n            \"details\": \"failed recovery, failure RecoveryFailedException[[logstash-2017.10.06][5]: Recovery failed on {REDACTED}{SnJTnI9YS7GKLV9dkOCbtw}{Y6DRDT41Qiqylyu1gXaVsw}{10.0.44.201}{10.0.44.201:9300}{rack=1}]; nested: IndexShardRecoveryException[failed to fetch index version after copying it over]; nested: IndexShardRecoveryException[shard allocated for local recovery (post api), should exist, but doesn't, current files: []]; nested: FileNotFoundException[no segments* file found in store(mmapfs(/data/5/logstash-2/nodes/0/indices/qKtuZNX9SHCHEcj8dviiMQ/5/index)): files: []]; \",\r\n            \"delayed\": false,\r\n            \"failed_attempts\": 1,\r\n            \"at\": \"2017-10-17T22:15:50.136Z\",\r\n            \"reason\": \"ALLOCATION_FAILED\"\r\n          },\r\n          \"recovery_source\": {\r\n            \"type\": \"EXISTING_STORE\"\r\n          },\r\n          \"index\": \"logstash-2017.10.06\",\r\n          \"shard\": 5,\r\n          \"relocating_node\": null,\r\n          \"node\": null,\r\n          \"primary\": true,\r\n          \"state\": \"UNASSIGNED\"\r\n        },\r\n        {\r\n          \"unassigned_info\": {\r\n            \"allocation_status\": \"no_attempt\",\r\n            \"details\": \"primary failed while replica initializing\",\r\n            \"delayed\": false,\r\n            \"at\": \"2017-10-16T23:40:06.448Z\",\r\n            \"reason\": \"PRIMARY_FAILED\"\r\n          },\r\n          \"recovery_source\": {\r\n            \"type\": \"PEER\"\r\n          },\r\n          \"index\": \"logstash-2017.10.06\",\r\n          \"shard\": 5,\r\n          \"relocating_node\": null,\r\n          \"node\": null,\r\n          \"primary\": false,\r\n          \"state\": \"UNASSIGNED\"\r\n        }\r\n      ]\r\n    },\r\n    \"restore\": {\r\n      \"snapshots\": []\r\n    }\r\n  },\r\n  \"acknowledged\": true\r\n}\r\n...\r\n\r\nIf I'm reading the docs right, I'm looking at data loss if I were to use the reroute API with `allocate_empty_primary`.  I have a few questions:\r\n\r\n1.  If I'm totally wrong about being stuck allocating an empty primary, what are my options for recovering?\r\n2.  If I can't recover those shards, is the most expedient path to getting my cluster back to green just deleting the affected indices?","performed_via_github_app":null}]