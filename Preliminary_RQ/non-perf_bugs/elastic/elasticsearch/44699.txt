{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44699","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44699/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44699/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44699/events","html_url":"https://github.com/elastic/elasticsearch/issues/44699","id":471126627,"node_id":"MDU6SXNzdWU0NzExMjY2Mjc=","number":44699,"title":"[ML] Improve model_memory_limit UX for data frame analytics jobs","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1619315113,"node_id":"MDU6TGFiZWwxNjE5MzE1MTEz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.6.0","name":"v7.6.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"assignees":[{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-07-22T14:25:34Z","updated_at":"2019-11-19T10:22:22Z","closed_at":"2019-11-19T10:22:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The current workflow for memory limits is:\r\n\r\n1. User specifies a memory limit up front with no guidance as to what is sensible/realistic\r\n2. They start the analysis\r\n3. Analysis chugs away for a while reindexing the source index into the destination index\r\n4. C++ process is started and checks whether the memory limit is sufficient to do the analysis\r\n5. If it's not then the process exits, reporting how much memory was required in the error message\r\n\r\nTwo possible ways to solve it are:\r\n\r\n1. We duplicate that logic that calculates the memory requirement from the C++ code into the Java and UI code\r\n2. We add a mode of operation to the C++ process where you just supply the spec and instead of actually doing the analysis it just tells you:\r\n  i. What you'd have to set the memory limit to to do the analysis entirely in RAM\r\n  ii. What the minimum memory limit is that will enable the analysis to run at all (using disk)\r\n\r\nAlthough option 2 is a lot of work, the memory calculations done by the C++ are now so complex that it is impractical to duplicate them.  Therefore we should implement option 2.  The work will be something along the lines of:\r\n\r\n- [x] Add a mode of operation to the C++ process where you just supply the spec and it returns the sizing information (i and ii above)\r\nhttps://github.com/elastic/ml-cpp/pull/584\r\n- [x] Add an endpoint to the Java code that runs the C++ process in this mode and returns the output in the endpoint response\r\nhttps://github.com/elastic/elasticsearch/pull/45188\r\n- [x] Call this endpoint early in the start data frame analytics endpoint sequence (before creating the persistent task) and fail early if the configured `model_memory_limit` is so low that the C++ process will fail immediately when run\r\nhttps://github.com/elastic/elasticsearch/pull/45536\r\n- [x] Call the endpoint as part of the configuration process in the UI so that the UI can present a sensible default `model_memory_limit`, advise on sensible upper and lower bounds and validate any value the user chooses themselves\r\nhttps://github.com/elastic/kibana/issues/43740\r\n- [x] HLRC\r\nhttps://github.com/elastic/elasticsearch/pull/45531\r\n- [x] docs\r\nhttps://github.com/elastic/elasticsearch/pull/45188 (API reference), https://github.com/elastic/elasticsearch/pull/45538 (HLRC)\r\n","closed_by":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}