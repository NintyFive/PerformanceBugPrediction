[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414583969","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-414583969","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":414583969,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDU4Mzk2OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-21T07:52:46Z","updated_at":"2018-08-21T07:52:46Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/444108854","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-444108854","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":444108854,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NDEwODg1NA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-12-04T13:59:30Z","updated_at":"2018-12-04T13:59:30Z","author_association":"MEMBER","body":"I haven't tested this personally yet, but I think it's just an artifact of your lat/lons and precision.  E.g. a precision of `2` has a bounding box of size `1,252.3km x 624.1km`\r\n\r\nThe distance between `{1,2}` and `{5,6}` is 628km, so it's possible those two points are just landing in different grid cells which is why you're seeing the same deviceid twice.  Notably, it's the `{5,6}` point that lands in a different grid which makes me think this is the issue.\r\n\r\nI know this is well after you submitted the ticket (sorry for the delay!), but do you have a more realistic example (e.g. real lat/lon points) that doesn't work as expected?\r\n\r\n> Accessing them in a way:\r\n\r\nJust FYI this isn't valid syntax.  This style of syntax can only be used for ordering, or in pipeline aggs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445749204","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445749204","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445749204,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc0OTIwNA==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T09:33:18Z","updated_at":"2018-12-10T09:33:18Z","author_association":"CONTRIBUTOR","body":"I am very confused with the example. I just checked the values for the resulting buckets of the aggregation:\r\n\r\nu2:  [lat = 47.81250000, lon = 16.87500000]\r\nt5: [lat = 19.68750000, lon = 50.62500000]\r\n\r\nI have tried locally the example (v. 6.4.2) and I get just one bucket:\r\n\r\ns0: [lat=2.81250000, lon=5.62500000]\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445753692","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445753692","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445753692,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc1MzY5Mg==","user":{"login":"szkumorowski","id":18058722,"node_id":"MDQ6VXNlcjE4MDU4NzIy","avatar_url":"https://avatars1.githubusercontent.com/u/18058722?v=4","gravatar_id":"","url":"https://api.github.com/users/szkumorowski","html_url":"https://github.com/szkumorowski","followers_url":"https://api.github.com/users/szkumorowski/followers","following_url":"https://api.github.com/users/szkumorowski/following{/other_user}","gists_url":"https://api.github.com/users/szkumorowski/gists{/gist_id}","starred_url":"https://api.github.com/users/szkumorowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szkumorowski/subscriptions","organizations_url":"https://api.github.com/users/szkumorowski/orgs","repos_url":"https://api.github.com/users/szkumorowski/repos","events_url":"https://api.github.com/users/szkumorowski/events{/privacy}","received_events_url":"https://api.github.com/users/szkumorowski/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T09:48:07Z","updated_at":"2018-12-10T09:48:07Z","author_association":"NONE","body":"@iverase\r\n@polyfractal  \r\n\r\ngeohash_grid buckets itself works fine, the issue is it doesn't take into account the sub-aggregation results  (which returns distinct - latest one result for each device based on timestamp), instead it takes the whole index as source\r\n\r\nResponse from ES:\r\n\r\n    \"key\": \"u2\",\r\n    \"doc_count\": 4,\r\n\r\n    \"key\": \"t5\",\r\n    \"doc_count\": 2,\r\n\r\nI belive it shoudn't take all 6 records at all, but 2 from sub-aggregation","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445768696","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445768696","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445768696,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc2ODY5Ng==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T10:37:22Z","updated_at":"2018-12-10T10:37:22Z","author_association":"CONTRIBUTOR","body":"I think your expectations about how aggregations work are not correct. \r\n\r\nSub-aggregations do not act as filters for parent aggregation but the opposite, they take as input the results from the parent aggregation so for the first aggregation the input is the whole index. \r\n\r\nThis is the expected result. \r\n\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445774183","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445774183","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445774183,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc3NDE4Mw==","user":{"login":"szkumorowski","id":18058722,"node_id":"MDQ6VXNlcjE4MDU4NzIy","avatar_url":"https://avatars1.githubusercontent.com/u/18058722?v=4","gravatar_id":"","url":"https://api.github.com/users/szkumorowski","html_url":"https://github.com/szkumorowski","followers_url":"https://api.github.com/users/szkumorowski/followers","following_url":"https://api.github.com/users/szkumorowski/following{/other_user}","gists_url":"https://api.github.com/users/szkumorowski/gists{/gist_id}","starred_url":"https://api.github.com/users/szkumorowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szkumorowski/subscriptions","organizations_url":"https://api.github.com/users/szkumorowski/orgs","repos_url":"https://api.github.com/users/szkumorowski/repos","events_url":"https://api.github.com/users/szkumorowski/events{/privacy}","received_events_url":"https://api.github.com/users/szkumorowski/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T10:54:27Z","updated_at":"2018-12-10T10:55:14Z","author_association":"NONE","body":"Thank you, \r\n\r\nThe point of this aggregation was to create geo buckets for latest position for each device (including top_hit for every bucket) - quite common generic case.\r\n\r\nOne of used aggregations (or top_hits (I don't have code in front of me now)) can not use sub-aggregations what makes it not usable this way. \r\n\r\nCould you please provide right hierarchy of this aggregations ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445779343","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445779343","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445779343,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc3OTM0Mw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T11:11:01Z","updated_at":"2018-12-10T11:11:01Z","author_association":"MEMBER","body":"I don't think it's really possible with elasticsearch at the moment since it would require passing the results of one set of aggregations into another and this is supported only for a small subset of aggregations called pipeline aggregations. \r\n\r\nI think the simplest way to do it might be by creating a separate frequently updated device-oriented index, where id of each record is the id of the device and only store the last known location per device there.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445780555","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445780555","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445780555,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc4MDU1NQ==","user":{"login":"szkumorowski","id":18058722,"node_id":"MDQ6VXNlcjE4MDU4NzIy","avatar_url":"https://avatars1.githubusercontent.com/u/18058722?v=4","gravatar_id":"","url":"https://api.github.com/users/szkumorowski","html_url":"https://github.com/szkumorowski","followers_url":"https://api.github.com/users/szkumorowski/followers","following_url":"https://api.github.com/users/szkumorowski/following{/other_user}","gists_url":"https://api.github.com/users/szkumorowski/gists{/gist_id}","starred_url":"https://api.github.com/users/szkumorowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szkumorowski/subscriptions","organizations_url":"https://api.github.com/users/szkumorowski/orgs","repos_url":"https://api.github.com/users/szkumorowski/repos","events_url":"https://api.github.com/users/szkumorowski/events{/privacy}","received_events_url":"https://api.github.com/users/szkumorowski/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T11:15:28Z","updated_at":"2018-12-10T11:15:28Z","author_association":"NONE","body":"Thank you, It's what I supposed is required for it :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445791159","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-445791159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":445791159,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTc5MTE1OQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-12-10T11:58:12Z","updated_at":"2018-12-10T11:58:12Z","author_association":"MEMBER","body":"Another idea might be to use the [`field collapsing`](https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-request-collapse.html) feature, collapse on the `deviceId` field and sort on the `timestamp` field to get the actual document for the latest position of each device and pull the `geoPoint` field from there. The downside of this approach would be that you get each point individually rather than aggregated into cells so your UI will need to do some more work.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/453136313","html_url":"https://github.com/elastic/elasticsearch/issues/32999#issuecomment-453136313","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32999","id":453136313,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MzEzNjMxMw==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2019-01-10T15:29:16Z","updated_at":"2019-01-10T15:29:16Z","author_association":"CONTRIBUTOR","body":"No further feedback received. @szkumorowski if you have other questions, post them and we can look at re-opening this issue.","performed_via_github_app":null}]