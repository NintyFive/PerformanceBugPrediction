{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28782","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28782/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28782/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28782/events","html_url":"https://github.com/elastic/elasticsearch/issues/28782","id":299344119,"node_id":"MDU6SXNzdWUyOTkzNDQxMTk=","number":28782,"title":"Should we store geoip files uncompressed?","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-02-22T12:59:11Z","updated_at":"2018-03-13T09:13:32Z","closed_at":"2018-03-12T07:07:34Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Current Situation\r\n\r\nThe ingest-geoip plugin ships with three geoip files:\r\n\r\n* GeoLite2-ASN.mmdb.gz\r\n* GeoLite2-City.mmdb.gz\r\n* GeoLite2-Country.mmdb.gz\r\n\r\nWe load these files [lazily](https://github.com/elastic/elasticsearch/blob/daf430c/plugins/ingest-geoip/src/main/java/org/elasticsearch/ingest/geoip/IngestGeoIpPlugin.java#L93-L97) to reduce memory usage when this feature is not required (despite the plugin being loaded).\r\n\r\nWhile the Maxmind DB reader allows to [load data either on-heap or off-heap](https://github.com/maxmind/MaxMind-DB-Reader-java/blob/master/src/main/java/com/maxmind/db/Reader.java#L31-L42),  we basically [have to load data on-heap](https://github.com/maxmind/GeoIP2-java/blob/b0a1695/src/main/java/com/maxmind/geoip2/DatabaseReader.java#L64) because we provide an `InputStream` that decompresses the gzipped data on the fly.\r\n\r\nIn order to allow loading the data off-heap, we [need to provide a file](https://github.com/maxmind/GeoIP2-java/blob/b0a1695/src/main/java/com/maxmind/geoip2/DatabaseReader.java#L66) (see the `builder.mode` parameter which controls whether to load on- or off-heap).\r\n\r\n### Discussion Item\r\n\r\nDoes it make sense to store these files uncompressed instead of gzip-compressed?\r\n\r\n### Consequences\r\n\r\n#### Positive Consequences\r\n\r\n* We take up less heap memory (it would be roughly 70MB less). This will positively affect users - especially users with small clusters - as well as our own integration tests (we can *probably* reduce the heap size of our integration test clusters). As a corollary, I expect that we reduce GC pressure a bit as well.\r\n* We also have the choice to decide whether we load data on-heap or off-heap when we use a file instead of an input stream. This means that we can provide an (expert) setting if we want to if certain users still prefer to have the data on-heap.\r\n\r\n#### Negative Consequences\r\n\r\n* Loading the files is not free: The data are memory-mapped instead and take up native memory.\r\n* The size of the `config` directory on disk increases from 34.5 MB to 72.6 MB.\r\n* The size of the plugin artefact increases from 34.7 MB to 37.6 MB (tested with `ingest-geoip-6.2.2.zip`).","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}