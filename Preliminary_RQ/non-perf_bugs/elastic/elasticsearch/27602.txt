{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27602","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27602/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27602/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27602/events","html_url":"https://github.com/elastic/elasticsearch/issues/27602","id":277985341,"node_id":"MDU6SXNzdWUyNzc5ODUzNDE=","number":27602,"title":"bucket_script & bucket_selector fail to get reference from bucket_path with meaningful cumulative_sum,serial_diff and moving_avg aggregtaion","user":{"login":"voidlps","id":3744683,"node_id":"MDQ6VXNlcjM3NDQ2ODM=","avatar_url":"https://avatars2.githubusercontent.com/u/3744683?v=4","gravatar_id":"","url":"https://api.github.com/users/voidlps","html_url":"https://github.com/voidlps","followers_url":"https://api.github.com/users/voidlps/followers","following_url":"https://api.github.com/users/voidlps/following{/other_user}","gists_url":"https://api.github.com/users/voidlps/gists{/gist_id}","starred_url":"https://api.github.com/users/voidlps/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/voidlps/subscriptions","organizations_url":"https://api.github.com/users/voidlps/orgs","repos_url":"https://api.github.com/users/voidlps/repos","events_url":"https://api.github.com/users/voidlps/events{/privacy}","received_events_url":"https://api.github.com/users/voidlps/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-11-30T03:21:23Z","updated_at":"2017-11-30T09:14:58Z","closed_at":"2017-11-30T09:14:58Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.6.3\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_151\r\n\r\n**OS version**: official docker image \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nbucket_script / bucket_selector aggregation with a bucket_path pointing to cumulative_sum or serial_diff result may fail or become zero.\r\nThe major problem comes from in date_histogram, we may have some empty buckets but the cumulative_sum and serial_diff values are still meaningful and shall be used in bucket_script, for example, let elasticsearch do the unit conversation and provide the result together.\r\n  \r\nIt seems related to 3rd OR in this line:\r\nhttps://github.com/elastic/elasticsearch/blob/64ca0fe9bb41da84945582e7317b714a642c1902/core/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketHelpers.java#L174\r\n  \r\nwhen bucket doc_count==0, here will always use gapPolicy even there is some meaningful value with that bucket_path, but this assumption is incorrect siince cumulative_sum / serial_diff / moving_avg aggregations will still provide meaningful values even it's an empty bucket.\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. create example data:\r\n```\r\ncurl http://localhost:9200/test_bucket_path/testdata/1 -XPUT -d'{\"name\":\"a\",\"num\":1, \"t\":\"2017-11-30T09:03\"}'\r\ncurl http://localhost:9200/test_bucket_path/testdata/2 -XPUT -d'{\"name\":\"a\",\"num\":3, \"t\":\"2017-11-30T09:15\"}'\r\ncurl http://localhost:9200/test_bucket_path/testdata/3 -XPUT -d'{\"name\":\"a\",\"num\":5, \"t\":\"2017-11-30T09:45\"}'\r\n```\r\n 2.try the aggregation with empty bucket:\r\n```\r\nGET test_bucket_path/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"t\",\r\n        \"interval\": \"10m\"\r\n      },\r\n      \"aggs\": {\r\n        \"avg\": {\r\n          \"avg\": {\r\n            \"field\": \"num\"\r\n          }\r\n        },\r\n        \"cul_sum\": {\r\n          \"cumulative_sum\": {\r\n            \"buckets_path\": \"avg\"\r\n          }\r\n        },\r\n        \"broken_script\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"cul_sum\": \"cul_sum\"\r\n            },\r\n            \"script\": \"params.cul_sum*5\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 3. the buckets of \"2017-11-30T09:20:00.000Z\" and \"2017-11-30T09:30:00.000Z\", the bucket_script result is not provided\r\n```\r\n{\r\n  \"took\": 167,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 3,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"test\": {\r\n      \"buckets\": [\r\n        {\r\n          \"key_as_string\": \"2017-11-30T09:00:00.000Z\",\r\n          \"key\": 1512032400000,\r\n          \"doc_count\": 1,\r\n          \"avg\": {\r\n            \"value\": 1\r\n          },\r\n          \"cul_sum\": {\r\n            \"value\": 1\r\n          },\r\n          \"broken_script\": {\r\n            \"value\": 5\r\n          }\r\n        },\r\n        {\r\n          \"key_as_string\": \"2017-11-30T09:10:00.000Z\",\r\n          \"key\": 1512033000000,\r\n          \"doc_count\": 1,\r\n          \"avg\": {\r\n            \"value\": 3\r\n          },\r\n          \"cul_sum\": {\r\n            \"value\": 4\r\n          },\r\n          \"broken_script\": {\r\n            \"value\": 20\r\n          }\r\n        },\r\n        {\r\n          \"key_as_string\": \"2017-11-30T09:20:00.000Z\",\r\n          \"key\": 1512033600000,\r\n          \"doc_count\": 0,\r\n          \"avg\": {\r\n            \"value\": null\r\n          },\r\n          \"cul_sum\": {\r\n            \"value\": 4\r\n          }\r\n        },\r\n        {\r\n          \"key_as_string\": \"2017-11-30T09:30:00.000Z\",\r\n          \"key\": 1512034200000,\r\n          \"doc_count\": 0,\r\n          \"avg\": {\r\n            \"value\": null\r\n          },\r\n          \"cul_sum\": {\r\n            \"value\": 4\r\n          }\r\n        },\r\n        {\r\n          \"key_as_string\": \"2017-11-30T09:40:00.000Z\",\r\n          \"key\": 1512034800000,\r\n          \"doc_count\": 1,\r\n          \"avg\": {\r\n            \"value\": 5\r\n          },\r\n          \"cul_sum\": {\r\n            \"value\": 9\r\n          },\r\n          \"broken_script\": {\r\n            \"value\": 45\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}