[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/219025309","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-219025309","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":219025309,"node_id":"MDEyOklzc3VlQ29tbWVudDIxOTAyNTMwOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-13T12:06:20Z","updated_at":"2016-05-13T12:06:20Z","author_association":"CONTRIBUTOR","body":"@colings86 please could you take a look at this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/219313848","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-219313848","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":219313848,"node_id":"MDEyOklzc3VlQ29tbWVudDIxOTMxMzg0OA==","user":{"login":"mattdawson","id":7719905,"node_id":"MDQ6VXNlcjc3MTk5MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/7719905?v=4","gravatar_id":"","url":"https://api.github.com/users/mattdawson","html_url":"https://github.com/mattdawson","followers_url":"https://api.github.com/users/mattdawson/followers","following_url":"https://api.github.com/users/mattdawson/following{/other_user}","gists_url":"https://api.github.com/users/mattdawson/gists{/gist_id}","starred_url":"https://api.github.com/users/mattdawson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattdawson/subscriptions","organizations_url":"https://api.github.com/users/mattdawson/orgs","repos_url":"https://api.github.com/users/mattdawson/repos","events_url":"https://api.github.com/users/mattdawson/events{/privacy}","received_events_url":"https://api.github.com/users/mattdawson/received_events","type":"User","site_admin":false},"created_at":"2016-05-15T22:10:34Z","updated_at":"2016-05-15T22:13:05Z","author_association":"NONE","body":"Looking deeper in to this I realise that the intention is for one bucket for the hour covering the DST change over.\nEssentially I have time series data with tsr = timestamp and tsrf = timestamp formatted, all stored against a channel denoted by 'c', with a sequence id of 'k', where if the data becomes non contiguous for some reason the 'k' value gets incremented.\nI then do terms agg plus a nested histo query over the data and merge multiple streams into one.\nBut, at change over is happens.. A dual 2am record for the second term aggregation where k=1\nLook for ***\\* in the log to see the double.\n\n```\n...\nrowk1.tsrf==rowk2.tsrf? true rowk1.tsrf= 03/04/2016 01:00 rowk2.tsrf= 03/04/2016 01:00 rowk1.k= undefined rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? true rowk1.tsrf= 03/04/2016 02:00 rowk2.tsrf= 03/04/2016 **** 02:00 **** rowk1.k= undefined rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 03/04/2016 03:00 rowk2.tsrf= 03/04/2016 **** 02:00 ****  rowk1.k= undefined rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 03/04/2016 04:00 rowk2.tsrf= 03/04/2016 03:00 rowk1.k= undefined rowk2.k= 1\n...\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 02/05/2016 13:00 rowk2.tsrf= 02/05/2016 12:00 rowk1.k= undefined rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 02/05/2016 14:00 rowk2.tsrf= 02/05/2016 13:00 rowk1.k= 0 rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 02/05/2016 15:00 rowk2.tsrf= 02/05/2016 14:00 rowk1.k= 0 rowk2.k= 1\nrowk1.tsrf==rowk2.tsrf? false rowk1.tsrf= 02/05/2016 16:00 rowk2.tsrf= 02/05/2016 15:00 rowk1.k= 0 rowk2.k= undefined\n...\n```\n\nWhat you see here is a two streams in a channel, one from 31/3/2016 11:00 to 02/05/2016 14:00, and one from 02/05/2016 13:00 to 02/05/2016 14:00:00.\nI think the bug only occurs when there are two streams and thus two buckets for k values(and thus two date_histos).\n\nHeres the full query I execute.\n\n```\n{\n        \"index\": \"read_5555605bab95c2765d65c3cc_201603,read_5555605bab95c2765d65c3cc_201604,read_5555605bab95c2765d65c3cc_201605\",\n        \"type\": \"reading\",\n        \"ignoreUnavailable\": true,\n        \"allowNoIndices\": true,\n        \"size\": 0\n}\n{\n        \"query\": {\n                \"filtered\": {\n                        \"filter\": {\n                                \"bool\": {\n                                        \"must\": [\n                                                {\n                                                        \"term\": {\n                                                                \"c\": \"57314b3f361be1ce3c55110d\"\n                                                        }\n                                                },\n                                                {\n                                                        \"term\": {\n                                                                \"p\": \"energy_active_sum\"\n                                                        }\n                                                },\n                                                {\n                                                        \"range\": {\n                                                                \"tsr\": {\n                                                                        \"gte\": \"2016-03-30T11:00:00.000Z\",\n                                                                        \"lt\": \"2016-05-02T12:00:00.000Z\"\n                                                                }\n                                                        }\n                                                }\n                                        ]\n                                }\n                        }\n                }\n        },\n        \"aggs\": {\n                \"by_k\": {\n                        \"terms\": {\n                                \"field\": \"k\",\n                                \"size\": 0,\n                                \"order\": {\n                                        \"_term\": \"asc\"\n                                }\n                        },\n                        \"aggs\": {\n                                \"events_by_date\": {\n                                        \"date_histogram\": {\n                                                \"field\": \"tsr\",\n                                                \"interval\": \"1h\",\n                                                \"time_zone\": \"Pacific/Auckland\",\n                                                \"min_doc_count\": 0,\n                                                \"extended_bounds\": {\n                                                        \"min\": \"2016-03-30T11:00:00.000Z\",\n                                                        \"max\": \"2016-05-02T12:00:00.000Z\"\n                                                },\n                                                \"order\": {\n                                                        \"_key\": \"asc\"\n                                                }\n                                        },\n                                        \"aggs\": {\n                                                \"maxtsr\": {\n                                                        \"max\": {\n                                                                \"field\": \"tsr\"\n                                                        }\n                                                },\n                                                \"mintsr\": {\n                                                        \"min\": {\n                                                                \"field\": \"tsr\"\n                                                        }\n                                                },\n                                                \"maxvd\": {\n                                                        \"max\": {\n                                                                \"field\": \"vd\"\n                                                        }\n                                                },\n                                                \"minvd\": {\n                                                        \"min\": {\n                                                                \"field\": \"vd\"\n                                                        }\n                                                }\n                                        }\n                                }\n                        }\n                }\n        }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/219315379","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-219315379","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":219315379,"node_id":"MDEyOklzc3VlQ29tbWVudDIxOTMxNTM3OQ==","user":{"login":"mattdawson","id":7719905,"node_id":"MDQ6VXNlcjc3MTk5MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/7719905?v=4","gravatar_id":"","url":"https://api.github.com/users/mattdawson","html_url":"https://github.com/mattdawson","followers_url":"https://api.github.com/users/mattdawson/followers","following_url":"https://api.github.com/users/mattdawson/following{/other_user}","gists_url":"https://api.github.com/users/mattdawson/gists{/gist_id}","starred_url":"https://api.github.com/users/mattdawson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattdawson/subscriptions","organizations_url":"https://api.github.com/users/mattdawson/orgs","repos_url":"https://api.github.com/users/mattdawson/repos","events_url":"https://api.github.com/users/mattdawson/events{/privacy}","received_events_url":"https://api.github.com/users/mattdawson/received_events","type":"User","site_admin":false},"created_at":"2016-05-15T22:39:10Z","updated_at":"2016-05-15T22:39:10Z","author_association":"NONE","body":"Further thought leads me to think the k=0 stream is correct because it's dst values were created by extended bounds, and the second failed because it actually had data.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/220301919","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-220301919","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":220301919,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMDMwMTkxOQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2016-05-19T11:50:13Z","updated_at":"2016-05-19T11:50:13Z","author_association":"MEMBER","body":"@mattdawson can you take a look at #18326 and the fix provided in #18415 to see if this solves your problem? I have looked at the queries you are using and this looks very similar, however I'm not fully able to understand your use case or check this with the patch from #18415 without a better understanding of your data. If looking at the two issues I linked to doesn't help, can you provide a minimal example with a few datapoints?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/220505781","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-220505781","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":220505781,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMDUwNTc4MQ==","user":{"login":"mattdawson","id":7719905,"node_id":"MDQ6VXNlcjc3MTk5MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/7719905?v=4","gravatar_id":"","url":"https://api.github.com/users/mattdawson","html_url":"https://github.com/mattdawson","followers_url":"https://api.github.com/users/mattdawson/followers","following_url":"https://api.github.com/users/mattdawson/following{/other_user}","gists_url":"https://api.github.com/users/mattdawson/gists{/gist_id}","starred_url":"https://api.github.com/users/mattdawson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattdawson/subscriptions","organizations_url":"https://api.github.com/users/mattdawson/orgs","repos_url":"https://api.github.com/users/mattdawson/repos","events_url":"https://api.github.com/users/mattdawson/events{/privacy}","received_events_url":"https://api.github.com/users/mattdawson/received_events","type":"User","site_admin":false},"created_at":"2016-05-20T02:58:50Z","updated_at":"2016-05-20T02:59:55Z","author_association":"NONE","body":"@cbuescher, The code change appears to add one non-DST adjusted unit inside TimeUnitRounding .nextRoundingValue for intervals less than 1 day.  Although the outcome is a consistent dual bucket for both extended and non-extended result sets, I believe it's the wrong approach.  What you want is a single bucket covering 2 hours for the DST change over.  The reason being because some DST change overs are only 30mins and this method would not be congruous between 1hour and 30min DST changes.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222407440","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-222407440","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":222407440,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjQwNzQ0MA==","user":{"login":"matsondawson","id":1276179,"node_id":"MDQ6VXNlcjEyNzYxNzk=","avatar_url":"https://avatars1.githubusercontent.com/u/1276179?v=4","gravatar_id":"","url":"https://api.github.com/users/matsondawson","html_url":"https://github.com/matsondawson","followers_url":"https://api.github.com/users/matsondawson/followers","following_url":"https://api.github.com/users/matsondawson/following{/other_user}","gists_url":"https://api.github.com/users/matsondawson/gists{/gist_id}","starred_url":"https://api.github.com/users/matsondawson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matsondawson/subscriptions","organizations_url":"https://api.github.com/users/matsondawson/orgs","repos_url":"https://api.github.com/users/matsondawson/repos","events_url":"https://api.github.com/users/matsondawson/events{/privacy}","received_events_url":"https://api.github.com/users/matsondawson/received_events","type":"User","site_admin":false},"created_at":"2016-05-30T04:01:54Z","updated_at":"2016-05-30T04:19:36Z","author_association":"NONE","body":"@cbuescher,\nThat change breaks 15 min intervals.  The buckets seem to change one hour early.  And I'm getting overlapping data results.  In the data below the min of the next bucket should be more than the max of the previous bucket.\nkey_as_string is in Pacific/Auckland time.  It should change to +12:00 at 3am, but it's changing at 2am.\n\n```\n{ key_as_string: '2016-04-03T01:45:00.000+13:00', mintsr: '2016-04-02T12:45:04.523Z', maxtsr: '2016-04-02T12:50:00.728Z', minvd: 6127.3, maxvd: 6127.3 }\n{ key_as_string: '2016-04-03T02:00:00.000+12:00', mintsr: '2016-04-02T13:00:00.755Z', maxtsr: '2016-04-02T14:10:00.814Z', minvd: 6127.4, maxvd: 6127.9 }\n{ key_as_string: '2016-04-03T02:15:00.000+12:00', mintsr: '2016-04-02T13:15:00.682Z', maxtsr: '2016-04-02T14:25:00.722Z', minvd: 6127.5, maxvd: 6128.0 }\n{ key_as_string: '2016-04-03T02:30:00.000+12:00', mintsr: '2016-04-02T13:30:00.789Z', maxtsr: '2016-04-02T14:40:00.684Z', minvd: 6127.6, maxvd: 6128.1 }\n{ key_as_string: '2016-04-03T02:45:00.000+12:00', mintsr: '2016-04-02T13:45:05.004Z', maxtsr: '2016-04-02T14:55:05.685Z', minvd: 6127.7, maxvd: 6128.2 }\n{ key_as_string: '2016-04-03T03:00:00.000+12:00', mintsr: '2016-04-02T15:00:06.389Z', maxtsr: '2016-04-02T15:10:00.729Z', minvd: 6128.3, maxvd: 6128.3 }\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222449265","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-222449265","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":222449265,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjQ0OTI2NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2016-05-30T09:13:26Z","updated_at":"2016-05-30T09:13:26Z","author_association":"MEMBER","body":"@matsondawson This is a different problem unrelated to #18415 , although from a user perspective it appears related. If you use 15 min intevals, ES is using `TimeIntervalRounding` internally which wasn't affected by that change. I'm pretty sure there are edge cases with arbitrary interval lengths around dst changes have glitches in them, so can I ask you again for an example containing few data ponts and a query that doesn't work for you, then I will look into this again. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/255758780","html_url":"https://github.com/elastic/elasticsearch/issues/18310#issuecomment-255758780","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18310","id":255758780,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NTc1ODc4MA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-10-24T14:36:58Z","updated_at":"2016-10-24T14:36:58Z","author_association":"CONTRIBUTOR","body":"Closing due to lack of feedback.\n","performed_via_github_app":null}]