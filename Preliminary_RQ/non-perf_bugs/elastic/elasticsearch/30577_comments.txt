[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/388844381","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-388844381","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":388844381,"node_id":"MDEyOklzc3VlQ29tbWVudDM4ODg0NDM4MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-14T14:49:01Z","updated_at":"2018-05-14T14:49:01Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389795747","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-389795747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":389795747,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTc5NTc0Nw==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T08:57:48Z","updated_at":"2018-05-17T08:57:48Z","author_association":"MEMBER","body":"This test creates an index with 0 replica, merges disabled and a very high value for the flush translog size setting. Then it corrupts a file in a random primary shard (in this failure, it is `_2.si`), registers a repository and creates a snapshot.\r\n\r\nWhen creating the snapshot, the test expects that the shard snapshot process loads the store metadata and then fails because one of the Lucene files is corrupted, failing the shard snapshot and marking the snapshot as PARTIAL.\r\n\r\nIn this test failure the snapshot completed as SUCCESS. I looked closely at it and I can't figure why it didn't fail when loading the store metadata. Of course it does not reproduce locally. The test correclty corrupted the file:\r\n\r\n```\r\n[INFO ][test                     ] Corrupting file --  flipping at position 68 from 0 to 1 file: _2.si\r\n[INFO ][test                     ] Checksum before: [2483589937] after: [1016601414] checksum value after corruption: 2483589937] file: _2.si length: 387\r\n```\r\n\r\nI suspect a test bug, or maybe that the file was not part of the snapshot but it should have been. Merges are disabled and flushes are manually executed before corrupting the file.\r\n\r\nI pushed 7915b5f7aaa1f5f67051dd699dfb2eb8d74c6bd1 to add more debug information, hopefully this error will appear again and we'll be able to grab the shard files and the snapshotted files.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389820044","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-389820044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":389820044,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTgyMDA0NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T10:24:13Z","updated_at":"2018-05-17T10:24:13Z","author_association":"CONTRIBUTOR","body":"@dnhatn With the changes that were made to `CombinedDeletionPolicy`, do you perhaps know if we can expect all unreferenced Lucene files to be cleaned up after a flush?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390232375","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390232375","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390232375,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDIzMjM3NQ==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T14:52:20Z","updated_at":"2018-05-18T14:52:20Z","author_association":"MEMBER","body":"@ywelsch I have looked at the test.\r\nIf the latest value of the global checkpoint has not fsynced before a flush, we will have two commits; then if we corrupt some files which are referenced only by the previous commit, the snapshot of the latest commit will be SUCCESS instead of PARTIAL.\r\n\r\nI will follow-up this test with @tlrx.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390233652","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390233652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390233652,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDIzMzY1Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T14:56:21Z","updated_at":"2018-05-18T14:56:21Z","author_association":"CONTRIBUTOR","body":"awesome!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390242305","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390242305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390242305,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDI0MjMwNQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T15:23:10Z","updated_at":"2018-05-18T15:23:10Z","author_association":"MEMBER","body":"Good catch @ywelsch and @dnhatn. But what could make a file referenced by a commit point and not by the next one, when merges are disabled and the shard manually flushed?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390267262","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390267262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390267262,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDI2NzI2Mg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T16:51:36Z","updated_at":"2018-05-18T16:51:36Z","author_association":"MEMBER","body":"@tlrx You're right. My assumption is not correct in this case.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390412004","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390412004","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390412004,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDQxMjAwNA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-05-19T15:21:21Z","updated_at":"2018-05-19T15:21:21Z","author_association":"MEMBER","body":"@tlrx I will be taking care of this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390451558","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390451558","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390451558,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDQ1MTU1OA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-05-20T01:44:02Z","updated_at":"2018-05-20T01:54:02Z","author_association":"MEMBER","body":"@tlrx and @ywelsch I've reproduced and have an explanation for this. This is possibly caused by [LUCENE-8253](https://issues.apache.org/jira/browse/LUCENE-8253) \r\n\r\n1. `indexRandom(true, builders)` not only add docs but also index/delete bogus docs. \r\n\r\n```\r\n[test][4] Index [fEPBemMBIyPePwGlvrH9]\r\n [test][4] Index [bogus_doc_ीनठफड़जऊa44]\r\n[test][4] Index [oUPBemMBIyPePwGlvrH-]\r\n[test][4] Delete [bogus_doc_ीनठफड़जऊa44]\r\n```\r\n\r\n2. With a special seed (A9D224BA3576B58B:E8899F47DB14C3CA), `indexRandom` might create a fully deleted segment in which all documents are deleted.\r\n\r\n```\r\nSegment _2(7.4.0):c1, files [_2.si, _2.cfe, _2.cfs], maxDocs=[1], numDocs=[0], delDocs=[1], seq#=[6] \r\n```\r\nPreviously, a fully deleted segment is kept around until the next commit, however since [LUCENE-8253](https://issues.apache.org/jira/browse/LUCENE-8253) it is dropped immediately. The problem is that its files, which are not referenced by any commit point, are not released but retained in IndexFileDeleter's lastFiles.\r\n\r\n```\r\nIFD's last files:  [_0.si, _3.si, _1.cfe, _1.si, _3_1.liv, _2.si, \r\n_0.cfs, _2.cfs, _3.cfe, _1.cfs, _0.cfe, _2.cfe, _3.cfs, _2_1.liv]\r\n```\r\n\r\n3. We then corrupt `_2.cfe` which belongs to the dropped segment.\r\n\r\n```\r\nCorrupting file --  flipping at position 197 from 0 to 1 file: _2.cfe\r\n```\r\n\r\n4. Taking snapshot should be ok because the last commit does not includes the corrupted file.\r\n\r\n```\r\nLoading store metadata using SnapshotIndexCommit{segments_3},\r\nfiles: [_1.cfs, _0.cfe, _0.si, _3.si, _1.cfe, _1.si, _3_1.liv, _0.cfs, _3.cfs, _3.cfe, segments_3]\r\n```\r\n\r\nI opened [LUCENE-8324](https://issues.apache.org/jira/browse/LUCENE-8324). If @s1monw agrees to fix this in Lucene, we are good; otherwise we need to update the test.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390949767","html_url":"https://github.com/elastic/elasticsearch/issues/30577#issuecomment-390949767","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30577","id":390949767,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDk0OTc2Nw==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-05-22T10:59:12Z","updated_at":"2018-05-22T10:59:12Z","author_association":"MEMBER","body":"Thanks @dnhatn. I suspected something like that but I did not look deeply enough.","performed_via_github_app":null}]