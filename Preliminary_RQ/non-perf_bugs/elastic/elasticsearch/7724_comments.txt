[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55608573","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-55608573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":55608573,"node_id":"MDEyOklzc3VlQ29tbWVudDU1NjA4NTcz","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2014-09-15T15:37:04Z","updated_at":"2014-09-15T15:37:04Z","author_association":"MEMBER","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/56882248","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-56882248","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":56882248,"node_id":"MDEyOklzc3VlQ29tbWVudDU2ODgyMjQ4","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-09-25T20:53:36Z","updated_at":"2014-09-25T20:53:36Z","author_association":"CONTRIBUTOR","body":"Pushed.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/57048311","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-57048311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":57048311,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MDQ4MzEx","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-09-27T10:08:54Z","updated_at":"2014-09-27T10:08:54Z","author_association":"CONTRIBUTOR","body":"I had to back out this change: it was causing false failures.\n\nThanks to @mvg digging, it looks like there is a pre-existing bug\nin ES somewhere, i.e. that while removing a shard\n(IndexService.removeShard) is running, NoneIndexShardGateway.recover\nis also allowed to concurrently go remove all files from the store.\n\nAckTests shows the issue easily: just change \"false\" to \"true\" for\nCHECK_INDEX_ON_CLOSE settings, and its tests will fail.  If I add\n`.put(\"gateway.type\", \"local\")` to AckTests.nodeSettings it fixes the\nfailures...\n\nBut I really have no idea where/how to fix this; seems like we need\nsome locking somewhere in NoneIndexShardGateway?  Somehow\nLocalIndexShardGateway.recover doesn't have this issue...\n\nNet/net I think it's very important that we pass CheckIndex for every\nshard created in our tests: when we added this to Lucene's\nMockDirectoryWrapper (long time ago...) it caught all sorts of\ntricky cases where Lucene was [incorrectly!] making corrupt indices.\nI just don't know how to proceed....\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/57279216","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-57279216","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":57279216,"node_id":"MDEyOklzc3VlQ29tbWVudDU3Mjc5MjE2","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-09-30T07:56:37Z","updated_at":"2014-09-30T07:56:37Z","author_association":"MEMBER","body":"When applying initializing shards on the actual data nodes the recovery happens in a async manner. In the integration tests the none gateway is used, which for \"recovery\" simply removes any existing files for shard being initialized. So for any create index or open index api call even if the response has been acked it doesn't mean recovery has been completed.\n\nIn AckTests#testOpenIndexNoAcknowledgement we create an index and then wait for green and then the created index gets closed and during close we run check index. So far no potential issues. The index gets opened and then the test tear down logic kicks in that deletes all the indices. This where there is a race condition. Because we don't wait for the acknowledgement and because the recovery from disk during the open index call is async, the deletion of all indices during teardown may run before / during the the recovery. When check index is ran the validation that there are actual files may pass, but when it actually starts verifying the index files they may already be removed.\n\nI think there are two easy fixes for this:\n- Stop using the none gateway in integration tests. The none gateway is used because the tests will run faster. The reason initializing shards get purged on the local node they get allocated is because of the none gateway. Local gateway (default) does't do this and actually recovers from disk.\n- Waiting for a green state after the open index call this will make sure that the recovery that is triggered by the open call is invoked before we run check index that is caused by deleting all indices in the tear down.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/57312975","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-57312975","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":57312975,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MzEyOTc1","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-09-30T13:27:51Z","updated_at":"2014-09-30T13:27:51Z","author_association":"CONTRIBUTOR","body":"Thank you @martijnvg for getting to the bottom of this...\n\nIs the \"none\" gateway used in practice, besides tests?  It is documented as being useful for indices that should not persist (http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html ) but is it really used?  Maybe we could remove it entirely if not?  (Seems dangerous to remove only from tests if in fact users do use it...).\n\nMight the \"local\" gateway also have problems, because its recover also runs concurrently with CheckIndex?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/57318692","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-57318692","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":57318692,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MzE4Njky","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-09-30T14:07:00Z","updated_at":"2014-09-30T14:07:00Z","author_association":"MEMBER","body":"I don't know of actual use cases for the none gateway, so I'm unsure if that is the right thing to do.\nThe local gateway does replay the translog and I think that isn't supposed to happen while check index runs? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/59475884","html_url":"https://github.com/elastic/elasticsearch/issues/7724#issuecomment-59475884","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7724","id":59475884,"node_id":"MDEyOklzc3VlQ29tbWVudDU5NDc1ODg0","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-10-17T07:23:28Z","updated_at":"2014-10-17T07:23:28Z","author_association":"MEMBER","body":"Check index now always runs on the 1.x and master branch\n","performed_via_github_app":null}]