{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58778","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58778/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58778/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58778/events","html_url":"https://github.com/elastic/elasticsearch/issues/58778","id":648456421,"node_id":"MDU6SXNzdWU2NDg0NTY0MjE=","number":58778,"title":"FollowerFailOverIT.testFailOverOnFollower fails on 7.x reproducibly","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":912824565,"node_id":"MDU6TGFiZWw5MTI4MjQ1NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CCR","name":":Distributed/CCR","color":"0e8a16","default":false,"description":"Issues around the Cross Cluster State Replication features"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-06-30T20:02:11Z","updated_at":"2020-06-30T20:08:24Z","closed_at":"2020-06-30T20:08:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Build scan**:\r\nhttps://gradle-enterprise.elastic.co/s/66hnn7nhkbtjw\r\n\r\n**Repro line**:\r\n```\r\n./gradlew ':x-pack:plugin:ccr:internalClusterTest' --tests \"org.elasticsearch.xpack.ccr.FollowerFailOverIT.testFailOverOnFollower\" -Dtests.seed=ECB3C06592940245 -Dtests.security.manager=true -Dtests.locale=be-BY -Dtests.timezone=Kwajalein -Druntime.java=8\r\n```\r\n\r\n**Reproduces locally?**:\r\nYep\r\n\r\n**Applicable branches**:\r\n7.x\r\n\r\n**Failure history**:\r\nNone\r\n\r\n**Failure excerpt**:\r\n```\r\norg.elasticsearch.xpack.ccr.FollowerFailOverIT > testFailOverOnFollower FAILED\r\n    java.lang.AssertionError: timed out waiting for green state\r\n        at __randomizedtesting.SeedInfo.seed([ECB3C06592940245:33E069F906F4A17F]:0)\r\n        at org.junit.Assert.fail(Assert.java:88)\r\n        at org.elasticsearch.xpack.CcrIntegTestCase.ensureColor(CcrIntegTestCase.java:347)\r\n        at org.elasticsearch.xpack.CcrIntegTestCase.ensureFollowerGreen(CcrIntegTestCase.java:321)\r\n        at org.elasticsearch.xpack.CcrIntegTestCase.ensureFollowerGreen(CcrIntegTestCase.java:316)\r\n        at org.elasticsearch.xpack.ccr.FollowerFailOverIT.testFailOverOnFollower(FollowerFailOverIT.java:104)\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ccr:internalClusterTest' --tests \"org.elasticsearch.xpack.ccr.FollowerFailOverIT.testFailOverOnFollower\" -Dtests.seed=ECB3C06592940245 -Dtests.security.manager=true -Dtests.locale=be-BY -Dtests.timezone=Kwajalein -Druntime.java=8\r\n\r\norg.elasticsearch.xpack.ccr.FollowerFailOverIT > classMethod FAILED\r\n    com.carrotsearch.randomizedtesting.ThreadLeakError: 1 thread leaked from SUITE scope at org.elasticsearch.xpack.ccr.FollowerFailOverIT: \r\n       1) Thread[id=148, name=Thread-5, state=TIMED_WAITING, group=TGRP-FollowerFailOverIT]\r\n            at sun.misc.Unsafe.park(Native Method)\r\n            at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\r\n            at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedNanos(AbstractQueuedSynchronizer.java:1037)\r\n            at java.util.concurrent.locks.AbstractQueuedSynchronizer.tryAcquireSharedNanos(AbstractQueuedSynchronizer.java:1328)\r\n            at java.util.concurrent.Semaphore.tryAcquire(Semaphore.java:409)\r\n            at org.elasticsearch.xpack.ccr.FollowerFailOverIT.lambda$testFailOverOnFollower$0(FollowerFailOverIT.java:73)\r\n            at org.elasticsearch.xpack.ccr.FollowerFailOverIT$$Lambda$3513/1225697012.run(Unknown Source)\r\n            at java.lang.Thread.run(Thread.java:748)\r\n        at __randomizedtesting.SeedInfo.seed([ECB3C06592940245]:0)\r\n```\r\n\r\nWith lots of these in the logs:\r\n\r\n```\r\n  1> [2020-07-01T07:59:13,153][WARN ][o.e.i.c.IndicesClusterStateService] [follower5] [follower_test_failover][0] marking and sending shard failed due to [failed recovery]\r\n  1> org.elasticsearch.indices.recovery.RecoveryFailedException: [follower_test_failover][0]: Recovery failed on {follower5}{wUxLqhZNQ3iWFQc86r0ZjA}{BMnTibr8QkWZJp8IlUhz_w}{127.0.0.1}{127.0.0.1:35485}{d}{xpack.installed=true}\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.lambda$executeRecovery$21(IndexShard.java:2663) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onFailure(ActionListener.java:71) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.StoreRecovery.lambda$recoveryListener$6(StoreRecovery.java:362) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onFailure(ActionListener.java:71) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.StoreRecovery.lambda$restore$8(StoreRecovery.java:484) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onFailure(ActionListener.java:71) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.xpack.ccr.repository.CcrRepository.lambda$restoreShard$1(CcrRepository.java:324) ~[main/:?]\r\n  1> \tat org.elasticsearch.action.ActionListener$2.onFailure(ActionListener.java:94) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListener$6.onFailure(ActionListener.java:292) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.xpack.ccr.repository.CcrRepository.restoreShard(CcrRepository.java:386) ~[main/:?]\r\n  1> \tat org.elasticsearch.index.shard.StoreRecovery.lambda$restore$10(StoreRecovery.java:507) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ListenableFuture$1.doRun(ListenableFuture.java:112) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.EsExecutors$DirectExecutorService.execute(EsExecutors.java:226) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ListenableFuture.notifyListener(ListenableFuture.java:106) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ListenableFuture.addListener(ListenableFuture.java:68) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.StepListener.whenComplete(StepListener.java:78) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:507) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:290) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1890) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$17(IndexShard.java:2610) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) [elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:710) [elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_231]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_231]\r\n  1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_231]\r\n  1> Caused by: org.elasticsearch.index.shard.IndexShardRecoveryException: failed recovery\r\n  1> \t... 26 more\r\n  1> Caused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: restore failed\r\n  1> \t... 24 more\r\n  1> Caused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: failed to restore snapshot [_latest_/_latest_]\r\n  1> \t... 22 more\r\n  1> Caused by: java.lang.IllegalArgumentException: this node does not have the remote_cluster_client role\r\n  1> \tat org.elasticsearch.transport.RemoteClusterService.getRemoteClusterClient(RemoteClusterService.java:450) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.client.node.NodeClient.getRemoteClusterClient(NodeClient.java:123) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.xpack.ccr.repository.CcrRepository.getRemoteClusterClient(CcrRepository.java:166) ~[main/:?]\r\n  1> \tat org.elasticsearch.xpack.ccr.repository.CcrRepository.restoreShard(CcrRepository.java:336) ~[main/:?]\r\n  1> \t... 18 more\r\n```\r\n","closed_by":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}