{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14538","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14538/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14538/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14538/events","html_url":"https://github.com/elastic/elasticsearch/issues/14538","id":115171560,"node_id":"MDU6SXNzdWUxMTUxNzE1NjA=","number":14538,"title":"Highlighter causing overflow of boolean max clause count","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-11-04T23:15:04Z","updated_at":"2016-11-25T15:09:09Z","closed_at":"2016-11-25T15:09:09Z","author_association":"MEMBER","active_lock_reason":null,"body":"The following appears to be the case where the wildcard query (in this case, entered by a Kibana user) caused enough Lucene rewrites so that it overflows the boolean max clause count of 1024 by default.  While we could potentially workaround this by increasing the max clause count in Lucene/ES, it is not the ideal workaround given the memory implications.    \n\nThis appears to be a highlighter issue based on the stack.  Not sure if the highlighter honors these rewrite settings (https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-term-rewrite.html) ... Is there any safeguard that can be configured to prevent the highlighter from causing the great number of bool queries that is being generated?\n\n```\n[indices:data/read/search[phase/fetch/id]] \nCaused by: org.elasticsearch.search.fetch.FetchPhaseExecutionException: [logstash-2015.11.03][9]: query[filtered(+host:* +(message:20151103) +(message:main) +(message:dialer))->BooleanFilter(+cache(@timestamp:[1446555600000 TO 1446574259999]))],from[0],size[1000],sort[<custom:\"@timestamp\": org.elasticsearch.index.fielddata.fieldcomparator.LongValuesComparatorSource@69646af6>!]: Fetch Failed [Failed to highlight field [message]] \nat org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:134) \nat org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:133) \nat org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:194) \nat org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:516) \nat org.elasticsearch.search.action.SearchServiceTransportAction$FetchByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:868) \nat org.elasticsearch.search.action.SearchServiceTransportAction$FetchByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:862) \nat org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.doRun(MessageChannelHandler.java:279) \nat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36) \nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) \nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) \nat java.lang.Thread.run(Thread.java:745) \nCaused by: org.apache.lucene.search.BooleanQuery$TooManyClauses: maxClauseCount is set to 1024\nat org.apache.lucene.search.ScoringRewrite$1.checkMaxClauseCount(ScoringRewrite.java:72) \nat org.apache.lucene.search.ScoringRewrite$ParallelArraysTermCollector.collect(ScoringRewrite.java:149)\nat org.apache.lucene.search.TermCollectingRewrite.collectTerms(TermCollectingRewrite.java:79) \nat org.apache.lucene.search.ScoringRewrite.rewrite(ScoringRewrite.java:105) \nat org.apache.lucene.search.MultiTermQuery.rewrite(MultiTermQuery.java:288) \nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:217) \nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:99) \nat org.elasticsearch.search.highlight.CustomQueryScorer$CustomWeightedSpanTermExtractor.extractUnknownQuery(CustomQueryScorer.java:89) \nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:224) \nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getWeightedSpanTerms(WeightedSpanTermExtractor.java:474) \nat org.apache.lucene.search.highlight.QueryScorer.initExtractor(QueryScorer.java:217) \nat org.apache.lucene.search.highlight.QueryScorer.init(QueryScorer.java:186) \nat org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:197) \nat org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:120) \n... 10 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}