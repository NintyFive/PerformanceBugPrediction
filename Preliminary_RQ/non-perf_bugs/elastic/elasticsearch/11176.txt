{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11176","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11176/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11176/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11176/events","html_url":"https://github.com/elastic/elasticsearch/issues/11176","id":76623256,"node_id":"MDU6SXNzdWU3NjYyMzI1Ng==","number":11176,"title":"Terms agg fails with medium-large \"exclude\" clause lists","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2015-05-15T06:54:17Z","updated_at":"2015-05-15T18:40:59Z","closed_at":"2015-05-15T18:21:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"A `terms` agg with an `exclude` arrray of medium size (in my case, 86 strings) was sufficient to cause this error:\n\n```\nCaused by: org.apache.lucene.util.automaton.TooComplexToDeterminizeException: Determinizing automaton would result in more than 10000 states.\n    at org.apache.lucene.util.automaton.Operations.determinize(Operations.java:743)\n    at org.apache.lucene.util.automaton.RunAutomaton.<init>(RunAutomaton.java:138)\n    at org.apache.lucene.util.automaton.ByteRunAutomaton.<init>(ByteRunAutomaton.java:32)\n    at org.apache.lucene.util.automaton.ByteRunAutomaton.<init>(ByteRunAutomaton.java:27)\n    at org.elasticsearch.search.aggregations.bucket.terms.support.IncludeExclude$StringFilter.<init>(IncludeExclude.java:88)\n```\n\nExample query: \n\n```\n{\n    \"query\": {\n        ...\n    },\n    \"aggs\": {\n        \"sample\": {\n            \"sampler\": {\n                \"shard_size\": 100\n            },\n            \"aggs\": {\n                \"suggestions\": {\n                    \"terms\": {\n                        \"field\": \"links\",\n                        \"exclude\": [\n                            \"Triangle-free graph\",\n                            \"Digraph (mathematics)\",\n                            \"Clique (graph theory)\",\n                            \"K-vertex-connected graph\",\n                            \"Connected graph\",\n                            \"Semi-symmetric graph\",\n                            \"Complement (graph theory)\",\n                            \"Tournament (graph theory)\",\n                            \"Tree (graph theory)\",\n                            \"Degree (graph theory)\",\n                            \"Node (graph theory)\",\n                            \"Heawood graph\",\n                            \"Cycle graph\",\n                            \"Cage graph\",\n                            \"Star (graph theory)\",\n                            \"Hoffmanâ€“Singleton graph\",\n                            \"Edge (graph theory)\",\n                            \"Shrikhande graph\",\n                            \"Cubic graph\",\n                            \"Cycle (graph theory)\",\n                            \"Trees (graph theory)\",\n                            \"Directed graph\",\n                            \"Moore graph\",\n                            \"Graph homomorphism\",\n                            \"Hamiltonian graph\",\n                            \"Regular graph\",\n                            \"Vertex (graph theory)\",\n                            \"Minor (graph theory)\",\n                            \"Harries graph\",\n                            \"Complement graph\",\n                            \"K-edge-connected graph\",\n                            \"Okapi BM25\",\n                            \"Controlled vocabularies\",\n                            \"Document retrieval\",\n                            \"Recall (information retrieval)\",\n                            \"C. J. van Rijsbergen\",\n                            \"Subject indexing\",\n                            \"Enterprise Search\",\n                            \"Natural Language Processing\",\n                            \"Information Retrieval\",\n                            \"Relevance\",\n                            \"SMART Information Retrieval System\",\n                            \"Text mining\",\n                            \"Inverse document frequency\",\n                            \"Ranking functions\",\n                            \"Binary classification\",\n                            \"Enterprise search\",\n                            \"Document classification\",\n                            \"SIGIR\",\n                            \"Query language\",\n                            \"Gerard Salton\",\n                            \"Gain (information retrieval)\",\n                            \"Relevance (information retrieval)\",\n                            \"Text Retrieval Conference\",\n                            \"Compound term processing\",\n                            \"Latent semantic indexing\",\n                            \"Query expansion\",\n                            \"Information retrieval#Recall\",\n                            \"Vector Space Model\",\n                            \"Stop words\",\n                            \"Search engine\",\n                            \"Index (search engine)\",\n                            \"Tf-idf\",\n                            \"Precision and recall\",\n                            \"Query\",\n                            \"Precision (information retrieval)\",\n                            \"Latent semantic analysis\",\n                            \"Summary statistics for contingency tables\",\n                            \"Term frequency\",\n                            \"Text retrieval\",\n                            \"Natural language processing\",\n                            \"Inverted index\",\n                            \"Standard Boolean model\",\n                            \"Question answering\",\n                            \"Search engine indexing\",\n                            \"Rocchio Classification\",\n                            \"Jaccard index\",\n                            \"Searching\",\n                            \"Ranking function\",\n                            \"Information retrieval\",\n                            \"Relevance feedback\",\n                            \"Special Interest Group on Information Retrieval\",\n                            \"Information need\",\n                            \"Gerard Salton Award\",\n                            \"Vector space model\",\n                            \"Automatic summarization\"\n                        ]\n                    }\n                }\n            }\n        }\n    },\n    \"size\": 1\n}\n```\n\nI can see how consulting large sets of terms can be expensive and we might want to cap it but in the above case this risk is mitigated through the use of the \"sampler\" agg to consider a maxiumum of 100 top-matching docs.\n\nThe use case for this type of query is looking for new terms outside of a set that has already been gathered by the client eg aiding graph exploration by looking for connections beyond what you already have collected:\n\n![excludebug](https://cloud.githubusercontent.com/assets/170925/7648108/a023170e-fad6-11e4-81fd-1ed43f7a3a6d.png)\n\nThese sorts of exclude lists can grow large so a cap of around 85 terms seems low for this use case.\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}