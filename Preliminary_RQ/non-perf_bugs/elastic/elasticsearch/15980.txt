{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15980","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15980/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15980/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15980/events","html_url":"https://github.com/elastic/elasticsearch/issues/15980","id":126641462,"node_id":"MDU6SXNzdWUxMjY2NDE0NjI=","number":15980,"title":"Java Client ES 2.1 Java Hash Map key removal","user":{"login":"sergiodaia","id":2794823,"node_id":"MDQ6VXNlcjI3OTQ4MjM=","avatar_url":"https://avatars2.githubusercontent.com/u/2794823?v=4","gravatar_id":"","url":"https://api.github.com/users/sergiodaia","html_url":"https://github.com/sergiodaia","followers_url":"https://api.github.com/users/sergiodaia/followers","following_url":"https://api.github.com/users/sergiodaia/following{/other_user}","gists_url":"https://api.github.com/users/sergiodaia/gists{/gist_id}","starred_url":"https://api.github.com/users/sergiodaia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergiodaia/subscriptions","organizations_url":"https://api.github.com/users/sergiodaia/orgs","repos_url":"https://api.github.com/users/sergiodaia/repos","events_url":"https://api.github.com/users/sergiodaia/events{/privacy}","received_events_url":"https://api.github.com/users/sergiodaia/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2016-01-14T12:03:38Z","updated_at":"2016-01-14T17:24:34Z","closed_at":"2016-01-14T13:30:06Z","author_association":"NONE","active_lock_reason":null,"body":"In my java project i use several java objects which contain java HashMaps among other fields. All serialization is performed correctly up the java client comunication with the node but something goes wrong upon key removal.  Everytime i remove a key from a java HashMap the key removal is not reflected on the stored document. Adding or updating keys on the java HashMap is performed correctly. Furthermore, interacting directly with the ES APIs won't result in this bug. Everything is ok.\n\nSo my best guess is that the java client detects a NoOp on the update request after i remove i json property although this happens only for properties derived from hashmaps. I'd exclude the Jackson Object Mapper fault since the generated json is correct.\n\nWhat am i doing wrong?\n\nI wrote a simple java testcase to show this behaviour\n\n``` java\n\n\n        //create an object mapper\n        mapper = new ObjectMapper();\n        mapper.configure(Feature.WRITE_DATES_AS_TIMESTAMPS, true);\n        mapper.configure(DeserializationConfig.Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n        mapper.configure(SerializationConfig.Feature.REQUIRE_SETTERS_FOR_GETTERS, true);\n\n        //create a hashmap with one key\n        Map<String,String> map = new HashMap<String,String>();\n        map.put(\"key\", \"value\");\n\n        //index the document\n        //sent json is: '{\"key\":\"value\"}'\n        this.client.prepareIndex(\"restaurants\", \"Restaurant\", \"id1\")\n        .setSource(mapper.writeValueAsString(map)).execute().actionGet();\n\n        //remove the key from map and update the document\n        //sent json is: '{}'\n        map.remove(\"key\");\n        this.client.prepareUpdate(\"restaurants\", \"Restaurant\", \"id1\")\n        .setDoc(mapper.writeValueAsString(map)).execute().actionGet();\n\n        //retrieve the document, no key expected  \n        //returned json is: '{\"key\":\"value\"}'\n        GetResponse response = this.client.prepareGet(\"restaurants\", \"Restaurant\", \"id1\").execute()\n        .actionGet();\n\n        //test fails\n        Map<String,String> updatedMap = mapper.readValue(response.getSourceAsString(), new HashMap<String,String>().getClass());\n        assertTrue(!updatedMap.containsKey(\"key\"));\n```\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}