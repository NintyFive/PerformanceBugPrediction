{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8630","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8630/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8630/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8630/events","html_url":"https://github.com/elastic/elasticsearch/issues/8630","id":49878881,"node_id":"MDU6SXNzdWU0OTg3ODg4MQ==","number":8630,"title":"Aggregate terms sum of array data getting wrong result ","user":{"login":"sreejithsrk","id":5036271,"node_id":"MDQ6VXNlcjUwMzYyNzE=","avatar_url":"https://avatars2.githubusercontent.com/u/5036271?v=4","gravatar_id":"","url":"https://api.github.com/users/sreejithsrk","html_url":"https://github.com/sreejithsrk","followers_url":"https://api.github.com/users/sreejithsrk/followers","following_url":"https://api.github.com/users/sreejithsrk/following{/other_user}","gists_url":"https://api.github.com/users/sreejithsrk/gists{/gist_id}","starred_url":"https://api.github.com/users/sreejithsrk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sreejithsrk/subscriptions","organizations_url":"https://api.github.com/users/sreejithsrk/orgs","repos_url":"https://api.github.com/users/sreejithsrk/repos","events_url":"https://api.github.com/users/sreejithsrk/events{/privacy}","received_events_url":"https://api.github.com/users/sreejithsrk/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-11-24T11:17:43Z","updated_at":"2015-02-28T04:51:36Z","closed_at":"2015-02-28T04:51:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\nI have data like follows\n\n```\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"index_testing\",\n      \"_type\" : \"status\",\n      \"_id\" : \"535733748264759296\",\n      \"_score\" : 1.0,\n      \"_source\":{\"text\":\"sreejith testing big data , testing smap, testing ES\",\"link\":[],\"hashtag\":[],\"senti_data\":[{\"count\":1,\"sentiment_score\":0,\"word\":\"data\"},{\"count\":3,\"sentiment_score\":0,\"word\":\"testing\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"big\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"sreejith\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"es\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"smap\"}],\"truncated\":false,\"SentimentScore\":1,\"Sentiment\":\"positive\",\"source\":\"<a href=\\\"http://twitter.com\\\" rel=\\\"nofollow\\\">Twitter Web Client</a>\",\"gender\":\"female\",\"retweet_count\":0,\"created_at\":\"2014-11-21T09:57:33.000Z\",\"mention\":[],\"language\":\"en\",\"user\":{\"id\":166819950,\"profile_image_url_https\":\"https://pbs.twimg.com/profile_images/458931356345434112/KkMSDG_P_normal.jpeg\",\"location\":\"\",\"description\":\"am what am... :P\",\"name\":\"Sreejith\",\"screen_name\":\"sreejithsga\",\"profile_image_url\":\"http://pbs.twimg.com/profile_images/458931356345434112/KkMSDG_P_normal.jpeg\"}}\n    }, {\n      \"_index\" : \"index_testing\",\n      \"_type\" : \"status\",\n      \"_id\" : \"535733934550577152\",\n      \"_score\" : 1.0,\n      \"_source\":{\"text\":\"sreejith testing hadoop\",\"link\":[],\"hashtag\":[],\"senti_data\":[{\"count\":1,\"sentiment_score\":0,\"word\":\"hadoop\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"testing\"},{\"count\":1,\"sentiment_score\":0,\"word\":\"sreejith\"}],\"truncated\":false,\"SentimentScore\":-1,\"Sentiment\":\"negative\",\"source\":\"<a href=\\\"http://twitter.com\\\" rel=\\\"nofollow\\\">Twitter Web Client</a>\",\"gender\":\"female\",\"retweet_count\":0,\"created_at\":\"2014-11-21T09:58:18.000Z\",\"mention\":[],\"language\":\"en\",\"user\":{\"id\":166819950,\"profile_image_url_https\":\"https://pbs.twimg.com/profile_images/458931356345434112/KkMSDG_P_normal.jpeg\",\"location\":\"\",\"description\":\"am what am... :P\",\"name\":\"Sreejith\",\"screen_name\":\"sreejithsga\",\"profile_image_url\":\"http://pbs.twimg.com/profile_images/458931356345434112/KkMSDG_P_normal.jpeg\"}}\n    } ]\n  }\n}\n```\n\nI tried the following query \n\n```\nPOST http://localhost:9200/index_testing/_search -d'\n{\n            \"query\": {\n              \"query_string\": {\n                 \"default_field\" : \"text\",\n                 \"query\" :  \"testing\"\n              }\n\n            },\n             \"filter\": {\n                \"exists\": {\n                  \"field\": \"senti_data\"\n                }\n            },\n            \"sort\": [\n               {\n                  \"created_at\": {\n                     \"order\": \"desc\"\n                  }\n               }\n            ],\n           \"aggs\": {\n                \"prod_type\": {\n                    \"terms\": {\n                        \"field\": \"senti_data.word\"\n                    },\n                    \"aggs\": {\n                        \"count\": {\n                            \"sum\": {\n                                \"field\": \"senti_data.count\"\n                            }\n                        }\n                    }\n                }\n            },\n            \"size\": 0\n\n\n\n}'\n```\n\nwhile running this query am getting the following result\n\n```\n{\n   \"took\": 6,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 1,\n      \"successful\": 1,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"prod_type\": {\n         \"buckets\": [\n            {\n               \"key\": \"sreejith\",\n               \"doc_count\": 2,\n               \"count\": {\n                  \"value\": 5\n               }\n            },\n            {\n               \"key\": \"testing\",\n               \"doc_count\": 2,\n               \"count\": {\n                  \"value\": 5\n               }\n            },\n            {\n               \"key\": \"big\",\n               \"doc_count\": 1,\n               \"count\": {\n                  \"value\": 4\n               }\n            },\n            {\n               \"key\": \"data\",\n               \"doc_count\": 1,\n               \"count\": {\n                  \"value\": 4\n               }\n            },\n            {\n               \"key\": \"es\",\n               \"doc_count\": 1,\n               \"count\": {\n                  \"value\": 4\n               }\n            },\n            {\n               \"key\": \"hadoop\",\n               \"doc_count\": 1,\n               \"count\": {\n                  \"value\": 1\n               }\n            },\n            {\n               \"key\": \"smap\",\n               \"doc_count\": 1,\n               \"count\": {\n                  \"value\": 4\n               }\n            }\n         ]\n      }\n   }\n}\n```\n\nIssue found \nit returns the incorrect  aggregate sum of \"count\"  \n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}