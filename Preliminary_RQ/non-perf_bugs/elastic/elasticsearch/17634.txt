{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17634","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17634/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17634/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17634/events","html_url":"https://github.com/elastic/elasticsearch/issues/17634","id":147056738,"node_id":"MDU6SXNzdWUxNDcwNTY3Mzg=","number":17634,"title":"Packaging tests fail and package installation is dependent on user's umask","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-04-08T22:38:57Z","updated_at":"2020-11-11T21:58:44Z","closed_at":"2016-04-21T19:27:27Z","author_association":"MEMBER","active_lock_reason":null,"body":"When running the packages on my development machines, they fail due to incorrect expected permissions, for example, my `umask` permissions are 002, which means that directories are created with 775 permissions, however, our tests compare the directories from the _user_ with the ones generated by a _root_ install, which has a different umask (022).\n\nThus, you get:\n\n```\n# Expected privileges: 775, found 755\nnot ok 10 [TAR PLUGINS] install jvm-example plugin with a custom CONFIG_DIR\n# (from function `assert_file' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/packaging_test_utils.bash, line 181,\n#  from function `install_jvm_example' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/plugins.bash, line 87,\n#  in test file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/25_tar_plugins.bats, line 143)\n#   `CONF_DIR=\"$ESCONFIG\" install_jvm_example' failed\n```\n\nAnd\n\n```\n# Expected privileges: 644, found 664\nnot ok 27 [TAR PLUGINS] check lang-expression module\n# (from function `assert_file' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/packaging_test_utils.bash, line 181,\n#  from function `assert_module_or_plugin_file' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/packaging_test_utils.bash, line 208,\n#  from function `check_module' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/modules.bash, line 35,\n#  from function `check_secure_module' in file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/modules.bash, line 43,\n#  in test file /elasticsearch/qa/vagrant/src/test/resources/packaging/scripts/25_tar_plugins.bats, line 242)\n#   `check_secure_module lang-expression antlr4-runtime-*.jar asm-5.0.4.jar asm-commons-*.jar asm-tree-*.jar lucene-expressions-*.jar' failed\n# Should exist: /tmp/elasticsearch/modules/lang-expression\n```\n\n(and many others)\n\nI think there are multiple options for fixing this:\n1. Set the umask bats will expect in the tests before these tests are run\n2. Change the tests to hardcode the correct \"expected\" permissions instead of\n   inferring them from the user's directory\n3. Change our packaging to set the permissions correctly instead of relying on\n   umask\n\nPersonally, I think we should go with number 3.\n\nNumber 1 I'm not actually sure would work, I haven't tested it, but we would be\nfooling ourselves if anyone actually changed their umask in the field.\n\nNumber 2 would be semi-okay, but again, if the umask changes or a user installs\nthe package as non-root (yes, with `dpkg --force-not-root`) the permissions will\nbe different because root's umask will not be used.\n\nI really don't like the variance of number 1 and number 2, we have a lot of\nchecks to tell users when their settings may be wrong, this is a situation where\nwe should set the permissions to the exact values they should be to prevent\nunintended errors. Hence, I believe we should go with number 3.\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}