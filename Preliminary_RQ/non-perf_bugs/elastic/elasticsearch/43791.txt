{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43791","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43791/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43791/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43791/events","html_url":"https://github.com/elastic/elasticsearch/issues/43791","id":462324806,"node_id":"MDU6SXNzdWU0NjIzMjQ4MDY=","number":43791,"title":"org.elasticsearch.common.settings.Settings.processSetting causes \"GET /_cluster/settings/\" throwing ClassCastException","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":144457604,"node_id":"MDU6TGFiZWwxNDQ0NTc2MDQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Settings","name":":Core/Infra/Settings","color":"0e8a16","default":false,"description":"Settings infrastructure and APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-06-29T17:53:00Z","updated_at":"2019-08-01T17:28:15Z","closed_at":"2019-08-01T17:28:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES_VERSION: 5.6.8 (all likely in all version)\r\nJVM version : JDK1.8.0_112\r\nOS version : linux\r\nDescription of the problem including expected versus actual behavior:\r\nFirstly I push several cluster settings to cluster twice:\r\nstep 1:\r\n```\r\nPUT /_cluster/settings\r\n{\r\n    \"transient\": {\r\n        \"logger.org.elasticsearch\" :\"info\",\r\n        \"logger.org.elasticsearch.transport.netty\":\"ERROR\"\r\n    }\r\n}\r\n```\r\nstep 2:\r\n```\r\nPUT /_cluster/settings\r\n{\r\n    \"transient\": {\r\n        \"logger.org.transport.netty\":\"ERROR\"\r\n    }\r\n}\r\n```\r\nit is executed successfully(those may be don't work, which we ignore)\r\nSecondly I want to see the settings by \"GET /_cluster/settings\", What is surprising is that, it throws Exception:\r\n```\r\n      \"root_cause\": [\r\n         {\r\n            \"type\": \"class_cast_exception\",\r\n            \"reason\": \"java.lang.String cannot be cast to java.util.Map\"\r\n         }\r\n      ]\r\n```\r\n\r\nRelated logs on es server:\r\n```\r\n[WARN ][r.suppressed             ] path: /_cluster/settings, params: {pretty=}\r\njava.lang.ClassCastException: java.lang.String cannot be cast to java.util.Map\r\n        at org.elasticsearch.common.settings.Settings.processSetting(Settings.java:146) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.common.settings.Settings.processSetting(Settings.java:166) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.common.settings.Settings.processSetting(Settings.java:166) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.common.settings.Settings.processSetting(Settings.java:166) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.common.settings.Settings.getAsStructuredMap(Settings.java:131) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.common.settings.Settings.toXContent(Settings.java:625) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.admin.cluster.RestClusterGetSettingsAction.renderResponse(RestClusterGetSettingsAction.java:90) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.admin.cluster.RestClusterGetSettingsAction.access$000(RestClusterGetSettingsAction.java:43) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.admin.cluster.RestClusterGetSettingsAction$1.buildResponse(RestClusterGetSettingsAction.java:66) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.admin.cluster.RestClusterGetSettingsAction$1.buildResponse(RestClusterGetSettingsAction.java:63) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.RestBuilderListener.buildResponse(RestBuilderListener.java:38) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n        at org.elasticsearch.rest.action.RestResponseListener.processResponse(RestResponseListener.java:37) ~[elasticsearch-5.6.8.jar:5.6.8]\r\n```\r\nAccord to those logs, I knew that there may be some thing wrong in Function `processSetting`, then i tested it such as:\r\n```\r\nprocessSetting(map, \"\", \"logger.org.elasticsearch\", \"info\");\r\nprocessSetting(map, \"\", \"logger.org.elasticsearch.transport.netty4\", \"ERROR\");\r\nprocessSetting(map, \"\", \"logger.org.transport.netty4\", \"ERROR\");\r\n```\r\nand it threw the exception as I mentioned above.\r\nReson: I find that code in https://github.com/elastic/elasticsearch/blob/674f7dc44c483ed55330144600618a7d220ede05/core/src/main/java/org/elasticsearch/common/settings/Settings.java#L161 and https://github.com/elastic/elasticsearch/blob/674f7dc44c483ed55330144600618a7d220ede05/core/src/main/java/org/elasticsearch/common/settings/Settings.java#L167 cause that bug, maybe it needs to be revised like this:\r\n```\r\nmap.put(prefix + key, newMap); //L161\r\nmap.put(prefix + key, innerMap);//L167\r\n```\r\nthen the bug is solved.","closed_by":{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false},"performed_via_github_app":null}