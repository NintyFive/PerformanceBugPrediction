{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30237","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30237/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30237/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30237/events","html_url":"https://github.com/elastic/elasticsearch/issues/30237","id":318732175,"node_id":"MDU6SXNzdWUzMTg3MzIxNzU=","number":30237,"title":"Ability to delete deleted documents","user":{"login":"antonpious","id":15054021,"node_id":"MDQ6VXNlcjE1MDU0MDIx","avatar_url":"https://avatars3.githubusercontent.com/u/15054021?v=4","gravatar_id":"","url":"https://api.github.com/users/antonpious","html_url":"https://github.com/antonpious","followers_url":"https://api.github.com/users/antonpious/followers","following_url":"https://api.github.com/users/antonpious/following{/other_user}","gists_url":"https://api.github.com/users/antonpious/gists{/gist_id}","starred_url":"https://api.github.com/users/antonpious/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antonpious/subscriptions","organizations_url":"https://api.github.com/users/antonpious/orgs","repos_url":"https://api.github.com/users/antonpious/repos","events_url":"https://api.github.com/users/antonpious/events{/privacy}","received_events_url":"https://api.github.com/users/antonpious/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-04-29T16:57:49Z","updated_at":"2018-05-01T09:04:54Z","closed_at":"2018-05-01T09:04:54Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\nThere should be a way to delete all deleted documents by having the other details constant.\r\n\r\nDue to the immutability of a segment in Lucene, the current way for a document that is updated is to keep the existing document in the segment in which it was created and to put the updated document in a new segment. Over the period of time if this continues the number of deleted documents grows significantly. The similar is the case of documents which are deleted which unfortunately is very less.\r\n\r\nThe cluster tries to control the optimum segment count by its own algorithm which currently is not explicitly based on deleted document size. The segment count is also optimized for what the cluster feels should be the segment count of the index for efficient read and write.\r\n\r\nWhat is needed is to delete only the deleted documents which is unfortunately tied to reducing the segment count which would eventually remove the deleted document which are there in the segment. This would also expose large segments when segments are merged as well as no control on how many deleted documents should be cleaned and its random. The only way to recover space for all deleted documents is to force merge to 1 segment which if the cluster felt is the right way it should have done it. The cluster never has this logic of force merging to only 1 segment so why should the customer be told to do force merge to 1 segment to remove deleted documents.\r\n\r\nThe way it should work is to give a specific API to clean deleted documents. It should do just that.\r\n\r\nThe migrate API is doing the deleted documents correctly and should be the basis for this feature. The migrate API copies all the data from one index to the other by doesn't copy the deleted documents. So the delete api should be based on this, keep existing segment counts as it is but copy over only the current documents\r\n\r\n<!-- Bug report -->\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}