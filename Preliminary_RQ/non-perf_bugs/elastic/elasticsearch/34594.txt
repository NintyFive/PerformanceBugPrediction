{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34594","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34594/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34594/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34594/events","html_url":"https://github.com/elastic/elasticsearch/issues/34594","id":371536219,"node_id":"MDU6SXNzdWUzNzE1MzYyMTk=","number":34594,"title":"elasticsearch search dsl translated from sql can't working","user":{"login":"chineseabacus","id":5484327,"node_id":"MDQ6VXNlcjU0ODQzMjc=","avatar_url":"https://avatars3.githubusercontent.com/u/5484327?v=4","gravatar_id":"","url":"https://api.github.com/users/chineseabacus","html_url":"https://github.com/chineseabacus","followers_url":"https://api.github.com/users/chineseabacus/followers","following_url":"https://api.github.com/users/chineseabacus/following{/other_user}","gists_url":"https://api.github.com/users/chineseabacus/gists{/gist_id}","starred_url":"https://api.github.com/users/chineseabacus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chineseabacus/subscriptions","organizations_url":"https://api.github.com/users/chineseabacus/orgs","repos_url":"https://api.github.com/users/chineseabacus/repos","events_url":"https://api.github.com/users/chineseabacus/events{/privacy}","received_events_url":"https://api.github.com/users/chineseabacus/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-10-18T13:40:50Z","updated_at":"2018-10-18T14:27:48Z","closed_at":"2018-10-18T14:27:48Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):  6.4.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\ntrying elasticsearch sql rest api on yelp dataset,\r\n\r\n```\r\nread -r -d '' sql <<'EOF'\r\n{\r\n        \"query\":\"select city, COUNT(*) AS c from \\\"yelp.business\\\" group by city\"\r\n}\r\nEOF\r\n\r\ncurl -v -XPOST \"http://$host/_xpack/sql?format=txt\" -H'Content-Type: application/json' -d\"$sql\"\r\n```\r\n\r\nget right response\r\n\r\n```\r\n            city            |       c\r\n----------------------------+---------------\r\nCleveland                   |2977\r\nCleveland Heights           |179\r\nCleveland Hghts.            |1\r\nEast Cleveland              |4\r\nMayfield Heights (Cleveland)|1\r\n\r\n```\r\n tranlsate sql to dsl\r\n```\r\n\r\nquery=`curl -v -XPOST \"http://$host/_xpack/sql/translate?format=json\" -H'Content-Type: application/json' -d\"$sql\"`\r\n\r\n{\r\n   \"_source\" : false,\r\n   \"size\" : 0,\r\n   \"aggregations\" : {\r\n      \"groupby\" : {\r\n         \"composite\" : {\r\n            \"sources\" : [\r\n               {\r\n                  \"2467\" : {\r\n                     \"terms\" : {\r\n                        \"order\" : \"asc\",\r\n                        \"field\" : \"city.keyword\",\r\n                        \"missing_bucket\" : false\r\n                     }\r\n                  }\r\n               }\r\n            ],\r\n            \"size\" : 1000\r\n         }\r\n      }\r\n   },\r\n   \"stored_fields\" : \"_none_\"\r\n}\r\n```\r\n, but get error if  execute search request with translated dsl\r\n```\r\ncurl -XGET \"http://$host/antkrill.event/_search\" -H 'Content-Type: application/json' -d\"$query\"\r\n```\r\n```\r\n{\r\n   \"status\" : 400,\r\n   \"error\" : {\r\n      \"type\" : \"search_phase_execution_exception\",\r\n      \"root_cause\" : [\r\n         {\r\n            \"index\" : \"antkrill.event\",\r\n            \"type\" : \"query_shard_exception\",\r\n            \"index_uuid\" : \"2x-HMb9-Q9WvVCZO7lqMNA\",\r\n            \"reason\" : \"failed to find field [city.keyword] and [missing_bucket] is not set\"\r\n         }\r\n      ],\r\n      \"failed_shards\" : [\r\n         {\r\n            \"index\" : \"antkrill.event\",\r\n            \"shard\" : 0,\r\n            \"node\" : \"GvQqqJKjT9ykp6QY6Qa2tA\",\r\n            \"reason\" : {\r\n               \"index\" : \"antkrill.event\",\r\n               \"type\" : \"query_shard_exception\",\r\n               \"index_uuid\" : \"2x-HMb9-Q9WvVCZO7lqMNA\",\r\n               \"reason\" : \"failed to find field [city.keyword] and [missing_bucket] is not set\"\r\n            }\r\n         }\r\n      ],\r\n      \"grouped\" : true,\r\n      \"reason\" : \"all shards failed\",\r\n      \"phase\" : \"query\"\r\n   }\r\n}\r\n\r\n```\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"chineseabacus","id":5484327,"node_id":"MDQ6VXNlcjU0ODQzMjc=","avatar_url":"https://avatars3.githubusercontent.com/u/5484327?v=4","gravatar_id":"","url":"https://api.github.com/users/chineseabacus","html_url":"https://github.com/chineseabacus","followers_url":"https://api.github.com/users/chineseabacus/followers","following_url":"https://api.github.com/users/chineseabacus/following{/other_user}","gists_url":"https://api.github.com/users/chineseabacus/gists{/gist_id}","starred_url":"https://api.github.com/users/chineseabacus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chineseabacus/subscriptions","organizations_url":"https://api.github.com/users/chineseabacus/orgs","repos_url":"https://api.github.com/users/chineseabacus/repos","events_url":"https://api.github.com/users/chineseabacus/events{/privacy}","received_events_url":"https://api.github.com/users/chineseabacus/received_events","type":"User","site_admin":false},"performed_via_github_app":null}