{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17019","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17019/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17019/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17019/events","html_url":"https://github.com/elastic/elasticsearch/issues/17019","id":139361594,"node_id":"MDU6SXNzdWUxMzkzNjE1OTQ=","number":17019,"title":"Cancellation of shard relocation does not work in 2.2.0","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-03-08T18:53:41Z","updated_at":"2016-03-15T13:16:25Z","closed_at":"2016-03-15T13:16:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**:\n\n```\n# elasticsearch --version\nVersion: 2.2.0, Build: 8ff36d1/2016-01-27T13:32:39Z, JVM: 1.8.0_72-internal\n```\n\n**JVM version**:\n\n```\n# java -version\nopenjdk version \"1.8.0_72-internal\"\nOpenJDK Runtime Environment (build 1.8.0_72-internal-b15)\nOpenJDK 64-Bit Server VM (build 25.72-b15, mixed mode)\n```\n\n**OS version**: Debian Jessie on kernel 4.1.3.\n\n**Description of the problem including expected versus actual behavior**:\n\n[Docs say](https://www.elastic.co/guide/en/elasticsearch/reference/current/delayed-allocation.html) that primary and replica have to have the same synch id in order to achieve immediate recovery and avoid costly relocation. I restart 1 node out of 8 and see that most of indices recover on remaining nodes, even though restarted node rejoined. Week old indices recover too. To be fair, it did not work for me on 1.7.3 either. #6069 is is closed, therefore I'm filing this issue.\n\n**Steps to reproduce**:\n1. Restart one node.\n2. Wait until node rejoins.\n\nExpected: immediate recovery for old indices, translog recovery for active indices. Nice and easy.\n\nActual: almost all (if not all) recover, active indices recover all data files (terabytes of them). Ingestion is suffering from backpressure, people notice delayed indexing and tell mean things about you. Sadness and disappointment.\n\nIt seems that some indices do not have `sync_id`. I tried checking sync IDs for old indices that were recovering and the field appeared.\n\nBefore:\n\n``` json\n[\n  {\n    \"routing\": {\n      \"state\": \"STARTED\",\n      \"primary\": true,\n      \"node\": \"hOM4Or2fTG-Do4ZkR9jIRQ\",\n      \"relocating_node\": null\n    },\n    \"commit\": {\n      \"id\": \"MJ19KOilFLcuYnGni1rE+A==\",\n      \"generation\": 81,\n      \"user_data\": {\n        \"translog_uuid\": \"OUU730pTTSOGk-07aJEMJw\",\n        \"translog_generation\": \"80\"\n      },\n      \"num_docs\": 62732221\n    },\n    \"shard_path\": {\n      \"state_path\": \"/disk/data6/es/main/main/nodes/0\",\n      \"data_path\": \"/disk/data6/es/main/main/nodes/0\",\n      \"is_custom_data_path\": false\n    }\n  },\n  {\n    \"routing\": {\n      \"state\": \"STARTED\",\n      \"primary\": false,\n      \"node\": \"yNaQ5IGARhGtu5FN8AvGUQ\",\n      \"relocating_node\": null\n    },\n    \"commit\": {\n      \"id\": \"4F6/8APNSb40wCqr89bs5g==\",\n      \"generation\": 82,\n      \"user_data\": {\n        \"translog_uuid\": \"GE4r0UDHTda2aLd-PwJ9Bg\",\n        \"translog_generation\": \"80\"\n      },\n      \"num_docs\": 62732221\n    },\n    \"shard_path\": {\n      \"state_path\": \"/disk/data5/es/main/main/nodes/0\",\n      \"data_path\": \"/disk/data5/es/main/main/nodes/0\",\n      \"is_custom_data_path\": false\n    }\n  }\n]\n```\n\nThen I do manual synched flush:\n\n```\n# curl -X POST -s http://myhost/myindex-2016.02.29/_flush/synced | jq .\n```\n\n``` json\n{\n  \"_shards\": {\n    \"total\": 2,\n    \"successful\": 2,\n    \"failed\": 0\n  },\n  \"www-nginx-error-2016.03.01\": {\n    \"total\": 2,\n    \"successful\": 2,\n    \"failed\": 0\n  }\n}\n```\n\nAfter:\n\n``` json\n[\n  {\n    \"routing\": {\n      \"state\": \"STARTED\",\n      \"primary\": true,\n      \"node\": \"hOM4Or2fTG-Do4ZkR9jIRQ\",\n      \"relocating_node\": null\n    },\n    \"commit\": {\n      \"id\": \"MJ19KOilFLcuYnGni3ExRw==\",\n      \"generation\": 82,\n      \"user_data\": {\n        \"translog_uuid\": \"OUU730pTTSOGk-07aJEMJw\",\n        \"sync_id\": \"AVNXkFKDdHUamVU5aCvy\",\n        \"translog_generation\": \"80\"\n      },\n      \"num_docs\": 62732221\n    },\n    \"shard_path\": {\n      \"state_path\": \"/disk/data6/es/main/main/nodes/0\",\n      \"data_path\": \"/disk/data6/es/main/main/nodes/0\",\n      \"is_custom_data_path\": false\n    }\n  },\n  {\n    \"routing\": {\n      \"state\": \"STARTED\",\n      \"primary\": false,\n      \"node\": \"yNaQ5IGARhGtu5FN8AvGUQ\",\n      \"relocating_node\": null\n    },\n    \"commit\": {\n      \"id\": \"4F6/8APNSb40wCqr8+yqgQ==\",\n      \"generation\": 83,\n      \"user_data\": {\n        \"translog_uuid\": \"GE4r0UDHTda2aLd-PwJ9Bg\",\n        \"sync_id\": \"AVNXkFKDdHUamVU5aCvy\",\n        \"translog_generation\": \"80\"\n      },\n      \"num_docs\": 62732221\n    },\n    \"shard_path\": {\n      \"state_path\": \"/disk/data5/es/main/main/nodes/0\",\n      \"data_path\": \"/disk/data5/es/main/main/nodes/0\",\n      \"is_custom_data_path\": false\n    }\n  }\n]\n```\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}