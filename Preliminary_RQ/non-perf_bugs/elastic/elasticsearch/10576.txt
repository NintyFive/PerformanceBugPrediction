{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10576","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10576/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10576/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10576/events","html_url":"https://github.com/elastic/elasticsearch/issues/10576","id":68151444,"node_id":"MDU6SXNzdWU2ODE1MTQ0NA==","number":10576,"title":"Circuit Breakers not triggering before OOM on a node","user":{"login":"wgodwin","id":11929096,"node_id":"MDQ6VXNlcjExOTI5MDk2","avatar_url":"https://avatars0.githubusercontent.com/u/11929096?v=4","gravatar_id":"","url":"https://api.github.com/users/wgodwin","html_url":"https://github.com/wgodwin","followers_url":"https://api.github.com/users/wgodwin/followers","following_url":"https://api.github.com/users/wgodwin/following{/other_user}","gists_url":"https://api.github.com/users/wgodwin/gists{/gist_id}","starred_url":"https://api.github.com/users/wgodwin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wgodwin/subscriptions","organizations_url":"https://api.github.com/users/wgodwin/orgs","repos_url":"https://api.github.com/users/wgodwin/repos","events_url":"https://api.github.com/users/wgodwin/events{/privacy}","received_events_url":"https://api.github.com/users/wgodwin/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2015-04-13T17:28:57Z","updated_at":"2015-08-26T19:29:57Z","closed_at":"2015-08-26T19:29:57Z","author_association":"NONE","active_lock_reason":null,"body":"I will have to prepare the logfile as it has some confidential information in it, but I will post the basic rundown of what is happening.\nOur situation is that the circuit breakers do not seem to keep us from throwing an OOM/\"stop-the-world\" GC event, causing the node(s) to become unresponsive and very quickly bringing down our cluster. We have seen this happen once a day for the last week. The little background I can give you without posting the log file is that it seems like a large query comes in and one node gets an OOM while the other nodes trigger the circuit breakers. It would be great if the OOM node would come back up and not bring down our cluster however that is not the case.  \n\nWe have 3 master nodes, 26 data only nodes and 1 client node in production.\n1. Can someone who has experimented with the circuit breakers give me some feedback as to why we are still getting OOMs related to a specific api request even if we set all 3 circuit breakers to 1%?\n2. Circuit Breakers seem to only work against single queries (not a single api request) which does not help much when it comes to an enterprise solution like ours. Is this a correct assumption? \n3. Is there anything I can do on each node to ensure that we avoid OOMs? \n- Change the max heap size? \n- Change to G1GC? \n- Change the setting index.cache.field.type to soft to allow for more aggressive GC? \n- Change the following JVM option settings CMSInitiatingOccupancyFraction and UseCMSInitiatingOccupancyOnly?\n\nCurrently we are running 1.4.2, \n\nEach of the data nodes is running 2 instances of ES, except the 3 master nodes and the single client node.\n\nEach data node box has 40  cores and 128GB of RAM, 28GB is allocated to the heap. Here are the settings in our yml file:\n\n```\nnode.master: false\nnode.data: true\nnode.max_local_storage_nodes: 2\nbootstrap.mlockall: true\ntransport.tcp.port: 9300\nhttp.port: 9200\nhttp.max_content_length: 400mb\ngateway.recover_after_nodes: 25\ngateway.recover_after_time: 1m\ngateway.expected_nodes: 29\ncluster.routing.allocation.node_concurrent_recoveries: 20\nindices.recovery.max_bytes_per_sec: 200mb\ndiscovery.zen.minimum_master_nodes: 2\ndiscovery.zen.ping.timeout: 3s\ndiscovery.zen.ping.multicast.enabled: false\ndiscovery.zen.ping.unicast.hosts: ['HM01:9300', 'HM02:9300', 'HM03:9300']\nindex.search.slowlog.threshold.query.warn: 10s\nindex.search.slowlog.threshold.query.info: 5s\nindex.search.slowlog.threshold.query.debug: 2s\nindex.search.slowlog.threshold.fetch.warn: 1s\nindex.search.slowlog.threshold.fetch.info: 800ms\nindex.search.slowlog.threshold.fetch.debug: 500ms\nindex.indexing.slowlog.threshold.index.warn: 10s\nindex.indexing.slowlog.threshold.index.info: 5s\nindex.indexing.slowlog.threshold.index.debug: 2s\nmonitor.jvm.gc.young.warn: 1000ms\nmonitor.jvm.gc.young.info: 700ms\nmonitor.jvm.gc.young.debug: 400ms\nmonitor.jvm.gc.old.warn: 10s\nmonitor.jvm.gc.old.info: 5s\nmonitor.jvm.gc.old.debug: 2s\naction.auto_create_index: .marvel-*\naction.disable_delete_all_indices: true\nindices.cache.filter.size: 15%\nindex.refresh_interval: -1\nthreadpool.search.type: fixed\nthreadpool.search.size: 48\nthreadpool.search.queue_size: 10000000\ncluster.routing.allocation.cluster_concurrent_rebalance: 6\nindices.store.throttle.type: none\nindex.reclaim_deletes_weight: 4.0\nindex.merge.policy.max_merge_at_once: 5\nindex.merge.policy.segments_per_tier: 5\nmarvel.agent.exporter.es.hosts: ['172.16.110.238:9200', '172.16.110.237:9200']\nmarvel.agent.enabled: true\nmarvel.agent.interval: 30s\nscript.disable_dynamic: false\n```\n\nPlease let me know if there are other settings you would like to see.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}