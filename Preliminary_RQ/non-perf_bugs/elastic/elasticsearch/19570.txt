{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19570","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19570/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19570/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19570/events","html_url":"https://github.com/elastic/elasticsearch/issues/19570","id":167319814,"node_id":"MDU6SXNzdWUxNjczMTk4MTQ=","number":19570,"title":"Upgrade repository type which is not accepted after 1.7","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2016-07-25T09:10:12Z","updated_at":"2017-09-12T17:05:44Z","closed_at":"2017-09-12T17:05:44Z","author_association":"MEMBER","active_lock_reason":null,"body":"Reported at https://discuss.elastic.co/t/s3-snapshot-repositories-not-working-after-upgrade-from-1-7-to-2-3/56214\n## Reproduction steps:\n- Start a new 1.7.5 node:\n\n``` sh\nbin/elasticsearch -Des.path.repo=/tmp\n```\n- Create a repository using type `FS`:\n\n```\ncurl -XPUT 'http://localhost:9200/_snapshot/my_backup' -d '{\n    \"type\": \"Fs\",\n    \"settings\": {\n        \"location\": \"/tmp\"\n    }\n}'\n```\n\nNote that we use `Fs` here. So the Class which is Loaded is `FsRepositoryModule`. \nIf we use `fs`, same class `FsRepositoryModule` is loaded. If we use `FS` it fails because class `FSRepositoryModule` does not exist.\n\nWhy is this important? In the context of S3 repositories, `S3` or `s3` will be allowed in 1.7 as they all try to load `S3RepositoryModule`: https://github.com/elastic/elasticsearch-cloud-aws/blob/es-1.7/src/main/java/org/elasticsearch/repositories/s3/S3RepositoryModule.java.\n- Stop 1.7.5 node\n- Move data dir to a new empty 2.3.3 node:\n\n``` sh\nmv elasticsearch-1.7.5/data elasticsearch-2.3.3\n```\n- Start 2.3.3 node:\n\n``` sh\nbin/elasticsearch -Des.path.repo=/tmp\n```\n\nIt fails with:\n\n```\n[2016-07-25 10:59:09,295][WARN ][repositories             ] [Kleinstocks] failed to create repository [my_backup]\nRepositoryException[[my_backup] failed to create repository]; nested: IllegalArgumentException[Unknown [repository] type [Fs]];\n    at org.elasticsearch.repositories.RepositoriesService.createRepositoryHolder(RepositoriesService.java:411)\n    at org.elasticsearch.repositories.RepositoriesService.clusterChanged(RepositoriesService.java:299)\n    at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:610)\n    at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalArgumentException: Unknown [repository] type [Fs]\n    at org.elasticsearch.common.util.ExtensionPoint$SelectedType.bindType(ExtensionPoint.java:146)\n    at org.elasticsearch.repositories.RepositoryTypesRegistry.bindType(RepositoryTypesRegistry.java:49)\n    at org.elasticsearch.repositories.RepositoryModule.configure(RepositoryModule.java:58)\n    at org.elasticsearch.common.inject.AbstractModule.configure(AbstractModule.java:60)\n    at org.elasticsearch.common.inject.spi.Elements$RecordingBinder.install(Elements.java:233)\n    at org.elasticsearch.common.inject.spi.Elements.getElements(Elements.java:105)\n    at org.elasticsearch.common.inject.InjectorShell$Builder.build(InjectorShell.java:143)\n    at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:99)\n    at org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:157)\n    at org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:55)\n    at org.elasticsearch.repositories.RepositoriesService.createRepositoryHolder(RepositoriesService.java:404)\n    ... 8 more\n```\n## Bug source\n\nFrom 2.x [we compare repository names](https://github.com/elastic/elasticsearch/blob/2.4/core/src/main/java/org/elasticsearch/repositories/RepositoriesService.java#L361) with what is defined in https://github.com/elastic/elasticsearch/blob/2.4/core/src/main/java/org/elasticsearch/repositories/fs/FsRepository.java#L51\n## How to solve this\n\nProposal 1: well, it's just about creating repositories so people are loosing any data if they have to recreate a repository from scratch.\n\n``` sh\ncurl -XPUT 'http://localhost:9200/_snapshot/my_backup'\n# Then create the repository with correct settings\n```\n\nWe should probably add this to the breaking changes and to the migration plugin.\n\nProposal 2: more complicated: automatically upgrade an existing repository which fails at startup with its lowercase form and write again this new version of the repository.\n\nThoughts?\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}