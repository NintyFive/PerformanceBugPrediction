{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39067","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39067/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39067/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39067/events","html_url":"https://github.com/elastic/elasticsearch/issues/39067","id":411595643,"node_id":"MDU6SXNzdWU0MTE1OTU2NDM=","number":39067,"title":"6.7 BWC layer for Java time formats in mappings does not default timezone to UTC","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1163688906,"node_id":"MDU6TGFiZWwxMTYzNjg4OTA2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.0","name":"v6.7.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-02-18T18:13:04Z","updated_at":"2019-02-19T13:11:53Z","closed_at":"2019-02-19T13:11:53Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It is documented that timestamps parsed by mappings that do not explicitly specify a timezone are considered to be UTC.  In the master branch this behaviour from the days of Joda time seems to have been preserved in the new Java time parsing.  However, in the 6.7 BWC layer trying to rely on the default of UTC timestamps parsed by mappings results in an exception.\r\n\r\nSteps to reproduce.\r\n\r\nFirst, to show it works as expected in master:\r\n\r\n* `git checkout master`\r\n* Start an ES test instance using `./gradlew run`\r\n* Run the following in a different terminal:\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT \"localhost:9200/with_tz\" -d '{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"my_time\": {\r\n        \"type\": \"date\",\r\n        \"format\": \"yyyy-MM-dd HH:mm:ssXX\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPOST \"localhost:9200/with_tz/_doc/1\" -d '{\r\n  \"my_time\": \"2018-02-18 17:47:17Z\"\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPUT \"localhost:9200/without_tz\" -d '{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"my_time\": {\r\n        \"type\": \"date\",\r\n        \"format\": \"yyyy-MM-dd HH:mm:ss\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPOST \"localhost:9200/without_tz/_doc/1\" -d '{\r\n  \"my_time\": \"2018-02-18 17:47:17\"\r\n}'\r\n```\r\n\r\n* Note that there are no exceptions and it is possible to index documents both with and without timezones in their timestamps when the Java 8 formats are set in the mappings.\r\n\r\nNow to show that things are different in 6.7 when Java 8 timestamp formats are used:\r\n\r\n* `git checkout 6.7`\r\n* Start an ES test instance using `./gradlew run`\r\n* Run the following in a different terminal:\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT \"localhost:9200/with_tz?include_type_name=false\" -d '{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"my_time\": {\r\n        \"type\": \"date\",\r\n        \"format\": \"8yyyy-MM-dd HH:mm:ssXX\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPOST \"localhost:9200/with_tz/_doc/1\" -d '{\r\n  \"my_time\": \"2018-02-18 17:47:17Z\"\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPUT \"localhost:9200/without_tz?include_type_name=false\" -d '{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"my_time\": {\r\n        \"type\": \"date\",\r\n        \"format\": \"8yyyy-MM-dd HH:mm:ss\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -H \"Content-Type: application/json\" -XPOST \"localhost:9200/without_tz/_doc/1\" -d '{\r\n  \"my_time\": \"2018-02-18 17:47:17\"\r\n}'\r\n```\r\n\r\n* The last command returns this error:\r\n\r\n```\r\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse field [my_time] of type [date] in document with id '1'\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse field [my_time] of type [date] in document with id '1'\",\"caused_by\":{\"type\":\"date_time_exception\",\"reason\":\"Unable to obtain Instant from TemporalAccessor: {},ISO resolved to 2018-02-18T17:47:17 of type java.time.format.Parsed\",\"caused_by\":{\"type\":\"unsupported_temporal_type_exception\",\"reason\":\"Unsupported field: InstantSeconds\"}}},\"status\":400}\r\n```\r\n\r\n* The ES log contains this error:\r\n\r\n```\r\n[elasticsearch] Caused by: java.time.temporal.UnsupportedTemporalTypeException: Unsupported field: InstantSeconds\r\n[elasticsearch]         at java.time.format.Parsed.getLong(Parsed.java:203) ~[?:?]\r\n[elasticsearch]         at java.time.Instant.from(Instant.java:373) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.common.time.DateFormatter.parseMillis(DateFormatter.java:51) ~[elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.index.mapper.DateFieldMapper$DateFieldType.parse(DateFieldMapper.java:246) ~[elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.index.mapper.DateFieldMapper.parseCreateField(DateFieldMapper.java:454) ~[elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:297) ~[elasticsearch-6.7.0-SNAPSHOT.jar:6.7.0-SNAPSHOT]\r\n[elasticsearch]         ... 42 more\r\n```\r\n\r\nUnless I'm making a silly mistake I think this is another bug that needs to be fixed before 6.7 GA because otherwise the Java 8 timestamp BWC layer is not robust enough to use for other components of the stack that need to work with many different timestamp formats.","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}