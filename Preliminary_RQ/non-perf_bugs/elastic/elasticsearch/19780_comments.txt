[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237511553","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237511553","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237511553,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzUxMTU1Mw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T10:10:39Z","updated_at":"2016-08-04T10:10:39Z","author_association":"MEMBER","body":"The cause of this is probably due to loading global ordinals. The time taken to load  global ordinals will increase as the cardinality of the field increases. The aggregator loads global ordinals when it is initialised (before starting to collect documents) and at this point the aggregator does not know whether there will be any matching documents for the query. Moving this loading to the collect phase would not be a great solution IMO as it would mean every document would incur the cost of checking whether we need to load global ordinals affecting the performance of collecting every document.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237514846","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237514846","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237514846,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzUxNDg0Ng==","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T10:25:47Z","updated_at":"2016-08-04T10:25:47Z","author_association":"CONTRIBUTOR","body":"It is also reasonably fast for cold indices. For yesterday's data:\n- 1ms (lowest) for low cardinality field with no matches\n- 200-400ms for high cardinality field with no matches\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237543141","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237543141","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237543141,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzU0MzE0MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T12:51:12Z","updated_at":"2016-08-04T12:51:12Z","author_association":"CONTRIBUTOR","body":"@bobrik what do you mean by your last comment?  What was different that time than the previous time that showed 10s?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237544569","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237544569","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237544569,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzU0NDU2OQ==","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T12:57:28Z","updated_at":"2016-08-04T12:57:28Z","author_association":"CONTRIBUTOR","body":"The difference is in freshness of data. 10s is for constantly updating current index, 200-400ms is for cold index with data from yesterday. Indices are rotated daily.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237545872","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237545872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237545872,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzU0NTg3Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T13:02:33Z","updated_at":"2016-08-04T13:02:33Z","author_association":"CONTRIBUTOR","body":"Ah OK - so then yes, this sounds like the cost of building global ordinals.  No way around this currently other than: (a) using eager global ordinals to build them as part of the refresh and (b) reducing the refresh time to build global ordinals as seldom as possible.\n\n@martijnvg is looking of ways to reduce the cost of global ordinal loading with frequent refreshes in Lucene, but that's probably a long way off.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237570517","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-237570517","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":237570517,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzU3MDUxNw==","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T14:29:53Z","updated_at":"2016-08-04T14:29:53Z","author_association":"CONTRIBUTOR","body":"@clintongormley, thanks. I enabled eager loading for the most offensive fields and with 200% CPU usage for flushes per node I can have faster searches. That's with 30s refresh intervals.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/325819455","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-325819455","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":325819455,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNTgxOTQ1NQ==","user":{"login":"jateenjoshi","id":1624229,"node_id":"MDQ6VXNlcjE2MjQyMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/1624229?v=4","gravatar_id":"","url":"https://api.github.com/users/jateenjoshi","html_url":"https://github.com/jateenjoshi","followers_url":"https://api.github.com/users/jateenjoshi/followers","following_url":"https://api.github.com/users/jateenjoshi/following{/other_user}","gists_url":"https://api.github.com/users/jateenjoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/jateenjoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jateenjoshi/subscriptions","organizations_url":"https://api.github.com/users/jateenjoshi/orgs","repos_url":"https://api.github.com/users/jateenjoshi/repos","events_url":"https://api.github.com/users/jateenjoshi/events{/privacy}","received_events_url":"https://api.github.com/users/jateenjoshi/received_events","type":"User","site_admin":false},"created_at":"2017-08-29T22:11:13Z","updated_at":"2017-08-29T22:11:13Z","author_association":"NONE","body":"@clintongormley - coming in quite late here. Couple of questions:\r\n\r\n1. Has the situation changed with making global ordinal loading faster in Lucene with newer versions of elasticsearch?\r\n\r\n2. I have had similar issues when using term aggregations. I've tried wrapping the term aggregation in a sampler aggregation and also separately, a filter aggregation. Both of them seem to have no effect on the slowness - is that expected?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/325917125","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-325917125","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":325917125,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNTkxNzEyNQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-08-30T08:13:54Z","updated_at":"2017-08-30T08:13:54Z","author_association":"MEMBER","body":"@jateenjoshi There may well have been improvements to the speed of loading global ordinals in more recent versions of Elasticsearch but for high cardinality fields it will probably still dominate the time taken to run these aggregations. Wrapping the terms aggregation in a sampler aggregation or a filter aggregation will unfortunately not work here since the global ordinals are not dependant on the number of terms matching the query but rather than number of terms in the shard (Lucene index) overall of that field. The global ordinals are built before we collect any matching documents so the time taken to load them is fixed (given a static index) no matter what the query or parent aggregations are.\r\n\r\nThe global ordinals only need to be loaded once and can then be used for all subsequent requests until the index changes (i.e. until a refresh is called). As @clintongormley says above, at the moment your only two options are to enable eager global ordinals so the cost of building global ordinals is incurred at the time the refresh is done rather than when the request is run, and/or you can increase the refresh interval so that you have to incur this cost less often.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/325919767","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-325919767","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":325919767,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNTkxOTc2Nw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-08-30T08:24:32Z","updated_at":"2017-08-30T08:24:32Z","author_association":"MEMBER","body":"Further to my comment above there is a change coming in Lucene 7.1 (https://issues.apache.org/jira/browse/LUCENE-7905) that will improve the speed of loading global ordinals. This should be available in Elasticsearch in one of the 6.x releases. However, although this will improve the speed of loading global ordinals it will not change the fact that global ordinals loading is the dominant part of these kinds of aggregation requests and so will not really change my advice from above.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329025899","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-329025899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":329025899,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTAyNTg5OQ==","user":{"login":"jateenjoshi","id":1624229,"node_id":"MDQ6VXNlcjE2MjQyMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/1624229?v=4","gravatar_id":"","url":"https://api.github.com/users/jateenjoshi","html_url":"https://github.com/jateenjoshi","followers_url":"https://api.github.com/users/jateenjoshi/followers","following_url":"https://api.github.com/users/jateenjoshi/following{/other_user}","gists_url":"https://api.github.com/users/jateenjoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/jateenjoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jateenjoshi/subscriptions","organizations_url":"https://api.github.com/users/jateenjoshi/orgs","repos_url":"https://api.github.com/users/jateenjoshi/repos","events_url":"https://api.github.com/users/jateenjoshi/events{/privacy}","received_events_url":"https://api.github.com/users/jateenjoshi/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T00:54:22Z","updated_at":"2017-09-13T00:54:22Z","author_association":"NONE","body":"Got it - thanks @colings86 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329026356","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-329026356","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":329026356,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTAyNjM1Ng==","user":{"login":"jateenjoshi","id":1624229,"node_id":"MDQ6VXNlcjE2MjQyMjk=","avatar_url":"https://avatars3.githubusercontent.com/u/1624229?v=4","gravatar_id":"","url":"https://api.github.com/users/jateenjoshi","html_url":"https://github.com/jateenjoshi","followers_url":"https://api.github.com/users/jateenjoshi/followers","following_url":"https://api.github.com/users/jateenjoshi/following{/other_user}","gists_url":"https://api.github.com/users/jateenjoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/jateenjoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jateenjoshi/subscriptions","organizations_url":"https://api.github.com/users/jateenjoshi/orgs","repos_url":"https://api.github.com/users/jateenjoshi/repos","events_url":"https://api.github.com/users/jateenjoshi/events{/privacy}","received_events_url":"https://api.github.com/users/jateenjoshi/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T00:57:54Z","updated_at":"2017-09-13T00:57:54Z","author_association":"NONE","body":"One thing we are doing is increasing the number of shards in our indexes. It sounds like the dominating factor is the cardinality of the field in a single shard, so would increasing the number of shards with more nodes help bring down the latencies?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329120316","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-329120316","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":329120316,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyMDMxNg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:01:48Z","updated_at":"2017-09-13T10:02:31Z","author_association":"MEMBER","body":"Only if you have the resources to handle the extra shards. Increasing shards has other affects on performance as well so you may find it helps but you may find it doesn't, you'd have to test in your use case to find out. Also if you increase the shards but they are shared over the same nodes then you will be loading double the number of global ordinals (one for each shard) every time you refresh so the total cost on resources may well be the same but with the cost of having more shards in other aspects (like the term dictionary cache and duplication of the same term in multiple shards)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522561412","html_url":"https://github.com/elastic/elasticsearch/issues/19780#issuecomment-522561412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19780","id":522561412,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjU2MTQxMg==","user":{"login":"alexander-marquardt","id":2364589,"node_id":"MDQ6VXNlcjIzNjQ1ODk=","avatar_url":"https://avatars2.githubusercontent.com/u/2364589?v=4","gravatar_id":"","url":"https://api.github.com/users/alexander-marquardt","html_url":"https://github.com/alexander-marquardt","followers_url":"https://api.github.com/users/alexander-marquardt/followers","following_url":"https://api.github.com/users/alexander-marquardt/following{/other_user}","gists_url":"https://api.github.com/users/alexander-marquardt/gists{/gist_id}","starred_url":"https://api.github.com/users/alexander-marquardt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexander-marquardt/subscriptions","organizations_url":"https://api.github.com/users/alexander-marquardt/orgs","repos_url":"https://api.github.com/users/alexander-marquardt/repos","events_url":"https://api.github.com/users/alexander-marquardt/events{/privacy}","received_events_url":"https://api.github.com/users/alexander-marquardt/received_events","type":"User","site_admin":false},"created_at":"2019-08-19T12:57:00Z","updated_at":"2019-08-19T12:57:00Z","author_association":"NONE","body":"The following blog post presents several techniques for improving the performance of terms aggregations on high-cardinality fields - https://www.elastic.co/blog/improving-the-performance-of-high-cardinality-terms-aggregations-in-elasticsearch. \r\n\r\n","performed_via_github_app":null}]