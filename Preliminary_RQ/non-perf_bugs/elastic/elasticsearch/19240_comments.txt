[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230218209","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230218209","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230218209,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDIxODIwOQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T06:55:06Z","updated_at":"2016-07-04T06:55:06Z","author_association":"CONTRIBUTOR","body":"Would the below query work?\n\n```\n{\n  \"span_near\": {\n    \"clauses\": [\n      {\n        \"span_term\": {\n          \"field\": \"value1\"\n        }\n      },\n      {\n        \"span_or\": {\n          \"clauses\": [\n            {\n              \"span_term\": {\n                \"field\": \"value2\"\n              }\n            },\n            {\n              \"span_term\": {\n                \"field\": \"value3\"\n              }\n            }\n          ]\n        }\n      }\n    ],\n    \"slop\": 2,\n    \"in_order\": false,\n    \"collect_payloads\": false\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230235059","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230235059","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230235059,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDIzNTA1OQ==","user":{"login":"trejkaz","id":43236,"node_id":"MDQ6VXNlcjQzMjM2","avatar_url":"https://avatars2.githubusercontent.com/u/43236?v=4","gravatar_id":"","url":"https://api.github.com/users/trejkaz","html_url":"https://github.com/trejkaz","followers_url":"https://api.github.com/users/trejkaz/followers","following_url":"https://api.github.com/users/trejkaz/following{/other_user}","gists_url":"https://api.github.com/users/trejkaz/gists{/gist_id}","starred_url":"https://api.github.com/users/trejkaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trejkaz/subscriptions","organizations_url":"https://api.github.com/users/trejkaz/orgs","repos_url":"https://api.github.com/users/trejkaz/repos","events_url":"https://api.github.com/users/trejkaz/events{/privacy}","received_events_url":"https://api.github.com/users/trejkaz/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T08:32:05Z","updated_at":"2016-07-04T08:32:05Z","author_association":"NONE","body":"Using a span_or would match:\n- a x x b\n\nbut should not.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230236114","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230236114","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230236114,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDIzNjExNA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T08:37:19Z","updated_at":"2016-07-04T08:37:19Z","author_association":"CONTRIBUTOR","body":"This is the parth that confuses me a bit: how should the `near_clauses` be combined?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230246820","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230246820","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230246820,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDI0NjgyMA==","user":{"login":"trejkaz","id":43236,"node_id":"MDQ6VXNlcjQzMjM2","avatar_url":"https://avatars2.githubusercontent.com/u/43236?v=4","gravatar_id":"","url":"https://api.github.com/users/trejkaz","html_url":"https://github.com/trejkaz","followers_url":"https://api.github.com/users/trejkaz/followers","following_url":"https://api.github.com/users/trejkaz/following{/other_user}","gists_url":"https://api.github.com/users/trejkaz/gists{/gist_id}","starred_url":"https://api.github.com/users/trejkaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trejkaz/subscriptions","organizations_url":"https://api.github.com/users/trejkaz/orgs","repos_url":"https://api.github.com/users/trejkaz/repos","events_url":"https://api.github.com/users/trejkaz/events{/privacy}","received_events_url":"https://api.github.com/users/trejkaz/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T09:27:57Z","updated_at":"2016-07-04T09:27:57Z","author_association":"NONE","body":"Each clause in `near_clauses` should be within the specified range of the `clause`. Essentially the same as `span_near`, but with multiple terms being tested.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230310008","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230310008","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230310008,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDMxMDAwOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T15:04:50Z","updated_at":"2016-07-04T15:04:50Z","author_association":"CONTRIBUTOR","body":"This should work I think:\n\n```\nPUT t/t/1\n{\n  \"text\": \"one two three four five six seven eight\"\n}\n\nGET t/_search\n{\n  \"query\": {\n    \"span_containing\": {\n      \"little\": {\n        \"span_term\": {\n          \"text\": \"three\"\n        }\n      },\n      \"big\": {\n        \"span_near\": {\n          \"clauses\": [\n            {\n              \"span_term\": {\n                \"text\": \"one\"\n              }\n            },\n            {\n              \"span_term\": {\n                \"text\": \"three\"\n              }\n            },\n            {\n              \"span_term\": {\n                \"text\": \"four\"\n              }\n            }\n          ],\n          \"slop\": 2,\n          \"in_order\": false\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230363240","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230363240","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230363240,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDM2MzI0MA==","user":{"login":"trejkaz","id":43236,"node_id":"MDQ6VXNlcjQzMjM2","avatar_url":"https://avatars2.githubusercontent.com/u/43236?v=4","gravatar_id":"","url":"https://api.github.com/users/trejkaz","html_url":"https://github.com/trejkaz","followers_url":"https://api.github.com/users/trejkaz/followers","following_url":"https://api.github.com/users/trejkaz/following{/other_user}","gists_url":"https://api.github.com/users/trejkaz/gists{/gist_id}","starred_url":"https://api.github.com/users/trejkaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trejkaz/subscriptions","organizations_url":"https://api.github.com/users/trejkaz/orgs","repos_url":"https://api.github.com/users/trejkaz/repos","events_url":"https://api.github.com/users/trejkaz/events{/privacy}","received_events_url":"https://api.github.com/users/trejkaz/received_events","type":"User","site_admin":false},"created_at":"2016-07-04T23:25:16Z","updated_at":"2016-07-04T23:28:08Z","author_association":"NONE","body":"That one doesn't match the already-provided example \"a x b c\".\n\nPresumably the span_near returns the span from b to c, so a is not inside it.\n\nIt also doesn't match \"b x x a x x c\", because the span from b to c is greater than 2.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230430864","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230430864","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230430864,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDQzMDg2NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-05T09:30:02Z","updated_at":"2016-07-05T09:30:02Z","author_association":"CONTRIBUTOR","body":"I've played around with various options and find myself to be defeated. I've also found [this comment](https://lucidworks.com/blog/2009/07/18/the-spanquery/#comment-2222) from the author of the SpanWithinQuery which suggests that what you want might be possible by modifying the SpanWithinQuery.\n\nWe just inherit the span queries from Lucene, so I think you have two options: (a) open an issue on Lucene to convince somebody to build this query, or (b) write a plugin with a custom query based on SpanWithinQuery which does what you need. (If you do the latter, then please consider donating it to Lucene).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230630642","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230630642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230630642,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDYzMDY0Mg==","user":{"login":"trejkaz","id":43236,"node_id":"MDQ6VXNlcjQzMjM2","avatar_url":"https://avatars2.githubusercontent.com/u/43236?v=4","gravatar_id":"","url":"https://api.github.com/users/trejkaz","html_url":"https://github.com/trejkaz","followers_url":"https://api.github.com/users/trejkaz/followers","following_url":"https://api.github.com/users/trejkaz/following{/other_user}","gists_url":"https://api.github.com/users/trejkaz/gists{/gist_id}","starred_url":"https://api.github.com/users/trejkaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trejkaz/subscriptions","organizations_url":"https://api.github.com/users/trejkaz/orgs","repos_url":"https://api.github.com/users/trejkaz/repos","events_url":"https://api.github.com/users/trejkaz/events{/privacy}","received_events_url":"https://api.github.com/users/trejkaz/received_events","type":"User","site_admin":false},"created_at":"2016-07-05T23:17:03Z","updated_at":"2016-07-05T23:17:03Z","author_association":"NONE","body":"I have made attempts to hack queries in Lucene to get a similar effect (funnily enough I appear on that thread you link as well, from 5 years ago when I was last looking at this stuff!) but found span queries too hard to understand in order to modify them. I think the most I was able to do was make a SpanNotNearQuery out of SpanNotQuery because it only required modifying one line...\n\nI already filed an issue with Lucene themselves for SpanAndQuery/SpanNearAllQuery at the time as well, but years passed with nothing being done, so it seems like nobody else has been keen enough to have it. :/\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230631698","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-230631698","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":230631698,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDYzMTY5OA==","user":{"login":"trejkaz","id":43236,"node_id":"MDQ6VXNlcjQzMjM2","avatar_url":"https://avatars2.githubusercontent.com/u/43236?v=4","gravatar_id":"","url":"https://api.github.com/users/trejkaz","html_url":"https://github.com/trejkaz","followers_url":"https://api.github.com/users/trejkaz/followers","following_url":"https://api.github.com/users/trejkaz/following{/other_user}","gists_url":"https://api.github.com/users/trejkaz/gists{/gist_id}","starred_url":"https://api.github.com/users/trejkaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trejkaz/subscriptions","organizations_url":"https://api.github.com/users/trejkaz/orgs","repos_url":"https://api.github.com/users/trejkaz/repos","events_url":"https://api.github.com/users/trejkaz/events{/privacy}","received_events_url":"https://api.github.com/users/trejkaz/received_events","type":"User","site_admin":false},"created_at":"2016-07-05T23:23:26Z","updated_at":"2016-07-05T23:23:26Z","author_association":"NONE","body":"Another rewrite that I thought should work at the time went like this:\n\n```\nspanNearAll(main, [near1, near2], slop)\n -> spanNot(\n        main,\n        spanOr([\n            spanNot(main, near1, slop),\n            spanNot(main, near2, slop)\n        ])\n```\n\nWhich is to say that you find all the spans where each sub-span is _not_ near the main span, and then exclude those spans from the results, so what I thought would be left is the spans where all of the clauses are near the main span.\n\nIn practice though, it failed the tests, and I never understood why.\n\nAnother rewrite that someone else said they were using went like this:\n\n```\nspanNearAll(main, [near1, near2], slop)\n -> spanNear([\n        main,\n        spanNear(main, near1, slop),\n        spanNear(main, near2, slop)\n    ], 0)\n```\n\nThis passes nearly all the tests, but there are some edge cases where it's still wrong, things like:\n\n```\na x x x b c x x x a\n```\n\nIt finds the span from a to b and then the span from c to a, and then decides that yes, the spans are near enough to match, and returns a false hit.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231316143","html_url":"https://github.com/elastic/elasticsearch/issues/19240#issuecomment-231316143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19240","id":231316143,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTMxNjE0Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-08T09:28:47Z","updated_at":"2016-07-08T09:28:47Z","author_association":"CONTRIBUTOR","body":"Discussed in Fix it Friday.  This should be added in Lucene rather than in Elasticsearch, even if it is added to the Lucene sandbox.\n","performed_via_github_app":null}]