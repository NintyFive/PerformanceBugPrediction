[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318582021","html_url":"https://github.com/elastic/elasticsearch/issues/25916#issuecomment-318582021","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25916","id":318582021,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODU4MjAyMQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-07-28T07:27:31Z","updated_at":"2017-07-28T07:27:31Z","author_association":"CONTRIBUTOR","body":"> One possibility for unexpected behavior is that ES encodes the 32-bit integer as an 8-bit integer, then decodes back to 32-bit when used. Have not tested to confirm.\r\n\r\nIndeed this is related.\r\n\r\nLucene has historically been using an implementation of TF-IDF that used `1/sqrt(length)` as a length normalization factor. It actually encoded the norm in the index instead of the length, using only 8 bits in order to save space.  Later we made it possible to have more similarities and most of them used different length normalization factors but we wanted them to be index-time compatible with what was the default at that time, so the lenth that they see is `1/norm^2`, which is almost never an integer. In the case of your `one two` document, the length was 2, so the length norm was `1/sqrt(2)~=0.707`, which in-turn was rounded to 0.625 because of 8-bits quantization. This is why you see a length that is equal to `1/0.625^2=2.56`.\r\n\r\nThis is something that is changing in Lucene 7 (Elasticsearch 6). Our default similarity has been BM25 since Lucene 6 and we also removed support for index-time boosts so we decided to make `norms` store the length of documents (still quantized on 8 bits) instead of a precomputed length normalization factor (see https://issues.apache.org/jira/browse/LUCENE-7730). So as of Elasticsearch 6, the `fieldLength` field will give you an integer.\r\n\r\n`avgFieldLength` is not computed based on `fieldLength` but by dividing the total number of occurrences of terms in the field by the number of documents that have a value for the field, which are both recorded by the inverted index. It could be a floating-point number, I believe the fact it was always an integer in your testing was a coincidence.\r\n\r\nThere are many bad things that happen with scoring when shards do not have enough data for index stats to be similar on all shards, but I understand it can be surprising.\r\n\r\nI'm closing this issue since the problem will be addressed in 6.0. For the record, here is the output of your script on 6.0:\r\n\r\n```\r\n{\r\n  \"took\": 17,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2,\r\n    \"max_score\": 0.2876821,\r\n    \"hits\": [\r\n      {\r\n        \"_shard\": \"[m][1]\",\r\n        \"_node\": \"6ZJpASksSfmwFmAprivJgA\",\r\n        \"_index\": \"m\",\r\n        \"_type\": \"d\",\r\n        \"_id\": \"5\",\r\n        \"_score\": 0.2876821,\r\n        \"_source\": {\r\n          \"a\": \"one two three four five\"\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.2876821,\r\n          \"description\": \"weight(a:one in 0) [PerFieldSimilarity], result of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.2876821,\r\n              \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.2876821,\r\n                  \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"docFreq\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"docCount\",\r\n                      \"details\": []\r\n                    }\r\n                  ]\r\n                },\r\n                {\r\n                  \"value\": 1,\r\n                  \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"termFreq=1.0\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 1.2,\r\n                      \"description\": \"parameter k1\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 0.75,\r\n                      \"description\": \"parameter b\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 5,\r\n                      \"description\": \"avgFieldLength\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 5,\r\n                      \"description\": \"fieldLength\",\r\n                      \"details\": []\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_shard\": \"[m][2]\",\r\n        \"_node\": \"6ZJpASksSfmwFmAprivJgA\",\r\n        \"_index\": \"m\",\r\n        \"_type\": \"d\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 0.2876821,\r\n        \"_source\": {\r\n          \"a\": \"one two\"\r\n        },\r\n        \"_explanation\": {\r\n          \"value\": 0.2876821,\r\n          \"description\": \"weight(a:one in 0) [PerFieldSimilarity], result of:\",\r\n          \"details\": [\r\n            {\r\n              \"value\": 0.2876821,\r\n              \"description\": \"score(doc=0,freq=1.0 = termFreq=1.0\\n), product of:\",\r\n              \"details\": [\r\n                {\r\n                  \"value\": 0.2876821,\r\n                  \"description\": \"idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"docFreq\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"docCount\",\r\n                      \"details\": []\r\n                    }\r\n                  ]\r\n                },\r\n                {\r\n                  \"value\": 1,\r\n                  \"description\": \"tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:\",\r\n                  \"details\": [\r\n                    {\r\n                      \"value\": 1,\r\n                      \"description\": \"termFreq=1.0\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 1.2,\r\n                      \"description\": \"parameter k1\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 0.75,\r\n                      \"description\": \"parameter b\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 2,\r\n                      \"description\": \"avgFieldLength\",\r\n                      \"details\": []\r\n                    },\r\n                    {\r\n                      \"value\": 2,\r\n                      \"description\": \"fieldLength\",\r\n                      \"details\": []\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","performed_via_github_app":null}]