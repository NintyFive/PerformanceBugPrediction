[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21096020","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-21096020","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":21096020,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMDk2MDIw","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-07-17T07:18:35Z","updated_at":"2013-07-17T07:18:35Z","author_association":"MEMBER","body":"Interesting, what is the search request that you execute? Just wondering what can cause this list to grow that much?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21100672","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-21100672","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":21100672,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTAwNjcy","user":{"login":"derekcicerone","id":1081904,"node_id":"MDQ6VXNlcjEwODE5MDQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1081904?v=4","gravatar_id":"","url":"https://api.github.com/users/derekcicerone","html_url":"https://github.com/derekcicerone","followers_url":"https://api.github.com/users/derekcicerone/followers","following_url":"https://api.github.com/users/derekcicerone/following{/other_user}","gists_url":"https://api.github.com/users/derekcicerone/gists{/gist_id}","starred_url":"https://api.github.com/users/derekcicerone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derekcicerone/subscriptions","organizations_url":"https://api.github.com/users/derekcicerone/orgs","repos_url":"https://api.github.com/users/derekcicerone/repos","events_url":"https://api.github.com/users/derekcicerone/events{/privacy}","received_events_url":"https://api.github.com/users/derekcicerone/received_events","type":"User","site_admin":false},"created_at":"2013-07-17T09:09:01Z","updated_at":"2013-07-17T09:09:01Z","author_association":"NONE","body":"That's a good question. We encountered this issue on one of our deployments when users noticed poor performance (searches taking upwards of 5-10 seconds versus the normal times of well under a second). Our initial investigation has focused on determining the symptoms of the slow performance and creating a workaround. We believe the issue begins when a single query results in a large number of search hits (possibly 100k - 1 million results of relatively small size: a dozen or so fields each containing a few words of stored text each). After our server processes a few queries like this and all elasticsearch client searcher threads enter the bad state, overall search performance degrades significantly. \n\nWe worked around the issue by creating a patched jar which modifies the code I mentioned earlier. We have been testing with that jar in the same environment and under various stress scenarios for the past few days and so far it seems to resolve the issue. Longer term we are also going to be refactoring our queries to fix ones that can potentially return so many results (we are migrating from a legacy search architecture that didn't restrict the number of results provided for any given query so this will be somewhat tricky). We will also be looking into whether our schema needs to mark almost all fields as stored (also a carryover from the legacy system).\n\nWe are still actively testing the workaround to hopefully nail down a specific query and data set which reproduces the issue so we can conclusively verify the fix. Our platform performs searches of varying complexity in several places so we've had some trouble nailing down a specific problematic query.\n\nI hope this information is helpful. Please let me know if I can provide any more context to aid your investigation. \n\nDerek\n\n> On Jul 17, 2013, at 3:19 AM, Shay Banon notifications@github.com wrote:\n> \n> Interesting, what is the search request that you execute? Just wondering what can cause this list to grow that much?\n> \n> â€”\n> Reply to this email directly or view it on GitHub.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21114272","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-21114272","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":21114272,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTE0Mjcy","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-07-17T13:55:53Z","updated_at":"2013-07-17T13:55:53Z","author_association":"MEMBER","body":"do the queries vary that much? a sample one would be a great start. I wonder specifically if you list fields to be returned as part of the search request?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/21128073","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-21128073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":21128073,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTI4MDcz","user":{"login":"derekcicerone","id":1081904,"node_id":"MDQ6VXNlcjEwODE5MDQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1081904?v=4","gravatar_id":"","url":"https://api.github.com/users/derekcicerone","html_url":"https://github.com/derekcicerone","followers_url":"https://api.github.com/users/derekcicerone/followers","following_url":"https://api.github.com/users/derekcicerone/following{/other_user}","gists_url":"https://api.github.com/users/derekcicerone/gists{/gist_id}","starred_url":"https://api.github.com/users/derekcicerone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derekcicerone/subscriptions","organizations_url":"https://api.github.com/users/derekcicerone/orgs","repos_url":"https://api.github.com/users/derekcicerone/repos","events_url":"https://api.github.com/users/derekcicerone/events{/privacy}","received_events_url":"https://api.github.com/users/derekcicerone/received_events","type":"User","site_admin":false},"created_at":"2013-07-17T17:06:12Z","updated_at":"2013-07-17T17:06:12Z","author_association":"NONE","body":"Yeah, the queries vary quite a bit (there are likely over 100 unique queries across the platform).  We use them both interactively based on user-initiated searches and also programatically to find various objects.\n\nHere is an example of a query that I recently rewrote to use the elasticsearch java APIs:\n\n``` java\n        SearchRequestBuilder request = this.searchEngine.getClient().prepareSearch(ServerSearchEngineService.INDEX_NAME)\n            .setNoFields()\n            .setQuery(QueryBuilders.matchAllQuery())\n            .setScroll(\"1m\")\n            .setSearchType(SearchType.SCAN)\n            .setSize(searchQueryPageSize)\n            .setTypes(ItemType.MODEL.getType());\n```\n\nThis query is used to scan all the objects of type \"model\" in the search index (there can be milllions of models).  The \"searchQueryPageSize\" constant is set to 100k.\n\nThen there are other queries which we translate from our legacy API calls into elasticsearch calls.  They often execute with the size set to 100k and they may or may not specify the desired fields.  Here is an example of what one of those looks like in its JSON form:\n\n``` json\n{\n  \"size\" : 21,\n  \"query\" : {\n    \"bool\" : {\n      \"must\" : [ {\n        \"bool\" : {\n          \"should\" : {\n            \"match\" : {\n              \"exactName\" : {\n                \"query\" : \"g\",\n                \"type\" : \"boolean\",\n                \"boost\" : 1.0\n              }\n            }\n          }\n        }\n      }, {\n        \"bool\" : {\n          \"should\" : {\n            \"bool\" : {\n              \"should\" : [ {\n                \"match\" : {\n                  \"assignableTypes\" : {\n                    \"query\" : \"com.palantir.finance.commons.service.ontology.model.Model\",\n                    \"type\" : \"boolean\",\n                    \"boost\" : 1.0\n                  }\n                }\n              }, {\n                \"match\" : {\n                  \"assignableTypes\" : {\n                    \"query\" : \"com.palantir.finance.commons.service.document.Document\",\n                    \"type\" : \"boolean\",\n                    \"boost\" : 1.0\n                  }\n                }\n              }, {\n                \"match\" : {\n                  \"assignableTypes\" : {\n                    \"query\" : \"java.lang.Enum\",\n                    \"type\" : \"boolean\",\n                    \"boost\" : 1.0\n                  }\n                }\n              }, {\n                \"match\" : {\n                  \"assignableTypes\" : {\n                    \"query\" : \"com.palantir.finance.commons.service.authentication.User\",\n                    \"type\" : \"boolean\",\n                    \"boost\" : 1.0\n                  }\n                }\n              } ]\n            }\n          }\n        }\n      } ]\n    }\n  },\n  \"filter\" : {\n    \"terms\" : {\n      \"permissions\" : [ 1000043, 2, 1003047 ]\n    }\n  },\n  \"fields\" : \"*\"\n}\n```\n\nWhen this particular query is run, we also run anywhere from 5-50 other queries in parallel at the same time.  The reason we run so many queries in parallel is that our legacy search system was not very expressive, so it was necessary to use a lot of queries to express some of the more complicated queries.  We'll also be looking into rewriting these queries to use the elasticsearch APIs in the near future.\n\nI can also provide our mappings if you like as well (they are specified in a single JSON file).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24460061","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-24460061","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":24460061,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDYwMDYx","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-14T21:58:55Z","updated_at":"2013-09-14T21:58:55Z","author_association":"MEMBER","body":"closing as its fixed in the above commits.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24460682","html_url":"https://github.com/elastic/elasticsearch/issues/3322#issuecomment-24460682","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3322","id":24460682,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDYwNjgy","user":{"login":"derekcicerone","id":1081904,"node_id":"MDQ6VXNlcjEwODE5MDQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1081904?v=4","gravatar_id":"","url":"https://api.github.com/users/derekcicerone","html_url":"https://github.com/derekcicerone","followers_url":"https://api.github.com/users/derekcicerone/followers","following_url":"https://api.github.com/users/derekcicerone/following{/other_user}","gists_url":"https://api.github.com/users/derekcicerone/gists{/gist_id}","starred_url":"https://api.github.com/users/derekcicerone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derekcicerone/subscriptions","organizations_url":"https://api.github.com/users/derekcicerone/orgs","repos_url":"https://api.github.com/users/derekcicerone/repos","events_url":"https://api.github.com/users/derekcicerone/events{/privacy}","received_events_url":"https://api.github.com/users/derekcicerone/received_events","type":"User","site_admin":false},"created_at":"2013-09-14T22:43:55Z","updated_at":"2013-09-14T22:43:55Z","author_association":"NONE","body":"Awesome, thanks!\n","performed_via_github_app":null}]