[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277199340","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277199340","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277199340,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzE5OTM0MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:12:02Z","updated_at":"2017-02-03T09:12:02Z","author_association":"CONTRIBUTOR","body":"@maxcom could you provide us with the aggregations that you are running please?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277201583","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277201583","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277201583,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwMTU4Mw==","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:24:00Z","updated_at":"2017-02-03T09:24:00Z","author_association":"NONE","body":"I can't find exact query that causes the problem. I'll add more logging to our application and wait for next reproduction.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277202498","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277202498","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277202498,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwMjQ5OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:29:00Z","updated_at":"2017-02-03T09:29:00Z","author_association":"CONTRIBUTOR","body":"The state of the thread is runnable, so I suspect this is not really a deadlock, but rather a memory pressure issue: so much time is spent doing garbage collection that the application does not seem to make any progress. Do you have some monitoring data of garbage collection activity / memory usage of the JVM?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277203371","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277203371","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277203371,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwMzM3MQ==","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:33:20Z","updated_at":"2017-02-03T09:33:20Z","author_association":"NONE","body":"I do not think that it is a memory issue. CPU is not busy at all; we see no GC activity in our logs. And no progress is made until we restart Elasticsearch (for ~30 minutes).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277204246","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277204246","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277204246,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwNDI0Ng==","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:38:00Z","updated_at":"2017-02-03T09:38:00Z","author_association":"NONE","body":"I dig into sources of Elasticsearch and I think that is can be some kind of class initialization deadlock. Similar problem is described here: https://ternarysearch.blogspot.ru/2013/07/static-initialization-deadlock.html","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277204764","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277204764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277204764,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwNDc2NA==","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:40:29Z","updated_at":"2017-02-03T09:40:43Z","author_association":"NONE","body":"One more stack trace (from Elasticsearch 2.4.3):\r\n\r\n```\r\n2017-02-02 16:09:32.129209500 \"elasticsearch[main][search][T#6]\" #71 daemon prio=5 os_prio=0 tid=0x00007f5a24083000 nid=0x2e51 in Object.wait() [0x00007f59ef6d2000]\r\n2017-02-02 16:09:32.129220500    java.lang.Thread.State: RUNNABLE\r\n2017-02-02 16:09:32.130068500   at org.elasticsearch.search.aggregations.support.ValuesSource$Bytes.<clinit>(ValuesSource.java:66)\r\n2017-02-02 16:09:32.130070500   at org.elasticsearch.search.aggregations.support.AggregationContext.bytesField(AggregationContext.java:176)\r\n2017-02-02 16:09:32.130071500   at org.elasticsearch.search.aggregations.support.AggregationContext.originalValuesSource(AggregationContext.java:151)\r\n2017-02-02 16:09:32.130073500   at org.elasticsearch.search.aggregations.support.AggregationContext.valuesSource(AggregationContext.java:85)\r\n2017-02-02 16:09:32.130088500   at org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:60)\r\n2017-02-02 16:09:32.130090500   at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:102)\r\n2017-02-02 16:09:32.130091500   at org.elasticsearch.search.aggregations.AggregatorFactories.createSubAggregators(AggregatorFactories.java:76)\r\n2017-02-02 16:09:32.130096500   at org.elasticsearch.search.aggregations.AggregatorBase.<init>(AggregatorBase.java:69)\r\n2017-02-02 16:09:32.130097500   at org.elasticsearch.search.aggregations.bucket.BucketsAggregator.<init>(BucketsAggregator.java:48)\r\n2017-02-02 16:09:32.130098500   at org.elasticsearch.search.aggregations.bucket.SingleBucketAggregator.<init>(SingleBucketAggregator.java:38)\r\n2017-02-02 16:09:32.130104500   at org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator.<init>(FilterAggregator.java:54)\r\n2017-02-02 16:09:32.130106500   at org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator$Factory.createInternal(FilterAggregator.java:108)\r\n2017-02-02 16:09:32.130107500   at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:102)\r\n2017-02-02 16:09:32.130111500   at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:87)\r\n2017-02-02 16:09:32.130113500   at org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:85)\r\n2017-02-02 16:09:32.130114500   at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:111)\r\n2017-02-02 16:09:32.130115500   at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:372)\r\n2017-02-02 16:09:32.130128500   at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:480)\r\n2017-02-02 16:09:32.130130500   at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\r\n2017-02-02 16:09:32.130131500   at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\r\n2017-02-02 16:09:32.130137500   at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\r\n2017-02-02 16:09:32.130139500   at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\r\n2017-02-02 16:09:32.130140500   at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:378)\r\n2017-02-02 16:09:32.130144500   at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n2017-02-02 16:09:32.130145500   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n2017-02-02 16:09:32.130147500   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n2017-02-02 16:09:32.130148500   at java.lang.Thread.run(Thread.java:745)\r\n2017-02-02 16:09:32.130152500 \r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277206448","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277206448","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277206448,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwNjQ0OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T09:49:03Z","updated_at":"2017-02-03T10:00:41Z","author_association":"CONTRIBUTOR","body":"So this might be a class initialization deadlock actually. Can you provide us with the entire jstack output?\r\n\r\nEDIT: I had not seen the two above messages where you already mentioned the fact it could be a class init deadlock.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277209849","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277209849","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277209849,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIwOTg0OQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T10:05:09Z","updated_at":"2017-02-03T10:05:09Z","author_association":"CONTRIBUTOR","body":"I think moving the `EMPTY` constant to the `WithOrdinals` class rather than its `Bytes` parent class would fix the problem as the `Bytes` class would no longer depend on initializing its `WithOrdinals` subclass.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277214400","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277214400","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277214400,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzIxNDQwMA==","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"created_at":"2017-02-03T10:27:23Z","updated_at":"2017-02-03T10:27:23Z","author_association":"NONE","body":"Sure, here is full thread dumps from 2.4.3: https://gist.github.com/maxcom/69d54d58284a7b5eea42db363bac5f6a","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277671571","html_url":"https://github.com/elastic/elasticsearch/issues/22952#issuecomment-277671571","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","id":277671571,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NzY3MTU3MQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-06T12:51:55Z","updated_at":"2017-02-06T12:52:01Z","author_association":"CONTRIBUTOR","body":"Closing as this bug does not exist in 5.x and will be fixed in the upcoming 2.4 release (for which we have no ETA at the moment). Thanks @maxcom for the detailed bug report and being so reactive helping us understand what was happening.","performed_via_github_app":null}]