{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30117","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30117/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30117/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30117/events","html_url":"https://github.com/elastic/elasticsearch/issues/30117","id":317545745,"node_id":"MDU6SXNzdWUzMTc1NDU3NDU=","number":30117,"title":"string terms is very slow when there are millions of buckets","user":{"login":"pakein","id":1241770,"node_id":"MDQ6VXNlcjEyNDE3NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/1241770?v=4","gravatar_id":"","url":"https://api.github.com/users/pakein","html_url":"https://github.com/pakein","followers_url":"https://api.github.com/users/pakein/followers","following_url":"https://api.github.com/users/pakein/following{/other_user}","gists_url":"https://api.github.com/users/pakein/gists{/gist_id}","starred_url":"https://api.github.com/users/pakein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pakein/subscriptions","organizations_url":"https://api.github.com/users/pakein/orgs","repos_url":"https://api.github.com/users/pakein/repos","events_url":"https://api.github.com/users/pakein/events{/privacy}","received_events_url":"https://api.github.com/users/pakein/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-04-25T09:22:42Z","updated_at":"2018-04-27T13:26:47Z","closed_at":"2018-04-27T13:26:47Z","author_association":"NONE","active_lock_reason":null,"body":"elasticsearch 6.1.3\r\n\r\nIn GlobalOrdinalsStringTermsAggregator\r\nWhen there are levels of aggregation， parent agg and valueCount both more than 100 thousands bucket\r\n\r\nthe loop may be explode\r\n`for (long globalTermOrd = 0; globalTermOrd < valueCount; ++globalTermOrd) `\r\n\r\nMy temporary resolution is， loop by bucketOrds\r\n```\r\n            private static Field keysField;\r\n            static {\r\n                try {\r\n                   keysField = LongHash.class.getDeclaredField(\"keys\");\r\n                   keysField.setAccessible(true);\r\n                 } catch (Exception e) {\r\n                LOGGER.error(e.getMessage(), e);\r\n            }\r\n     \r\n           if (bucketOrds != null && bucketOrds.size() < valueCount && bucketCountThresholds.getMinDocCount() > 0 ) {\r\n                try {\r\n                    loop = false;\r\n                    LongArray keys = ((LongArray) keysField.get(bucketOrds));\r\n                    for (long i = 0; i < keys.size(); i++) {\r\n                        //i: bucketOrd\r\n                        int bucketDocCount = bucketDocCount(i);\r\n                        if ( bucketDocCount == 0) {\r\n                            continue;\r\n                        }           \r\n                        long globalTermOrd = keys.get(i);\r\n                        if (includeExclude != null && !acceptedGlobalOrdinals.get(globalTermOrd)) {\r\n                            continue;\r\n                        }\r\n                        otherDocCount += bucketDocCount;\r\n                        spare.globalOrd = globalTermOrd;\r\n                        spare.bucketOrd = i;\r\n                        spare.docCount = bucketDocCount;\r\n                        if (bucketCountThresholds.getShardMinDocCount() <= spare.docCount) {\r\n                            spare = ordered.insertWithOverflow(spare);\r\n                            if (spare == null) {\r\n                                spare = new OrdBucket(-1, 0, null, showTermDocCountError, 0);\r\n                            }\r\n                        }\r\n\r\n                    }\r\n\r\n                } catch (IllegalAccessException e) {\r\n                    LOGGER.error(e.getMessage(), e);\r\n                    loop = true;\r\n                }\r\n            }\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}