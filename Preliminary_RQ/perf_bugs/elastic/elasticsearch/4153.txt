{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4153","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4153/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4153/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4153/events","html_url":"https://github.com/elastic/elasticsearch/issues/4153","id":22515345,"node_id":"MDU6SXNzdWUyMjUxNTM0NQ==","number":4153,"title":"Deadlock in BulkProcessor","user":{"login":"matt-preston","id":1115857,"node_id":"MDQ6VXNlcjExMTU4NTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1115857?v=4","gravatar_id":"","url":"https://api.github.com/users/matt-preston","html_url":"https://github.com/matt-preston","followers_url":"https://api.github.com/users/matt-preston/followers","following_url":"https://api.github.com/users/matt-preston/following{/other_user}","gists_url":"https://api.github.com/users/matt-preston/gists{/gist_id}","starred_url":"https://api.github.com/users/matt-preston/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matt-preston/subscriptions","organizations_url":"https://api.github.com/users/matt-preston/orgs","repos_url":"https://api.github.com/users/matt-preston/repos","events_url":"https://api.github.com/users/matt-preston/events{/privacy}","received_events_url":"https://api.github.com/users/matt-preston/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":64134382,"node_id":"MDU6TGFiZWw2NDEzNDM4Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.7","name":"v0.90.7","color":"dddddd","default":false,"description":null},{"id":64607794,"node_id":"MDU6TGFiZWw2NDYwNzc5NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta2","name":"v1.0.0.Beta2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2013-11-12T12:41:16Z","updated_at":"2014-09-23T16:32:54Z","closed_at":"2013-11-12T14:47:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I'm experiencing a deadlock in BulkProcessor during heavy bulk indexing to a single node cluster.\n\nOccasionally, during heavy indexing, the node becomes unresponsive causing the client to throw NoNodeAvailableException, triggering the issue.\n\nhttps://github.com/elasticsearch/elasticsearch/blob/master/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java#L279-305\n\nA semaphore is acquired before the call to client.bulk(request, listener) and only released in the callback.  If an Exception, such as NoNodeAvailableException, is thrown from client.bulk(request, listener), the semaphore is never released.\n\nWhen the number of Exceptions thrown by client.bulk(request, listener) is greater than the number of concurrent requests supported by BulkProcessor a deadlock occurs and no more documents can be indexed.\n\nBulkProcessor should be able to handle this by wrapping client.bulk(request, listener) inside a try/catch block and handling the Exception, calling the listener and releasing the semaphore.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}