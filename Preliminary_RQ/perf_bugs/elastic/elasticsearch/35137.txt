{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35137","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35137/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35137/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35137/events","html_url":"https://github.com/elastic/elasticsearch/issues/35137","id":376057846,"node_id":"MDU6SXNzdWUzNzYwNTc4NDY=","number":35137,"title":"[ML] Slow performance of file structure finder with log message containing many dates","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-10-31T16:43:11Z","updated_at":"2019-05-23T20:06:48Z","closed_at":"2019-05-23T20:06:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"@grabowskit noticed that the `find_file_structure` endpoint timed out on a log file that contained messages from a Cloud allocator.\r\n\r\nI debugged this and found that the messages that cause a particular problem for the file structure finder are those that contain many dates, for example:\r\n\r\n```\r\n[2018-10-05 11:05:17,526][INFO ][no.found.runner.allocation.elasticsearch.ElasticsearchDockerContainer] Creating container from [ElasticsearchDockerContainer(ElasticsearchContainerId(11111111111111111111111111111111,instance-0000000000),-,List(),{\"data\":{\"name\":\"admin-console-elasticsearch\"},\"kind\":\"elasticsearch\",\"resources\":{\"cpu\":{\"hard_limit\":false,\"boost\":true}},\"shield\":{\"system_key\":\"-\",\"found_users\":{\"found-internal-constructor\":{\"roles\":[\"found-internal-admin\",\"superuser\"],\"username\":\"found-internal-constructor\",\"password\":\"-\",\"password_hash\":\"-\",\"valid_until\":\"2023-10-05T11:05:15.879Z\"},\"found-internal-system\":{\"roles\":[\"found-internal-constructor\",\"superuser\"],\"username\":\"found-internal-system\",\"password\":\"-\",\"password_hash\":\"-\",\"valid_until\":\"2060-10-05T11:05:10.624Z\"},\"found-internal-admin-proxy\":{\"roles\":[\"found-internal-admin\"],\"username\":\"found-internal-admin-proxy\",\"password_hash\":\"-\",\"valid_until\":\"2060-10-05T11:05:10.546Z\"},\"ece-admin-cluster-indexer\":{\"roles\":[\"found-internal-admin\"],\"username\":\"ece-admin-cluster-indexer\",\"password_hash\":\"-\"},\"found-internal-monitor\":{\"roles\":[\"found-internal-monitor\"],\"username\":\"found-internal-monitor\",\"password_hash\":\"-\",\"valid_until\":\"2060-10-05T11:05:10.701Z\"},\"found-local-allocator\":{\"password_hash\":\"-\",\"roles\":[\"found-internal-admin\"]},\"ec-local-beats-monitor\":{\"password_hash\":\"-\",\"roles\":[\"found-internal-monitor\"]}}},\"snapshot\":{\"enabled\":false,\"suspended\":{\"constructor\":true}},\"user_id\":\"root\",\"system_owned\":true,\"source\":{\"facilitator\":\"bootstrap\",\"action\":\"create-admin-console-backend\",\"date\":\"2018-10-05T11:05:10.535Z\"}},{\"instance_capacity\":4096,\"instance_configuration_id\":\"data.default\",\"allocator_filter\":{\"match_all\":{}},\"node_types\":[\"data\",\"master\",\"ingest\"],\"elasticsearch\":{\"node\":{\"data\":true,\"master\":true,\"ingest\":true},\"plugins\":[\"repository-s3\",\"found-elasticsearch\",\"x-pack\"],\"gateway_type\":\"local\",\"user_settings_overrides\":{},\"user_bundles\":[],\"version\":\"5.6.12\",\"confirmed_election\":false,\"user_settings\":{\"script.engine.expression.file\":true,\"script.engine.expression.inline\":true,\"script.engine.expression.stored\":true,\"script.engine.mustache.file\":true,\"script.engine.mustache.stored\":true,\"script.engine.painless.file\":true,\"script.engine.painless.inline\":true,\"script.engine.painless.stored\":true,\"script.file\":false,\"script.inline\":false,\"script.stored\":false},\"user_plugins\":[],\"seed_hosts\":[]},\"resources\":{\"quota\":{\"fs_multiplier\":32}},\"ssd\":false,\"plan_version\":\"1.0\",\"logical_zone_name\":\"zone-0\",\"start\":true,\"quorum_size\":1,\"maintenance\":true,\"source\":{\"facilitator\":\"constructor\",\"action\":\"elasticsearch.create-instances\",\"date\":\"2018-10-05T11:05:15.963Z\"},\"allocator_name\":\"10.10.10.10\",\"allocator_id\":\"10.10.10.10\",\"allocator_zone_name\":\"ece-zone-1\"},None,None,{\"forward_auth_headers\":true,\"shield\":{\"allow_anonymous\":false,\"esusers\":{\"roles\":{\"anonymous\":{}},\"users\":{},\"users_roles\":{}}},\"source\":{\"facilitator\":\"bootstrap\",\"action\":\"create-admin-console-backend\",\"date\":\"2018-10-05T11:05:10.535Z\"}},AllocatorShieldUser(ec-local-beats-monitor,-,List(found-internal-monitor)),AllocatorShieldUser(found-local-allocator,-,List(found-internal-admin)),no.found.template.ZooKeeperResourceLocator@1f41214d,DefaultAllocatorAllocationEnvironment(438182,10.10.10.10,ece-zone-1,10.10.10.10,Map(kibana -> found/{kind}:{version}, apm -> found/{kind}:{version}, elasticsearch -> found/{kind}:{version}),Map(kibana -> 4.0, apm -> 4.0, elasticsearch -> 32.0),Map(kibana -> 5 seconds, apm -> 30000 milliseconds, elasticsearch -> 5 seconds),/usr/elastic/data/elastic/10.10.10.10/services/allocator/containers,/app/state,/app/state,state/runner-initial-containers-content.json,no.found.zookeeper.VersionCache@2b367d62,no.found.http.ActorHttpClient@3d6b7a00,no.found.runner.managers.ContainerIdsManager@1b8f1b99,no.found.runner.managers.XFSQuotaSupport@2291e278,no.found.filewatch.FileWatchService@3ad44625,no.found.template.VersionedTemplateManager@5c098005,no.found.runner.managers.ZooKeeperManager@3f390bce,no.found.runner.managers.NetworkResourcesManager@1296ac73,no.found.runner.settings.AllocatorSettings@aeb256a,Map(kibana -> 0.0, apm -> 0.0, elasticsearch -> 0.0)),no.found.featureflags.CloudFeatureManager@1af2959a)]: [{\"Image\":\"docker.hs.coop.ch/cloud-assets/elasticsearch:5.6.12-0\",\"Labels\":{\"co.elastic.cloud.allocator.id\":\"10.10.10.10\",\"co.elastic.cloud.allocator.zone\":\"ece-zone-1\",\"co.elastic.cloud.allocator.instance_id\":\"instance-0000000000\",\"co.elastic.cloud.allocator.cluster_id\":\"11111111111111111111111111111111\",\"co.elastic.cloud.allocator.user_id\":\"root\",\"co.elastic.cloud.allocator.kind\":\"elasticsearch\",\"co.elastic.cloud.allocator.type\":\"elasticsearch\",\"co.elastic.cloud.allocator.type_version\":\"5.6.12\"},\"ExposedPorts\":{\"11111/tcp\":{},\"22222/tcp\":{}},\"HostConfig\":{\"CpuShares\":11,\"Memory\":4294967296,\"MemorySwap\":4294967296,\"BlkioWeight\":11,\"CpuPeriod\":100000,\"CpuQuota\":4800000,\"Binds\":[\"/usr/elastic/data/elastic/10.10.10.10/services/allocator/containers/elasticsearch/11111111111111111111111111111111/instance-0000000000:/app\"],\"RestartPolicy\":{\"Name\":\"always\"},\"ExtraHosts\":[\"containerhost:${ALLOCATOR_HOST_IP}\",\"dockerhost:${ALLOCATOR_HOST_IP}\"],\"PortBindings\":{\"11111/tcp\":[{\"HostIp\":\"0.0.0.0\",\"HostPort\":\"11111\"}],\"22222/tcp\":[{\"HostIp\":\"0.0.0.0\",\"HostPort\":\"22222\"}]},\"CapAdd\":[\"SETUID\",\"SETGID\",\"CHOWN\",\"DAC_OVERRIDE\"],\"CapDrop\":[\"ALL\"]},\"Volumes\":{\"/app\":{}},\"Env\":[\"ELASTIC_UID=33333\",\"ELASTIC_GID=33333\"]}] {\"ec_container_kind\":\"elasticsearch\",\"ec_container_group\":\"11111111111111111111111111111111\",\"ec_container_name\":\"instance-0000000000\"}\r\n```\r\n\r\n(Some of the details in that sample have been altered to avoid disclosing real values from Cloud.)\r\n\r\nSome temporary debug showed the following for this message:\r\n\r\n```\r\n[2018-10-31T16:22:20,667][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] quick rule out 0\r\n[2018-10-31T16:22:20,667][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n[2018-10-31T16:22:20,667][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] quick rule out 1\r\n[2018-10-31T16:22:20,667][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n[2018-10-31T16:22:20,667][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] trying [YYYY-MM-dd HH:mm:ss,SSS Z]\r\n[2018-10-31T16:22:21,306][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n[2018-10-31T16:22:21,306][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] trying [YYYY-MM-dd HH:mm:ss,SSSZ]\r\n[2018-10-31T16:22:22,021][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n[2018-10-31T16:22:22,021][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] trying [YYYY-MM-dd HH:mm:ss,SSSZZ]\r\n[2018-10-31T16:22:22,727][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n[2018-10-31T16:22:22,727][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] trying [YYYY-MM-dd HH:mm:ss,SSS]\r\n[2018-10-31T16:22:22,728][INFO ][o.e.x.m.f.TimestampFormatFinder] [node-0] done\r\n```\r\n\r\nThe problems are:\r\n\r\n1. Because there are multiple timestamps in different formats the functionality to quickly rule out some timestamp patterns doesn't work.\r\n2. Then patterns that nearly match but not quite cause excessive backtracking and searching in the Grok pattern matcher due to the fact that a large prefix of the pattern matches in several places - around 2/3rds of a second per nearly matching pattern, just for this one message.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}