{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31877","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31877/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31877/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31877/events","html_url":"https://github.com/elastic/elasticsearch/issues/31877","id":339065620,"node_id":"MDU6SXNzdWUzMzkwNjU2MjA=","number":31877,"title":"Performance regression for search query in single node cluster","user":{"login":"ctrlaltdel","id":8973,"node_id":"MDQ6VXNlcjg5NzM=","avatar_url":"https://avatars3.githubusercontent.com/u/8973?v=4","gravatar_id":"","url":"https://api.github.com/users/ctrlaltdel","html_url":"https://github.com/ctrlaltdel","followers_url":"https://api.github.com/users/ctrlaltdel/followers","following_url":"https://api.github.com/users/ctrlaltdel/following{/other_user}","gists_url":"https://api.github.com/users/ctrlaltdel/gists{/gist_id}","starred_url":"https://api.github.com/users/ctrlaltdel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctrlaltdel/subscriptions","organizations_url":"https://api.github.com/users/ctrlaltdel/orgs","repos_url":"https://api.github.com/users/ctrlaltdel/repos","events_url":"https://api.github.com/users/ctrlaltdel/events{/privacy}","received_events_url":"https://api.github.com/users/ctrlaltdel/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2018-07-06T20:41:55Z","updated_at":"2018-09-11T19:16:07Z","closed_at":"2018-09-11T19:16:07Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.3.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): OpenJDK Runtime Environment (build 10.0.1+10-Ubuntu-3ubuntu1)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 18.04\r\n\r\n`Linux es-perf 4.13.0-25-generic #29-Ubuntu SMP Mon Jan 8 21:14:41 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nA single search query running on a single node elasticsearch cluster is much slower with elasticsearch 6.3.1 than it was with 5.5.3 while it would be expected to take the same time.\r\n\r\nAn inefficient use of the CPU due to the limit of concurrent shard requests per search request (implemented in https://github.com/elastic/elasticsearch/pull/25632) is the likely culprit.\r\n\r\n**Steps to reproduce**:\r\n\r\nThe following steps were tested in a virtual machine with 8 cores and 16 GB of RAM.\r\n\r\n1. Install elasticsearch 5.5.3 from deb package\r\n2. Create indices with test data using `populate.sh` (see below)\r\n3. Run a single `match_all` search query while showing CPU usage\r\n\r\n```console\r\n$ ./query.sh\r\nElasticsearch version 5.5.3\r\n\r\n%Cpu(s): 55.7 us,  4.0 sy,  0.0 ni, 31.0 id,  9.1 wa,  0.0 hi,  0.0 si,  0.1 st\r\n%Cpu(s):  1.1 us,  0.0 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  0.0 us,  1.1 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n\r\nGET /_search\r\n{\"query\":{\"match_all\":{}}}\r\n\r\n%Cpu(s):  1.1 us,  2.2 sy,  0.0 ni, 96.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 76.5 us,  0.0 sy,  0.0 ni, 23.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 85.9 us,  1.2 sy,  0.0 ni, 12.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n{\r\n  \"hits\": 670830085,\r\n  \"took\": 334,\r\n  \"_shards\": {\r\n    \"total\": 100,\r\n    \"successful\": 100,\r\n    \"failed\": 0\r\n  }\r\n}\r\n%Cpu(s): 24.7 us,  1.1 sy,  0.0 ni, 74.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  0.0 us,  1.1 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  1.1 sy,  0.0 ni, 96.7 id,  1.1 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  0.0 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n$\r\n```\r\n4. Upgrade to 6.3.1 by installing new package and restarting the service\r\n5. Run the same query again\r\n\r\n```console\r\n$ ./query.sh\r\nElasticsearch version 6.3.1\r\n\r\n%Cpu(s): 54.8 us,  4.0 sy,  0.0 ni, 32.0 id,  9.1 wa,  0.0 hi,  0.0 si,  0.1 st\r\n%Cpu(s):  2.2 us,  1.1 sy,  0.0 ni, 96.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n\r\nGET /_search\r\n{\"query\":{\"match_all\":{}}}\r\n\r\n%Cpu(s):  0.0 us,  1.1 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 25.6 us,  1.1 sy,  0.0 ni, 72.2 id,  0.0 wa,  0.0 hi,  1.1 si,  0.0 st\r\n%Cpu(s): 52.8 us,  1.1 sy,  0.0 ni, 46.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 62.1 us,  0.0 sy,  0.0 ni, 37.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 59.8 us,  1.1 sy,  0.0 ni, 39.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 58.8 us,  0.0 sy,  0.0 ni, 41.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 56.5 us,  0.0 sy,  0.0 ni, 43.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 44.3 us,  2.3 sy,  0.0 ni, 53.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n{\r\n  \"hits\": 670830085,\r\n  \"took\": 727,\r\n  \"_shards\": {\r\n    \"total\": 100,\r\n    \"successful\": 100,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  }\r\n}\r\n%Cpu(s):  1.1 us,  2.3 sy,  0.0 ni, 96.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  0.0 us,  1.1 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  1.1 sy,  0.0 ni, 97.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  1.1 sy,  0.0 ni, 97.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n$\r\n```\r\n\r\n- Run the same again while setting `max_concurrent_shard_requests` to 16\r\n\r\n```console\r\n$ ./query.sh ?max_concurrent_shard_requests=16\r\nElasticsearch version 6.3.1\r\n\r\n%Cpu(s): 53.4 us,  3.9 sy,  0.0 ni, 33.8 id,  8.8 wa,  0.0 hi,  0.0 si,  0.1 st\r\n%Cpu(s):  1.1 us,  1.1 sy,  0.0 ni, 97.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  2.3 sy,  0.0 ni, 96.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n\r\nGET /_search?max_concurrent_shard_requests=16\r\n{\"query\":{\"match_all\":{}}}\r\n\r\n%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s): 78.2 us,  2.3 sy,  0.0 ni, 19.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n{\r\n  \"hits\": 670830085,\r\n  \"took\": 309,\r\n  \"_shards\": {\r\n    \"total\": 100,\r\n    \"successful\": 100,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  }\r\n}\r\n%Cpu(s):  5.7 us,  2.3 sy,  0.0 ni, 92.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  0.0 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  0.0 sy,  0.0 ni, 98.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n%Cpu(s):  1.1 us,  1.1 sy,  0.0 ni, 97.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\r\n$\r\n```\r\n\r\n**Summary**:\r\n\r\n| Version | Query took (ms) | Peak user CPU usage | Extra query parameter |\r\n| ------- | --------------- | ------------------- | ---------------- |\r\n| 5.5.3   | 334 | 100 % | |\r\n| 6.3.1   | 727 | 62 % (only 5 threads running on a 8-core CPU) | |\r\n| 6.3.1   | 309 | 100 % | max_concurrent_shard_requests=16 |\r\n\r\n\r\n**Test scripts**:\r\n\r\n`populate.sh`:\r\n```bash\r\n#!/bin/bash\r\n\r\n# Create index-1 with 10M dummy documents\r\n\r\nfor j in $(seq 0 10); do\r\n        for i in $(seq 0 1000000); do echo -e '{ \"index\" : { \"_index\" : \"index-1\", \"_type\" : \"doc\" } }\\n{ \"message\" : \"Hello World!\" }'; done | curl -s -X POST \"localhost:9200/_bulk\" -H 'Content-Type: application/json' --data-binary @- | jq '{errors: .errors, took: .took}'\r\ndone\r\n\r\n# Clone index-1\r\n\r\nfor index in $(seq 2 20); do\r\n        curl -X POST \"localhost:9200/_reindex\" -H 'Content-Type: application/json' -d\"{\\\"source\\\": {\\\"index\\\": \\\"index-1\\\"}, \\\"dest\\\": {\\\"index\\\": \\\"index-$index\\\"}}\" &\r\ndone\r\n```\r\n\r\n`query.sh`:\r\n```bash\r\n#!/bin/bash\r\n\r\necho -n \"Elasticsearch version \"\r\ncurl -s localhost:9200 | jq -r .version.number\r\necho\r\n\r\ncurl -s -X POST \"localhost:9200/_cache/clear\" > /dev/null\r\n\r\nQUERY='{\"query\":{\"match_all\":{}}}'\r\n\r\ntop -d 0.1 -b | grep Cpu &\r\n\r\nsleep 0.5\r\necho\r\necho \"GET /_search$1\"\r\necho $QUERY\r\necho\r\ncurl -s -X GET \"localhost:9200/_search$1\" -H 'Content-Type: application/json' -d $QUERY | jq \"{hits: .hits.total, took: .took, _shards: ._shards}\"\r\nsleep 0.5\r\n\r\nkill $(jobs -p)\r\nwait\r\n```\r\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}