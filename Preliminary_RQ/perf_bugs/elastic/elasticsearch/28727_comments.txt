[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366736426","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-366736426","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":366736426,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NjczNjQyNg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-02-19T16:06:02Z","updated_at":"2018-02-19T16:06:02Z","author_association":"CONTRIBUTOR","body":"Joda does really quite a lot of work in trying to find the previous time zone transition, which I'd guess to be the expensive bit (and it appears on the stack trace in the investigation you were working on):\r\n\r\nhttps://github.com/JodaOrg/joda-time/blob/master/src/main/java/org/joda/time/tz/DateTimeZoneBuilder.java#L595\r\n\r\n`java.time` looks to be a lot smarter - it sorts out the transitions by year and involves a cache:\r\n\r\nhttp://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/time/zone/ZoneRules.java#l720\r\n\r\nAlthough I'm sure it'd be possible to put a cache around Joda, given that we're working on #27330 I think it would be a good idea to postpone any in-depth work on this until we can see what the effects of that would be.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366762857","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-366762857","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":366762857,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njc2Mjg1Nw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-02-19T17:46:04Z","updated_at":"2018-02-19T17:46:04Z","author_association":"CONTRIBUTOR","body":"This is good to know, thanks for sharing. I suspect that the `Rounding` class would be one of the easier ones to migrate so we might not have to wait long to know how much java.time helps.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366766978","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-366766978","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":366766978,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njc2Njk3OA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-02-19T18:04:19Z","updated_at":"2018-02-19T18:04:19Z","author_association":"CONTRIBUTOR","body":"> I suspect that the Rounding class would be one of the easier ones to migrate...\r\n\r\nSounds like you're volunteering!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371270241","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-371270241","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":371270241,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTI3MDI0MQ==","user":{"login":"Bargs","id":6239176,"node_id":"MDQ6VXNlcjYyMzkxNzY=","avatar_url":"https://avatars3.githubusercontent.com/u/6239176?v=4","gravatar_id":"","url":"https://api.github.com/users/Bargs","html_url":"https://github.com/Bargs","followers_url":"https://api.github.com/users/Bargs/followers","following_url":"https://api.github.com/users/Bargs/following{/other_user}","gists_url":"https://api.github.com/users/Bargs/gists{/gist_id}","starred_url":"https://api.github.com/users/Bargs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bargs/subscriptions","organizations_url":"https://api.github.com/users/Bargs/orgs","repos_url":"https://api.github.com/users/Bargs/repos","events_url":"https://api.github.com/users/Bargs/events{/privacy}","received_events_url":"https://api.github.com/users/Bargs/received_events","type":"User","site_admin":false},"created_at":"2018-03-07T20:16:14Z","updated_at":"2018-03-07T20:16:14Z","author_association":"NONE","body":"FYI we [have](https://github.com/elastic/kibana/issues/15732) [a](https://github.com/elastic/kibana/issues/10787) [few](https://github.com/elastic/kibana/issues/15662) issues related to this in Kibana. It's been on my todo list to look into possible solutions for awhile. I'm stoked to see the root problem may be solvable in ES.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/375603432","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-375603432","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":375603432,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NTYwMzQzMg==","user":{"login":"Retenodus","id":949128,"node_id":"MDQ6VXNlcjk0OTEyOA==","avatar_url":"https://avatars0.githubusercontent.com/u/949128?v=4","gravatar_id":"","url":"https://api.github.com/users/Retenodus","html_url":"https://github.com/Retenodus","followers_url":"https://api.github.com/users/Retenodus/followers","following_url":"https://api.github.com/users/Retenodus/following{/other_user}","gists_url":"https://api.github.com/users/Retenodus/gists{/gist_id}","starred_url":"https://api.github.com/users/Retenodus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Retenodus/subscriptions","organizations_url":"https://api.github.com/users/Retenodus/orgs","repos_url":"https://api.github.com/users/Retenodus/repos","events_url":"https://api.github.com/users/Retenodus/events{/privacy}","received_events_url":"https://api.github.com/users/Retenodus/received_events","type":"User","site_admin":false},"created_at":"2018-03-23T10:09:34Z","updated_at":"2018-03-23T10:09:34Z","author_association":"NONE","body":"Did something break/changed between 5.X and 6.X ? I run three clusters in 5.1, 5.6.8 and 6.1 and DateHistogram aggregations are basically unusable for me with the 6.X cluster. When I put the same data in 5.X clusters, I don't have any performance issues.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/375680549","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-375680549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":375680549,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NTY4MDU0OQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2018-03-23T14:21:12Z","updated_at":"2018-03-23T14:21:12Z","author_association":"CONTRIBUTOR","body":"> Did something break/changed between 5.X and 6.X ? I run three clusters in 5.1, 5.6.8 and 6.1 and DateHistogram aggregations are basically unusable for me with the 6.X cluster. When I put the same data in 5.X clusters, I don't have any performance issues.\r\n\r\nI don't think this is the right place to comment about this. If you can make a bash script that reproduces the issue against a clean cluster I'd file it as a separate issue. If you can't I'd take it to http://discuss.elastic.co/ .","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386873841","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-386873841","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":386873841,"node_id":"MDEyOklzc3VlQ29tbWVudDM4Njg3Mzg0MQ==","user":{"login":"timroes","id":877229,"node_id":"MDQ6VXNlcjg3NzIyOQ==","avatar_url":"https://avatars0.githubusercontent.com/u/877229?v=4","gravatar_id":"","url":"https://api.github.com/users/timroes","html_url":"https://github.com/timroes","followers_url":"https://api.github.com/users/timroes/followers","following_url":"https://api.github.com/users/timroes/following{/other_user}","gists_url":"https://api.github.com/users/timroes/gists{/gist_id}","starred_url":"https://api.github.com/users/timroes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timroes/subscriptions","organizations_url":"https://api.github.com/users/timroes/orgs","repos_url":"https://api.github.com/users/timroes/repos","events_url":"https://api.github.com/users/timroes/events{/privacy}","received_events_url":"https://api.github.com/users/timroes/received_events","type":"User","site_admin":false},"created_at":"2018-05-06T11:53:06Z","updated_at":"2018-05-06T11:53:06Z","author_association":"CONTRIBUTOR","body":"Since this pops up rather often, I wanted to add another possible performance improvement suggestion.\r\n\r\nBefore starting aggregating the date histogram, we could actually check if the query had an overall date range filter applied. We could than check on the start and end date in that date range. If both of these dates are within the same daylight saving time period, we could actually use the offset this time zone had during that period as an absolute fixed time zone (e.g. if I am just doing a date histogram with the timezone `Europe/Berlin` for an overall date range of April 1st, 2018 to July 1st 2018, I could safely rewrite the aggregation to use `UTC+2`/`Etc/GMT-2` timezone instead).\r\n\r\nThis would of course not solve the performance issue, when doing a date histogram over a period of time, that contained a DST switch, but already would improve for a lot of users, usually looking at smaller date ranges.\r\n\r\nSee also https://github.com/elastic/kibana/issues/18853 for a detailed meta issue on the Kibana side.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/387806324","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-387806324","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":387806324,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NzgwNjMyNA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-05-09T16:59:57Z","updated_at":"2018-05-09T16:59:57Z","author_association":"CONTRIBUTOR","body":"I agree this is a good idea. Unfortunately today queries and aggregations are kept completely unaware of each other so this would be hard to implement without adding unwanted dependencies.\r\n\r\nSomething less efficient than your proposal but that should cover a number of cases already would be to look at the min/max values that exist within the current shard and apply the optimization that you describe if all times within this interval have the same offset. With eg. daily indices, this optimization would still apply in most cases.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394382052","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-394382052","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":394382052,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDM4MjA1Mg==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T14:49:14Z","updated_at":"2018-06-04T14:49:14Z","author_association":"MEMBER","body":"Working my way through agg issues.  @jpountz, is this closeable now that #30534 merged, or was that just a partial solution to the slowdown?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394385063","html_url":"https://github.com/elastic/elasticsearch/issues/28727#issuecomment-394385063","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28727","id":394385063,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDM4NTA2Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T14:57:23Z","updated_at":"2018-06-04T14:57:23Z","author_association":"CONTRIBUTOR","body":"It is partial, but I think it's good enough to close this issue. Thanks for the ping.","performed_via_github_app":null}]