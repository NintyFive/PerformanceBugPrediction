{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5116","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5116/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5116/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5116/events","html_url":"https://github.com/elastic/elasticsearch/issues/5116","id":27545511,"node_id":"MDU6SXNzdWUyNzU0NTUxMQ==","number":5116,"title":"poor performance of parent/child queries in function_score query and rescore ","user":{"login":"karol-gwaj","id":1188157,"node_id":"MDQ6VXNlcjExODgxNTc=","avatar_url":"https://avatars3.githubusercontent.com/u/1188157?v=4","gravatar_id":"","url":"https://api.github.com/users/karol-gwaj","html_url":"https://github.com/karol-gwaj","followers_url":"https://api.github.com/users/karol-gwaj/followers","following_url":"https://api.github.com/users/karol-gwaj/following{/other_user}","gists_url":"https://api.github.com/users/karol-gwaj/gists{/gist_id}","starred_url":"https://api.github.com/users/karol-gwaj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karol-gwaj/subscriptions","organizations_url":"https://api.github.com/users/karol-gwaj/orgs","repos_url":"https://api.github.com/users/karol-gwaj/repos","events_url":"https://api.github.com/users/karol-gwaj/events{/privacy}","received_events_url":"https://api.github.com/users/karol-gwaj/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-02-13T19:34:51Z","updated_at":"2014-12-29T11:47:03Z","closed_at":"2014-12-29T11:47:03Z","author_association":"NONE","active_lock_reason":null,"body":"looks like function_score and rescore boost queries are not reusing parent/children documents loaded by main query\n\nfor example:\n\n``` JSON\n{\n   \"query\": {\n      \"bool\": {\n         \"must\": [\n            {\n               \"geo_bounding_box\": {\n                  \"@center\": {\n                     \"top_right\": \"52.68,-7.2\",\n                     \"bottom_left\": \"52.62,-7.28\"\n                  },\n                  \"_cache\": true,\n                  \"type\": \"indexed\"\n               }\n            },\n            {\n               \"has_child\": {\n                  \"type\": \"skill\",\n                  \"query\": {\n                     \"match\": {\n                        \"@title\": \"plumber\"\n                     }\n                  }\n               }\n            }\n         ]\n      }\n   },\n   \"rescore\": {\n      \"window_size\": 50,\n      \"query\": {\n         \"query_weight\": 0.5,\n         \"rescore_query\": {\n            \"has_child\": {\n               \"query\": {\n                  \"filtered\": {\n                     \"query\": {\n                        \"function_score\": {\n                           \"boost_mode\": \"replace\",\n                           \"score_mode\": \"first\",\n                           \"script_score\": {\n                              \"script\": \"...SCRIPT...\"\n                           }\n                        }\n                     }\n                  }\n               },\n               \"score_type\": \"max\",\n               \"type\": \"skill\"\n            }\n         },\n         \"rescore_query_weight\": 0.5\n      }\n   }\n}\n```\n\nexecutes in around 3 sec (for around 30m parent/child documents)\n\nwhen this query:\n\n``` JSON\n{\n   \"query\": {\n      \"bool\": {\n         \"must\": [\n            {\n               \"geo_bounding_box\": {\n                  \"@center\": {\n                     \"top_right\": \"52.68,-7.2\",\n                     \"bottom_left\": \"52.62,-7.28\"\n                  },\n                  \"_cache\": true,\n                  \"type\": \"indexed\"\n               }\n            },\n            {\n               \"has_child\": {\n                  \"type\": \"skill\",\n                  \"query\": {\n                     \"match\": {\n                        \"@title\": \"plumber\"\n                     }\n                  }\n               }\n            }\n         ]\n      }\n   },\n   \"rescore\": {\n      \"window_size\": 50,\n      \"query\": {\n         \"query_weight\": 0.5,\n         \"rescore_query\": {\n            \"has_child\": {\n               \"query\": {\n                  \"filtered\": {\n                     \"filter\": {\n                        \"bool\": {\n                           \"must\": [\n                              {\n                                 \"match\": {\n                                    \"@title\": \"plumber\"\n                                 }\n                              },\n                              {\n                                 \"has_parent\": {\n                                    \"type\": \"person\",\n                                    \"filter\": {\n                                       \"geo_bounding_box\": {\n                                          \"@center\": {\n                                             \"top_right\": \"52.68,-7.2\",\n                                             \"bottom_left\": \"52.62,-7.28\"\n                                          },\n                                          \"_cache\": true,\n                                          \"type\": \"indexed\"\n                                       }\n                                    }\n                                 }\n                              }\n                           ]\n                        }\n                     },\n                     \"query\": {\n                        \"function_score\": {\n                           \"boost_mode\": \"replace\",\n                           \"score_mode\": \"first\",\n                           \"script_score\": {\n                              \"script\": \"...SCRIPT...\"\n                           }\n                        }\n                     }\n                  }\n               },\n               \"score_type\": \"max\",\n               \"type\": \"skill\"\n            }\n         },\n         \"rescore_query_weight\": 0.5\n      }\n   }\n}\n```\n\nexecutes in around 100 milliseconds\n\nthe only difference is that rescore query in second example contains 'inverted' main query to filter child documents\n\nthis same problem occurs when using function_score query\n\nit will be more intuitive if this kind of boost/rescore queries could reuse results from the main query for parent child relationship (maybe controlled by additional field in rescore query)\n\ni know that this kind of behavior is probably intentional (as sometimes we might want to boost by child documents that are not returned by main query), still having to set inverted main query in rescore query is doubling the size of request sent to the server\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}