{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18680","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18680/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18680/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18680/events","html_url":"https://github.com/elastic/elasticsearch/issues/18680","id":157885177,"node_id":"MDU6SXNzdWUxNTc4ODUxNzc=","number":18680,"title":"Cached query/filter performance degradation from 1.7.3 to 2.3.2 ","user":{"login":"jfenc91","id":3521256,"node_id":"MDQ6VXNlcjM1MjEyNTY=","avatar_url":"https://avatars0.githubusercontent.com/u/3521256?v=4","gravatar_id":"","url":"https://api.github.com/users/jfenc91","html_url":"https://github.com/jfenc91","followers_url":"https://api.github.com/users/jfenc91/followers","following_url":"https://api.github.com/users/jfenc91/following{/other_user}","gists_url":"https://api.github.com/users/jfenc91/gists{/gist_id}","starred_url":"https://api.github.com/users/jfenc91/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jfenc91/subscriptions","organizations_url":"https://api.github.com/users/jfenc91/orgs","repos_url":"https://api.github.com/users/jfenc91/repos","events_url":"https://api.github.com/users/jfenc91/events{/privacy}","received_events_url":"https://api.github.com/users/jfenc91/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2016-06-01T11:35:39Z","updated_at":"2017-03-31T09:56:25Z","closed_at":"2017-03-31T09:56:24Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.2\n\n**JVM version**:  1.8.0_91–b14\n\n**OS version**: 3.13.0-62-generic #102-Ubuntu\n\nI have a set of 300 queries that are submitted concurrently.  When tested on a 1.7.3 cluster the queries complete in less than 2 seconds where as on a 2.3.2 cluster with the same hardware they take 60+ seconds to complete. \n\nHere are the hot threads captured during the queries on the 2.3.2 cluster:\n\nUsing the default store:\nhttps://gist.github.com/jfenc91/6c8aec1dcca232be533743528aa544a2\n\nUsing the mmap store:  (I have enough ram for everything to be in memory)\nhttps://gist.github.com/jfenc91/85d30a17a5684a2a2d7b0e9e8924ba0f\n\nBefore the filter cache is checked, there is apparently a call to query.createWeight that can get pretty expensive: https://github.com/apache/lucene-solr/blob/releases/lucene-solr/5.5.0/lucene/core/src/java/org/apache/lucene/search/IndexSearcher.java#L904-L907\n\nHiding the complexity of queries was part of the awesomeness of cached filters/queries.  Its seems like with the changes, that some of the evaluation of the query, where terms are compared against the document index, are happening, even though the query results are cached, because of that call to createWeight: https://github.com/apache/lucene-solr/blob/releases/lucene-solr/5.5.0/lucene/core/src/java/org/apache/lucene/search/PhraseQuery.java#L390-L395 \n\nI feel like extremely complex queries that changed occasionally were one of the best use cases for caching, but it doesn’t really seem to work with the cache rework that came with ES 2.x. If there were intended to be alternative ways to use this I would love to know. Thanks for reading!  \n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}