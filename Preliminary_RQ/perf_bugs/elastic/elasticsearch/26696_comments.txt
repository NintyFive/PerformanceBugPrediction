[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330463193","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330463193","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330463193,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDQ2MzE5Mw==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T08:09:55Z","updated_at":"2017-09-19T08:37:50Z","author_association":"NONE","body":"\"fixed\" my problem now by running manually: \r\n```\r\ncurl -XPUT 'elastic30:9200/my_index/_settings' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"index\" : {\r\n    \"warmer.enabled\": false\r\n  }\r\n}'\r\n```\r\nshould be looked after why this locks everything though .. \r\nFound this setting by looking at the source code.. INDEX_WARMER_ENABLED_SETTING etc.. because the warmer topic is completely removed from the ES 6.0 documentation... \r\nso should be disabled/removed completely from source imho or kept in documentation if some internals still rely on it.\r\n\r\n\r\ngoing from a mere 50 index req/s to 3000 req/s after this change\r\nhttps://www.dropbox.com/s/e24e1klza07ysnv/Screenshot%202017-09-19%2010.08.55.png?dl=0\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330464485","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330464485","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330464485,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDQ2NDQ4NQ==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T08:15:38Z","updated_at":"2017-09-19T08:16:47Z","author_association":"NONE","body":"Saw this behavior especially when updating time fields if it is of any help.. \r\nmaybe a lot of similar terms are generated for dates that are semi the same and one is locking each other\r\n```\r\n{\"update\":{\"_id\":\"267223693\",\"_index\":\"my_index\",\"_retry_on_conflict\":2,\"_type\":\"doc\"}}\r\n{\"doc\":{\"join_field\":{\"name\":\"user\"},\"lastlogindate\":\"2017-09-18 01:09:55\"},\"doc_as_upsert\":true}\r\n{\"update\":{\"_id\":\"65825209\",\"_index\":\"my_index\",\"_retry_on_conflict\":2,\"_type\":\"doc\"}}\r\n{\"doc\":{\"join_field\":{\"name\":\"user\"},\"lastlogindate\":\"2017-09-18 01:09:55\"},\"doc_as_upsert\":true}\r\n{\"update\":{\"_id\":\"282636413\",\"_index\":\"my_index\",\"_retry_on_conflict\":2,\"_type\":\"doc\"}}\r\n{\"doc\":{\"join_field\":{\"name\":\"user\"},\"lastlogindate\":\"2017-09-18 01:09:55\"},\"doc_as_upsert\":true}\r\n{\"update\":{\"_id\":\"271866584\",\"_index\":\"my_index\",\"_retry_on_conflict\":2,\"_type\":\"doc\"}}\r\n{\"doc\":{\"join_field\":{\"name\":\"user\"},\"lastlogindate\":\"2017-09-18 01:09:55\"},\"doc_as_upsert\":true} \r\n{\"update\":{\"_id\":\"282417656\",\"_index\":\"my_index\",\"_retry_on_conflict\":2,\"_type\":\"doc\"}}\r\n{\"doc\":{\"join_field\":{\"name\":\"user\"},\"lastlogindate\":\"2017-09-18 01:09:55\"},\"doc_as_upsert\":true}\r\n```\r\n```\r\n         \"lastlogindate\" : {\r\n            \"type\" : \"date\",\r\n            \"format\" : \"YYYY-MM-dd HH:mm:ss\"\r\n          },\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330476111","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330476111","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330476111,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDQ3NjExMQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T09:00:26Z","updated_at":"2017-09-19T09:00:26Z","author_association":"MEMBER","body":"Can you share your mapping ? It seems that you are using a `parent_join` field with a lot of relations, `parent_join` by default uses the warmer to load global ordinals. Global ordinals are needed for `parent/child` queries so they are built eagerly when a new searcher is built.\r\nYou can change the `refresh_interval` of your index (defaults to 1s), otherwise global ordinals are built from scratch every second. You could also disable this loading but this will impact your users that need to query the `parent_join` field:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/6.x/parent-join.html#_global_ordinals","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330511222","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330511222","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330511222,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDUxMTIyMg==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T11:32:18Z","updated_at":"2017-09-19T11:32:18Z","author_association":"NONE","body":"Hmm it seems that `eager_global_ordinals` is set to true.\r\n \r\nWill check to put it to false again, impact is quite massive of this if it's that.. 60 times as slow indexing is not nothing :). \r\nIn the latest update version I left the `{\"join_field\":{\"name\":\"user\"},` away from the updates when changing something to the parent.. but didn't have an impact. \r\n\r\nSo best way is to enable the warmer again and disable the eager_global_ordinals? \r\nThx\r\nJ\r\n\r\n```\r\n{\r\n  \"my_index\" : {\r\n    \"mappings\" : {\r\n      \"doc\" : {\r\n        \"properties\" : {\r\n          \"accountstatus\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"avatar\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"birthdate\" : {\r\n            \"type\" : \"date\",\r\n            \"format\" : \"YYYY-MM-dd\"\r\n          },\r\n          \"country\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"gender\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"hasavatar\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"join_field\" : {\r\n            \"type\" : \"join\",\r\n            \"eager_global_ordinals\" : true,\r\n            \"relations\" : {\r\n              \"user\" : [\r\n                \"i_m_int\",\r\n                \"i_int\",\r\n                \"i_text\"\r\n              ]\r\n            }\r\n          },\r\n          \"lastlogindate\" : {\r\n            \"type\" : \"date\",\r\n            \"format\" : \"YYYY-MM-dd HH:mm:ss\"\r\n          },\r\n          \"location\" : {\r\n            \"type\" : \"geo_point\"\r\n          },\r\n          \"mint_oid\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"mint_oii\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"userid\" : {\r\n            \"type\" : \"keyword\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330512961","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330512961","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330512961,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDUxMjk2MQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T11:41:11Z","updated_at":"2017-09-19T11:41:11Z","author_association":"MEMBER","body":"> So best way is to enable the warmer again and disable the eager_global_ordinals?\r\n\r\nNo, you should first check the `refresh_interval` of your index. If you use the default value of `1s` this means that global ordinals needs a rebuild every second. As I said global ordinals are needed for `parent/child` queries so they are eagerly loaded when a new searcher is built in order to not impact user queries. If you disable the loading, user queries are going to be slow. \r\nI hope you don't mind if I close this issue, we can continue the discussion on the forum (https://discuss.elastic.co/c/elasticsearch) but we reserve github for verified bugs and feature requests. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330516159","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330516159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330516159,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDUxNjE1OQ==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T11:56:00Z","updated_at":"2017-09-19T11:56:25Z","author_association":"NONE","body":"Ok thx, will do.  I will bump the refresh_interval to 1 minute as a fix. Still think something's fundamentally wrong in the way ordinals are built than, even bug like status if defaults have such an impact on indexing and are constantly competing/ utilizing up all cpu.. using a less strict refresh_interval for it as the default or a specific config for reloading ordinals would help I think.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330518226","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330518226","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330518226,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDUxODIyNg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T12:06:03Z","updated_at":"2017-09-19T12:06:03Z","author_association":"CONTRIBUTOR","body":"@jimczi why is this impacting indexing so much, I mean if run into slow refreshes find I buy that but why is indexing blocked so much. It might be good it get a thread dump when it's hanging @jrots I am with you this is weird why indexing perf is hit so much. Can you provide a stack dump when it's hanging as well as a sample batch request?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330526378","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-330526378","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":330526378,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDUyNjM3OA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T12:41:24Z","updated_at":"2017-09-19T12:41:24Z","author_association":"CONTRIBUTOR","body":"> Ok thx, will do. I will bump the refresh_interval to 1 minute as a fix. Still think something's fundamentally wrong in the way ordinals are built than, even bug like status if defaults have such an impact on indexing and are constantly competing/ utilizing up all cpu.. using a less strict refresh_interval for it as the default or a specific config for reloading ordinals would help I think.\r\n\r\nok let me clarify why this is happening. @jimczi pointed out that you are using `upsert` which explains what you are seeing. When you use an upsert we use a `_get` internally to fetch the latest document. this requires us to open a new searcher internally that will cause caches to be load. Elasticsearch is not made for things like counters that change very very frequently. The extra cost of global ordinals is what you pay in this case when we open a searcher and we block until it's all loaded. \r\n\r\nI also want to point out that changing the `refresh_interval` won't help here at all. The only thing you can do is to disable global ordinal loading or warmer loading all-together to make this situation better for you at this point.  One thing we can do in the future is to use a dedicated index reader that  doesn't do this kind of warming unless needed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331157185","html_url":"https://github.com/elastic/elasticsearch/issues/26696#issuecomment-331157185","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26696","id":331157185,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTE1NzE4NQ==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T13:32:08Z","updated_at":"2017-09-21T13:36:16Z","author_association":"NONE","body":"@s1monw I understand why it was slow a bit better.  I'm updating around +/- 1500 user records per minute to have a better/ accurate sorting value (lastlogindate) in this case for user records.  Wouldn't say that this is a \"crazy\" use case at all or that I'm slamming elastic with counter upserts in any way. \r\nWhenever you do anything search related that needs some kind of \"freshness\" to records will have the same issue I had. All the updates are just halting for seconds/ even minutes of time, making elastic completely unusable and data out of sync.  \r\nDisabling the warmer, works for me now.","performed_via_github_app":null}]