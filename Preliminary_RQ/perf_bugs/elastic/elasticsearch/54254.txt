{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54254","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54254/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54254/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54254/events","html_url":"https://github.com/elastic/elasticsearch/issues/54254","id":588272196,"node_id":"MDU6SXNzdWU1ODgyNzIxOTY=","number":54254,"title":"[Transform] continuous transform date_histogram group_by performance","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-26T09:23:53Z","updated_at":"2020-08-05T10:07:34Z","closed_at":"2020-03-26T20:38:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Affected versions**: < 7.7\r\n\r\n**Problem** \r\n\r\nContinuous Transforms are optimized for usecases, where sessions are grouped using [terms](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html). Grouping on `date_histogram` - e.g. per hour metrics -  with large datasets suffers from re-writing _all_ buckets for every checkpoint. This causes a lot of load on the cluster and might result in service degradation.\r\n\r\n**Mitigation** \r\n\r\n[Rollup](https://www.elastic.co/guide/en/elasticsearch/reference/master/rollup-overview.html) is optimized for this usecase and provides - via rollup search - aggregations on aggregations. Please consider using rollup instead.\r\n\r\nTransform will provide an optimization for grouping on date_histogram with version **7.7**. Please consider upgrading to **7.7**. (Note that you can use a separate cluster for transform as transform supports CCS)\r\n\r\nFor this optimization to kick in, the field you configure for `sync` _must_ be the same field you configure for the date_histogram `group_by`. Using multiple `group_by` is still possible, the transform gets optimized for the group_by where the field matches the field for time-based `sync`.\r\n\r\nIf you can not switch to rollup and upgrading to `7.7` is not possible, you can workaround the problem by adding a query filter that filters out data, you know is not required for updating the transform:\r\n\r\n```\r\n\"range\" : {\r\n    \"TIMESTAMP_FIELD\" : {\r\n        \"gte\" : \"FILTER_VALUE\",\r\n    }\r\n}\r\n```\r\n\r\n`TIMESTAMP_FIELD` should be the same that you use for `date_histogram` as well as `sync`.\r\n\r\nThe `FILTER_VALUE` should exclude at least everything before `delay + interval`. Also take bucket rounding into account.\r\n\r\nFor example if you group every 5 minutes and your ingest delay is 1 minute, the query should filter out everything older than 6 minutes. You can use date time logic for creating an absolute value: `now`.\r\n\r\nExamples: \r\n\r\n - `now-1h/h` excludes everything older than 1 hour rounded down to the hour\r\n - `now-1d/d` excludes everything older than 1 day rounded down to the day.\r\n\r\nNote: This does not have to be exact, you can filter less. However **it is important** to **round down** to a start of a bucket. Without rounding down, transform will overwrite older buckets with wrong/incomplete data.","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}