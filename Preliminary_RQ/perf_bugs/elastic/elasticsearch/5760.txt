{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5760","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5760/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5760/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5760/events","html_url":"https://github.com/elastic/elasticsearch/issues/5760","id":31229629,"node_id":"MDU6SXNzdWUzMTIyOTYyOQ==","number":5760,"title":"Poor aggragations/facets performance","user":{"login":"karol-gwaj","id":1188157,"node_id":"MDQ6VXNlcjExODgxNTc=","avatar_url":"https://avatars3.githubusercontent.com/u/1188157?v=4","gravatar_id":"","url":"https://api.github.com/users/karol-gwaj","html_url":"https://github.com/karol-gwaj","followers_url":"https://api.github.com/users/karol-gwaj/followers","following_url":"https://api.github.com/users/karol-gwaj/following{/other_user}","gists_url":"https://api.github.com/users/karol-gwaj/gists{/gist_id}","starred_url":"https://api.github.com/users/karol-gwaj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karol-gwaj/subscriptions","organizations_url":"https://api.github.com/users/karol-gwaj/orgs","repos_url":"https://api.github.com/users/karol-gwaj/repos","events_url":"https://api.github.com/users/karol-gwaj/events{/privacy}","received_events_url":"https://api.github.com/users/karol-gwaj/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2014-04-10T10:08:40Z","updated_at":"2016-03-15T21:38:41Z","closed_at":"2014-04-10T17:46:20Z","author_association":"NONE","active_lock_reason":null,"body":"looks like using filtered aggregates/facets could be (in some cases) 10 times slower than querying count directly (see example queries below).\n\nthis aggregate query executes in around 150ms:\n\n``` JSON\nPOST users/_search?search_type=count\n{\n   \"aggs\": {\n      \"skills\": {\n         \"filter\": {\n            \"fquery\": {\n               \"query\": {\n                  \"nested\": {\n                     \"path\": \"skills\",\n                     \"query\": {\n                        \"match\": {\n                           \"@name\": \"plumber\"\n                        }\n                     }\n                  }\n               }\n            }\n         }\n      },\n      \"people\": {\n         \"filter\": {\n            \"fquery\": {\n               \"query\": {\n                  \"match\": {\n                     \"@name\": \"plumber\"\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nwhen the queries below execute in around 10ms (each):\n\n``` JSON\nPOST users/_search?search_type=count\n{\n   \"query\": {\n      \"nested\": {\n         \"path\": \"skills\",\n         \"query\": {\n            \"match\": {\n                \"@name\": \"plumber\"\n            }\n         }\n      }\n   }\n}\n\nPOST user/_search?search_type=count\n{\n   \"query\": {\n      \"match\": {\n               \"@name\": \"plumber\"\n            }\n   }\n}\n```\n\nthis times are measure after multiple hits with this same query (so they all should be cached)\nmaking two sequential calls to compute count is still faster than one aggregate/facet call that suppose to do exactly this same\n\ncontext of my queries:\n- es 1.0.0\n- 6 servers (hosted in EC2)\n- 12 shards per index\n- 2 replicas\n- around 40m documents \n- document size < 50k\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}