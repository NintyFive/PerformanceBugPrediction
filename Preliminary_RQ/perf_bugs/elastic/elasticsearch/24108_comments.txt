[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294135009","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294135009","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294135009,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDEzNTAwOQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T10:50:41Z","updated_at":"2017-04-14T10:50:41Z","author_association":"MEMBER","body":"@anatoly21 Just double checking: So after registering a single percolator query that has a `nested` query this memory issue happens? Also I assume that search requests (containing `percolate` queries) are being executed. Do you have a lot of these search requests or just a few?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294136816","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294136816","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294136816,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDEzNjgxNg==","user":{"login":"anatoly21","id":27484990,"node_id":"MDQ6VXNlcjI3NDg0OTkw","avatar_url":"https://avatars3.githubusercontent.com/u/27484990?v=4","gravatar_id":"","url":"https://api.github.com/users/anatoly21","html_url":"https://github.com/anatoly21","followers_url":"https://api.github.com/users/anatoly21/followers","following_url":"https://api.github.com/users/anatoly21/following{/other_user}","gists_url":"https://api.github.com/users/anatoly21/gists{/gist_id}","starred_url":"https://api.github.com/users/anatoly21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anatoly21/subscriptions","organizations_url":"https://api.github.com/users/anatoly21/orgs","repos_url":"https://api.github.com/users/anatoly21/repos","events_url":"https://api.github.com/users/anatoly21/events{/privacy}","received_events_url":"https://api.github.com/users/anatoly21/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T11:07:48Z","updated_at":"2017-04-14T11:07:48Z","author_association":"NONE","body":"Yes, this issue occurs after registerering a single nested query. The attached pictures show results after execution of about 300 000 search requests (percolate queries). ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294137789","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294137789","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294137789,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDEzNzc4OQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T11:16:45Z","updated_at":"2017-04-14T11:31:40Z","author_association":"MEMBER","body":"@anatoly21 Thanks, are the search requests (with `percolate` query) similar (besides the document being percolated)? If possible can you share the search request (or at least how this query is structured)? I like to figure out if the `percolate` query itself gets cached.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294147545","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294147545","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294147545,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDE0NzU0NQ==","user":{"login":"anatoly21","id":27484990,"node_id":"MDQ6VXNlcjI3NDg0OTkw","avatar_url":"https://avatars3.githubusercontent.com/u/27484990?v=4","gravatar_id":"","url":"https://api.github.com/users/anatoly21","html_url":"https://github.com/anatoly21","followers_url":"https://api.github.com/users/anatoly21/followers","following_url":"https://api.github.com/users/anatoly21/following{/other_user}","gists_url":"https://api.github.com/users/anatoly21/gists{/gist_id}","starred_url":"https://api.github.com/users/anatoly21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anatoly21/subscriptions","organizations_url":"https://api.github.com/users/anatoly21/orgs","repos_url":"https://api.github.com/users/anatoly21/repos","events_url":"https://api.github.com/users/anatoly21/events{/privacy}","received_events_url":"https://api.github.com/users/anatoly21/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T12:44:14Z","updated_at":"2017-04-14T13:15:52Z","author_association":"NONE","body":"Mapping has a lot of keyword fields, therefore the attachment is a simplified version. Search requests are quite different. \r\n[env.zip](https://github.com/elastic/elasticsearch/files/922050/env.zip)\r\n\r\nPossibly this issue is related to https://github.com/elastic/elasticsearch/issues/23859 \r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294169324","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294169324","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294169324,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDE2OTMyNA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T15:02:21Z","updated_at":"2017-04-14T15:02:21Z","author_association":"MEMBER","body":"Thanks for reporting @anatoly21 and this is indeed a bad bug.\r\n\r\nThis problem is quite easily reproducible and affects all 5.x releases.\r\nThe cause of the memory issues / OOM is that the index reader for the memory index isn't closed,\r\nwhich then causes the cache entries in `BitsetFilterCache` to never get cleaned up.\r\n\r\nPrior to 5.0 the percolator had its own search context (PercolateContext), which always closed the readers of the in-memory index.\r\n\r\nI'll work on a fix. The percolator should just never use the `BitsetFilterCache` and it doesn't need since it is querying an in-memory index.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294170378","html_url":"https://github.com/elastic/elasticsearch/issues/24108#issuecomment-294170378","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24108","id":294170378,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDE3MDM3OA==","user":{"login":"anatoly21","id":27484990,"node_id":"MDQ6VXNlcjI3NDg0OTkw","avatar_url":"https://avatars3.githubusercontent.com/u/27484990?v=4","gravatar_id":"","url":"https://api.github.com/users/anatoly21","html_url":"https://github.com/anatoly21","followers_url":"https://api.github.com/users/anatoly21/followers","following_url":"https://api.github.com/users/anatoly21/following{/other_user}","gists_url":"https://api.github.com/users/anatoly21/gists{/gist_id}","starred_url":"https://api.github.com/users/anatoly21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anatoly21/subscriptions","organizations_url":"https://api.github.com/users/anatoly21/orgs","repos_url":"https://api.github.com/users/anatoly21/repos","events_url":"https://api.github.com/users/anatoly21/events{/privacy}","received_events_url":"https://api.github.com/users/anatoly21/received_events","type":"User","site_admin":false},"created_at":"2017-04-14T15:08:10Z","updated_at":"2017-04-14T15:08:10Z","author_association":"NONE","body":"Thank you. ","performed_via_github_app":null}]