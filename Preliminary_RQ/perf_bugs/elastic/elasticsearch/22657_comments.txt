[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273195558","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-273195558","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":273195558,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzE5NTU1OA==","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"created_at":"2017-01-17T15:10:54Z","updated_at":"2017-01-17T15:10:54Z","author_association":"CONTRIBUTOR","body":"Performed another similar test.\r\n\r\n[1] Normal `bool>must_not`\r\n\r\n```\r\nGET logstash-2017.01.17/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must_not\": {\r\n        \"exists\": {\r\n          \"field\": \"field1\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResults: from 40ms to 45ms\r\n\r\n[2] Constant score query\r\n\r\n```\r\nGET logstash-2017.01.17/_search\r\n{\r\n  \"query\": {\r\n    \"constant_score\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"must_not\": {\r\n            \"exists\": {\r\n              \"field\": \"field1\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResults: from 28ms to 41ms\r\n\r\n[2] Filter>bool>must_not\r\n\r\n```\r\nGET logstash-2017.01.17/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"must_not\": {\r\n            \"exists\": {\r\n              \"field\": \"field1\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResults: from 28ms to 39ms\r\n\r\n\r\nThe test was performed in an index with the following configuration in 1 node only:\r\n\r\n```\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 12215398,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  }\r\n}\r\n```\r\n\r\n```\r\nlogstash-2017.01.17                   2 p STARTED    2443397 182.1mb 127.0.0.1 PZyNogU\r\nlogstash-2017.01.17                   2 r UNASSIGNED                           \r\nlogstash-2017.01.17                   1 p STARTED    2441482 181.3mb 127.0.0.1 PZyNogU\r\nlogstash-2017.01.17                   1 r UNASSIGNED                           \r\nlogstash-2017.01.17                   3 p STARTED    2443738 201.9mb 127.0.0.1 PZyNogU\r\nlogstash-2017.01.17                   3 r UNASSIGNED                           \r\nlogstash-2017.01.17                   4 p STARTED    2444459 182.3mb 127.0.0.1 PZyNogU\r\nlogstash-2017.01.17                   4 r UNASSIGNED                           \r\nlogstash-2017.01.17                   0 p STARTED    2442322 236.5mb 127.0.0.1 PZyNogU\r\nlogstash-2017.01.17                   0 r UNASSIGNED   \r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273211056","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-273211056","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":273211056,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzIxMTA1Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-01-17T15:59:50Z","updated_at":"2017-01-17T15:59:50Z","author_association":"CONTRIBUTOR","body":"@jpountz it looks like the implicit `match_all` is scoring docs, which is taking the majority of the time.  Could this be improved by disabling scoring?\r\n\r\nI assume that most of the cost is building the bitset for all docs minus those which have the field.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273234566","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-273234566","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":273234566,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzIzNDU2Ng==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-01-17T17:16:08Z","updated_at":"2017-01-17T17:16:08Z","author_association":"CONTRIBUTOR","body":"> it looks like the implicit match_all is scoring docs, which is taking the majority of the time. Could this be improved by disabling scoring?\r\n\r\nThe long timing for scoring on the `match_all` query is not the cause of the problem but rather a side-effect: this query is mostly slow because it matches lots of documents. The reason is that we have to visit all matching documents in order to compute the total hit count and the top hits. We do indeed score, but if you look at the timings, it is not the bottleneck: we spend a similar amount of time in `advance` and `matches`. Disabling scoring might speed things up a bit, but not significantly.\r\n\r\nI don't think there is much we can do here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273236049","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-273236049","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":273236049,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzIzNjA0OQ==","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"created_at":"2017-01-17T17:21:25Z","updated_at":"2017-01-17T17:21:25Z","author_association":"CONTRIBUTOR","body":"@jpountz @clintongormley \r\n\r\nI opened this issue not only to see if we can do something to speed up this, but also to maybe think about a documentation change to make sure that everyone does an `exists` wrapped by a `constant_score`. That is what it gives the best results.\r\n\r\nAlso, visiting all the documents doesn't make any sense as when using `exists` we usually don't want the top documents, but just to filter those documents as soon as the field exists or not.\r\n\r\nShould we change the recommendation from `bool>must_not>exists` to `constant_score>filter>bool>must_not>exists`?\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/273254673","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-273254673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":273254673,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MzI1NDY3Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-01-17T18:25:43Z","updated_at":"2017-01-17T18:25:43Z","author_association":"CONTRIBUTOR","body":"Docs already mention that filters are preferable to queries when scores do not matter, so I think we are good from that perspective? The `exists` query is not different from other queries.\r\n\r\nAdditionally I'm wondering that the speedup that you saw with `constant_score` wrapping might be due to the fact the query gets cached rather than because scores are not computed?\r\n\r\n> Also, visiting all the documents doesn't make any sense as when using exists we usually don't want the top documents, but just to filter those documents as soon as the field exists or not.\r\n\r\nTrue, but even in that case we still need to count the number of documents that match.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290670187","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-290670187","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":290670187,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDY3MDE4Nw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T09:52:49Z","updated_at":"2017-03-31T09:52:49Z","author_association":"MEMBER","body":"@jpountz is there anything to be done here?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290693616","html_url":"https://github.com/elastic/elasticsearch/issues/22657#issuecomment-290693616","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","id":290693616,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDY5MzYxNg==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T11:59:36Z","updated_at":"2017-03-31T11:59:36Z","author_association":"CONTRIBUTOR","body":"Agreed there is nothing left to be done. Closing.","performed_via_github_app":null}]