{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36452","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36452/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36452/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36452/events","html_url":"https://github.com/elastic/elasticsearch/issues/36452","id":389475668,"node_id":"MDU6SXNzdWUzODk0NzU2Njg=","number":36452,"title":"Highlighters are slow with thousands of fields","user":{"login":"melissachang","id":10929390,"node_id":"MDQ6VXNlcjEwOTI5Mzkw","avatar_url":"https://avatars1.githubusercontent.com/u/10929390?v=4","gravatar_id":"","url":"https://api.github.com/users/melissachang","html_url":"https://github.com/melissachang","followers_url":"https://api.github.com/users/melissachang/followers","following_url":"https://api.github.com/users/melissachang/following{/other_user}","gists_url":"https://api.github.com/users/melissachang/gists{/gist_id}","starred_url":"https://api.github.com/users/melissachang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/melissachang/subscriptions","organizations_url":"https://api.github.com/users/melissachang/orgs","repos_url":"https://api.github.com/users/melissachang/repos","events_url":"https://api.github.com/users/melissachang/events{/privacy}","received_events_url":"https://api.github.com/users/melissachang/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-12-10T20:35:52Z","updated_at":"2019-04-04T09:51:39Z","closed_at":"2019-04-04T09:51:38Z","author_association":"NONE","active_lock_reason":null,"body":"I have a `multi_match` query that searches across all fields. Without highlighting, it takes 2 seconds.\r\n\r\nI'd like to use highlight to tell me which fields match. But highlight makes the query take several minutes long. I gave up after 2 minutes -- I'm not sure if the query ever finishes. I tried all three highlight types (unified, plain, fvh).\r\n\r\nSo instead of using highlight, I'm manually iterating through the source documents and finding the matching field. This only takes maybe .2 seconds.\r\n\r\n(Curious about how Elasticsearch query works -- as part of the query process, does Elasticsearch know which field matches? Say document D contains field F that matches query Q. When Elasticsearch determines that D is a result for Q, does Elasticserach know that F contains Q, as part of that process?)\r\n\r\nWould it be possible to create a highlight type that is fast? It would either return only the field that matched, or the field name and entire contents of the field.\r\n\r\nHere are some timing stats. My index has 121k documents. Across all documents there are 7k fields; a particular document will have a small subset of the 7k fields.\r\n\r\n~/data-explorer (master): curl \"localhost:9200/_cat/indices?v&s=index\"\r\nhealth status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size\r\nyellow open   nurse_s_health_study            kMyBnxPVTLC7W5ufetg3UQ   5   1     121701            0      5.6gb          5.6gb\r\nyellow open   nurse_s_health_study_fvh        snoFPeGQSWqXZL8rGG-1qg   5   1     121701            0      8.9gb          8.9gb\r\n\r\n**no highlighter**\r\n```\r\nGET /nurse_s_health_study/_search\r\n{\r\n  \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"pre\",\r\n      \"type\": \"phrase_prefix\"\r\n    }\r\n  },\r\n  \"size\": 10\r\n}\r\n```\r\n2.2s\r\n**unified highlighter**\r\n```\r\nGET /nurse_s_health_study/_search\r\n{\r\n    \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"pre\",\r\n      \"type\": \"phrase_prefix\"\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"fields\": {\r\n      \"*\": {\r\n        \"type\": \"unified\"\r\n      }\r\n    }\r\n  },\r\n  \"size\": 10\r\n}\r\n```\r\nGave up after 2 mins.\r\n**plain highlighter**\r\n```\r\nGET /nurse_s_health_study/_search\r\n{\r\n    \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"pre\",\r\n      \"type\": \"phrase_prefix\"\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"fields\": {\r\n      \"*\": {\r\n        \"type\": \"plain\"\r\n      }\r\n    }\r\n  },\r\n  \"size\": 10\r\n}\r\n```\r\nGave up after 4 minutes.\r\n**fvh highligher**\r\nI reindexed with `term_vector = with_positions_offsets`.\r\n```\r\nGET /nurse_s_health_study_fvh/_search\r\n{\r\n    \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"pre\",\r\n      \"type\": \"phrase_prefix\"\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"fields\": {\r\n      \"*\": {\r\n        \"type\": \"fvh\"\r\n      }\r\n    }\r\n  },\r\n  \"size\": 10\r\n}\r\n```\r\nGave up after 2 minutes.\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}