{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25050","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25050/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25050/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25050/events","html_url":"https://github.com/elastic/elasticsearch/issues/25050","id":233477446,"node_id":"MDU6SXNzdWUyMzM0Nzc0NDY=","number":25050,"title":"return very slow when using ngram char split","user":{"login":"lixiuna0908","id":12512226,"node_id":"MDQ6VXNlcjEyNTEyMjI2","avatar_url":"https://avatars2.githubusercontent.com/u/12512226?v=4","gravatar_id":"","url":"https://api.github.com/users/lixiuna0908","html_url":"https://github.com/lixiuna0908","followers_url":"https://api.github.com/users/lixiuna0908/followers","following_url":"https://api.github.com/users/lixiuna0908/following{/other_user}","gists_url":"https://api.github.com/users/lixiuna0908/gists{/gist_id}","starred_url":"https://api.github.com/users/lixiuna0908/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lixiuna0908/subscriptions","organizations_url":"https://api.github.com/users/lixiuna0908/orgs","repos_url":"https://api.github.com/users/lixiuna0908/repos","events_url":"https://api.github.com/users/lixiuna0908/events{/privacy}","received_events_url":"https://api.github.com/users/lixiuna0908/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-06-05T02:00:00Z","updated_at":"2017-06-07T07:10:41Z","closed_at":"2017-06-05T08:50:33Z","author_association":"NONE","active_lock_reason":null,"body":"we deploy elasticsearch 5.* version using ngram char split in our 5 servers which one of them is master node, and others are data nodes.\r\n\r\n**settings as follows:**\r\n```\r\n{\r\n  \"trimps2\": {\r\n    \"settings\": {\r\n      \"index\": {\r\n        \"number_of_shards\": \"5\",\r\n        \"provided_name\": \"my_ngram_resource\",\r\n        \"creation_date\": \"1496286488490\",\r\n        \"analysis\": {\r\n          \"analyzer\": {\r\n            \"charSplit\": {\r\n              \"type\": \"custom\",\r\n              \"tokenizer\": \"ngram_tokenizer\"\r\n            }\r\n          },\r\n          \"tokenizer\": {\r\n            \"ngram_tokenizer\": {\r\n              \"token_chars\": [\r\n                \"letter\",\r\n                \"digit\",\r\n                \"punctuation\"\r\n              ],\r\n              \"min_gram\": \"1\",\r\n              \"type\": \"nGram\",\r\n              \"max_gram\": \"1\"\r\n            }\r\n          }\r\n        },\r\n        \"number_of_replicas\": \"0\",\r\n        \"uuid\": \"QAs4jqBfTt2xiO0OMFOXzQ\",\r\n        \"version\": {\r\n          \"created\": \"5030099\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**mapping as follows:**\r\n```\r\n{\r\n  \"trimps2\": {\r\n    \"mappings\": {\r\n      \"tb\": {\r\n        \"properties\": {\r\n          \"address\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"id_card\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"mobile_phone\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"phone\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"post_code\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"realname\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          },\r\n          \"username\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"analyzer\": \"charSplit\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**we find it return data very slowly when we use query phrase as follows:**\r\n\r\n```\r\nPOST trimps2/tb/_search\r\n{\r\n  \"query\":  {\r\n    \"multi_match\": {\r\n      \"query\": \"138141\",\r\n      \"type\": \"phrase\",\r\n      \"slop\": 0,\r\n      \"fields\": [\r\n        \"username\",\r\n        \"realname\",\r\n        \"phone\",\r\n        \"mobile_phone\",\r\n        \"id_card\",\r\n        \"address\",\r\n        \"post_code\"\r\n      ],\r\n      \"analyzer\": \"charSplit\",\r\n      \"max_expansions\": 1\r\n    }\r\n  },\r\n  \"profile\": true,\r\n  \"from\": 100\r\n}\r\n```\r\n**then, the return data as follows:**\r\n```\r\n\"profile\": {\r\n    \"shards\": [\r\n      {\r\n        \"id\": \"[TZLIzKdMShijRmqi5q9ZMw][trimps2][1]\",\r\n        \"searches\": [\r\n          {\r\n            \"query\": [\r\n              {\r\n                \"type\": \"BooleanQuery\",\r\n                \"description\": \"+(address:\"1 3 8 1 4 1\" | id_card:\"1 3 8 1 4 1\" | mobile_phone:\"1 3 8 1 4 1\" | phone:\"1 3 8 1 4 1\" | post_code:\"1 3 8 1 4 1\" | realname:\"1 3 8 1 4 1\" | username:\"1 3 8 1 4 1\") #(ConstantScore(_type:tb))^0.0\",\r\n                \"time\": \"83253.58251ms\",\r\n                \"breakdown\": {\r\n                  \"score\": 24716112935,\r\n                  \"build_scorer_count\": 1,\r\n                  \"match_count\": 31173147,\r\n                  \"create_weight\": 84788168,\r\n                  \"next_doc\": 35685629647,\r\n                  \"match\": 22691767834,\r\n                  \"create_weight_count\": 1,\r\n                  \"next_doc_count\": 31173148,\r\n                  \"score_count\": 11170,\r\n                  \"build_scorer\": 12926458,\r\n                  \"advance\": 0,\r\n                  \"advance_count\": 0\r\n                },\r\n                \"children\": [\r\n                  {\r\n                    \"type\": \"DisjunctionMaxQuery\",\r\n                    \"description\": \"(address:\"1 3 8 1 4 1\" | id_card:\"1 3 8 1 4 1\" | mobile_phone:\"1 3 8 1 4 1\" | phone:\"1 3 8 1 4 1\" | post_code:\"1 3 8 1 4 1\" | realname:\"1 3 8 1 4 1\" | username:\"1 3 8 1 4 1\")\",\r\n                    \"time\": \"69752.35071ms\",\r\n                    \"breakdown\": {\r\n                      \"score\": 24713740053,\r\n                      \"build_scorer_count\": 1,\r\n                      \"match_count\": 31173147,\r\n                      \"create_weight\": 84741719,\r\n                      \"next_doc\": 0,\r\n                      \"match\": 20160625790,\r\n                      \"create_weight_count\": 1,\r\n                      \"next_doc_count\": 0,\r\n                      \"score_count\": 11170,\r\n                      \"build_scorer\": 332724,\r\n                      \"advance\": 24730552960,\r\n                      \"advance_count\": 31173148\r\n                    },\r\n                    \"children\": [\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"address:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"4293.176204ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 1278093283,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 651714,\r\n                          \"create_weight\": 31859192,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 880991501,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 27,\r\n                          \"build_scorer\": 176911,\r\n                          \"advance\": 2100751859,\r\n                          \"advance_count\": 651715\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"id_card:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"5518.753810ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 0,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 1681553,\r\n                          \"create_weight\": 8691525,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 1556429401,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 0,\r\n                          \"build_scorer\": 19189,\r\n                          \"advance\": 3950250586,\r\n                          \"advance_count\": 1681554\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"mobile_phone:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"35756.24689ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 16255859298,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 25631907,\r\n                          \"create_weight\": 40331,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 10502289703,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 10989,\r\n                          \"build_scorer\": 15227,\r\n                          \"advance\": 8946767522,\r\n                          \"advance_count\": 25631908\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"phone:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"7599.542964ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 3584294628,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 4481751,\r\n                          \"create_weight\": 37066,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 1771748313,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 113,\r\n                          \"build_scorer\": 14757,\r\n                          \"advance\": 2234484582,\r\n                          \"advance_count\": 4481752\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"post_code:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"2916.660629ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 76925602,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 328741,\r\n                          \"create_weight\": 40851,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 500365619,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 3,\r\n                          \"build_scorer\": 13904,\r\n                          \"advance\": 2338657165,\r\n                          \"advance_count\": 328742\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"realname:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"191.0606490ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 37897899,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 5900,\r\n                          \"create_weight\": 43407114,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 40885487,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 1,\r\n                          \"build_scorer\": 18164,\r\n                          \"advance\": 68840181,\r\n                          \"advance_count\": 5901\r\n                        }\r\n                      },\r\n                      {\r\n                        \"type\": \"PhraseQuery\",\r\n                        \"description\": \"username:\"1 3 8 1 4 1\"\",\r\n                        \"time\": \"6112.909024ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 3477860293,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 1103389,\r\n                          \"create_weight\": 609428,\r\n                          \"next_doc\": 0,\r\n                          \"match\": 844641749,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 0,\r\n                          \"score_count\": 109,\r\n                          \"build_scorer\": 14529,\r\n                          \"advance\": 1787576135,\r\n                          \"advance_count\": 1103390\r\n                        }\r\n                      }\r\n                    ]\r\n                  },\r\n                  {\r\n                    \"type\": \"BoostQuery\",\r\n                    \"description\": \"(ConstantScore(_type:tb))^0.0\",\r\n                    \"time\": \"6276.341551ms\",\r\n                    \"breakdown\": {\r\n                      \"score\": 0,\r\n                      \"build_scorer_count\": 1,\r\n                      \"match_count\": 0,\r\n                      \"create_weight\": 19257,\r\n                      \"next_doc\": 3346713972,\r\n                      \"match\": 0,\r\n                      \"create_weight_count\": 1,\r\n                      \"next_doc_count\": 31173148,\r\n                      \"score_count\": 0,\r\n                      \"build_scorer\": 12540883,\r\n                      \"advance\": 2865977199,\r\n                      \"advance_count\": 19917090\r\n                    },\r\n                    \"children\": [\r\n                      {\r\n                        \"type\": \"TermQuery\",\r\n                        \"description\": \"_type:tb\",\r\n                        \"time\": \"2745.874807ms\",\r\n                        \"breakdown\": {\r\n                          \"score\": 0,\r\n                          \"build_scorer_count\": 1,\r\n                          \"match_count\": 0,\r\n                          \"create_weight\": 10657,\r\n                          \"next_doc\": 1233157250,\r\n                          \"match\": 0,\r\n                          \"create_weight_count\": 1,\r\n                          \"next_doc_count\": 31173148,\r\n                          \"score_count\": 0,\r\n                          \"build_scorer\": 12473624,\r\n                          \"advance\": 1449143036,\r\n                          \"advance_count\": 19917090\r\n                        }\r\n                      }\r\n                    ]\r\n                  }\r\n                ]\r\n              }\r\n            ],\r\n            \"rewrite_time\": 112744,\r\n            \"collector\": [\r\n              {\r\n                \"name\": \"SimpleTopScoreDocCollector\",\r\n                \"reason\": \"search_top_hits\",\r\n                \"time\": \"24717.87966ms\"\r\n              }\r\n            ]\r\n          }\r\n        ],\r\n        \"aggregations\": [\r\n\r\n        ]\r\n      },\r\n```\r\n**as we see, return time is about 24717.87966ms, It is almost impossible to accept. Any idea to make fast to get return data, thank you very much.**\r\n\r\n\r\n**Elasticsearch version**: 5.0.2\r\n\r\n**JVM version** (`java -version`): 1.8.0\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux ubuntu 3.16.0-30-generic #40~14.04.1-Ubuntu SMP Thu Jan 15 17:43:14 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}