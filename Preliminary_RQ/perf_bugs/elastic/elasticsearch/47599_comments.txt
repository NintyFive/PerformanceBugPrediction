[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/538514561","html_url":"https://github.com/elastic/elasticsearch/issues/47599#issuecomment-538514561","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47599","id":538514561,"node_id":"MDEyOklzc3VlQ29tbWVudDUzODUxNDU2MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-10-04T18:38:28Z","updated_at":"2019-10-04T18:38:28Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features (:Core/Features/Watcher)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/538517729","html_url":"https://github.com/elastic/elasticsearch/issues/47599#issuecomment-538517729","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47599","id":538517729,"node_id":"MDEyOklzc3VlQ29tbWVudDUzODUxNzcyOQ==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-10-04T18:47:53Z","updated_at":"2019-10-04T18:47:53Z","author_association":"CONTRIBUTOR","body":"Thanks to @SuXingLee for finding this issue and providing a test case on #46790.  \r\n\r\nI logged this issue as reference point and will close out this issue as fixed by #41451 in 7.3.0. I will evaluate if Watcher needs to implement the workaround for older versions in a different PR. \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/538657577","html_url":"https://github.com/elastic/elasticsearch/issues/47599#issuecomment-538657577","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47599","id":538657577,"node_id":"MDEyOklzc3VlQ29tbWVudDUzODY1NzU3Nw==","user":{"login":"SuXingLee","id":9591097,"node_id":"MDQ6VXNlcjk1OTEwOTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9591097?v=4","gravatar_id":"","url":"https://api.github.com/users/SuXingLee","html_url":"https://github.com/SuXingLee","followers_url":"https://api.github.com/users/SuXingLee/followers","following_url":"https://api.github.com/users/SuXingLee/following{/other_user}","gists_url":"https://api.github.com/users/SuXingLee/gists{/gist_id}","starred_url":"https://api.github.com/users/SuXingLee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SuXingLee/subscriptions","organizations_url":"https://api.github.com/users/SuXingLee/orgs","repos_url":"https://api.github.com/users/SuXingLee/repos","events_url":"https://api.github.com/users/SuXingLee/events{/privacy}","received_events_url":"https://api.github.com/users/SuXingLee/received_events","type":"User","site_admin":false},"created_at":"2019-10-05T15:03:08Z","updated_at":"2019-10-05T15:03:08Z","author_association":"NONE","body":"Thank you for your reply. \r\n> Until `7.3.0` the only workaround is to set the [BackOffPolicy](https://github.com/elastic/elasticsearch/blob/v6.8.3/server/src/main/java/org/elasticsearch/action/bulk/BackoffPolicy.java) to `BackoffPolicy.noBackoff()` so that the `Retry` does not kick in.\r\n\r\nPS: Another workaround is not to set the bulk flush interval.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/541789733","html_url":"https://github.com/elastic/elasticsearch/issues/47599#issuecomment-541789733","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47599","id":541789733,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MTc4OTczMw==","user":{"login":"SuXingLee","id":9591097,"node_id":"MDQ6VXNlcjk1OTEwOTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9591097?v=4","gravatar_id":"","url":"https://api.github.com/users/SuXingLee","html_url":"https://github.com/SuXingLee","followers_url":"https://api.github.com/users/SuXingLee/followers","following_url":"https://api.github.com/users/SuXingLee/following{/other_user}","gists_url":"https://api.github.com/users/SuXingLee/gists{/gist_id}","starred_url":"https://api.github.com/users/SuXingLee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SuXingLee/subscriptions","organizations_url":"https://api.github.com/users/SuXingLee/orgs","repos_url":"https://api.github.com/users/SuXingLee/repos","events_url":"https://api.github.com/users/SuXingLee/events{/privacy}","received_events_url":"https://api.github.com/users/SuXingLee/received_events","type":"User","site_admin":false},"created_at":"2019-10-14T16:47:11Z","updated_at":"2019-10-14T16:47:11Z","author_association":"NONE","body":"@jakelandis \r\nAfter modifying the test case: when the `Flush` logic is executed first and a failure occurs. I found that it seems that a similar problem still occurs in the latest version of ES.  #48013 is the newest test case in master branch. I am not sure and hope you can verify it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/547657412","html_url":"https://github.com/elastic/elasticsearch/issues/47599#issuecomment-547657412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47599","id":547657412,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzY1NzQxMg==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-10-29T22:29:00Z","updated_at":"2019-10-29T22:29:00Z","author_association":"CONTRIBUTOR","body":"Re-opening issue since as @SuXingLee points out this can still happen if the documents that flush is flushing fail. \r\n\r\nIn the original description and what is fixed in 7.3.0 is \"normal requests\" fail -> Flush kicks in but is blocked by the request that failured -> Retry tries to happens but is blocked by Flush.  The more granular locking fixes that deadlock case.  \r\n\r\nHere, the question is what happens if the \"Flush request\" fail (which grabs the lock and only slot in the scheduler), and the Retry attempts to kick in. Retry can't run because the one and only slot in the scheduler is consumed by Flush, but Flush is waiting on the Retry to finish.  Hence the deadlock. \r\n\r\nThe workarounds are the same, disable Flush (pass null) , or disable Retry (use `BackoffPolicy.noBackoff()`). \r\n\r\n@SuXingLee - thanks again for the test that illustrates this.  I am still weighing the options of increasing single scheduler number of slots vs. using separate schedulers for flush and retry. ","performed_via_github_app":null}]