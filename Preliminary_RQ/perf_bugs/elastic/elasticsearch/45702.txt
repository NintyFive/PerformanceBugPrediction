{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45702","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45702/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45702/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45702/events","html_url":"https://github.com/elastic/elasticsearch/issues/45702","id":482385779,"node_id":"MDU6SXNzdWU0ODIzODU3Nzk=","number":45702,"title":"Slow date_histogram after upgrading to 7.3.0","user":{"login":"brenuart","id":3028601,"node_id":"MDQ6VXNlcjMwMjg2MDE=","avatar_url":"https://avatars3.githubusercontent.com/u/3028601?v=4","gravatar_id":"","url":"https://api.github.com/users/brenuart","html_url":"https://github.com/brenuart","followers_url":"https://api.github.com/users/brenuart/followers","following_url":"https://api.github.com/users/brenuart/following{/other_user}","gists_url":"https://api.github.com/users/brenuart/gists{/gist_id}","starred_url":"https://api.github.com/users/brenuart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brenuart/subscriptions","organizations_url":"https://api.github.com/users/brenuart/orgs","repos_url":"https://api.github.com/users/brenuart/repos","events_url":"https://api.github.com/users/brenuart/events{/privacy}","received_events_url":"https://api.github.com/users/brenuart/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":30486044,"node_id":"MDU6TGFiZWwzMDQ4NjA0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eregression","name":">regression","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"csoulios","id":1561376,"node_id":"MDQ6VXNlcjE1NjEzNzY=","avatar_url":"https://avatars2.githubusercontent.com/u/1561376?v=4","gravatar_id":"","url":"https://api.github.com/users/csoulios","html_url":"https://github.com/csoulios","followers_url":"https://api.github.com/users/csoulios/followers","following_url":"https://api.github.com/users/csoulios/following{/other_user}","gists_url":"https://api.github.com/users/csoulios/gists{/gist_id}","starred_url":"https://api.github.com/users/csoulios/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/csoulios/subscriptions","organizations_url":"https://api.github.com/users/csoulios/orgs","repos_url":"https://api.github.com/users/csoulios/repos","events_url":"https://api.github.com/users/csoulios/events{/privacy}","received_events_url":"https://api.github.com/users/csoulios/received_events","type":"User","site_admin":false},"assignees":[{"login":"csoulios","id":1561376,"node_id":"MDQ6VXNlcjE1NjEzNzY=","avatar_url":"https://avatars2.githubusercontent.com/u/1561376?v=4","gravatar_id":"","url":"https://api.github.com/users/csoulios","html_url":"https://github.com/csoulios","followers_url":"https://api.github.com/users/csoulios/followers","following_url":"https://api.github.com/users/csoulios/following{/other_user}","gists_url":"https://api.github.com/users/csoulios/gists{/gist_id}","starred_url":"https://api.github.com/users/csoulios/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/csoulios/subscriptions","organizations_url":"https://api.github.com/users/csoulios/orgs","repos_url":"https://api.github.com/users/csoulios/repos","events_url":"https://api.github.com/users/csoulios/events{/privacy}","received_events_url":"https://api.github.com/users/csoulios/received_events","type":"User","site_admin":false}],"milestone":null,"comments":28,"created_at":"2019-08-19T15:41:13Z","updated_at":"2019-10-07T10:31:24Z","closed_at":"2019-09-16T20:16:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n`Version: 7.3.0, Build: default/rpm/de777fa/2019-07-24T18:30:11.767338Z, JVM: 12.0.1`\r\n\r\n**Plugins installed**: []\r\n`repository-s3`\r\n\r\n**JVM version** (`java -version`):\r\nJVM shipped with Elasticsearch (rpm)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n`Linux es-hot-03.aegaeon-it.com 4.9.120-xxxx-std-ipv6-64 #327490 SMP Thu Aug 16 10:11:35 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe noticed a severe degradation of `date_histogram` performance after upgrading from Elasticsearch `6.8.2` to the latest `7.3.0`.\r\n\r\nThe table below shows the execution time of the same query on the same cluster before and after the upgrade. The first execution happens after caches are cleared as follows:\r\n- ES caches are cleared with `POST _cache/clear`\r\n- Filesystem caches are invalidated by doing a _cat_ of all files found in `/var/lib/elasticsearch` do `/dev/null` (that's the best we found...)\r\n\r\nTimings are as follows:\r\n```\r\nES Version   Timings (ms)\r\n------------------------------------\r\n6.8.2        10388,  5797,  7319\r\n7.3.0        21553, 15138, 14833\r\n```\r\n\r\nAs you notice `7.3.0` is at **least twice slower** than `6.8.2`.\r\n\r\nThe dataset is made of about `650m` documents spread evenly between 15 indexes. Indexes have 3 shards each and no replica. The cluster is made of three nodes, each with 7Gb RAM (of each 4Gb is allocated to the heap) and 2 vCPUs at 3.1Ghz. There is no activity on the cluster besides this test query.\r\n\r\nThe query targets only half of the documents (using a _date_range_) and builds a `date_histogram` with buckets of `3h`. This query is actually what KIbana's Discover panel will do...\r\n\r\n```\r\n{\r\n  \"size\": 500,\r\n  \"sort\": [\r\n    {\r\n      \"@timestamp\": {\r\n        \"order\": \"desc\",\r\n        \"unmapped_type\": \"boolean\"\r\n      }\r\n    }\r\n  ],\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"interval\": \"3h\",\r\n        \"time_zone\": \"Europe/Berlin\",\r\n        \"min_doc_count\": 1\r\n      }\r\n    }\r\n  },\r\n  \"docvalue_fields\": [\r\n    {\r\n      \"field\": \"@timestamp\",\r\n      \"format\": \"date_time\"\r\n    }\r\n  ],\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"format\": \"strict_date_optional_time\",\r\n              \"gte\": \"2019-01-09T00:00:00.000Z\",\r\n              \"lte\": \"2019-01-15T00:00:00.000Z\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWe are very surprised by this drop of performance...\r\nDid we forgot to change some configurations parameters when doing the upgrade or is it a regression in ES itself ?","closed_by":{"login":"csoulios","id":1561376,"node_id":"MDQ6VXNlcjE1NjEzNzY=","avatar_url":"https://avatars2.githubusercontent.com/u/1561376?v=4","gravatar_id":"","url":"https://api.github.com/users/csoulios","html_url":"https://github.com/csoulios","followers_url":"https://api.github.com/users/csoulios/followers","following_url":"https://api.github.com/users/csoulios/following{/other_user}","gists_url":"https://api.github.com/users/csoulios/gists{/gist_id}","starred_url":"https://api.github.com/users/csoulios/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/csoulios/subscriptions","organizations_url":"https://api.github.com/users/csoulios/orgs","repos_url":"https://api.github.com/users/csoulios/repos","events_url":"https://api.github.com/users/csoulios/events{/privacy}","received_events_url":"https://api.github.com/users/csoulios/received_events","type":"User","site_admin":false},"performed_via_github_app":null}