[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/235876987","html_url":"https://github.com/elastic/elasticsearch/issues/19646#issuecomment-235876987","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19646","id":235876987,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNTg3Njk4Nw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-28T12:11:00Z","updated_at":"2016-07-28T12:11:00Z","author_association":"CONTRIBUTOR","body":"The problem here is the long GCs you're getting, essentially because you're overwhelming the heap with your aggregations (probably because you're generating way too many buckets).\n\nYou need to simplify your aggs structure.  Imagine if you have 1,000 buckets and each has another 1,000 buckets, and each of those has another 1,000 buckets.  That's a trillion buckets!  It's just not going to work.  In fact, we've recently added a circuit breaker which will prevent such aggs from running https://github.com/elastic/elasticsearch/pull/19394\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/235884899","html_url":"https://github.com/elastic/elasticsearch/issues/19646#issuecomment-235884899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19646","id":235884899,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNTg4NDg5OQ==","user":{"login":"Cardy165","id":9974991,"node_id":"MDQ6VXNlcjk5NzQ5OTE=","avatar_url":"https://avatars0.githubusercontent.com/u/9974991?v=4","gravatar_id":"","url":"https://api.github.com/users/Cardy165","html_url":"https://github.com/Cardy165","followers_url":"https://api.github.com/users/Cardy165/followers","following_url":"https://api.github.com/users/Cardy165/following{/other_user}","gists_url":"https://api.github.com/users/Cardy165/gists{/gist_id}","starred_url":"https://api.github.com/users/Cardy165/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cardy165/subscriptions","organizations_url":"https://api.github.com/users/Cardy165/orgs","repos_url":"https://api.github.com/users/Cardy165/repos","events_url":"https://api.github.com/users/Cardy165/events{/privacy}","received_events_url":"https://api.github.com/users/Cardy165/received_events","type":"User","site_admin":false},"created_at":"2016-07-28T12:50:44Z","updated_at":"2016-07-28T12:50:44Z","author_association":"NONE","body":"That would make sense if our query was generating thousands of buckets. \n\nThe first aggregation returns 2 buckets\nthe second as documented in the linked discussion is fixed at 5 buckets. \nThe last aggregation could be one of several and at worst case would be 8000 buckets. \n\nThere is GC going on on the cluster however doubling the capacity of the interface which is used for transports allows the query to run and return results, if the issue was purely a GC one then increasing the bandwidth available to the transport layer would not change the original behaviour.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/235987919","html_url":"https://github.com/elastic/elasticsearch/issues/19646#issuecomment-235987919","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19646","id":235987919,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNTk4NzkxOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-28T18:45:17Z","updated_at":"2016-07-28T18:45:17Z","author_association":"CONTRIBUTOR","body":"8000 buckets x 1175 indices x 5 shards that have to be handled by the coordinating node.  \n\nMost of this traffic is across the transport layer, not http, so I very much doubt that separating the interfaces would really help here.  That said, I'll reopen this for further discussion.\n\n/cc @bleskes \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/235996110","html_url":"https://github.com/elastic/elasticsearch/issues/19646#issuecomment-235996110","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19646","id":235996110,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNTk5NjExMA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-07-28T19:14:52Z","updated_at":"2016-07-28T19:14:52Z","author_association":"MEMBER","body":"> The first aggregation returns 2 buckets\n> the second as documented in the linked discussion is fixed at 5 buckets. \n> The last aggregation could be one of several and at worst case would be 8000 buckets\n\nThis is much more than @clintongormley said, as the 8000 buckets on the lowest level need to be multiplied by the upper levels as well - assuming `sex` (see later how I came up with) has just two values, that will be 2 x 5 (for age ranges) x lower level buckets x 1175 x 5 shards.\n\n> Most of this traffic is across the transport layer, not http, so I very much doubt that separating the interfaces would really help here. That said, I'll reopen this for further discussion.\n\nAgreed. All the traffic here is highly likely on the transport layer, so separation is not a big deal. Also you can try it out since you can bind the http host to another IP than the transport one. See [here](https://www.elastic.co/guide/en/elasticsearch/reference/2.3/modules-http.html).\n\nAll in all I think you have two issues:\n1) Long GCs cause nodes to not respond to pings - I see a 1.9m GC, cleaning about 6GB of mem.\n2) Network saturation (presumably by queries) which prevents the cluster to normally operate. For pings and any other reasons, ES nodes should be able to freely communicate with each other.\n\nYou should either increase the capacity of your cluster to meet what you do with it or try to reduce the number of shards and see how it helps.\n\nClosing this again. I suggest you continue the discussion on the thread you already have going with @danielmitterdorfer  on discuss.elastic.co : https://discuss.elastic.co/t/cluster-nodes-get-disconnected-and-out-of-sync-due-to-ping-timeouts-caused-by-transport-load/56505\n","performed_via_github_app":null}]