[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223062115","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-223062115","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":223062115,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzA2MjExNQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-06-01T17:15:40Z","updated_at":"2016-06-01T17:15:40Z","author_association":"CONTRIBUTOR","body":"@bittusarkar could you upload a small recreation showing what you're doing? I can't think of anything that has changed here, except maybe the extraction of query terms.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223073624","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-223073624","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":223073624,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzA3MzYyNA==","user":{"login":"bittusarkar","id":860447,"node_id":"MDQ6VXNlcjg2MDQ0Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/860447?v=4","gravatar_id":"","url":"https://api.github.com/users/bittusarkar","html_url":"https://github.com/bittusarkar","followers_url":"https://api.github.com/users/bittusarkar/followers","following_url":"https://api.github.com/users/bittusarkar/following{/other_user}","gists_url":"https://api.github.com/users/bittusarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/bittusarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bittusarkar/subscriptions","organizations_url":"https://api.github.com/users/bittusarkar/orgs","repos_url":"https://api.github.com/users/bittusarkar/repos","events_url":"https://api.github.com/users/bittusarkar/events{/privacy}","received_events_url":"https://api.github.com/users/bittusarkar/received_events","type":"User","site_admin":false},"created_at":"2016-06-01T17:55:38Z","updated_at":"2016-06-02T07:53:49Z","author_association":"NONE","body":"@clintongormley Let me work on creating the repro. It might take some time. In the meanwhile, let me add some information I missed earlier. I profiled Elasticsearch 2.1.1 by running a single query and almost 77% of inherent time was spent in `org.apache.lucene.search.postingshighlighter.CustomPostingsHighlighter.highlightField()`. Then at 4%, it was `org.apache.lucene.search.IndexSearcher.createNormalizedWeight()` followed by other methods. Hope this information is useful. I can share a JProfiler snapshot file if you're interested.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223209417","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-223209417","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":223209417,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzIwOTQxNw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-06-02T06:47:27Z","updated_at":"2016-06-02T06:47:27Z","author_association":"MEMBER","body":"Not surprised that method is the hotspot. The way we use the lucene postings highlighter is not the best...  #11223 would help here so that we can highlight documents in bulk rather than one document and one field at a time.\n\nThat said I don't yet see what made things so much worse when we moved to the lucene postings highlighter, which we did in 2.x, nor what changed in the plain highlighter that made things so much worse. The recreation might help.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226301157","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-226301157","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":226301157,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjMwMTE1Nw==","user":{"login":"bittusarkar","id":860447,"node_id":"MDQ6VXNlcjg2MDQ0Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/860447?v=4","gravatar_id":"","url":"https://api.github.com/users/bittusarkar","html_url":"https://github.com/bittusarkar","followers_url":"https://api.github.com/users/bittusarkar/followers","following_url":"https://api.github.com/users/bittusarkar/following{/other_user}","gists_url":"https://api.github.com/users/bittusarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/bittusarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bittusarkar/subscriptions","organizations_url":"https://api.github.com/users/bittusarkar/orgs","repos_url":"https://api.github.com/users/bittusarkar/repos","events_url":"https://api.github.com/users/bittusarkar/events{/privacy}","received_events_url":"https://api.github.com/users/bittusarkar/received_events","type":"User","site_admin":false},"created_at":"2016-06-15T19:55:05Z","updated_at":"2016-06-15T19:55:05Z","author_association":"NONE","body":"@javanna, @clintongormley I have a reproduction available but there is a huge file for which I cannot create a gist. Is there another way by which I can share the files? Email maybe?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226426708","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-226426708","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":226426708,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjQyNjcwOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-06-16T08:53:58Z","updated_at":"2016-06-16T08:53:58Z","author_association":"CONTRIBUTOR","body":"@bittusarkar sure - clinton at elastic dot co\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226455027","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-226455027","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":226455027,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjQ1NTAyNw==","user":{"login":"bittusarkar","id":860447,"node_id":"MDQ6VXNlcjg2MDQ0Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/860447?v=4","gravatar_id":"","url":"https://api.github.com/users/bittusarkar","html_url":"https://github.com/bittusarkar","followers_url":"https://api.github.com/users/bittusarkar/followers","following_url":"https://api.github.com/users/bittusarkar/following{/other_user}","gists_url":"https://api.github.com/users/bittusarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/bittusarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bittusarkar/subscriptions","organizations_url":"https://api.github.com/users/bittusarkar/orgs","repos_url":"https://api.github.com/users/bittusarkar/repos","events_url":"https://api.github.com/users/bittusarkar/events{/privacy}","received_events_url":"https://api.github.com/users/bittusarkar/received_events","type":"User","site_admin":false},"created_at":"2016-06-16T11:05:45Z","updated_at":"2016-06-16T11:05:45Z","author_association":"NONE","body":"Thanks @clintongormley. I just sent you the email.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260366400","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-260366400","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":260366400,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDM2NjQwMA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-11-14T15:29:39Z","updated_at":"2016-11-14T15:29:39Z","author_association":"MEMBER","body":"@bittusarkar sorry for the (very) late response, we've reproduced your issue and found why you're seeing such a big difference between 1.7 and 2.x. In 2.x we've removed our fork of the PostingsHighlighter and we now rely solely on the Lucene implementation. We did that because some of the functionalities we wanted were not present in Lucene at that time. We realized afterward that it was hard to maintain this fork and that we missed a lot of optimizations of the original implementation. This is why we decided to remove our fork and to integrate the original PostingsHighlighter directly. Though the way we've integrated the original Highlighter is not optimal and for some use cases it can be very slow. For instance in our fork we extract the terms of the query once and then we reuse the set of terms for each hit/field. In the new version we extract the terms of the query for each field in each hit. For simple queries it is fast but if you have a lot of fields and a lot of terms in your query it can be the bottleneck. In the example you sent us you have 240 fields to highlight and the query contains 240 terms (one for each field). This is really a bad use case for this highlighter since it needs to extract the terms of this big query 240 times for each hit. \nSince the issue is clearly related to the number of fields you want to highlight in a single query, \ncan you explain why you need so many fields ? Maybe you could use a different model that requires less fields ? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290728760","html_url":"https://github.com/elastic/elasticsearch/issues/18665#issuecomment-290728760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18665","id":290728760,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcyODc2MA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T14:33:23Z","updated_at":"2017-03-31T14:33:23Z","author_association":"MEMBER","body":"No further feedback. @bittusarkar if you have answers to the questions above please comment and reopen this issue","performed_via_github_app":null}]