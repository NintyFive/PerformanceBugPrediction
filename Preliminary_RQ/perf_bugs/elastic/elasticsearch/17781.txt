{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17781","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17781/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17781/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17781/events","html_url":"https://github.com/elastic/elasticsearch/issues/17781","id":148631754,"node_id":"MDU6SXNzdWUxNDg2MzE3NTQ=","number":17781,"title":"Geo polygon searches are slow. But they go about three times faster with profile: true","user":{"login":"motherhubbard","id":3320683,"node_id":"MDQ6VXNlcjMzMjA2ODM=","avatar_url":"https://avatars0.githubusercontent.com/u/3320683?v=4","gravatar_id":"","url":"https://api.github.com/users/motherhubbard","html_url":"https://github.com/motherhubbard","followers_url":"https://api.github.com/users/motherhubbard/followers","following_url":"https://api.github.com/users/motherhubbard/following{/other_user}","gists_url":"https://api.github.com/users/motherhubbard/gists{/gist_id}","starred_url":"https://api.github.com/users/motherhubbard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/motherhubbard/subscriptions","organizations_url":"https://api.github.com/users/motherhubbard/orgs","repos_url":"https://api.github.com/users/motherhubbard/repos","events_url":"https://api.github.com/users/motherhubbard/events{/privacy}","received_events_url":"https://api.github.com/users/motherhubbard/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-04-15T11:12:07Z","updated_at":"2016-04-19T08:28:14Z","closed_at":"2016-04-19T08:28:14Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: \n2.2.0\n\nJVM version: \njava version \"1.8.0_74\"\nJava(TM) SE Runtime Environment (build 1.8.0_74-b02)\nJava HotSpot(TM) 64-Bit Server VM (build 25.74-b02, mixed mode)\n\nOS version:\nCentOS Linux release 7.2.1511 (Core) \n\nWe have approximately 500k items in our index over 15 shards (we expect many more documents over time). The documents are relatively small (approx 5k). The Elastic cluster is spread over 12 boxes, each with 90G RAM and 16 cores running 1 node per box. Each shard has two replicas. No other applications run on the boxes so it should be pretty well specced. \n\nWe have a query as follows:\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"bool\": {\n                \"should\": [\n                  {\n                    \"bool\": {\n                      \"must\": [\n                        {\n                          \"terms\": {\n                            \"metadata.queries\": [\n                              53\n                            ]\n                          }\n                        },\n                        {\n                          \"range\": {\n                            \"metadata.timestamp\": {\n                              \"from\": 1365984000000\n                            }\n                          }\n                        }\n                      ]\n                    }\n                  },\n                  {\n                    \"bool\": {\n                      \"must\": [\n                        {\n                          \"terms\": {\n                            \"metadata.queries\": [\n                              2034,\n                              3106,\n                              3107,\n                              3108,\n                              3109\n                            ]\n                          }\n                        },\n                        {\n                          \"range\": {\n                            \"metadata.timestamp\": {\n                              \"from\": 1366070400000\n                            }\n                          }\n                        }\n                      ]\n                    }\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"query\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"range\": {\n                \"core.date.timestamp\": {\n                  \"gte\": \"2016-04-08T09:16:33.443Z\",\n                  \"lte\": \"2016-04-15T09:19:05.251Z\"\n                }\n              }\n            },\n            {\n              \"terms\": {\n                \"metadata.queries\": [\n                  53,\n                  2034,\n                  3106,\n                  3107,\n                  3108,\n                  3109\n                ]\n              }\n            },\n            {\n              \"bool\": {\n                \"must\": [\n                  {\n                    \"bool\": {\n                      \"must\": [\n                        {\n                          \"or\": [\n                            {\n                              \"geo_polygon\": {\n                                \"activity.location.location\": {\n                                  \"points\": [\n                                    [\n                                      -56.07421875,\n                                      -24.206889622398023\n                                    ],\n                                    [\n                                      -56.07421875,\n                                      64.84893726357947\n                                    ],\n                                    [\n                                      112.67578124999999,\n                                      64.84893726357947\n                                    ],\n                                    [\n                                      112.67578124999999,\n                                      -24.206889622398023\n                                    ],\n                                    [\n                                      -56.07421875,\n                                      -24.206889622398023\n                                    ]\n                                  ]\n                                }\n                              }\n                            }\n                          ]\n                        }\n                      ]\n                    }\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n```\n\nThis query matches 407 of our 500k documents however with the geo polygon block this query goes from taking approx 10 milliseconds to anywhere between 1.5 and 4.5 seconds. Even more weird is that when I set:\n\n```\nprofile: true\n```\n\non the query it completes in about 500ms. \n\nMy questions therefore are:\n1) Why does adding the geo block above make the query so slow?\n2) Why does adding profile: true make it go so much faster?\n\nThe mapping of the field is shown below:\n\n```\n\"location\": {\n                              \"type\": \"geo_point\",\n                              \"lat_lon\": true,\n                              \"geohash\": true,\n                              \"geohash_precision\": 8\n                           }\n```\n\nIf we change to geo_bounding_box the query is fast again but we can't always do this as we need to support arbitrary polygons. Also adding profile:true to this query makes it go about twice as fast again.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}