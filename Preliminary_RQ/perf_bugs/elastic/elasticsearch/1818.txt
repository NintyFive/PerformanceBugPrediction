{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1818","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1818/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1818/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1818/events","html_url":"https://github.com/elastic/elasticsearch/issues/1818","id":3863602,"node_id":"MDU6SXNzdWUzODYzNjAy","number":1818,"title":"TransportClient hangs when in sniff mode and no node running ","user":{"login":"jprante","id":635745,"node_id":"MDQ6VXNlcjYzNTc0NQ==","avatar_url":"https://avatars1.githubusercontent.com/u/635745?v=4","gravatar_id":"","url":"https://api.github.com/users/jprante","html_url":"https://github.com/jprante","followers_url":"https://api.github.com/users/jprante/followers","following_url":"https://api.github.com/users/jprante/following{/other_user}","gists_url":"https://api.github.com/users/jprante/gists{/gist_id}","starred_url":"https://api.github.com/users/jprante/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jprante/subscriptions","organizations_url":"https://api.github.com/users/jprante/orgs","repos_url":"https://api.github.com/users/jprante/repos","events_url":"https://api.github.com/users/jprante/events{/privacy}","received_events_url":"https://api.github.com/users/jprante/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1671193,"node_id":"MDU6TGFiZWwxNjcxMTkz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.19.2","name":"v0.19.2","color":"DDDDDD","default":false,"description":null},{"id":232920,"node_id":"MDU6TGFiZWwyMzI5MjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.20.0.RC1","name":"v0.20.0.RC1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2012-03-28T20:39:28Z","updated_at":"2012-03-29T09:21:14Z","closed_at":"2012-03-29T09:21:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When TransportClient is started in sniff mode, but no ES node is running at a single given transport address, only a \"Connection refused\" exception is silently logged at debug level.  After that, TransportClient hangs in \"addTransportAddress\".\n\nCode:\n\n```\n    Settings settings = ImmutableSettings.settingsBuilder()\n            .put(\"cluster.name\", \"elasticsearch\")\n            .put(\"client.transport.sniff\", true)\n            .build();\n    try {\n        Client client = new TransportClient(settings);        \n        client.addTransportAddress(address);\n        client.close();\n    } catch (Exception e) {\n        logger.log(Level.WARNING, e.getMessage());            \n    }\n```\n\nI expect a NoNodeAvailableException  (or a MasterNotDiscoveredException?) instead.\n\nHere is the debug level message.\n\n```\n[22:12:51,680][DEBUG][org.elasticsearch.client.transport] [Riot] failed to connect to node [[#transport#-1][inet[Jorg-Prantes-MacBook-Pro.local/192.168.1.113:9300]]], removed from nodes list\norg.elasticsearch.transport.ConnectTransportException: [][inet[Jorg-Prantes-MacBook-Pro.local/192.168.1.113:9300]] connect_timeout[30s]\n    at org.elasticsearch.transport.netty.NettyTransport.connectToChannels(NettyTransport.java:560)\n    at org.elasticsearch.transport.netty.NettyTransport.connectToNode(NettyTransport.java:503)\n    at org.elasticsearch.transport.netty.NettyTransport.connectToNode(NettyTransport.java:482)\n    at org.elasticsearch.transport.TransportService.connectToNode(TransportService.java:128)\n    at org.elasticsearch.client.transport.TransportClientNodesService$SniffNodesSampler$1.run(TransportClientNodesService.java:327)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n    at java.lang.Thread.run(Thread.java:680)\nCaused by: java.net.ConnectException: Connection refused\n    at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\n    at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:567)\n    at org.elasticsearch.common.netty.channel.socket.nio.NioClientSocketPipelineSink$Boss.connect(NioClientSocketPipelineSink.java:400)\n    at org.elasticsearch.common.netty.channel.socket.nio.NioClientSocketPipelineSink$Boss.processSelectedKeys(NioClientSocketPipelineSink.java:362)\n    at org.elasticsearch.common.netty.channel.socket.nio.NioClientSocketPipelineSink$Boss.run(NioClientSocketPipelineSink.java:284)\n    at org.elasticsearch.common.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:102)\n    at org.elasticsearch.common.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\n    ... 3 more\n```\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}