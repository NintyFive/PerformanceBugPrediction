{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4041","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4041/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4041/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4041/events","html_url":"https://github.com/elastic/elasticsearch/issues/4041","id":21952845,"node_id":"MDU6SXNzdWUyMTk1Mjg0NQ==","number":4041,"title":"On full cluster restart, node fails to detect master, then hangs for 10+ minutes","user":{"login":"andrewclegg","id":578186,"node_id":"MDQ6VXNlcjU3ODE4Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/578186?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewclegg","html_url":"https://github.com/andrewclegg","followers_url":"https://api.github.com/users/andrewclegg/followers","following_url":"https://api.github.com/users/andrewclegg/following{/other_user}","gists_url":"https://api.github.com/users/andrewclegg/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewclegg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewclegg/subscriptions","organizations_url":"https://api.github.com/users/andrewclegg/orgs","repos_url":"https://api.github.com/users/andrewclegg/repos","events_url":"https://api.github.com/users/andrewclegg/events{/privacy}","received_events_url":"https://api.github.com/users/andrewclegg/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-11-01T11:42:15Z","updated_at":"2014-10-06T16:21:05Z","closed_at":"2014-09-26T18:14:31Z","author_association":"NONE","active_lock_reason":null,"body":"## Context\n\nES 0.90.2 on a cluster of 4 large Redhat machines (24 core, 96GB RAM). Multicast discovery disabled.\n## Symptoms\n\nWhen I do a full cluster restart, there is often one machine that fails to join the cluster properly, and hangs after the \"started\" log entry for 10 minutes or more, before retrying.\n\nThis is a _different_ machine (and a different master) each time, so I don't think it's a hardware fault.\n\nHere's some log entries from a recent case. In this case, _lo1uspaldbs006.palomino.pearson.com_ was the master, and _lo1uspaldbs009.palomino.pearson.com_ was the confused slave.\n\nThe confused slave shows a sequence like this in its log:\n\n```\n[2013-11-01 11:00:08,718][DEBUG][discovery.zen.fd         ] [lo1uspaldbs009.palomino.pearson.com] [master] starting fault detection against master [[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]]], reason [initial_join]\n[2013-11-01 11:00:09,840][DEBUG][discovery.zen.fd         ] [lo1uspaldbs009.palomino.pearson.com] [master] pinging a master [lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]] but we do not exists on it, act as if its master failure\n[2013-11-01 11:00:09,841][DEBUG][discovery.zen.fd         ] [lo1uspaldbs009.palomino.pearson.com] [master] stopping fault detection against master [[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]]], reason [master failure, do not exists on master, act as master failure]\n[2013-11-01 11:00:09,842][INFO ][discovery.zen            ] [lo1uspaldbs009.palomino.pearson.com] master_left [[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]]], reason [do not exists on master, act as master failure]\n```\n\nHowever, the master shows no connection attempt from the slave during this time.\n\nThe slave then sits in the \"started\" stated, but responding only with MasterNotDiscoveredException, until some time later:\n\n```\n[2013-11-01 11:11:38,573][DEBUG][discovery.zen.fd         ] [lo1uspaldbs009.palomino.pearson.com] [master] restarting fault detection against master [[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]]], reason [new cluster state received and we are monitoring the wrong master [null]]\n[2013-11-01 11:11:38,599][INFO ][cluster.service          ] [lo1uspaldbs009.palomino.pearson.com] detected_master [lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]], added {[lo1uspaldbs007.palomino.pearson.com][ooTKn5ADRmG16KZk5BDS2w][inet[/10.162.45.36:9300]],[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]],[lo1uspaldbs008.palomino.pearson.com][z3kkkvJOR3eeyoYeRf6Cpw][inet[/10.162.45.37:9300]],}, reason: zen-disco-receive(from master [[lo1uspaldbs006.palomino.pearson.com][eRv40ALrSrWDm7w6rdbmOA][inet[/10.162.45.35:9300]]])\n```\n## Clock sync issue?\n\nI've noticed that the clocks are slightly out of sync in this cluster. Could this cause a problem? I know this is potentially problematic for some distributed databases.\n\n(I accounted for this in trying to track down join attempts in the master log.)\n## Relevant changes\n\nI've checked the changelog since 0.90.2 and found only two potentially relevant-looking fixes, #3515 and #3361, of which the former seems like a red herring. The latter might be relevant; I'm hoping to upgrade our cluster and retest in mid/late November.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}