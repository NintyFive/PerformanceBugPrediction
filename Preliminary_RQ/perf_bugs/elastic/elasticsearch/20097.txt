{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20097","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20097/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20097/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20097/events","html_url":"https://github.com/elastic/elasticsearch/issues/20097","id":172405368,"node_id":"MDU6SXNzdWUxNzI0MDUzNjg=","number":20097,"title":"scripted_metric aggregation is very slow in v2.3.3","user":{"login":"Hexer338","id":9653791,"node_id":"MDQ6VXNlcjk2NTM3OTE=","avatar_url":"https://avatars3.githubusercontent.com/u/9653791?v=4","gravatar_id":"","url":"https://api.github.com/users/Hexer338","html_url":"https://github.com/Hexer338","followers_url":"https://api.github.com/users/Hexer338/followers","following_url":"https://api.github.com/users/Hexer338/following{/other_user}","gists_url":"https://api.github.com/users/Hexer338/gists{/gist_id}","starred_url":"https://api.github.com/users/Hexer338/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hexer338/subscriptions","organizations_url":"https://api.github.com/users/Hexer338/orgs","repos_url":"https://api.github.com/users/Hexer338/repos","events_url":"https://api.github.com/users/Hexer338/events{/privacy}","received_events_url":"https://api.github.com/users/Hexer338/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-08-22T09:23:13Z","updated_at":"2016-08-23T13:09:50Z","closed_at":"2016-08-23T13:09:50Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: v2.3.3\n\n**Plugins installed**: [murmur3]\n\n**JVM version**:\n      \\* \"version\" : \"1.8.0_91\",\n      \\* \"vm_name\" : \"OpenJDK 64-Bit Server VM\",\n      \\* \"vm_version\" : \"25.91-b14\",\n      \\* \"vm_vendor\" : \"Oracle Corporation\",\n\n**OS version**: Linux\n\n**Description of the problem including expected versus actual behavior**:\nScripted_metric aggregations are performing very slow when compared to v2.0.0.\n\n**Steps to reproduce**:\nIam running Elasticsearch v2.3.3 and Elasticsearch v2.0.0 in docker.\n I have 1 million documents in index with following mapping:\n\n``` js\n               \"units\": {\n                  \"type\": \"double\"\n               },\n               \"unit_price\": {\n                  \"type\": \"double\"\n```\n\nUsed the following esQuery to test.\n\n``` js\n{\n   \"size\": 0,\n   \"aggregations\": {\n      \"__filtered__\": {\n         \"filter\": {\n            \"bool\": {\n               \"should\": [\n                  {\n                     \"exists\": {\n                        \"field\": \"units\"\n                     }\n                  },\n                  {\n                     \"exists\": {\n                        \"field\": \"unit_price\"\n                     }\n                  }\n               ]\n            }\n         },\n         \"aggs\": {\n            \"test_aggregation\": {\n               \"scripted_metric\": {\n                  \"params\": {\n                     \"_agg\": {},\n                     \"global\": {}\n                  },\n                  \"reduce_params\": {\n                     \"r_v\": [],\n                     \"r_v_args\": []\n                  },\n                  \"init_script\": \"_agg['r_v_map'] = [];_agg['r_v_combine'] = null;\",\n                  \"map_script\": \"result = 0;a = [doc['units'].value, doc['unit_price'].value, doc['units'].value]; for (i in a) {result += i;};b = a;a = null;for (i in b) {result +=i;};c = b; b = null;for (i in c) {result +=i;};_agg['r_v_map'].add(result);\",\n                  \"combine_script\": \"args = _agg['r_v_map'];result = 0; for (a in args) {result += a};_agg['r_v_combine'] = result;_agg['r_v_map'] = null; _agg;\",\n                  \"reduce_script\": \"for (arg in _aggs){if (arg != null) {if (arg['r_v_combine'] != null){r_v_args.add(arg['r_v_combine']);};};};args = r_v_args;result = 0; for (a in args) {result += a};return result\"\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nThe **performance** of the query is **significantly slow** in v2.3.3 when compared to v2.0.0.\nIt is taking 98 seconds in v2.3.3 when compared to 2 seconds in v2.0.0.\nI attached es responses below.\n\n**Provide logs (if relevant)**:\n**Es Response for above query in v2.3.3**\n\n``` js\n{\n   \"took\": 98031,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1092823,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"__filtered__\": {\n         \"doc_count\": 1092823,\n         \"test_aggregation\": {\n            \"value\": 1030923404.8491706\n         }\n      }\n   }\n}\n```\n\n**Es Response for above query in v2.0.0**\n\n``` js\n{\n   \"took\": 1428,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1092823,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"__filtered__\": {\n         \"doc_count\": 1092823,\n         \"test_aggregation\": {\n            \"value\": 1030923404.849173\n         }\n      }\n   }\n}\n```\n#### Elasticsearch version and jvm version for v2.0.0:\n\n**Elasticsearch version**: v2.0.0\n\n**Plugins installed**: [murmur3]\n\n**JVM version**:\n        \\* \"version\" : \"1.8.0_66-internal\",\n        \\* \"vm_name\" : \"OpenJDK 64-Bit Server VM\",\n        \\* \"vm_version\" : \"25.66-b17\",\n        \\* \"vm_vendor\" : \"Oracle Corporation\"\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}