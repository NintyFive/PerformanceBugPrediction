[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254099056","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254099056","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254099056,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDA5OTA1Ng==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T02:33:16Z","updated_at":"2016-10-17T02:33:16Z","author_association":"MEMBER","body":"Looks like the JVM optimizer does not optimize as we would expect?\n\nWondering what would happen if you try to turn it off with XX:MaxInlineSize=0?\n\nSee http://niklasschlimm.blogspot.fr/2012/01/java-7-how-to-write-really-fast-java.html?m=1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254100151","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254100151","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254100151,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDEwMDE1MQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T02:43:08Z","updated_at":"2016-10-17T02:43:08Z","author_association":"MEMBER","body":"@dadoonet I tried it, for some reason JVM ignores this setting and inlines it anyway. When I turn off inlining completely everything becomes slow (I am getting consistent response time of about 500ms).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254125039","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254125039","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254125039,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDEyNTAzOQ==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T06:44:22Z","updated_at":"2016-10-17T06:44:22Z","author_association":"MEMBER","body":"> I tried it, for some reason JVM ignores this setting and inlines it anyway.\n\nHmmm. That's strange because it is still documented for Java8 http://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html. So this should work. May be `0` is not supported anymore so that we should try `1` instead?\n\nI also wonder if this happened with previous versions of Lucene? May be it's a reproductible behavior which can be reproduced with pure Lucene code which in that cas we should open the issue there?\nOr do you believe that elasticsearch code makes that behavior happening?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254234446","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254234446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254234446,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDIzNDQ0Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T15:05:18Z","updated_at":"2016-10-17T15:05:18Z","author_association":"CONTRIBUTOR","body":"@danielmitterdorfer @jpountz any ideas?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254248900","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254248900","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254248900,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDI0ODkwMA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T15:53:32Z","updated_at":"2016-10-17T15:53:32Z","author_association":"MEMBER","body":"@clintongormley I'll need a bit more time for a definitive answer but @imotov could try to avoid inlining of the method in question with `-XX:CompileCommand=\"dontinline org.apache.lucene.search.FakeScorer::score\"`. `-XX:MaxInlineSize=0` is somewhat brutal. :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254253165","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254253165","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254253165,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDI1MzE2NQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T16:08:20Z","updated_at":"2016-10-17T16:08:20Z","author_association":"MEMBER","body":"@danielmitterdorfer I am getting about 700ms response time for all requests. By the way, I don't think `FakeScorer::score` is the method in question. Last week, I tried removing FakeScorer completely by commenting out scoring and it didn't have any effect on the result. I am pretty sure the issue is with  `org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1::collect`.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254257997","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254257997","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254257997,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDI1Nzk5Nw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T16:25:31Z","updated_at":"2016-10-18T06:52:15Z","author_association":"MEMBER","body":"@imotov Oh, then I just misread your initial comment, sorry. The correct command should be `-XX:CompileCommand=\"dontinline org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1::collect\"` in this case.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254262944","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254262944","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254262944,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDI2Mjk0NA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-10-17T16:43:21Z","updated_at":"2016-10-17T16:43:21Z","author_association":"MEMBER","body":"Yep, tried that as well - same result. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254485506","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254485506","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254485506,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDQ4NTUwNg==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-10-18T11:54:39Z","updated_at":"2016-10-18T11:59:17Z","author_association":"MEMBER","body":"In the meantime I ran `esrally --preserve-install=true --pipeline=from-distribution --distribution-version=5.0.0-rc1 --track=nyc_taxis` and got the following 99th percentile service time for the query in question (`match_all`):\n\n![service_times](https://cloud.githubusercontent.com/assets/1699576/19476494/d230b31a-9539-11e6-8880-00f2b50ad4a8.png)\n\nThis looks as I'd expect it. Maybe this is something related to your hardware? (CPU cache size?) \n\nI also ran `curl \"localhost:9200/nyc_taxis/_search\"` as you did and I got the following values for `took`: 37, 157, 259, 258, 253, 252, 258 (and so on). So, similar to the pattern that you describe.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/254502287","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-254502287","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":254502287,"node_id":"MDEyOklzc3VlQ29tbWVudDI1NDUwMjI4Nw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-10-18T13:09:09Z","updated_at":"2016-10-18T13:10:59Z","author_association":"MEMBER","body":"So, after a couple of experiments I got the following results (see [script source](https://gist.github.com/danielmitterdorfer/4ce26e92e0650f0472e0ab782ae4a98f)):\n\nForce that `org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1::collect` is not inlined (I am just pasting the first 11 responses here for brevity):\n\n| idx | response_time_ms | took_ms |\n| --- | --- | --- |\n| 0 | 469.48 | 466.00 |\n| 1 | 507.87 | 504.00 |\n| 2 | 477.45 | 468.00 |\n| 3 | 474.57 | 470.00 |\n| 4 | 473.75 | 469.00 |\n| 5 | 475.56 | 471.00 |\n| 6 | 473.45 | 469.00 |\n| 7 | 474.74 | 470.00 |\n| 8 | 475.93 | 471.00 |\n| 9 | 475.59 | 470.00 |\n| 10 | 474.34 | 469.00 |\n\nwhere `response_time_ms` is the end-to-end response time in ms and `took_ms` the content of the `took` field in the JSON response.\n\nWith default behavior (i.e. no compiler control command):\n\n| idx | response_time_ms | took_ms |\n| --- | --- | --- |\n| 0 | 80.07 | 37.00 |\n| 1 | 174.90 | 162.00 |\n| 2 | 269.38 | 257.00 |\n| 3 | 291.43 | 284.00 |\n| 4 | 315.52 | 302.00 |\n| 5 | 270.99 | 257.00 |\n| 6 | 267.95 | 257.00 |\n| 7 | 265.99 | 254.00 |\n| 8 | 267.39 | 255.00 |\n| 9 | 326.63 | 276.00 |\n| 10 | 266.90 | 255.00 |\n\nWe can clearly see:\n- the performance impact of inlining\n- a real increase in the response time in the second case whereas response time is roughly constant in the first case\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/383881049","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-383881049","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":383881049,"node_id":"MDEyOklzc3VlQ29tbWVudDM4Mzg4MTA0OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-24T10:19:47Z","updated_at":"2018-04-24T10:19:47Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408416539","html_url":"https://github.com/elastic/elasticsearch/issues/20957#issuecomment-408416539","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20957","id":408416539,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODQxNjUzOQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-07-27T13:21:20Z","updated_at":"2018-07-27T13:21:20Z","author_association":"MEMBER","body":"We have discussed this and it doesn't seem that we should (or can) do something about it and will just leave this to JVM to eventually fix. Closing.","performed_via_github_app":null}]