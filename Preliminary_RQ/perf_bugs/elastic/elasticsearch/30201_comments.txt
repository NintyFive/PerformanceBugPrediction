[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384944035","html_url":"https://github.com/elastic/elasticsearch/issues/30201#issuecomment-384944035","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201","id":384944035,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDk0NDAzNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T11:31:41Z","updated_at":"2018-04-27T11:31:41Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385196611","html_url":"https://github.com/elastic/elasticsearch/issues/30201#issuecomment-385196611","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201","id":385196611,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTE5NjYxMQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-04-28T18:29:55Z","updated_at":"2018-04-28T18:29:55Z","author_association":"MEMBER","body":"I am not sure that I agree. An error should tear the server down; if that is not happening because the error is being swallowed, that's the bug.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385251446","html_url":"https://github.com/elastic/elasticsearch/issues/30201#issuecomment-385251446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201","id":385251446,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTI1MTQ0Ng==","user":{"login":"nomoa","id":5939211,"node_id":"MDQ6VXNlcjU5MzkyMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5939211?v=4","gravatar_id":"","url":"https://api.github.com/users/nomoa","html_url":"https://github.com/nomoa","followers_url":"https://api.github.com/users/nomoa/followers","following_url":"https://api.github.com/users/nomoa/following{/other_user}","gists_url":"https://api.github.com/users/nomoa/gists{/gist_id}","starred_url":"https://api.github.com/users/nomoa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nomoa/subscriptions","organizations_url":"https://api.github.com/users/nomoa/orgs","repos_url":"https://api.github.com/users/nomoa/repos","events_url":"https://api.github.com/users/nomoa/events{/privacy}","received_events_url":"https://api.github.com/users/nomoa/received_events","type":"User","site_admin":false},"created_at":"2018-04-29T13:26:30Z","updated_at":"2018-04-29T13:26:30Z","author_association":"CONTRIBUTOR","body":"Thanks for having a look, so if I understand your position properly I need to continue my investigations on the bug downstream to understand why the Error has not brought the server down (assuming that my assumption to explain the deadlock stack reported there is correct).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385272797","html_url":"https://github.com/elastic/elasticsearch/issues/30201#issuecomment-385272797","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201","id":385272797,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTI3Mjc5Nw==","user":{"login":"nomoa","id":5939211,"node_id":"MDQ6VXNlcjU5MzkyMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5939211?v=4","gravatar_id":"","url":"https://api.github.com/users/nomoa","html_url":"https://github.com/nomoa","followers_url":"https://api.github.com/users/nomoa/followers","following_url":"https://api.github.com/users/nomoa/following{/other_user}","gists_url":"https://api.github.com/users/nomoa/gists{/gist_id}","starred_url":"https://api.github.com/users/nomoa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nomoa/subscriptions","organizations_url":"https://api.github.com/users/nomoa/orgs","repos_url":"https://api.github.com/users/nomoa/repos","events_url":"https://api.github.com/users/nomoa/events{/privacy}","received_events_url":"https://api.github.com/users/nomoa/received_events","type":"User","site_admin":false},"created_at":"2018-04-29T18:52:51Z","updated_at":"2018-04-29T18:52:51Z","author_association":"CONTRIBUTOR","body":"Tested this by injecting an Error and the server properly crashed after logging the exception:\r\n```\r\n[2018-04-29T18:28:04,994][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[vf0a0em][search][T#1]], exiting\r\njava.lang.AssertionError: BOOM!\r\n\tat com.o19s.es.ltr.feature.store.index.Caches.lambda$cacheLoad$7(Caches.java:146) ~[?:?]\r\n\tat org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:412) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n\tat com.o19s.es.ltr.feature.store.index.Caches.cacheLoad(Caches.java:140) ~[?:?]\r\n\tat com.o19s.es.ltr.feature.store.index.Caches.loadFeatureSet(Caches.java:130) ~[?:?]\r\n\tat com.o19s.es.ltr.feature.store.index.CachedFeatureStore.loadSet(CachedFeatureStore.java:51) ~[?:?]\r\n\tat com.o19s.es.ltr.query.StoredLtrQueryBuilder.doToQuery(StoredLtrQueryBuilder.java:140) ~[?:?]\r\n\tat com.o19s.es.ltr.query.StoredLtrQueryBuilder.doToQuery(StoredLtrQueryBuilder.java:45) ~[?:?]\r\n\tat org.elasticsearch.index.query.AbstractQueryBuilder.toQuery(AbstractQueryBuilder.java:97) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n[...]\r\n```\r\n\r\nSo I understand that it's not worth trying to make this Cache implementation resilient to such errors and having it in a deadlock state after these is not much a problem since the server should crash anyways.\r\n\r\nI'll continue investigating as my first guess to explain the lock states seems to be wrong.\r\n\r\nThanks and sorry for the noise.","performed_via_github_app":null}]