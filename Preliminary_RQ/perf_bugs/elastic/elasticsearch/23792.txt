{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23792","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23792/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23792/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23792/events","html_url":"https://github.com/elastic/elasticsearch/issues/23792","id":217848985,"node_id":"MDU6SXNzdWUyMTc4NDg5ODU=","number":23792,"title":"Slow bulk updates","user":{"login":"redserpent7","id":7194031,"node_id":"MDQ6VXNlcjcxOTQwMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/7194031?v=4","gravatar_id":"","url":"https://api.github.com/users/redserpent7","html_url":"https://github.com/redserpent7","followers_url":"https://api.github.com/users/redserpent7/followers","following_url":"https://api.github.com/users/redserpent7/following{/other_user}","gists_url":"https://api.github.com/users/redserpent7/gists{/gist_id}","starred_url":"https://api.github.com/users/redserpent7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redserpent7/subscriptions","organizations_url":"https://api.github.com/users/redserpent7/orgs","repos_url":"https://api.github.com/users/redserpent7/repos","events_url":"https://api.github.com/users/redserpent7/events{/privacy}","received_events_url":"https://api.github.com/users/redserpent7/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2017-03-29T11:43:43Z","updated_at":"2018-03-28T16:04:16Z","closed_at":"2017-03-29T12:09:12Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nRecently I encountered an issue after migrating my cluster from 1.7 to 5.2. I have experienced extremely slow bulk updates to the extent where it took 1 week to update 1M files where in 1.7 those took minutes.\r\n\r\nI have reported this on [Elastic Discuss](https://discuss.elastic.co/t/bulk-updates-are-extremely-slow-after-upgrading-to-5-2/79450/15). And did not get any valid answer for why I am experiencing this kinf of slowness.\r\n\r\nAs you can see from the discussion thread, I have tried many things. Set number of replicas to 0, set refresh interval to -1, increased the CPU and memory of my nodes, increased the size of the cluster from 5 to 9 nodes and since the cluster was on AWS EC2 I changed the disk type to provisioned IOPS with 10000 IOPS. I also tried changing the bulk size from 100 to 500 to 1000 to 10000 and every increase made matters worse.\r\n\r\nAll of the above did not show any difference in the bulk update speed. Bulk inserts only took milliseconds so did update by query and search.\r\n\r\nI was then forced to switch the code to pull the document, update the necessary fields on the server, then insert the updated document to ES. This sped up the process significantly as I managed to update 1M documents in 10 minutes. And I can increase this rate further as I did not see any changes to the CPU or Memory usage during those 10 minutes.\r\n\r\nAll this led me to believe that there is definitely some major flaws of the way ES handles bulk updates since the slowness did not make any sense and since doing the GET/UPDATE/INSERT should, in theory, take longer than using the update API.\r\n\r\n\r\n![es_monitor](https://cloud.githubusercontent.com/assets/7194031/24452784/366638e4-1485-11e7-9880-a6f1ce0c8a48.jpg)\r\n\r\nLooking at the attached image, I do not see any significant changes in the indexing and search rates since I stopped using bulk updates which was on Mar 26th, as indicated by the red line.\r\n\r\nI wish you can review the way bulk updates are currently being handled because even though I managed to avert that disaster I believe it should not be this way at all and it should be much faster than what I was experiencing.\r\n\r\n \r\nCurrenlty my ES cluster is on version 5.2\r\nJVM: Java SE 1.8.0_121\r\nOS: Ubuntu 14.04 64-bit\r\nInstalled Plugins: analysis-icu, analysis-kuromoji, analysis-smartcn, discovery-ec2, repository-s3, x-pack\r\n\r\n\r\n \r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}