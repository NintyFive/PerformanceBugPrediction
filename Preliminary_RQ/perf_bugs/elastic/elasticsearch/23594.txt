{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23594","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23594/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23594/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23594/events","html_url":"https://github.com/elastic/elasticsearch/issues/23594","id":214477694,"node_id":"MDU6SXNzdWUyMTQ0Nzc2OTQ=","number":23594,"title":"Fuzzy match very slow on indices with shingle filter","user":{"login":"jeantil","id":22979,"node_id":"MDQ6VXNlcjIyOTc5","avatar_url":"https://avatars3.githubusercontent.com/u/22979?v=4","gravatar_id":"","url":"https://api.github.com/users/jeantil","html_url":"https://github.com/jeantil","followers_url":"https://api.github.com/users/jeantil/followers","following_url":"https://api.github.com/users/jeantil/following{/other_user}","gists_url":"https://api.github.com/users/jeantil/gists{/gist_id}","starred_url":"https://api.github.com/users/jeantil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeantil/subscriptions","organizations_url":"https://api.github.com/users/jeantil/orgs","repos_url":"https://api.github.com/users/jeantil/repos","events_url":"https://api.github.com/users/jeantil/events{/privacy}","received_events_url":"https://api.github.com/users/jeantil/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2017-03-15T18:04:30Z","updated_at":"2018-10-11T15:43:28Z","closed_at":"2018-03-19T23:28:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n5.2.2 (I reproduced this issue on the [5.2.2 docker image provided by elastic.co](https://github.com/elastic/elasticsearch-docker)) \r\n\r\n**Plugins installed**: [x-pack:5.2.2] \r\n(is installed by default in the docker image)\r\n**JVM version**:\r\n```\r\n                \"version\": \"1.8.0_92-internal\",\r\n                \"vm_name\": \"OpenJDK 64-Bit Server VM\",\r\n                \"vm_vendor\": \"Oracle Corporation\",\r\n                \"vm_version\": \"25.92-b14\"\r\n```\r\n**OS version**:\r\nthe os of the docker image is a linux, it runs on docker4mac 17.03.0-ce-mac2 (15657) on mac osX sierra \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning the following request on a very small index (see reproduction steps) is consistently very slow: \r\n```\r\nGET season/season/_search\r\n{\r\n  \"query\" : {\r\n    \"bool\" : {\r\n      \"must\" : [\r\n        {\r\n          \"match\" : {\r\n            \"name.classic\" : {\r\n              \"query\" : \"RENAULT Talisman Talisman Estate 1.6 dCi 130 225/55 R17 101W winter\",\r\n              \"operator\" : \"OR\",\r\n              \"fuzziness\" : \"AUTO\",\r\n              \"prefix_length\" : 0,\r\n              \"max_expansions\" : 50,\r\n              \"fuzzy_transpositions\" : true,\r\n              \"lenient\" : false,\r\n              \"zero_terms_query\" : \"NONE\",\r\n              \"boost\" : 1.0\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\" : false,\r\n      \"adjust_pure_negative\" : true,\r\n      \"boost\" : 1.0\r\n    }\r\n  }\r\n}\r\n```\r\nthe previous query returns in over 3 seconds :\r\n```\r\n \"took\": 4360,\r\n```\r\nwhen disabling the fuzzyness the query runs orders of magnitude faster \r\n```\r\n  \"took\": 87,\r\n```\r\ndisabling shingling in the query analysis also runs orders of magnitude faster \r\n```\r\n  \"took\": 11,\r\n```\r\n\r\n**Steps to reproduce**:\r\n```\r\nDELETE season\r\nPUT season\r\n{\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"filter\": {\r\n          \"search_shingler\": {\r\n            \"max_shingle_size\": \"3\",\r\n            \"min_shingle_size\": \"2\",\r\n            \"token_separator\": \" \",\r\n            \"output_unigrams\": \"true\",\r\n            \"filler_token\": \"_\",\r\n            \"output_unigrams_if_no_shingles\": \"false\",\r\n            \"type\": \"shingle\"\r\n          }\r\n        },\r\n        \"analyzer\": {\r\n          \"seasons-searchAnalyzer\": {\r\n            \"filter\": [\r\n              \"asciifolding\",\r\n              \"lowercase\",\r\n              \"search_shingler\"\r\n            ],\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\"\r\n          },\r\n          \"seasons-indexAnalyzer\": {\r\n            \"filter\": [\r\n              \"asciifolding\",\r\n              \"lowercase\"\r\n            ],\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"keyword\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT season/_mapping/season\r\n{\r\n \"properties\": {\r\n   \"name\": {\r\n     \"type\": \"text\",\r\n     \"fields\": {\r\n       \"classic\": {\r\n         \"type\": \"text\",\r\n         \"analyzer\": \"seasons-indexAnalyzer\",\r\n         \"search_analyzer\": \"seasons-searchAnalyzer\"\r\n       },\r\n       \"raw\": {\r\n         \"type\": \"keyword\"\r\n       }\r\n     }\r\n   },\r\n   \"value\": {\r\n     \"type\": \"keyword\"\r\n   }\r\n }   \r\n}\r\nPOST season/season\r\n{ \"name\": \"winter\", \"value\": \"Winter\"}\r\nPOST season/season\r\n{ \"name\": \"winteur\", \"value\": \"Winter\"}\r\nPOST season/season  \r\n{ \"name\": \"summer\", \"value\": \"Summer\"}\r\nPOST season/season  \r\n{ \"name\": \"all seasons\", \"value\": \"AllSeasons\"}\r\nPOST season/season  \r\n{ \"name\": \"nordic\", \"value\": \"Nordic\" }\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\nI couldn't find anything relevant in the logs (I only get deleting index, creating index, adding mapping, etc... ) \r\n\r\n**comparison with previous versions**\r\n\r\nI tried running the exact same scenario on our previous configuration (es 1.7) the query with both fuzzy and shingling ran in about 150ms. we never tried intermediate versions as our upgrade path was blocked by the removal of FLT until #9103 got merged.","closed_by":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"performed_via_github_app":null}