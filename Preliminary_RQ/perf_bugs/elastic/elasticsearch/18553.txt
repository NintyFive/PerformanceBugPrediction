{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18553","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18553/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18553/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18553/events","html_url":"https://github.com/elastic/elasticsearch/issues/18553","id":156570007,"node_id":"MDU6SXNzdWUxNTY1NzAwMDc=","number":18553,"title":"Relocation and indexing concurrently can lead to a deadlock","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":396750536,"node_id":"MDU6TGFiZWwzOTY3NTA1MzY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha5","name":"v5.0.0-alpha5","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-05-24T17:54:44Z","updated_at":"2016-09-14T14:44:25Z","closed_at":"2016-07-02T07:36:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: master (f210605af82ab0642b6294c08163c81b10e84969)\n\nEdit: pushed a test to master with an AwaitsFix, see below. Reproduces for me on spinning disk.\n\nThis is what happens:\n\nfour nodes: node_t0, node_t1, node_t2, node_t3\n\nnode_t1 has P0 and R1 and node_t0 has P1 and R0\n\nIndex request for P0 comes in, executes on node_t1 and sends replication request to node_t0.\nIndex request for P1 comes in, executes on node_t0 and sends replication request to node_t1.\nBoth will hold one shard reference (by which I mean a permit in SuspendableRefContainer of the shard).\n\nBefore replication requests arrives at target (trapped in the network, queued in thread pool, ...):\n\nP0 starts relocating from node_t1 to node_t2\nP1 starts relocating from node_t0 to node_t3\n\nBefore relocation finishes we try to set the state of IndexShard to relocated and block all further incoming requests by trying to acquire acquiring all shard references.\nWe do this on both nodes. Both do not succeed in acquiring all counters because the two primary requests are still waiting for the replica to succeed. \nIn the meanwhile, new indexing requests come in and try to acquire shard references but they have to wait too because the relocation is queued before them.\nHence, they block the indexing threadpool.\n\nNow, the replication requests arrive at their respective targets. But because the indexing thread pool is full on both nodes they too will have to wait.\n\nTherefore the primary requests on node_t0 and node_t1 will never release their shard reference, the relocation can never be finished and the new indexing requests never finish too.\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}