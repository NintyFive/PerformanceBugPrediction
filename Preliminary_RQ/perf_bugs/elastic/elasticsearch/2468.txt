{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2468","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2468/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2468/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2468/events","html_url":"https://github.com/elastic/elasticsearch/issues/2468","id":9092797,"node_id":"MDU6SXNzdWU5MDkyNzk3","number":2468,"title":"Unrealistic high memory consumption for faceting of infrequent array fields with many members","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2012-12-07T16:13:34Z","updated_at":"2013-06-06T11:38:09Z","closed_at":"2013-06-06T11:38:09Z","author_association":"MEMBER","active_lock_reason":null,"body":"Hi,\n\nOur ElasticSearch instance contains circa 240 million messages. Each message can have one or more tags id associated with it. These ids are stored as an array of integers and we facet it using the standard terms facet.\n\nThe facet cache size for this field is ~55GB which is highly surprising as only 5 million messages actually do have tags (tagging is manual). Also the total number of tag applications is only ~15 million. \n\nYesterday our ES cluster died due to lack of memory. \n\nResearching it I have pin down the issue to the way the MultiValued*Field caches work - For every segment it allocates memory space which is proportionate to the max number of values per docs \\* maxDocs of that segment. \n\nIn our case we had 3 messages with 100 tags which caused ElasticSearch to allocate 100*24 million  integers on 3 of the 10 shards we use (27.5 GB in total ). The rest of the shards each had at least one message with ~50 tags which is less dramatic but has a similar high consumption.\n\nI understand why the current MultiValueIntFieldData implementation is set as it is right now, but in our case it leads to extreme results.\n\nWe currently worked around it by delete the tags from the top 200 messages which reduced memory considerably but this a short term solution.\n\nI have started working on a an alternative data structure which will solve things for us. I will submit a pull request as soon as it is ready.\n\nCheers,\nBoaz\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}