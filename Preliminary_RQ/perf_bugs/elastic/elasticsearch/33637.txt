{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33637","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33637/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33637/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33637/events","html_url":"https://github.com/elastic/elasticsearch/issues/33637","id":359539604,"node_id":"MDU6SXNzdWUzNTk1Mzk2MDQ=","number":33637,"title":"java rest client is slow","user":{"login":"ouyangchucai","id":39488161,"node_id":"MDQ6VXNlcjM5NDg4MTYx","avatar_url":"https://avatars3.githubusercontent.com/u/39488161?v=4","gravatar_id":"","url":"https://api.github.com/users/ouyangchucai","html_url":"https://github.com/ouyangchucai","followers_url":"https://api.github.com/users/ouyangchucai/followers","following_url":"https://api.github.com/users/ouyangchucai/following{/other_user}","gists_url":"https://api.github.com/users/ouyangchucai/gists{/gist_id}","starred_url":"https://api.github.com/users/ouyangchucai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ouyangchucai/subscriptions","organizations_url":"https://api.github.com/users/ouyangchucai/orgs","repos_url":"https://api.github.com/users/ouyangchucai/repos","events_url":"https://api.github.com/users/ouyangchucai/events{/privacy}","received_events_url":"https://api.github.com/users/ouyangchucai/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-09-12T15:38:20Z","updated_at":"2018-09-13T05:37:39Z","closed_at":"2018-09-13T05:37:39Z","author_association":"NONE","active_lock_reason":null,"body":"When I use java rest client for search，the return json shows Elasticsearch server took only 14ms，but the java code execute time is 665ms. It cost about 509ms to create rest client, and the get request cost 149ms. \r\nWhen I use curl request Elasticsearch rest URL, it shows cost 25ms.\r\n`time curl -XGET 'http://localhost:9200/fulltext001/_search?_source=id&sort=id&size=10000&q=content:%22KTV%22' > es_result.txt`\r\nHow can I make the java search code faster? \r\n\r\nsearch code:\r\nimport org.apache.http.HttpEntity;\r\nimport org.apache.http.HttpHost;\r\nimport org.apache.http.auth.AuthScope;\r\nimport org.apache.http.auth.UsernamePasswordCredentials;\r\nimport org.apache.http.client.CredentialsProvider;\r\nimport org.apache.http.entity.ContentType;\r\nimport org.apache.http.impl.client.BasicCredentialsProvider;\r\nimport org.apache.http.impl.client.SystemDefaultCredentialsProvider;\r\nimport org.apache.http.impl.nio.client.HttpAsyncClientBuilder;\r\nimport org.apache.http.nio.entity.NStringEntity;\r\nimport org.apache.http.util.EntityUtils;\r\nimport org.elasticsearch.client.Response;\r\nimport org.elasticsearch.client.RestClient;\r\nimport org.elasticsearch.client.RestClientBuilder;\r\nimport org.elasticsearch.client.transport.TransportClient;\r\nimport org.elasticsearch.client.*;\r\n\r\nimport java.io.IOException;\r\nimport java.util.Collections;\r\npublic class RestClientTest {\r\n    public  static void main(String[]args){\r\n        long startTime = System.currentTimeMillis();\r\n        String host = \"127.0.0.1\";\r\n        int port = 9200; \r\n        String username=\"elastic\";\r\n        String password=\"changeme\";\r\n\r\n        final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\r\n        credentialsProvider.setCredentials(AuthScope.ANY,\r\n                new UsernamePasswordCredentials(username, password));\r\n\r\n        long clientStartTime = System.currentTimeMillis();\r\n        RestClient restClient = RestClient.builder(new HttpHost(host, port))\r\n                .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {\r\n                    public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {\r\n                        return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);\r\n                    }\r\n                }).build();\r\n\r\n        long clientEndTime = System.currentTimeMillis();\r\n\r\n        long indexStartTime = 0;\r\n        long indexEndTime = 0;\r\n        long searchStartTime = 0;\r\n        long searchEndTime = 0;\r\n        long startReponseTime =0;\r\n        long endReponseTime = 0;\r\n        try {\r\n\r\n            //index a document\r\n            /*\r\n            HttpEntity entity = new NStringEntity(\"{\\n\\\"id\\\" : \\\"https://www.huxiu.com/article/215169.html\\\"\\n, \\n\\\"content\\\" : \\\"“娃娃机，迷你KTV，VR体验馆，堪称商场三大标配‘神器’。”一家地处商业中心的大型综合体负责人告诉懂懂笔记，在过去的这几个月里，几乎所有的综合体都“标配”了这三种“设备”…\\\"\\n}\", ContentType.APPLICATION_JSON);\r\n            indexStartTime = System.currentTimeMillis();\r\n            Response indexResponse = restClient.performRequest(\"PUT\", \"/fulltext001/doc/123\", Collections.<String, String>emptyMap(), entity);\r\n            indexEndTime = System.currentTimeMillis();\r\n            */\r\n\r\n            //search a document\r\n            searchStartTime = System.currentTimeMillis();\r\n            //Response response = restClient.performRequest(\"GET\", \"/fulltext001/doc/123\", Collections.singletonMap(\"pretty\", \"true\"));\r\n            Response response = restClient.performRequest(\"GET\", \"/fulltext001/doc/_search?_source=id&sort=id&size=10000&q=content:KTV\", Collections.singletonMap(\"pretty\", \"true\"));\r\n\r\n            searchEndTime = System.currentTimeMillis();\r\n\r\n            startReponseTime = System.currentTimeMillis();\r\n            System.out.println(EntityUtils.toString(response.getEntity()));\r\n            endReponseTime = System.currentTimeMillis();\r\n        } catch (IOException e) {\r\n            e.printStackTrace();\r\n        } finally {\r\n\r\n        }\r\n\r\n        long endTime = System.currentTimeMillis();\r\n        System.out.println(\"total cost time:\"+(endTime-startTime)/1000.0+\"s, client create time:\"+(clientEndTime-clientStartTime)/1000.0+\"s, index time:\"+(indexEndTime-indexStartTime)/1000.0+\"s, search time:\"+(searchEndTime-searchStartTime)/1000.0+\"s, response to string time:\"+(endReponseTime-startReponseTime)/1000.0+\"s\");\r\n        //total cost time:0.665s, client create time:0.509s, index time:0.0s, search time:0.149s, response to string time:0.001s.  Elasticsearch took 14ms.\r\n        //total cost time:0.714s, client create time:0.553s, index time:0.0s, search time:0.152s, response to string time:0.001s. Elasticsearch took 37ms.\r\n\r\n    }\r\n}\r\n\r\n\r\n\r\nreturn elasticsearch search result json:\r\n{\r\n  \"took\" : 14,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 27,\r\n    \"successful\" : 27,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 2,\r\n    \"max_score\" : null,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"fulltext001\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"123\",\r\n        \"_score\" : null,\r\n        \"_source\" : {\r\n          \"id\" : \"https://www.huxiu.com/article/215169.html\"\r\n        },\r\n        \"sort\" : [\r\n          \"https://www.huxiu.com/article/215169.html\"\r\n        ]\r\n      },\r\n      {\r\n        \"_index\" : \"fulltext001\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : null,\r\n        \"_source\" : {\r\n          \"id\" : \"https://www.huxiu.com/article/215169.html\"\r\n        },\r\n        \"sort\" : [\r\n          \"https://www.huxiu.com/article/215169.html\"\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n\r\n\r\n#create index\r\ncurl -XPUT http://localhost:9200/fulltext001?pretty -H 'Content-Type: application/json'   -d ' \r\n{\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"number_of_shards\" : \"27\",\r\n        \"number_of_replicas\" : \"0\"\r\n      }\r\n    }\r\n}\r\n'\r\n\r\n#create mapping\r\ncurl -XPOST http://localhost:9200/fulltext001/doc/_mapping?pretty  -H 'Content-Type: application/json' -d ' \r\n{\r\n    \"doc\" : {\r\n        \"_all\" : {\r\n\t  \"enabled\" : false\r\n\t},\r\n        \"properties\" : {\r\n          \"content\" : {\r\n            \"type\" : \"text\",\r\n            \"analyzer\":\"cjk\"\r\n          },\r\n          \"id\" : {\r\n            \"type\" : \"keyword\"\r\n          }\r\n        }\r\n    }\r\n}\r\n'\r\n\r\n#index demo\r\ncurl -XPUT 'http://localhost:9200/fulltext001/doc/1?pretty' -H 'Content-Type: application/json' -d '\r\n{\r\n    \"id\": \"https://www.huxiu.com/article/215169.html\",\r\n    \"content\": \"“娃娃机，迷你KTV，VR体验馆，堪称商场三大标配‘神器’。”一家地处商业中心的大型综合体负责人告诉懂懂笔记，在过去的这几个月里，几乎所有的综合体都“标配”了这三种“设备”…\"\r\n}'\r\n\r\ncurl -XPUT 'http://localhost:9200/fulltext001/doc/2?pretty' -H 'Content-Type: application/json' -d '\r\n{\r\n    \"id\": \"https://www.huxiu.com/article/217588.html\",\r\n    \"content\": \"虎嗅注：本文转载自微信公众号“PingWest品玩”（wepingwest），作者：范俊杰。  趣店集团成立于2014年3月。近日据外媒报道，趣店计划于美国东部时间10月18日（万圣节前夕）在纽约证券交易所挂牌上市，预计融资7.69亿美元。…\"\r\n}'\r\n\r\ncurl -XPUT 'http://localhost:9200/fulltext001/doc/3?pretty' -H 'Content-Type: application/json' -d '\r\n{\r\n    \"id\": \"https://www.huxiu.com/article/222027.html\",\r\n    \"content\": \"趣分期和分期乐曾经是校园贷领域的两大明星公司，之后二者都进行了品牌升级，成为如今的趣店和乐信，也都表示退出校园贷领域。如今二者又延续了相同的步调，继趣店在美上市后，乐信也在美发布招股书，计划在美上市。虽然两家公司经常被作为对标公司，但从目前的业务状况看，二者还是有比较大的差异。…\"\r\n}'\r\n\r\ncurl -XPUT 'http://localhost:9200/fulltext001/doc/4?pretty' -H 'Content-Type: application/json' -d '\r\n{\r\n    \"id\": \"https://www.huxiu.com/article/239920.html\",\r\n    \"content\": \"虎嗅注：昨日（4月13日），虎嗅 “2018 WOW! 新媒体营销分享会” 在北京召开，luckin coffee作为咖啡新零售品牌，准备凭借其优选的产品原料、精湛的咖啡工艺，创新的商业模式和领先的移动互联网技术来改变咖啡行业。…\"\r\n}'\r\n\r\ncurl -XPUT 'http://localhost:9200/fulltext001/doc/5?pretty' -H 'Content-Type: application/json' -d '\r\n{\r\n    \"id\": \"https://www.huxiu.com/article/204310.html\",\r\n    \"content\": \"虎嗅注：无人便利店突然成为创投圈的新风口。  然而，它究竟是否真的那么具有“颠覆性”？而这种与消费者自身关系并不紧密的人工成本节省是否真的有意义？本文对上述疑问一一进行了探讨。  本文首发自微信公众号快刀三侠（ID：iyqkpd），虎嗅获授权转载。  盛夏，资本市场的升温速度令人咋舌。  7月1日，F5未来商店完成3000万元A+轮融资；7月3日，缤果盒子完成超1亿元A轮融资；短短一周，融资便超过1.3亿元。  紧接着，7月8日，阿里巴巴无人超市“淘咖啡”正式亮相杭州。…\"\r\n}'\r\n\r\n#search demo\r\ntime curl -XGET 'http://localhost:9200/fulltext001/_search?_source=id&sort=id&size=10000&q=content:%22KTV%22' > es_result.txt\r\n\r\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}