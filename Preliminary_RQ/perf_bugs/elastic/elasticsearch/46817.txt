{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46817","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46817/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46817/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46817/events","html_url":"https://github.com/elastic/elasticsearch/issues/46817","id":495202864,"node_id":"MDU6SXNzdWU0OTUyMDI4NjQ=","number":46817,"title":"DLS search performance/canMatch impact","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1352927464,"node_id":"MDU6TGFiZWwxMzUyOTI3NDY0","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.3.0","name":"v7.3.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2019-09-18T12:45:32Z","updated_at":"2019-10-14T11:06:37Z","closed_at":"2019-10-14T11:06:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"During `IndexShard.acquireSearcher`, the `readerWrapper` is applied, which populates the DLS bitsets. This causes a performance issue, since `IndexShard.acquireSearcher` is called during the `canMatch` phase. In this context it seems unnecessary, since we are only after whether the shard could match or not, which does not require DLS to kick in. When searching for a short time range in a large number of time based indices, this causes a performance impact which seems unnecessary.\r\n\r\nConcrete observations: A query that takes 30ms can take 26s for a DLS filtered user. The user has many DLS roles applied, which seems to increase the impact of the issue. The hot threads are dominated by variants of this stack trace:\r\n\r\n```\r\napp//org.apache.lucene.search.DisjunctionDISIApproximation.nextDoc(DisjunctionDISIApproximation.java:55)\r\napp//org.apache.lucene.search.DisjunctionDISIApproximation.nextDoc(DisjunctionDISIApproximation.java:55)\r\napp//org.apache.lucene.util.BitSet.or(BitSet.java:95)\r\napp//org.apache.lucene.util.FixedBitSet.or(FixedBitSet.java:271)\r\napp//org.apache.lucene.util.BitSet.of(BitSet.java:41)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetBitsetCache.lambda$getBitSet$2(DocumentSubsetBitsetCache.java:153)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetBitsetCache$$Lambda$5134/0x000000080204e840.load(Unknown Source)\r\napp//org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:433)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetBitsetCache.getBitSet(DocumentSubsetBitsetCache.java:135)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetReader.<init>(DocumentSubsetReader.java:160)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetReader.<init>(DocumentSubsetReader.java:34)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetReader$DocumentSubsetDirectoryReader$1.wrap(DocumentSubsetReader.java:120)\r\napp//org.apache.lucene.index.FilterDirectoryReader$SubReaderWrapper.wrap(FilterDirectoryReader.java:62)\r\napp//org.apache.lucene.index.FilterDirectoryReader.<init>(FilterDirectoryReader.java:91)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetReader$DocumentSubsetDirectoryReader.<init>(DocumentSubsetReader.java:116)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.DocumentSubsetReader.wrap(DocumentSubsetReader.java:38)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.SecurityIndexReaderWrapper.apply(SecurityIndexReaderWrapper.java:86)\r\norg.elasticsearch.xpack.core.security.authz.accesscontrol.SecurityIndexReaderWrapper.apply(SecurityIndexReaderWrapper.java:42)\r\napp//org.elasticsearch.index.shard.IndexShard.wrapSearcher(IndexShard.java:1262)\r\napp//org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1240)\r\napp//org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1224)\r\napp//org.elasticsearch.search.SearchService.createSearchContext(SearchService.java:632)\r\napp//org.elasticsearch.search.SearchService.canMatch(SearchService.java:1007)\r\napp//org.elasticsearch.search.SearchService.canMatch(SearchService.java:1020)\r\napp//org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$14(SearchTransportService.java:396)\r\napp//org.elasticsearch.action.search.SearchTransportService$$Lambda$3005/0x0000000801b4d840.messageReceived(Unknown Source)\r\n```\r\n\r\nThese all run directly in the transport thread.\r\n\r\nEncountered on ES v7.3.0, running on linux OS.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}