[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/171704261","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-171704261","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":171704261,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MTcwNDI2MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-14T17:00:36Z","updated_at":"2016-01-14T17:00:36Z","author_association":"CONTRIBUTOR","body":"What version of ES?\nHow many times did you run it?\nHow many segments do you have?\nWhat hardware are you running this on? (all your search times seem very slow for such a small index)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/171710099","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-171710099","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":171710099,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MTcxMDA5OQ==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2016-01-14T17:15:44Z","updated_at":"2016-01-14T17:15:44Z","author_association":"NONE","body":"- ES:  2.1.1 - Lucene 5.3.1,  -Xms28g -Xmx28g mlockall = true\n- 6 times consecutively for each query\n- Intel(R) Xeon(R) CPU           X5650  @ 2.67GHz, 2 physical cpu's, 12 cores w hyperthreading, 24 processors in total\n- 64GB ram, 1TB SSD \n- segments : https://gist.github.com/jrots/d7020441bf33dca4b67a , 4 shards with 30 segments on each shard\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/171724590","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-171724590","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":171724590,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MTcyNDU5MA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-14T18:05:06Z","updated_at":"2016-01-14T18:05:06Z","author_association":"MEMBER","body":"And what is the average time when you remove the range filter/post_filter ? The post_filter vs filter are very similar in terms of implementation, the post_filter has to scan the inverted lists also. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/171937435","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-171937435","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":171937435,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MTkzNzQzNQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T11:23:43Z","updated_at":"2016-01-15T11:23:43Z","author_association":"CONTRIBUTOR","body":"@jrots It seems there may be a misunderstanding of what the `post_filter` does in Elasticsearch.  The post filter is simply a filter that is applied to the query results AFTER aggregations have been calculated - it has nothing to do with executing the filter via the inverted index vs fielddata.\n\nThat said, something seems odd about how the query is executed - if the range query is the most costly, the bool query should figure that out and change the execution order to apply the terms queries first.  We'll investigate.\n\nTwo questions:\n- Is the `birthdate` field mapped as a string or as a date?\n- Why do the number of results differ for the two queries? Are you actively indexing?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172001365","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172001365","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172001365,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjAwMTM2NQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T16:05:04Z","updated_at":"2016-01-15T16:05:13Z","author_association":"MEMBER","body":"> Why do the number of results differ for the two queries? Are you actively indexing?\n\n@clintongormley I guess that the number of results differs because the post-filtered documents are not taken into account in the total hits. I opened https://github.com/elastic/elasticsearch/issues/16021 because I don't know if it's expected or not.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172011690","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172011690","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172011690,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjAxMTY5MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T16:44:59Z","updated_at":"2016-01-15T16:44:59Z","author_association":"CONTRIBUTOR","body":"@jimferenczi no - these counts should be the same whether post_filter is used or not.  post_filter just affects which documents the aggs see.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172016772","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172016772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172016772,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjAxNjc3Mg==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T17:03:34Z","updated_at":"2016-01-15T17:05:16Z","author_association":"NONE","body":"I was still actively indexing at that moment - now that's done and I've also ran: force merge max_segments=1 to be sure that we're measuring the right things here. \n\nwith range on birthdate : \n\n``` json\n{\"took\":872,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n{\"took\":875,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n{\"took\":109,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n```\n\nIf I change the range of the birthdate with one day f.e. it's again consecutive 800ms+ \n\nleaving out the birthdate completely : \n\n``` json\n{\"took\":37,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":39062}}\n{\"took\":32,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":39062}}\n```\n\netc.. \neven changing some of the params in the query, \n\nrunning with range on birthdate in post_filter,initial + consecutive \n\n``` json\n{\"took\":401,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n{\"took\":54,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n{\"took\":53,\"timed_out\":false,\"_shards\":{\"total\":4,\"successful\":4,\"failed\":0},\"hits\":{\"total\":18892}}\n```\n\nbirthdate is stored as : \n\n``` json\n          \"birthdate\" : {\n            \"type\" : \"date\",\n            \"format\" : \"YYYY-MM-dd\"\n          },\n```\n\nWonder if I don't need time precision on my dates (like a birthdate f.e.), \nif I'm not better of storing these dates as a fixed int number => floor(( (epochtime) - (timestamp birthdate) )/60/60/24)\nThis way it would generate less terms in the lucene index, the precision_step would also be 8 in that case, delivering faster responses. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172019754","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172019754","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172019754,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjAxOTc1NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T17:14:58Z","updated_at":"2016-01-15T17:14:58Z","author_association":"CONTRIBUTOR","body":"> I was still actively indexing at that moment\n\nOK that explains the varying counts.\n\n> Wonder if I don't need time precision on my dates (like a birthdate f.e.), if I'm not better of storing these dates as a fixed int number => floor(( (epochtime)  (timestamp birthdate) )/60/60/24)\n\nBefore going there... query execution order has had a big rewrite, and it sounds like it is choosing a suboptimal order.  @jimferenczi is going to dive into it to see if he can find something that can be improved.\n\nthanks for all the info\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172086242","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172086242","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172086242,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjA4NjI0Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T20:36:06Z","updated_at":"2016-01-15T21:10:33Z","author_association":"MEMBER","body":"edited version of the comment which was wrong and misleading.\n@jrots I'll try to reproduce.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172552757","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172552757","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172552757,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjU1Mjc1Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-01-18T15:00:21Z","updated_at":"2016-01-18T15:00:21Z","author_association":"MEMBER","body":"@jrots I've tried to reproduce with a 40M documents index, 5 shards, each document contain one date field with a random date chosen between \"1950-01-01\" to \"2000-12-31\" and two long fields with different cardinalities (one big and one small).\n I compared the post_filter+boolean query vs one big boolean query and the results are always the same, there is no gain with the post_filter. I checked with different type of range queries (big range like 1950 => 2000 and small ones like your example).  \nWhen you test the performance you can have some variations depending on the activity of your machine in terms of cpu and ram. Are you sure that you stopped the indexing and the queries when you checked the performance of each query ? Can you try to re-run your tests with more than 3 trials per query ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172609890","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172609890","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172609890,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjYwOTg5MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-18T18:11:05Z","updated_at":"2016-01-18T18:11:05Z","author_association":"CONTRIBUTOR","body":"@jrots could you provide a more complete recreation? or would it be possible to upload your index somewhere so that we could try it out?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172964504","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-172964504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":172964504,"node_id":"MDEyOklzc3VlQ29tbWVudDE3Mjk2NDUwNA==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2016-01-19T19:45:43Z","updated_at":"2016-01-19T19:45:43Z","author_association":"NONE","body":"Ok I'll have a look to have a testable index that doesn't contain too much private info\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/177888722","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-177888722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":177888722,"node_id":"MDEyOklzc3VlQ29tbWVudDE3Nzg4ODcyMg==","user":{"login":"jrots","id":195346,"node_id":"MDQ6VXNlcjE5NTM0Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/195346?v=4","gravatar_id":"","url":"https://api.github.com/users/jrots","html_url":"https://github.com/jrots","followers_url":"https://api.github.com/users/jrots/followers","following_url":"https://api.github.com/users/jrots/following{/other_user}","gists_url":"https://api.github.com/users/jrots/gists{/gist_id}","starred_url":"https://api.github.com/users/jrots/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrots/subscriptions","organizations_url":"https://api.github.com/users/jrots/orgs","repos_url":"https://api.github.com/users/jrots/repos","events_url":"https://api.github.com/users/jrots/events{/privacy}","received_events_url":"https://api.github.com/users/jrots/received_events","type":"User","site_admin":false},"created_at":"2016-02-01T10:07:38Z","updated_at":"2016-02-01T10:09:15Z","author_association":"NONE","body":"Hi guys, \nsorry for the late reply.I retried the post_filter and filter on date ranges and it indeed have the same results.. (both quite slow to be honest). Must've been the indexing I was doing at that time that caused the fluctuation in search response times. \n\nI think if you have a lot of documents and are doing a wide numeric range there can be a big slowdown. .\n\nI fixed my problem by rewriting the following range query  :\n\n```\n                    \"range\": {\n                                \"birthdate\": {\n                                    \"gte\": \"1967-01-28\",\n                                    \"lte\": \"1996-01-28\"\n                                }\n                            }\n```\n\nto : \n\n```\n\"filter\": {\n                \"bool\": {\n                    \"should\": [\n                        {\n                            \"range\": {\n                                \"birthdate\": {\n                                    \"gte\": \"1967-01-28\",\n                                    \"lte\": \"1967-12-31\"\n                                }\n                            }\n                        },\n                        {\n                            \"range\": {\n                                \"birthdate\": {\n                                    \"gte\": \"1996-01-01\",\n                                    \"lte\": \"1996-01-28\"\n                                }\n                            }\n                        },\n                        {\n                            \"terms\": {\n                                \"country_birthdate_string\": [\n                                    \"be1-1968\",\n                                    \"be1-1969\",\n                                    \"be0-1970\",\n                                    \"be0-1980\",\n                                    \"be1-1990\",\n                                    \"be1-1991\",\n                                    \"be1-1992\",\n                                    \"be1-1993\",\n                                    \"be1-1994\",\n                                    \"be1-1995\"\n                                ]\n                            }\n                        }\n```\n\n<country>0_<year rounded 0> => spans 10 years\n<country>1 => spans 1 year\n\nI added a transform to the index mapping that generates these keywords automatically for me: \n\n```\n    \"mappings\" : {\n      \"person\" : {\n        \"transform\" : {\n          \"inline\" : \"ctx._source[\\\"country_birthdate_string\\\"] = [ctx._source[\\\"country\\\"] + \\\"0_\\\"+(int)Math.floor(Integer.parseInt(ctx._source[\\\"birthdate\\\"].substring(0,4))/10)*10, ctx._source[\\\"country\\\"] + \\\"1_\\\"+ctx._source[\\\"birthdate\\\"].substring(0,4)];\",\n          \"lang\" : \"groovy\"\n        },\n        \"_all\" : {\n          \"enabled\" : false\n        },\n        \"properties\" : {\n          \"birthdate\" : {\n            \"type\" : \"date\",\n            \"format\" : \"YYYY-MM-dd\"\n          },\n          \"country\" : {\n            \"type\" : \"string\",\n            \"index\" : \"not_analyzed\"\n          },\n          \"country_birthdate_string\" : {\n            \"type\" : \"string\",\n            \"index\" : \"not_analyzed\"\n          },\n```\n\nI have a speed up times 10 doing it like this for my use case. \nMaybe worth adding something like this higher up in lucene internal/ revisit the numeric tree lookup for large ranges. . \nRegards\nJ\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/190704428","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-190704428","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":190704428,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDcwNDQyOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-03-01T12:34:33Z","updated_at":"2016-03-01T12:34:33Z","author_association":"CONTRIBUTOR","body":"The new point field encoding coming in 5.0 should improve this situation.  Closing\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292131208","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-292131208","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":292131208,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MjEzMTIwOA==","user":{"login":"ChristopheBoucaut","id":2339969,"node_id":"MDQ6VXNlcjIzMzk5Njk=","avatar_url":"https://avatars0.githubusercontent.com/u/2339969?v=4","gravatar_id":"","url":"https://api.github.com/users/ChristopheBoucaut","html_url":"https://github.com/ChristopheBoucaut","followers_url":"https://api.github.com/users/ChristopheBoucaut/followers","following_url":"https://api.github.com/users/ChristopheBoucaut/following{/other_user}","gists_url":"https://api.github.com/users/ChristopheBoucaut/gists{/gist_id}","starred_url":"https://api.github.com/users/ChristopheBoucaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ChristopheBoucaut/subscriptions","organizations_url":"https://api.github.com/users/ChristopheBoucaut/orgs","repos_url":"https://api.github.com/users/ChristopheBoucaut/repos","events_url":"https://api.github.com/users/ChristopheBoucaut/events{/privacy}","received_events_url":"https://api.github.com/users/ChristopheBoucaut/received_events","type":"User","site_admin":false},"created_at":"2017-04-06T10:19:06Z","updated_at":"2017-04-06T10:25:12Z","author_association":"NONE","body":"Hi @jrots.\r\n\r\nDid you test your use case with ES 5.* ? Can you confirm the improve ?\r\n\r\nI have the same issue with ES 5.3 and I don't found a \"native solution\" in ES.\r\n\r\nRegards.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/311564782","html_url":"https://github.com/elastic/elasticsearch/issues/15994#issuecomment-311564782","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15994","id":311564782,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMTU2NDc4Mg==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2017-06-28T06:03:36Z","updated_at":"2017-06-28T06:03:36Z","author_association":"CONTRIBUTOR","body":"@hwb1992 Please ask this question on our [discuss forum](https://discuss.elastic.co/) where we can provide better support.","performed_via_github_app":null}]