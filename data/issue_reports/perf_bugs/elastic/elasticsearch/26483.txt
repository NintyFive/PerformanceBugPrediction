{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26483","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26483/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26483/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26483/events","html_url":"https://github.com/elastic/elasticsearch/issues/26483","id":254894543,"node_id":"MDU6SXNzdWUyNTQ4OTQ1NDM=","number":26483,"title":"Elasticsearch service hangs in stopping status with ReadonlyREST plugin","user":{"login":"askids","id":10394218,"node_id":"MDQ6VXNlcjEwMzk0MjE4","avatar_url":"https://avatars0.githubusercontent.com/u/10394218?v=4","gravatar_id":"","url":"https://api.github.com/users/askids","html_url":"https://github.com/askids","followers_url":"https://api.github.com/users/askids/followers","following_url":"https://api.github.com/users/askids/following{/other_user}","gists_url":"https://api.github.com/users/askids/gists{/gist_id}","starred_url":"https://api.github.com/users/askids/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/askids/subscriptions","organizations_url":"https://api.github.com/users/askids/orgs","repos_url":"https://api.github.com/users/askids/repos","events_url":"https://api.github.com/users/askids/events{/privacy}","received_events_url":"https://api.github.com/users/askids/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-09-03T19:13:52Z","updated_at":"2017-09-05T12:38:13Z","closed_at":"2017-09-04T07:16:27Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.1\r\n\r\n**Plugins installed**: [xpack, readonlyrest]\r\n\r\n**JVM version** (`java -version`): \r\njava version \"1.8.0_131\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_131-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows 2008 R2 Enterprise SP1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI have Elasticsearch 5.5.1 running as a windows service (this was created manually using the zip file) on Win 2008 R2 server. When I install ReadonlyREST 1.16.10_es5.5.1 (free version) and restart the service for the 1st time, it restarts properly and plugin also work (i get the prompted for id/pwd). But when I make any changes in elasticsearch.yml file and try restarting the service, the service hangs in stopping status.\r\n\r\nI have copied the additional entries that I have on my elasticsearch.yml file. If I see the Elasticsearch log, it looks like the service stopped properly. But in the Windows service manager, the service status is shown as stopping. In the task manager, I can still see elasticsearch exe in running status.\r\n\r\nCurrently, only way to get it back to working is to restart the machine, which is definitely not something that we want to do everytime we change something on elasticsearch.yml file. If I remove the plugin, restart service works fine in the service manager.\r\n\r\nPlease let me know, if you need any further details.\r\n\r\n**Steps to reproduce**:\r\n1. Install 5.5.1 using zip. create service manually using SC command.\r\n2. Install xpack 5.5.1. Enable only monitoring plugin, disable security, graph, watcher.\r\n3. Install readonlyrest 1.16.10_es5.5.1. Update elasticsearch.yml with basic rule for Kibana (given below)\r\n4. Restart windows service from service manager (till here it works fine. Try opening the Elasticsearch endpoint using https address. It will prompt for id/pwd. On providing the input, it will show the cluster name, version number etc)\r\n5. Modify a comment line to elasticsearch.yml file and try restarting the Elasticsearch windows service.\r\n\r\n```\r\naction.destructive_requires_name: true\r\ntransport.tcp.port: 12300\r\naction.auto_create_index: .security,.monitoring*,.watches,.triggered_watches,.watcher-history*,.kibana*\r\nxpack.security.enabled: false\r\nxpack.monitoring.enabled: true\r\nxpack.graph.enabled: false\r\nxpack.watcher.enabled: false\r\nindices.query.bool.max_clause_count: 20000\r\n#\r\n# ReadonlyREST\r\nhttp.type: ssl_netty4\r\nreadonlyrest:\r\n    enable: true \r\n    response_if_req_forbidden: Forbidden by ReadonlyREST ES plugin\r\n    \r\n    ssl:\r\n      enable: true\r\n      # put the keystore in the same dir with elasticsearch.yml \r\n      keystore_file: \"plugins/readonlyrest/mykeystore.jks\"\r\n      keystore_pass: Password1\r\n      key_pass: Password1\r\n   \r\n    access_control_rules:\r\n\r\n    - name: Kibana Server\r\n      type: allow\r\n      auth_key: kibana:kibana\r\n      verbosity: error\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n    [2017-09-03T14:28:33,721][INFO ][o.e.n.Node               ] [ESPOC2-node1] stopping ...\r\n    [2017-09-03T14:28:33,742][INFO ][o.e.x.m.j.p.l.CppLogMessageHandler] [controller/2728] [Main.cc@168] Ml controller exiting\r\n    [2017-09-03T14:28:33,746][INFO ][o.e.x.m.j.p.NativeController] Native controller process has stopped - no new native processes can be started\r\n    [2017-09-03T14:28:33,815][INFO ][o.e.n.Node               ] [ESPOC2-node1] stopped\r\n    [2017-09-03T14:28:33,816][INFO ][o.e.n.Node               ] [ESPOC2-node1] closing ...\r\n    [2017-09-03T14:28:33,825][INFO ][o.e.n.Node               ] [ESPOC2-node1] closed\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}