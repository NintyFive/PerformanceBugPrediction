{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5086","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5086/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5086/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5086/events","html_url":"https://github.com/elastic/elasticsearch/issues/5086","id":27358187,"node_id":"MDU6SXNzdWUyNzM1ODE4Nw==","number":5086,"title":"In MVEL .empty can be way way way slower then .isEmpty()","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-02-11T15:50:50Z","updated_at":"2014-12-29T14:21:30Z","closed_at":"2014-12-29T11:36:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This happens when you use `.empty` to check if a field is empty and it actually is empty.  I've made a gist to reproduce it: https://gist.github.com/nik9000/8937202\n\nHigh level:\n1.  Hit ~1 million documents with a script score.\n2.  Do something like `(doc['foo'].empty ? 0 : doc['foo'].value) * doc['bar']`.  The `.empty` is the key here.\n3.  If most of the documents don't have a `foo` then this is really slow.  Like, two seconds slow.\n4.  Instead, switch to this `(doc['foo'].isEmpty() ? 0 : doc['foo'].value) * doc['bar']`.  That is faster.  .36 seconds or so.  Not super speedy, but much better.\n\nI'm not completely sure what is happening but my guess is that the MVEL optimizer is optimizing .empty is a call to .isEmpty on an instance of either ScriptDocValues or ScriptDocValues.Empty.  When it hits the wrong one it recovers by catching an IllegalArgumentException thrown by the JVM and then does some munging.  The act of filling in the stack trace for that IllegalArgumentException is really really really slow.  So slow, I see it in the hot threads: https://gist.github.com/nik9000/8937335 .\n\nWorkaround: use `.isEmpty()` instead of `.empty`.\n\nI'm not sure what the fix ought to be.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}