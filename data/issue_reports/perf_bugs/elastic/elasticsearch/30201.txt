{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30201/events","html_url":"https://github.com/elastic/elasticsearch/issues/30201","id":318356621,"node_id":"MDU6SXNzdWUzMTgzNTY2MjE=","number":30201,"title":"org.elasticsearch.common.cache.Cache deadlock when loader throws Error","user":{"login":"nomoa","id":5939211,"node_id":"MDQ6VXNlcjU5MzkyMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5939211?v=4","gravatar_id":"","url":"https://api.github.com/users/nomoa","html_url":"https://github.com/nomoa","followers_url":"https://api.github.com/users/nomoa/followers","following_url":"https://api.github.com/users/nomoa/following{/other_user}","gists_url":"https://api.github.com/users/nomoa/gists{/gist_id}","starred_url":"https://api.github.com/users/nomoa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nomoa/subscriptions","organizations_url":"https://api.github.com/users/nomoa/orgs","repos_url":"https://api.github.com/users/nomoa/repos","events_url":"https://api.github.com/users/nomoa/events{/privacy}","received_events_url":"https://api.github.com/users/nomoa/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-04-27T10:23:22Z","updated_at":"2018-04-29T18:52:52Z","closed_at":"2018-04-29T18:52:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi,\r\nI'm currently investigating what seems to be a deadlock issue in `org.elasticsearch.common.cache.Cache` (ref https://github.com/o19s/elasticsearch-learning-to-rank/issues/153). It was reported to happen on 5.5 and 6.2.\r\n\r\nReading the stack I understand that the `CompletableFuture` created just before calling the loader method in `computeIfAbsent` and stored in `Cache.CacheSegment#map` is never resolved.\r\nOne possibility would be that the loader method throws an Error (or anything extending Throwable but not Exception).\r\n\r\nThis simple test case allows to reproduce the issue:\r\n```java\r\n        Cache<String, String> cache = CacheBuilder.<String, String>builder().build();;\r\n\r\n        try {\r\n            cache.computeIfAbsent(\"test\", (s) -> {\r\n                throw new Error(\"test\");\r\n            });\r\n        } catch (Error e) {\r\n            e.printStackTrace();\r\n        }\r\n        cache.computeIfAbsent(\"test\", (s) -> \"s\" ); // Deadlock\r\n```\r\nI believe that `computeIfAbsent` should catch `Throwable` instead of `Exception`.\r\n\r\nSee https://github.com/elastic/elasticsearch/blob/dfc7ca72147d11b2757c5feec84aa1dedcfef4b3/server/src/main/java/org/elasticsearch/common/cache/Cache.java#L413\r\n","closed_by":{"login":"nomoa","id":5939211,"node_id":"MDQ6VXNlcjU5MzkyMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5939211?v=4","gravatar_id":"","url":"https://api.github.com/users/nomoa","html_url":"https://github.com/nomoa","followers_url":"https://api.github.com/users/nomoa/followers","following_url":"https://api.github.com/users/nomoa/following{/other_user}","gists_url":"https://api.github.com/users/nomoa/gists{/gist_id}","starred_url":"https://api.github.com/users/nomoa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nomoa/subscriptions","organizations_url":"https://api.github.com/users/nomoa/orgs","repos_url":"https://api.github.com/users/nomoa/repos","events_url":"https://api.github.com/users/nomoa/events{/privacy}","received_events_url":"https://api.github.com/users/nomoa/received_events","type":"User","site_admin":false},"performed_via_github_app":null}