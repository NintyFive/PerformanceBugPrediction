{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30611","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30611/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30611/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30611/events","html_url":"https://github.com/elastic/elasticsearch/issues/30611","id":323190047,"node_id":"MDU6SXNzdWUzMjMxOTAwNDc=","number":30611,"title":"Elasticsearch process stuck on our machine(or virtual machine failure) which have a NFS mount point when NFS service failure（resulting in `df -h` stuck)","user":{"login":"wuyunfeng","id":5183061,"node_id":"MDQ6VXNlcjUxODMwNjE=","avatar_url":"https://avatars1.githubusercontent.com/u/5183061?v=4","gravatar_id":"","url":"https://api.github.com/users/wuyunfeng","html_url":"https://github.com/wuyunfeng","followers_url":"https://api.github.com/users/wuyunfeng/followers","following_url":"https://api.github.com/users/wuyunfeng/following{/other_user}","gists_url":"https://api.github.com/users/wuyunfeng/gists{/gist_id}","starred_url":"https://api.github.com/users/wuyunfeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuyunfeng/subscriptions","organizations_url":"https://api.github.com/users/wuyunfeng/orgs","repos_url":"https://api.github.com/users/wuyunfeng/repos","events_url":"https://api.github.com/users/wuyunfeng/events{/privacy}","received_events_url":"https://api.github.com/users/wuyunfeng/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-05-15T12:11:24Z","updated_at":"2018-05-15T13:17:05Z","closed_at":"2018-05-15T12:16:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):5.5.0\r\n\r\n**Plugins installed**: [ik、repository-hdfs、repository-s3]\r\n\r\n**JVM version** (`java -version`):1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):CentOS 7.3\r\n\r\n**Description of the problem including expected versus actual behavior**: Elasticsearch process stuck on our machine(or virtual machine failure) which have a NFS mount point when NFS service failure（resulting in `df -h` stuck)\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Start NFS service which have a mount point /mnt/nfs..\r\n 2. Stop NFS service (do not umount the mount point)\r\n 3. Start Elasticsearch,Elasticsearch stuck forever...\r\n\r\n**Provide logs (if relevant)**:\r\nJava Stacktrace:\r\n\r\n124 \"main\" #1 prio=5 os_prio=0 tid=0x00007fe7bc00b000 nid=0x8476 runnable [0x00007fe7c56be000]\r\n125    java.lang.Thread.State: RUNNABLE\r\n126         at java.io.UnixFileSystem.canonicalize0(Native Method)\r\n127         at java.io.UnixFileSystem.canonicalize(UnixFileSystem.java:172)\r\n128         at java.io.File.getCanonicalPath(File.java:618)\r\n129         at java.io.FilePermission$1.run(FilePermission.java:215)\r\n130         at java.io.FilePermission$1.run(FilePermission.java:203)\r\n131         at java.security.AccessController.doPrivileged(Native Method)\r\n132         at java.io.FilePermission.init(FilePermission.java:203)\r\n133         at java.io.FilePermission.<init>(FilePermission.java:277)\r\n134         at java.lang.SecurityManager.checkRead(SecurityManager.java:888)\r\n135         at sun.nio.fs.UnixFileSystem$FileStoreIterator.readNext(UnixFileSystem.java:207)\r\n136         at sun.nio.fs.UnixFileSystem$FileStoreIterator.hasNext(UnixFileSystem.java:224)\r\n137         - locked <0x00000003cb23c398> (a sun.nio.fs.UnixFileSystem$FileStoreIterator)\r\n138         at org.apache.lucene.util.IOUtils.**getFileStore**(IOUtils.java:595)\r\n139         at org.apache.lucene.util.IOUtils.spinsLinux(IOUtils.java:539)\r\n140         at org.apache.lucene.util.IOUtils.spins(IOUtils.java:528)\r\n141         at org.elasticsearch.env.ESFileStore.<init>(ESFileStore.java:60)\r\n142         at org.elasticsearch.env.Environment.<clinit>(Environment.java:119)\r\n143         at org.elasticsearch.node.InternalSettingsPreparer.prepareEnvironment(InternalSettingsPreparer.java:90)\r\n144         at org.elasticsearch.cli.EnvironmentAwareCommand.createEnv(EnvironmentAwareCommand.java:72)\r\n145         at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:67)\r\n146         at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:122)\r\n147         at org.elasticsearch.cli.Command.main(Command.java:88)\r\n148         at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:91)\r\n149         at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:84)\r\n\r\n\r\n**Then we find  the method `IOUtils.**getFileStore** ` invoke the `path.getFileSystem().getFileStores()` , this like the `df  -h` command stucked....**\r\n\r\n`static FileStore getFileStore(Path path) throws IOException {\r\n    FileStore store = Files.getFileStore(path);\r\n    String mount = getMountPoint(store);\r\n\r\n    // find the \"matching\" FileStore from system list, it's the one we want, but only return\r\n    // that if it's unambiguous (only one matching):\r\n    FileStore sameMountPoint = null;\r\n    for (FileStore fs : path.getFileSystem().getFileStores()) {\r\n      if (mount.equals(getMountPoint(fs))) {\r\n        if (sameMountPoint == null) {\r\n          sameMountPoint = fs;\r\n        } else {\r\n          // more than one filesystem has the same mount point; something is wrong!\r\n          // fall back to crappy one we got from Files.getFileStore\r\n          return store;\r\n        }\r\n      }\r\n    }`\r\n\r\nHow we resolve this problem, Can we modify the Lucene `IOUtils.getFileStore` or  elasticsearch team can provide a better solution?","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}