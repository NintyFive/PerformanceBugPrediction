{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22952/events","html_url":"https://github.com/elastic/elasticsearch/issues/22952","id":205103808,"node_id":"MDU6SXNzdWUyMDUxMDM4MDg=","number":22952,"title":"Deadlock on aggregation in 2.x","user":{"login":"maxcom","id":69385,"node_id":"MDQ6VXNlcjY5Mzg1","avatar_url":"https://avatars3.githubusercontent.com/u/69385?v=4","gravatar_id":"","url":"https://api.github.com/users/maxcom","html_url":"https://github.com/maxcom","followers_url":"https://api.github.com/users/maxcom/followers","following_url":"https://api.github.com/users/maxcom/following{/other_user}","gists_url":"https://api.github.com/users/maxcom/gists{/gist_id}","starred_url":"https://api.github.com/users/maxcom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxcom/subscriptions","organizations_url":"https://api.github.com/users/maxcom/orgs","repos_url":"https://api.github.com/users/maxcom/repos","events_url":"https://api.github.com/users/maxcom/events{/privacy}","received_events_url":"https://api.github.com/users/maxcom/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2017-02-03T09:03:35Z","updated_at":"2017-02-06T12:52:01Z","closed_at":"2017-02-06T12:51:55Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.4 and 2.4.3\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version**: OpenJDK 1.8.0.101-3.b13\r\n\r\n**OS version**: CentOS 6.8\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSearch threads became completely locked up sometimes. All search threads have the same track trace. No progress is made until we restart Elasticsearch.\r\n\r\nWe seen this problem on 2.3.4 and 2.4.3. \r\n\r\n**Steps to reproduce**: Do not know how to reproduce it\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nHere is stack trace from 2.3.4:\r\n\r\n```\r\n2017-02-03 10:35:44.216064500 \"elasticsearch[main][search][T#12]\" #116 daemon prio=5 os_prio=0 tid=0x00007f498c0a7800 nid=0x266f in Object.wait() [0x00007f48d18da000]\r\n2017-02-03 10:35:44.216089500    java.lang.Thread.State: RUNNABLE\r\n2017-02-03 10:35:44.216090500 \tat org.elasticsearch.search.aggregations.support.AggregationContext.bytesField(AggregationContext.java:178)\r\n2017-02-03 10:35:44.216098500 \tat org.elasticsearch.search.aggregations.support.AggregationContext.originalValuesSource(AggregationContext.java:151)\r\n2017-02-03 10:35:44.216106500 \tat org.elasticsearch.search.aggregations.support.AggregationContext.valuesSource(AggregationContext.java:85)\r\n2017-02-03 10:35:44.216108500 \tat org.elasticsearch.search.aggregations.support.ValuesSourceAggregatorFactory.createInternal(ValuesSourceAggregatorFactory.java:60)\r\n2017-02-03 10:35:44.216116500 \tat org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:102)\r\n2017-02-03 10:35:44.216118500 \tat org.elasticsearch.search.aggregations.AggregatorFactories.createSubAggregators(AggregatorFactories.java:76)\r\n2017-02-03 10:35:44.216127500 \tat org.elasticsearch.search.aggregations.AggregatorBase.<init>(AggregatorBase.java:69)\r\n2017-02-03 10:35:44.216128500 \tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.<init>(BucketsAggregator.java:48)\r\n2017-02-03 10:35:44.216137500 \tat org.elasticsearch.search.aggregations.bucket.SingleBucketAggregator.<init>(SingleBucketAggregator.java:38)\r\n2017-02-03 10:35:44.216139500 \tat org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator.<init>(FilterAggregator.java:54)\r\n2017-02-03 10:35:44.216146500 \tat org.elasticsearch.search.aggregations.bucket.filter.FilterAggregator$Factory.createInternal(FilterAggregator.java:108)\r\n2017-02-03 10:35:44.216148500 \tat org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:102)\r\n2017-02-03 10:35:44.216156500 \tat org.elasticsearch.search.aggregations.AggregatorFactories.createSubAggregators(AggregatorFactories.java:76)\r\n2017-02-03 10:35:44.216158500 \tat org.elasticsearch.search.aggregations.AggregatorBase.<init>(AggregatorBase.java:69)\r\n2017-02-03 10:35:44.216166500 \tat org.elasticsearch.search.aggregations.bucket.BucketsAggregator.<init>(BucketsAggregator.java:48)\r\n2017-02-03 10:35:44.216168500 \tat org.elasticsearch.search.aggregations.bucket.SingleBucketAggregator.<init>(SingleBucketAggregator.java:38)\r\n2017-02-03 10:35:44.216175500 \tat org.elasticsearch.search.aggregations.bucket.nested.NestedAggregator.<init>(NestedAggregator.java:61)\r\n2017-02-03 10:35:44.216177500 \tat org.elasticsearch.search.aggregations.bucket.nested.NestedAggregator$Factory.createInternal(NestedAggregator.java:168)\r\n2017-02-03 10:35:44.216185500 \tat org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:102)\r\n2017-02-03 10:35:44.216186500 \tat org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:87)\r\n2017-02-03 10:35:44.216194500 \tat org.elasticsearch.search.aggregations.AggregationPhase.preProcess(AggregationPhase.java:85)\r\n2017-02-03 10:35:44.216202500 \tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:111)\r\n2017-02-03 10:35:44.216209500 \tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:366)\r\n2017-02-03 10:35:44.216217500 \tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:378)\r\n2017-02-03 10:35:44.216225500 \tat org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:368)\r\n2017-02-03 10:35:44.216234500 \tat org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:365)\r\n2017-02-03 10:35:44.216236500 \tat org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\r\n2017-02-03 10:35:44.216245500 \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:75)\r\n2017-02-03 10:35:44.216252500 \tat org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\r\n2017-02-03 10:35:44.216254500 \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n2017-02-03 10:35:44.216261500 \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n2017-02-03 10:35:44.216277500 \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n2017-02-03 10:35:44.216279500 \tat java.lang.Thread.run(Thread.java:745)\r\n2017-02-03 10:35:44.216280500 \r\n```\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}