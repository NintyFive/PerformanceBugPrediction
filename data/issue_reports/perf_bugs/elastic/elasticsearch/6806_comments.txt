[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48585726","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-48585726","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":48585726,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTg1NzI2","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-07-10T09:56:44Z","updated_at":"2014-07-10T09:56:44Z","author_association":"MEMBER","body":"I can't reproduce the slowdown that you're reporting. I benchmarked with different types of queries (term, range and geo_distance) between 1.0 and 1.2.2. In fact on 1.2.2 I get a slightly better performance. Can you share a more detailed reproduction of the big performance difference that you're experiencing?\n\nThe indexing slowdown in 1.0.0 was due to [1] and has been resolved in 1.0.2.\n1: https://github.com/elasticsearch/elasticsearch/issues/5339\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48671446","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-48671446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":48671446,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NjcxNDQ2","user":{"login":"quhar","id":4906585,"node_id":"MDQ6VXNlcjQ5MDY1ODU=","avatar_url":"https://avatars2.githubusercontent.com/u/4906585?v=4","gravatar_id":"","url":"https://api.github.com/users/quhar","html_url":"https://github.com/quhar","followers_url":"https://api.github.com/users/quhar/followers","following_url":"https://api.github.com/users/quhar/following{/other_user}","gists_url":"https://api.github.com/users/quhar/gists{/gist_id}","starred_url":"https://api.github.com/users/quhar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quhar/subscriptions","organizations_url":"https://api.github.com/users/quhar/orgs","repos_url":"https://api.github.com/users/quhar/repos","events_url":"https://api.github.com/users/quhar/events{/privacy}","received_events_url":"https://api.github.com/users/quhar/received_events","type":"User","site_admin":false},"created_at":"2014-07-10T22:11:33Z","updated_at":"2014-07-10T22:20:25Z","author_association":"NONE","body":"I've performed additional tests. I've used 1.0.2 (as inserting percolate queries was very slow) and 1.2.2. Difference is much smaller (previously i had difference in nr of queries), but still 1.2.2 is 3 times slower.\n[Test script](https://github.com/quhar/misc_scripts/blob/master/test_es_percolate.py)\nI did two tests, one with 200k queries, second one with 300k. In both cases for test I percolated same document 100 times and computed average. [Here](https://gist.github.com/quhar/40283786d103c4ec0139) are detailed results.\n\nWith 1.0.2 I got average 198 ms per percolate with 200k queries and 312 ms with 300k queries.\nWith 1.2.2 values are 667 and 1008 respectively.\n\nEdit:\nIn both cases it's standard ES from deb without any config or runtime changes.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48736109","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-48736109","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":48736109,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzM2MTA5","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-07-11T14:22:54Z","updated_at":"2014-07-11T14:24:50Z","author_association":"MEMBER","body":"@quhar I can confirm the performance regression:\n\n```\n1.0.3:\nNo handlers could be found for logger \"elasticsearch\"\nIndexed 300000 queries into precolator, took 234.444020987 seconds\nAfter 100 tests, average query time: 288.63\n\n1.2.2:\nNo handlers could be found for logger \"elasticsearch\"\nIndexed 300000 queries into precolator, took 250.046157837 seconds\nAfter 100 tests, average query time: 846.89\n```\n\nThe following change introduced in 1.2.2 is causing this slowdown:\nhttps://github.com/elasticsearch/elasticsearch/pull/6578\n\nOn 1.2.1 there is similar performance as is on 1.0.3:\n\n```\n1.2.1:\nNo handlers could be found for logger \"elasticsearch\"\nIndexed 300000 queries into precolator, took 217.544229984 seconds\nAfter 100 tests, average query time: 270.79\n```\n\nThis change disabled caching for both filter cache and field data at all times in the percolator. In general this is a good improvement, since the caching for an in memory index make no sense. However the disabling of the field data caching has a drawback in that even constructing data structures for the percolator in memory index is relatively expensive, and that is what you're noticing if you percolating across 300k docs with a geo_distance filter that relies on field data.\n\nSo the percolator is creating the same data structure 300k times, which is causing the performance regression. Instead the percolator should **temporarily** cache field data during the execution of a percolator request and that should fix the performance regression.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48854635","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-48854635","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":48854635,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4ODU0NjM1","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-07-13T23:10:06Z","updated_at":"2014-07-13T23:10:06Z","author_association":"MEMBER","body":"The performance regression only occurs if percolator queries contain filters that rely on field data. (e.g. `geo_distance` filter). The best way to get around the field data loading overhead costs is to enable doc values for geo fields.\n\n@quhar If you set `doc_values` to `true` on the `location` field the performance is similar to `1.0.3`:\n\n``` python\nmappings = {\n    'mappings': {\n        TYPE: {\n            'properties': {\n                'name': {\n                    u'type': u'string',\n                },\n                'location': {\n                    u'type': u'geo_point',\n                    u'doc_values': u'true',\n                }\n            }\n        }\n    }\n}\n```\n\nBy enabling doc_values the cost of building field data is done only once instead of 300k times. I think this the best way to get around this performance regression.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48874748","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-48874748","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":48874748,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4ODc0NzQ4","user":{"login":"quhar","id":4906585,"node_id":"MDQ6VXNlcjQ5MDY1ODU=","avatar_url":"https://avatars2.githubusercontent.com/u/4906585?v=4","gravatar_id":"","url":"https://api.github.com/users/quhar","html_url":"https://github.com/quhar","followers_url":"https://api.github.com/users/quhar/followers","following_url":"https://api.github.com/users/quhar/following{/other_user}","gists_url":"https://api.github.com/users/quhar/gists{/gist_id}","starred_url":"https://api.github.com/users/quhar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quhar/subscriptions","organizations_url":"https://api.github.com/users/quhar/orgs","repos_url":"https://api.github.com/users/quhar/repos","events_url":"https://api.github.com/users/quhar/events{/privacy}","received_events_url":"https://api.github.com/users/quhar/received_events","type":"User","site_admin":false},"created_at":"2014-07-14T08:13:17Z","updated_at":"2014-07-14T08:13:17Z","author_association":"NONE","body":"Thanks. I will take a look at `doc_value` then\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/74551372","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-74551372","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":74551372,"node_id":"MDEyOklzc3VlQ29tbWVudDc0NTUxMzcy","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-02-16T18:19:15Z","updated_at":"2015-02-16T23:06:42Z","author_association":"NONE","body":"We found that when we use doc_values, percolator finds about 30% less matches (queries).\nPercolator (against index with doc_values setting on Location property) does not return matches that it clearly should have find (query is searching for keyword that is present in percolated item; percolated item is within location range specified by the query).\n\nExecution time was smaller by about 30% too.\n\nWe do batch percolation.\nWe percolate 50 items per batch.\nIt took:\n28.225s to percolate 50 items without \"doc_values\" option (found 14787 matching queries).\n19.855s to percolate 50 items with \"doc_values\" option (found 10781 matching queries).\n\nWe made this change to our index:\nReplaced:\n\n```\n\"\"Location\"\": {\n    \"\"type\"\": \"\"geo_point\"\"\n}\n```\n\nwith:\n\n```\n\"\"Location\"\": {\n    \"\"type\"\": \"\"geo_point\"\",\n    \"\"doc_values\"\": \"\"true\"\"\n}\n```\n\nNumber of queries to percolate against: 154,195\nVersion: ElasticSearch 1.2.2\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/74576844","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-74576844","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":74576844,"node_id":"MDEyOklzc3VlQ29tbWVudDc0NTc2ODQ0","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-02-16T21:42:33Z","updated_at":"2015-02-16T21:42:33Z","author_association":"MEMBER","body":"@dennisgorelik ouch, does this also occur with a more recent version of ES? (1.3.8 / 1.4.3) If so can you open a new issue for this? and if possible share a smaller reproduction of the bug?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/74586061","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-74586061","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":74586061,"node_id":"MDEyOklzc3VlQ29tbWVudDc0NTg2MDYx","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-02-16T23:02:12Z","updated_at":"2015-02-16T23:10:56Z","author_association":"NONE","body":"Martin,\nWe are going to install and test doc_values effect on ElasticSearch 1.4.3 (probably in a day or two).\nIf we reproduce the same percolation mismatch issue on a smaller set or data we will file a separate issue.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/74619767","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-74619767","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":74619767,"node_id":"MDEyOklzc3VlQ29tbWVudDc0NjE5NzY3","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-02-17T05:42:37Z","updated_at":"2015-02-17T05:42:37Z","author_association":"NONE","body":"Martin,\nWe were able to reproduce that doc_value mismatch.\nI created separate issue for that:\nhttps://github.com/elasticsearch/elasticsearch/issues/9714\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/74620450","html_url":"https://github.com/elastic/elasticsearch/issues/6806#issuecomment-74620450","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6806","id":74620450,"node_id":"MDEyOklzc3VlQ29tbWVudDc0NjIwNDUw","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-02-17T05:53:03Z","updated_at":"2015-02-17T05:53:03Z","author_association":"NONE","body":"We tried performance of the same percolate batch (of 50 items) on ElasticSearch 1.4.3.\nThe performance improved by ~25%\n28.225s on ElasticSearch 1.2.2\n21.270s on ElasticSearch 1.4.3\n\nUsing doc_value=true on ElasticSearch 1.4.3 did not improve performance (but caused percolator to miss ~30% of queries that it should have found - the same issue as in ElasticSearch 1.2.2).\n","performed_via_github_app":null}]