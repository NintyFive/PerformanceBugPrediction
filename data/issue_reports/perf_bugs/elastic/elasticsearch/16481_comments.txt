[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/180464920","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-180464920","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":180464920,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MDQ2NDkyMA==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-02-05T17:45:39Z","updated_at":"2016-02-05T17:45:39Z","author_association":"CONTRIBUTOR","body":"Can you post your mapping? Showing nested type definitions and all.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/180479677","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-180479677","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":180479677,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MDQ3OTY3Nw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-05T18:17:26Z","updated_at":"2016-02-05T18:17:26Z","author_association":"NONE","body":"Of course (I removed non relevant fields):\n\n``` json\n{  \n  \"title\":{  \n    \"type\":\"string\",\n    \"analyzer\":\"french\"\n  },\n  \"stores\":{  \n    \"type\":\"nested\",\n    \"include_in_parent\":true,\n    \"properties\":{  \n      \"id\":{  \n        \"type\":\"string\",\n        \"index\":\"not_analyzed\"\n      },\n      \"location\":{  \n        \"type\":\"geo_point\"\n      }\n    }\n  }\n}\n```\n\nIn my documents `stores` is an array of objects.\nThere are usually 50-200 nested documents per root document.\n\nI didn't use the \"nested\" query in my previous message, because it doesn't change anything to the performance issue.\nBut I still need to use \"nested\" in my case (I have other fields).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181288953","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181288953","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181288953,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTI4ODk1Mw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T10:11:08Z","updated_at":"2016-02-08T10:11:08Z","author_association":"NONE","body":"Even weirder:\n\nI reimplemented the \"geo_distance query\" with a \"script query\":\n\n``` json\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"script\": {\n          \"script\": \"import org.elasticsearch.common.unit.DistanceUnit;\\nimport org.elasticsearch.common.geo.GeoDistance;\\nfor (storeLocation in doc[\\\"stores.location\\\"]) {\\n    distance = GeoDistance.ARC.calculate(location.lat, location.lon, storeLocation.lat, storeLocation.lon, DistanceUnit.METERS);\\n    if (distance <= storeDistanceMax) {\\n        return true;\\n    }\\n}\\nreturn false;\",\n          \"params\": {\n            \"location\": {\n              \"lat\": 49.85,\n              \"lon\": 2.35\n            },\n            \"storeDistanceMax\": 100000\n          }\n        }\n      }\n    }\n  },\n  \"fields\": []\n}\n```\n\nMy search took 200ms! (instead of 3700ms for the \"geo_distance query\")\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181295594","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181295594","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181295594,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTI5NTU5NA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T10:24:31Z","updated_at":"2016-02-08T10:25:53Z","author_association":"NONE","body":"It's getting worse:\n\nI added a \"term query\" before the \"geo_distance query\", to restrict the search to 1 hit:\n\n``` json\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"query\": {\n          \"bool\": {\n            \"must\": [\n              {\n                \"term\": {\n                  \"_id\": \"51a89a7c4eb8dd9e41000025\"\n                }\n              },\n              {\n                \"geo_distance\": {\n                  \"distance\": \"100000m\",\n                  \"stores.location\": {\n                    \"lat\": 48.71,\n                    \"lon\": 2.35\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThere is only 1 document with this id.\nIt takes 500ms.\n(there are 53 sub documents in the \"store\" field)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181303642","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181303642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181303642,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTMwMzY0Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T10:51:07Z","updated_at":"2016-02-08T10:51:07Z","author_association":"CONTRIBUTOR","body":"@pierrre Could you set the `profile` parameter to `true` and upload the response please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181323461","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181323461","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181323461,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTMyMzQ2MQ==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T11:25:41Z","updated_at":"2016-02-08T11:25:41Z","author_association":"NONE","body":"Search:\n\n``` json\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"geo_distance\": {\n          \"distance\": \"100000m\",\n          \"stores.location\": {\n            \"lat\": 49.83,\n            \"lon\": 2.34\n          }\n        }\n      }\n    }\n  },\n  \"fields\": [],\n  \"profile\": true\n}\n```\n\nProfile (I removed the hits):\n\n``` json\n{  \n  \"took\":1880,\n  \"timed_out\":false,\n  \"_shards\":{  \n    \"total\":5,\n    \"successful\":5,\n    \"failed\":0\n  },\n  \"hits\":{  \n    \"total\":4701,\n    \"max_score\":0\n  },\n  \"profile\":{  \n    \"shards\":[  \n      {  \n        \"id\":\"[ST0bPIZTSbOP768od67YHA][test-v5][1]\",\n        \"searches\":[  \n          {  \n            \"query\":[  \n              {  \n                \"query_type\":\"BooleanQuery\",\n                \"lucene\":\"+ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0 #ConstantScore(_type:offer)\",\n                \"time\":\"4961.247043ms\",\n                \"breakdown\":{  \n                  \"score\":74250,\n                  \"create_weight\":285299,\n                  \"next_doc\":461141,\n                  \"match\":0,\n                  \"build_scorer\":1653267115,\n                  \"advance\":0\n                },\n                \"children\":[  \n                  {  \n                    \"query_type\":\"BoostQuery\",\n                    \"lucene\":\"ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0\",\n                    \"time\":\"3305.913181ms\",\n                    \"breakdown\":{  \n                      \"score\":19386,\n                      \"create_weight\":12349,\n                      \"next_doc\":0,\n                      \"match\":0,\n                      \"build_scorer\":1652853718,\n                      \"advance\":123164\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"GeoPointTermQueryConstantScoreWrapper\",\n                        \"lucene\":\"GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952]\",\n                        \"time\":\"1652.904564ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":3376,\n                          \"next_doc\":0,\n                          \"match\":0,\n                          \"build_scorer\":1652844406,\n                          \"advance\":56782\n                        }\n                      }\n                    ]\n                  },\n                  {  \n                    \"query_type\":\"ConstantScoreQuery\",\n                    \"lucene\":\"ConstantScore(_type:offer)\",\n                    \"time\":\"1.246057000ms\",\n                    \"breakdown\":{  \n                      \"score\":0,\n                      \"create_weight\":253447,\n                      \"next_doc\":106307,\n                      \"match\":0,\n                      \"build_scorer\":234222,\n                      \"advance\":99908\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"TermQuery\",\n                        \"lucene\":\"_type:offer\",\n                        \"time\":\"0.5521730000ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":244762,\n                          \"next_doc\":62877,\n                          \"match\":0,\n                          \"build_scorer\":166216,\n                          \"advance\":78318\n                        }\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"rewrite_time\":48665,\n            \"collector\":[  \n              {  \n                \"name\":\"SimpleTopScoreDocCollector\",\n                \"reason\":\"search_top_hits\",\n                \"time\":\"0.1369960000ms\"\n              }\n            ]\n          }\n        ]\n      },\n      {  \n        \"id\":\"[ST0bPIZTSbOP768od67YHA][test-v5][2]\",\n        \"searches\":[  \n          {  \n            \"query\":[  \n              {  \n                \"query_type\":\"BooleanQuery\",\n                \"lucene\":\"+ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0 #ConstantScore(_type:offer)\",\n                \"time\":\"4704.517483ms\",\n                \"breakdown\":{  \n                  \"score\":103082,\n                  \"create_weight\":1672361,\n                  \"next_doc\":599497,\n                  \"match\":0,\n                  \"build_scorer\":1566220273,\n                  \"advance\":0\n                },\n                \"children\":[  \n                  {  \n                    \"query_type\":\"BoostQuery\",\n                    \"lucene\":\"ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0\",\n                    \"time\":\"3131.965622ms\",\n                    \"breakdown\":{  \n                      \"score\":27974,\n                      \"create_weight\":21414,\n                      \"next_doc\":0,\n                      \"match\":0,\n                      \"build_scorer\":1565840240,\n                      \"advance\":164784\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"GeoPointTermQueryConstantScoreWrapper\",\n                        \"lucene\":\"GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952]\",\n                        \"time\":\"1565.911210ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":8763,\n                          \"next_doc\":0,\n                          \"match\":0,\n                          \"build_scorer\":1565832122,\n                          \"advance\":70325\n                        }\n                      }\n                    ]\n                  },\n                  {  \n                    \"query_type\":\"ConstantScoreQuery\",\n                    \"lucene\":\"ConstantScore(_type:offer)\",\n                    \"time\":\"3.956648000ms\",\n                    \"breakdown\":{  \n                      \"score\":0,\n                      \"create_weight\":1627981,\n                      \"next_doc\":131485,\n                      \"match\":0,\n                      \"build_scorer\":183439,\n                      \"advance\":124196\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"TermQuery\",\n                        \"lucene\":\"_type:offer\",\n                        \"time\":\"1.889547000ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":1614342,\n                          \"next_doc\":70688,\n                          \"match\":0,\n                          \"build_scorer\":110984,\n                          \"advance\":93533\n                        }\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"rewrite_time\":64977,\n            \"collector\":[  \n              {  \n                \"name\":\"SimpleTopScoreDocCollector\",\n                \"reason\":\"search_top_hits\",\n                \"time\":\"0.1800850000ms\"\n              }\n            ]\n          }\n        ]\n      },\n      {  \n        \"id\":\"[ST0bPIZTSbOP768od67YHA][test-v5][0]\",\n        \"searches\":[  \n          {  \n            \"query\":[  \n              {  \n                \"query_type\":\"BooleanQuery\",\n                \"lucene\":\"+ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0 #ConstantScore(_type:offer)\",\n                \"time\":\"5089.745722ms\",\n                \"breakdown\":{  \n                  \"score\":90465,\n                  \"create_weight\":358410,\n                  \"next_doc\":621934,\n                  \"match\":0,\n                  \"build_scorer\":1695828128,\n                  \"advance\":0\n                },\n                \"children\":[  \n                  {  \n                    \"query_type\":\"BoostQuery\",\n                    \"lucene\":\"ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0\",\n                    \"time\":\"3391.571303ms\",\n                    \"breakdown\":{  \n                      \"score\":24217,\n                      \"create_weight\":17164,\n                      \"next_doc\":0,\n                      \"match\":0,\n                      \"build_scorer\":1695648631,\n                      \"advance\":159863\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"GeoPointTermQueryConstantScoreWrapper\",\n                        \"lucene\":\"GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952]\",\n                        \"time\":\"1695.721428ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":4688,\n                          \"next_doc\":0,\n                          \"match\":0,\n                          \"build_scorer\":1695642225,\n                          \"advance\":74515\n                        }\n                      }\n                    ]\n                  },\n                  {  \n                    \"query_type\":\"ConstantScoreQuery\",\n                    \"lucene\":\"ConstantScore(_type:offer)\",\n                    \"time\":\"1.275482000ms\",\n                    \"breakdown\":{  \n                      \"score\":0,\n                      \"create_weight\":313628,\n                      \"next_doc\":105851,\n                      \"match\":0,\n                      \"build_scorer\":93796,\n                      \"advance\":195599\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"TermQuery\",\n                        \"lucene\":\"_type:offer\",\n                        \"time\":\"0.5666080000ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":304105,\n                          \"next_doc\":52834,\n                          \"match\":0,\n                          \"build_scorer\":42238,\n                          \"advance\":167431\n                        }\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"rewrite_time\":66164,\n            \"collector\":[  \n              {  \n                \"name\":\"SimpleTopScoreDocCollector\",\n                \"reason\":\"search_top_hits\",\n                \"time\":\"0.1565940000ms\"\n              }\n            ]\n          }\n        ]\n      },\n      {  \n        \"id\":\"[ST0bPIZTSbOP768od67YHA][test-v5][3]\",\n        \"searches\":[  \n          {  \n            \"query\":[  \n              {  \n                \"query_type\":\"BooleanQuery\",\n                \"lucene\":\"+ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0 #ConstantScore(_type:offer)\",\n                \"time\":\"4168.444183ms\",\n                \"breakdown\":{  \n                  \"score\":112480,\n                  \"create_weight\":1390519,\n                  \"next_doc\":651504,\n                  \"match\":0,\n                  \"build_scorer\":1387739181,\n                  \"advance\":0\n                },\n                \"children\":[  \n                  {  \n                    \"query_type\":\"BoostQuery\",\n                    \"lucene\":\"ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0\",\n                    \"time\":\"2775.107749ms\",\n                    \"breakdown\":{  \n                      \"score\":30077,\n                      \"create_weight\":21344,\n                      \"next_doc\":0,\n                      \"match\":0,\n                      \"build_scorer\":1387401154,\n                      \"advance\":178740\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"GeoPointTermQueryConstantScoreWrapper\",\n                        \"lucene\":\"GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952]\",\n                        \"time\":\"1387.476434ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":8741,\n                          \"next_doc\":0,\n                          \"match\":0,\n                          \"build_scorer\":1387392110,\n                          \"advance\":75583\n                        }\n                      }\n                    ]\n                  },\n                  {  \n                    \"query_type\":\"ConstantScoreQuery\",\n                    \"lucene\":\"ConstantScore(_type:offer)\",\n                    \"time\":\"3.442750000ms\",\n                    \"breakdown\":{  \n                      \"score\":0,\n                      \"create_weight\":1345801,\n                      \"next_doc\":142323,\n                      \"match\":0,\n                      \"build_scorer\":180087,\n                      \"advance\":139750\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"TermQuery\",\n                        \"lucene\":\"_type:offer\",\n                        \"time\":\"1.634789000ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":1336059,\n                          \"next_doc\":76175,\n                          \"match\":0,\n                          \"build_scorer\":114883,\n                          \"advance\":107672\n                        }\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"rewrite_time\":43438,\n            \"collector\":[  \n              {  \n                \"name\":\"SimpleTopScoreDocCollector\",\n                \"reason\":\"search_top_hits\",\n                \"time\":\"0.1943090000ms\"\n              }\n            ]\n          }\n        ]\n      },\n      {  \n        \"id\":\"[ST0bPIZTSbOP768od67YHA][test-v5][4]\",\n        \"searches\":[  \n          {  \n            \"query\":[  \n              {  \n                \"query_type\":\"BooleanQuery\",\n                \"lucene\":\"+ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0 #ConstantScore(_type:offer)\",\n                \"time\":\"5621.826671ms\",\n                \"breakdown\":{  \n                  \"score\":105805,\n                  \"create_weight\":230198,\n                  \"next_doc\":612438,\n                  \"match\":0,\n                  \"build_scorer\":1873433238,\n                  \"advance\":0\n                },\n                \"children\":[  \n                  {  \n                    \"query_type\":\"BoostQuery\",\n                    \"lucene\":\"ConstantScore(GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952])^0.0\",\n                    \"time\":\"3746.271286ms\",\n                    \"breakdown\":{  \n                      \"score\":28564,\n                      \"create_weight\":11564,\n                      \"next_doc\":0,\n                      \"match\":0,\n                      \"build_scorer\":1873000894,\n                      \"advance\":170871\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"GeoPointTermQueryConstantScoreWrapper\",\n                        \"lucene\":\"GeoPointDistanceQueryImpl: field=stores.location: Lower Left: [0.9473075707611631,48.93168471588048] Upper Right: [3.7326924292388366,50.72831528411952]\",\n                        \"time\":\"1873.059393ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":3611,\n                          \"next_doc\":0,\n                          \"match\":0,\n                          \"build_scorer\":1872983462,\n                          \"advance\":72320\n                        }\n                      }\n                    ]\n                  },\n                  {  \n                    \"query_type\":\"ConstantScoreQuery\",\n                    \"lucene\":\"ConstantScore(_type:offer)\",\n                    \"time\":\"1.173706000ms\",\n                    \"breakdown\":{  \n                      \"score\":0,\n                      \"create_weight\":199370,\n                      \"next_doc\":137624,\n                      \"match\":0,\n                      \"build_scorer\":234299,\n                      \"advance\":124913\n                    },\n                    \"children\":[  \n                      {  \n                        \"query_type\":\"TermQuery\",\n                        \"lucene\":\"_type:offer\",\n                        \"time\":\"0.4775000000ms\",\n                        \"breakdown\":{  \n                          \"score\":0,\n                          \"create_weight\":188244,\n                          \"next_doc\":75295,\n                          \"match\":0,\n                          \"build_scorer\":120317,\n                          \"advance\":93644\n                        }\n                      }\n                    ]\n                  }\n                ]\n              }\n            ],\n            \"rewrite_time\":44649,\n            \"collector\":[  \n              {  \n                \"name\":\"SimpleTopScoreDocCollector\",\n                \"reason\":\"search_top_hits\",\n                \"time\":\"0.1850390000ms\"\n              }\n            ]\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\nI can't use \"profile\" with Elasticsearch 1.7, but my query is:\n\n``` json\n{\n  \"filter\": {\n    \"geo_distance\": {\n      \"distance\": \"100000m\",\n      \"stores.location\": {\n        \"lat\": 49.83,\n        \"lon\": 2.34\n      }\n    }\n  },\n  \"fields\": []\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181326656","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181326656","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181326656,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTMyNjY1Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T11:30:49Z","updated_at":"2016-02-08T11:30:49Z","author_association":"CONTRIBUTOR","body":"@pierrre thanks. btw - did you reindex your geo-points in 2.2, or reuse geo-points from an earlier index?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181352140","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181352140","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181352140,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTM1MjE0MA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T12:40:45Z","updated_at":"2016-02-08T12:40:45Z","author_association":"NONE","body":"@clintongormley yes, I created a new index (it's a new Elasticsearch instance), and reindexed all my data.\n\nI also observe the same regression with the \"geo_bounding_box\" and \"geo_distance_range\" queries.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181364747","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181364747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181364747,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTM2NDc0Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T13:21:31Z","updated_at":"2016-02-08T13:21:31Z","author_association":"MEMBER","body":"> My model is simple: 20k documents in a type\n\n@pierre is it the total number of documents with a field named `stores.location` ? Do you have other types with the same field name in your index ? What is the total number of documents in this index (20k ?) ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181367609","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181367609","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181367609,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTM2NzYwOQ==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T13:30:40Z","updated_at":"2016-02-08T13:31:29Z","author_association":"NONE","body":"> is it the total number of documents with a field named stores.location ?\n\n@jimferenczi yes, there are 20k root documents with the field `stores.location`.\nThere are between 50-200 documents in each `stores`fields. (sometimes more)\n\n> Do you have other types with the same field name in your index ?\n\nNo, there is only 1 type that uses `stores` & `stores.location`.\nI checked with GET `myindex/_mapping`.\n\n> What is the total number of documents in this index (20k ?) ?\n\nGET `myindex/_count` returns 207322.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181399978","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181399978","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181399978,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTM5OTk3OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T14:39:35Z","updated_at":"2016-02-08T14:39:35Z","author_association":"CONTRIBUTOR","body":"I've tried this out locally, build an index with 1 million random lat/lon points written in 2.1.1 and in a new index in 2.2.0.  Also added in 50 nested docs in each doc, and using the following settings/mappings:\n\n```\nPUT x\n{\n  \"settings\": {\n    \"index.number_of_shards\": 1,\n    \"index.queries.cache.type\": \"none\"\n  },\n  \"mappings\": {\n    \"t\": {\n      \"properties\": {\n        \"loc\": {\n          \"type\": \"geo_point\"\n        },\n        \"nested\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"foo\": {\n              \"type\": \"string\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n(note I've disabled caching so that that doesn't interfere with the measurements)\n\nThen I query it like this:\n\n```\nGET x/t/_search?size=1\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"geo_distance\": {\n          \"distance\": \"10000km\",\n          \"loc\": {\n            \"lat\": 0,\n            \"lon\": 0\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nPerformance for v1 geo-points is pretty much the same whatever the distance (> distance == more matching docs).  V2 varies greatly depending on how many docs match, eg for a distance of \"10000km\" it is about the same as v1, eg 1000ms, for eg \"10km\" this drops to eg 16ms.\n\nSo things seem to be working as expected, with v2 much faster than v1, even with the nested docs.\n\n@pierrre are you running this on eg your laptop?  v1 distance calculations are memory based, so all geopoints get loaded onto your heap.  v2 calculations use the index so it is important to have enough file system cache (and use fast disks) to get best performance.  I wonder if you're running this in an unrealistic environment, eg laptop with little free memory for file system caching?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181409931","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181409931","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181409931,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQwOTkzMQ==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T14:53:22Z","updated_at":"2016-02-08T14:55:17Z","author_association":"NONE","body":"@clintongormley in my mapping, the location field is in nested documents: https://github.com/elastic/elasticsearch/issues/16481#issuecomment-180479677\n\nI'll try to write a script to create the index/add data.\n\n> are you running this on eg your laptop? v1 distance calculations are memory based, so all geopoints get loaded onto your heap. v2 calculations use the index so it is important to have enough file system cache (and use fast disks) to get best performance. I wonder if you're running this in an unrealistic environment, eg laptop with little free memory for file system caching?\n\nYes I run my test on a laptop:\n- Intel(R) Core(TM) i7-3610QM CPU @ 2.30GHz (max 3.3Ghz), 4 cores, 2 threads per core\n- 8GB RAM\n- SSD Samsung 840\n\nI also use the default Elasticsearch config: -Xms256m -Xmx1g\nShould I increase the memory usage?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181412946","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181412946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181412946,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQxMjk0Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T14:57:05Z","updated_at":"2016-02-08T14:57:05Z","author_association":"CONTRIBUTOR","body":"> in my mapping, the location field is in a nested documents\n\nBut you're querying it at the root level, because I don't see a nested query anywhere?\n\n> Should I increase the memory usage?\n\nNo, that's the point.  V2 is in your file system cache, NOT the ES heap, so if you don't have much free space for caching, then it'll need to hit disk all the time.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181414469","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181414469","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181414469,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQxNDQ2OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T14:58:27Z","updated_at":"2016-02-08T14:58:27Z","author_association":"CONTRIBUTOR","body":"> But you're querying it at the root level, because I don't see a nested query anywhere?\n\nOK so the difference here is multiple geopoints per field at the root level, I'll try that.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181415232","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181415232","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181415232,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQxNTIzMg==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T15:00:06Z","updated_at":"2016-02-08T15:00:06Z","author_association":"NONE","body":"> > in my mapping, the location field is in a nested documents\n> \n> But you're querying it at the root level, because I don't see a nested query anywhere?\n\nIn my queries, I need a nested query (there are other fields in my nesteds documents).\nBut I've got a performance issue even if I don't use a nested query.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181427533","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181427533","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181427533,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQyNzUzMw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T15:39:21Z","updated_at":"2016-02-08T15:39:21Z","author_association":"CONTRIBUTOR","body":"OK, with 100,000 docs, each with 50 random geopoints, v1 takes about 2 seconds for me, regardless of how many docs match.  v2 varies dramatically with the number of docs that match, eg if i set the distance to 10km (5 docs) it takes 13ms, for 100km (751 docs) it takes 80ms, for 1000km (54,747 docs) it takes 2,200ms, and for 10000km (88,551 docs) it took 100 seconds!\n\nThe times for v2 with a geo-bounding-box covering most of the earth was better, but still 10-15x slower than v1.  @nknize over to you!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181461774","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181461774","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181461774,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTQ2MTc3NA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T16:49:09Z","updated_at":"2016-02-08T17:01:33Z","author_association":"NONE","body":"Here is a script (Go) to reproduce the issue: https://gist.github.com/pierrre/1b95f47d25d30e03316c\n\nEdit: with Go 1.7, you need to run the `search()` function 5-10 times, then the execution time is low.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181510363","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181510363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181510363,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTUxMDM2Mw==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T18:26:41Z","updated_at":"2016-02-08T18:26:41Z","author_association":"CONTRIBUTOR","body":"Thanks for the reproduction @pierrre. There's an issue with multiple geo-fields in Lucene 5.4.1. I have a fix that will be available in the ES 2.2.1 release.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181555968","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181555968","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181555968,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTU1NTk2OA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-08T20:30:45Z","updated_at":"2016-02-08T20:30:45Z","author_association":"NONE","body":"Lucene issue: https://issues.apache.org/jira/browse/LUCENE-7018\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/181706285","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181706285","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":181706285,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MTcwNjI4NQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-02-09T04:35:26Z","updated_at":"2016-02-09T04:35:26Z","author_association":"CONTRIBUTOR","body":"update: feature branch cut. Bug fix back ported. 5.5 will be cut on Wed. There are a few other relational fixes I'm going to back port to 5.4.2. Will keep this issue updated when 5.4.2 is released. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183440741","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183440741","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183440741,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzQ0MDc0MQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-02-12T18:26:41Z","updated_at":"2016-02-12T18:26:41Z","author_association":"CONTRIBUTOR","body":"@pierrre with the release of 5.5 and 2.3 right around the corner we have decided to forgo fixing this in 2.2.x. This bugfix, along with other encoding optimizations, will be available in the 2.3 release coming real soon.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183445407","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183445407","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183445407,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzQ0NTQwNw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-12T18:42:59Z","updated_at":"2016-02-12T18:42:59Z","author_association":"NONE","body":"OK, thank you.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183491120","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183491120","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183491120,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzQ5MTEyMA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-02-12T21:18:46Z","updated_at":"2016-02-12T21:18:46Z","author_association":"NONE","body":"Any idea of ETA for Elasticsearch 2.3.0? 1 week? 1 month? When it's done? :D\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183492485","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183492485","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183492485,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzQ5MjQ4NQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-02-12T21:22:44Z","updated_at":"2016-02-12T21:22:44Z","author_association":"CONTRIBUTOR","body":"Should be more information coming out at Elasticon. I defer to @clintongormley \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183654880","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183654880","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183654880,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzY1NDg4MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-13T12:02:43Z","updated_at":"2016-02-13T12:02:43Z","author_association":"CONTRIBUTOR","body":"it'll definitely be out before 2.3.1 :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183665448","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-183665448","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":183665448,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzY2NTQ0OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-13T13:33:43Z","updated_at":"2016-02-13T13:33:43Z","author_association":"CONTRIBUTOR","body":"Closed by https://github.com/elastic/elasticsearch/pull/16615\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/195811043","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-195811043","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":195811043,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NTgxMTA0Mw==","user":{"login":"jweber","id":61980,"node_id":"MDQ6VXNlcjYxOTgw","avatar_url":"https://avatars0.githubusercontent.com/u/61980?v=4","gravatar_id":"","url":"https://api.github.com/users/jweber","html_url":"https://github.com/jweber","followers_url":"https://api.github.com/users/jweber/followers","following_url":"https://api.github.com/users/jweber/following{/other_user}","gists_url":"https://api.github.com/users/jweber/gists{/gist_id}","starred_url":"https://api.github.com/users/jweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jweber/subscriptions","organizations_url":"https://api.github.com/users/jweber/orgs","repos_url":"https://api.github.com/users/jweber/repos","events_url":"https://api.github.com/users/jweber/events{/privacy}","received_events_url":"https://api.github.com/users/jweber/received_events","type":"User","site_admin":false},"created_at":"2016-03-12T21:29:36Z","updated_at":"2016-03-12T21:29:36Z","author_association":"NONE","body":"My apologies if this isn't the right place to comment on this, but I wanted to mention that we are seeing similar poor performance with `geo_distance` queries in 2.2.0 but on documents without nested collections of geopoints. I [commented on a post](https://discuss.elastic.co/t/slower-geo-distance-queries-in-2-2/41655/4) in the Elasticsearch forums with this data but I also wanted to add it here to increase visibility.\n\nI also tried [the script based approach](https://github.com/elastic/elasticsearch/issues/16481#issuecomment-181288953) that @pierrre performed and found it to return results faster than the equivalent `geo_distance` but under load started encountering shard errors using it.\n\nHere's the comment I posted on the forums:\n\n---\n\nI've definitely encountered this issue as well and are able to recreate it with test data. The following comparisons were performed against v2.1.2, v2.2.0 and 5.0.0 (built from source).\n\nThe test data is 6 million documents with random locations on the following index (single shard, query cache disabled). I'm running Elasticsearch with the stock configs on my development machine.\n\n```\n{\n  \"test\": {\n    \"mappings\": {\n      \"document\": {\n        \"properties\": {\n          \"id\": {\n            \"type\": \"integer\"\n          },\n          \"location\": {\n            \"type\": \"geo_point\",\n            \"lat_lon\": true\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe `geo_distance` queries look like:\n\n```\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"geo_distance\": {\n          \"distance\": \"100mi\",\n          \"location\": \"[lat], [lon]\"\n        }\n      }\n    }\n  }\n}\n```\n\nHere are the average times when performing the same 100 `geo_distance` searches against the different Elasticsearch versions: \n\n```\nRadius      2.1.2       2.2.0       5.0.0\n1mi         256ms       1ms         2ms\n10mi        206ms       10ms        2ms\n30mi        236ms       36ms        3ms\n50mi        252ms       277ms       40ms\n100mi       258ms       461ms       74ms\n250mi       241ms       2,088ms     315ms\n500mi       227ms       3,534ms     643ms\n1000mi      223ms       943ms       339ms\n2000mi      280ms       754ms       683ms\n```\n\nI was also curious about bounding box performance, so I ran the same queries using a bounding box that circumbscribes the diameter of the `geo_distance` query:\n\n```\n            2.1.2       2.2.0       5.0.0\n1mi         211ms       23ms        9ms\n10mi        217ms       72ms        13ms\n30mi        221ms       60ms        18ms\n50mi        221ms       91ms        23ms\n100mi       220ms       89ms        32ms\n250mi       223ms       130ms       54ms\n500mi       231ms       168ms       81ms\n1000mi      231ms       156ms       96ms\n2000mi      226ms       143ms       100ms\n```\n\nThe slower queries for 2.2.0 and 5.0.0 always have the largest matching count of documents, so queries over areas with lower matching documents perform quickly.\n\nI'm not too sure what to think about the v2.2.0 performance at 250mi and 500mi, but it's definitely not an option for us to run those searches. The next version looks to be an improvement over 2.2.0 but still lags behind 2.1.2 with regards to larger radius searches.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/199558295","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-199558295","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":199558295,"node_id":"MDEyOklzc3VlQ29tbWVudDE5OTU1ODI5NQ==","user":{"login":"cdonnellytx","id":183046,"node_id":"MDQ6VXNlcjE4MzA0Ng==","avatar_url":"https://avatars0.githubusercontent.com/u/183046?v=4","gravatar_id":"","url":"https://api.github.com/users/cdonnellytx","html_url":"https://github.com/cdonnellytx","followers_url":"https://api.github.com/users/cdonnellytx/followers","following_url":"https://api.github.com/users/cdonnellytx/following{/other_user}","gists_url":"https://api.github.com/users/cdonnellytx/gists{/gist_id}","starred_url":"https://api.github.com/users/cdonnellytx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdonnellytx/subscriptions","organizations_url":"https://api.github.com/users/cdonnellytx/orgs","repos_url":"https://api.github.com/users/cdonnellytx/repos","events_url":"https://api.github.com/users/cdonnellytx/events{/privacy}","received_events_url":"https://api.github.com/users/cdonnellytx/received_events","type":"User","site_admin":false},"created_at":"2016-03-22T00:32:09Z","updated_at":"2016-03-22T00:32:09Z","author_association":"NONE","body":"We are also seeing poor performance with documents indexed on 2.2.1 (as opposed to a preexisting index created on 1.7.3 prior to upgrade).\n\nIt looks like this was closed because 2.3.0 was slated to be released sometime in February, but it's been over a month and 2.3.0 hasn't been released, nor can I find any documentation on when it will be released.\n\nIs there a workaround on 2.2 where you can tell Elasticsearch to index using the old format? Or are the only workarounds the script / not upgrading at this time?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/200922590","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-200922590","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":200922590,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMDkyMjU5MA==","user":{"login":"jweber","id":61980,"node_id":"MDQ6VXNlcjYxOTgw","avatar_url":"https://avatars0.githubusercontent.com/u/61980?v=4","gravatar_id":"","url":"https://api.github.com/users/jweber","html_url":"https://github.com/jweber","followers_url":"https://api.github.com/users/jweber/followers","following_url":"https://api.github.com/users/jweber/following{/other_user}","gists_url":"https://api.github.com/users/jweber/gists{/gist_id}","starred_url":"https://api.github.com/users/jweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jweber/subscriptions","organizations_url":"https://api.github.com/users/jweber/orgs","repos_url":"https://api.github.com/users/jweber/repos","events_url":"https://api.github.com/users/jweber/events{/privacy}","received_events_url":"https://api.github.com/users/jweber/received_events","type":"User","site_admin":false},"created_at":"2016-03-24T16:54:37Z","updated_at":"2016-03-24T16:54:37Z","author_association":"NONE","body":"We've not been able to find an adequate workaround for this issue on 2.2.0. The script option, while performing better than using geo_distance queries, still does not give acceptable performance. I ran the same performance tests against the current 2.3.0 branch and it looks like that will in fact resolve this issue. It would be nice to have an updated estimate on when 2.3.0 will be released as 2.2.x does not perform well enough in these scenarios for us to use.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/203158565","html_url":"https://github.com/elastic/elasticsearch/issues/16481#issuecomment-203158565","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16481","id":203158565,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMzE1ODU2NQ==","user":{"login":"tmatei","id":471751,"node_id":"MDQ6VXNlcjQ3MTc1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/471751?v=4","gravatar_id":"","url":"https://api.github.com/users/tmatei","html_url":"https://github.com/tmatei","followers_url":"https://api.github.com/users/tmatei/followers","following_url":"https://api.github.com/users/tmatei/following{/other_user}","gists_url":"https://api.github.com/users/tmatei/gists{/gist_id}","starred_url":"https://api.github.com/users/tmatei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tmatei/subscriptions","organizations_url":"https://api.github.com/users/tmatei/orgs","repos_url":"https://api.github.com/users/tmatei/repos","events_url":"https://api.github.com/users/tmatei/events{/privacy}","received_events_url":"https://api.github.com/users/tmatei/received_events","type":"User","site_admin":false},"created_at":"2016-03-29T23:34:38Z","updated_at":"2016-03-29T23:34:38Z","author_association":"NONE","body":"I've encountered the same issue and I'm running 2.2.1\n","performed_via_github_app":null}]