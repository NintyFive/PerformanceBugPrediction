[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/117103033","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-117103033","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":117103033,"node_id":"MDEyOklzc3VlQ29tbWVudDExNzEwMzAzMw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-06-30T09:53:26Z","updated_at":"2015-06-30T09:53:26Z","author_association":"CONTRIBUTOR","body":"I don't know what is causing your timeouts, but the slowlog does record slow events, eg (you need to pass `--script.inline on` on the command line for this to work):\n\n```\nDELETE t\n\nPUT t\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold.query.warn\": \"1s\"\n  }\n}\n\nPUT t/t/1\n{}\n\nGET _search\n{\n  \"script_fields\": {\n    \"FIELD\": {\n      \"script\": \"sleep(3000); return 'foo'\"\n    }\n  }\n}\n```\n\nThe above request will show up every time you run it, as will this one:\n\n```\nGET _search\n{\n  \"aggs\": {\n    \"foo\": {\n      \"terms\": {\n        \"script\": \"sleep(3000); return 'foo'\"  \n      }\n    }\n  }\n}\n```\n\nAnd why are your queries taking 100s?  Are you requesting 10M docs? Something else is going on.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/118721560","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-118721560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":118721560,"node_id":"MDEyOklzc3VlQ29tbWVudDExODcyMTU2MA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-06T05:11:57Z","updated_at":"2015-07-06T05:11:57Z","author_association":"NONE","body":"Here's some side story that would probably involve into separate \"ElasticSearch memory leaks\" issue when we have more data:\n7 days ago (June 29 2015) we moved our ElasticSearch database into Linux (CentOs 7) on 32GB machine dedicated to ElasticSearch.\n\nInitially we got no timeouts, but after 5 days without ElasticSearch reboot we started to get timeouts.\nIt looks like number of timeouts grows ~exponentially with times since last reboot:\n\n```\nDays 1 ... 5: 0 (no) timeouts.\nDay 6: 3 timeouts.\nDay 7: 5 timeouts.\n```\n\nThat pattern of growing number timeouts is the same as when we were running ElasticSearch on Windows box with 2 times less memory allocated to ElasticSearch (16GB in Windows vs 32GB on Linux).\nWindows machine produced more timeout errors, but also clearly showed the trend of increasing number of crashes with time since last reboot.\n\nAnswering your question about query size:\nNone of these failing queries that we run on that ElasticSearch server exceed few kilobytes.\nNormally they should execute in well below 1s (e.g. ~50ms).\nBut several times per day these queries time out at 100s (see above).\nTo put things in perspective, on our ElasticSearch server we are running about 200,000 ElasticSearch queries per day.\n\nIn the next comment I'm going to add some details about the key issue here: slowlog is not recording timeouts.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/118731935","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-118731935","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":118731935,"node_id":"MDEyOklzc3VlQ29tbWVudDExODczMTkzNQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-06T05:46:50Z","updated_at":"2015-07-06T05:46:50Z","author_association":"NONE","body":"@clintongormley\n\nNow about slowlog not recording timeouts.\n1) In my previous comment I described that we got 8 timeout errors on our new Linux ElasticSearch 1.6.0 box (3 timeouts on day 6 and 5 timeouts on day 7).\n\n2) Slowlog recorded only 3 timeouts out of 8 (1 timeouts on day 6 and 2 timeouts on day 7).\nSlowlog also recorded some other long-running queries which did not result in timeouts.\n\n3) On our new Linux box we have the same slowlog settings that I already described in the main post here: from 1s (fetch) to 10s(query).\n\n4) We ran your suggested query with artificial delay in fetch (\"script_fields-FIELD-script\").\nOur slowlog recorded that slow query (as it should because our slowlog fetch trigger is set to 1s).\n\n5) We tried to run up to 10 queries with artificial delay in parallel (10 async calls from our client).\nSlowlog recorded all of them.\n\n6) We tried to run up to 10 queries in parallel and set artificial delay to 105000ms, so we got 10 parallel timeouts.\nSlowlog recorded all of them.\n\nMy only guess so far is that slowlog misses timeouts that happen due to poor query execution (as opposing to fetch).\nBut I do not know how to reliably reproduce poor ElasticSearch query execution (when slowlog fails).\n\nAny idea how to make queries that ran slow once (as an exception due to poor ElasticSearch server performance) - ran slow consistently?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/119082625","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-119082625","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":119082625,"node_id":"MDEyOklzc3VlQ29tbWVudDExOTA4MjYyNQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-07T06:07:22Z","updated_at":"2015-07-07T06:07:22Z","author_association":"NONE","body":"As expected, today (2015-07-06) as we got more ElasticSearch timeouts than yesterday.\nNumber of ElasticSearch slowlog records: 22.\nNumber of timeouts recorded by our client code: 34.\nNumber of timeouts recorded by ElasticSearch slowlog: 1 (out of 22).\nSo pretty much all timeouts went unrecorded by slowlog.\n\nAbout 2 minutes after getting timeouts we turned on BigDesk monitoring on ElasticSearch.\nBigDesk did NOT show any lack of resources (Heap Mem ~6Gb, CPU used less than 20%, Search requests per second less than 100).\n\nWe are going to reboot our ElasticSearch server and see what would happen (probably no timeouts for about 5 days since reboot).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/121583581","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-121583581","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":121583581,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMTU4MzU4MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-15T11:06:54Z","updated_at":"2015-07-15T11:06:54Z","author_association":"CONTRIBUTOR","body":"These two lines make me think you're hiding problems:\n\n```\nmonitor.jvm.gc.young.warn: 1000ms\nmonitor.jvm.gc.old.warn: 10s\n```\n\nThose are very slow times for GC.  I'd undset those lines and look for slow GC messages in your logs.  Also check `GET _nodes/process` to see if mlockall is actually being set properly or not.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/121692466","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-121692466","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":121692466,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMTY5MjQ2Ng==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-15T17:53:01Z","updated_at":"2015-07-15T17:53:01Z","author_association":"NONE","body":"What does \"undset\" mean?\nAre you suggesting to reduce slowlog warning threshholds?\nWhat  values do you suggest?\n\nNote that we do get slowlog records occasionally. They just do not match with our timeouts.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/121831373","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-121831373","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":121831373,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMTgzMTM3Mw==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-16T05:13:19Z","updated_at":"2015-07-16T05:15:57Z","author_association":"NONE","body":"I just checked: mlockall is set to true.\n\n```\nGET _nodes/process\n```\n\n```\n{\n   \"cluster_name\": \"ccccccccc\",\n   \"nodes\": {\n      \"pNrRIW49SEanDr-0289lAQ\": {\n         \"name\": \"Node1\",\n         \"transport_address\": \"inet[/xxx.xxx.xxx.xxx:9300]\",\n         \"host\": \"hhhhhhh\",\n         \"ip\": \"xxx.xxx.xxx.xxx\",\n         \"version\": \"1.6.0\",\n         \"build\": \"cdd3ac4\",\n         \"http_address\": \"inet[/xxx.xxx.xxx.xxx:9200]\",\n         \"attributes\": {\n            \"master\": \"true\"\n         },\n         \"process\": {\n            \"refresh_interval_in_millis\": 1000,\n            \"id\": 8156,\n            \"max_file_descriptors\": 65535,\n            \"mlockall\": true\n         }\n      }\n   }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122274869","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122274869","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122274869,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjI3NDg2OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-17T13:29:05Z","updated_at":"2015-07-17T13:29:05Z","author_association":"CONTRIBUTOR","body":"\"undset\" means \"unset\" :)  ie remove those lines and go back to the defaults. Let's see what shows up in your logs\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122489444","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122489444","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122489444,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjQ4OTQ0NA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-18T06:11:42Z","updated_at":"2015-07-18T06:11:42Z","author_association":"NONE","body":"We commented out slowlog GC settings.\nHere are log results we are getting (PjfSearch.log.2015-07-17)\n\n```\n[2015-07-17 13:40:08,119][INFO ][monitor.jvm              ] [Node1] [gc][young][18149][1529] duration [769ms], collections [1]/[1.3s], total [769ms]/[4.3m], memory [6.7gb]->[5.7gb]/[15.8gb], all_pools {[young] [1gb]->[655.9kb]/[1.1gb]}{[survivor] [54.2mb]->[55mb]/[149.7mb]}{[old] [5.6gb]->[5.6gb]/[14.5gb]}\n[2015-07-17 14:30:17,403][WARN ][monitor.jvm              ] [Node1] [gc][young][21149][1746] duration [1.2s], collections [1]/[1.7s], total [1.2s]/[5m], memory [8.1gb]->[7.1gb]/[15.8gb], all_pools {[young] [1gb]->[595.5kb]/[1.1gb]}{[survivor] [53mb]->[61.6mb]/[149.7mb]}{[old] [7gb]->[7gb]/[14.5gb]}\n[2015-07-17 14:30:40,864][WARN ][monitor.jvm              ] [Node1] [gc][young][21171][1749] duration [1.3s], collections [1]/[2.3s], total [1.3s]/[5m], memory [8gb]->[7.1gb]/[15.8gb], all_pools {[young] [980.1mb]->[642.7kb]/[1.1gb]}{[survivor] [60.9mb]->[60.8mb]/[149.7mb]}{[old] [7gb]->[7gb]/[14.5gb]}\n[2015-07-17 14:35:01,755][INFO ][monitor.jvm              ] [Node1] [gc][young][21431][1770] duration [836ms], collections [1]/[1s], total [836ms]/[5.1m], memory [8.3gb]->[7.2gb]/[15.8gb], all_pools {[young] [1.1gb]->[5.9mb]/[1.1gb]}{[survivor] [60mb]->[58.2mb]/[149.7mb]}{[old] [7.1gb]->[7.1gb]/[14.5gb]}\n[2015-07-17 14:46:04,340][INFO ][monitor.jvm              ] [Node1] [gc][young][22090][1828] duration [793ms], collections [1]/[1s], total [793ms]/[5.4m], memory [8.7gb]->[7.6gb]/[15.8gb], all_pools {[young] [1.1gb]->[59.5mb]/[1.1gb]}{[survivor] [67mb]->[74.5mb]/[149.7mb]}{[old] [7.5gb]->[7.5gb]/[14.5gb]}\n[2015-07-17 14:46:14,349][INFO ][monitor.jvm              ] [Node1] [gc][young][22100][1829] duration [738ms], collections [1]/[1s], total [738ms]/[5.4m], memory [8.7gb]->[7.6gb]/[15.8gb], all_pools {[young] [1.1gb]->[15.2mb]/[1.1gb]}{[survivor] [74.5mb]->[70.9mb]/[149.7mb]}{[old] [7.5gb]->[7.5gb]/[14.5gb]}\n[2015-07-17 16:38:25,231][WARN ][monitor.jvm              ] [Node1] [gc][young][28784][2438] duration [1s], collections [1]/[1s], total [1s]/[8.6m], memory [6.9gb]->[5.7gb]/[15.8gb], all_pools {[young] [1.1gb]->[608.2kb]/[1.1gb]}{[survivor] [68.9mb]->[66.2mb]/[149.7mb]}{[old] [5.6gb]->[5.6gb]/[14.5gb]}\n[2015-07-17 16:39:16,276][INFO ][monitor.jvm              ] [Node1] [gc][young][28835][2441] duration [950ms], collections [1]/[1s], total [950ms]/[8.6m], memory [6.9gb]->[5.7gb]/[15.8gb], all_pools {[young] [1.1gb]->[4.8mb]/[1.1gb]}{[survivor] [67.5mb]->[65.7mb]/[149.7mb]}{[old] [5.6gb]->[5.7gb]/[14.5gb]}\n[2015-07-17 17:37:57,460][WARN ][monitor.jvm              ] [Node1] [gc][young][32344][2759] duration [1s], collections [1]/[1.6s], total [1s]/[9.6m], memory [8.7gb]->[7.6gb]/[15.8gb], all_pools {[young] [1gb]->[1.1mb]/[1.1gb]}{[survivor] [48.7mb]->[49.6mb]/[149.7mb]}{[old] [7.5gb]->[7.5gb]/[14.5gb]}\n[2015-07-17 17:43:03,431][INFO ][monitor.jvm              ] [Node1] [gc][young][32649][2787] duration [742ms], collections [1]/[1s], total [742ms]/[9.7m], memory [8.9gb]->[7.8gb]/[15.8gb], all_pools {[young] [1.1gb]->[188.7kb]/[1.1gb]}{[survivor] [63.4mb]->[59.6mb]/[149.7mb]}{[old] [7.7gb]->[7.7gb]/[14.5gb]}\n[2015-07-17 17:44:13,429][INFO ][monitor.jvm              ] [Node1] [gc][young][32718][2793] duration [878ms], collections [1]/[1.5s], total [878ms]/[9.8m], memory [8.8gb]->[7.8gb]/[15.8gb], all_pools {[young] [1gb]->[1.9mb]/[1.1gb]}{[survivor] [64.5mb]->[66.7mb]/[149.7mb]}{[old] [7.7gb]->[7.7gb]/[14.5gb]}\n[2015-07-17 18:33:36,104][WARN ][monitor.jvm              ] [Node1] [gc][young][35667][3047] duration [2.2s], collections [1]/[3.1s], total [2.2s]/[10.8m], memory [10.3gb]->[9.3gb]/[15.8gb], all_pools {[young] [1021.1mb]->[1mb]/[1.1gb]}{[survivor] [58.7mb]->[64.4mb]/[149.7mb]}{[old] [9.3gb]->[9.3gb]/[14.5gb]}\n[2015-07-17 18:35:17,368][WARN ][monitor.jvm              ] [Node1] [gc][young][35766][3054] duration [2.1s], collections [1]/[2.9s], total [2.1s]/[10.9m], memory [10.4gb]->[9.4gb]/[15.8gb], all_pools {[young] [1gb]->[599.7kb]/[1.1gb]}{[survivor] [62.2mb]->[64.4mb]/[149.7mb]}{[old] [9.3gb]->[9.3gb]/[14.5gb]}\n[2015-07-17 19:34:45,083][INFO ][monitor.jvm              ] [Node1] [gc][young][39305][3324] duration [759ms], collections [1]/[1.5s], total [759ms]/[12.1m], memory [6.9gb]->[5.8gb]/[15.8gb], all_pools {[young] [1.1gb]->[4.6mb]/[1.1gb]}{[survivor] [54.2mb]->[57.4mb]/[149.7mb]}{[old] [5.7gb]->[5.7gb]/[14.5gb]}\n[2015-07-17 20:22:23,246][WARN ][monitor.jvm              ] [Node1] [gc][young][42154][3508] duration [2.1s], collections [1]/[2.7s], total [2.1s]/[12.7m], memory [7.9gb]->[6.9gb]/[15.8gb], all_pools {[young] [1gb]->[5mb]/[1.1gb]}{[survivor] [64.8mb]->[67.6mb]/[149.7mb]}{[old] [6.8gb]->[6.9gb]/[14.5gb]}\n[2015-07-17 20:24:38,625][WARN ][monitor.jvm              ] [Node1] [gc][young][42288][3520] duration [1.7s], collections [1]/[2s], total [1.7s]/[12.8m], memory [8.1gb]->[7gb]/[15.8gb], all_pools {[young] [1.1gb]->[799kb]/[1.1gb]}{[survivor] [62.5mb]->[62.4mb]/[149.7mb]}{[old] [6.9gb]->[6.9gb]/[14.5gb]}\n[2015-07-17 20:51:55,654][WARN ][monitor.jvm              ] [Node1] [gc][young][43918][3664] duration [1.4s], collections [1]/[1.9s], total [1.4s]/[13.3m], memory [8.8gb]->[7.8gb]/[15.8gb], all_pools {[young] [1gb]->[678.2kb]/[1.1gb]}{[survivor] [62.7mb]->[55.6mb]/[149.7mb]}{[old] [7.8gb]->[7.8gb]/[14.5gb]}\n[2015-07-17 20:57:28,428][WARN ][monitor.jvm              ] [Node1] [gc][young][44249][3692] duration [1s], collections [1]/[1.6s], total [1s]/[13.4m], memory [9.1gb]->[8gb]/[15.8gb], all_pools {[young] [1.1gb]->[741.4kb]/[1.1gb]}{[survivor] [55.9mb]->[55mb]/[149.7mb]}{[old] [7.9gb]->[7.9gb]/[14.5gb]}\n[2015-07-17 21:00:04,808][WARN ][monitor.jvm              ] [Node1] [gc][young][44404][3710] duration [1.2s], collections [1]/[1.4s], total [1.2s]/[13.5m], memory [9.2gb]->[8.1gb]/[15.8gb], all_pools {[young] [1.1gb]->[682.4kb]/[1.1gb]}{[survivor] [58.7mb]->[54.4mb]/[149.7mb]}{[old] [8gb]->[8gb]/[14.5gb]}\n[2015-07-17 21:04:16,142][WARN ][monitor.jvm              ] [Node1] [gc][young][44654][3715] duration [1s], collections [1]/[1.4s], total [1s]/[13.5m], memory [9.2gb]->[8.1gb]/[15.8gb], all_pools {[young] [1gb]->[830.2kb]/[1.1gb]}{[survivor] [64.6mb]->[62.6mb]/[149.7mb]}{[old] [8.1gb]->[8.1gb]/[14.5gb]}\n[2015-07-17 21:12:49,400][WARN ][monitor.jvm              ] [Node1] [gc][young][45164][3761] duration [1.2s], collections [1]/[2s], total [1.2s]/[13.7m], memory [9.5gb]->[8.4gb]/[15.8gb], all_pools {[young] [1gb]->[2mb]/[1.1gb]}{[survivor] [66mb]->[64.7mb]/[149.7mb]}{[old] [8.3gb]->[8.4gb]/[14.5gb]}\n[2015-07-17 23:40:27,883][INFO ][monitor.jvm              ] [Node1] [gc][young][53981][4480] duration [802ms], collections [1]/[1.5s], total [802ms]/[16.7m], memory [8.9gb]->[7.9gb]/[15.8gb], all_pools {[young] [1gb]->[817.4kb]/[1.1gb]}{[survivor] [59.6mb]->[63.9mb]/[149.7mb]}{[old] [7.8gb]->[7.8gb]/[14.5gb]}\n[2015-07-17 23:41:18,012][WARN ][monitor.jvm              ] [Node1] [gc][young][54030][4485] duration [1s], collections [1]/[2s], total [1s]/[16.7m], memory [8.9gb]->[7.9gb]/[15.8gb], all_pools {[young] [1gb]->[4.3mb]/[1.1gb]}{[survivor] [65.1mb]->[64.5mb]/[149.7mb]}{[old] [7.8gb]->[7.8gb]/[14.5gb]}\n```\n\nNote that we already saw similar log entries (including sub-second entries) even before we commented out 1s threshold in slowlog GC settings.\n\nWe also do NOT experience timeouts now, because ElasticSearch service runs for less than 5 days (so timeout issues did not start yet).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122649907","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122649907","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122649907,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjY0OTkwNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-19T11:14:52Z","updated_at":"2015-07-19T11:14:52Z","author_association":"CONTRIBUTOR","body":"So, as I suspected, you have very long GCs.  GC time may not counted as part of query execution time as it can happen in between phases, hence the missing slowlog entries.\n\nWhat is curious is that GC is slow even though you half your heap is empty.  This leads me back to wondering about whether `mlockall` is actually working, which leads me to questions about your environment:\n- what JVM are you using?\n- are you setting any JVM flags?\n- what OS are you using?\n- are you running on bare metal, or are you using containers or VMs?\n- what CPUs do you have?\n- can you provide a [diagnostics dump](https://github.com/elastic/elasticsearch-support-diagnostics)\n- does the problem disappear if you disable swap completely?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122649920","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122649920","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122649920,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjY0OTkyMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-19T11:15:14Z","updated_at":"2015-07-19T11:15:14Z","author_association":"CONTRIBUTOR","body":"Also, what indexing and search requests are you running?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122736262","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122736262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122736262,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjczNjI2Mg==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-20T02:45:10Z","updated_at":"2015-07-20T02:45:10Z","author_association":"NONE","body":"@clintongormley\n\n> it can happen in between phases, hence the missing slowlog entries\n\nAre you saying that if we have sequence of:\n- Query time 100ms\n- Garbage collector 200s (which means timeout for us).\n- Fetch time 100ms.\n  Then slowlog will NOT record anything?\n  Is it designed behavior?\n\nDoes not look right to me. No matter the phase, all slow times must be recorded, otherwise slowlog has very limited use.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122736704","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122736704","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122736704,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjczNjcwNA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-20T02:54:08Z","updated_at":"2015-07-20T02:54:08Z","author_association":"NONE","body":"> what JVM are you using?\n\nFrom bigdesk info:\n\n```\nJVM\n\nVM name: Java HotSpot(TM) 64-Bit Server VM\nVM vendor: Oracle Corporation\nVM version: 25.45-b02\n\nUptime: 2.5d\nJava version: 1.8.0_45\nPID: 15693\n```\n\n> are you setting any JVM flags?\n\nOnly these:\n\n```\nES_JAVA_OPTS='-Djna.tmpdir=/es_tmp'\n```\n\n> what OS are you using?\n\nCentOS 7\n\n> are you running on bare metal, or are you using containers or VMs?\n\nBare metal.\n\n> what CPUs do you have?\n\n```\nOS\n\nCPU vendor: Intel\nCPU model: Xeon (2600 MHz)\nCPU total logical cores: 24\nCPU cache: 15kb\n\nUptime: 29.4m\nRefresh interval: 1sms\nTotal mem: 31.2gb (33531912192 b)\nTotal swap: 1023.9mb (1073737728 b)\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122739889","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122739889","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122739889,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjczOTg4OQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-20T03:03:14Z","updated_at":"2015-07-20T03:03:14Z","author_association":"NONE","body":"> what indexing and search requests are you running?\n\nI'm not sure what you're asking here.\nWould that bigdesk data help?\n\n```\nIndices\n\nDocs count: 2361020\nDocs deleted: 429086\n\nFlush: 1197, 19s\nRefresh: 18256, 10.4m\n\nSize: 10.1gb\n```\n\nMost of indexed documents are jobs (~1KB in size on average).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122740656","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122740656","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122740656,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjc0MDY1Ng==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-20T03:04:28Z","updated_at":"2015-07-20T03:04:28Z","author_association":"NONE","body":"We'll try to disable Linux swap, but bigdesk reports only ~1GB swap.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/122843016","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-122843016","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":122843016,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMjg0MzAxNg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-20T10:34:04Z","updated_at":"2015-07-20T10:34:04Z","author_association":"CONTRIBUTOR","body":"> what indexing and search requests are you running?\n\nI just mean real examples of the types of queries and indexing request you're running. If you're using bulk indexing, how many docs do you send in one request?  with search, are you doing deep paging (eg `from:10000` or `size:10000`)\n\n> We'll try to disable Linux swap, but bigdesk reports only ~1GB swap.\n\nIf any of the heap lands up in swap it can have a huge effect on GC, which is why I suggest disabling it to see.\n\nThe [diagnostic dump](https://github.com/elastic/elasticsearch-support-diagnostics) would also be very useful.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/123193670","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-123193670","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":123193670,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMzE5MzY3MA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-21T07:06:26Z","updated_at":"2015-07-21T07:06:26Z","author_association":"NONE","body":"See below typical ES queries that we run:\n1) The most frequently run query runs about 150,000 times per day.\nThe query is a batch with 2 \"function_score\" queries\n\n```\n{}\n{   \"fields\": [],   \"size\": 7,  \"query\": {      \"function_score\": {         \"functions\": [          {               \"script_score\": {                   \"script\": \"pow(0.99, (1437445335545.0 - doc['PostedDate'].value)/86400000)\"             }           },          {               \"field_value_factor\": {                 \"field\": \"PenaltyFactor\",                   \"factor\": 1.0}          },          {               \"weight\": 0.015625          }],         \"query\" : {\"filtered\" : {       \"query\" : {         \"query_string\" : {      \"fields\" : [\"JobTitle\",\"JobDescription\",\"CompanyName\",\"Salary\"],        \"query\" : \"MARKETING^1 OR STRATEGY^0.612 OR ACCESS^0.552 OR SALES^0.382 OR IT^0.348\",       \"analyzer\" : \"pjfqueryanalyzer\"}        },\"filter\" : {\"bool\" : {\"must\" : [{\"query\":{    \"term\" : {      \"Country\": \"US\" }}}],\"must_not\" : [{ \"term\" : {\"JobId\" : 150107695}}]}}}},          \"score_mode\": \"multiply\",           \"boost_mode\": \"multiply\"        }   }}\n{}\n{   \"fields\": [],   \"size\": 200,    \"query\": {      \"function_score\": {         \"functions\": [                      {               \"field_value_factor\": {                 \"field\": \"PenaltyFactor\",                   \"factor\": 1.0}          },          {               \"weight\": 0.015625          }],         \"query\" : {\"filtered\" : {       \"query\" : {         \"query_string\" : {      \"fields\" : [\"JobTitle\",\"JobDescription\",\"CompanyName\",\"Salary\"],        \"query\" : \"MARKETING^1 OR STRATEGY^0.612 OR ACCESS^0.552 OR SALES^0.382 OR IT^0.348\",       \"analyzer\" : \"pjfqueryanalyzer\"}        },\"filter\" : {\"bool\" : {\"must\" : [{\"query\":{    \"term\" : {      \"Country\": \"US\" }}}],\"must_not\" : [{ \"term\" : {\"JobId\" : 150107695}}]}}}},          \"score_mode\": \"multiply\",           \"boost_mode\": \"multiply\"        }   }}\n```\n\n2) Simple search queries -- about 40,000 per day.\n\n```\n{\"fields\" : [\"JobId\"],\n\"sort\" : [\n        {\"PostedDate\" : {\"order\" : \"desc\"}}\n],\n\"from\" : 0, \"size\" : 10,\n\"query\" : {\n\"filtered\" : {\n        \"query\" : {\n            \"query_string\" : {\n        \"fields\" : [\"JobTitle\",\"JobDescription\",\"CompanyName\",\"Salary\"],\n        \"query\" : \"TEST\",\n        \"analyzer\" : \"pjfqueryanalyzer\"\n}\n        },\n\"filter\" : {\n\"match_all\" : {}\n}\n}\n}\n}\n```\n\n3)  Bulk insert: up to 10000 docs per batch.\nOverall it inserts about 150,000 documents per day.\n\n4) We have other queries, but they are less frequent and are similar to the queries above.\n\n> are you doing deep paging\n\nNo.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/123197822","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-123197822","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":123197822,"node_id":"MDEyOklzc3VlQ29tbWVudDEyMzE5NzgyMg==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-21T07:25:59Z","updated_at":"2015-07-21T07:25:59Z","author_association":"NONE","body":"We ran another experiment yesterday:\nAdded percolator queries to our dedicated ElasticSearch server.\n\nPrior to yesterday we were running percolator queries on a separate Virtual Machine (2GB RAM, 4 virtual CPU cores, CentOS 7).\nPercolation performance on VM was pretty robust.\nCPU at heavy load was around 90%, but 4 percolation queues were running at a good pace (about 1 percolation per second per queue).\nAfter we moved percolator to dedicated ElasticSearch server, percolation queries became about 40% slower.\nBut what was worse, our most frequently running \"function_score\" queries (see #1 in my previous comment) became about 100 times slower (execution time increased from about 200ms to about 20s).\nMeanwhile CPU utilization was never above 60% and there was lots of available RAM (the total RAM on our dedicated box is 32GB).\nSomehow ElasticSearch on dedicated server was not able to use available hardware resources, even though we have \"standalone\" job percolator index that is not used for regular ES queries.\n\nCould it relate to slowlog issue?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124034069","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124034069","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124034069,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDAzNDA2OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-23T09:36:22Z","updated_at":"2015-07-23T09:36:22Z","author_association":"CONTRIBUTOR","body":"All of this seems to be tied to the slow GC.  Usually you see logs of slow old generation GC.  Slow young gen GC seems to be related to kernel bugs, CPU bugs or VM bugs.  May be worth comparing the setup of your external percolator machine and this dedicated cluster, and try finding the differences, eg kernel, JVM version, CPU etc.\n\nAlso, I'm still waiting for two things:\n- the effect of disabling swap\n- the diagnostic dump\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124202420","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124202420","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124202420,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDIwMjQyMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-23T18:34:43Z","updated_at":"2015-07-23T18:34:43Z","author_association":"CONTRIBUTOR","body":"A colleague gave me an idea: Centos has transparent hugepages enabled by default.  This can interfere with memory handling.\n\nTry disabling them and see if it improves things.  See https://www.centos.org/forums/viewtopic.php?f=47&t=49428\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124293194","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124293194","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124293194,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDI5MzE5NA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-24T02:12:23Z","updated_at":"2015-07-24T02:12:23Z","author_association":"NONE","body":"> the effect of disabling swap\n\nIt's been 4th day since last reboot (we had to reboot because disabling swap requires it).\nWe have much lower number of Garbage Collector records now.\n\n```\n[2015-07-20 12:33:25,312][INFO ][monitor.jvm              ] [Node1] [gc][young][42980][86773] duration [850ms], collections [1]/[1s], total [850ms]/[1.3h], memory [8.7gb]->[7.6gb]/[15.8gb], all_pools {[young] [1.1gb]->[643.1kb]/[1.1gb]}{[survivor] [55.7mb]->[58.1mb]/[149.7mb]}{[old] [7.6gb]->[7.6gb]/[14.5gb]}\n[2015-07-20 12:34:07,670][INFO ][monitor.jvm              ] [Node1] [gc][young][43022][86781] duration [799ms], collections [1]/[1.1s], total [799ms]/[1.3h], memory [8.7gb]->[7.7gb]/[15.8gb], all_pools {[young] [1gb]->[597.7kb]/[1.1gb]}{[survivor] [56.8mb]->[56.2mb]/[149.7mb]}{[old] [7.6gb]->[7.6gb]/[14.5gb]}\n```\n\nWe do not have any timeouts yet in our client app (but historically timeouts started from day 5 since reboot).\n\nWe still have some slowlog records (about 10 day), but that number is much lower now than it was before and it does NOT grow with the \"number of days since last reboot\".\nSlowlog records duration stays low (e.g. \"took[19.2s]\") and does not grow into 60+ seconds range.\n\nSo ElasticSearch performance looks good so far.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124294903","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124294903","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124294903,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDI5NDkwMw==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-24T02:28:10Z","updated_at":"2015-07-24T02:28:10Z","author_association":"NONE","body":"> comparing the setup of your external percolator machine and this dedicated cluster, and try finding the differences, eg kernel, JVM version, CPU etc.\n\nI can think of only these differences:\n1) VM vs dedicated.\n2) Different version of ElasticSearch:\nVM: v. 1.5.2\nDedicated: v. 1.6.0\n3) RAM\nVM: 2GB RAM\nDedicated: 32 GB RAM\n\nCPU on both machines is the same: Xeon (2600 MHz)\nVM: 20kb CPU cache\nDedicated: 15kb CPU cache\n\nKernel version is almost the same:\nVM:\n\n```\n3.10.0-229.1.2.el7.x86_64\n```\n\nDedicated :\n\n```\n3.10.0-229.7.2.el7.x86_64\n```\n\nVM does percolation 40% faster than dedicated server (on the same number of queues).\n\nAll comparisons were made after we disabled Linux swap on Dedicated server.\n\nVM reported no Garbage Collector errors in almost 3 months (heavy percolation use, but no direct searches).\nVM has 4 slowlog records in these 3 months (which is much better than dedicated service performance).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124295360","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124295360","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124295360,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDI5NTM2MA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-24T02:32:33Z","updated_at":"2015-07-24T02:44:34Z","author_association":"NONE","body":"> the diagnostic dump\n\nWe installed \"elastic-support-diagnostic\" plugin and recorded statistics.\n\n```\n/usr/share/elasticsearch/bin/plugin --install elasticsearch/elasticsearch-support-diagnostics\n```\n\nShould I email the diagnostic dump to clint@traveljury.com ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124298191","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124298191","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124298191,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDI5ODE5MQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-24T02:50:37Z","updated_at":"2015-07-24T02:50:37Z","author_association":"NONE","body":"> Centos has transparent hugepages enabled by default\n\nAre you suggesting disable THP in addition to disabling Linux memory swap?\nOr enable Linux memory swap again, disable THP and see if we still have no errors?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/124916315","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-124916315","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":124916315,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNDkxNjMxNQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-25T23:46:15Z","updated_at":"2015-07-25T23:46:15Z","author_association":"NONE","body":"Unfortunately disabling Linux swap did NOT help.\nAt the end of day 5 (since last reboot) we started getting timeouts again.\nAt the day 6 number of timeouts became significant enough so we had to reboot ElasticSearch again.\n\nWe did not try disabling transparent hugepages, but it probably would not help against timeouts (5+ days after last ElasticticSearch reboot).\nThe reason I think that is that we had the same 5+ days timeouts issue with our Windows ElasticSearch installation.\nThese empirical observations point to ElasticSearch itself as a responsible party for these timeouts.\nMost likely cause - memory leak (otherwise timeouts would not go away after ElasticSearch reboot).\n\nDisabling transparent hugepages still may (or may not) help us to combine percolator functionality with regular searches and make using server resources efficiently.\nThough I am a little bit skeptical at this point about positive outcome.\nRunning ElasticSearch in smaller virtual machines seems to be more promising option.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/125013645","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-125013645","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":125013645,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNTAxMzY0NQ==","user":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"created_at":"2015-07-26T16:29:42Z","updated_at":"2015-07-26T16:29:42Z","author_association":"MEMBER","body":"@dennisgorelik I noticed in one of your normal queries that you're using a script. On the node with timeouts, can you run:\n\n``` bash\n$ curl -XGET 'localhost:9200/_cat/fielddata?v&fields=*'\n```\n\nand\n\n``` bash\n$ curl -XGET localhost:9200/_cat/plugins?v\n```\n\nThere's two things that come to mind when I look at your GCs:\n1. Your memory seems to have settled at just over 50% of the total heap, which isn't giving a dramatic amount of headroom to do other stuff. I expect that this article will be useful to you here: https://elastic.co/blog/support-in-the-wild-my-biggest-elasticsearch-problem-at-scale\n2. Your young GCs are indeed slow, but if you look at the young versus old, you can see that it's actually aging the memory rather than freeing it. This means that whatever is happening is probably happening all at once.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/125031879","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-125031879","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":125031879,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNTAzMTg3OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-26T19:41:17Z","updated_at":"2015-07-26T19:41:17Z","author_association":"CONTRIBUTOR","body":"> Should I email the diagnostic dump to clint@traveljury.com ?\n\nyes please\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/125076215","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-125076215","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":125076215,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNTA3NjIxNQ==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-27T03:45:45Z","updated_at":"2015-07-27T03:45:45Z","author_association":"NONE","body":"@pickypg\n\n> localhost:9200/_cat/fielddata?v&fields=*\n\n```\n5KUus70-Taix-_Tokoea_Q pjfsearch xxx.xxx.xxx.xxx Node1  38mb        9mb 2.5mb         2.5mb   23.8mb \n```\n\n(That's the snapshot at ~1 day since last ElasticSearch reboot.\n\nDoes it help to determine anything?\n\n> /_cat/plugins?v\n\n```\nNode1 bigdesk   NA      s    /_plugin/bigdesk/ \n```\n\n> settled at just over 50% of the total heap\n\nDo you mean that normal heap usage should be less than 50%?\n\nDo you think that some of our requests require some memory buffer of more than 50% of the heap?\n(That seems unlikely, considering that we have a lot of RAM and our queries are not really that big).\n\n> it's actually aging the memory rather than freeing it\n\nFrom what information do you see that young memory is not freeing?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/125139770","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-125139770","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":125139770,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNTEzOTc3MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-07-27T09:20:13Z","updated_at":"2015-07-27T09:20:13Z","author_association":"CONTRIBUTOR","body":"> Do you mean that normal heap usage should be less than 50%?\n\nNo.  It's normal for old gen GC to kick in at 75% and drop the heap to 50%.  \n\n> From what information do you see that young memory is not freeing?\n\nYour young gen GCs are really slow, and the young heap usage never drops by much.\n\n@pickypg's mention of scripts made me take another look at your scripts:\n\n>    \"pow(0.99, (1437445335545.0 - doc['PostedDate'].value)/86400000)\" \n\nYou have values like `1437445335545.0` in your scripts.  Do these values change on most requests?  If so, you recompile your scripts every time you run them.  This could well be the problem you're suffering. Script compilation is heavy and can generate a lot of garbage.  \n\nChange your scripts to use params instead, and see if that helps, eg:\n\n```\n      \"script_score\": {\n        \"script\": \"pow(0.99, (my_param - doc['PostedDate'].value)/86400000)\"\n      },\n      \"params\": {\n        \"my_param\": 1437445335545\n      }\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/125498488","html_url":"https://github.com/elastic/elasticsearch/issues/11919#issuecomment-125498488","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11919","id":125498488,"node_id":"MDEyOklzc3VlQ29tbWVudDEyNTQ5ODQ4OA==","user":{"login":"dennisgorelik","id":4333866,"node_id":"MDQ6VXNlcjQzMzM4NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4333866?v=4","gravatar_id":"","url":"https://api.github.com/users/dennisgorelik","html_url":"https://github.com/dennisgorelik","followers_url":"https://api.github.com/users/dennisgorelik/followers","following_url":"https://api.github.com/users/dennisgorelik/following{/other_user}","gists_url":"https://api.github.com/users/dennisgorelik/gists{/gist_id}","starred_url":"https://api.github.com/users/dennisgorelik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dennisgorelik/subscriptions","organizations_url":"https://api.github.com/users/dennisgorelik/orgs","repos_url":"https://api.github.com/users/dennisgorelik/repos","events_url":"https://api.github.com/users/dennisgorelik/events{/privacy}","received_events_url":"https://api.github.com/users/dennisgorelik/received_events","type":"User","site_admin":false},"created_at":"2015-07-28T08:24:21Z","updated_at":"2015-07-28T08:24:21Z","author_association":"NONE","body":">  It's normal for old gen GC to kick in at 75% and drop the heap to 50%.\n\nThat is exactly what we had (and still have) in our ElasticSearch.\nHaving \"GC usage at just over 50%\" was a temporary snapshot.\n\n> Do these values change on most requests?\n\nYes: these values change almost always.\n\n> you recompile your scripts every time you run them. This could well be the problem you're suffering. \n\nYou are right.\nWe changed that query to parameterized version and that immediately brought great improvements:\n1) In our development environment (ElasticSearch on Windows without running any other concurrent tasks) query execution time dropped from 20ms down to 4ms (5x improvement!).\n2) In our production environment we now are able to run our percolation queries with our direct search queries (the queries that we just parameterized).\n\nWe do not have timeouts yet, but when running percolation queries and direct queries concurrently, direct queries execute much longer (e.g. 10s instead of 120ms).\nWe have that direct queries slowness in spite of CPU utilization of being never more than 60% (and plenty of RAM).\n\nEven though it looks likely that we fixed (parametrized) query that was causing memory leaks, we still did not test it empirically: It's been less than a day since last ElasticSearch reboot.\nI will report in about a week if we would get timeouts or not.\n","performed_via_github_app":null}]