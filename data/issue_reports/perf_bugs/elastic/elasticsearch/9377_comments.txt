[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70839481","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-70839481","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":70839481,"node_id":"MDEyOklzc3VlQ29tbWVudDcwODM5NDgx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-21T13:49:29Z","updated_at":"2015-01-21T13:49:29Z","author_association":"CONTRIBUTOR","body":"Hi @silvestrelosada \n\nPlease could you provide the simplest complete recreation of the problem, so that we can try it out:\n- you're only running suggestions on one field, but you've provided the mapping for all fields\n- you haven't provided the index settings (including the analysis section)\n- you haven't provided an example document\n\nthanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70878232","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-70878232","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":70878232,"node_id":"MDEyOklzc3VlQ29tbWVudDcwODc4MjMy","user":{"login":"silvestrelosada","id":2760778,"node_id":"MDQ6VXNlcjI3NjA3Nzg=","avatar_url":"https://avatars2.githubusercontent.com/u/2760778?v=4","gravatar_id":"","url":"https://api.github.com/users/silvestrelosada","html_url":"https://github.com/silvestrelosada","followers_url":"https://api.github.com/users/silvestrelosada/followers","following_url":"https://api.github.com/users/silvestrelosada/following{/other_user}","gists_url":"https://api.github.com/users/silvestrelosada/gists{/gist_id}","starred_url":"https://api.github.com/users/silvestrelosada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silvestrelosada/subscriptions","organizations_url":"https://api.github.com/users/silvestrelosada/orgs","repos_url":"https://api.github.com/users/silvestrelosada/repos","events_url":"https://api.github.com/users/silvestrelosada/events{/privacy}","received_events_url":"https://api.github.com/users/silvestrelosada/received_events","type":"User","site_admin":false},"created_at":"2015-01-21T17:11:01Z","updated_at":"2015-01-21T17:11:01Z","author_association":"NONE","body":"Hi here is the data needed to reproduce the error, mapping file, elasticsarch.yml, and data \n\nhttps://gist.github.com/silvestrelosada/eb32afdc8c971504e45c\n\nTo reproduce it you have to send seval concurrent queries, Im using jmeter.\n\nBest\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71020332","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-71020332","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":71020332,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMDIwMzMy","user":{"login":"silvestrelosada","id":2760778,"node_id":"MDQ6VXNlcjI3NjA3Nzg=","avatar_url":"https://avatars2.githubusercontent.com/u/2760778?v=4","gravatar_id":"","url":"https://api.github.com/users/silvestrelosada","html_url":"https://github.com/silvestrelosada","followers_url":"https://api.github.com/users/silvestrelosada/followers","following_url":"https://api.github.com/users/silvestrelosada/following{/other_user}","gists_url":"https://api.github.com/users/silvestrelosada/gists{/gist_id}","starred_url":"https://api.github.com/users/silvestrelosada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silvestrelosada/subscriptions","organizations_url":"https://api.github.com/users/silvestrelosada/orgs","repos_url":"https://api.github.com/users/silvestrelosada/repos","events_url":"https://api.github.com/users/silvestrelosada/events{/privacy}","received_events_url":"https://api.github.com/users/silvestrelosada/received_events","type":"User","site_admin":false},"created_at":"2015-01-22T13:33:55Z","updated_at":"2015-01-22T13:33:55Z","author_association":"NONE","body":"If it is helps the issue takes place on multi shard enviroment in  fetchMatchingDocCountResponses method when executing the search.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71530675","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-71530675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":71530675,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNTMwNjc1","user":{"login":"seyart","id":5413519,"node_id":"MDQ6VXNlcjU0MTM1MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/5413519?v=4","gravatar_id":"","url":"https://api.github.com/users/seyart","html_url":"https://github.com/seyart","followers_url":"https://api.github.com/users/seyart/followers","following_url":"https://api.github.com/users/seyart/following{/other_user}","gists_url":"https://api.github.com/users/seyart/gists{/gist_id}","starred_url":"https://api.github.com/users/seyart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seyart/subscriptions","organizations_url":"https://api.github.com/users/seyart/orgs","repos_url":"https://api.github.com/users/seyart/repos","events_url":"https://api.github.com/users/seyart/events{/privacy}","received_events_url":"https://api.github.com/users/seyart/received_events","type":"User","site_admin":false},"created_at":"2015-01-26T20:21:17Z","updated_at":"2015-01-27T09:10:44Z","author_association":"NONE","body":"Hi,\n\nI think I have the same issue. ES hangs when I send multiple simultaneous suggest requests with collate option to the search API. I tested the version 1.37 and 1.42 of ES. ES is running with one node and the default settings (5 shards per index, but 0 replica). There are about 19 000 documents in the target index. \n\nTo make ES hang, I created a script which run a lot of suggest requests with random text.  When I launch 2 or more instances of this script, depending on the hardware configuration of my testing environment, ES hangs and my ES client (elasticsearch-py) raises timeout exceptions. Then, I'm unable to make curl request to the search API (it's keep waiting for a response). Index API and bulk API are still running fine. \nUsing BigDesk to monitor, there is no memory issue. The search thread pools are also fine but the queue size increases after it hangs.\n\nES log gives nothing.\n\nHere is an exemple of a request :\n\n```\n{\n    \"aggregations\": {\n        \"brand\": {\n            \"terms\": {\n                \"field\": \"brand.untouched\",\n                \"size\": 0\n            }\n        },\n        \"categories\": {\n            \"terms\": {\n                \"field\": \"categories_parents_catalog_codes\",\n                \"size\": 0\n            }\n        },\n        \"offers\": {\n            \"terms\": {\n                \"field\": \"offers.untouched\",\n                \"size\": 0\n            }\n        },\n        \"stores\": {\n            \"terms\": {\n                \"field\": \"categories_parents_catalog_codes\",\n                \"size\": 0\n            }\n        }\n    },\n    \"fields\": [\n        \"full_title\"\n    ],\n    \"from\": 0,\n    \"query\": {\n        \"filtered\": {\n            \"filter\": {\n                \"term\": {\n                    \"categories_parents_catalog_codes\": \"root\"\n                }\n            },\n            \"query\": {\n                \"match\": {\n                    \"full_title.autocomplete\": {\n                        \"operator\": \"and\",\n                        \"query\": \"B\"\n                    }\n                }\n            }\n        }\n    },\n    \"size\": 20,\n    \"suggest\": {\n        \"suggestion_phrase\": {\n            \"phrase\": {\n                \"collate\": {\n                    \"preference\": \"_primary\",\n                    \"query\": {\n                        \"filtered\": {\n                            \"filter\": {\n                                \"term\": {\n                                    \"categories_parents_catalog_codes\": \"root\"\n                                }\n                            },\n                            \"query\": {\n                                \"match\": {\n                                    \"full_title.autocomplete\": {\n                                        \"operator\": \"and\",\n                                        \"query\": \"{{suggestion}}\"\n                                    }\n                                }\n                            }\n                        }\n                    }\n                },\n                \"field\": \"full_title.suggestion\"\n            }\n        },\n        \"text\": \"B\"\n    }\n}\n```\n\nHere is the mapping of the suggest field :\n\n```\n            \"full_title\": {\n                \"type\": \"string\",\n                \"fields\": {\n                    \"french\": {\n                        \"type\": \"string\",\n                        \"analyzer\": \"custom_french\"\n                    },\n                    \"suggestion\": {\n                        \"type\": \"string\",\n                        \"analyzer\": \"custom_suggestion\"\n                    },\n                    \"autocomplete\": {\n                        \"type\": \"string\",\n                        \"index_analyzer\": \"nGram_analyzer\",\n                        \"search_analyzer\": \"whitespace_analyzer\"\n                    }\n                }\n            }\n```\n\nI remain available for any further information.\n\nBest Regards,\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/71536742","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-71536742","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":71536742,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNTM2NzQy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-26T20:57:45Z","updated_at":"2015-01-26T20:57:45Z","author_association":"CONTRIBUTOR","body":"@areek could you take a look at this please\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/73221331","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-73221331","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":73221331,"node_id":"MDEyOklzc3VlQ29tbWVudDczMjIxMzMx","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2015-02-06T11:09:23Z","updated_at":"2015-02-06T11:09:23Z","author_association":"CONTRIBUTOR","body":"@areek can you try to write a test to reproduce this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/98618908","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-98618908","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":98618908,"node_id":"MDEyOklzc3VlQ29tbWVudDk4NjE4OTA4","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2015-05-04T07:59:11Z","updated_at":"2015-05-04T07:59:11Z","author_association":"CONTRIBUTOR","body":"one idea that I have here is that it seem it only happens if we specify the suggest together with a search and that means the suggestion as well as the collation is executed on the search threadpool @areek can you try to write a test that does the same and try to forcefully reduce the number of threads in the search threadpool to a small number ie 1 or 2? I guess that could trigger the issue...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101796638","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-101796638","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":101796638,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTc5NjYzOA==","user":{"login":"areek","id":753679,"node_id":"MDQ6VXNlcjc1MzY3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/753679?v=4","gravatar_id":"","url":"https://api.github.com/users/areek","html_url":"https://github.com/areek","followers_url":"https://api.github.com/users/areek/followers","following_url":"https://api.github.com/users/areek/following{/other_user}","gists_url":"https://api.github.com/users/areek/gists{/gist_id}","starred_url":"https://api.github.com/users/areek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/areek/subscriptions","organizations_url":"https://api.github.com/users/areek/orgs","repos_url":"https://api.github.com/users/areek/repos","events_url":"https://api.github.com/users/areek/events{/privacy}","received_events_url":"https://api.github.com/users/areek/received_events","type":"User","site_admin":false},"created_at":"2015-05-13T20:00:11Z","updated_at":"2015-05-13T20:00:11Z","author_association":"CONTRIBUTOR","body":"I have been able to reproduce this issue.\nCollate option internally fires off a search request, when used from the _search API, the internal request uses the same search threadpool used by the search request, hence if all threads are busy, it causes a deadlock.\n\nOne solution to avoid this issue would be to execute the collate query on only the local shard from which the suggestions are generated instead of collating on non-local shards. As suggestions are generated from the terms of the local shard,  in most cases a generated suggestion which does not yield a hit for the collate query on the local shard would not yield a hit for collate query on non-local shards. Thoughts? I will create a PR for this.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101798776","html_url":"https://github.com/elastic/elasticsearch/issues/9377#issuecomment-101798776","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9377","id":101798776,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTc5ODc3Ng==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2015-05-13T20:07:24Z","updated_at":"2015-05-13T20:07:24Z","author_association":"CONTRIBUTOR","body":"> One solution to avoid this issue would be to execute the collate query on only the local shard from which the suggestions are generated instead of collating on non-local shards. As suggestions are generated from the terms of the local shard, in most cases a generated suggestion which does not yield a hit for the collate query on the local shard would not yield a hit for collate query on non-local shards. Thoughts? I will create a PR for this.\n\nI like this a lot  - i think it's the right tradeoff \n","performed_via_github_app":null}]