[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269757843","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-269757843","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":269757843,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTc1Nzg0Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-12-30T10:51:10Z","updated_at":"2016-12-30T10:51:10Z","author_association":"CONTRIBUTOR","body":"1.7 used to load filters into a bit set while 5.x consumes filters on the fly. So I would expect 5.x to perform better in the case that the filter is not cached, especially if the query is selective, and 1.x to perform better if the filter was cached. What does your filters aggregation look like?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269760215","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-269760215","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":269760215,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTc2MDIxNQ==","user":{"login":"sinsonglew","id":12896760,"node_id":"MDQ6VXNlcjEyODk2NzYw","avatar_url":"https://avatars1.githubusercontent.com/u/12896760?v=4","gravatar_id":"","url":"https://api.github.com/users/sinsonglew","html_url":"https://github.com/sinsonglew","followers_url":"https://api.github.com/users/sinsonglew/followers","following_url":"https://api.github.com/users/sinsonglew/following{/other_user}","gists_url":"https://api.github.com/users/sinsonglew/gists{/gist_id}","starred_url":"https://api.github.com/users/sinsonglew/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sinsonglew/subscriptions","organizations_url":"https://api.github.com/users/sinsonglew/orgs","repos_url":"https://api.github.com/users/sinsonglew/repos","events_url":"https://api.github.com/users/sinsonglew/events{/privacy}","received_events_url":"https://api.github.com/users/sinsonglew/received_events","type":"User","site_admin":false},"created_at":"2016-12-30T11:15:24Z","updated_at":"2016-12-30T11:22:19Z","author_association":"NONE","body":"@jpountz , we have such a need: get latest post of multi users by one request. the built query as follows:\r\n\r\n```{\r\n  \"size\": 0,\r\n  \"timeout\": \"3000ms\",\r\n  \"aggregations\": {\r\n    \"collector\": {\r\n      \"filters\": {\r\n        \"filters\": {\r\n          \"204443405\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"bool\": {\r\n                    \"must\": [\r\n                      {\r\n                        \"term\": {\r\n                          \"userId\": {\r\n                            \"value\": 204443405,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      },\r\n                      {\r\n                        \"terms\": {\r\n                          \"typeId\": [\r\n                            1,\r\n                            2\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      },\r\n                      {\r\n                        \"term\": {\r\n                          \"effect\": {\r\n                            \"value\": true,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"must_not\": [\r\n                      {\r\n                        \"terms\": {\r\n                          \"workId\": [\r\n                            101219700,\r\n                            576315300,\r\n                            578923100\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"disable_coord\": false,\r\n                    \"adjust_pure_negative\": true,\r\n                    \"boost\": 1\r\n                  }\r\n                }\r\n              ],\r\n              \"disable_coord\": false,\r\n              \"adjust_pure_negative\": true,\r\n              \"boost\": 1\r\n            }\r\n          },\r\n          \"204659905\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"bool\": {\r\n                    \"must\": [\r\n                      {\r\n                        \"term\": {\r\n                          \"userId\": {\r\n                            \"value\": 204659905,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      },\r\n                      {\r\n                        \"terms\": {\r\n                          \"typeId\": [\r\n                            1,\r\n                            2\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      },\r\n                      {\r\n                        \"term\": {\r\n                          \"effect\": {\r\n                            \"value\": true,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"must_not\": [\r\n                      {\r\n                        \"terms\": {\r\n                          \"workId\": [\r\n                            101219700,\r\n                            576315300,\r\n                            578923100\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"disable_coord\": false,\r\n                    \"adjust_pure_negative\": true,\r\n                    \"boost\": 1\r\n                  }\r\n                }\r\n              ],\r\n              \"disable_coord\": false,\r\n              \"adjust_pure_negative\": true,\r\n              \"boost\": 1\r\n            }\r\n          },\r\n          \"214507405\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"bool\": {\r\n                    \"must\": [\r\n                      {\r\n                        \"term\": {\r\n                          \"userId\": {\r\n                            \"value\": 214507405,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      },\r\n                      {\r\n                        \"terms\": {\r\n                          \"typeId\": [\r\n                            1,\r\n                            2\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      },\r\n                      {\r\n                        \"term\": {\r\n                          \"effect\": {\r\n                            \"value\": true,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"must_not\": [\r\n                      {\r\n                        \"terms\": {\r\n                          \"workId\": [\r\n                            101219700,\r\n                            576315300,\r\n                            578923100\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"disable_coord\": false,\r\n                    \"adjust_pure_negative\": true,\r\n                    \"boost\": 1\r\n                  }\r\n                }\r\n              ],\r\n              \"disable_coord\": false,\r\n              \"adjust_pure_negative\": true,\r\n              \"boost\": 1\r\n            }\r\n          },\r\n          \"215114505\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"bool\": {\r\n                    \"must\": [\r\n                      {\r\n                        \"term\": {\r\n                          \"userId\": {\r\n                            \"value\": 215114505,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      },\r\n                      {\r\n                        \"terms\": {\r\n                          \"typeId\": [\r\n                            1,\r\n                            2\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      },\r\n                      {\r\n                        \"term\": {\r\n                          \"effect\": {\r\n                            \"value\": true,\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"must_not\": [\r\n                      {\r\n                        \"terms\": {\r\n                          \"workId\": [\r\n                            101219700,\r\n                            576315300,\r\n                            578923100\r\n                          ],\r\n                          \"boost\": 1\r\n                        }\r\n                      }\r\n                    ],\r\n                    \"disable_coord\": false,\r\n                    \"adjust_pure_negative\": true,\r\n                    \"boost\": 1\r\n                  }\r\n                }\r\n              ],\r\n              \"disable_coord\": false,\r\n              \"adjust_pure_negative\": true,\r\n              \"boost\": 1\r\n            }\r\n          }\r\n        },\r\n        \"other_bucket\": false,\r\n        \"other_bucket_key\": \"_other_\"\r\n      },\r\n      \"aggregations\": {\r\n        \"top\": {\r\n          \"top_hits\": {\r\n            \"from\": 0,\r\n            \"size\": 4,\r\n            \"version\": false,\r\n            \"explain\": false,\r\n            \"_source\": {\r\n              \"includes\": [\r\n                \"workId\",\r\n                \"userName\"\r\n              ],\r\n              \"excludes\": []\r\n            },\r\n            \"sort\": [\r\n              {\r\n                \"lastUpdateTime\": {\r\n                  \"order\": \"desc\"\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"ext\": {}\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269772908","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-269772908","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":269772908,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTc3MjkwOA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-12-30T13:41:57Z","updated_at":"2016-12-30T13:41:57Z","author_association":"CONTRIBUTOR","body":"You can probably get faster results by moving the common bits to the query part:\r\n\r\n```javascript\r\n{\r\n  \"size\": 0,\r\n  \"timeout\": \"3000ms\",\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"terms\": {\r\n            \"typeId\": [1, 2]\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"effect\": true\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": [\r\n        {\r\n          \"terms\": {\r\n            \"workId\": [101219700, 576315300, 578923100]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"collector\": {\r\n      \"filters\": {\r\n        \"filters\": {\r\n          \"204443405\": {\r\n            \"term\": {\r\n              \"userId\": 204443405\r\n            }\r\n          },\r\n          \"204659905\": {\r\n            \"term\": {\r\n              \"userId\": 204659905\r\n            }\r\n          },\r\n          \"214507405\": {\r\n            \"term\": {\r\n              \"userId\": 214507405\r\n            }\r\n          },\r\n          \"215114505\": {\r\n            \"term\": {\r\n              \"userId\": 215114505\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"aggregations\": {\r\n        \"top\": {\r\n          \"top_hits\": {\r\n            \"from\": 0,\r\n            \"size\": 4,\r\n            \"version\": false,\r\n            \"explain\": false,\r\n            \"_source\": {\r\n              \"includes\": [\r\n                \"workId\",\r\n                \"userName\"\r\n              ],\r\n              \"excludes\": []\r\n            },\r\n            \"sort\": [\r\n              {\r\n                \"lastUpdateTime\": {\r\n                  \"order\": \"desc\"\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"ext\": {}\r\n}\r\n```\r\n\r\nI did not test it so there might be typos but hopefully this gives you the idea.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270669917","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-270669917","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":270669917,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDY2OTkxNw==","user":{"login":"sinsonglew","id":12896760,"node_id":"MDQ6VXNlcjEyODk2NzYw","avatar_url":"https://avatars1.githubusercontent.com/u/12896760?v=4","gravatar_id":"","url":"https://api.github.com/users/sinsonglew","html_url":"https://github.com/sinsonglew","followers_url":"https://api.github.com/users/sinsonglew/followers","following_url":"https://api.github.com/users/sinsonglew/following{/other_user}","gists_url":"https://api.github.com/users/sinsonglew/gists{/gist_id}","starred_url":"https://api.github.com/users/sinsonglew/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sinsonglew/subscriptions","organizations_url":"https://api.github.com/users/sinsonglew/orgs","repos_url":"https://api.github.com/users/sinsonglew/repos","events_url":"https://api.github.com/users/sinsonglew/events{/privacy}","received_events_url":"https://api.github.com/users/sinsonglew/received_events","type":"User","site_admin":false},"created_at":"2017-01-05T15:24:05Z","updated_at":"2017-01-05T15:24:05Z","author_association":"NONE","body":"@Adrien，Your advice help a lot，thanks！\r\n\r\n发自我的 Windows Phone\r\n________________________________\r\nFrom: Adrien Grand<mailto:notifications@github.com>\r\nSent: ‎2016/‎12/‎30 21:43\r\nTo: elastic/elasticsearch<mailto:elasticsearch@noreply.github.com>\r\nCc: sinsonglew<mailto:sinsonglew@live.com>; Author<mailto:author@noreply.github.com>\r\nSubject: Re: [elastic/elasticsearch] 5.x Aggregation Performance worse than 1.7.x ? (#22382)\r\n\r\n\r\nYou can probably get faster results by moving the common bits to the query part:\r\n\r\n{\r\n  \"size\": 0,\r\n  \"timeout\": \"3000ms\",\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"terms\": {\r\n            \"typeId\": [1, 2]\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"effect\": true\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": [\r\n        {\r\n          \"terms\": {\r\n            \"workId\": [101219700, 576315300, 578923100]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"collector\": {\r\n      \"filters\": {\r\n        \"filters\": {\r\n          \"204443405\": {\r\n            \"term\": {\r\n              \"userId\": 204443405\r\n            }\r\n          },\r\n          \"204659905\": {\r\n            \"term\": {\r\n              \"userId\": 204659905\r\n            }\r\n          },\r\n          \"214507405\": {\r\n            \"term\": {\r\n              \"userId\": 214507405\r\n            }\r\n          },\r\n          \"215114505\": {\r\n            \"term\": {\r\n              \"userId\": 215114505\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"aggregations\": {\r\n        \"top\": {\r\n          \"top_hits\": {\r\n            \"from\": 0,\r\n            \"size\": 4,\r\n            \"version\": false,\r\n            \"explain\": false,\r\n            \"_source\": {\r\n              \"includes\": [\r\n                \"workId\",\r\n                \"userName\"\r\n              ],\r\n              \"excludes\": []\r\n            },\r\n            \"sort\": [\r\n              {\r\n                \"lastUpdateTime\": {\r\n                  \"order\": \"desc\"\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"ext\": {}\r\n}\r\n\r\nI did not test it so there might be typos but hopefully this gives you the idea.\r\n\r\n—\r\nYou are receiving this because you authored the thread.\r\nReply to this email directly, view it on GitHub<https://github.com/elastic/elasticsearch/issues/22382#issuecomment-269772908>, or mute the thread<https://github.com/notifications/unsubscribe-auth/AMTJ-PAp4K3pXdY2oWx708lc445oejg-ks5rNQpogaJpZM4LYF7Z>.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315664898","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-315664898","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":315664898,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTY2NDg5OA==","user":{"login":"sinsonglew","id":12896760,"node_id":"MDQ6VXNlcjEyODk2NzYw","avatar_url":"https://avatars1.githubusercontent.com/u/12896760?v=4","gravatar_id":"","url":"https://api.github.com/users/sinsonglew","html_url":"https://github.com/sinsonglew","followers_url":"https://api.github.com/users/sinsonglew/followers","following_url":"https://api.github.com/users/sinsonglew/following{/other_user}","gists_url":"https://api.github.com/users/sinsonglew/gists{/gist_id}","starred_url":"https://api.github.com/users/sinsonglew/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sinsonglew/subscriptions","organizations_url":"https://api.github.com/users/sinsonglew/orgs","repos_url":"https://api.github.com/users/sinsonglew/repos","events_url":"https://api.github.com/users/sinsonglew/events{/privacy}","received_events_url":"https://api.github.com/users/sinsonglew/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T04:08:29Z","updated_at":"2017-07-17T04:08:29Z","author_association":"NONE","body":"Hi, @jpountz , hoping get advices for another question.  Efficiency issue between _**terms**_ query and **_range_** query , to enumerable integers , for example with number size less than 50, we can filter by terms and ranges. but which is better and preferred. Thanks !","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315734915","html_url":"https://github.com/elastic/elasticsearch/issues/22382#issuecomment-315734915","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22382","id":315734915,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTczNDkxNQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T11:55:09Z","updated_at":"2017-07-17T11:55:09Z","author_association":"CONTRIBUTOR","body":"Use a range.","performed_via_github_app":null}]