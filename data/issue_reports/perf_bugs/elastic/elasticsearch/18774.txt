{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18774","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18774/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18774/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18774/events","html_url":"https://github.com/elastic/elasticsearch/issues/18774","id":159086575,"node_id":"MDU6SXNzdWUxNTkwODY1NzU=","number":18774,"title":"Query/Filter performance loss from 1.4.2 to 2.3.3 on dynamically updated index","user":{"login":"gpstathis","id":365914,"node_id":"MDQ6VXNlcjM2NTkxNA==","avatar_url":"https://avatars0.githubusercontent.com/u/365914?v=4","gravatar_id":"","url":"https://api.github.com/users/gpstathis","html_url":"https://github.com/gpstathis","followers_url":"https://api.github.com/users/gpstathis/followers","following_url":"https://api.github.com/users/gpstathis/following{/other_user}","gists_url":"https://api.github.com/users/gpstathis/gists{/gist_id}","starred_url":"https://api.github.com/users/gpstathis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpstathis/subscriptions","organizations_url":"https://api.github.com/users/gpstathis/orgs","repos_url":"https://api.github.com/users/gpstathis/repos","events_url":"https://api.github.com/users/gpstathis/events{/privacy}","received_events_url":"https://api.github.com/users/gpstathis/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2016-06-08T06:10:00Z","updated_at":"2018-01-16T08:28:03Z","closed_at":"2016-06-16T10:03:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\n\n**JVM version**: 1.8.0_31-b13\n\n**OS version**: Ubuntu 14.04.1 LTS\n\nWe are upgrading from 1.4.2 to 2.3.3 and are seeing some significant performance loss for several of our filtered queries against a dynamically updated index. For simplicity, I'll focus on just one query for this issue.\n\nThe query in question: https://gist.github.com/gpstathis/f96c048d0afe8f2bfce4753ffc9d555b\n\nI am testing this same query on two different clusters, one 1.4.2 and one 2.3.3, loaded with the same data and getting the same real-time updates (new docs arriving at about 20 o 50 per second). Both clusters are using the same machine specs and the indices are sized with the same number of shards.\n\nOn a corpus of about 1 billion docs this query/filter yields about 88k hits. It takes about 5 seconds to execute on 1.4.2 while on 2.3.3 the time has more than doubled to 13 seconds. \n\nHere are the hot threads for the query on 1.4.2: https://gist.github.com/gpstathis/12ef17f104e3e2d7fafbae10d6eb9267\n\nAnd now hot threads for the query on 2.3.3: https://gist.github.com/gpstathis/9196625858d4ca0b4311e5d288bae55e\n\nFrom what I can tell, we are not benefiting from caching in either environment so I am not clear why 2.3.3, despite the new autocaching, would be penalized so much.\n\nNow the real head scratcher is this: the query times and hot threads above are from productionâ€”we also have a QA 2.3.3 cluster with a similar size corpus as prod but sized with half the nodes to save on cost (same number of shards). This QA cluster does not receive real-time updates like the prod cluster does. Even with half the number of nodes, the smaller 2.3.3 QA cluster performs similarly to our old 1.4.2 prod cluster and is therefore **faster** than the larger 2.3.3 cluster.\n\nFrom the above, it seems that the real-time updates have a much more adverse effect on 2.3.3 compared to pre-2.x versions?\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}