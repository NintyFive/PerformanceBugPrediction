{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24172","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24172/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24172/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24172/events","html_url":"https://github.com/elastic/elasticsearch/issues/24172","id":222626480,"node_id":"MDU6SXNzdWUyMjI2MjY0ODA=","number":24172,"title":"multiple update of one document in one _bulk too slow","user":{"login":"dizzzyroma","id":13850283,"node_id":"MDQ6VXNlcjEzODUwMjgz","avatar_url":"https://avatars1.githubusercontent.com/u/13850283?v=4","gravatar_id":"","url":"https://api.github.com/users/dizzzyroma","html_url":"https://github.com/dizzzyroma","followers_url":"https://api.github.com/users/dizzzyroma/followers","following_url":"https://api.github.com/users/dizzzyroma/following{/other_user}","gists_url":"https://api.github.com/users/dizzzyroma/gists{/gist_id}","starred_url":"https://api.github.com/users/dizzzyroma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dizzzyroma/subscriptions","organizations_url":"https://api.github.com/users/dizzzyroma/orgs","repos_url":"https://api.github.com/users/dizzzyroma/repos","events_url":"https://api.github.com/users/dizzzyroma/events{/privacy}","received_events_url":"https://api.github.com/users/dizzzyroma/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-04-19T05:49:58Z","updated_at":"2017-04-19T12:53:38Z","closed_at":"2017-04-19T09:33:43Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\nHi,\r\n\r\nMultiple update of one document in one _bulk is too slow\r\n\r\nExample:\r\n\r\n```\r\ncurl -XPOST \"http://localhost:9200/_bulk\" -H 'Content-Type: application/json' -d'\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":1}}\r\n{\"update\":{\"_index\":\"cc_36\",\"_type\":\"job\",\"_id\":\"960_87786b7c-69df-4d3d-b90b-b9b26f08e2a1\"}}\r\n{\"doc\":{\"status\":2}}\r\n'\r\n\r\n```\r\n\r\n**Elasticsearch version**: 5.3, 5.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_121-b13\r\n\r\n**OS version**:Ubuntu 16.04.2 LTS\r\n\r\nbulk request with 75 updates takes near 6 seconds on our test index that runs on c3.xlarge (4 CPU, 8 GB, documents in inex 14860619, index size 20GB) .\r\nbulk request with 150 updates takes near 12 seconds.\r\n\r\nbulk index with 75 documents takes 0.2 seconds\r\n\r\nOn ES 2.4 - we haven't this problem\r\n\r\nProfiler info:\r\n![image](https://cloud.githubusercontent.com/assets/13850283/25164972/b16176e6-24dc-11e7-84aa-0f11d56a1431.png)\r\n\r\n\r\n![image](https://cloud.githubusercontent.com/assets/13850283/25164960/996a4c5c-24dc-11e7-93e6-a3355070c9ed.png)\r\n\r\n\r\nIf it helps, I may open profiling port to cluster where this problem is reproduced","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}