{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50198","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50198/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50198/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50198/events","html_url":"https://github.com/elastic/elasticsearch/issues/50198","id":537804674,"node_id":"MDU6SXNzdWU1Mzc4MDQ2NzQ=","number":50198,"title":"_count is slower in 7.x than 6.x","user":{"login":"awick","id":427321,"node_id":"MDQ6VXNlcjQyNzMyMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/427321?v=4","gravatar_id":"","url":"https://api.github.com/users/awick","html_url":"https://github.com/awick","followers_url":"https://api.github.com/users/awick/followers","following_url":"https://api.github.com/users/awick/following{/other_user}","gists_url":"https://api.github.com/users/awick/gists{/gist_id}","starred_url":"https://api.github.com/users/awick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/awick/subscriptions","organizations_url":"https://api.github.com/users/awick/orgs","repos_url":"https://api.github.com/users/awick/repos","events_url":"https://api.github.com/users/awick/events{/privacy}","received_events_url":"https://api.github.com/users/awick/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-12-13T22:24:59Z","updated_at":"2019-12-16T10:48:14Z","closed_at":"2019-12-16T10:48:14Z","author_association":"NONE","active_lock_reason":null,"body":"Started in https://discuss.elastic.co/t/count-api-performance-downgraded-after-cluster-upgrade-from-6-8-4-to-7-5/210783\r\n\r\nSummary, _count is definitely slower with 7.x than 6.x.  It seems like it might have to do with the number of indices/shards involved, like there is O(n^2) with a loop inside a loop or something.\r\n\r\nOur old way with _count on 7.5.0\r\n\r\n```\r\ntime curl -H \"Content-Type: application/json\" -s --insecure https://localhost:9200/_count\r\n{\"count\":182116470792,\"_shards\":{\"total\":20107,\"successful\":20107,\"skipped\":0,\"failed\":0}}\r\n\r\nreal\t0m6.795s\r\n```\r\n_cat/count is the same on 7.5.0\r\n\r\n```\r\ntime curl -H \"Content-Type: application/json\" -s --insecure 'https://localhost:9200/_cat/count?format=json'\r\n[{\"epoch\":\"1575661460\",\"timestamp\":\"19:44:20\",\"count\":\"182117127449\"}]```\r\n\r\nreal\t0m6.523s\r\n```\r\n\r\n /_cat/indices is faster on 7.5.0, so my current work around is to just add up the indices myself.\r\n\r\n```\r\ntime curl -H \"Content-Type: application/json\" -s --insecure 'https://localhost:9200/_cat/indices?h=index,docs.count&format=json' > /dev/null\r\n\r\nreal\t0m2.351s\r\n```\r\n\r\n\r\nInteresting if I do partial counts like the following on 7.5\r\n```\r\ntime curl  'https://localhost:9200/sessions2-18*/_count' = 1s     (435 indices)\r\ntime curl  'https://localhost:9200/sessions2-19*/_count' = 3s    (1160 indices)\r\ntime curl  'https://localhost:9200/sessions2-18*,sessions2-19*/_count' = 6s\r\n```\r\n\r\nI would expect the last to take 4s instead of 6\r\n\r\nI don't have timings for 6.x, but I do know this used to be under 2s because it wasn't the slowest part of all my queries, and now it is.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}