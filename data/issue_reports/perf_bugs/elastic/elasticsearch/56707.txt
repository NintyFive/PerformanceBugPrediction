{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/56707","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56707/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56707/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56707/events","html_url":"https://github.com/elastic/elasticsearch/issues/56707","id":617639492,"node_id":"MDU6SXNzdWU2MTc2Mzk0OTI=","number":56707,"title":"IO hangs on Leader can cause publications to get stuck indefinitely","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-05-13T17:49:45Z","updated_at":"2020-05-29T15:05:30Z","closed_at":"2020-05-29T15:05:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.7.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAt the start of the publication the leader schedules a timeout handler and info handler to run at the end of the publish timeout. When the leader tries to commit the state locally, it acquires a mutex which is released only after local commit goes through. Now at this point if the node encounters an IO freeze at the persistence layer `PersistedClusterStateService#commit`, the mutex is not released that restricts the timeout behaviour from cancelling publication. \r\n\r\nThe scheduler schedules the timeout at publication timeout but its prevented from cancelling the publication by the mutex that has been held up. I'm not quite sure if that is the intended behaviour since the scheduler starts at the start of publication and not at the end of local state commit success. The leader as a result steps down only after it recovers from IO freeze when the timeout handler finally runs and cancels publication. The master operations during this time is stuck.\r\n\r\nThis also impacts the `infoTimeoutHandler` from running and logging the slow publication responses.\r\n\r\n**Steps to reproduce**:\r\nI have tried to simulate IO hang by adding a sleep in the code at `PersistedClusterStateService#commit` (apologies in advance, but will try a command that mimics the same). \r\n\r\n\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}