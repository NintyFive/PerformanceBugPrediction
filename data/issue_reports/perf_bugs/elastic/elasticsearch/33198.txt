{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33198","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33198/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33198/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33198/events","html_url":"https://github.com/elastic/elasticsearch/issues/33198","id":354673133,"node_id":"MDU6SXNzdWUzNTQ2NzMxMzM=","number":33198,"title":"Primary shard recovery time slower in 6.3.2 than 5.6.7","user":{"login":"ahadadi","id":25010233,"node_id":"MDQ6VXNlcjI1MDEwMjMz","avatar_url":"https://avatars1.githubusercontent.com/u/25010233?v=4","gravatar_id":"","url":"https://api.github.com/users/ahadadi","html_url":"https://github.com/ahadadi","followers_url":"https://api.github.com/users/ahadadi/followers","following_url":"https://api.github.com/users/ahadadi/following{/other_user}","gists_url":"https://api.github.com/users/ahadadi/gists{/gist_id}","starred_url":"https://api.github.com/users/ahadadi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahadadi/subscriptions","organizations_url":"https://api.github.com/users/ahadadi/orgs","repos_url":"https://api.github.com/users/ahadadi/repos","events_url":"https://api.github.com/users/ahadadi/events{/privacy}","received_events_url":"https://api.github.com/users/ahadadi/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-28T10:43:07Z","updated_at":"2018-08-28T12:52:22Z","closed_at":"2018-08-28T12:52:22Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (6.3.2)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen upgrading from 5.6.7 to 6.3.2, we've noticed that relocating a primary shard takes longer.\r\nIt seems that in 6.3.2, when relocating a primary shard to a different node, translog operations are being replayed. This happens even if the shard on the source node was successfully flushed, which means the translog does not contain any operation that is not already contained in the files being copied to the target node.\r\nIn 5.6.7 the translog is emptied when flush takes place, so translog operations are not replayed during relocation.\r\n\r\nThe expected behavior is that the recovery of a flushed shard to an empty target node will not entail translog replay, only copying files.\r\n\r\n**Steps to reproduce**:\r\n1) Create an index with a single primary shard and no replicas.\r\n2) Index 1M documents.\r\n3) Flush the index.\r\n4) Relocate the index to a different node using e.g. \"index.routing.allocation.require._name\" with a different node name.\r\n\r\nIf you set org.elasticsearch.indices.recovery logging level to TRACE, you will see that a file based recovery is taking place, that the files are transferred and then the translog is being sent and replayed on the target node:\r\n[2018-08-28T13:10:31,099][TRACE][o.e.i.r.RecoverySourceHandler] [node_td2] [index][0][recover to node_td1] sent batch of [10083][512kb] (total: [1000000]) translog operations\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}