{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29118","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29118/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29118/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29118/events","html_url":"https://github.com/elastic/elasticsearch/issues/29118","id":306023921,"node_id":"MDU6SXNzdWUzMDYwMjM5MjE=","number":29118,"title":"Snapshot stuck in IN_PROGRESS","user":{"login":"scottsom","id":23276852,"node_id":"MDQ6VXNlcjIzMjc2ODUy","avatar_url":"https://avatars1.githubusercontent.com/u/23276852?v=4","gravatar_id":"","url":"https://api.github.com/users/scottsom","html_url":"https://github.com/scottsom","followers_url":"https://api.github.com/users/scottsom/followers","following_url":"https://api.github.com/users/scottsom/following{/other_user}","gists_url":"https://api.github.com/users/scottsom/gists{/gist_id}","starred_url":"https://api.github.com/users/scottsom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/scottsom/subscriptions","organizations_url":"https://api.github.com/users/scottsom/orgs","repos_url":"https://api.github.com/users/scottsom/repos","events_url":"https://api.github.com/users/scottsom/events{/privacy}","received_events_url":"https://api.github.com/users/scottsom/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2018-03-16T17:58:34Z","updated_at":"2019-07-17T13:52:29Z","closed_at":"2019-01-16T09:10:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.1\r\n\r\n**Plugins installed**: [analysis-icu, analysis-kuromoji, analysis-phonetic, analysis-smartcn, analysis-stempel, analysis-ukrainian, mapper-size, repository-s3]\r\n\r\nAlso a few custom plugins that add monitoring, security, and one that initiates a snapshot periodically.\r\n\r\n**JVM version** (`java -version`): 1.8.0_144\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Amazon Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe initiate an S3 snapshot request and wait for it complete. These are done daily and usually only take about 20 minutes. In this case, the snapshot never returned. Our backups are now effectively useless since the IN_PROGRESS snapshot cannot be deleted, the repository cannot be deleted, and no subsequent snapshots can be created (even in a different repository).\r\n\r\nThe snapshot seems to be out of sync with the cluster state which says the snapshot was ABORTED but the snapshot still says IN_PROGRESS.\r\n\r\nI have restarted all 3 dedicated master nodes and the snapshot is still stuck. I have yet to try a full cluster restart.\r\n\r\n**Steps to reproduce**:\r\n\r\nUnfortunately, I haven't been able to identify the root cause or a way to reproduce this.\r\n\r\nThe cluster was GREEN before and after the snapshot started (17 hours later it went YELLOW). There were 4 shards being relocated leading up to and during the snapshot. The `cluster.routing.allocation.disk.watermark.low` setting was breached on a number of nodes. 17 hours after the snapshot was initiated I replaced the master node. All indexes were originally created in ES 5.5.0 and the current version was reached through a series of rolling upgrades (5.5.0 -> 5.6.2 -> 6.1.1).\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\nGET _cat/snapshots?repository=repo-name\r\n\r\n2018-02-16t00:00:00.000z     SUCCESS 1518739205 00:00:05 1518740265 00:17:45 17.6m 17 895 0 895\r\n2018-02-17t00:00:00.000z     SUCCESS 1518825640 00:00:40 1518826775 00:19:35 18.9m 17 895 0 895\r\n2018-02-18t00:00:00.000z     SUCCESS 1518912034 00:00:34 1518912988 00:16:28 15.9m 17 895 0 895\r\n2018-02-19t00:00:00.000z     SUCCESS 1518998435 00:00:35 1518999342 00:15:42 15.1m 17 895 0 895\r\n2018-02-20t00:00:00.000z     SUCCESS 1519084807 00:00:07 1519085803 00:16:43 16.6m 17 895 0 895\r\n2018-02-21t00:00:00.000z     SUCCESS 1519171226 00:00:26 1519172313 00:18:33 18.1m 17 895 0 895\r\n2018-02-22t00:00:00.000z     SUCCESS 1519257620 00:00:20 1519258622 00:17:02 16.7m 17 895 0 895\r\n2018-02-23t00:00:00.000z IN_PROGRESS 1519344013 00:00:13 0          00:00:00 20.6d 17   0 0   0\r\n```\r\n\r\n```\r\nGET _snapshot/repo-name\r\n\r\n{\r\n    \"repo-name\": {\r\n        \"type\": \"s3\",\r\n        \"settings\": {\r\n            \"bucket\": \"some-bucket\",\r\n            \"base_path\": \"repo-name\",\r\n            \"storage_class\": \"standard_ia\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n```\r\nGET _snapshot/repo-name/_status\r\n\r\n{\r\n    \"snapshots\": [\r\n        {\r\n            \"snapshot\": \"2018-02-23t00:00:00.000z\",\r\n            \"repository\": \"repo-name\",\r\n            \"uuid\": \"YtXSACL5Tm-kPadJ1I8JOw\",\r\n            \"state\": \"ABORTED\",\r\n            \"shards_stats\": {\r\n                \"initializing\": 0,\r\n                \"started\": 0,\r\n                \"finalizing\": 0,\r\n                \"done\": 0,\r\n                \"failed\": 2,\r\n                \"total\": 2\r\n            },\r\n            \"stats\": {\r\n                \"number_of_files\": 0,\r\n                \"processed_files\": 0,\r\n                \"total_size_in_bytes\": 0,\r\n                \"processed_size_in_bytes\": 0,\r\n                \"start_time_in_millis\": 0,\r\n                \"time_in_millis\": 0\r\n            },\r\n            \"indices\": {\r\n                \"some_index\": {\r\n                    \"shards_stats\": {\r\n                        \"initializing\": 0,\r\n                        \"started\": 0,\r\n                        \"finalizing\": 0,\r\n                        \"done\": 0,\r\n                        \"failed\": 2,\r\n                        \"total\": 2\r\n                    },\r\n                    \"stats\": {\r\n                        \"number_of_files\": 0,\r\n                        \"processed_files\": 0,\r\n                        \"total_size_in_bytes\": 0,\r\n                        \"processed_size_in_bytes\": 0,\r\n                        \"start_time_in_millis\": 0,\r\n                        \"time_in_millis\": 0\r\n                    },\r\n                    \"shards\": {\r\n                        \"61\": {\r\n                            \"stage\": \"FAILURE\",\r\n                            \"stats\": {\r\n                                \"number_of_files\": 0,\r\n                                \"processed_files\": 0,\r\n                                \"total_size_in_bytes\": 0,\r\n                                \"processed_size_in_bytes\": 0,\r\n                                \"start_time_in_millis\": 0,\r\n                                \"time_in_millis\": 0\r\n                            }\r\n                        },\r\n                        \"269\": {\r\n                            \"stage\": \"FAILURE\",\r\n                            \"stats\": {\r\n                                \"number_of_files\": 0,\r\n                                \"processed_files\": 0,\r\n                                \"total_size_in_bytes\": 0,\r\n                                \"processed_size_in_bytes\": 0,\r\n                                \"start_time_in_millis\": 0,\r\n                                \"time_in_millis\": 0\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n```\r\nGET _snapshot/repo-name/_current\r\n\r\n{\r\n    \"snapshots\": [\r\n        {\r\n            \"snapshot\": \"2018-02-23t00:00:00.000z\",\r\n            \"uuid\": \"YtXSACL5Tm-kPadJ1I8JOw\",\r\n            \"version_id\": 6010199,\r\n            \"version\": \"6.1.1\",\r\n            \"indices\": [ ... ],\r\n            \"state\": \"IN_PROGRESS\",\r\n            \"start_time\": \"2018-02-23T00:00:13.754Z\",\r\n            \"start_time_in_millis\": 1519344013754,\r\n            \"end_time\": \"1970-01-01T00:00:00.000Z\",\r\n            \"end_time_in_millis\": 0,\r\n            \"duration_in_millis\": -1519344013754,\r\n            \"failures\": [],\r\n            \"shards\": {\r\n                \"total\": 0,\r\n                \"failed\": 0,\r\n                \"successful\": 0\r\n            }\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n```\r\nGET _cluster/state\r\n\r\n{\r\n    \"snapshots\": {\r\n        \"snapshots\": [\r\n            {\r\n                \"repository\": \"repo-name\",\r\n                \"snapshot\": \"2018-02-23t00:00:00.000z\",\r\n                \"uuid\": \"YtXSACL5Tm-kPadJ1I8JOw\",\r\n                \"include_global_state\": true,\r\n                \"partial\": false,\r\n                \"state\": \"ABORTED\",\r\n                \"indices\": [ ... ],\r\n                \"start_time_millis\": 1519344013754,\r\n                \"repository_state_id\": 54,\r\n                \"shards\": [\r\n                    {\r\n                        \"index\": {\r\n                            \"index_name\": \"some_index\",\r\n                            \"index_uuid\": \"IDRyEj-lTSmr7imXFqdkgQ\"\r\n                        },\r\n                        \"shard\": 61,\r\n                        \"state\": \"FAILED\",\r\n                        \"node\": \"0sAovqveTv6q70IqfpYGDQ\"\r\n                    },\r\n                    {\r\n                        \"index\": {\r\n                            \"index_name\": \"some_index\",\r\n                            \"index_uuid\": \"IDRyEj-lTSmr7imXFqdkgQ\"\r\n                        },\r\n                        \"shard\": 269,\r\n                        \"state\": \"ABORTED\",\r\n                        \"node\": \"arLNOMBtRnSu_dMZMxVxiw\"\r\n                    }\r\n                ]\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nOnly log statements I could find about one of the affected shards are:\r\n\r\n```\r\n[2018-02-23T17:43:22,336][WARN ][o.e.c.s.ClusterApplierService] [host_a] cluster state applier task [indices_store ([[some_index][61]] active fully on other nodes)] took [57.8s] above the warn threshold of 30s\r\n[2018-02-23T17:41:13,470][WARN ][o.e.a.b.TransportShardBulkAction] [host_b] [[some_index][61]] failed to perform indices:data/write/bulk[s] on replica [some_index][61], node[86N5Eln9SsOj4f58HTaJzQ], relocating [0sAovqveTv6q70IqfpYGDQ], [P], recovery_source[peer recovery], s[INITIALIZING], a[id=uAJap9BDTTyTUL2iDhx9aA, rId=JNI46MMfQBaTKQkFrb5Rkg], expected_shard_size[74700244115]\r\n```\r\n\r\nThe cluster state says the snapshot was ABORTED since two of the shards in one of the indexes were marked as ABORTED.\r\n\r\nI have ran hot_threads with threads=1000 across all nodes and I cannot find any indication of the snapshot running. I cannot find any references to snapshots in `_tasks`.","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}