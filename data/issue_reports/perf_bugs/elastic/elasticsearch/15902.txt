{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15902","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15902/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15902/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15902/events","html_url":"https://github.com/elastic/elasticsearch/issues/15902","id":126038389,"node_id":"MDU6SXNzdWUxMjYwMzgzODk=","number":15902,"title":"histogram query results a deadlock in elasticsearch","user":{"login":"puneetjaiswal","id":1412516,"node_id":"MDQ6VXNlcjE0MTI1MTY=","avatar_url":"https://avatars1.githubusercontent.com/u/1412516?v=4","gravatar_id":"","url":"https://api.github.com/users/puneetjaiswal","html_url":"https://github.com/puneetjaiswal","followers_url":"https://api.github.com/users/puneetjaiswal/followers","following_url":"https://api.github.com/users/puneetjaiswal/following{/other_user}","gists_url":"https://api.github.com/users/puneetjaiswal/gists{/gist_id}","starred_url":"https://api.github.com/users/puneetjaiswal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/puneetjaiswal/subscriptions","organizations_url":"https://api.github.com/users/puneetjaiswal/orgs","repos_url":"https://api.github.com/users/puneetjaiswal/repos","events_url":"https://api.github.com/users/puneetjaiswal/events{/privacy}","received_events_url":"https://api.github.com/users/puneetjaiswal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-01-11T21:17:07Z","updated_at":"2016-01-12T10:42:02Z","closed_at":"2016-01-12T10:42:02Z","author_association":"NONE","active_lock_reason":null,"body":"ElasticSearch version 1.7.3 running with Oracle Java 8.\n\nWhen ran this query \n\n```\n {\n  \"size\" : 1000,\n  \"query\" : {\n    \"range\" : {\n      \"eventTimestamp\" : {\n        \"from\" : 1452543896208,\n        \"to\" : 1452544796208,\n        \"include_lower\" : true,\n        \"include_upper\" : true\n      }\n    }\n  },\n  \"aggregations\" : {\n    \"/series(eventtimestamp)\" : {\n      \"date_histogram\" : {\n        \"field\" : \"eventTimestamp\",\n        \"interval\" : \"10ms\",\n        \"min_doc_count\" : 0,\n        \"order\" : {\n          \"_key\" : \"asc\"\n        },\n        \"extended_bounds\" : {\n          \"min\" : 0,\n          \"max\" : 1452544262018\n        }\n      }\n    }\n  }\n}\n```\n\nElasticSearch froze and observed a possible deadlock using yourkit. Filter is selected for 15 mins on a interval of 10ms. \n<img width=\"1380\" alt=\"screen shot 2016-01-11 at 12 51 11 pm\" src=\"https://cloud.githubusercontent.com/assets/1412516/12246831/96db4156-b865-11e5-9dce-670d5f87012e.png\">\n\nAlthough min/max diff is unrealistically huge, ES should simply timeout.\n\nNow I replaced min max diff to reasonably low value but not within the filter range. ES still freezes. \n\n```\n {\n  \"size\" : 1000,\n  \"query\" : {\n    \"range\" : {\n      \"eventTimestamp\" : {\n        \"from\" : 1452552455074,\n        \"to\" : 1452552755074,\n        \"include_lower\" : true,\n        \"include_upper\" : true\n      }\n    }\n  },\n  \"aggregations\" : {\n    \"/series(eventtimestamp)\" : {\n      \"date_histogram\" : {\n        \"field\" : \"eventTimestamp\",\n        \"interval\" : \"10ms\",\n        \"min_doc_count\" : 0,\n        \"order\" : {\n          \"_key\" : \"asc\"\n        },\n        \"extended_bounds\" : {\n          \"min\" : 210,\n          \"max\" : 1000\n        }\n      }\n    }\n  }\n}\n```\n\n![heapusage](https://cloud.githubusercontent.com/assets/1412516/12249272/89c2371e-b873-11e5-9cf4-e8a732e7b192.png)\n<img width=\"589\" alt=\"cpuusage\" src=\"https://cloud.githubusercontent.com/assets/1412516/12249279/96c3ebe2-b873-11e5-9dbf-f81ad977e1e0.png\">\n[es_deadlock_histogram_stackdump.txt](https://github.com/elastic/elasticsearch/files/86527/es_deadlock_histogram_stackdump.txt)\n\nIdeally elasticsearch should only return buckets with overlapping range from filter (or range present in output result set) and input min/max bounds.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}