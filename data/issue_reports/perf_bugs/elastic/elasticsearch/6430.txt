{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6430","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6430/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6430/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6430/events","html_url":"https://github.com/elastic/elasticsearch/issues/6430","id":35146871,"node_id":"MDU6SXNzdWUzNTE0Njg3MQ==","number":6430,"title":"Stuck on shard recovery, NPE in _recovery API","user":{"login":"magnhaug","id":477436,"node_id":"MDQ6VXNlcjQ3NzQzNg==","avatar_url":"https://avatars0.githubusercontent.com/u/477436?v=4","gravatar_id":"","url":"https://api.github.com/users/magnhaug","html_url":"https://github.com/magnhaug","followers_url":"https://api.github.com/users/magnhaug/followers","following_url":"https://api.github.com/users/magnhaug/following{/other_user}","gists_url":"https://api.github.com/users/magnhaug/gists{/gist_id}","starred_url":"https://api.github.com/users/magnhaug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/magnhaug/subscriptions","organizations_url":"https://api.github.com/users/magnhaug/orgs","repos_url":"https://api.github.com/users/magnhaug/repos","events_url":"https://api.github.com/users/magnhaug/events{/privacy}","received_events_url":"https://api.github.com/users/magnhaug/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-06-06T13:47:55Z","updated_at":"2014-10-15T11:39:19Z","closed_at":"2014-10-15T11:39:19Z","author_association":"NONE","active_lock_reason":null,"body":"I'm running a cluster of 5 nodes. After a normal reboot, recovery of certain shards started as normally. However, one of the replica shards doing recovery stopped when it had reached a shard size of about 233MB, out of the 1.4GB total shard size on the primary shard.\n\nHere's what I've found out so far:\n- Shards might stop mid-recovery on any size. 0 bytes, a few KB, or several GB.\n- Shards stopped mid-recovery might even report a higher size_in_bytes than the primary shard.\n- Shards of any size might experience this (smalles index: 2 very small documents, biggest: millions of large documents).\n- The translog was empty for all shards on the sick node.\n- Accessing the `_recovery` API on any node in the cluster produces a `{\"error\":\"NullPointerException[null]\",\"status\":500}` (verified multiple times). No NPE in a healthy cluster.\n- Even with a log level of TRACE there's no info in the logs, even after the NPE.\n- Waiting for hours does not seem to fix anything.\n- Rebooting the node with the shard stuck on recovery fixes it (another node tries, and most often succeeds).\n- Observed on ElasticSearch 1.1.1 and 1.1.2 on RHEL 6.5 with Sun Java 1.7.0_55. Not observed in the same cluster configuration when running 0.90.x or 0.20.x.\n\nOutput from `_cat/recovery/` on my index:\n\n```\ncurl \"tsl0mag19:2500/_cat/recovery/meta\"\nmeta 0 2332847 replica init n/a                tsl0mag15.skead.no n/a n/a 0 0.0%   0    0.0%\nmeta 0 17687   replica done tsl0mag16.skead.no tsl0mag18.skead.no n/a n/a 1 100.0% 7286 100.0%\nmeta 0 3634    replica done tsl0mag19.skead.no tsl0mag16.skead.no n/a n/a 9 100.0% 7286 100.0%\n```\n\nThe segments have not yet been created/registered:\n\n```\ncurl \"tsl0mag19:2500/_cat/segments/meta\"\nmeta 0 r 151.187.99.218 _7lhu 354450 1 3 3.6kb 443 true  true  4.7 true\nmeta 0 r 151.187.99.218 _ajjy 491902 4 3 3.4kb   0 true  false 4.7 true\nmeta 0 r 151.187.99.218 _ajp5 492089 1 2 3.3kb 442 false true  4.7 true\nmeta 0 p 151.187.99.216 _7lhu 354450 1 3 3.6kb 443 true  true  4.7 true\nmeta 0 p 151.187.99.216 _ajk4 491908 1 0 2.9kb   0 true  false 4.7 true\nmeta 0 p 151.187.99.216 _ajpm 492106 1 0 2.9kb 442 false true  4.7 true\n```\n\nHere is the stack trace from the ElasticSearch process that should be recovering this shard:\nhttps://gist.github.com/magnhaug/11fa5750fe76a6adca4b\n\nHere are the contents from the `indices` folder:\nhttps://dl.dropboxusercontent.com/u/233260280/unhealthy_shard.tar.gz (problematic shard)\nhttps://dl.dropboxusercontent.com/u/233260280/healthy_shard.tar.gz (primary shard, for reference)\n\nThis is how a sample stuck shard looks in HEAD:\n\n```\n{\n  routing: {\n    state: INITIALIZING\n    primary: false\n    node: 85EJGc_1RjyZMBuc2QluCw\n    relocating_node: null\n    shard: 0\n  i  ndex: meta\n}\n  state: RECOVERING\n  index: {\n    size_in_bytes: 3566\n  }\n}\n```\n\nThis was recovering from the following primary shard:\n\n```\n{\n  routing: {\n    state: STARTED\n    primary: true\n    node: ZrYUKHXZSFaftExxueYo3w\n    relocating_node: null\n    shard: 0\n    index: meta\n}\n  state: STARTED\n  index: {\n    size_in_bytes: 10489\n  }\n  translog: {\n    id: 1401785020764\n    operations: 805\n  }\n  docs: {\n    num_docs: 2\n    max_doc: 5\n    deleted_docs: 3\n  }\n  merges: {\n    current: 0\n    current_docs: 0\n    current_size_in_bytes: 0\n    total: 0\n    total_time_in_millis: 0\n    total_docs: 0\n    total_size_in_bytes: 0\n  }\n  refresh: {\n    total: 263\n    total_time_in_millis: 2145\n  }\n  flush: {\n    total: 0\n    total_time_in_millis: 0\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}