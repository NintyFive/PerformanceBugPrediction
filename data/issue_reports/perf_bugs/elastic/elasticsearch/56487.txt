{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/56487","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56487/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56487/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56487/events","html_url":"https://github.com/elastic/elasticsearch/issues/56487","id":615164753,"node_id":"MDU6SXNzdWU2MTUxNjQ3NTM=","number":56487,"title":"Multi-bucket aggregator wrapper is slow and uses a ton of memory","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":108108556,"node_id":"MDU6TGFiZWwxMDgxMDg1NTY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/release%20highlight","name":"release highlight","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-05-09T12:18:41Z","updated_at":"2020-10-08T12:13:10Z","closed_at":"2020-07-20T14:53:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Before 7.9.0 many of our more complex aggregations made a simplifying assumption that required that they duplicate many data structures once per bucket that contained them. The most expensive of these weighed in at a couple of kilobytes each. So for an aggregation like:\r\n```\r\nPOST _search\r\n{\r\n  \"aggs\": {\r\n    \"date\": {\r\n      \"date_histogram\": { \"field\": \"timestamp\", \"calendar_interval\": \"day\" },\r\n      \"aggs\": {\r\n        \"ips\": {\r\n          \"terms\": { \"field\": \"ip\" }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWhen run over three years spends a couple of megabytes just on bucket accounting. More deeply nested aggregations spend even more on this overhead. And 7.9.0 removes all of it which should allow us to run better in lower memory environments.\r\n\r\nAs a bonus we wrote quite a few Rally [benchmarks](https://github.com/elastic/rally-tracks/) for aggs to make sure that these tests didn't slow down aggregations. So we can think much more scientifically about aggregation performance. The benchmarks suggest that these changes don't affect simple aggregation trees and speed up complex aggregation trees of similar or higher depth than the example above. Your actual performance changes will vary but it this should help! :crossed_fingers:  \r\n\r\nEDIT:\r\nEverything above the EDIT mark was added when I tagged this `release highlight` so it could be more easily understood in context.\r\n\r\n#55873 removed the \"multi-bucket wrapper\" from the numeric terms aggregator and showed that we can get a pretty substantial performance improvement in some common aggregation requests. This will track work to remove the wrapper for other aggregations because:\r\n1. I expect we can get a similar or better performance improvement for each one.\r\n2. The wrapper makes it very difficult to reason about aggregations.\r\n3. This will give us a good excuse to add rally tracks for these aggregations.\r\n\r\n* [x] string `terms`  (#57207 + #57361 #57397 + #57438 + #57758)\r\n* [x] `significant_terms` (#56789 + #57207 + #57361 + #57397 + #57438 + #57758)\r\n* [x] `rare_terms` (#57948)\r\n* [x] `date_histogram` (#56921)\r\n* [x] `auto_date_histogram` (#57304)\r\n* [x] `histogram` (#57277)\r\n* [x] `parent` (#57490 + #57892)\r\n* [x] `child` (#57490 + #57892)\r\n* [x] `geohash_grid` (#57483)\r\n* [x] `geotile_grid` (#57483)\r\n* [x] `scripted_metric` (#57627)\r\n* [x] `significant_text` (#57903  + #58145)\r\n\r\nAfter this is all done we can:\r\n* [x] Remove `significant_terms`'s \"funny\" reference back to its factory for caching. We won't need it because they'll only ever be one aggregator so it can cache. (#57903)\r\n* [x] ~~Look into non-`BigArrays` backed memory usage in aggs. This is more important now that we don't get the 5k \"artificial\" value added to the breaker per bucket.~~ Moved to #59892\r\n* [x] Replace `descendsFromBucketAggregator(parent)` with `collectsFromSingleBucket`. (#58571)\r\n* [x] Look into replacing \"lego-ed\" data structures with purpose built ones. (7.10: #59740)","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}