{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36929","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36929/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36929/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36929/events","html_url":"https://github.com/elastic/elasticsearch/issues/36929","id":393373324,"node_id":"MDU6SXNzdWUzOTMzNzMzMjQ=","number":36929,"title":"Slow-recovering primaries can prevent allocation of other primaries","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-21T08:54:52Z","updated_at":"2019-01-17T23:15:20Z","closed_at":"2018-12-21T09:11:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Today the `cluster.routing.allocation.node_initial_primaries_recoveries` setting limits the number of recoveries of a primary shard on each node. This limit applies to (amongst other things) the number of shards restoring from a snapshot on a node as well as the number of freshly-created primary shards. It's possible that Elasticsearch may have allocated more than `node_initial_primaries_recoveries` (default 4) shards of an index onto a single node, meaning that no new primaries can be allocated to this node until at least one shard has been restored. This could take quite some time.\r\n\r\nPrior to #36397 it seems unlikely that more than 4 primaries would be restoring on a single node, but now we can perform concurrent restores it seems much more likely that users will hit this limit in practice. Imagine restoring a month's worth of daily indices into a cluster receiving today's indexing traffic too.\r\n\r\nThe effect of hitting this limit is that new indices will be created but perhaps not allocated. The cluster health will be yellow (because the indices are new) and yet attempts to index into those new indices will time out.\r\n\r\nI think the answer to this question is no:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/022726011ce1d9e4748fd39293a3aeae6954b3ac/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/ThrottlingAllocationDecider.java#L131\r\n\r\nHowever even if the answer is yes, I think we should throttle them separately from snapshot restores.","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}