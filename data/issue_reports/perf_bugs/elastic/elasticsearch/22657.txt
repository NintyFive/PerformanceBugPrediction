{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22657/events","html_url":"https://github.com/elastic/elasticsearch/issues/22657","id":201294847,"node_id":"MDU6SXNzdWUyMDEyOTQ4NDc=","number":22657,"title":"Exists filters have bad performance","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2017-01-17T14:07:59Z","updated_at":"2017-03-31T11:59:36Z","closed_at":"2017-03-31T11:59:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: Elasticsearch 5.1\r\n\r\n**Plugins installed**: -]\r\n\r\n**JVM version**: Any\r\n\r\n**OS version**: Any\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIn 2.x the the missing query has been deprecated, and one should use and _exists query_ inside a _must_not_ clause. In 5.1 the only option is to use the exists query in a must not.\r\n\r\nDoing some tests, i noticed that the execution of the bool with a must not is not performing as good as one expects. \r\n\r\nThe test is the following:\r\n\r\n1. Multiple types included\r\n2. More than 10 million documents\r\n3. And the following query:\r\n\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"BOOL_FIELD1\": false\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"DATE_FIELD2\": {\r\n              \"lte\": \"2017-01-01\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"should\": [\r\n        {\r\n          \"bool\": {\r\n            \"must_not\": {\r\n              \"exists\": {\r\n                \"field\": \"DATE_FIELD1\"\r\n              }\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"DATE_FIELD1\": {\r\n              \"gt\": \"2017-01-01\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\nThe profiler shows that at some point inside the `bool>must_not` we are doing an expensive match_all clause:\r\n\r\n```\r\n\"query\": [\r\n    {\r\n        \"type\": \"BooleanQuery\",\r\n        \"description\": \"+((-ConstantScore(_field_names:DATE_FIELD1) +*:*) DATE_FIELD1:[1483315200000 TO 9223372036854775807] #BOOL_FIELD1:F #DATE_FIELD2:[-9223372036854775808 TO 1483315199999]) #(ConstantScore(_type:TYPE_1))^0.0\",\r\n        \"time\": \"3951.448731ms\",\r\n        \"breakdown\": {\r\n            \"score\": 2310059550,\r\n            \"build_scorer_count\": 27,\r\n            \"match_count\": 0,\r\n            \"create_weight\": 587195,\r\n            \"next_doc\": 1629358099,\r\n            \"match\": 0,\r\n            \"create_weight_count\": 1,\r\n            \"next_doc_count\": 3489324,\r\n            \"score_count\": 3489319,\r\n            \"build_scorer\": 4465216,\r\n            \"advance\": 0,\r\n            \"advance_count\": 0\r\n        },\r\n        \"children\": [\r\n            {\r\n                \"type\": \"BooleanQuery\",\r\n                \"description\": \"(-ConstantScore(_field_names:DATE_FIELD1) +*:*) DATE_FIELD1:[1483315200000 TO 9223372036854775807] #BOOL_FIELD1:F #DATE_FIELD2:[-9223372036854775808 TO 1483315199999]\",\r\n                \"time\": \"2716.687540ms\",\r\n                \"breakdown\": {\r\n                    \"score\": 1977436672,\r\n                    \"build_scorer_count\": 27,\r\n                    \"match_count\": 0,\r\n                    \"create_weight\": 513144,\r\n                    \"next_doc\": 0,\r\n                    \"match\": 0,\r\n                    \"create_weight_count\": 1,\r\n                    \"next_doc_count\": 0,\r\n                    \"score_count\": 3489319,\r\n                    \"build_scorer\": 4299218,\r\n                    \"advance\": 727459835,\r\n                    \"advance_count\": 3489324\r\n                },\r\n                \"children\": [\r\n                    {\r\n                        \"type\": \"BooleanQuery\",\r\n                        \"description\": \"-ConstantScore(_field_names:DATE_FIELD1) +*:*\",\r\n                        \"time\": \"1121.160176ms\",\r\n                        \"breakdown\": {\r\n                            \"score\": 384220941,\r\n                            \"build_scorer_count\": 27,\r\n                            \"match_count\": 3493583,\r\n                            \"create_weight\": 484754,\r\n                            \"next_doc\": 44583944,\r\n                            \"match\": 294190414,\r\n                            \"create_weight_count\": 1,\r\n                            \"next_doc_count\": 362672,\r\n                            \"score_count\": 3126806,\r\n                            \"build_scorer\": 1680096,\r\n                            \"advance\": 385886027,\r\n                            \"advance_count\": 3130911\r\n                        },\r\n                        \"children\": [\r\n                            {\r\n                                \"type\": \"ConstantScoreQuery\", <---------- This is the missing clause\r\n                                \"description\": \"ConstantScore(_field_names:DATE_FIELD1)\", \r\n                                \"time\": \"45.20257600ms\",\r\n                                \"breakdown\": {\r\n                                    \"score\": 0,\r\n                                    \"build_scorer_count\": 27,\r\n                                    \"match_count\": 0,\r\n                                    \"create_weight\": 462958,\r\n                                    \"next_doc\": 0,\r\n                                    \"match\": 0,\r\n                                    \"create_weight_count\": 1,\r\n                                    \"next_doc_count\": 0,\r\n                                    \"score_count\": 0,\r\n                                    \"build_scorer\": 1214111,\r\n                                    \"advance\": 43162585,\r\n                                    \"advance_count\": 362894\r\n                                },\r\n                                \"children\": [\r\n                                    {\r\n                                        \"type\": \"TermQuery\",\r\n                                        \"description\": \"_field_names:DATE_FIELD1\",\r\n                                        \"time\": \"17.49171500ms\",\r\n                                        \"breakdown\": {\r\n                                            \"score\": 0,\r\n                                            \"build_scorer_count\": 27,\r\n                                            \"match_count\": 0,\r\n                                            \"create_weight\": 21463,\r\n                                            \"next_doc\": 0,\r\n                                            \"match\": 0,\r\n                                            \"create_weight_count\": 1,\r\n                                            \"next_doc_count\": 0,\r\n                                            \"score_count\": 0,\r\n                                            \"build_scorer\": 399236,\r\n                                            \"advance\": 16708094,\r\n                                            \"advance_count\": 362894\r\n                                        }\r\n                                    }\r\n                                ]\r\n                            },\r\n                            {\r\n                                \"type\": \"MatchAllDocsQuery\",    <---------- HERE , matching all documents.\r\n                                \"description\": \"*:*\",\r\n                                \"time\": \"301.1009210ms\",\r\n                                \"breakdown\": {\r\n                                    \"score\": 115027006,\r\n                                    \"build_scorer_count\": 27,\r\n                                    \"match_count\": 0,\r\n                                    \"create_weight\": 1391,\r\n                                    \"next_doc\": 18151692,\r\n                                    \"match\": 0,\r\n                                    \"create_weight_count\": 1,\r\n                                    \"next_doc_count\": 362672,\r\n                                    \"score_count\": 3126806,\r\n                                    \"build_scorer\": 18448,\r\n                                    \"advance\": 161281967,\r\n                                    \"advance_count\": 3130911\r\n                                }\r\n                            }\r\n                        ]\r\n                    },\r\n                    {\r\n                        \"type\": \"\",\r\n                        \"description\": \"DATE_FIELD1:[1483315200000 TO 9223372036854775807]\",\r\n                        \"time\": \"0.9628580000ms\",\r\n                        \"breakdown\": {\r\n                            \"score\": 1856,\r\n                            \"build_scorer_count\": 27,\r\n                            \"match_count\": 0,\r\n                            \"create_weight\": 2788,\r\n                            \"next_doc\": 0,\r\n                            \"match\": 0,\r\n                            \"create_weight_count\": 1,\r\n                            \"next_doc_count\": 0,\r\n                            \"score_count\": 6,\r\n                            \"build_scorer\": 899073,\r\n                            \"advance\": 59093,\r\n                            \"advance_count\": 14\r\n                        }\r\n                    },\r\n                    {\r\n                        \"type\": \"TermQuery\",\r\n                        \"description\": \"BOOL_FIELD1:F\",\r\n                        \"time\": \"146.7007190ms\",\r\n                        \"breakdown\": {\r\n                            \"score\": 0,\r\n                            \"build_scorer_count\": 27,\r\n                            \"match_count\": 0,\r\n                            \"create_weight\": 2866,\r\n                            \"next_doc\": 0,\r\n                            \"match\": 0,\r\n                            \"create_weight_count\": 1,\r\n                            \"next_doc_count\": 0,\r\n                            \"score_count\": 0,\r\n                            \"build_scorer\": 181639,\r\n                            \"advance\": 143026853,\r\n                            \"advance_count\": 3489333\r\n                        }\r\n                    },\r\n                    {\r\n                        \"type\": \"\",\r\n                        \"description\": \"DATE_FIELD2:[-9223372036854775808 TO 1483315199999]\",\r\n                        \"time\": \"139.4384300ms\",\r\n                        \"breakdown\": {\r\n                            \"score\": 0,\r\n                            \"build_scorer_count\": 26,\r\n                            \"match_count\": 0,\r\n                            \"create_weight\": 1177,\r\n                            \"next_doc\": 0,\r\n                            \"match\": 0,\r\n                            \"create_weight_count\": 1,\r\n                            \"next_doc_count\": 0,\r\n                            \"score_count\": 0,\r\n                            \"build_scorer\": 654853,\r\n                            \"advance\": 135293049,\r\n                            \"advance_count\": 3489324\r\n                        }\r\n                    }\r\n                ]\r\n            },\r\n            {\r\n                \"type\": \"BoostQuery\",\r\n                \"description\": \"(ConstantScore(_type:TYPE_1))^0.0\",\r\n                \"time\": \"442.0722720ms\",\r\n                \"breakdown\": {\r\n                    \"score\": 0,\r\n                    \"build_scorer_count\": 26,\r\n                    \"match_count\": 0,\r\n                    \"create_weight\": 9132,\r\n                    \"next_doc\": 436935469,\r\n                    \"match\": 0,\r\n                    \"create_weight_count\": 1,\r\n                    \"next_doc_count\": 3489324,\r\n                    \"score_count\": 0,\r\n                    \"build_scorer\": 56264,\r\n                    \"advance\": 1572452,\r\n                    \"advance_count\": 9604\r\n                },\r\n                \"children\": [\r\n                    {\r\n                        \"type\": \"TermQuery\",\r\n                        \"description\": \"_type:TYPE_1\",\r\n                        \"time\": \"189.9574780ms\",\r\n                        \"breakdown\": {\r\n                            \"score\": 0,\r\n                            \"build_scorer_count\": 26,\r\n                            \"match_count\": 0,\r\n                            \"create_weight\": 2575,\r\n                            \"next_doc\": 185530777,\r\n                            \"match\": 0,\r\n                            \"create_weight_count\": 1,\r\n                            \"next_doc_count\": 3489324,\r\n                            \"score_count\": 0,\r\n                            \"build_scorer\": 40296,\r\n                            \"advance\": 884875,\r\n                            \"advance_count\": 9604\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        ]\r\n    }\r\n],\r\n```\r\n\r\nSo it looks like either we are doing not-necessary steps when using the Exists inside a bool, or we should bring back a \"missing\" that knows that it should do a Match all. Filtering by type is taking a similar time than doing a `must_not>exists`.\r\n\r\nOpening this to discuss whether: \r\n\r\n1. Do we need to bring back the Missing filter/query?\r\n2. Is there something that we should do/recommend apart from doing `must_not>exists`?\r\n\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}