{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11599","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11599/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11599/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11599/events","html_url":"https://github.com/elastic/elasticsearch/issues/11599","id":87333926,"node_id":"MDU6SXNzdWU4NzMzMzkyNg==","number":11599,"title":"Kibana highlighting issue not fixed?","user":{"login":"jimmyjones2","id":2991805,"node_id":"MDQ6VXNlcjI5OTE4MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/2991805?v=4","gravatar_id":"","url":"https://api.github.com/users/jimmyjones2","html_url":"https://github.com/jimmyjones2","followers_url":"https://api.github.com/users/jimmyjones2/followers","following_url":"https://api.github.com/users/jimmyjones2/following{/other_user}","gists_url":"https://api.github.com/users/jimmyjones2/gists{/gist_id}","starred_url":"https://api.github.com/users/jimmyjones2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimmyjones2/subscriptions","organizations_url":"https://api.github.com/users/jimmyjones2/orgs","repos_url":"https://api.github.com/users/jimmyjones2/repos","events_url":"https://api.github.com/users/jimmyjones2/events{/privacy}","received_events_url":"https://api.github.com/users/jimmyjones2/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"assignees":[{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2015-06-11T12:44:16Z","updated_at":"2015-08-28T17:03:15Z","closed_at":"2015-06-25T10:36:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"New 1.6.0 install with new indices, in Kibana discover searching for \"execute\":\n\n```\n[2015-06-11 13:18:59,718][DEBUG][action.search.type       ] [Laura Dean] [29] Failed to execute fetch phase\norg.elasticsearch.search.fetch.FetchPhaseExecutionException: [logstash-2015.06.11][4]: query[filtered(_all:execute)->BooleanFilter(+cache(@timestamp:[1433938739612 TO 1434025139612]\n))],from[0],size[500],sort[<custom:\"@timestamp\": org.elasticsearch.index.fielddata.fieldcomparator.LongValuesComparatorSource@31c250a5>!]: Fetch Failed [Failed to highlight field [m\nessage.raw]]\n        at org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:133)\n        at org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:133)\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:194)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:504)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$17.call(SearchServiceTransportAction.java:452)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$17.call(SearchServiceTransportAction.java:449)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.RuntimeException: org.apache.lucene.util.BytesRefHash$MaxBytesLengthExceededException: bytes can be at most 32766 in length; got 173493\n        at org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:493)\n        at org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:396)\n        at org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:371)\n        at org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:351)\n        at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getLeafContext(WeightedSpanTermExtractor.java:360)\n        at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:216)\n        at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getWeightedSpanTerms(WeightedSpanTermExtractor.java:474)\n        at org.apache.lucene.search.highlight.QueryScorer.initExtractor(QueryScorer.java:217)\n        at org.apache.lucene.search.highlight.QueryScorer.init(QueryScorer.java:186)\n        at org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:197)\n        at org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:119)\n        ... 9 more\nCaused by: org.apache.lucene.util.BytesRefHash$MaxBytesLengthExceededException: bytes can be at most 32766 in length; got 173493\n        at org.apache.lucene.util.BytesRefHash.add(BytesRefHash.java:284)\n        at org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:467)\n        ... 19 more\n```\n\nI thought this was fixed in #9881 - but for some reason ES is still trying to highlight message.raw which is not_analyzed. The comment in the Kibana issue https://github.com/elastic/kibana/issues/2782#issuecomment-105224019 says that long terms shouldn't get into the index and not_analyzed should be skipped - but neither seem to be happening here.\n\nReproduction in this [gist](https://gist.github.com/jimmyjones2/0be6664a471a30b2e624) then add index to Kibana and in discover search for \"execute\". My original setup involves Elasticsearch sending its own logs to logstash via log4j socket, then ingesting into another elasticsearch instance - can include details here if needed.\n","closed_by":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"performed_via_github_app":null}