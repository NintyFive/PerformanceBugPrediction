{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11457","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11457/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11457/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11457/events","html_url":"https://github.com/elastic/elasticsearch/issues/11457","id":84043520,"node_id":"MDU6SXNzdWU4NDA0MzUyMA==","number":11457,"title":"AggregationBuilder renders incorrect JSON when using binary or raw sub-aggregation","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":204320058,"node_id":"MDU6TGFiZWwyMDQzMjAwNTg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.5.3","name":"v1.5.3","color":"dddddd","default":false,"description":null},{"id":182334038,"node_id":"MDU6TGFiZWwxODIzMzQwMzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.6.0","name":"v1.6.0","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-06-02T14:15:07Z","updated_at":"2015-06-04T11:59:24Z","closed_at":"2015-06-04T11:59:22Z","author_association":"MEMBER","active_lock_reason":null,"body":"Bug found from a forum post: https://discuss.elastic.co/t/problem-with-binary-sub-aggregations/1727\n\nUsing the below code to embed a sub-aggregation inside another aggregation:\n\n``` java\nimport org.elasticsearch.common.xcontent.ToXContent;\nimport org.elasticsearch.common.xcontent.XContentBuilder;\nimport org.elasticsearch.common.xcontent.XContentHelper;\nimport org.elasticsearch.common.xcontent.json.JsonXContent;\nimport org.elasticsearch.search.aggregations.AggregationBuilders;\nimport org.elasticsearch.search.aggregations.bucket.terms.TermsBuilder;\nimport java.io.IOException;\n\npublic class TestSubAggregation {\n\n    public static void main(String[] args) throws IOException {\n        // Build a simple term aggregation\n\n        TermsBuilder termsBuilder = AggregationBuilders.terms(\"test\").field(\"testfield\");\n\n        // Build a simple term sub aggregation\n        TermsBuilder subTerm = AggregationBuilders.terms(\"subtest\").field(\"subtestfield\");\n\n        // Add sub aggregation as an AggregationBuilder\n        termsBuilder.subAggregation(subTerm);\n        // It produces a correct output\n        System.out.println(XContentHelper.toString(termsBuilder));\n\n        // Reset term aggregation\n        termsBuilder = AggregationBuilders.terms(\"test\").field(\"testfield\");\n\n        // Create an XContentBuilder from sub aggregation\n        XContentBuilder subTermContentBuilder = JsonXContent.contentBuilder().startObject();\n        subTerm.toXContent(subTermContentBuilder, ToXContent.EMPTY_PARAMS);\n        subTermContentBuilder.endObject();\n\n        // Add sub aggregation as a XContentBuilder (binary_aggregation)\n        termsBuilder.subAggregation(subTermContentBuilder);\n\n        // Produces an incorrect output (two aggregations levels instead of one)\n        System.out.println(XContentHelper.toString(termsBuilder));\n\n    }\n}\n```\n\nThe second sysout produces:\n\n``` json\n{\n  \"test\" : {\n    \"terms\" : {\n      \"field\" : \"testfield\"\n    },\n    \"aggregations\" : {\n      \"aggregations\":{\"subtest\":{\"terms\":{\"field\":\"subtestfield\"}}}\n    }\n  }\n}\n```\n\nWhich is invalid as `aggregations` object is specified twice.\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}