{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11882","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11882/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11882/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11882/events","html_url":"https://github.com/elastic/elasticsearch/issues/11882","id":91078816,"node_id":"MDU6SXNzdWU5MTA3ODgxNg==","number":11882,"title":"TTL recalculated on upsert","user":{"login":"ronlepper","id":13055650,"node_id":"MDQ6VXNlcjEzMDU1NjUw","avatar_url":"https://avatars0.githubusercontent.com/u/13055650?v=4","gravatar_id":"","url":"https://api.github.com/users/ronlepper","html_url":"https://github.com/ronlepper","followers_url":"https://api.github.com/users/ronlepper/followers","following_url":"https://api.github.com/users/ronlepper/following{/other_user}","gists_url":"https://api.github.com/users/ronlepper/gists{/gist_id}","starred_url":"https://api.github.com/users/ronlepper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronlepper/subscriptions","organizations_url":"https://api.github.com/users/ronlepper/orgs","repos_url":"https://api.github.com/users/ronlepper/repos","events_url":"https://api.github.com/users/ronlepper/events{/privacy}","received_events_url":"https://api.github.com/users/ronlepper/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"assignees":[{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-06-25T21:21:15Z","updated_at":"2016-05-12T12:55:44Z","closed_at":"2016-05-12T12:55:44Z","author_association":"NONE","active_lock_reason":null,"body":"We are currently running into an issue with ttl and upserts (using doc_as_upsert).  It looks like the ttl is being recalulated when we perform an upsert that does not update _ttl or _timestamp.\n\nHere is the command to create the mapping we are using to test this:\n\n```\ncurl -XPUT localhost:9200/timetolive -d'{\n\"mappings\": {\n    \"test\": {\n        \"_ttl\": {\n            \"enabled\" : true\n        },\n        \"_timestamp\": {\n            \"enabled\" : true, \n            \"format\":\"basic_date_time\",\n            \"path\":\"post_date\"\n        },\n\n        \"properties\": {\n            \"post_date\": {\n                \"type\": \"date\", \n                \"format\":\"basic_date_time\"\n            },\n            \"text\": {\n                \"type\": \"string\"\n            }\n        }\n    }\n}\n}'\n```\n\nThen insert a document with a ttl and a timestamp:\n\n```\ncurl -XPUT localhost:9200/timetolive/test/1 -d'{\n    \"text\" : \"Initial test\", \n    \"post_date\" : \"20150625T130000.000000-0700\", \n    \"_ttl\": \"20s\"\n}'\n```\n\nNext, update only the text field on the document: \n\n```\ncurl -XPOST localhost:9200/timetolive/test/1/_update -d'{\n    \"doc\" : {\n        \"text\" : \"Upsert text\"\n    },\n    \"doc_as_upsert\" : true \n}'\n```\n\nAfter the upsert, the ttl has now been extended.  It looks like is taking the calculated time to live (_ttl + timestamp - now) from the initial request and adding it to the stored timestamp when the upsert comes in. \n\nWe are running ElasticSearch version 1.5.2.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}