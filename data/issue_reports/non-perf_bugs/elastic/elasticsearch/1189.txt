{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1189","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1189/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1189/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1189/events","html_url":"https://github.com/elastic/elasticsearch/issues/1189","id":1323953,"node_id":"MDU6SXNzdWUxMzIzOTUz","number":1189,"title":"error when creating and deleting many indexes?","user":{"login":"bbgordonn","id":952080,"node_id":"MDQ6VXNlcjk1MjA4MA==","avatar_url":"https://avatars2.githubusercontent.com/u/952080?v=4","gravatar_id":"","url":"https://api.github.com/users/bbgordonn","html_url":"https://github.com/bbgordonn","followers_url":"https://api.github.com/users/bbgordonn/followers","following_url":"https://api.github.com/users/bbgordonn/following{/other_user}","gists_url":"https://api.github.com/users/bbgordonn/gists{/gist_id}","starred_url":"https://api.github.com/users/bbgordonn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbgordonn/subscriptions","organizations_url":"https://api.github.com/users/bbgordonn/orgs","repos_url":"https://api.github.com/users/bbgordonn/repos","events_url":"https://api.github.com/users/bbgordonn/events{/privacy}","received_events_url":"https://api.github.com/users/bbgordonn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2011-08-01T16:13:24Z","updated_at":"2013-04-05T13:46:00Z","closed_at":"2013-04-05T13:46:00Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The below Perl program for the bulk API fails non-deterministically after a few minutes during most runs. I've tried tinkering with a lot of the variables--refresh time, number of indexes, number of servers--to make this simpler to reproduce, but it's still a pretty complex case. Sorry.\n\nThe only other thing I've noticed is a lot of errors in the logs like:\n\n```\n[2011-08-01 11:47:35,224][WARN ][cluster.action.shard     ] [Mother Night] sending failed shard for [silly_9921][1], node[hHogDRzJRx-kK35d5FuCiQ], relocating [rXUNQERpSY6NrCwVgb3qvQ], [R], s[INITIALIZING], reason [Failed to start shard, message [RecoveryFailedException[Index Shard [silly_9921][1]: Recovery failed from [Anelle][aUg0SyLgQ8WeDeQhaW6KMw][inet[/10.2.75.191:9300]] into [Mother Night][hHogDRzJRx-kK35d5FuCiQ][inet[/10.2.75.193:9300]]]; nested: RemoteTransportException[[Anelle][inet[/10.2.75.191:9300]][index/shard/recovery/startRecovery]]; nested: RecoveryEngineException[[silly_9921][1] Phase[1] Execution failed]; nested: RecoverFilesRecoveryException[[silly_9921][1] Failed to transfer [1] files with total size of [58b]]; nested: FileNotFoundException[/var/lib/elasticsearch/elasticsearch/nodes/0/indices/silly_9921/1/index/segments_1 (No such file or directory):\nimpleFSDirectory.java:90)\n        at org.apache.lucene.store.NIOFSDirectory$NIOFSIndexInput.<init>(NIOFSDirectory.java:91)\n        at org.apache.lucene.store.NIOFSDirectory.openInput(NIOFSDirectory.java:78)\n        at org.apache.lucene.store.FSDirectory.openInput(FSDirectory.java:345)\n        at org.elasticsearch.index.store.support.AbstractStore$StoreDirectory.openInput(AbstractStore.java:328)\n        at org.elasticsearch.index.shard.recovery.RecoverySource$1$1.run(RecoverySource.java:162)\n        ... 3 more\n[2011-08-01 11:47:35,224][WARN ][cluster.action.shard     ] [Mother Night] sending failed shard for [silly_9921][1], node[hHogDRzJRx-kK35d5FuCiQ], relocating [rXUNQERpSY6NrCwVgb3qvQ], [R], s[INITIALIZING], reason [Failed to start shard, message [RecoveryFailedException[Index Shard [silly_9921][1]: Recovery failed from [Anelle][aUg0SyLgQ8WeDeQhaW6KMw][inet[/10.2.75.191:9300]] into [Mother Night][hHogDRzJRx-kK35d5FuCiQ][inet[/10.2.75.193:9300]]]; nested: RemoteTransportException[[Anelle][inet[/10.2.75.191:9300]][index/shard/recovery/startRecovery]]; nested: RecoveryEngineException[[silly_9921][1] Phase[1] Execution failed]; nested: RecoverFilesRecoveryException[[silly_9921][1] Failed to transfer [1] files with total size of [58b]]; nested: FileNotFoundException[/var/lib/elasticsearch/elasticsearch/nodes/0/indices/silly_9921/1/index/segments_1 (No such file or directory)]; ]]\n```\n\nThe error I get:\n\n```\n[ERROR] ** ElasticSearch::Error::Missing at lib/ElasticSearch/Transport/HTTPLite.pm line 56 :\nIndexMissingException[[silly_8089] missing]\n\nWith vars:{\n  'request' => {\n    'qs' => {},\n    'as_json' => undef,\n    'cmd' => '/_bulk',\n    'data' => \\'{\"index\":{\"_index\":\"silly_9901\",\"_id\":\"1311677474-91-19527-316-22\",\"_type\":\"eeee\"}}\n{\"id\":\"1311677474-91-19527-316-22\",\"domain id\":\"9901\"}\n{\"index\":{\"_index\":\"silly_8089\",\"_id\":\"1311677474-92-19527-316-22\",\"_type\":\"eeee\"}}\n{\"id\":\"1311677474-92-19527-316-22\",\"domain id\":\"8089\"}\n',\n    'method' => 'POST'\n  },\n  'status_code' => 404,\n  'server' => '10.2.75.191:9200',\n  'status_msg' => 'Not Found\n'\n}\n```\n\nThe program:\n\n``` perl\n#!/usr/bin/perl\nuse strict;\nuse warnings;\n\nuse Data::Dumper;\nuse ElasticSearch;\n\nmy $es = ElasticSearch->new(\n    'transport' => 'httplite',\n    'servers' =>  [\n        '10.2.75.191:9200',\n        '10.2.75.193:9200',\n        '10.2.72.64:9200',\n        '10.2.72.65:9200',\n    ],\n    'trace_calls' => 0,\n    'timeout' => 300,\n    'max_requests' => 10_000,\n    'no_refresh' => 0,\n);\n\nrecreate_indexes();\n\nmy $i = 0;\nwhile (1) {\n    $i++;\n    do_index([\n        {\n            'id' => ('1311677474-91-19527-316-' . $i),\n            'domain id' => int(rand(10000)),\n        },\n        {\n            'id' => ('1311677474-92-19527-316-' . $i),\n            'domain id' => int(rand(10000)),\n        },\n    ]);\n}\n\nsub do_index {\n    my ($documents) = @_;\n    my $n_msgs = scalar(@{$documents});\n\n    my @req;\n    for my $doc (@{$documents}) {\n        my $index = 'silly_' . $doc->{'domain id'};\n        my $doc_req = {\n            'index' => $index,\n            'type' => 'eeee',\n            'id' => $doc->{'id'},\n            'data' => $doc,\n        };\n        push(@req, { 'index' => $doc_req });\n    }\n\n    print STDERR join(' ',\n                      'Submitting', $n_msgs,\n                      'pid =', $$,\n                      'server =', $es->transport()->current_server(),\n                      \"\\n\");\n    my $result = $es->bulk(\\@req);\n}\n\nsub recreate_indexes {\n    print STDERR \"DELETE index _all\\n\";\n    $es->delete_index(\n        'index' => '_all',\n    );\n\n    print STDERR \"DELETE index template silly\\n\";\n    $es->delete_index_template(\n        'name' => 'silly',\n        'ignore_missing' => 1,\n    );\n\n    print STDERR \"CREATE index template silly\\n\";\n    $es->create_index_template(\n        'name' => 'silly',\n        'template' => 'silly_*',\n        'settings' => {\n            \"index\" => {\n                \"refresh_interval\" => \"60s\",\n                \"number_of_replicas\" => 1,\n                \"number_of_shards\" => 3,\n            },\n        },\n        'mappings' => {\n            'eeee' => {\n                \"_source\" => { \"enabled\" => 0 },\n            },\n        },\n    );\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}