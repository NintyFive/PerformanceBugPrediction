[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107249492","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107249492","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107249492,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzI0OTQ5Mg==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-05-31T21:43:45Z","updated_at":"2015-05-31T21:43:45Z","author_association":"CONTRIBUTOR","body":"I am not sure it is related to your JVM upgrade. 1.5 has a number of fixes for file truncation issues, I think that is the root problem, and you just got unlucky in a way that seems to correlate with 7u80.\n\nBy the way, if you are concerned about it, why not use 7u79 instead? Its significantly less scary\n(http://www.oracle.com/technetwork/java/javase/2col/7u79-bugfixes-2494165.html) versus looking at the list of changes for 7u80 (http://www.oracle.com/technetwork/java/javase/2col/7u80-bugfixes-2494167.html). Basically just timezone and security fixes.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107251454","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107251454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107251454,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzI1MTQ1NA==","user":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"created_at":"2015-05-31T21:58:29Z","updated_at":"2015-05-31T21:58:29Z","author_association":"NONE","body":"Thanks for your reply. We didn't notice that the leap second addition was available in 7u79, nice catch! \n\nIn any case, if I understand correctly: you mean that the files are really corrupted in disk and we didn't notice during all these months? What can trigger this behavior? Sounds scary :)\n\nBut really, we didn't have any issues and we do a daily snapshot for all indices, daily queries for the whole month of data (1 index per month), and a lot of writes during each day. And not so long ago we restarted the cluster with the upgrade to 1.4.4 and some operating system updates (a few days later after that), and we never had any errors in the logs (we monitor the cluster with a marvel cluster but also we log the messages to a logstash installation that aggregate all the logs for us).\n\nWhat would you guys recommend to handle this particular situation and avoid the risk of losing data with a java or ES upgrade? How can we be sure that our current index files are ok or not?\n\nThanks guys!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107270951","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107270951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107270951,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzI3MDk1MQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-06-01T00:50:53Z","updated_at":"2015-06-01T00:50:53Z","author_association":"CONTRIBUTOR","body":"> In any case, if I understand correctly: you mean that the files are really corrupted in disk and we didn't notice during all these months? What can trigger this behavior? Sounds scary :)\n\nYou can get an idea how things can happen by reviewing the 1.5 release notes (https://www.elastic.co/blog/elasticsearch-1-5-0-released). To me the most important change is that files are transferred in an atomic way on recovery (temp files, then renamed at the end). So if stuff goes wrong, you dont have the chance of a half-baked file sitting there. But there are really a ton of fixes to this kind of stuff there.\n\nI honestly doubt you had corrupted data \"all along\". That is because the check in question was added in ES 1.2.x (https://issues.apache.org/jira/browse/LUCENE-5617), so the check was happening before you upgraded, too. So I think it likely happened before/after the upgrade? Things are getting shut down, Shards are shuffling around or whatever, stuff gets chatty, more chance for stuff to wrong or have an incomplete file with the old code.\n\n> What would you guys recommend to handle this particular situation and avoid the risk of losing data with a java or ES upgrade? How can we be sure that our current index files are ok or not?\n\nMy first recommendation is to use the latest elasticsearch version. Really, a lot of folks here have spent a lot of time on preventing these issues: this kind of stuff has matured a lot and will continue to get better in forthcoming releases. So IMO, if you are worried about safety of your data, prioritize it first by using the latest version, and maybe invite some additional risk of bugs or whatever in features, but its a good tradeoff.\n\nAs far as checking the index files: you can always explicitly do full checks with the lucene CheckIndex tool (see https://www.found.no/foundation/dive-into-elasticsearch-storage/#fixing-problematic-shards for some instructions, but please please don't ever use the badly-named _fix_ option). So if you want to manually do a check, that is your best option currently. Its also possible for ES to check on startup (`index.shard.check_on_startup`) but this is really slow and resource-hungry.\n\nGoing forward its really something you shouldnt need to do: files are fully checked continuously whenever they are \"in motion\" (e.g. network recovery, merge for indexes being changed, etc). We also have a fair amount of checks happening just on startup, like the one you hit here, which was extended to all files in the index in ES 1.4+. Finally coming in 2.0 there will also be a \"reasonable\" option `index.shard.check_on_startup=checksum` designed for situations like yours (https://github.com/elastic/elasticsearch/pull/9183), where maybe you want an explicit full check on startup to know your data is ok, after upgrades etc :)\n\nHaving an option for an immediate check... its been thrown around before: maybe its a good idea, maybe not. I do have concerns it could could be a trap like `optimize`, leading people to run it across the entire index after every operation or other stuff like that.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107483817","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107483817","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107483817,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzQ4MzgxNw==","user":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"created_at":"2015-06-01T13:44:58Z","updated_at":"2015-06-01T13:44:58Z","author_association":"NONE","body":"That is an amazing reply really, it clarified a lot and I highly appreciate it :) A few final questions then:\n\n1.- Got it. We will try to upgrade to 1.5.2 (latest so far). But just to clarify  this case (and as a final conclusion): you think that this error might just happened while shutting down the node (and not before), and that there is a chance that repeating the process will yield a successful result?\n\n2.- Just out of curiosity: [https://www.elastic.co/guide/en/elasticsearch/hadoop/current/requirements.html] still recommends 7u55. Do you recommend a jvm upgrade to 7u79 or sticking to 7u67 (in our case) is a safer bet? \n\n3.- Are snapshots stored in a way that can be trusted and safe from corruption? (hardware issues aside). I'm asking this to know if there might be a chance of snapshooting an already corrupted index (i.e: corrupted lucene files), and if there is a chance of losing data in scenarios like this, when using a snapshot to restore data that might have been snapshooted with older ES versions (i.e: older lucene versions).\n\nThanks again for your time and all the hard work!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107499921","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107499921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107499921,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzQ5OTkyMQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-06-01T14:03:11Z","updated_at":"2015-06-01T14:03:11Z","author_association":"CONTRIBUTOR","body":"> 1.- Got it. We will try to upgrade to 1.5.2 (latest so far). But just to clarify this case (and as a final conclusion): you think that this error might just happened while shutting down the node (and not before), and that there is a chance that repeating the process will yield a successful result?\n\nThat is my best guess as to what happened, its the simplest explanation. As far as the chance of it happening, its not clear to me how likely it is, you know if you just got unlucky, but it can happen, which is why folks worked to fix it for 1.5. I definitely think if things are \"not moving\" when you shut down, you could have probably been just fine and not hit it, so you can at least get lucky.\n\n> 2.- Just out of curiosity: [https://www.elastic.co/guide/en/elasticsearch/hadoop/current/requirements.html] still recommends 7u55. Do you recommend a jvm upgrade to 7u79 or sticking to 7u67 (in our case) is a safer bet?\n\nI don't know any hadoop-specifics of JDK versions (cc @costin). The recommendations page does say \"or higher\". I think the motivation there was just to avoid index corruption bugs that can happen in versions before 7u55, so 7u79 should be fine.\n\n> 3.- Are snapshots stored in a way that can be trusted and safe from corruption? (hardware issues aside). I'm asking this to know if there might be a chance of snapshooting an already corrupted index (i.e: corrupted lucene files), and if there is a chance of losing data in scenarios like this, when using a snapshot to restore data that might have been snapshooted with older ES versions (i.e: older lucene versions)\n\nIts a good question. See https://github.com/elastic/elasticsearch/issues/5593 where this feature was added for elasticsearch 1.4\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107514047","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107514047","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107514047,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzUxNDA0Nw==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2015-06-01T14:21:29Z","updated_at":"2015-06-01T14:21:29Z","author_association":"MEMBER","body":"> Just out of curiosity: [https://www.elastic.co/guide/en/elasticsearch/hadoop/current/requirements.html] still recommends 7u55\n\nThat's because the documentation belongs to the es-hadoop 2.0.2 and at the time, that was the latest safe JDK version. Hence why it also states 'or higher' - as time goes buy, new releases are published.\nThe beta documentation has a slightly different [wording](https://www.elastic.co/guide/en/elasticsearch/hadoop/2.1.Beta/requirements.html) pointing to the Elasticsearch [Matrix](https://www.elastic.co/subscriptions/matrix).\n\nNote that most Hadoop distros use JDK 6 or old JDK 7 versions.\n\nHope this helps,\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/107918824","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-107918824","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":107918824,"node_id":"MDEyOklzc3VlQ29tbWVudDEwNzkxODgyNA==","user":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"created_at":"2015-06-02T11:21:21Z","updated_at":"2015-06-02T11:21:21Z","author_association":"NONE","body":"Thanks guys, will close this one then, and will try to schedule an update to the latest 1.5.x (1.4.4 has been working amazingly well for us, but due to this \"episode\" we'd like to  avoid any kind of possible \"bad luck\", as suggested) and only then bump up the java version to 7u79.\n\nI really appreciate all the insights, and useful links to resources :)\n\nBest!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/111816134","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-111816134","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":111816134,"node_id":"MDEyOklzc3VlQ29tbWVudDExMTgxNjEzNA==","user":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"created_at":"2015-06-14T11:55:02Z","updated_at":"2015-06-14T11:55:02Z","author_association":"NONE","body":"Just wanted to report that we upgraded (not in a rolling upgrade, but shutting down the cluster) to ES 1.5.2 and Java 7u80 and everything went smoothly. Thanks again for your time and help.\n\nCheers.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/111872910","html_url":"https://github.com/elastic/elasticsearch/issues/11439#issuecomment-111872910","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","id":111872910,"node_id":"MDEyOklzc3VlQ29tbWVudDExMTg3MjkxMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-06-14T20:18:20Z","updated_at":"2015-06-14T20:18:20Z","author_association":"CONTRIBUTOR","body":"thanks for letting us know @marcelog \n","performed_via_github_app":null}]