{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11116","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11116/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11116/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11116/events","html_url":"https://github.com/elastic/elasticsearch/issues/11116","id":75593609,"node_id":"MDU6SXNzdWU3NTU5MzYwOQ==","number":11116,"title":"Alternatives to disabling or filtering the `_source` field at index time","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"assignees":[{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false}],"milestone":null,"comments":12,"created_at":"2015-05-12T12:58:49Z","updated_at":"2015-08-19T09:32:58Z","closed_at":"2015-05-14T21:41:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In https://github.com/elastic/elasticsearch/pull/10915 we removed the ability to disable the `_source` field, and in https://github.com/elastic/elasticsearch/pull/10814 we removed the ability to use `includes` and `excludes` to remove selected fields from the `_source` field that is stored with each document.\n\nThe reason for this is that a number of important existing and future features rely on having the complete original `_source` field available in Elasticsearch, such as:\n- the `update` API\n- on-the-fly highlighting\n- reindexing (either to change mappings/analysis or in to upgrade an index over major versions)\n- automated repair of index corruption \n- the ability to debug problems by viewing the original source used for indexing\n\nIn our experience, many new users disable `_source` just to save disk space, or because it seemed like a nice optimisation. Almost all of them later regret it, and found themselves unable to move forward because rebuilding the index from the original data store was too costly.\n\nInstead, we have the ability to:\n- filter the contents of the `_source` field that is returned to the user (#3302)\n- enable a higher compression ratio (https://github.com/elastic/elasticsearch/pull/8863)\n- filter down the entire search response with the `path` parameter (https://github.com/elastic/elasticsearch/pull/10980)\n\nThe above changes are good for the most common use cases, probably 90% of our user base.  However, there are two use cases in particular where controlling how or whether the source is indexed would beneficial to the more expert user:\n## No source needed\n\nHigh volume indexing of documents used almost exclusively for analytics. The source field is not required in the search results, indices can be rebuilt from fast primary data stores, minimising disk usage and write performance matters. In this case, we can provide an index setting to completely disable the storage of the `_source` field and all of the benefits that come with having the original source.\n\n**Why an index setting?**\n\nPreviously, users could do this just by setting `_source.enabled: false`, so why switch this to an index setting?  Doing this in the mapping was too convenient, so users who didn't understand the consequences used the option and ended up suffering for it.  By making it an index setting, it (1) invalidates the behaviour that has been recommended in blog posts, making users go back to read the documentation and (2) allows us to use a scary enough name (with accompanying docs) that will make users think twice.\n## Reading a large `_source` is slow and unnecessary\n\nUsers who are indexing a large field (like the contents of a PDF) plus several small fields (eg title, creation date, tags, etc) are likely to want to return just the small fields plus highlighted snippets.  However, returning just the `title` field necessitates reading (and then filtering out) the large `contents` field as well.\n\nPreviously, users used the `source.includes` and `source.excludes` filters to remove these large fields from the `_source`, but as a consequence, this disables all of the features mentioned above.   As an alternative, the user can still disable the `_source` field and set individual fields to `store: true`.\n\nIt would be nice to do better though: to keep the original `_source` but make search responses requiring just a few fields faster than they are today.  Two proposals:\n\n**Add  a `_response_source` field**\n\nThe original  `_source` would still be stored, but the `_response_source` would be a second stored field with a filtered list of fields (behaving like the old `includes/excludes).  The user could choose which field should be returned with their search requests.  Compression would minimise the amount of extra storage required because the fields in the`_response_source`would be a subset of those in the`_source`.\n\n**Store top-level fields as separate stored fields**\n\nAs suggested in https://github.com/elastic/elasticsearch/issues/9034, the `_source` field would be stored as separate stored fields, one for top-level field in the JSON document.  This would allow Elasticsearch to efficiently skip over filtered out fields to return just the required subset, yet it preserves the original JSON so that values such as `[1,null,1]` or `[]` etc can be returned correctly.\n\nAn advantage of this solution is that the decision about which fields to return is query time, while the `_response_source` option is set at index time.\n\nThis also opens up the possibility to enable more efficient compression techniques for individual fields, depending on the type of data contained in each field.\n\nThoughts?\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}