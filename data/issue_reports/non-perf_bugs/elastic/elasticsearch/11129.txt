{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11129","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11129/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11129/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11129/events","html_url":"https://github.com/elastic/elasticsearch/issues/11129","id":75695154,"node_id":"MDU6SXNzdWU3NTY5NTE1NA==","number":11129,"title":"Percolator with transform script doesn't match","user":{"login":"idlefella","id":1322083,"node_id":"MDQ6VXNlcjEzMjIwODM=","avatar_url":"https://avatars2.githubusercontent.com/u/1322083?v=4","gravatar_id":"","url":"https://api.github.com/users/idlefella","html_url":"https://github.com/idlefella","followers_url":"https://api.github.com/users/idlefella/followers","following_url":"https://api.github.com/users/idlefella/following{/other_user}","gists_url":"https://api.github.com/users/idlefella/gists{/gist_id}","starred_url":"https://api.github.com/users/idlefella/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/idlefella/subscriptions","organizations_url":"https://api.github.com/users/idlefella/orgs","repos_url":"https://api.github.com/users/idlefella/repos","events_url":"https://api.github.com/users/idlefella/events{/privacy}","received_events_url":"https://api.github.com/users/idlefella/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-05-12T18:31:19Z","updated_at":"2016-01-18T19:17:41Z","closed_at":"2016-01-18T19:17:41Z","author_association":"NONE","active_lock_reason":null,"body":"Hi\n\nI think I found a bug in the percolator from elaticsearch. The problem happens when you have a transform script registered in your mapping. The following code reproduces this bug.\n\nCreate an elasticsearch.yml config file to activate dynamic scripts:\n\n``` yaml\nscript.inline: on\nscript.indexed: on\nscript.disable_dynamic: false\n```\n\nStart an elasticsearch instance (I do it with docker)\n\n``` bash\ndocker run -d -p 9200:9200 -v $PWD/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml --name es elasticsearch:1.5.2\n```\n\nThe following script then reproduces the bug. The registered transform script does nothing (you can also replace it by something else). I expect that the percolator matches the document, since the same query matches the document after it has been added to the index. After removing the transform script, the percolator works as exptected. I also added some sleep statements since I wasn't sure if it's a timing problem.\n\n``` bash\nES_HOST=localhost:9200\n\necho \"Deleting the percolator\"\ncurl -XDELETE $ES_HOST/myindex/.percolator/1\n\necho -e \"\\nDelete index\"\ncurl -XDELETE $ES_HOST/myindex/\n\necho -e \"\\nCreating index\"\ncurl -XPUT $ES_HOST/myindex\n\necho -e \"\\nInsert mapping\"\ncurl -XPUT $ES_HOST/myindex/_mapping/mytype?pretty -d '\n{\n    \"mytype\" : {\n        \"properties\": {\n            \"message\": {\n                \"type\": \"string\"\n            }\n        },\n        \"transform\": {\n            \"script\" : \"println ctx\",\n            \"lang\": \"groovy\"\n        }\n    }\n}\n'\n\necho -e \"\\nCheck mapping\"\ncurl -XGET $ES_HOST/myindex/_mapping/?pretty\n\necho -e \"\\nAdd a percolator query\"\ncurl -XPUT \"$ES_HOST/myindex/.percolator/1?pretty\" -d '\n{\n    \"query\" : {\n        \"match\" : {\n            \"message\" : \"bonsai\"\n        }\n    }\n}'\n\nsleep 2\n\necho -e \"\\nSend a document to the percolator\"\ncurl -XGET \"$ES_HOST/myindex/mytype/_percolate?pretty\" -d '{\n    \"doc\" : {\n        \"message\" : \"A new bonsai tree in the office\"\n    }\n}'\n\n# HERE THE RESPONSE IS WRONG\n\necho -e \"\\nIndexing the document\"\ncurl -XPOST \"$ES_HOST/myindex/mytype?pretty\" -d '{\n    \"message\" : \"A new bonsai tree in the office\"\n}'\n\nsleep 2\n\necho -e \"\\nRun a query with the same settings as the percolator\"\ncurl -XGET \"$ES_HOST/myindex/mytype/_search?pretty\" -d '\n{\n    \"query\" : {\n        \"match\" : {\n            \"message\" : \"bonsai\"\n        }\n    }\n}'\n\n# HERE THE SAME DOCUMENT IS FOUND WITH THE QUERY\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}