{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11883","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11883/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11883/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11883/events","html_url":"https://github.com/elastic/elasticsearch/issues/11883","id":91176098,"node_id":"MDU6SXNzdWU5MTE3NjA5OA==","number":11883,"title":"Corrupted replica shards","user":{"login":"bittusarkar","id":860447,"node_id":"MDQ6VXNlcjg2MDQ0Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/860447?v=4","gravatar_id":"","url":"https://api.github.com/users/bittusarkar","html_url":"https://github.com/bittusarkar","followers_url":"https://api.github.com/users/bittusarkar/followers","following_url":"https://api.github.com/users/bittusarkar/following{/other_user}","gists_url":"https://api.github.com/users/bittusarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/bittusarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bittusarkar/subscriptions","organizations_url":"https://api.github.com/users/bittusarkar/orgs","repos_url":"https://api.github.com/users/bittusarkar/repos","events_url":"https://api.github.com/users/bittusarkar/events{/privacy}","received_events_url":"https://api.github.com/users/bittusarkar/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-06-26T07:03:40Z","updated_at":"2015-06-26T15:40:09Z","closed_at":"2015-06-26T15:40:08Z","author_association":"NONE","active_lock_reason":null,"body":"We're using Elasticsearch 1.3.4. Every now and then we run into corrupted replica shard issues on our production cluster. Below is one of the error messages we see in the log file.\n\n```\n[MasterNode] [index10][1] received shard failed for [index10][1], node[BujRysY1Sh-g1ZCFjA5Nag], [R], s[INITIALIZING], indexUUID [SEEuraAWTwObNVug0lz4sA], reason [Failed to start shard, message [CorruptIndexException[[index10][1] Corrupted index [corrupted_2rbhI3j1SY-WsNsOgdsjug] caused by: CorruptIndexException[codec footer mismatch: actual footer=1291846144 vs expected footer=-1071082520 (resource: MMapIndexInput(path=\"<path to one of the .doc file>\"))]]]]\n```\n\nThe replica shard remains in the corrupted state indefinitely even when the corresponding primary shard is in `STARTED` state. Today we workaround this issue by setting the number of replica shards of the affected index to `0` and then back to the original number. Though this fixes the corruption, it has other non-trivial side-effects:\n- Replicas of even the unaffected shards get re-created but take a lot of time to get to the `STARTED` state.\n- As all replica shards are re-created, filter and fielddata caches for those shards is reset, causing slower queries.\n\nI want to understand if there is a better way to fix such issues or is this fixed in higher versions of Elasticsearch.\n\nIdeally, if a replica shard is corrupted and the primary shard is not, it should recover from the primary shard because the corruption will never self-heal, no?\n\nIf that is not possible, is it possible to delete the corrupted replica shard from file system and use the `_cluser/reroute` API to allocate it back? Even better, allocation with `_cluster/reroute` should first check if the shard is corrupted and if yes, delete it and finally allocate.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}