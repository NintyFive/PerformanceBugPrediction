{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11555","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11555/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11555/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11555/events","html_url":"https://github.com/elastic/elasticsearch/issues/11555","id":86611327,"node_id":"MDU6SXNzdWU4NjYxMTMyNw==","number":11555,"title":"Sub Aggregations in parent-child relationship on field value","user":{"login":"vineet85","id":12549304,"node_id":"MDQ6VXNlcjEyNTQ5MzA0","avatar_url":"https://avatars0.githubusercontent.com/u/12549304?v=4","gravatar_id":"","url":"https://api.github.com/users/vineet85","html_url":"https://github.com/vineet85","followers_url":"https://api.github.com/users/vineet85/followers","following_url":"https://api.github.com/users/vineet85/following{/other_user}","gists_url":"https://api.github.com/users/vineet85/gists{/gist_id}","starred_url":"https://api.github.com/users/vineet85/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vineet85/subscriptions","organizations_url":"https://api.github.com/users/vineet85/orgs","repos_url":"https://api.github.com/users/vineet85/repos","events_url":"https://api.github.com/users/vineet85/events{/privacy}","received_events_url":"https://api.github.com/users/vineet85/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-06-09T14:09:00Z","updated_at":"2015-06-15T08:25:38Z","closed_at":"2015-06-15T08:25:37Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nI have a parent child mapping in the following format:-\nThe children are linked to the parent based on the _id field in this case\n\nParent:-\n\n```\nPOST http://localhost:9200/_bulk\n{ \"index\" :  {\"_index\":\"estester\",\"_type\":\"document\",\"_id\":\"00005777b25343f0b7c03e54c0411c1b\"} }\n{}\n```\n\nChildren:-\n\n```\nPOST http://localhost:9200/_bulk\n{\n    \"index\": {\n        \"_index\": \"estester\",\n        \"_type\": \"documentmetadatavalue\",\n        \"_parent\": \"00005777b25343f0b7c03e54c0411c1b\"\n    }\n}\n{\n    \"fieldid\": \"DOCUMENT_GUID\",\n    \"fieldvalue\": [\n        \"00005777b25343f0b7c03e54c0411c1b\"\n    ],\n    \"parent\": \"00005777b25343f0b7c03e54c0411c1b\"\n},\n{\n    \"fieldid\": \"FILETYPE\",\n    \"fieldvalue\": [\n        \"PDF \"\n    ],\n    \"parent\": \"00005777b25343f0b7c03e54c0411c1b\"\n},\n{\n    \"fieldid\": \"CREATEDDATE\",\n    \"fieldvalue\": [\n        \"06/08/2015\"\n    ],\n    \"parent\": \"00005777b25343f0b7c03e54c0411c1b\"\n}\n```\n\nI'm trying to create sub-aggregations which are 2 levels deep based on the fieldid:- CREATEDDATE and FILETYPE.\n\nHowever the aggregation below fails to create child buckets more than 1 level deep:-\n\n```\nGET /estester/documentmetadatavalue/_search?search_type=count\n{\n    \"size\": 100,\n    \"aggs\": {\n        \"field_aggregation\": {\n            \"filter\": {\n                \"term\": {\n                    \"fieldid\": \"CREATEDDATE\"\n                }\n            },\n            \"aggs\": {\n                \"field_aggregation_values\": {\n                    \"terms\": {\n                        \"field\": \"fieldvalue.original\",\n                        \"size\": 0\n                    },\n                    \"aggs\": {\n                      \"field_aggregation\": {\n                          \"filter\": {\n                              \"term\": {\n                                  \"fieldid\": \"FILETYPE\"\n                              }\n                          },\n                          \"aggs\": {\n                              \"field_aggregation_values\": {\n                                  \"terms\": {\n                                      \"field\": \"fieldvalue.original\",\n                                      \"size\": 0\n                                  }\n                              }\n                          }\n                      }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nResponse:-\n\n```\n{\n   \"took\": 8,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 196,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"field_aggregation\": {\n         \"doc_count\": 4,\n         \"field_aggregation_values\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n               {\n                  \"key\": \"02/27/2015\",\n                  \"doc_count\": 1,\n                  \"field_aggregation\": {\n                     \"doc_count\": 0,\n                     \"field_aggregation_values\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": []\n                     }\n                  }\n               },\n               {\n                  \"key\": \"05/15/2015\",\n                  \"doc_count\": 1,\n                  \"field_aggregation\": {\n                     \"doc_count\": 0,\n                     \"field_aggregation_values\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": []\n                     }\n                  }\n               },\n               {\n                  \"key\": \"06/08/2015\",\n                  \"doc_count\": 1,\n                  \"field_aggregation\": {\n                     \"doc_count\": 0,\n                     \"field_aggregation_values\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": []\n                     }\n                  }\n               },\n               {\n                  \"key\": \"06/09/2015\",\n                  \"doc_count\": 1,\n                  \"field_aggregation\": {\n                     \"doc_count\": 0,\n                     \"field_aggregation_values\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": []\n                     }\n                  }\n               }\n            ]\n         }\n      }\n   }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}