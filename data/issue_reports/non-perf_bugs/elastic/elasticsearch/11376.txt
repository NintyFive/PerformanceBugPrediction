{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11376","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11376/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11376/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11376/events","html_url":"https://github.com/elastic/elasticsearch/issues/11376","id":81470569,"node_id":"MDU6SXNzdWU4MTQ3MDU2OQ==","number":11376,"title":"Aggregations: combining children, nested and range filter - filter not working properly","user":{"login":"crutch","id":119724,"node_id":"MDQ6VXNlcjExOTcyNA==","avatar_url":"https://avatars0.githubusercontent.com/u/119724?v=4","gravatar_id":"","url":"https://api.github.com/users/crutch","html_url":"https://github.com/crutch","followers_url":"https://api.github.com/users/crutch/followers","following_url":"https://api.github.com/users/crutch/following{/other_user}","gists_url":"https://api.github.com/users/crutch/gists{/gist_id}","starred_url":"https://api.github.com/users/crutch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/crutch/subscriptions","organizations_url":"https://api.github.com/users/crutch/orgs","repos_url":"https://api.github.com/users/crutch/repos","events_url":"https://api.github.com/users/crutch/events{/privacy}","received_events_url":"https://api.github.com/users/crutch/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2015-05-27T14:28:39Z","updated_at":"2018-02-14T13:28:51Z","closed_at":"2015-06-26T15:08:22Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI am experiencing strange behavior when using aggregations combining `children`, `nested`, and `filter` aggs (with a `range` filter).\n\nIt looks like `children` aggregation is somehow affecting the `range` filter - it either returns count of all nested docs of a child document or none.\n\n<pre>\ncurl -XPUT 'localhost:9200/nestingtest' -d '{\n  \"mappings\": {\n    \"teams\": {\n      properties: {\n        name: {\n          type: \"string\",\n          index: \"not_analyzed\",\n          doc_values: true\n        }\n      }\n    },\n    \"tasks\": {\n        _parent: { type: \"teams\" },\n      properties: {\n        task_id: {\n          type: \"long\",\n          doc_values: true\n        },\n        started_at: {\n          type: \"object\",\n          properties: {\n            raw: {\n              type: \"date\",\n              doc_values: true\n            },\n            year: {\n              type: \"short\",\n              doc_values: true\n            },\n            month: {\n              type: \"short\",\n              doc_values: true\n            },\n            day: {\n              type: \"short\",\n              doc_values: true\n            },\n            hour: {\n              type: \"short\",\n              doc_values: true\n            },\n            minute: {\n              type: \"short\",\n              doc_values: true\n            },\n            wday: {\n              type: \"short\",\n              doc_values: true\n            }\n          }\n        },\n        events: {\n          type: \"nested\",\n          properties: {\n            id: {\n              type: \"long\",\n              doc_values: true\n            },\n            happened_at: {\n              type: \"object\",\n              properties: {\n                raw: {\n                  type: \"date\",\n                  doc_values: true\n                },\n                year: {\n                  type: \"short\",\n                  doc_values: true\n                },\n                month: {\n                  type: \"short\",\n                  doc_values: true\n                },\n                day: {\n                  type: \"short\",\n                  doc_values: true\n                },\n                hour: {\n                  type: \"short\",\n                  doc_values: true\n                },\n                minute: {\n                  type: \"short\",\n                  doc_values: true\n                },\n                wday: {\n                  type: \"short\",\n                  doc_values: true\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n</pre>\n\n\nData:\n\n<pre>\ncurl -XPOST 'localhost:9200/nestingtest/teams/1' -d '{ name: \"team-A\"}'\n\ncurl -XPOST 'localhost:9200/nestingtest/tasks/1?parent=1' -d '\n    {\n      _parent: 1,\n      task_id: 1,\n      started_at: {\n        raw: \"2015-05-27T13:05\",\n        year: 2015,\n        month: 5,\n        day: 27,\n        hour: 13,\n        minute: 5,\n        dow: 3\n      },\n      events: [\n        {\n          id: 1,\n          happened_at: {\n            raw: \"2015-05-27T13:10\",\n            year: 2015,\n            month: 5,\n            day: 27,\n            hour: 13,\n            minute: 10,\n            dow: 3\n          }\n        }\n      ]\n    }\n'\n\ncurl -XPOST 'localhost:9200/nestingtest/tasks/2?parent=1' -d '\n    {\n      _parent: 1,\n      task_id: 2,\n      started_at: {\n        raw: \"2015-05-27T16:05\",\n        year: 2015,\n        month: 5,\n        day: 27,\n        hour: 16,\n        minute: 5,\n        dow: 3\n      },\n      events: [\n        {\n          id: 21,\n          happened_at: {\n            raw: \"2015-05-27T16:10\",\n            year: 2015,\n            month: 5,\n            day: 27,\n            hour: 16,\n            minute: 10,\n            dow: 3\n          }\n        },\n        {\n          id: 22,\n          happened_at: {\n            raw: \"2015-05-27T17:10\",\n            year: 2015,\n            month: 5,\n            day: 27,\n            hour: 17,\n            minute: 10,\n            dow: 3\n          }\n        }\n      ]\n    }\n'   \n</pre>\n\n\nQueries:\nThis one, querying for parent documents is the one which behaves strangely\n\n<pre>\ncurl -XPOST 'localhost:9200/nestingtest/teams/_search?pretty' -d '\n    {\n      aggs: {\n        \"to-tasks\": {\n          children: {\n            type: \"tasks\"\n          },\n          aggs: {\n            \"to-events\": {\n              nested: {\n                path: \"tasks.events\"\n              },\n              aggs: {\n                filtered: {\n                  filter: {\n                    range: {\n                      \"events.happened_at.hour\": {\n                        gt: 15\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n'\n</pre>\n   \n\nIt returns: \n\n<pre>\n \"aggregations\" : {\n    \"to-tasks\" : {\n      \"doc_count\" : 2,\n      \"to-events\" : {\n        \"doc_count\" : 3,\n        \"filtered\" : {\n          \"doc_count\" : 3\n        }\n      }\n    }\n</pre>\n\n\nWhere I would expect `filtered > doc_count` set to `2`.\n\nIf I change `events.happened_at.hour` to `tasks.events.happened_at.hour` it returns an empty bucket.\n\nJust for comparison, this one queries the same data, but directly into children type (i.e., not using `children` aggregation) and is working as expected (returning 2 docs in the bucket). However, I would prefer to query for parent type, as I want to combine other criteria into query.\n\n<pre>\ncurl -XPOST 'localhost:9200/nestingtest/tasks/_search?pretty' -d '\n     {\n      aggs: {\n        \"to-events\": {\n          nested: {\n            path: \"events\"\n          },\n          aggs: {\n            filtered: {\n              filter: {\n                range: {\n                  \"events.happened_at.hour\": {\n                    gt: 15\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n'\n</pre>\n\n# \n\n<pre>\n\"version\" : {\n    \"number\" : \"1.5.0\",\n    \"build_hash\" : \"544816042d40151d3ce4ba4f95399d7860dc2e92\",\n    \"build_timestamp\" : \"2015-03-23T14:30:58Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  }\n</pre>\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}