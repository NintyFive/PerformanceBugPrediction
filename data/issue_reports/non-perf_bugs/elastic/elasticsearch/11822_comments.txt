[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/114614485","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-114614485","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":114614485,"node_id":"MDEyOklzc3VlQ29tbWVudDExNDYxNDQ4NQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-06-23T19:15:21Z","updated_at":"2015-06-23T19:15:21Z","author_association":"CONTRIBUTOR","body":"Hi @darshanmehta10 \n\nWhat version are you on, and what does your code look like?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/114668320","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-114668320","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":114668320,"node_id":"MDEyOklzc3VlQ29tbWVudDExNDY2ODMyMA==","user":{"login":"darshanmehta10","id":12479117,"node_id":"MDQ6VXNlcjEyNDc5MTE3","avatar_url":"https://avatars3.githubusercontent.com/u/12479117?v=4","gravatar_id":"","url":"https://api.github.com/users/darshanmehta10","html_url":"https://github.com/darshanmehta10","followers_url":"https://api.github.com/users/darshanmehta10/followers","following_url":"https://api.github.com/users/darshanmehta10/following{/other_user}","gists_url":"https://api.github.com/users/darshanmehta10/gists{/gist_id}","starred_url":"https://api.github.com/users/darshanmehta10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darshanmehta10/subscriptions","organizations_url":"https://api.github.com/users/darshanmehta10/orgs","repos_url":"https://api.github.com/users/darshanmehta10/repos","events_url":"https://api.github.com/users/darshanmehta10/events{/privacy}","received_events_url":"https://api.github.com/users/darshanmehta10/received_events","type":"User","site_admin":false},"created_at":"2015-06-23T23:07:28Z","updated_at":"2015-06-23T23:10:58Z","author_association":"NONE","body":"Hi,\n\nWe are using elasticsearch 1.4.2. We have a Java API which connects with remote elasticsearch server, executes search and closes Transport client. The transport client object is cached for some time and is closed when evicted from cache.\nFollowing is the code to create transport client:\n\n```\nSettings settings = ImmutableSettings.settingsBuilder().put(\"cluster.name\",     elasticSearch.getClusterName()).build();\nTransportClient tc = new TransportClient(settings);\ntc.addTransportAddress(new InetSocketTransportAddress(elasticSearch.getHost(), elasticSearch.getPort()));\n```\n\nFollowing is the code to close Transport Client:\n\n```\ntc.threadPool().shutdownNow();\ntc.close();\n```\n\nBelow is the screen shot of heapdump taken 3 hours after application restart (CPU : 11%, Memory 18%):\n![hd1](https://cloud.githubusercontent.com/assets/12479117/8319226/32fa1aea-1a04-11e5-852a-698a9febdc39.JPG)\nIt has 60k objects of HashedWheelBucket and thread dump showed 120 blocked threads of same.\n\nBelow is the screen shot of heapdump taken 6 hours after application restart (CPU 18%, Memory : 21%):\n![hd2](https://cloud.githubusercontent.com/assets/12479117/8319264/aa439af4-1a04-11e5-8b71-d7312d567be6.JPG)\n94k objects and 180 blocked threads now.\n\nIt seems closing Transportclient doesn't kill off threads even though we explicitly shut the threadpool down. This causes memory and cpu usage to reach 100% and then requires restart.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/114867619","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-114867619","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":114867619,"node_id":"MDEyOklzc3VlQ29tbWVudDExNDg2NzYxOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-06-24T13:29:06Z","updated_at":"2015-06-24T13:29:06Z","author_association":"CONTRIBUTOR","body":"I know that a number of improvements have been made to the transport client in recent versions. Not sure if this is the same thing or not.  /cc @spinscale ?\n\n@darshanmehta10 Would probably be useful to have some examples of what you're doing between opening and closing the connection too.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/114898424","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-114898424","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":114898424,"node_id":"MDEyOklzc3VlQ29tbWVudDExNDg5ODQyNA==","user":{"login":"darshanmehta10","id":12479117,"node_id":"MDQ6VXNlcjEyNDc5MTE3","avatar_url":"https://avatars3.githubusercontent.com/u/12479117?v=4","gravatar_id":"","url":"https://api.github.com/users/darshanmehta10","html_url":"https://github.com/darshanmehta10","followers_url":"https://api.github.com/users/darshanmehta10/followers","following_url":"https://api.github.com/users/darshanmehta10/following{/other_user}","gists_url":"https://api.github.com/users/darshanmehta10/gists{/gist_id}","starred_url":"https://api.github.com/users/darshanmehta10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darshanmehta10/subscriptions","organizations_url":"https://api.github.com/users/darshanmehta10/orgs","repos_url":"https://api.github.com/users/darshanmehta10/repos","events_url":"https://api.github.com/users/darshanmehta10/events{/privacy}","received_events_url":"https://api.github.com/users/darshanmehta10/received_events","type":"User","site_admin":false},"created_at":"2015-06-24T14:58:32Z","updated_at":"2015-06-24T14:59:22Z","author_association":"NONE","body":"Hello,\n\nBelow is the method which uses transport client object to query:\n\n```\npublic Object execute(SearchQuery query, TransportClient client) {\n    Object result;\n    ElasticsearchTemplate elasticSearchTemplate = new ElasticsearchTemplate(client);\n    SearchResponse response = elasticSearchTemplate.query(query, new ResultsExtractor<SearchResponse>() {\n        @Override\n        public SearchResponse extract(SearchResponse response) {\n            return response;\n        }\n    });\n\n    result = processResponse(response);//Extracts data from response\n    return result;\n```\n\n}\n\nWe are using spring implementation of EhCache (EhCacheCache) to store TransportClient object and have configured listener to close the client in overridden notifyElementRemoved, notifyElementExpired and notifyElementEvicted methods.\n\nA day after the last restart (24 hours), the API is using 32% CPU and 22% memory.\n\nPlease let me know if anything else is required.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/115542963","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-115542963","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":115542963,"node_id":"MDEyOklzc3VlQ29tbWVudDExNTU0Mjk2Mw==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2015-06-26T06:34:18Z","updated_at":"2015-06-26T06:34:18Z","author_association":"MEMBER","body":"Are you sure that you are instantiating only a single TransportClient? Can you try the same by reusing some TransportClient object? I just want to rule out that you have started dozens of TransportClients.\n\nYou should also check with netstat how many open connections there are.\n\nThe reason why I have the feeling that instantiate thousands of TransportClients is that, usually each Client only has one HashedWheelTimer, but you have tons of those.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/116590280","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-116590280","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":116590280,"node_id":"MDEyOklzc3VlQ29tbWVudDExNjU5MDI4MA==","user":{"login":"darshanmehta10","id":12479117,"node_id":"MDQ6VXNlcjEyNDc5MTE3","avatar_url":"https://avatars3.githubusercontent.com/u/12479117?v=4","gravatar_id":"","url":"https://api.github.com/users/darshanmehta10","html_url":"https://github.com/darshanmehta10","followers_url":"https://api.github.com/users/darshanmehta10/followers","following_url":"https://api.github.com/users/darshanmehta10/following{/other_user}","gists_url":"https://api.github.com/users/darshanmehta10/gists{/gist_id}","starred_url":"https://api.github.com/users/darshanmehta10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darshanmehta10/subscriptions","organizations_url":"https://api.github.com/users/darshanmehta10/orgs","repos_url":"https://api.github.com/users/darshanmehta10/repos","events_url":"https://api.github.com/users/darshanmehta10/events{/privacy}","received_events_url":"https://api.github.com/users/darshanmehta10/received_events","type":"User","site_admin":false},"created_at":"2015-06-29T10:02:10Z","updated_at":"2015-06-29T10:02:21Z","author_association":"NONE","body":"We are not using a single TransportClient. We can't really use the same TransportClient as we get the elasticsearch cluster details at runtime. So, we do the following steps when a request to query elasticsearch is received to our api:\n- Create TransportClient object\n- Cache TransportClient object\n- Execute search\n- Send back results\n\nWe are using Spring EhCache with 30 mins timeout and close the TransportClient object when it is evacuated. However, we believe that closing TransportClient (and explicitly shutting down threadpool) doesn't kill off all the request threads and that's why there are tons of HashedWheelTimer objects. Netstat also shows plenty of connections which ideally should not be the case.\n\nWe found the following in close() method of TransportClient:\n`injector.getInstance(ThreadPool.class).shutdown();`\nThis means threadpool won't accept the new thread but it will still execute the existing threads. May be existing threads are hung/blocked and the count of such threads keeps on increasing every time a new TransportClient is created?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/117042199","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-117042199","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":117042199,"node_id":"MDEyOklzc3VlQ29tbWVudDExNzA0MjE5OQ==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2015-06-30T07:44:04Z","updated_at":"2015-06-30T07:44:13Z","author_association":"MEMBER","body":"You can try with Elasticsearch 1.5 and above. We changed the closing of threadpools in there, see [here](https://github.com/elastic/elasticsearch/blob/1.5/src/main/java/org/elasticsearch/client/transport/TransportClient.java#L283)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/171365254","html_url":"https://github.com/elastic/elasticsearch/issues/11822#issuecomment-171365254","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11822","id":171365254,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MTM2NTI1NA==","user":{"login":"eskibars","id":2246002,"node_id":"MDQ6VXNlcjIyNDYwMDI=","avatar_url":"https://avatars0.githubusercontent.com/u/2246002?v=4","gravatar_id":"","url":"https://api.github.com/users/eskibars","html_url":"https://github.com/eskibars","followers_url":"https://api.github.com/users/eskibars/followers","following_url":"https://api.github.com/users/eskibars/following{/other_user}","gists_url":"https://api.github.com/users/eskibars/gists{/gist_id}","starred_url":"https://api.github.com/users/eskibars/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eskibars/subscriptions","organizations_url":"https://api.github.com/users/eskibars/orgs","repos_url":"https://api.github.com/users/eskibars/repos","events_url":"https://api.github.com/users/eskibars/events{/privacy}","received_events_url":"https://api.github.com/users/eskibars/received_events","type":"User","site_admin":false},"created_at":"2016-01-13T17:04:57Z","updated_at":"2016-01-13T17:04:57Z","author_association":"CONTRIBUTOR","body":"I'm going to close this since we haven't heard from this in over 6 months and it was potentially solved with #7868.  If there's still an issue, we can reopen.\n","performed_via_github_app":null}]